<!DOCTYPE html>
<html lang="en-US" xml:lang="en-US">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Section 3 CBH Process | Aerial LiDAR for Fire Model Inputs</title>
  <meta name="description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  <meta name="generator" content="bookdown 0.34 and GitBook 2.6.7" />

  <meta property="og:title" content="Section 3 CBH Process | Aerial LiDAR for Fire Model Inputs" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Section 3 CBH Process | Aerial LiDAR for Fire Model Inputs" />
  
  <meta name="twitter:description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  

<meta name="author" content="George Woolsey" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="s01.html"/>
<link rel="next" href="s03.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
<link href="libs/bsTable-3.3.7/bootstrapTable.min.css" rel="stylesheet" />
<script src="libs/bsTable-3.3.7/bootstrapTable.js"></script>
<link href="libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet" />
<script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.2.2/leaflet.js"></script>
<script src="libs/leaflet-providers-2.0.0/leaflet-providers_2.0.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.2.2/leaflet-providers-plugin.js"></script>
<script src="libs/clipboard-0.0.1/setClipboardText.js"></script>
<link href="libs/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet" />
<link href="libs/mapviewCSS-0.0.1/mapview.css" rel="stylesheet" />
<script type="text/javascript">

// toggle visibility of R source blocks in R Markdown output
function toggle_R() {
  var x = document.getElementsByClassName('r');
  if (x.length == 0) return;
  function toggle_vis(o) {
    var d = o.style.display;
    o.style.display = (d == 'block' || d == '') ? 'none':'block';
  }

  for (i = 0; i < x.length; i++) {
    var y = x[i];
    if (y.tagName.toLowerCase() === 'pre') toggle_vis(y);
  }

    var elem = document.getElementById("myButton1");
    if (elem.value === "Hide Code") elem.value = "Show Code";
    else elem.value = "Hide Code";
}

document.write('<input onclick="toggle_R();" type="button" value="Hide Code" id="myButton1" style="position: absolute; top: 10%; right: 2%; z-index: 200"></input>')

</script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#objective"><i class="fa fa-check"></i><b>1.1</b> Objective</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#data"><i class="fa fa-check"></i><b>1.2</b> Data</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="s01.html"><a href="s01.html"><i class="fa fa-check"></i><b>2</b> Data Load and Methods Explore</a>
<ul>
<li class="chapter" data-level="2.1" data-path="s01.html"><a href="s01.html#neontreeevaluation"><i class="fa fa-check"></i><b>2.1</b> <code id="neon">NeonTreeEvaluation</code></a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="s01.html"><a href="s01.html#explore-lidar-data-from-package"><i class="fa fa-check"></i><b>2.1.1</b> Explore LiDAR data from package</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="s01.html"><a href="s01.html#cloud2trees"><i class="fa fa-check"></i><b>2.2</b> <code id="cloud2trees">cloud2trees</code></a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="s01.html"><a href="s01.html#get-tree-list-and-normalized-cloud"><i class="fa fa-check"></i><b>2.2.1</b> Get tree list and normalized cloud</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="s01.html"><a href="s01.html#ladderfuelsr"><i class="fa fa-check"></i><b>2.3</b> <code id="ladr">LadderFuelsR</code></a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="s01.html"><a href="s01.html#prep-for-the-package"><i class="fa fa-check"></i><b>2.3.1</b> Prep for the package</a></li>
<li class="chapter" data-level="2.3.2" data-path="s01.html"><a href="s01.html#defining-function-for-computing-crown-level-metrics"><i class="fa fa-check"></i><b>2.3.2</b> Defining function for computing crown-level metrics</a></li>
<li class="chapter" data-level="2.3.3" data-path="s01.html"><a href="s01.html#computing-crown-level-standard-metrics-within-all-trees-detected"><i class="fa fa-check"></i><b>2.3.3</b> Computing crown level standard metrics within all trees detected</a></li>
<li class="chapter" data-level="2.3.4" data-path="s01.html"><a href="s01.html#lai-lad-metrics-by-trees"><i class="fa fa-check"></i><b>2.3.4</b> LAI-LAD metrics by Trees</a></li>
<li class="chapter" data-level="2.3.5" data-path="s01.html"><a href="s01.html#i-quit"><i class="fa fa-check"></i><b>2.3.5</b> I quit</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="s01.html"><a href="s01.html#ladr_s"><i class="fa fa-check"></i><b>2.4</b> <code>LadderFuelsR</code> - simplified</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="s01.html"><a href="s01.html#setup"><i class="fa fa-check"></i><b>2.4.1</b> Setup</a></li>
<li class="chapter" data-level="2.4.2" data-path="s01.html"><a href="s01.html#step-0---leafr-steps"><i class="fa fa-check"></i><b>2.4.2</b> Step 0 - <code>leafR</code> steps</a></li>
<li class="chapter" data-level="2.4.3" data-path="s01.html"><a href="s01.html#step-1---ladderfuelsrget_gaps_fbhs"><i class="fa fa-check"></i><b>2.4.3</b> Step 1 - <code>LadderFuelsR::get_gaps_fbhs</code></a></li>
<li class="chapter" data-level="2.4.4" data-path="s01.html"><a href="s01.html#step-2---ladderfuelsrcalculate_gaps_perc"><i class="fa fa-check"></i><b>2.4.4</b> Step 2 - <code>LadderFuelsR::calculate_gaps_perc</code></a></li>
<li class="chapter" data-level="2.4.5" data-path="s01.html"><a href="s01.html#step-3---ladderfuelsrget_distance"><i class="fa fa-check"></i><b>2.4.5</b> Step 3 - <code>LadderFuelsR::get_distance</code></a></li>
<li class="chapter" data-level="2.4.6" data-path="s01.html"><a href="s01.html#step-4---ladderfuelsrget_depths"><i class="fa fa-check"></i><b>2.4.6</b> Step 4 - <code>LadderFuelsR::get_depths</code></a></li>
<li class="chapter" data-level="2.4.7" data-path="s01.html"><a href="s01.html#step-5---ladderfuelsrget_real_fbh"><i class="fa fa-check"></i><b>2.4.7</b> Step 5 - <code>LadderFuelsR::get_real_fbh</code></a></li>
<li class="chapter" data-level="2.4.8" data-path="s01.html"><a href="s01.html#step-6---ladderfuelsrget_real_depths"><i class="fa fa-check"></i><b>2.4.8</b> Step 6 - <code>LadderFuelsR::get_real_depths</code></a></li>
<li class="chapter" data-level="2.4.9" data-path="s01.html"><a href="s01.html#step-7---ladderfuelsrget_effective_gap"><i class="fa fa-check"></i><b>2.4.9</b> Step 7 - <code>LadderFuelsR::get_effective_gap</code></a></li>
<li class="chapter" data-level="2.4.10" data-path="s01.html"><a href="s01.html#step-8---ladderfuelsrget_layers_lad"><i class="fa fa-check"></i><b>2.4.10</b> Step 8 - <code>LadderFuelsR::get_layers_lad</code></a></li>
<li class="chapter" data-level="2.4.11" data-path="s01.html"><a href="s01.html#step-9---ladderfuelsrget_cbh_dist-ladderfuelsrget_cbh_metrics"><i class="fa fa-check"></i><b>2.4.11</b> Step 9 - <del><code>LadderFuelsR::get_cbh_dist</code></del> <code>LadderFuelsR::get_cbh_metrics</code></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="s02.html"><a href="s02.html"><i class="fa fa-check"></i><b>3</b> CBH Process</a>
<ul>
<li class="chapter" data-level="3.1" data-path="s02.html"><a href="s02.html#get-some-lidar-data"><i class="fa fa-check"></i><b>3.1</b> Get some lidar data</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="s02.html"><a href="s02.html#cloud2trees-that-lidar-data"><i class="fa fa-check"></i><b>3.1.1</b> <code>cloud2trees</code> that lidar data</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="s02.html"><a href="s02.html#define-ladderfuelsr-processing-function"><i class="fa fa-check"></i><b>3.2</b> Define <code>LadderFuelsR</code> Processing Function</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="s02.html"><a href="s02.html#return-cbh-metrics"><i class="fa fa-check"></i><b>3.2.1</b> Return CBH Metrics</a></li>
<li class="chapter" data-level="3.2.2" data-path="s02.html"><a href="s02.html#cbh-on-the-point-cloud"><i class="fa fa-check"></i><b>3.2.2</b> CBH on the point cloud</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="s02.html"><a href="s02.html#function-to-cbh-a-tree-list"><i class="fa fa-check"></i><b>3.3</b> Function to CBH a tree list</a></li>
<li class="chapter" data-level="3.4" data-path="s02.html"><a href="s02.html#test_l"><i class="fa fa-check"></i><b>3.4</b> Test CBH process - lidar</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="s02.html"><a href="s02.html#comparison-to-ladderfuelsr-defaults"><i class="fa fa-check"></i><b>3.4.1</b> Comparison to <code>LadderFuelsR</code> defaults</a></li>
<li class="chapter" data-level="3.4.2" data-path="s02.html"><a href="s02.html#test-cbh-based-on-parameterization-of-ladderfuelsr"><i class="fa fa-check"></i><b>3.4.2</b> test CBH based on parameterization of <code id="test_l2">LadderFuelsR</code></a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="s02.html"><a href="s02.html#test-cbh-process---uas"><i class="fa fa-check"></i><b>3.5</b> Test CBH process - UAS</a>
<ul>
<li class="chapter" data-level="3.5.1" data-path="s02.html"><a href="s02.html#cloud2trees-that-uas-data"><i class="fa fa-check"></i><b>3.5.1</b> <code>cloud2trees</code> that UAS data</a></li>
<li class="chapter" data-level="3.5.2" data-path="s02.html"><a href="s02.html#extract-cbh-example"><i class="fa fa-check"></i><b>3.5.2</b> Extract CBH example</a></li>
<li class="chapter" data-level="3.5.3" data-path="s02.html"><a href="s02.html#test-cbh-based-on-parameterization-of-ladderfuelsr-1"><i class="fa fa-check"></i><b>3.5.3</b> test CBH based on parameterization of <code>LadderFuelsR</code></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="s03.html"><a href="s03.html"><i class="fa fa-check"></i><b>4</b> Species Process</a>
<ul>
<li class="chapter" data-level="4.1" data-path="s03.html"><a href="s03.html#rmnp_ex"><i class="fa fa-check"></i><b>4.1</b> Example Lidar Data</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="s03.html"><a href="s03.html#cloud2trees-that-lidar-data-1"><i class="fa fa-check"></i><b>4.1.1</b> <code>cloud2trees</code> that lidar data</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="s03.html"><a href="s03.html#usfs-national-forest-type-group-dataset"><i class="fa fa-check"></i><b>4.2</b> USFS National Forest Type Group dataset</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="s03.html"><a href="s03.html#get-the-data"><i class="fa fa-check"></i><b>4.2.1</b> Get the data</a></li>
<li class="chapter" data-level="4.2.2" data-path="s03.html"><a href="s03.html#check-the-raster"><i class="fa fa-check"></i><b>4.2.2</b> Check the raster</a></li>
<li class="chapter" data-level="4.2.3" data-path="s03.html"><a href="s03.html#forest-type-group-data"><i class="fa fa-check"></i><b>4.2.3</b> Forest type group data</a></li>
<li class="chapter" data-level="4.2.4" data-path="s03.html"><a href="s03.html#forest-type-group-example"><i class="fa fa-check"></i><b>4.2.4</b> Forest type group example</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="s03.html"><a href="s03.html#forest-type-to-tree-list"><i class="fa fa-check"></i><b>4.3</b> Forest Type to Tree List</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="s03.html"><a href="s03.html#example-with-original-forest-type"><i class="fa fa-check"></i><b>4.3.1</b> Example with original forest type</a></li>
<li class="chapter" data-level="4.3.2" data-path="s03.html"><a href="s03.html#fill-missing-forest-type-example"><i class="fa fa-check"></i><b>4.3.2</b> Fill missing forest type example</a></li>
<li class="chapter" data-level="4.3.3" data-path="s03.html"><a href="s03.html#fill-missing-forest-type-resilience"><i class="fa fa-check"></i><b>4.3.3</b> Fill missing forest type resilience</a></li>
<li class="chapter" data-level="4.3.4" data-path="s03.html"><a href="s03.html#get-forest-type-function"><i class="fa fa-check"></i><b>4.3.4</b> Get forest type function</a></li>
</ul></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Aerial LiDAR for Fire Model Inputs</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="s02" class="section level1 hasAnchor" number="3">
<h1><span class="header-section-number">Section 3</span> CBH Process<a href="s02.html#s02" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>In this <a href="s02.html#s02">prior section</a> we reviewed the methodologies to process lidar data, extract a tree list, and estimate CBH.</p>
<p>Presently, we will outline the end-to-end process for accomplishing this task given some example lidar data.</p>
<div id="get-some-lidar-data" class="section level2 hasAnchor" number="3.1">
<h2><span class="header-section-number">3.1</span> Get some lidar data<a href="s02.html#get-some-lidar-data" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Let’s load an example lidar dataset from Weinstein et al. (<a href="https://scholar.google.com/scholar?cluster=4986448711981898434&amp;hl=en&amp;as_sdt=0,6">2021</a>) in their <code>NeonTreeEvaluation</code> package.</p>
<p>We’ll use data from a NEON site that we know has conifers: RMNP (Rocky Mountain National Park)</p>
<div class="sourceCode" id="cb160"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb160-1"><a href="s02.html#cb160-1" tabindex="-1"></a><span class="co"># let&#39;s see some field trees data</span></span>
<span id="cb160-2"><a href="s02.html#cb160-2" tabindex="-1"></a>NeonTreeEvaluation<span class="sc">::</span>field <span class="sc">%&gt;%</span> </span>
<span id="cb160-3"><a href="s02.html#cb160-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(siteID <span class="sc">==</span> <span class="st">&quot;RMNP&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb160-4"><a href="s02.html#cb160-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(taxonID) <span class="sc">%&gt;%</span> </span>
<span id="cb160-5"><a href="s02.html#cb160-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(n))</span></code></pre></div>
<pre><code>##   taxonID   n
## 1   PICOL 773
## 2   POTR5 292
## 3   PIPOS  91
## 4    PSME  89
## 5   ABLAL  57
## 6    PIEN  39
## 7   PIFL2  34</code></pre>
<p>let’s pick a site with the lowest proportion of POTR5</p>
<div class="sourceCode" id="cb162"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb162-1"><a href="s02.html#cb162-1" tabindex="-1"></a>plots_temp <span class="ot">&lt;-</span> NeonTreeEvaluation<span class="sc">::</span>field <span class="sc">%&gt;%</span> </span>
<span id="cb162-2"><a href="s02.html#cb162-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(siteID <span class="sc">==</span> <span class="st">&quot;RMNP&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb162-3"><a href="s02.html#cb162-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(plotID) <span class="sc">%&gt;%</span> </span>
<span id="cb162-4"><a href="s02.html#cb162-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb162-5"><a href="s02.html#cb162-5" tabindex="-1"></a>    <span class="at">trees =</span> dplyr<span class="sc">::</span><span class="fu">n</span>()</span>
<span id="cb162-6"><a href="s02.html#cb162-6" tabindex="-1"></a>    , <span class="at">conifers =</span> <span class="fu">sum</span>(<span class="fu">ifelse</span>(taxonID<span class="sc">==</span><span class="st">&quot;POTR5&quot;</span>, <span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb162-7"><a href="s02.html#cb162-7" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb162-8"><a href="s02.html#cb162-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pct_conifer =</span> conifers<span class="sc">/</span>trees) <span class="sc">%&gt;%</span> </span>
<span id="cb162-9"><a href="s02.html#cb162-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(trees<span class="sc">&gt;</span><span class="dv">20</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb162-10"><a href="s02.html#cb162-10" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(pct_conifer), <span class="fu">desc</span>(trees))</span>
<span id="cb162-11"><a href="s02.html#cb162-11" tabindex="-1"></a>plots_temp</span></code></pre></div>
<pre><code>## # A tibble: 20 × 4
##    plotID   trees conifers pct_conifer
##    &lt;fct&gt;    &lt;int&gt;    &lt;dbl&gt;       &lt;dbl&gt;
##  1 RMNP_042   111      111       1    
##  2 RMNP_043   104      104       1    
##  3 RMNP_047    59       59       1    
##  4 RMNP_008    50       50       1    
##  5 RMNP_048    50       50       1    
##  6 RMNP_001    41       41       1    
##  7 RMNP_006    39       39       1    
##  8 RMNP_014    36       36       1    
##  9 RMNP_012    35       35       1    
## 10 RMNP_003    30       30       1    
## 11 RMNP_018    29       29       1    
## 12 RMNP_005    24       24       1    
## 13 RMNP_002    21       21       1    
## 14 RMNP_041   131      128       0.977
## 15 RMNP_004    27       26       0.963
## 16 RMNP_049    36       34       0.944
## 17 RMNP_007    30       24       0.8  
## 18 RMNP_044   111       68       0.613
## 19 RMNP_045   229       57       0.249
## 20 RMNP_046    73       13       0.178</code></pre>
<p>get the lidar data</p>
<div class="sourceCode" id="cb164"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb164-1"><a href="s02.html#cb164-1" tabindex="-1"></a><span class="co"># get the laz file path</span></span>
<span id="cb164-2"><a href="s02.html#cb164-2" tabindex="-1"></a>las_f_path <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">system.file</span>(<span class="at">package =</span> <span class="st">&quot;NeonTreeEvaluation&quot;</span>),<span class="st">&quot;/extdata/&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb164-3"><a href="s02.html#cb164-3" tabindex="-1"></a>    <span class="fu">list.files</span>(<span class="at">recursive =</span> T, <span class="at">pattern =</span> <span class="st">&quot;.*</span><span class="sc">\\</span><span class="st">.(laz|las)$&quot;</span>, <span class="at">full.names =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb164-4"><a href="s02.html#cb164-4" tabindex="-1"></a>    <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb164-5"><a href="s02.html#cb164-5" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb164-6"><a href="s02.html#cb164-6" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">f_path =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb164-7"><a href="s02.html#cb164-7" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb164-8"><a href="s02.html#cb164-8" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_detect</span>(f_path,  <span class="fu">as.character</span>(plots_temp[<span class="dv">1</span>,]<span class="sc">$</span>plotID))</span>
<span id="cb164-9"><a href="s02.html#cb164-9" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb164-10"><a href="s02.html#cb164-10" tabindex="-1"></a>    .[<span class="dv">1</span>] <span class="sc">%&gt;%</span> </span>
<span id="cb164-11"><a href="s02.html#cb164-11" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(f_path)</span>
<span id="cb164-12"><a href="s02.html#cb164-12" tabindex="-1"></a><span class="co"># check the data</span></span>
<span id="cb164-13"><a href="s02.html#cb164-13" tabindex="-1"></a>lidR<span class="sc">::</span><span class="fu">readLAS</span>(las_f_path)</span></code></pre></div>
<pre><code>## class        : LAS (v1.3 format 1)
## memory       : 1.2 Mb 
## extent       : 453532.6, 453572.6, 4458556, 4458596 (xmin, xmax, ymin, ymax)
## coord. ref.  : WGS 84 / UTM zone 13N 
## area         : 1653 m²
## points       : 20.4 thousand points
## density      : 12.35 points/m²
## density      : 7.63 pulses/m²</code></pre>
<p>where in the world is this data?</p>
<div class="sourceCode" id="cb166"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb166-1"><a href="s02.html#cb166-1" tabindex="-1"></a>las_ctg <span class="ot">&lt;-</span> lidR<span class="sc">::</span><span class="fu">readLAScatalog</span>(las_f_path)</span>
<span id="cb166-2"><a href="s02.html#cb166-2" tabindex="-1"></a>mapview<span class="sc">::</span><span class="fu">mapview</span>(las_ctg<span class="sc">@</span>data)</span></code></pre></div>
<div class="leaflet html-widget html-fill-item" id="htmlwidget-6155ead1c32e37e7359f" style="width:1008px;height:672px;"></div>
<script type="application/json" data-for="htmlwidget-6155ead1c32e37e7359f">{"x":{"options":{"minZoom":1,"maxZoom":52,"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}},"preferCanvas":false,"bounceAtZoomLimits":false,"maxBounds":[[[-90,-370]],[[90,370]]]},"calls":[{"method":"addProviderTiles","args":["OpenStreetMap","OpenStreetMap","OpenStreetMap",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["Esri.WorldImagery","Esri.WorldImagery","Esri.WorldImagery",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"createMapPane","args":["polygon",420]},{"method":"addPolygons","args":[[[[{"lng":[-105.5465792276325,-105.5465821289829,-105.5461116533473,-105.546108754494,-105.5465792276325],"lat":[40.27619328566198,40.27655360805593,40.2765558295054,40.27619550708332,40.27619328566198]}]]],null,"las_ctg@data",{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}},"pane":"polygon","stroke":true,"color":"#333333","weight":0.5,"opacity":0.9,"fill":true,"fillColor":"#6666FF","fillOpacity":0.6,"smoothFactor":1,"noClip":false},"<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>1&emsp;<\/td><\/tr><tr><td>1<\/td><th>File.Signature&emsp;<\/th><td>LASF\u0002&emsp;<\/td><\/tr><tr><td>2<\/td><th>File.Source.ID&emsp;<\/th><td>2&emsp;<\/td><\/tr><tr><td>3<\/td><th>GUID&emsp;<\/th><td>00000000-0000-0000-0000-000000000000&emsp;<\/td><\/tr><tr><td>4<\/td><th>Version.Major&emsp;<\/th><td>1&emsp;<\/td><\/tr><tr><td>5<\/td><th>Version.Minor&emsp;<\/th><td>3&emsp;<\/td><\/tr><tr><td>6<\/td><th>System.Identifier&emsp;<\/th><td>&emsp;<\/td><\/tr><tr><td>7<\/td><th>Generating.Software&emsp;<\/th><td>rlas R package&emsp;<\/td><\/tr><tr><td>8<\/td><th>File.Creation.Day.of.Year&emsp;<\/th><td>0&emsp;<\/td><\/tr><tr><td>9<\/td><th>File.Creation.Year&emsp;<\/th><td>2018&emsp;<\/td><\/tr><tr><td>10<\/td><th>Header.Size&emsp;<\/th><td>235&emsp;<\/td><\/tr><tr><td>11<\/td><th>Offset.to.point.data&emsp;<\/th><td>1077&emsp;<\/td><\/tr><tr><td>12<\/td><th>Number.of.variable.length.records&emsp;<\/th><td>2&emsp;<\/td><\/tr><tr><td>13<\/td><th>Point.Data.Format.ID&emsp;<\/th><td>1&emsp;<\/td><\/tr><tr><td>14<\/td><th>Point.Data.Record.Length&emsp;<\/th><td>28&emsp;<\/td><\/tr><tr><td>15<\/td><th>Number.of.point.records&emsp;<\/th><td>20407&emsp;<\/td><\/tr><tr><td>16<\/td><th>X.scale.factor&emsp;<\/th><td>0.001&emsp;<\/td><\/tr><tr><td>17<\/td><th>Y.scale.factor&emsp;<\/th><td>0.001&emsp;<\/td><\/tr><tr><td>18<\/td><th>Z.scale.factor&emsp;<\/th><td>0.001&emsp;<\/td><\/tr><tr><td>19<\/td><th>X.offset&emsp;<\/th><td>450000&emsp;<\/td><\/tr><tr><td>20<\/td><th>Y.offset&emsp;<\/th><td>4450000&emsp;<\/td><\/tr><tr><td>21<\/td><th>Z.offset&emsp;<\/th><td>0&emsp;<\/td><\/tr><tr><td>22<\/td><th>Max.X&emsp;<\/th><td>453572.6&emsp;<\/td><\/tr><tr><td>23<\/td><th>Min.X&emsp;<\/th><td>453532.6&emsp;<\/td><\/tr><tr><td>24<\/td><th>Max.Y&emsp;<\/th><td>4458596&emsp;<\/td><\/tr><tr><td>25<\/td><th>Min.Y&emsp;<\/th><td>4458556&emsp;<\/td><\/tr><tr><td>26<\/td><th>Max.Z&emsp;<\/th><td>2762.425&emsp;<\/td><\/tr><tr><td>27<\/td><th>Min.Z&emsp;<\/th><td>2742.063&emsp;<\/td><\/tr><tr><td>28<\/td><th>CRS&emsp;<\/th><td>32613&emsp;<\/td><\/tr><tr><td>29<\/td><th>Number.of.1st.return&emsp;<\/th><td>12612&emsp;<\/td><\/tr><tr><td>30<\/td><th>Number.of.2nd.return&emsp;<\/th><td>4365&emsp;<\/td><\/tr><tr><td>31<\/td><th>Number.of.3rd.return&emsp;<\/th><td>2284&emsp;<\/td><\/tr><tr><td>32<\/td><th>Number.of.4th.return&emsp;<\/th><td>881&emsp;<\/td><\/tr><tr><td>33<\/td><th>Number.of.5th.return&emsp;<\/th><td>216&emsp;<\/td><\/tr><tr><td>34<\/td><th>filename&emsp;<\/th><td>C:\\Program Files\\R\\R-4.3.0\\library\\NeonTreeEvaluation\\extdata\\NeonTreeEvaluation\\evaluation\\LiDAR\\RMNP_042_2018.laz&emsp;<\/td><\/tr><tr><td>35<\/td><th>geometry&emsp;<\/th><td>sfc_POLYGON&emsp;<\/td><\/tr><\/table><\/div>",{"maxWidth":800,"minWidth":50,"autoPan":true,"keepInView":false,"closeButton":true,"closeOnClick":true,"className":""},"1",{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},{"stroke":true,"weight":1,"opacity":0.9,"fillOpacity":0.84,"bringToFront":false,"sendToBack":false}]},{"method":"addScaleBar","args":[{"maxWidth":100,"metric":true,"imperial":true,"updateWhenIdle":true,"position":"bottomleft"}]},{"method":"addLayersControl","args":[["OpenStreetMap","Esri.WorldImagery"],"las_ctg@data",{"collapsed":true,"autoZIndex":true,"position":"topleft"}]},{"method":"addLegend","args":[{"colors":["#6666FF"],"labels":["las_ctg@data"],"na_color":null,"na_label":"NA","opacity":1,"position":"topright","type":"factor","title":"","extra":null,"layerId":null,"className":"info legend","group":"las_ctg@data"}]}],"limits":{"lat":[40.27619328566198,40.2765558295054],"lng":[-105.5465821289829,-105.546108754494]},"fitBounds":[40.27619328566198,-105.5465821289829,40.2765558295054,-105.546108754494,[]]},"evals":[],"jsHooks":{"render":[{"code":"function(el, x, data) {\n  return (\n      function(el, x, data) {\n      // get the leaflet map\n      var map = this; //HTMLWidgets.find('#' + el.id);\n      // we need a new div element because we have to handle\n      // the mouseover output separately\n      // debugger;\n      function addElement () {\n      // generate new div Element\n      var newDiv = $(document.createElement('div'));\n      // append at end of leaflet htmlwidget container\n      $(el).append(newDiv);\n      //provide ID and style\n      newDiv.addClass('lnlt');\n      newDiv.css({\n      'position': 'relative',\n      'bottomleft':  '0px',\n      'background-color': 'rgba(255, 255, 255, 0.7)',\n      'box-shadow': '0 0 2px #bbb',\n      'background-clip': 'padding-box',\n      'margin': '0',\n      'padding-left': '5px',\n      'color': '#333',\n      'font': '9px/1.5 \"Helvetica Neue\", Arial, Helvetica, sans-serif',\n      'z-index': '700',\n      });\n      return newDiv;\n      }\n\n\n      // check for already existing lnlt class to not duplicate\n      var lnlt = $(el).find('.lnlt');\n\n      if(!lnlt.length) {\n      lnlt = addElement();\n\n      // grab the special div we generated in the beginning\n      // and put the mousmove output there\n\n      map.on('mousemove', function (e) {\n      if (e.originalEvent.ctrlKey) {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                           ' lon: ' + (e.latlng.lng).toFixed(5) +\n                           ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                           ' | zoom: ' + map.getZoom() +\n                           ' | x: ' + L.CRS.EPSG3857.project(e.latlng).x.toFixed(0) +\n                           ' | y: ' + L.CRS.EPSG3857.project(e.latlng).y.toFixed(0) +\n                           ' | epsg: 3857 ' +\n                           ' | proj4: +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs ');\n      } else {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                      ' | zoom: ' + map.getZoom() + ' ');\n      }\n      });\n\n      // remove the lnlt div when mouse leaves map\n      map.on('mouseout', function (e) {\n      var strip = document.querySelector('.lnlt');\n      if( strip !==null) strip.remove();\n      });\n\n      };\n\n      //$(el).keypress(67, function(e) {\n      map.on('preclick', function(e) {\n      if (e.originalEvent.ctrlKey) {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                      ' | zoom: ' + map.getZoom() + ' ');\n      var txt = document.querySelector('.lnlt').textContent;\n      console.log(txt);\n      //txt.innerText.focus();\n      //txt.select();\n      setClipboardText('\"' + txt + '\"');\n      }\n      });\n\n      }\n      ).call(this.getMap(), el, x, data);\n}","data":null},{"code":"function(el, x, data) {\n  return (function(el,x,data){\n           var map = this;\n\n           map.on('keypress', function(e) {\n               console.log(e.originalEvent.code);\n               var key = e.originalEvent.code;\n               if (key === 'KeyE') {\n                   var bb = this.getBounds();\n                   var txt = JSON.stringify(bb);\n                   console.log(txt);\n\n                   setClipboardText('\\'' + txt + '\\'');\n               }\n           })\n        }).call(this.getMap(), el, x, data);\n}","data":null}]}}</script>
<p><em>zoom out if you can’t see anything</em></p>
<p>let’s read one file</p>
<div class="sourceCode" id="cb167"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb167-1"><a href="s02.html#cb167-1" tabindex="-1"></a>las <span class="ot">&lt;-</span> lidR<span class="sc">::</span><span class="fu">readLAS</span>(las_f_path)</span>
<span id="cb167-2"><a href="s02.html#cb167-2" tabindex="-1"></a>las</span></code></pre></div>
<pre><code>## class        : LAS (v1.3 format 1)
## memory       : 1.2 Mb 
## extent       : 453532.6, 453572.6, 4458556, 4458596 (xmin, xmax, ymin, ymax)
## coord. ref.  : WGS 84 / UTM zone 13N 
## area         : 1653 m²
## points       : 20.4 thousand points
## density      : 12.35 points/m²
## density      : 7.63 pulses/m²</code></pre>
<p>plot a sample</p>
<div class="sourceCode" id="cb169"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb169-1"><a href="s02.html#cb169-1" tabindex="-1"></a>las <span class="sc">%&gt;%</span> </span>
<span id="cb169-2"><a href="s02.html#cb169-2" tabindex="-1"></a>  lidR<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb169-3"><a href="s02.html#cb169-3" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">&quot;Z&quot;</span>, <span class="at">breaks =</span> <span class="st">&quot;quantile&quot;</span>, <span class="at">bg =</span> <span class="st">&quot;white&quot;</span>, <span class="at">legend =</span> T</span>
<span id="cb169-4"><a href="s02.html#cb169-4" tabindex="-1"></a>   , <span class="at">pal =</span> harrypotter<span class="sc">::</span><span class="fu">hp</span>(<span class="at">n=</span><span class="dv">50</span>, <span class="at">house =</span> <span class="st">&quot;gryffindor&quot;</span>)</span>
<span id="cb169-5"><a href="s02.html#cb169-5" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-106-1.png" width="1008" /></p>
<div id="cloud2trees-that-lidar-data" class="section level3 hasAnchor" number="3.1.1">
<h3><span class="header-section-number">3.1.1</span> <code>cloud2trees</code> that lidar data<a href="s02.html#cloud2trees-that-lidar-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>extract trees from the lidar data using <code>cloud2trees</code> to create some example tree-level point cloud data to test the <code>LadderFuelsR</code> function we define below with</p>
<div class="sourceCode" id="cb170"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb170-1"><a href="s02.html#cb170-1" tabindex="-1"></a>cloud2trees_ans <span class="ot">&lt;-</span> cloud2trees<span class="sc">::</span><span class="fu">cloud2trees</span>(</span>
<span id="cb170-2"><a href="s02.html#cb170-2" tabindex="-1"></a>  <span class="at">input_las_dir =</span> las_f_path</span>
<span id="cb170-3"><a href="s02.html#cb170-3" tabindex="-1"></a>  , <span class="at">output_dir =</span> <span class="st">&quot;../data&quot;</span></span>
<span id="cb170-4"><a href="s02.html#cb170-4" tabindex="-1"></a>  , <span class="at">estimate_tree_dbh =</span> F</span>
<span id="cb170-5"><a href="s02.html#cb170-5" tabindex="-1"></a>  , <span class="at">keep_intrmdt =</span> T</span>
<span id="cb170-6"><a href="s02.html#cb170-6" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## Read files headers: [==========] 100% (1 threads)                    Overall: [          ] 0% (1 threads) | : no progress                     Overall: [          ] 0% (1 threads) | read_las: [          ] 0% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [          ] 1% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [          ] 2% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [          ] 3% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [          ] 4% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [          ] 5% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [          ] 6% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [          ] 7% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [          ] 8% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [          ] 9% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [=         ] 10% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [=         ] 11% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [=         ] 12% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [=         ] 13% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [=         ] 14% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [=         ] 15% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [=         ] 16% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [=         ] 17% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [=         ] 18% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [=         ] 19% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [==        ] 20% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [==        ] 21% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [==        ] 22% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [==        ] 23% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [==        ] 24% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [==        ] 25% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [==        ] 26% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [==        ] 27% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [==        ] 28% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [==        ] 29% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [===       ] 30% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [===       ] 31% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [===       ] 32% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [===       ] 33% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [===       ] 34% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [===       ] 35% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [===       ] 36% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [===       ] 37% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [===       ] 38% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [===       ] 39% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [====      ] 40% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [====      ] 41% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [====      ] 42% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [====      ] 43% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [====      ] 44% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [====      ] 45% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [====      ] 46% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [====      ] 47% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [====      ] 48% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [====      ] 49% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [=====     ] 50% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [=====     ] 51% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [=====     ] 52% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [=====     ] 53% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [=====     ] 54% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [=====     ] 55% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [=====     ] 56% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [=====     ] 57% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [=====     ] 58% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [=====     ] 59% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [======    ] 60% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [======    ] 61% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [======    ] 62% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [======    ] 63% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [======    ] 64% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [======    ] 65% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [======    ] 66% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [======    ] 67% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [======    ] 68% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [======    ] 69% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [=======   ] 70% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [=======   ] 71% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [=======   ] 72% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [=======   ] 73% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [=======   ] 74% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [=======   ] 75% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [=======   ] 76% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [=======   ] 77% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [=======   ] 78% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [=======   ] 79% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [========  ] 80% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [========  ] 81% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [========  ] 82% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [========  ] 83% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [========  ] 84% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [========  ] 85% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [========  ] 86% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [========  ] 87% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [========  ] 88% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [========  ] 89% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [========= ] 90% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [========= ] 91% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [========= ] 92% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [========= ] 93% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [========= ] 94% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [========= ] 95% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [========= ] 96% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [========= ] 97% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [========= ] 98% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [========= ] 99% (1 threads)                    Overall: [          ] 0% (1 threads) | read_las: [==========] 100% (1 threads)                    Overall: [          ] 0% (1 threads) | CSF: no progress                     Overall: [          ] 0% (1 threads) | Write LAS: [          ] 0% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [          ] 1% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [          ] 2% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [          ] 3% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [          ] 4% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [          ] 5% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [          ] 6% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [          ] 7% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [          ] 8% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [          ] 9% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=         ] 10% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=         ] 11% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=         ] 12% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=         ] 13% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=         ] 14% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=         ] 15% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=         ] 16% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=         ] 17% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=         ] 18% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=         ] 19% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [==        ] 20% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [==        ] 21% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [==        ] 22% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [==        ] 23% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [==        ] 24% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [==        ] 25% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [==        ] 26% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [==        ] 27% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [==        ] 28% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [==        ] 29% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [===       ] 30% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [===       ] 31% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [===       ] 32% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [===       ] 33% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [===       ] 34% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [===       ] 35% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [===       ] 36% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [===       ] 37% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [===       ] 38% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [===       ] 39% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [====      ] 40% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [====      ] 41% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [====      ] 42% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [====      ] 43% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [====      ] 44% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [====      ] 45% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [====      ] 46% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [====      ] 47% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [====      ] 48% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [====      ] 49% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=====     ] 50% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=====     ] 51% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=====     ] 52% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=====     ] 53% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=====     ] 54% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=====     ] 55% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=====     ] 56% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=====     ] 57% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=====     ] 58% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=====     ] 59% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [======    ] 60% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [======    ] 61% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [======    ] 62% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [======    ] 63% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [======    ] 64% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [======    ] 65% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [======    ] 66% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [======    ] 67% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [======    ] 68% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [======    ] 69% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=======   ] 70% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=======   ] 71% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=======   ] 72% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=======   ] 73% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=======   ] 74% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=======   ] 75% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=======   ] 76% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=======   ] 77% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=======   ] 78% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=======   ] 79% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========  ] 80% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========  ] 81% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========  ] 82% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========  ] 83% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========  ] 84% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========  ] 85% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========  ] 86% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========  ] 87% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========  ] 88% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========  ] 89% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========= ] 90% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========= ] 91% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========= ] 92% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========= ] 93% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========= ] 94% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========= ] 95% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========= ] 96% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========= ] 97% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========= ] 98% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========= ] 99% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [==========] 100% (1 threads)                    Overall: [          ] 0% (1 threads) | Delaunay triangulation: no progress                     Overall: [          ] 0% (1 threads) | Delaunay triangulation: no progress                     Overall: [          ] 0% (1 threads) | Interpolation: [          ] 0% (10 threads)                    Overall: [          ] 0% (1 threads) | Interpolation: [          ] 1% (10 threads)                    Overall: [          ] 0% (1 threads) | Interpolation: [          ] 2% (10 threads)                    Overall: [          ] 0% (1 threads) | Interpolation: [          ] 3% (10 threads)                    Overall: [          ] 0% (1 threads) | Interpolation: [          ] 4% (10 threads)                    Overall: [          ] 0% (1 threads) | Interpolation: [          ] 5% (10 threads)                    Overall: [          ] 0% (1 threads) | Interpolation: [          ] 6% (10 threads)                    Overall: [          ] 0% (1 threads) | Interpolation: [          ] 7% (10 threads)                    Overall: [          ] 0% (1 threads) | Interpolation: [          ] 8% (10 threads)                    Overall: [          ] 0% (1 threads) | Interpolation: [          ] 9% (10 threads)                    Overall: [          ] 0% (1 threads) | Interpolation: [==========] 100% (10 threads)                    Overall: [          ] 0% (1 threads) | Interpolation: [          ] 0% (10 threads)                    Overall: [          ] 0% (1 threads) | Interpolation: [          ] 1% (10 threads)                    Overall: [          ] 0% (1 threads) | Interpolation: [          ] 2% (10 threads)                    Overall: [          ] 0% (1 threads) | Interpolation: [          ] 3% (10 threads)                    Overall: [          ] 0% (1 threads) | Interpolation: [          ] 4% (10 threads)                    Overall: [          ] 0% (1 threads) | Interpolation: [          ] 5% (10 threads)                    Overall: [          ] 0% (1 threads) | Interpolation: [          ] 6% (10 threads)                    Overall: [          ] 0% (1 threads) | Interpolation: [          ] 7% (10 threads)                    Overall: [          ] 0% (1 threads) | Interpolation: [          ] 8% (10 threads)                    Overall: [          ] 0% (1 threads) | Interpolation: [          ] 9% (10 threads)                    Overall: [          ] 0% (1 threads) | Interpolation: [==========] 100% (10 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [          ] 0% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [          ] 1% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [          ] 2% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [          ] 3% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [          ] 4% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [          ] 5% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [          ] 6% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [          ] 7% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [          ] 8% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [          ] 9% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=         ] 10% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=         ] 11% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=         ] 12% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=         ] 13% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=         ] 14% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=         ] 15% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=         ] 16% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=         ] 17% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=         ] 18% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=         ] 19% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [==        ] 20% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [==        ] 21% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [==        ] 22% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [==        ] 23% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [==        ] 24% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [==        ] 25% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [==        ] 26% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [==        ] 27% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [==        ] 28% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [==        ] 29% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [===       ] 30% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [===       ] 31% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [===       ] 32% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [===       ] 33% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [===       ] 34% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [===       ] 35% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [===       ] 36% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [===       ] 37% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [===       ] 38% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [===       ] 39% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [====      ] 40% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [====      ] 41% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [====      ] 42% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [====      ] 43% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [====      ] 44% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [====      ] 45% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [====      ] 46% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [====      ] 47% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [====      ] 48% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [====      ] 49% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=====     ] 50% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=====     ] 51% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=====     ] 52% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=====     ] 53% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=====     ] 54% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=====     ] 55% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=====     ] 56% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=====     ] 57% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=====     ] 58% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=====     ] 59% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [======    ] 60% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [======    ] 61% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [======    ] 62% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [======    ] 63% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [======    ] 64% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [======    ] 65% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [======    ] 66% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [======    ] 67% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [======    ] 68% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [======    ] 69% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=======   ] 70% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=======   ] 71% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=======   ] 72% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=======   ] 73% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=======   ] 74% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=======   ] 75% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=======   ] 76% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=======   ] 77% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=======   ] 78% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [=======   ] 79% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========  ] 80% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========  ] 81% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========  ] 82% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========  ] 83% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========  ] 84% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========  ] 85% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========  ] 86% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========  ] 87% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========  ] 88% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========  ] 89% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========= ] 90% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========= ] 91% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========= ] 92% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========= ] 93% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========= ] 94% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========= ] 95% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========= ] 96% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========= ] 97% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========= ] 98% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [========= ] 99% (1 threads)                    Overall: [          ] 0% (1 threads) | Write LAS: [==========] 100% (1 threads)                    Overall: [==========] 100% (1 threads) |                     Overall: [==========] 100% (1 threads)                    </code></pre>
<div class="sourceCode" id="cb172"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb172-1"><a href="s02.html#cb172-1" tabindex="-1"></a>norm_las_dir <span class="ot">&lt;-</span> <span class="st">&quot;../data/point_cloud_processing_temp/02_normalize/&quot;</span></span>
<span id="cb172-2"><a href="s02.html#cb172-2" tabindex="-1"></a><span class="co"># what?</span></span>
<span id="cb172-3"><a href="s02.html#cb172-3" tabindex="-1"></a>cloud2trees_ans <span class="sc">%&gt;%</span> <span class="fu">names</span>()</span></code></pre></div>
<pre><code>## [1] &quot;crowns_sf&quot;   &quot;treetops_sf&quot; &quot;dtm_rast&quot;    &quot;chm_rast&quot;</code></pre>
<div class="sourceCode" id="cb174"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb174-1"><a href="s02.html#cb174-1" tabindex="-1"></a>cloud2trees_ans<span class="sc">$</span>crowns_sf <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 107
## Columns: 22
## $ treeID                    &lt;chr&gt; &quot;1_453532.6_4458594.6&quot;, &quot;2_453544.6_4458594.…
## $ tree_height_m             &lt;dbl&gt; 3.185, 12.866, 11.826, 4.287, 8.980, 7.009, …
## $ tree_x                    &lt;dbl&gt; 453532.6, 453544.6, 453542.6, 453547.4, 4535…
## $ tree_y                    &lt;dbl&gt; 4458595, 4458595, 4458594, 4458593, 4458592,…
## $ crown_area_m2             &lt;dbl&gt; 0.8750, 10.0000, 11.0625, 0.5625, 5.1875, 1.…
## $ geometry                  &lt;GEOMETRY [m]&gt; POLYGON ((453532.5 4458595,..., POL…
## $ fia_est_dbh_cm            &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ fia_est_dbh_cm_lower      &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ fia_est_dbh_cm_upper      &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ dbh_cm                    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ is_training_data          &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ dbh_m                     &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ radius_m                  &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ basal_area_m2             &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ basal_area_ft2            &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ ptcld_extracted_dbh_cm    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ ptcld_predicted_dbh_cm    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ tree_cbh_m                &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ is_training_cbh           &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ comp_trees_per_ha         &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ comp_relative_tree_height &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ comp_dist_to_nearest_m    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …</code></pre>
<p>clean it for <code>LadderFuelsR</code> to attach treeID to the point cloud</p>
<div class="sourceCode" id="cb176"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb176-1"><a href="s02.html#cb176-1" tabindex="-1"></a><span class="co"># the lidR::merge_spatial requires only polygons so we need to rid the multipolygons</span></span>
<span id="cb176-2"><a href="s02.html#cb176-2" tabindex="-1"></a>crowns_sf_poly <span class="ot">&lt;-</span></span>
<span id="cb176-3"><a href="s02.html#cb176-3" tabindex="-1"></a>  <span class="co"># start with only polygons</span></span>
<span id="cb176-4"><a href="s02.html#cb176-4" tabindex="-1"></a>  cloud2trees_ans<span class="sc">$</span>crowns_sf <span class="sc">%&gt;%</span> </span>
<span id="cb176-5"><a href="s02.html#cb176-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_geometry_type</span>(.)<span class="sc">==</span><span class="st">&quot;POLYGON&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb176-6"><a href="s02.html#cb176-6" tabindex="-1"></a>  <span class="co"># union on cleaned multipolygons</span></span>
<span id="cb176-7"><a href="s02.html#cb176-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb176-8"><a href="s02.html#cb176-8" tabindex="-1"></a>    cloud2trees_ans<span class="sc">$</span>crowns_sf <span class="sc">%&gt;%</span> </span>
<span id="cb176-9"><a href="s02.html#cb176-9" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_geometry_type</span>(.)<span class="sc">==</span><span class="st">&quot;MULTIPOLYGON&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb176-10"><a href="s02.html#cb176-10" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_cast</span>(<span class="at">to =</span> <span class="st">&quot;POLYGON&quot;</span>, <span class="at">do_split =</span> T, <span class="at">warn =</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb176-11"><a href="s02.html#cb176-11" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">axxx =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.)) <span class="sc">%&gt;%</span> <span class="co"># axxx is so we don&#39;t overwrite a column</span></span>
<span id="cb176-12"><a href="s02.html#cb176-12" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">group_by</span>(treeID) <span class="sc">%&gt;%</span> </span>
<span id="cb176-13"><a href="s02.html#cb176-13" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(axxx <span class="sc">==</span> <span class="fu">max</span>(axxx)) <span class="sc">%&gt;%</span> <span class="co"># keep the biggest crown polygon by treeID</span></span>
<span id="cb176-14"><a href="s02.html#cb176-14" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb176-15"><a href="s02.html#cb176-15" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>axxx)</span>
<span id="cb176-16"><a href="s02.html#cb176-16" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb176-17"><a href="s02.html#cb176-17" tabindex="-1"></a>  <span class="co"># generate a treeID index because it needs to be numeric</span></span>
<span id="cb176-18"><a href="s02.html#cb176-18" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb176-19"><a href="s02.html#cb176-19" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb176-20"><a href="s02.html#cb176-20" tabindex="-1"></a>    <span class="at">treeID_backup =</span> treeID</span>
<span id="cb176-21"><a href="s02.html#cb176-21" tabindex="-1"></a>    , <span class="at">treeID =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>()</span>
<span id="cb176-22"><a href="s02.html#cb176-22" tabindex="-1"></a>  )</span></code></pre></div>
<p>read in normalized las files and filter one for testing</p>
<div class="sourceCode" id="cb177"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb177-1"><a href="s02.html#cb177-1" tabindex="-1"></a><span class="co"># read in catalog</span></span>
<span id="cb177-2"><a href="s02.html#cb177-2" tabindex="-1"></a>crowns_nlas_ctg <span class="ot">&lt;-</span> lidR<span class="sc">::</span><span class="fu">readLAScatalog</span>(norm_las_dir)</span>
<span id="cb177-3"><a href="s02.html#cb177-3" tabindex="-1"></a><span class="co"># filter for single tree point cloud</span></span>
<span id="cb177-4"><a href="s02.html#cb177-4" tabindex="-1"></a>one_tree_sf <span class="ot">&lt;-</span> crowns_sf_poly <span class="sc">%&gt;%</span> </span>
<span id="cb177-5"><a href="s02.html#cb177-5" tabindex="-1"></a>  <span class="co"># get one of the taller trees</span></span>
<span id="cb177-6"><a href="s02.html#cb177-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(tree_height_m <span class="sc">&gt;=</span> <span class="fu">quantile</span>(crowns_sf_poly<span class="sc">$</span>tree_height_m, <span class="at">probs =</span> <span class="fl">0.9</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb177-7"><a href="s02.html#cb177-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice_sample</span>(<span class="at">n=</span><span class="dv">1</span>)</span></code></pre></div>
<p>now we’ll attach the <code>treeID</code> column to the normalized las file and keep only the points that fall within a tree crown.</p>
<div class="sourceCode" id="cb178"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb178-1"><a href="s02.html#cb178-1" tabindex="-1"></a><span class="co"># clip the point cloud</span></span>
<span id="cb178-2"><a href="s02.html#cb178-2" tabindex="-1"></a>nlas_one_tree <span class="ot">&lt;-</span> lidR<span class="sc">::</span><span class="fu">clip_roi</span>(</span>
<span id="cb178-3"><a href="s02.html#cb178-3" tabindex="-1"></a>    <span class="at">las =</span> crowns_nlas_ctg</span>
<span id="cb178-4"><a href="s02.html#cb178-4" tabindex="-1"></a>    , <span class="at">geometry =</span> one_tree_sf</span>
<span id="cb178-5"><a href="s02.html#cb178-5" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb178-6"><a href="s02.html#cb178-6" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_set_crs</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(crowns_sf_poly)) <span class="sc">%&gt;%</span> </span>
<span id="cb178-7"><a href="s02.html#cb178-7" tabindex="-1"></a>  lidR<span class="sc">::</span><span class="fu">merge_spatial</span>(</span>
<span id="cb178-8"><a href="s02.html#cb178-8" tabindex="-1"></a>    <span class="at">source =</span> crowns_sf_poly</span>
<span id="cb178-9"><a href="s02.html#cb178-9" tabindex="-1"></a>    , <span class="at">attribute =</span> <span class="st">&quot;treeID&quot;</span></span>
<span id="cb178-10"><a href="s02.html#cb178-10" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb178-11"><a href="s02.html#cb178-11" tabindex="-1"></a>  lidR<span class="sc">::</span><span class="fu">filter_poi</span>(<span class="sc">!</span><span class="fu">is.na</span>(treeID))</span>
<span id="cb178-12"><a href="s02.html#cb178-12" tabindex="-1"></a><span class="co"># what is this data?</span></span>
<span id="cb178-13"><a href="s02.html#cb178-13" tabindex="-1"></a>nlas_one_tree<span class="sc">@</span>data <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 250
## Columns: 17
## $ X                 &lt;dbl&gt; 453545.2, 453544.4, 453545.0, 453545.2, 453542.7, 45…
## $ Y                 &lt;dbl&gt; 4458559, 4458560, 4458560, 4458560, 4458560, 4458560…
## $ Z                 &lt;dbl&gt; 0.000, 10.796, 10.059, 8.604, 0.000, 0.000, 0.000, 8…
## $ gpstime           &lt;dbl&gt; 409990.2, 409990.2, 409990.2, 409990.2, 409990.2, 40…
## $ Intensity         &lt;int&gt; 57, 215, 75, 53, 88, 363, 421, 26, 63, 164, 76, 35, …
## $ ReturnNumber      &lt;int&gt; 2, 1, 1, 2, 4, 2, 1, 1, 2, 3, 1, 2, 3, 1, 2, 2, 1, 1…
## $ NumberOfReturns   &lt;int&gt; 2, 1, 3, 3, 4, 2, 1, 3, 3, 3, 3, 3, 3, 2, 2, 2, 1, 4…
## $ ScanDirectionFlag &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ EdgeOfFlightline  &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ Classification    &lt;int&gt; 2, 5, 5, 5, 2, 2, 2, 5, 5, 2, 5, 5, 2, 5, 5, 5, 5, 5…
## $ Synthetic_flag    &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FAL…
## $ Keypoint_flag     &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FAL…
## $ Withheld_flag     &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FAL…
## $ ScanAngleRank     &lt;int&gt; -7, -7, -7, -7, -7, -7, -7, -7, -7, -7, -7, -7, -7, …
## $ UserData          &lt;int&gt; 0, 108, 101, 86, 0, 0, 0, 86, 82, 0, 95, 82, 0, 110,…
## $ PointSourceID     &lt;int&gt; 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9…
## $ treeID            &lt;int&gt; 56, 56, 56, 56, 56, 56, 56, 56, 56, 56, 56, 56, 56, …</code></pre>
</div>
</div>
<div id="define-ladderfuelsr-processing-function" class="section level2 hasAnchor" number="3.2">
<h2><span class="header-section-number">3.2</span> Define <code>LadderFuelsR</code> Processing Function<a href="s02.html#define-ladderfuelsr-processing-function" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In this <a href="s01.html#ladr_s">prior section</a> we identified the minimum steps needed to get CBH using the <code>LadderFuelsR</code> and <code>leafR</code> packages. Unfortunately, extracting CBH from the point cloud following these methods is performed one-by-one for individual trees. This does not seem like something that would work well if many, many trees.</p>
<p>There are a few possible paths forward to get CBH from point cloud data:
* Extract CBH from the point cloud for all trees using the <code>LadderFuelsR</code> <a href="s01.html#ladr_s">methodology</a>
* Extract CBH from the point cloud for a sample of trees using the <code>LadderFuelsR</code> <a href="s01.html#ladr_s">methodology</a> and build a model to estimate the rest
* Use the <a href="https://doi.org/10.2737/RDS-2021-0074">TreeMap 2016 data</a> to model CBH using a regional model</p>
<p>Let’s build a function to combine the <code>LadderFuelsR</code> steps for estimating CBH from the individual tree point cloud. Our function will take a point cloud as input and return a data frame.</p>
<div class="sourceCode" id="cb180"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb180-1"><a href="s02.html#cb180-1" tabindex="-1"></a>ladderfuelsr_cbh <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb180-2"><a href="s02.html#cb180-2" tabindex="-1"></a>  las</span>
<span id="cb180-3"><a href="s02.html#cb180-3" tabindex="-1"></a>  , <span class="at">treeID =</span> <span class="cn">NA</span></span>
<span id="cb180-4"><a href="s02.html#cb180-4" tabindex="-1"></a>  <span class="co"># minimum vhp records</span></span>
<span id="cb180-5"><a href="s02.html#cb180-5" tabindex="-1"></a>  <span class="co"># https://github.com/olgaviedma/LadderFuelsR?tab=readme-ov-file#8depurating-tree-lad-profiles</span></span>
<span id="cb180-6"><a href="s02.html#cb180-6" tabindex="-1"></a>  , <span class="at">min_vhp_n =</span> <span class="dv">6</span></span>
<span id="cb180-7"><a href="s02.html#cb180-7" tabindex="-1"></a>  <span class="co"># leafR::lad.voxels</span></span>
<span id="cb180-8"><a href="s02.html#cb180-8" tabindex="-1"></a>  , <span class="at">voxel_grain_size_m =</span> <span class="dv">2</span> <span class="co"># grain.size</span></span>
<span id="cb180-9"><a href="s02.html#cb180-9" tabindex="-1"></a>  <span class="co"># LadderFuelsR::get_gaps_fbhs</span></span>
<span id="cb180-10"><a href="s02.html#cb180-10" tabindex="-1"></a>  , <span class="at">dist_btwn_bins_m =</span> <span class="dv">1</span> <span class="co"># step</span></span>
<span id="cb180-11"><a href="s02.html#cb180-11" tabindex="-1"></a>  , <span class="at">min_fuel_layer_ht_m =</span> <span class="fl">1.5</span> <span class="co"># min_height</span></span>
<span id="cb180-12"><a href="s02.html#cb180-12" tabindex="-1"></a>  , <span class="at">lad_pct_gap =</span> <span class="dv">25</span> <span class="co"># perc_gap</span></span>
<span id="cb180-13"><a href="s02.html#cb180-13" tabindex="-1"></a>  , <span class="at">lad_pct_base =</span> <span class="dv">25</span> <span class="co"># perc_base</span></span>
<span id="cb180-14"><a href="s02.html#cb180-14" tabindex="-1"></a>  <span class="co"># LadderFuelsR::get_real_fbh</span></span>
<span id="cb180-15"><a href="s02.html#cb180-15" tabindex="-1"></a>  , <span class="at">num_jump_steps =</span> <span class="dv">1</span> <span class="co"># number_steps</span></span>
<span id="cb180-16"><a href="s02.html#cb180-16" tabindex="-1"></a>  <span class="co"># LadderFuelsR::get_layers_lad</span></span>
<span id="cb180-17"><a href="s02.html#cb180-17" tabindex="-1"></a>  , <span class="at">min_lad_pct =</span> <span class="dv">10</span> <span class="co"># threshold</span></span>
<span id="cb180-18"><a href="s02.html#cb180-18" tabindex="-1"></a>  <span class="co"># LadderFuelsR::get_cbh_metrics</span></span>
<span id="cb180-19"><a href="s02.html#cb180-19" tabindex="-1"></a>  , <span class="at">frst_layer_min_ht_m =</span> <span class="fl">2.5</span> <span class="co"># hdepth1_height</span></span>
<span id="cb180-20"><a href="s02.html#cb180-20" tabindex="-1"></a>) {</span>
<span id="cb180-21"><a href="s02.html#cb180-21" tabindex="-1"></a>  <span class="co"># check if string to las/laz file</span></span>
<span id="cb180-22"><a href="s02.html#cb180-22" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">inherits</span>(las, <span class="st">&quot;character&quot;</span>)){</span>
<span id="cb180-23"><a href="s02.html#cb180-23" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span>stringr<span class="sc">::</span><span class="fu">str_ends</span>(las, <span class="st">&quot;.*</span><span class="sc">\\</span><span class="st">.(laz|las)$&quot;</span>)){</span>
<span id="cb180-24"><a href="s02.html#cb180-24" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">&quot;must pass a .las|.laz file path -OR- an object of class LAS to the `las` parameter&quot;</span>)</span>
<span id="cb180-25"><a href="s02.html#cb180-25" tabindex="-1"></a>    }</span>
<span id="cb180-26"><a href="s02.html#cb180-26" tabindex="-1"></a>    <span class="co"># set the file path</span></span>
<span id="cb180-27"><a href="s02.html#cb180-27" tabindex="-1"></a>    f <span class="ot">&lt;-</span> <span class="fu">normalizePath</span>(las)</span>
<span id="cb180-28"><a href="s02.html#cb180-28" tabindex="-1"></a>  }<span class="cf">else</span> <span class="cf">if</span>(<span class="fu">inherits</span>(las, <span class="st">&quot;LAS&quot;</span>)){</span>
<span id="cb180-29"><a href="s02.html#cb180-29" tabindex="-1"></a>    <span class="co"># have to write the las to a tempfile</span></span>
<span id="cb180-30"><a href="s02.html#cb180-30" tabindex="-1"></a>    fn <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">tempdir</span>(), <span class="st">&quot;/temp.las&quot;</span>) </span>
<span id="cb180-31"><a href="s02.html#cb180-31" tabindex="-1"></a>    <span class="co"># check if has a treeID</span></span>
<span id="cb180-32"><a href="s02.html#cb180-32" tabindex="-1"></a>    <span class="cf">if</span>(</span>
<span id="cb180-33"><a href="s02.html#cb180-33" tabindex="-1"></a>      (<span class="fu">names</span>(las<span class="sc">@</span>data) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_detect</span>(<span class="st">&quot;treeID&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">max</span>())<span class="sc">==</span><span class="dv">1</span></span>
<span id="cb180-34"><a href="s02.html#cb180-34" tabindex="-1"></a>    ){</span>
<span id="cb180-35"><a href="s02.html#cb180-35" tabindex="-1"></a>      n <span class="ot">&lt;-</span> las<span class="sc">@</span>data<span class="sc">$</span>treeID <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">length</span>()</span>
<span id="cb180-36"><a href="s02.html#cb180-36" tabindex="-1"></a>      <span class="cf">if</span>(n<span class="sc">&gt;</span><span class="dv">1</span> <span class="sc">&amp;</span> <span class="fu">is.na</span>(treeID)){</span>
<span id="cb180-37"><a href="s02.html#cb180-37" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">&quot;the treeID column has more than one tree detected. set the `treeID` parameter&quot;</span>)</span>
<span id="cb180-38"><a href="s02.html#cb180-38" tabindex="-1"></a>      }<span class="cf">else</span> <span class="cf">if</span>(<span class="fu">is.na</span>(treeID)){</span>
<span id="cb180-39"><a href="s02.html#cb180-39" tabindex="-1"></a>        <span class="co"># set the treeID</span></span>
<span id="cb180-40"><a href="s02.html#cb180-40" tabindex="-1"></a>        treeID <span class="ot">&lt;-</span> las<span class="sc">@</span>data<span class="sc">$</span>treeID <span class="sc">%&gt;%</span> <span class="fu">unique</span>()</span>
<span id="cb180-41"><a href="s02.html#cb180-41" tabindex="-1"></a>        <span class="co"># write it</span></span>
<span id="cb180-42"><a href="s02.html#cb180-42" tabindex="-1"></a>        f <span class="ot">&lt;-</span> las <span class="sc">%&gt;%</span> </span>
<span id="cb180-43"><a href="s02.html#cb180-43" tabindex="-1"></a>          lidR<span class="sc">::</span><span class="fu">filter_poi</span>(treeID <span class="sc">==</span> treeID) <span class="sc">%&gt;%</span> </span>
<span id="cb180-44"><a href="s02.html#cb180-44" tabindex="-1"></a>          lidR<span class="sc">::</span><span class="fu">writeLAS</span>(<span class="at">file =</span> fn) </span>
<span id="cb180-45"><a href="s02.html#cb180-45" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb180-46"><a href="s02.html#cb180-46" tabindex="-1"></a>        <span class="co"># write it</span></span>
<span id="cb180-47"><a href="s02.html#cb180-47" tabindex="-1"></a>        f <span class="ot">&lt;-</span> las <span class="sc">%&gt;%</span> </span>
<span id="cb180-48"><a href="s02.html#cb180-48" tabindex="-1"></a>          lidR<span class="sc">::</span><span class="fu">filter_poi</span>(treeID <span class="sc">==</span> treeID) <span class="sc">%&gt;%</span> </span>
<span id="cb180-49"><a href="s02.html#cb180-49" tabindex="-1"></a>          lidR<span class="sc">::</span><span class="fu">writeLAS</span>(<span class="at">file =</span> fn) </span>
<span id="cb180-50"><a href="s02.html#cb180-50" tabindex="-1"></a>      }</span>
<span id="cb180-51"><a href="s02.html#cb180-51" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb180-52"><a href="s02.html#cb180-52" tabindex="-1"></a>      <span class="co"># write it</span></span>
<span id="cb180-53"><a href="s02.html#cb180-53" tabindex="-1"></a>      f <span class="ot">&lt;-</span> las <span class="sc">%&gt;%</span> lidR<span class="sc">::</span><span class="fu">writeLAS</span>(<span class="at">file =</span> fn)</span>
<span id="cb180-54"><a href="s02.html#cb180-54" tabindex="-1"></a>    }</span>
<span id="cb180-55"><a href="s02.html#cb180-55" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb180-56"><a href="s02.html#cb180-56" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;must pass a .las|.laz file path -OR- an object of class LAS to the `las` parameter&quot;</span>)</span>
<span id="cb180-57"><a href="s02.html#cb180-57" tabindex="-1"></a>  }</span>
<span id="cb180-58"><a href="s02.html#cb180-58" tabindex="-1"></a>  </span>
<span id="cb180-59"><a href="s02.html#cb180-59" tabindex="-1"></a>  <span class="co"># check the treeID</span></span>
<span id="cb180-60"><a href="s02.html#cb180-60" tabindex="-1"></a>  treeID <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(<span class="fu">as.character</span>(treeID), <span class="fu">as.character</span>(<span class="dv">1</span>)) <span class="co"># if the treeID parameter is not set, fake 1 </span></span>
<span id="cb180-61"><a href="s02.html#cb180-61" tabindex="-1"></a>  <span class="do">#######################################</span></span>
<span id="cb180-62"><a href="s02.html#cb180-62" tabindex="-1"></a>  <span class="do">### Step 0 - `leafR` steps</span></span>
<span id="cb180-63"><a href="s02.html#cb180-63" tabindex="-1"></a>  <span class="do">#######################################</span></span>
<span id="cb180-64"><a href="s02.html#cb180-64" tabindex="-1"></a>    <span class="co"># 1) `leafR::lad.voxels()` - use normalized las file to create </span></span>
<span id="cb180-65"><a href="s02.html#cb180-65" tabindex="-1"></a>        <span class="co"># a data frame of the 3D voxels information (xyz) with Leaf Area Density values</span></span>
<span id="cb180-66"><a href="s02.html#cb180-66" tabindex="-1"></a>    <span class="co"># 2) `leafR::lad.profile()` - calculate the lad profile from </span></span>
<span id="cb180-67"><a href="s02.html#cb180-67" tabindex="-1"></a>        <span class="co"># the input lad.voxels (step 1)</span></span>
<span id="cb180-68"><a href="s02.html#cb180-68" tabindex="-1"></a>    <span class="co"># 3) ensure that the data frame returned from `leafR::lad.profile()` </span></span>
<span id="cb180-69"><a href="s02.html#cb180-69" tabindex="-1"></a>        <span class="co"># has a column named `treeID` which uniquely identifies individual trees. </span></span>
<span id="cb180-70"><a href="s02.html#cb180-70" tabindex="-1"></a>        <span class="co"># also, that column has to be the first column (bad practice by the authors)</span></span>
<span id="cb180-71"><a href="s02.html#cb180-71" tabindex="-1"></a>    </span>
<span id="cb180-72"><a href="s02.html#cb180-72" tabindex="-1"></a>    <span class="do">## leafR::lad.voxels</span></span>
<span id="cb180-73"><a href="s02.html#cb180-73" tabindex="-1"></a>    lad_voxels <span class="ot">&lt;-</span> leafR<span class="sc">::</span><span class="fu">lad.voxels</span>(<span class="at">normlas.file =</span> f, <span class="at">grain.size =</span> voxel_grain_size_m)</span>
<span id="cb180-74"><a href="s02.html#cb180-74" tabindex="-1"></a>    <span class="do">## leafR::lad.profile</span></span>
<span id="cb180-75"><a href="s02.html#cb180-75" tabindex="-1"></a>    lad_profile <span class="ot">&lt;-</span> leafR<span class="sc">::</span><span class="fu">lad.profile</span>(lad_voxels, <span class="at">relative =</span> F)</span>
<span id="cb180-76"><a href="s02.html#cb180-76" tabindex="-1"></a>    <span class="do">## add treeID column that is required by the package, though it&#39;s never stated</span></span>
<span id="cb180-77"><a href="s02.html#cb180-77" tabindex="-1"></a>    lad_profile <span class="ot">&lt;-</span> lad_profile <span class="sc">%&gt;%</span> </span>
<span id="cb180-78"><a href="s02.html#cb180-78" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb180-79"><a href="s02.html#cb180-79" tabindex="-1"></a>        <span class="at">treeID =</span> treeID <span class="sc">%&gt;%</span> <span class="fu">factor</span>()</span>
<span id="cb180-80"><a href="s02.html#cb180-80" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb180-81"><a href="s02.html#cb180-81" tabindex="-1"></a>      <span class="do">## !!!!! not only does the treeID column have to exist...it has to be the first column</span></span>
<span id="cb180-82"><a href="s02.html#cb180-82" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">relocate</span>(treeID) <span class="sc">%&gt;%</span> </span>
<span id="cb180-83"><a href="s02.html#cb180-83" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(treeID <span class="sc">==</span> treeID)</span>
<span id="cb180-84"><a href="s02.html#cb180-84" tabindex="-1"></a></span>
<span id="cb180-85"><a href="s02.html#cb180-85" tabindex="-1"></a>  <span class="do">### check if all NA or all 0, whereby no fuel gaps can be determined</span></span>
<span id="cb180-86"><a href="s02.html#cb180-86" tabindex="-1"></a>  prof_na <span class="ot">&lt;-</span> lad_profile <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(dplyr<span class="sc">::</span><span class="fu">coalesce</span>(lad,<span class="dv">0</span>) <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()</span>
<span id="cb180-87"><a href="s02.html#cb180-87" tabindex="-1"></a>  <span class="cf">if</span>( <span class="fu">nrow</span>(lad_profile)<span class="sc">-</span>prof_na <span class="sc">&lt;=</span> <span class="dv">1</span> ){</span>
<span id="cb180-88"><a href="s02.html#cb180-88" tabindex="-1"></a>    <span class="fu">message</span>(</span>
<span id="cb180-89"><a href="s02.html#cb180-89" tabindex="-1"></a>      <span class="fu">paste0</span>(</span>
<span id="cb180-90"><a href="s02.html#cb180-90" tabindex="-1"></a>        <span class="st">&quot;no fuel gaps found. unable to quantify CBH (treeID=&quot;</span></span>
<span id="cb180-91"><a href="s02.html#cb180-91" tabindex="-1"></a>        , treeID, <span class="st">&quot;).&quot;</span></span>
<span id="cb180-92"><a href="s02.html#cb180-92" tabindex="-1"></a>      )</span>
<span id="cb180-93"><a href="s02.html#cb180-93" tabindex="-1"></a>    )</span>
<span id="cb180-94"><a href="s02.html#cb180-94" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb180-95"><a href="s02.html#cb180-95" tabindex="-1"></a>  }<span class="cf">else</span> <span class="cf">if</span>(<span class="fu">nrow</span>(lad_profile) <span class="sc">&lt;</span> min_vhp_n){</span>
<span id="cb180-96"><a href="s02.html#cb180-96" tabindex="-1"></a>    <span class="fu">message</span>(</span>
<span id="cb180-97"><a href="s02.html#cb180-97" tabindex="-1"></a>      <span class="fu">paste0</span>(</span>
<span id="cb180-98"><a href="s02.html#cb180-98" tabindex="-1"></a>        <span class="fu">nrow</span>(lad_profile)</span>
<span id="cb180-99"><a href="s02.html#cb180-99" tabindex="-1"></a>        , <span class="st">&quot; fuel vertical height profiles found. unable to quantify CBH (treeID=&quot;</span></span>
<span id="cb180-100"><a href="s02.html#cb180-100" tabindex="-1"></a>        , treeID, <span class="st">&quot;). try decreasing the `min_vhp_n` parameter?&quot;</span></span>
<span id="cb180-101"><a href="s02.html#cb180-101" tabindex="-1"></a>      )</span>
<span id="cb180-102"><a href="s02.html#cb180-102" tabindex="-1"></a>    )</span>
<span id="cb180-103"><a href="s02.html#cb180-103" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb180-104"><a href="s02.html#cb180-104" tabindex="-1"></a>  }</span>
<span id="cb180-105"><a href="s02.html#cb180-105" tabindex="-1"></a>  <span class="cf">else</span>{</span>
<span id="cb180-106"><a href="s02.html#cb180-106" tabindex="-1"></a>    <span class="do">## &quot;depurating tree lad profiles&quot;</span></span>
<span id="cb180-107"><a href="s02.html#cb180-107" tabindex="-1"></a>    <span class="do">## see: https://github.com/olgaviedma/LadderFuelsR#8depurating-tree-lad-profiles</span></span>
<span id="cb180-108"><a href="s02.html#cb180-108" tabindex="-1"></a>    lad_profile <span class="ot">&lt;-</span> lad_profile <span class="sc">%&gt;%</span> </span>
<span id="cb180-109"><a href="s02.html#cb180-109" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">lad =</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(<span class="fu">as.numeric</span>(lad), <span class="fl">0.01</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb180-110"><a href="s02.html#cb180-110" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">arrange</span>(treeID, height)</span>
<span id="cb180-111"><a href="s02.html#cb180-111" tabindex="-1"></a>    <span class="do">#######################################</span></span>
<span id="cb180-112"><a href="s02.html#cb180-112" tabindex="-1"></a>    <span class="do">### Step 1 - `LadderFuelsR::get_gaps_fbhs`</span></span>
<span id="cb180-113"><a href="s02.html#cb180-113" tabindex="-1"></a>    <span class="do">#######################################</span></span>
<span id="cb180-114"><a href="s02.html#cb180-114" tabindex="-1"></a>      <span class="do">### this function is fixed: https://github.com/olgaviedma/LadderFuelsR/pull/3</span></span>
<span id="cb180-115"><a href="s02.html#cb180-115" tabindex="-1"></a>      <span class="do">### LadderFuelsR::get_gaps_fbhs</span></span>
<span id="cb180-116"><a href="s02.html#cb180-116" tabindex="-1"></a>      <span class="do">### This function calculates gaps and fuel layers base height (FBH) as </span></span>
<span id="cb180-117"><a href="s02.html#cb180-117" tabindex="-1"></a>      <span class="do">### the difference in percentiles between consecutive LAD values along the vertical tree profile (VTP)</span></span>
<span id="cb180-118"><a href="s02.html#cb180-118" tabindex="-1"></a>      </span>
<span id="cb180-119"><a href="s02.html#cb180-119" tabindex="-1"></a>      <span class="co"># quiet this function</span></span>
<span id="cb180-120"><a href="s02.html#cb180-120" tabindex="-1"></a>      quiet_get_gaps_fbhs <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">quietly</span>(LadderFuelsR<span class="sc">::</span>get_gaps_fbhs)</span>
<span id="cb180-121"><a href="s02.html#cb180-121" tabindex="-1"></a>    </span>
<span id="cb180-122"><a href="s02.html#cb180-122" tabindex="-1"></a>      gaps_fbhs <span class="ot">&lt;-</span></span>
<span id="cb180-123"><a href="s02.html#cb180-123" tabindex="-1"></a>        <span class="co"># gw_get_gaps_fbhs(</span></span>
<span id="cb180-124"><a href="s02.html#cb180-124" tabindex="-1"></a>        <span class="co"># LadderFuelsR::get_gaps_fbhs(</span></span>
<span id="cb180-125"><a href="s02.html#cb180-125" tabindex="-1"></a>        <span class="fu">quiet_get_gaps_fbhs</span>(</span>
<span id="cb180-126"><a href="s02.html#cb180-126" tabindex="-1"></a>          <span class="at">LAD_profiles =</span> lad_profile</span>
<span id="cb180-127"><a href="s02.html#cb180-127" tabindex="-1"></a>          , <span class="at">step =</span> dist_btwn_bins_m</span>
<span id="cb180-128"><a href="s02.html#cb180-128" tabindex="-1"></a>          , <span class="at">min_height =</span> min_fuel_layer_ht_m</span>
<span id="cb180-129"><a href="s02.html#cb180-129" tabindex="-1"></a>          , <span class="at">perc_gap =</span> lad_pct_gap</span>
<span id="cb180-130"><a href="s02.html#cb180-130" tabindex="-1"></a>          , <span class="at">perc_base =</span> lad_pct_base</span>
<span id="cb180-131"><a href="s02.html#cb180-131" tabindex="-1"></a>          , <span class="at">verbose =</span> F</span>
<span id="cb180-132"><a href="s02.html#cb180-132" tabindex="-1"></a>        )</span>
<span id="cb180-133"><a href="s02.html#cb180-133" tabindex="-1"></a>      <span class="co"># just get the result</span></span>
<span id="cb180-134"><a href="s02.html#cb180-134" tabindex="-1"></a>      gaps_fbhs <span class="ot">&lt;-</span> gaps_fbhs<span class="sc">$</span>result</span>
<span id="cb180-135"><a href="s02.html#cb180-135" tabindex="-1"></a>      <span class="co"># fix the columns that should be numeric</span></span>
<span id="cb180-136"><a href="s02.html#cb180-136" tabindex="-1"></a>      gaps_fbhs <span class="ot">&lt;-</span> gaps_fbhs <span class="sc">%&gt;%</span></span>
<span id="cb180-137"><a href="s02.html#cb180-137" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(dplyr<span class="sc">::</span><span class="fu">across</span>(</span>
<span id="cb180-138"><a href="s02.html#cb180-138" tabindex="-1"></a>          <span class="sc">!</span>tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;treeID&quot;</span>)</span>
<span id="cb180-139"><a href="s02.html#cb180-139" tabindex="-1"></a>          , as.numeric</span>
<span id="cb180-140"><a href="s02.html#cb180-140" tabindex="-1"></a>        ))</span>
<span id="cb180-141"><a href="s02.html#cb180-141" tabindex="-1"></a>    <span class="do">### check for all NA or 0</span></span>
<span id="cb180-142"><a href="s02.html#cb180-142" tabindex="-1"></a>    gaps_na <span class="ot">&lt;-</span> gaps_fbhs <span class="sc">%&gt;%</span> </span>
<span id="cb180-143"><a href="s02.html#cb180-143" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb180-144"><a href="s02.html#cb180-144" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">if_all</span>(</span>
<span id="cb180-145"><a href="s02.html#cb180-145" tabindex="-1"></a>          <span class="at">.cols =</span> <span class="sc">-</span>tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;treeID&quot;</span>)</span>
<span id="cb180-146"><a href="s02.html#cb180-146" tabindex="-1"></a>          , <span class="at">.fns =</span> <span class="sc">~</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(.x, <span class="dv">0</span>) <span class="sc">==</span> <span class="dv">0</span></span>
<span id="cb180-147"><a href="s02.html#cb180-147" tabindex="-1"></a>        )</span>
<span id="cb180-148"><a href="s02.html#cb180-148" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb180-149"><a href="s02.html#cb180-149" tabindex="-1"></a>      <span class="fu">nrow</span>()</span>
<span id="cb180-150"><a href="s02.html#cb180-150" tabindex="-1"></a>    <span class="cf">if</span>(gaps_na<span class="sc">&gt;</span><span class="dv">0</span>){</span>
<span id="cb180-151"><a href="s02.html#cb180-151" tabindex="-1"></a>      <span class="fu">message</span>(</span>
<span id="cb180-152"><a href="s02.html#cb180-152" tabindex="-1"></a>        <span class="fu">paste0</span>(</span>
<span id="cb180-153"><a href="s02.html#cb180-153" tabindex="-1"></a>          <span class="st">&quot;no fuel gaps found. unable to quantify CBH (treeID=&quot;</span></span>
<span id="cb180-154"><a href="s02.html#cb180-154" tabindex="-1"></a>          , treeID, <span class="st">&quot;).&quot;</span></span>
<span id="cb180-155"><a href="s02.html#cb180-155" tabindex="-1"></a>        )</span>
<span id="cb180-156"><a href="s02.html#cb180-156" tabindex="-1"></a>      )</span>
<span id="cb180-157"><a href="s02.html#cb180-157" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb180-158"><a href="s02.html#cb180-158" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb180-159"><a href="s02.html#cb180-159" tabindex="-1"></a>      <span class="do">######`#################################</span></span>
<span id="cb180-160"><a href="s02.html#cb180-160" tabindex="-1"></a>      <span class="do">### Step 2 - `LadderFuelsR::calculate_gaps_perc`</span></span>
<span id="cb180-161"><a href="s02.html#cb180-161" tabindex="-1"></a>      <span class="do">#######################################</span></span>
<span id="cb180-162"><a href="s02.html#cb180-162" tabindex="-1"></a>        <span class="do">### this function calculates the percentile value of each height</span></span>
<span id="cb180-163"><a href="s02.html#cb180-163" tabindex="-1"></a>        <span class="do">## LadderFuelsR::calculate_gaps_perc</span></span>
<span id="cb180-164"><a href="s02.html#cb180-164" tabindex="-1"></a>        <span class="co">#!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! ERROR if treeID is not the first column</span></span>
<span id="cb180-165"><a href="s02.html#cb180-165" tabindex="-1"></a>        <span class="co"># quiet this function</span></span>
<span id="cb180-166"><a href="s02.html#cb180-166" tabindex="-1"></a>        quiet_calculate_gaps_perc <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">quietly</span>(LadderFuelsR<span class="sc">::</span>calculate_gaps_perc)</span>
<span id="cb180-167"><a href="s02.html#cb180-167" tabindex="-1"></a>        <span class="co"># run it quietly</span></span>
<span id="cb180-168"><a href="s02.html#cb180-168" tabindex="-1"></a>        gaps_perc <span class="ot">&lt;-</span> <span class="fu">quiet_calculate_gaps_perc</span>(</span>
<span id="cb180-169"><a href="s02.html#cb180-169" tabindex="-1"></a>          <span class="co"># LadderFuelsR::calculate_gaps_perc(</span></span>
<span id="cb180-170"><a href="s02.html#cb180-170" tabindex="-1"></a>          <span class="at">LAD_profiles =</span> lad_profile</span>
<span id="cb180-171"><a href="s02.html#cb180-171" tabindex="-1"></a>          , <span class="at">min_height =</span> min_fuel_layer_ht_m</span>
<span id="cb180-172"><a href="s02.html#cb180-172" tabindex="-1"></a>        )</span>
<span id="cb180-173"><a href="s02.html#cb180-173" tabindex="-1"></a>        <span class="co"># just get the result</span></span>
<span id="cb180-174"><a href="s02.html#cb180-174" tabindex="-1"></a>        gaps_perc <span class="ot">&lt;-</span> gaps_perc<span class="sc">$</span>result</span>
<span id="cb180-175"><a href="s02.html#cb180-175" tabindex="-1"></a>  </span>
<span id="cb180-176"><a href="s02.html#cb180-176" tabindex="-1"></a>      <span class="do">#######################################</span></span>
<span id="cb180-177"><a href="s02.html#cb180-177" tabindex="-1"></a>      <span class="do">### Step 3 - `LadderFuelsR::get_distance`</span></span>
<span id="cb180-178"><a href="s02.html#cb180-178" tabindex="-1"></a>      <span class="do">#######################################</span></span>
<span id="cb180-179"><a href="s02.html#cb180-179" tabindex="-1"></a>        <span class="do">### calculates distances (and their heights) between fuel layers as</span></span>
<span id="cb180-180"><a href="s02.html#cb180-180" tabindex="-1"></a>        <span class="do">### the difference between consecutive gaps and fuel bases</span></span>
<span id="cb180-181"><a href="s02.html#cb180-181" tabindex="-1"></a>        <span class="do">### (the gap height always must be lower than the fuel base height).</span></span>
<span id="cb180-182"><a href="s02.html#cb180-182" tabindex="-1"></a>        <span class="do">## LadderFuelsR::get_distance</span></span>
<span id="cb180-183"><a href="s02.html#cb180-183" tabindex="-1"></a>        metrics_distance <span class="ot">&lt;-</span> LadderFuelsR<span class="sc">::</span><span class="fu">get_distance</span>(</span>
<span id="cb180-184"><a href="s02.html#cb180-184" tabindex="-1"></a>          <span class="at">gap_cbh_metrics =</span> gaps_fbhs</span>
<span id="cb180-185"><a href="s02.html#cb180-185" tabindex="-1"></a>          , <span class="at">gaps_perc =</span> gaps_perc</span>
<span id="cb180-186"><a href="s02.html#cb180-186" tabindex="-1"></a>          , <span class="at">step =</span> dist_btwn_bins_m</span>
<span id="cb180-187"><a href="s02.html#cb180-187" tabindex="-1"></a>          , <span class="at">min_height =</span> min_fuel_layer_ht_m</span>
<span id="cb180-188"><a href="s02.html#cb180-188" tabindex="-1"></a>          , <span class="at">verbose =</span> F</span>
<span id="cb180-189"><a href="s02.html#cb180-189" tabindex="-1"></a>        )</span>
<span id="cb180-190"><a href="s02.html#cb180-190" tabindex="-1"></a>  </span>
<span id="cb180-191"><a href="s02.html#cb180-191" tabindex="-1"></a>      <span class="do">#######################################</span></span>
<span id="cb180-192"><a href="s02.html#cb180-192" tabindex="-1"></a>      <span class="do">### Step 4 - `LadderFuelsR::get_depths`</span></span>
<span id="cb180-193"><a href="s02.html#cb180-193" tabindex="-1"></a>      <span class="do">#######################################</span></span>
<span id="cb180-194"><a href="s02.html#cb180-194" tabindex="-1"></a>        <span class="do">### calculates fuels depth as the difference between gaps</span></span>
<span id="cb180-195"><a href="s02.html#cb180-195" tabindex="-1"></a>        <span class="do">### interleaved between fuel layers minus one step if</span></span>
<span id="cb180-196"><a href="s02.html#cb180-196" tabindex="-1"></a>        <span class="do">### the fuel depths are greater than one step.</span></span>
<span id="cb180-197"><a href="s02.html#cb180-197" tabindex="-1"></a>        <span class="do">## LadderFuelsR::get_depths</span></span>
<span id="cb180-198"><a href="s02.html#cb180-198" tabindex="-1"></a>        metrics_depth <span class="ot">&lt;-</span> LadderFuelsR<span class="sc">::</span><span class="fu">get_depths</span>(</span>
<span id="cb180-199"><a href="s02.html#cb180-199" tabindex="-1"></a>          <span class="at">LAD_profiles =</span> lad_profile</span>
<span id="cb180-200"><a href="s02.html#cb180-200" tabindex="-1"></a>          , <span class="at">distance_metrics =</span> metrics_distance</span>
<span id="cb180-201"><a href="s02.html#cb180-201" tabindex="-1"></a>          , <span class="at">step =</span> dist_btwn_bins_m</span>
<span id="cb180-202"><a href="s02.html#cb180-202" tabindex="-1"></a>          , <span class="at">min_height=</span> min_fuel_layer_ht_m</span>
<span id="cb180-203"><a href="s02.html#cb180-203" tabindex="-1"></a>          , <span class="at">verbose =</span> F</span>
<span id="cb180-204"><a href="s02.html#cb180-204" tabindex="-1"></a>        )</span>
<span id="cb180-205"><a href="s02.html#cb180-205" tabindex="-1"></a>      </span>
<span id="cb180-206"><a href="s02.html#cb180-206" tabindex="-1"></a>      <span class="do">#######################################</span></span>
<span id="cb180-207"><a href="s02.html#cb180-207" tabindex="-1"></a>      <span class="do">### Step 5 - `LadderFuelsR::get_real_fbh`</span></span>
<span id="cb180-208"><a href="s02.html#cb180-208" tabindex="-1"></a>      <span class="do">#######################################      </span></span>
<span id="cb180-209"><a href="s02.html#cb180-209" tabindex="-1"></a>        <span class="do">### reshapes fuel layers after removing distances equal </span></span>
<span id="cb180-210"><a href="s02.html#cb180-210" tabindex="-1"></a>        <span class="do">### to any number of height bin steps, keeping the first </span></span>
<span id="cb180-211"><a href="s02.html#cb180-211" tabindex="-1"></a>        <span class="do">### &quot;base height&quot; from those consecutive ones separated by such distance.</span></span>
<span id="cb180-212"><a href="s02.html#cb180-212" tabindex="-1"></a>        </span>
<span id="cb180-213"><a href="s02.html#cb180-213" tabindex="-1"></a>        <span class="do">## LadderFuelsR::get_real_fbh</span></span>
<span id="cb180-214"><a href="s02.html#cb180-214" tabindex="-1"></a>        real_fbh <span class="ot">&lt;-</span> LadderFuelsR<span class="sc">::</span><span class="fu">get_real_fbh</span>(</span>
<span id="cb180-215"><a href="s02.html#cb180-215" tabindex="-1"></a>          <span class="at">depth_metrics =</span> metrics_depth</span>
<span id="cb180-216"><a href="s02.html#cb180-216" tabindex="-1"></a>          , <span class="at">step =</span> dist_btwn_bins_m</span>
<span id="cb180-217"><a href="s02.html#cb180-217" tabindex="-1"></a>          , <span class="at">number_steps =</span> num_jump_steps</span>
<span id="cb180-218"><a href="s02.html#cb180-218" tabindex="-1"></a>          , <span class="at">min_height =</span> min_fuel_layer_ht_m</span>
<span id="cb180-219"><a href="s02.html#cb180-219" tabindex="-1"></a>          , <span class="at">verbose =</span> F</span>
<span id="cb180-220"><a href="s02.html#cb180-220" tabindex="-1"></a>        )</span>
<span id="cb180-221"><a href="s02.html#cb180-221" tabindex="-1"></a>      </span>
<span id="cb180-222"><a href="s02.html#cb180-222" tabindex="-1"></a>      <span class="do">#######################################</span></span>
<span id="cb180-223"><a href="s02.html#cb180-223" tabindex="-1"></a>      <span class="do">### Step 6 - `LadderFuelsR::get_real_depths`</span></span>
<span id="cb180-224"><a href="s02.html#cb180-224" tabindex="-1"></a>      <span class="do">#######################################</span></span>
<span id="cb180-225"><a href="s02.html#cb180-225" tabindex="-1"></a>        <span class="do">### recalculates fuel layers depth after considering </span></span>
<span id="cb180-226"><a href="s02.html#cb180-226" tabindex="-1"></a>        <span class="do">### distances greater than the actual height bin step.</span></span>
<span id="cb180-227"><a href="s02.html#cb180-227" tabindex="-1"></a>        </span>
<span id="cb180-228"><a href="s02.html#cb180-228" tabindex="-1"></a>        <span class="do">## LadderFuelsR::get_real_depths</span></span>
<span id="cb180-229"><a href="s02.html#cb180-229" tabindex="-1"></a>        real_depth <span class="ot">&lt;-</span> LadderFuelsR<span class="sc">::</span><span class="fu">get_real_depths</span>(</span>
<span id="cb180-230"><a href="s02.html#cb180-230" tabindex="-1"></a>          <span class="at">effective_fbh =</span> real_fbh</span>
<span id="cb180-231"><a href="s02.html#cb180-231" tabindex="-1"></a>          , <span class="at">step =</span> dist_btwn_bins_m</span>
<span id="cb180-232"><a href="s02.html#cb180-232" tabindex="-1"></a>          , <span class="at">min_height =</span> min_fuel_layer_ht_m</span>
<span id="cb180-233"><a href="s02.html#cb180-233" tabindex="-1"></a>          , <span class="at">verbose =</span> F</span>
<span id="cb180-234"><a href="s02.html#cb180-234" tabindex="-1"></a>        )</span>
<span id="cb180-235"><a href="s02.html#cb180-235" tabindex="-1"></a>      </span>
<span id="cb180-236"><a href="s02.html#cb180-236" tabindex="-1"></a>      <span class="do">#######################################</span></span>
<span id="cb180-237"><a href="s02.html#cb180-237" tabindex="-1"></a>      <span class="do">### Step 7 - `LadderFuelsR::get_effective_gap`</span></span>
<span id="cb180-238"><a href="s02.html#cb180-238" tabindex="-1"></a>      <span class="do">#######################################</span></span>
<span id="cb180-239"><a href="s02.html#cb180-239" tabindex="-1"></a>        <span class="do">### recalculates the distance between fuel layers after considering </span></span>
<span id="cb180-240"><a href="s02.html#cb180-240" tabindex="-1"></a>        <span class="do">### distances greater than any number of height bin steps.</span></span>
<span id="cb180-241"><a href="s02.html#cb180-241" tabindex="-1"></a>        </span>
<span id="cb180-242"><a href="s02.html#cb180-242" tabindex="-1"></a>        <span class="do">## LadderFuelsR::get_effective_gap</span></span>
<span id="cb180-243"><a href="s02.html#cb180-243" tabindex="-1"></a>        eff_gap <span class="ot">&lt;-</span> LadderFuelsR<span class="sc">::</span><span class="fu">get_effective_gap</span>(</span>
<span id="cb180-244"><a href="s02.html#cb180-244" tabindex="-1"></a>          <span class="at">effective_depth =</span> real_depth</span>
<span id="cb180-245"><a href="s02.html#cb180-245" tabindex="-1"></a>          , <span class="at">number_steps =</span> num_jump_steps</span>
<span id="cb180-246"><a href="s02.html#cb180-246" tabindex="-1"></a>          , <span class="at">min_height =</span> min_fuel_layer_ht_m</span>
<span id="cb180-247"><a href="s02.html#cb180-247" tabindex="-1"></a>          , <span class="at">verbose =</span> F</span>
<span id="cb180-248"><a href="s02.html#cb180-248" tabindex="-1"></a>        )</span>
<span id="cb180-249"><a href="s02.html#cb180-249" tabindex="-1"></a>      <span class="do">#######################################</span></span>
<span id="cb180-250"><a href="s02.html#cb180-250" tabindex="-1"></a>      <span class="do">### Step 8 - `LadderFuelsR::get_layers_lad`</span></span>
<span id="cb180-251"><a href="s02.html#cb180-251" tabindex="-1"></a>      <span class="do">#######################################</span></span>
<span id="cb180-252"><a href="s02.html#cb180-252" tabindex="-1"></a>        <span class="do">### calculates the percentage of Leaf Area Density (LAD) within </span></span>
<span id="cb180-253"><a href="s02.html#cb180-253" tabindex="-1"></a>        <span class="do">### each fuel layer (first output) and removes those fuel layers </span></span>
<span id="cb180-254"><a href="s02.html#cb180-254" tabindex="-1"></a>        <span class="do">### with LAD percentage less than a specified threshold </span></span>
<span id="cb180-255"><a href="s02.html#cb180-255" tabindex="-1"></a>        <span class="do">### (default 10 the depth of the remaining ones (second output).</span></span>
<span id="cb180-256"><a href="s02.html#cb180-256" tabindex="-1"></a>        </span>
<span id="cb180-257"><a href="s02.html#cb180-257" tabindex="-1"></a>        <span class="do">## LadderFuelsR::get_layers_lad</span></span>
<span id="cb180-258"><a href="s02.html#cb180-258" tabindex="-1"></a>        layers_lad_df <span class="ot">&lt;-</span> LadderFuelsR<span class="sc">::</span><span class="fu">get_layers_lad</span>(</span>
<span id="cb180-259"><a href="s02.html#cb180-259" tabindex="-1"></a>          <span class="at">LAD_profiles =</span> lad_profile</span>
<span id="cb180-260"><a href="s02.html#cb180-260" tabindex="-1"></a>          , <span class="at">effective_distances =</span> eff_gap</span>
<span id="cb180-261"><a href="s02.html#cb180-261" tabindex="-1"></a>          , <span class="at">threshold =</span> min_lad_pct</span>
<span id="cb180-262"><a href="s02.html#cb180-262" tabindex="-1"></a>          , <span class="at">step =</span> dist_btwn_bins_m</span>
<span id="cb180-263"><a href="s02.html#cb180-263" tabindex="-1"></a>          , <span class="at">min_height =</span> min_fuel_layer_ht_m</span>
<span id="cb180-264"><a href="s02.html#cb180-264" tabindex="-1"></a>          , <span class="at">verbose =</span> F</span>
<span id="cb180-265"><a href="s02.html#cb180-265" tabindex="-1"></a>        )</span>
<span id="cb180-266"><a href="s02.html#cb180-266" tabindex="-1"></a>        <span class="do">### idk why it is a list of 2 with the same data just the order </span></span>
<span id="cb180-267"><a href="s02.html#cb180-267" tabindex="-1"></a>        <span class="do">### of the `max_height` and `Hcbh1_Hdptf1` columns are switched. do you spot another difference??</span></span>
<span id="cb180-268"><a href="s02.html#cb180-268" tabindex="-1"></a>        <span class="do">### looking through the befuddling README it looks like the authors only keep </span></span>
<span id="cb180-269"><a href="s02.html#cb180-269" tabindex="-1"></a>        <span class="do">### the second data frame in the list</span></span>
<span id="cb180-270"><a href="s02.html#cb180-270" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">length</span>(layers_lad_df)<span class="sc">&gt;</span><span class="dv">1</span>){</span>
<span id="cb180-271"><a href="s02.html#cb180-271" tabindex="-1"></a>          layers_lad_df <span class="ot">&lt;-</span> layers_lad_df[[<span class="dv">2</span>]]</span>
<span id="cb180-272"><a href="s02.html#cb180-272" tabindex="-1"></a>        }</span>
<span id="cb180-273"><a href="s02.html#cb180-273" tabindex="-1"></a>      </span>
<span id="cb180-274"><a href="s02.html#cb180-274" tabindex="-1"></a>      <span class="do">#######################################</span></span>
<span id="cb180-275"><a href="s02.html#cb180-275" tabindex="-1"></a>      <span class="do">### Step 9 - `LadderFuelsR::get_cbh_metrics`</span></span>
<span id="cb180-276"><a href="s02.html#cb180-276" tabindex="-1"></a>      <span class="do">#######################################</span></span>
<span id="cb180-277"><a href="s02.html#cb180-277" tabindex="-1"></a>        <span class="do">### `LadderFuelsR::get_cbh_dist` is described in the research article but does not </span></span>
<span id="cb180-278"><a href="s02.html#cb180-278" tabindex="-1"></a>        <span class="do">### exist in the package or README. Looks like `LadderFuelsR::get_cbh_metrics` is there though.</span></span>
<span id="cb180-279"><a href="s02.html#cb180-279" tabindex="-1"></a>        <span class="do">### determines the CBH of a segmented tree using three criteria: </span></span>
<span id="cb180-280"><a href="s02.html#cb180-280" tabindex="-1"></a>        <span class="do">### maximum LAD percentage, maximum distance and the last distance.</span></span>
<span id="cb180-281"><a href="s02.html#cb180-281" tabindex="-1"></a>        </span>
<span id="cb180-282"><a href="s02.html#cb180-282" tabindex="-1"></a>        <span class="do">## LadderFuelsR::get_cbh_metrics</span></span>
<span id="cb180-283"><a href="s02.html#cb180-283" tabindex="-1"></a>        cbh_metrics <span class="ot">&lt;-</span> LadderFuelsR<span class="sc">::</span><span class="fu">get_cbh_metrics</span>(</span>
<span id="cb180-284"><a href="s02.html#cb180-284" tabindex="-1"></a>          <span class="at">effective_LAD =</span> layers_lad_df</span>
<span id="cb180-285"><a href="s02.html#cb180-285" tabindex="-1"></a>          , <span class="at">min_height =</span> min_fuel_layer_ht_m</span>
<span id="cb180-286"><a href="s02.html#cb180-286" tabindex="-1"></a>          , <span class="at">hdepth1_height =</span> frst_layer_min_ht_m</span>
<span id="cb180-287"><a href="s02.html#cb180-287" tabindex="-1"></a>          , <span class="at">verbose =</span> F</span>
<span id="cb180-288"><a href="s02.html#cb180-288" tabindex="-1"></a>        )</span>
<span id="cb180-289"><a href="s02.html#cb180-289" tabindex="-1"></a>  </span>
<span id="cb180-290"><a href="s02.html#cb180-290" tabindex="-1"></a>      <span class="co"># return</span></span>
<span id="cb180-291"><a href="s02.html#cb180-291" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb180-292"><a href="s02.html#cb180-292" tabindex="-1"></a>          <span class="at">gaps_fbhs =</span> gaps_fbhs</span>
<span id="cb180-293"><a href="s02.html#cb180-293" tabindex="-1"></a>          , <span class="at">lad_profile =</span> lad_profile</span>
<span id="cb180-294"><a href="s02.html#cb180-294" tabindex="-1"></a>          , <span class="at">gaps_perc =</span> gaps_perc</span>
<span id="cb180-295"><a href="s02.html#cb180-295" tabindex="-1"></a>          , <span class="at">metrics_distance =</span> metrics_distance</span>
<span id="cb180-296"><a href="s02.html#cb180-296" tabindex="-1"></a>          , <span class="at">metrics_depth =</span> metrics_depth</span>
<span id="cb180-297"><a href="s02.html#cb180-297" tabindex="-1"></a>          , <span class="at">real_fbh =</span> real_fbh</span>
<span id="cb180-298"><a href="s02.html#cb180-298" tabindex="-1"></a>          , <span class="at">real_depth =</span> real_depth</span>
<span id="cb180-299"><a href="s02.html#cb180-299" tabindex="-1"></a>          , <span class="at">eff_gap =</span> eff_gap</span>
<span id="cb180-300"><a href="s02.html#cb180-300" tabindex="-1"></a>          , <span class="at">layers_lad_df =</span> layers_lad_df</span>
<span id="cb180-301"><a href="s02.html#cb180-301" tabindex="-1"></a>          , <span class="at">cbh_metrics =</span> cbh_metrics</span>
<span id="cb180-302"><a href="s02.html#cb180-302" tabindex="-1"></a>        ))</span>
<span id="cb180-303"><a href="s02.html#cb180-303" tabindex="-1"></a>    } <span class="co"># if all NA or all 0, whereby no fuel gaps can be determined</span></span>
<span id="cb180-304"><a href="s02.html#cb180-304" tabindex="-1"></a>  } <span class="co"># if all NA or all 0, whereby no fuel gaps can be determined</span></span>
<span id="cb180-305"><a href="s02.html#cb180-305" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb181"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb181-1"><a href="s02.html#cb181-1" tabindex="-1"></a><span class="co"># CALL IT</span></span>
<span id="cb181-2"><a href="s02.html#cb181-2" tabindex="-1"></a>ladderfuelsr_cbh_ans <span class="ot">&lt;-</span> cloud2trees<span class="sc">::</span><span class="fu">ladderfuelsr_cbh</span>(</span>
<span id="cb181-3"><a href="s02.html#cb181-3" tabindex="-1"></a>  <span class="at">las =</span> nlas_one_tree <span class="co"># %&gt;% lidR::decimate_points(random(0.5))</span></span>
<span id="cb181-4"><a href="s02.html#cb181-4" tabindex="-1"></a>) </span>
<span id="cb181-5"><a href="s02.html#cb181-5" tabindex="-1"></a>ladderfuelsr_cbh_ans <span class="sc">%&gt;%</span> <span class="fu">names</span>()</span></code></pre></div>
<pre><code>##  [1] &quot;gaps_fbhs&quot;        &quot;lad_profile&quot;      &quot;gaps_perc&quot;        &quot;metrics_distance&quot;
##  [5] &quot;metrics_depth&quot;    &quot;real_fbh&quot;         &quot;real_depth&quot;       &quot;eff_gap&quot;         
##  [9] &quot;layers_lad_df&quot;    &quot;cbh_metrics&quot;</code></pre>
<div class="sourceCode" id="cb183"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb183-1"><a href="s02.html#cb183-1" tabindex="-1"></a>ladderfuelsr_cbh_ans<span class="sc">$</span>lad_profile <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 13
## Columns: 3
## $ treeID &lt;fct&gt; 56, 56, 56, 56, 56, 56, 56, 56, 56, 56, 56, 56, 56
## $ height &lt;dbl&gt; 1.5, 2.5, 3.5, 4.5, 5.5, 6.5, 7.5, 8.5, 9.5, 10.5, 11.5, 12.5, …
## $ lad    &lt;dbl&gt; 0.000000000, 0.021362532, 0.011498812, 0.036923712, 0.112494453…</code></pre>
<p>Create our own plot of the gaps and fuel layers base height in the vertical tree profile</p>
<div class="sourceCode" id="cb185"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb185-1"><a href="s02.html#cb185-1" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb185-2"><a href="s02.html#cb185-2" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="at">data =</span> ladderfuelsr_cbh_ans<span class="sc">$</span>lad_profile, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> lad, <span class="at">y =</span> height)) <span class="sc">+</span></span>
<span id="cb185-3"><a href="s02.html#cb185-3" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> ladderfuelsr_cbh_ans<span class="sc">$</span>lad_profile, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> lad, <span class="at">y =</span> height)) <span class="sc">+</span></span>
<span id="cb185-4"><a href="s02.html#cb185-4" tabindex="-1"></a>  <span class="co"># gaps data</span></span>
<span id="cb185-5"><a href="s02.html#cb185-5" tabindex="-1"></a>  <span class="fu">geom_hline</span>(</span>
<span id="cb185-6"><a href="s02.html#cb185-6" tabindex="-1"></a>    <span class="at">data =</span> ladderfuelsr_cbh_ans<span class="sc">$</span>gaps_fbhs <span class="sc">%&gt;%</span> </span>
<span id="cb185-7"><a href="s02.html#cb185-7" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb185-8"><a href="s02.html#cb185-8" tabindex="-1"></a>        tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;gap&quot;</span>) <span class="sc">&amp;</span> <span class="sc">!</span>tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;gap_&quot;</span>)</span>
<span id="cb185-9"><a href="s02.html#cb185-9" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb185-10"><a href="s02.html#cb185-10" tabindex="-1"></a>      tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(dplyr<span class="sc">::</span><span class="fu">everything</span>())</span>
<span id="cb185-11"><a href="s02.html#cb185-11" tabindex="-1"></a>    , <span class="fu">aes</span>(<span class="at">yintercept =</span> value, <span class="at">color =</span> <span class="st">&quot;gaps&quot;</span>)</span>
<span id="cb185-12"><a href="s02.html#cb185-12" tabindex="-1"></a>    , <span class="at">linetype =</span> <span class="st">&quot;dotted&quot;</span></span>
<span id="cb185-13"><a href="s02.html#cb185-13" tabindex="-1"></a>    , <span class="at">lwd =</span> <span class="fl">1.2</span></span>
<span id="cb185-14"><a href="s02.html#cb185-14" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb185-15"><a href="s02.html#cb185-15" tabindex="-1"></a>  <span class="co"># fbh data</span></span>
<span id="cb185-16"><a href="s02.html#cb185-16" tabindex="-1"></a>  <span class="fu">geom_hline</span>(</span>
<span id="cb185-17"><a href="s02.html#cb185-17" tabindex="-1"></a>    <span class="at">data =</span> ladderfuelsr_cbh_ans<span class="sc">$</span>gaps_fbhs <span class="sc">%&gt;%</span> </span>
<span id="cb185-18"><a href="s02.html#cb185-18" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb185-19"><a href="s02.html#cb185-19" tabindex="-1"></a>        tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;cbh&quot;</span>) <span class="sc">&amp;</span> <span class="sc">!</span>tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;cbh_&quot;</span>)</span>
<span id="cb185-20"><a href="s02.html#cb185-20" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb185-21"><a href="s02.html#cb185-21" tabindex="-1"></a>      tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(dplyr<span class="sc">::</span><span class="fu">everything</span>())</span>
<span id="cb185-22"><a href="s02.html#cb185-22" tabindex="-1"></a>    , <span class="fu">aes</span>(<span class="at">yintercept =</span> value, <span class="at">color =</span> <span class="st">&quot;FBHs&quot;</span>)</span>
<span id="cb185-23"><a href="s02.html#cb185-23" tabindex="-1"></a>    , <span class="at">linetype =</span> <span class="st">&quot;dotdash&quot;</span></span>
<span id="cb185-24"><a href="s02.html#cb185-24" tabindex="-1"></a>    , <span class="at">lwd =</span> <span class="fl">1.2</span></span>
<span id="cb185-25"><a href="s02.html#cb185-25" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb185-26"><a href="s02.html#cb185-26" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;green4&quot;</span>, <span class="st">&quot;red&quot;</span>), <span class="at">name =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb185-27"><a href="s02.html#cb185-27" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">extended_breaks</span>(<span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb185-28"><a href="s02.html#cb185-28" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb185-29"><a href="s02.html#cb185-29" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>)</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-117-1.png" width="1008" /></p>
<p>note, the <code>gap</code> and <code>cbh</code> columns in <code>ladderfuelsr_cbh_ans$gaps_fbhs</code> contain the data needed for the plot ( but not the <code>gap_</code> and <code>cbh_</code> columns ;/ ).</p>
<p>but what are these columns?</p>
<ul>
<li><code>cbh</code> - Height of the fuel layer base height (m)</li>
<li><code>gap</code> - Height of gap between fuel layers (m)</li>
</ul>
<div id="return-cbh-metrics" class="section level3 hasAnchor" number="3.2.1">
<h3><span class="header-section-number">3.2.1</span> Return CBH Metrics<a href="s02.html#return-cbh-metrics" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb186"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb186-1"><a href="s02.html#cb186-1" tabindex="-1"></a>ladderfuelsr_cbh_ans<span class="sc">$</span>cbh_metrics <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 1
## Columns: 29
## $ treeID1        &lt;dbl&gt; 56
## $ dptf1          &lt;dbl&gt; 8
## $ effdist1       &lt;dbl&gt; 3
## $ Hcbh1          &lt;dbl&gt; 4.5
## $ Hdist1         &lt;dbl&gt; 3.5
## $ Hdptf1         &lt;dbl&gt; 12.5
## $ max1           &lt;dbl&gt; 13.5
## $ Hcbh1_Hdptf1   &lt;dbl&gt; 96.75358
## $ treeID         &lt;fct&gt; 56
## $ max_height     &lt;dbl&gt; 13.5
## $ nlayers        &lt;int&gt; 1
## $ maxlad_Hcbh    &lt;dbl&gt; 4.5
## $ maxlad_Hdist   &lt;dbl&gt; 3.5
## $ maxlad_Hdptf   &lt;dbl&gt; 12.5
## $ maxlad_dptf    &lt;dbl&gt; 8
## $ maxlad_effdist &lt;dbl&gt; 3
## $ maxlad_lad     &lt;dbl&gt; 96.75358
## $ max_Hcbh       &lt;dbl&gt; 4.5
## $ max_Hdist      &lt;dbl&gt; 3.5
## $ max_Hdptf      &lt;dbl&gt; 12.5
## $ max_dptf       &lt;dbl&gt; 8
## $ max_effdist    &lt;dbl&gt; 3
## $ max_lad        &lt;dbl&gt; 96.75358
## $ last_Hcbh      &lt;dbl&gt; 4.5
## $ last_Hdist     &lt;dbl&gt; 3.5
## $ last_Hdptf     &lt;dbl&gt; 12.5
## $ last_dptf      &lt;dbl&gt; 8
## $ last_effdist   &lt;dbl&gt; 3
## $ last_lad       &lt;dbl&gt; 96.75358</code></pre>
<p>what are these?</p>
<ul>
<li>treeID: tree ID with strings and numeric values</li>
<li>treeID1: tree ID with only numeric values</li>
<li>dptf: Depth of fuel layers (m) after considering distances greater than the actual height bin step</li>
<li>effdist: Effective distance between consecutive fuel layers (m) after considering distances greater than any number of steps</li>
<li>Hcbh: Base height of each fuel separated by a distance greater than the certain number of steps</li>
<li>Hdptf: Height of the depth of fuel layers (m) after considering distances greater than the actual step</li>
<li>Hdist: Height of the distance (&gt; any number of steps) between consecutive fuel layers (m)</li>
<li>Hcbh_Hdptf - Percentage of LAD values comprised in each effective fuel layer</li>
<li>maxlad_Hcbh - Height of the CBH of the segmented tree based on the maximum LAD percentage</li>
<li>maxlad1_Hcbh - Height of the CBH from the second fuel layer when the maximum LAD occurred in the first fuel layer but its depth &lt;= “hdepth1_height”</li>
<li>max_Hcbh - Height of the CBH of the segmented tree based on the maximum distance found in its profile</li>
<li>last_Hcbh - Height of the CBH of the segmented tree based on the last distance found in its profile</li>
<li>maxlad_ - Values of distance and fuel depth and their corresponding heights at the maximum LAD percentage</li>
<li>maxlad1_ - Values of distance and fuel depth and their corresponding heights for the second fuel layer when the maximum LAD occurred in the first fuel layer but its depth &lt;= “hdepth1_height”</li>
<li>max_ - Values of distance and fuel depth and their corresponding heights at the maximum distance</li>
<li>last_ - Values of distance and fuel depth and their corresponding heights at the last distance</li>
<li>nlayers - Number of effective fuel layers</li>
<li>max_height - Maximum height of the tree profile</li>
</ul>
<p>there are also some plotting functions</p>
<div class="sourceCode" id="cb188"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb188-1"><a href="s02.html#cb188-1" tabindex="-1"></a><span class="co"># Generate plots for fuels LAD metrics</span></span>
<span id="cb188-2"><a href="s02.html#cb188-2" tabindex="-1"></a>plots_cbh_maxlad <span class="ot">&lt;-</span> LadderFuelsR<span class="sc">::</span><span class="fu">get_plots_cbh_LAD</span>(</span>
<span id="cb188-3"><a href="s02.html#cb188-3" tabindex="-1"></a>  <span class="at">LAD_profiles =</span> ladderfuelsr_cbh_ans<span class="sc">$</span>lad_profile</span>
<span id="cb188-4"><a href="s02.html#cb188-4" tabindex="-1"></a>  , <span class="at">cbh_metrics =</span> ladderfuelsr_cbh_ans<span class="sc">$</span>cbh_metrics</span>
<span id="cb188-5"><a href="s02.html#cb188-5" tabindex="-1"></a>  , <span class="at">min_height =</span> <span class="fl">0.5</span></span>
<span id="cb188-6"><a href="s02.html#cb188-6" tabindex="-1"></a>)</span>
<span id="cb188-7"><a href="s02.html#cb188-7" tabindex="-1"></a>plots_cbh_maxdist <span class="ot">&lt;-</span> LadderFuelsR<span class="sc">::</span><span class="fu">get_plots_cbh_maxdist</span>(</span>
<span id="cb188-8"><a href="s02.html#cb188-8" tabindex="-1"></a>  <span class="at">LAD_profiles =</span> ladderfuelsr_cbh_ans<span class="sc">$</span>lad_profile</span>
<span id="cb188-9"><a href="s02.html#cb188-9" tabindex="-1"></a>  , <span class="at">cbh_metrics =</span> ladderfuelsr_cbh_ans<span class="sc">$</span>cbh_metrics</span>
<span id="cb188-10"><a href="s02.html#cb188-10" tabindex="-1"></a>  , <span class="at">min_height =</span> <span class="fl">0.5</span></span>
<span id="cb188-11"><a href="s02.html#cb188-11" tabindex="-1"></a>)</span>
<span id="cb188-12"><a href="s02.html#cb188-12" tabindex="-1"></a>plots_cbh_lastdist <span class="ot">&lt;-</span> LadderFuelsR<span class="sc">::</span><span class="fu">get_plots_cbh_lastdist</span>(</span>
<span id="cb188-13"><a href="s02.html#cb188-13" tabindex="-1"></a>  <span class="at">LAD_profiles =</span> ladderfuelsr_cbh_ans<span class="sc">$</span>lad_profile</span>
<span id="cb188-14"><a href="s02.html#cb188-14" tabindex="-1"></a>  , <span class="at">cbh_metrics =</span> ladderfuelsr_cbh_ans<span class="sc">$</span>cbh_metrics</span>
<span id="cb188-15"><a href="s02.html#cb188-15" tabindex="-1"></a>  , <span class="at">min_height =</span> <span class="fl">0.5</span></span>
<span id="cb188-16"><a href="s02.html#cb188-16" tabindex="-1"></a>)</span>
<span id="cb188-17"><a href="s02.html#cb188-17" tabindex="-1"></a><span class="co"># patchwork them</span></span>
<span id="cb188-18"><a href="s02.html#cb188-18" tabindex="-1"></a>(plots_cbh_maxlad[[<span class="dv">1</span>]] <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;get_plots_cbh_LAD&quot;</span>)) <span class="sc">+</span></span>
<span id="cb188-19"><a href="s02.html#cb188-19" tabindex="-1"></a>(plots_cbh_maxdist[[<span class="dv">1</span>]] <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;get_plots_cbh_maxdist&quot;</span>)) <span class="sc">+</span></span>
<span id="cb188-20"><a href="s02.html#cb188-20" tabindex="-1"></a>(plots_cbh_lastdist[[<span class="dv">1</span>]] <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;get_plots_cbh_lastdist&quot;</span>)) <span class="sc">+</span></span>
<span id="cb188-21"><a href="s02.html#cb188-21" tabindex="-1"></a>  patchwork<span class="sc">::</span><span class="fu">plot_layout</span>(<span class="at">ncol =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-119-1.png" width="1008" /></p>
<p>these plots represent the three criteria to define the CBH in a segmented tree:</p>
<ul>
<li><code>get_plots_cbh_LAD</code> = the fuel layer containing the maximum LAD percentage (column named <code>maxlad_Hcbh</code>)</li>
<li><code>get_plots_cbh_maxdist</code> = the fuel layer located at the highest distance (column named <code>max_Hcbh</code>)</li>
<li><code>get_plots_cbh_lastdist</code> = the fuel layer separated by the last effective distance (column named <code>last_Hcbh</code>)</li>
</ul>
</div>
<div id="cbh-on-the-point-cloud" class="section level3 hasAnchor" number="3.2.2">
<h3><span class="header-section-number">3.2.2</span> CBH on the point cloud<a href="s02.html#cbh-on-the-point-cloud" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>can we make a view of the CBH on the point cloud?</p>
<div class="sourceCode" id="cb189"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb189-1"><a href="s02.html#cb189-1" tabindex="-1"></a><span class="co"># make a matrix to represent the cbh</span></span>
<span id="cb189-2"><a href="s02.html#cb189-2" tabindex="-1"></a>x_temp <span class="ot">&lt;-</span> <span class="fu">seq</span>(</span>
<span id="cb189-3"><a href="s02.html#cb189-3" tabindex="-1"></a>    <span class="fu">min</span>(nlas_one_tree<span class="sc">@</span>data<span class="sc">$</span>X)</span>
<span id="cb189-4"><a href="s02.html#cb189-4" tabindex="-1"></a>    , <span class="fu">max</span>(nlas_one_tree<span class="sc">@</span>data<span class="sc">$</span>X)</span>
<span id="cb189-5"><a href="s02.html#cb189-5" tabindex="-1"></a>    , <span class="at">length.out =</span> <span class="dv">2</span></span>
<span id="cb189-6"><a href="s02.html#cb189-6" tabindex="-1"></a>  )</span>
<span id="cb189-7"><a href="s02.html#cb189-7" tabindex="-1"></a>y_temp <span class="ot">&lt;-</span> <span class="fu">seq</span>(</span>
<span id="cb189-8"><a href="s02.html#cb189-8" tabindex="-1"></a>    <span class="fu">min</span>(nlas_one_tree<span class="sc">@</span>data<span class="sc">$</span>Y)</span>
<span id="cb189-9"><a href="s02.html#cb189-9" tabindex="-1"></a>    , <span class="fu">max</span>(nlas_one_tree<span class="sc">@</span>data<span class="sc">$</span>Y)</span>
<span id="cb189-10"><a href="s02.html#cb189-10" tabindex="-1"></a>    , <span class="at">length.out =</span> <span class="dv">2</span></span>
<span id="cb189-11"><a href="s02.html#cb189-11" tabindex="-1"></a>  )</span>
<span id="cb189-12"><a href="s02.html#cb189-12" tabindex="-1"></a>xy_temp <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">x =</span> x_temp, <span class="at">y =</span> y_temp)</span>
<span id="cb189-13"><a href="s02.html#cb189-13" tabindex="-1"></a>z_temp <span class="ot">&lt;-</span> <span class="fu">matrix</span>(</span>
<span id="cb189-14"><a href="s02.html#cb189-14" tabindex="-1"></a>  <span class="fu">rep</span>(</span>
<span id="cb189-15"><a href="s02.html#cb189-15" tabindex="-1"></a>    ladderfuelsr_cbh_ans<span class="sc">$</span>cbh_metrics<span class="sc">$</span>last_Hcbh</span>
<span id="cb189-16"><a href="s02.html#cb189-16" tabindex="-1"></a>    , <span class="fu">nrow</span>(xy_temp)</span>
<span id="cb189-17"><a href="s02.html#cb189-17" tabindex="-1"></a>  )</span>
<span id="cb189-18"><a href="s02.html#cb189-18" tabindex="-1"></a>  , <span class="at">nrow =</span> <span class="fu">length</span>(x_temp), <span class="at">ncol =</span> <span class="fu">length</span>(y_temp)</span>
<span id="cb189-19"><a href="s02.html#cb189-19" tabindex="-1"></a>)</span>
<span id="cb189-20"><a href="s02.html#cb189-20" tabindex="-1"></a><span class="co"># plot it</span></span>
<span id="cb189-21"><a href="s02.html#cb189-21" tabindex="-1"></a>plot3D<span class="sc">::</span><span class="fu">scatter3D</span>(</span>
<span id="cb189-22"><a href="s02.html#cb189-22" tabindex="-1"></a>  <span class="at">x =</span> nlas_one_tree<span class="sc">@</span>data<span class="sc">$</span>X</span>
<span id="cb189-23"><a href="s02.html#cb189-23" tabindex="-1"></a>  , <span class="at">y =</span> nlas_one_tree<span class="sc">@</span>data<span class="sc">$</span>Y</span>
<span id="cb189-24"><a href="s02.html#cb189-24" tabindex="-1"></a>  , <span class="at">z =</span> nlas_one_tree<span class="sc">@</span>data<span class="sc">$</span>Z</span>
<span id="cb189-25"><a href="s02.html#cb189-25" tabindex="-1"></a>  , <span class="at">colvar =</span> nlas_one_tree<span class="sc">@</span>data<span class="sc">$</span>Z</span>
<span id="cb189-26"><a href="s02.html#cb189-26" tabindex="-1"></a>  , <span class="at">cex =</span> <span class="fl">0.3</span>, <span class="at">pch =</span> <span class="dv">19</span></span>
<span id="cb189-27"><a href="s02.html#cb189-27" tabindex="-1"></a>  , <span class="at">colkey =</span> T</span>
<span id="cb189-28"><a href="s02.html#cb189-28" tabindex="-1"></a>  , <span class="at">phi =</span> <span class="sc">-</span><span class="dv">6</span></span>
<span id="cb189-29"><a href="s02.html#cb189-29" tabindex="-1"></a>  , <span class="at">col =</span> harrypotter<span class="sc">::</span><span class="fu">hp</span>(<span class="at">n=</span><span class="dv">50</span>, <span class="at">house =</span> <span class="st">&quot;gryffindor&quot;</span>)</span>
<span id="cb189-30"><a href="s02.html#cb189-30" tabindex="-1"></a>  , <span class="at">main =</span><span class="st">&quot;CBH shown in black&quot;</span></span>
<span id="cb189-31"><a href="s02.html#cb189-31" tabindex="-1"></a>  , <span class="at">surf =</span> <span class="fu">list</span>(</span>
<span id="cb189-32"><a href="s02.html#cb189-32" tabindex="-1"></a>    <span class="at">x =</span> x_temp</span>
<span id="cb189-33"><a href="s02.html#cb189-33" tabindex="-1"></a>    , <span class="at">y =</span> y_temp</span>
<span id="cb189-34"><a href="s02.html#cb189-34" tabindex="-1"></a>    , <span class="at">z =</span> z_temp</span>
<span id="cb189-35"><a href="s02.html#cb189-35" tabindex="-1"></a>    , <span class="at">facets =</span> <span class="cn">NA</span></span>
<span id="cb189-36"><a href="s02.html#cb189-36" tabindex="-1"></a>    , <span class="at">border =</span> <span class="st">&quot;black&quot;</span></span>
<span id="cb189-37"><a href="s02.html#cb189-37" tabindex="-1"></a>    , <span class="at">lwd =</span> <span class="dv">2</span></span>
<span id="cb189-38"><a href="s02.html#cb189-38" tabindex="-1"></a>  )</span>
<span id="cb189-39"><a href="s02.html#cb189-39" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-120-1.png" width="1008" /></p>
</div>
</div>
<div id="function-to-cbh-a-tree-list" class="section level2 hasAnchor" number="3.3">
<h2><span class="header-section-number">3.3</span> Function to CBH a tree list<a href="s02.html#function-to-cbh-a-tree-list" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>first, an intermediate function to clip the point cloud to a polygon and run it through the <code>ladderfuelsr_cbh()</code> function we defined above</p>
<div class="sourceCode" id="cb190"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb190-1"><a href="s02.html#cb190-1" tabindex="-1"></a>call_ladderfuelsr_cbh <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb190-2"><a href="s02.html#cb190-2" tabindex="-1"></a>      id</span>
<span id="cb190-3"><a href="s02.html#cb190-3" tabindex="-1"></a>      , poly_df</span>
<span id="cb190-4"><a href="s02.html#cb190-4" tabindex="-1"></a>      , nlas</span>
<span id="cb190-5"><a href="s02.html#cb190-5" tabindex="-1"></a>      , my_min_vhp_n</span>
<span id="cb190-6"><a href="s02.html#cb190-6" tabindex="-1"></a>      , my_voxel_grain_size_m</span>
<span id="cb190-7"><a href="s02.html#cb190-7" tabindex="-1"></a>      , my_dist_btwn_bins_m</span>
<span id="cb190-8"><a href="s02.html#cb190-8" tabindex="-1"></a>      , my_min_fuel_layer_ht_m</span>
<span id="cb190-9"><a href="s02.html#cb190-9" tabindex="-1"></a>      , my_lad_pct_gap</span>
<span id="cb190-10"><a href="s02.html#cb190-10" tabindex="-1"></a>      , my_lad_pct_base</span>
<span id="cb190-11"><a href="s02.html#cb190-11" tabindex="-1"></a>      , my_num_jump_steps</span>
<span id="cb190-12"><a href="s02.html#cb190-12" tabindex="-1"></a>      , my_min_lad_pct</span>
<span id="cb190-13"><a href="s02.html#cb190-13" tabindex="-1"></a>      , my_frst_layer_min_ht_m</span>
<span id="cb190-14"><a href="s02.html#cb190-14" tabindex="-1"></a>    ){</span>
<span id="cb190-15"><a href="s02.html#cb190-15" tabindex="-1"></a>      <span class="do">##################################</span></span>
<span id="cb190-16"><a href="s02.html#cb190-16" tabindex="-1"></a>      <span class="co"># filter sf</span></span>
<span id="cb190-17"><a href="s02.html#cb190-17" tabindex="-1"></a>      <span class="do">##################################</span></span>
<span id="cb190-18"><a href="s02.html#cb190-18" tabindex="-1"></a>      one_tree_sf <span class="ot">&lt;-</span> poly_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(treeID<span class="sc">==</span>id)</span>
<span id="cb190-19"><a href="s02.html#cb190-19" tabindex="-1"></a>      <span class="do">##################################</span></span>
<span id="cb190-20"><a href="s02.html#cb190-20" tabindex="-1"></a>      <span class="co"># clip the point cloud</span></span>
<span id="cb190-21"><a href="s02.html#cb190-21" tabindex="-1"></a>      <span class="do">##################################</span></span>
<span id="cb190-22"><a href="s02.html#cb190-22" tabindex="-1"></a>      nlas_one_tree <span class="ot">&lt;-</span> lidR<span class="sc">::</span><span class="fu">clip_roi</span>(<span class="at">las =</span> nlas, <span class="at">geometry =</span> one_tree_sf) <span class="sc">%&gt;%</span></span>
<span id="cb190-23"><a href="s02.html#cb190-23" tabindex="-1"></a>        lidR<span class="sc">::</span><span class="fu">filter_poi</span>(<span class="sc">!</span>Classification <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">9</span>,<span class="dv">18</span>)) <span class="sc">%&gt;%</span> <span class="do">## class 2 = ground; 9 = water; 18 = noise</span></span>
<span id="cb190-24"><a href="s02.html#cb190-24" tabindex="-1"></a>        lidR<span class="sc">::</span><span class="fu">add_attribute</span>(<span class="at">x =</span> id, <span class="at">name =</span> <span class="st">&quot;treeID&quot;</span>)</span>
<span id="cb190-25"><a href="s02.html#cb190-25" tabindex="-1"></a>      <span class="do">##################################</span></span>
<span id="cb190-26"><a href="s02.html#cb190-26" tabindex="-1"></a>      <span class="co"># check for points</span></span>
<span id="cb190-27"><a href="s02.html#cb190-27" tabindex="-1"></a>      <span class="do">##################################</span></span>
<span id="cb190-28"><a href="s02.html#cb190-28" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">nrow</span>(nlas_one_tree<span class="sc">@</span>data)<span class="sc">&gt;</span><span class="dv">10</span>){</span>
<span id="cb190-29"><a href="s02.html#cb190-29" tabindex="-1"></a>        <span class="co"># quiet this function</span></span>
<span id="cb190-30"><a href="s02.html#cb190-30" tabindex="-1"></a>        quiet_ladderfuelsr_cbh <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">quietly</span>(ladderfuelsr_cbh)</span>
<span id="cb190-31"><a href="s02.html#cb190-31" tabindex="-1"></a>        <span class="co"># CALL ladderfuelsr_cbh</span></span>
<span id="cb190-32"><a href="s02.html#cb190-32" tabindex="-1"></a>        ladderfuelsr_cbh_ans <span class="ot">&lt;-</span> <span class="fu">quiet_ladderfuelsr_cbh</span>(</span>
<span id="cb190-33"><a href="s02.html#cb190-33" tabindex="-1"></a>          <span class="at">las =</span> nlas_one_tree</span>
<span id="cb190-34"><a href="s02.html#cb190-34" tabindex="-1"></a>          , <span class="at">treeID =</span> id</span>
<span id="cb190-35"><a href="s02.html#cb190-35" tabindex="-1"></a>          , <span class="at">min_vhp_n =</span> my_min_vhp_n</span>
<span id="cb190-36"><a href="s02.html#cb190-36" tabindex="-1"></a>          , <span class="at">voxel_grain_size_m =</span> my_voxel_grain_size_m</span>
<span id="cb190-37"><a href="s02.html#cb190-37" tabindex="-1"></a>          , <span class="at">dist_btwn_bins_m =</span> my_dist_btwn_bins_m</span>
<span id="cb190-38"><a href="s02.html#cb190-38" tabindex="-1"></a>          , <span class="at">min_fuel_layer_ht_m =</span> my_min_fuel_layer_ht_m</span>
<span id="cb190-39"><a href="s02.html#cb190-39" tabindex="-1"></a>          , <span class="at">lad_pct_gap =</span> my_lad_pct_gap</span>
<span id="cb190-40"><a href="s02.html#cb190-40" tabindex="-1"></a>          , <span class="at">lad_pct_base =</span> my_lad_pct_base</span>
<span id="cb190-41"><a href="s02.html#cb190-41" tabindex="-1"></a>          , <span class="at">num_jump_steps =</span> my_num_jump_steps</span>
<span id="cb190-42"><a href="s02.html#cb190-42" tabindex="-1"></a>          , <span class="at">min_lad_pct =</span> my_min_lad_pct</span>
<span id="cb190-43"><a href="s02.html#cb190-43" tabindex="-1"></a>          , <span class="at">frst_layer_min_ht_m =</span> my_frst_layer_min_ht_m</span>
<span id="cb190-44"><a href="s02.html#cb190-44" tabindex="-1"></a>        ) </span>
<span id="cb190-45"><a href="s02.html#cb190-45" tabindex="-1"></a>        <span class="co"># just get the result</span></span>
<span id="cb190-46"><a href="s02.html#cb190-46" tabindex="-1"></a>        ladderfuelsr_cbh_ans <span class="ot">&lt;-</span> ladderfuelsr_cbh_ans<span class="sc">$</span>result</span>
<span id="cb190-47"><a href="s02.html#cb190-47" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb190-48"><a href="s02.html#cb190-48" tabindex="-1"></a>        ladderfuelsr_cbh_ans <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb190-49"><a href="s02.html#cb190-49" tabindex="-1"></a>      }</span>
<span id="cb190-50"><a href="s02.html#cb190-50" tabindex="-1"></a>      </span>
<span id="cb190-51"><a href="s02.html#cb190-51" tabindex="-1"></a>      <span class="co"># build return data</span></span>
<span id="cb190-52"><a href="s02.html#cb190-52" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">is.null</span>(ladderfuelsr_cbh_ans<span class="sc">$</span>cbh_metrics)){</span>
<span id="cb190-53"><a href="s02.html#cb190-53" tabindex="-1"></a>        <span class="co"># blank the cbh columns</span></span>
<span id="cb190-54"><a href="s02.html#cb190-54" tabindex="-1"></a>        df <span class="ot">&lt;-</span> one_tree_sf <span class="sc">%&gt;%</span> </span>
<span id="cb190-55"><a href="s02.html#cb190-55" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb190-56"><a href="s02.html#cb190-56" tabindex="-1"></a>            <span class="at">cbh_maxlad_height_m =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb190-57"><a href="s02.html#cb190-57" tabindex="-1"></a>            , <span class="at">cbh_max_height_m =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb190-58"><a href="s02.html#cb190-58" tabindex="-1"></a>            , <span class="at">cbh_last_height_m =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb190-59"><a href="s02.html#cb190-59" tabindex="-1"></a>          )</span>
<span id="cb190-60"><a href="s02.html#cb190-60" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb190-61"><a href="s02.html#cb190-61" tabindex="-1"></a>        df <span class="ot">&lt;-</span> one_tree_sf <span class="sc">%&gt;%</span> </span>
<span id="cb190-62"><a href="s02.html#cb190-62" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb190-63"><a href="s02.html#cb190-63" tabindex="-1"></a>            <span class="at">cbh_maxlad_height_m =</span> ladderfuelsr_cbh_ans<span class="sc">$</span>cbh_metrics<span class="sc">$</span>maxlad_Hcbh[<span class="dv">1</span>]</span>
<span id="cb190-64"><a href="s02.html#cb190-64" tabindex="-1"></a>            , <span class="at">cbh_max_height_m =</span> ladderfuelsr_cbh_ans<span class="sc">$</span>cbh_metrics<span class="sc">$</span>max_Hcbh[<span class="dv">1</span>]</span>
<span id="cb190-65"><a href="s02.html#cb190-65" tabindex="-1"></a>            , <span class="at">cbh_last_height_m =</span> ladderfuelsr_cbh_ans<span class="sc">$</span>cbh_metrics<span class="sc">$</span>last_Hcbh[<span class="dv">1</span>]</span>
<span id="cb190-66"><a href="s02.html#cb190-66" tabindex="-1"></a>          )</span>
<span id="cb190-67"><a href="s02.html#cb190-67" tabindex="-1"></a>      }</span>
<span id="cb190-68"><a href="s02.html#cb190-68" tabindex="-1"></a>      <span class="fu">return</span>(df)</span>
<span id="cb190-69"><a href="s02.html#cb190-69" tabindex="-1"></a>    }</span></code></pre></div>
<p>let’s define a function for performing the CBH estimation over multiple trees and combining all of the data</p>
<div class="sourceCode" id="cb191"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb191-1"><a href="s02.html#cb191-1" tabindex="-1"></a>trees_cbh <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb191-2"><a href="s02.html#cb191-2" tabindex="-1"></a>  trees_poly</span>
<span id="cb191-3"><a href="s02.html#cb191-3" tabindex="-1"></a>  , <span class="at">norm_las =</span> <span class="cn">NA</span></span>
<span id="cb191-4"><a href="s02.html#cb191-4" tabindex="-1"></a>  , <span class="at">tree_sample_prop =</span> <span class="dv">1</span></span>
<span id="cb191-5"><a href="s02.html#cb191-5" tabindex="-1"></a>  , <span class="at">which_cbh =</span> <span class="st">&quot;lowest&quot;</span></span>
<span id="cb191-6"><a href="s02.html#cb191-6" tabindex="-1"></a>    <span class="co"># maxlad_Hcbh = max_lad</span></span>
<span id="cb191-7"><a href="s02.html#cb191-7" tabindex="-1"></a>    <span class="co"># max_Hcbh = highest</span></span>
<span id="cb191-8"><a href="s02.html#cb191-8" tabindex="-1"></a>    <span class="co"># last_Hcbh = lowest</span></span>
<span id="cb191-9"><a href="s02.html#cb191-9" tabindex="-1"></a>  , <span class="at">estimate_missing_cbh =</span> <span class="cn">FALSE</span></span>
<span id="cb191-10"><a href="s02.html#cb191-10" tabindex="-1"></a>  <span class="do">##### LadderFuelsR</span></span>
<span id="cb191-11"><a href="s02.html#cb191-11" tabindex="-1"></a>  <span class="co"># minimum vhp records</span></span>
<span id="cb191-12"><a href="s02.html#cb191-12" tabindex="-1"></a>  <span class="co"># https://github.com/olgaviedma/LadderFuelsR?tab=readme-ov-file#8depurating-tree-lad-profiles</span></span>
<span id="cb191-13"><a href="s02.html#cb191-13" tabindex="-1"></a>  , <span class="at">min_vhp_n =</span> <span class="dv">6</span></span>
<span id="cb191-14"><a href="s02.html#cb191-14" tabindex="-1"></a>  <span class="co"># leafR::lad.voxels</span></span>
<span id="cb191-15"><a href="s02.html#cb191-15" tabindex="-1"></a>  , <span class="at">voxel_grain_size_m =</span> <span class="dv">2</span></span>
<span id="cb191-16"><a href="s02.html#cb191-16" tabindex="-1"></a>  <span class="co"># LadderFuelsR::get_gaps_fbhs</span></span>
<span id="cb191-17"><a href="s02.html#cb191-17" tabindex="-1"></a>  , <span class="at">dist_btwn_bins_m =</span> <span class="dv">1</span> <span class="co"># step</span></span>
<span id="cb191-18"><a href="s02.html#cb191-18" tabindex="-1"></a>  , <span class="at">min_fuel_layer_ht_m =</span> <span class="fl">1.5</span> <span class="co"># min_height</span></span>
<span id="cb191-19"><a href="s02.html#cb191-19" tabindex="-1"></a>  , <span class="at">lad_pct_gap =</span> <span class="dv">25</span> <span class="co"># perc_gap</span></span>
<span id="cb191-20"><a href="s02.html#cb191-20" tabindex="-1"></a>  , <span class="at">lad_pct_base =</span> <span class="dv">25</span> <span class="co"># perc_base</span></span>
<span id="cb191-21"><a href="s02.html#cb191-21" tabindex="-1"></a>  <span class="co"># LadderFuelsR::get_real_fbh</span></span>
<span id="cb191-22"><a href="s02.html#cb191-22" tabindex="-1"></a>  , <span class="at">num_jump_steps =</span> <span class="dv">1</span> <span class="co"># number_steps</span></span>
<span id="cb191-23"><a href="s02.html#cb191-23" tabindex="-1"></a>  <span class="co"># LadderFuelsR::get_layers_lad</span></span>
<span id="cb191-24"><a href="s02.html#cb191-24" tabindex="-1"></a>  , <span class="at">min_lad_pct =</span> <span class="dv">10</span> <span class="co"># threshold</span></span>
<span id="cb191-25"><a href="s02.html#cb191-25" tabindex="-1"></a>  <span class="co"># LadderFuelsR::get_cbh_metrics</span></span>
<span id="cb191-26"><a href="s02.html#cb191-26" tabindex="-1"></a>  , <span class="at">frst_layer_min_ht_m =</span> <span class="fl">2.5</span> <span class="co"># hdepth1_height</span></span>
<span id="cb191-27"><a href="s02.html#cb191-27" tabindex="-1"></a>){</span>
<span id="cb191-28"><a href="s02.html#cb191-28" tabindex="-1"></a>  <span class="do">##################################</span></span>
<span id="cb191-29"><a href="s02.html#cb191-29" tabindex="-1"></a>  <span class="co"># check which cbh</span></span>
<span id="cb191-30"><a href="s02.html#cb191-30" tabindex="-1"></a>  <span class="do">##################################</span></span>
<span id="cb191-31"><a href="s02.html#cb191-31" tabindex="-1"></a>    <span class="co"># clean it</span></span>
<span id="cb191-32"><a href="s02.html#cb191-32" tabindex="-1"></a>    which_cbh <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(which_cbh, <span class="st">&quot;lowest&quot;</span>)</span>
<span id="cb191-33"><a href="s02.html#cb191-33" tabindex="-1"></a>    which_cbh <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb191-34"><a href="s02.html#cb191-34" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(which_cbh,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">s&quot;</span>) <span class="sc">==</span> <span class="st">&quot;&quot;</span></span>
<span id="cb191-35"><a href="s02.html#cb191-35" tabindex="-1"></a>      , <span class="st">&quot;lowest&quot;</span></span>
<span id="cb191-36"><a href="s02.html#cb191-36" tabindex="-1"></a>      , which_cbh</span>
<span id="cb191-37"><a href="s02.html#cb191-37" tabindex="-1"></a>    )</span>
<span id="cb191-38"><a href="s02.html#cb191-38" tabindex="-1"></a>    which_cbh <span class="ot">&lt;-</span> <span class="fu">tolower</span>(which_cbh[<span class="dv">1</span>])</span>
<span id="cb191-39"><a href="s02.html#cb191-39" tabindex="-1"></a>    <span class="co"># check it</span></span>
<span id="cb191-40"><a href="s02.html#cb191-40" tabindex="-1"></a>    cbh_l <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;max_lad&quot;</span>, <span class="st">&quot;highest&quot;</span>, <span class="st">&quot;lowest&quot;</span>)</span>
<span id="cb191-41"><a href="s02.html#cb191-41" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span>which_cbh <span class="sc">%in%</span> cbh_l){</span>
<span id="cb191-42"><a href="s02.html#cb191-42" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="fu">paste0</span>(</span>
<span id="cb191-43"><a href="s02.html#cb191-43" tabindex="-1"></a>        <span class="st">&quot;`which_cbh` must be one of:&quot;</span></span>
<span id="cb191-44"><a href="s02.html#cb191-44" tabindex="-1"></a>        , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb191-45"><a href="s02.html#cb191-45" tabindex="-1"></a>        , <span class="fu">paste</span>(cbh_l, <span class="at">collapse =</span> <span class="st">&quot;, &quot;</span>)</span>
<span id="cb191-46"><a href="s02.html#cb191-46" tabindex="-1"></a>      ))</span>
<span id="cb191-47"><a href="s02.html#cb191-47" tabindex="-1"></a>    }</span>
<span id="cb191-48"><a href="s02.html#cb191-48" tabindex="-1"></a>  <span class="do">##################################</span></span>
<span id="cb191-49"><a href="s02.html#cb191-49" tabindex="-1"></a>  <span class="co"># ensure that norm las data exists</span></span>
<span id="cb191-50"><a href="s02.html#cb191-50" tabindex="-1"></a>  <span class="do">##################################</span></span>
<span id="cb191-51"><a href="s02.html#cb191-51" tabindex="-1"></a>  nlas_msg <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb191-52"><a href="s02.html#cb191-52" tabindex="-1"></a>    <span class="st">&quot;`norm_las` must contain a directory with nomalized las files, the path of a .laz|.las file&quot;</span></span>
<span id="cb191-53"><a href="s02.html#cb191-53" tabindex="-1"></a>    , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">, -or- an object of class `LAS`. Please update the `norm_las` parameter.&quot;</span></span>
<span id="cb191-54"><a href="s02.html#cb191-54" tabindex="-1"></a>  )</span>
<span id="cb191-55"><a href="s02.html#cb191-55" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.na</span>(norm_las)){<span class="fu">stop</span>(nlas_msg)}</span>
<span id="cb191-56"><a href="s02.html#cb191-56" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">inherits</span>(norm_las, <span class="st">&quot;character&quot;</span>)){</span>
<span id="cb191-57"><a href="s02.html#cb191-57" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span>stringr<span class="sc">::</span><span class="fu">str_ends</span>(norm_las, <span class="st">&quot;.*</span><span class="sc">\\</span><span class="st">.(laz|las)$&quot;</span>)){</span>
<span id="cb191-58"><a href="s02.html#cb191-58" tabindex="-1"></a>      <span class="co"># try to read directory for las files</span></span>
<span id="cb191-59"><a href="s02.html#cb191-59" tabindex="-1"></a>      fls <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="fu">normalizePath</span>(norm_las), <span class="at">pattern =</span> <span class="st">&quot;.*</span><span class="sc">\\</span><span class="st">.(laz|las)$&quot;</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb191-60"><a href="s02.html#cb191-60" tabindex="-1"></a>      <span class="co"># stop it if no files</span></span>
<span id="cb191-61"><a href="s02.html#cb191-61" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">length</span>(fls)<span class="sc">&lt;</span><span class="dv">1</span>){<span class="fu">stop</span>(nlas_msg)}</span>
<span id="cb191-62"><a href="s02.html#cb191-62" tabindex="-1"></a>      <span class="co"># read it</span></span>
<span id="cb191-63"><a href="s02.html#cb191-63" tabindex="-1"></a>      nlas_ctg <span class="ot">&lt;-</span> lidR<span class="sc">::</span><span class="fu">readLAScatalog</span>(fls)</span>
<span id="cb191-64"><a href="s02.html#cb191-64" tabindex="-1"></a>      <span class="co"># turn of lidR progress</span></span>
<span id="cb191-65"><a href="s02.html#cb191-65" tabindex="-1"></a>      lidR<span class="sc">::</span><span class="fu">opt_progress</span>(nlas_ctg) <span class="ot">&lt;-</span> F</span>
<span id="cb191-66"><a href="s02.html#cb191-66" tabindex="-1"></a>    }<span class="cf">else</span> <span class="cf">if</span>(stringr<span class="sc">::</span><span class="fu">str_ends</span>(norm_las, <span class="st">&quot;.*</span><span class="sc">\\</span><span class="st">.(laz|las)$&quot;</span>)){</span>
<span id="cb191-67"><a href="s02.html#cb191-67" tabindex="-1"></a>      <span class="co"># read it</span></span>
<span id="cb191-68"><a href="s02.html#cb191-68" tabindex="-1"></a>      nlas_ctg <span class="ot">&lt;-</span> lidR<span class="sc">::</span><span class="fu">readLAScatalog</span>(norm_las)</span>
<span id="cb191-69"><a href="s02.html#cb191-69" tabindex="-1"></a>      <span class="co"># turn of lidR progress</span></span>
<span id="cb191-70"><a href="s02.html#cb191-70" tabindex="-1"></a>      lidR<span class="sc">::</span><span class="fu">opt_progress</span>(nlas_ctg) <span class="ot">&lt;-</span> F</span>
<span id="cb191-71"><a href="s02.html#cb191-71" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb191-72"><a href="s02.html#cb191-72" tabindex="-1"></a>      <span class="fu">stop</span>(nlas_msg)</span>
<span id="cb191-73"><a href="s02.html#cb191-73" tabindex="-1"></a>    }</span>
<span id="cb191-74"><a href="s02.html#cb191-74" tabindex="-1"></a>  }<span class="cf">else</span> <span class="cf">if</span>(<span class="fu">inherits</span>(norm_las, <span class="st">&quot;LAS&quot;</span>)){</span>
<span id="cb191-75"><a href="s02.html#cb191-75" tabindex="-1"></a>    nlas_ctg <span class="ot">&lt;-</span> norm_las</span>
<span id="cb191-76"><a href="s02.html#cb191-76" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb191-77"><a href="s02.html#cb191-77" tabindex="-1"></a>    <span class="fu">stop</span>(nlas_msg)</span>
<span id="cb191-78"><a href="s02.html#cb191-78" tabindex="-1"></a>  }</span>
<span id="cb191-79"><a href="s02.html#cb191-79" tabindex="-1"></a>  <span class="do">##################################</span></span>
<span id="cb191-80"><a href="s02.html#cb191-80" tabindex="-1"></a>  <span class="co"># ensure that treeID data exists</span></span>
<span id="cb191-81"><a href="s02.html#cb191-81" tabindex="-1"></a>  <span class="do">##################################</span></span>
<span id="cb191-82"><a href="s02.html#cb191-82" tabindex="-1"></a>  f <span class="ot">&lt;-</span> trees_poly <span class="sc">%&gt;%</span> <span class="fu">names</span>()</span>
<span id="cb191-83"><a href="s02.html#cb191-83" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(f)<span class="sc">==</span><span class="dv">0</span>){f <span class="ot">&lt;-</span> <span class="st">&quot;&quot;</span>}</span>
<span id="cb191-84"><a href="s02.html#cb191-84" tabindex="-1"></a>  <span class="cf">if</span>(</span>
<span id="cb191-85"><a href="s02.html#cb191-85" tabindex="-1"></a>    <span class="fu">max</span>(<span class="fu">grepl</span>(<span class="st">&quot;treeID&quot;</span>, f))<span class="sc">==</span><span class="dv">0</span></span>
<span id="cb191-86"><a href="s02.html#cb191-86" tabindex="-1"></a>  ){</span>
<span id="cb191-87"><a href="s02.html#cb191-87" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="fu">paste0</span>(</span>
<span id="cb191-88"><a href="s02.html#cb191-88" tabindex="-1"></a>      <span class="st">&quot;`trees_poly` data must contain `treeID` column to estimate missing CBH values.&quot;</span></span>
<span id="cb191-89"><a href="s02.html#cb191-89" tabindex="-1"></a>      , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">Provide the `treeID` as a unique identifier of individual trees.&quot;</span></span>
<span id="cb191-90"><a href="s02.html#cb191-90" tabindex="-1"></a>    ))</span>
<span id="cb191-91"><a href="s02.html#cb191-91" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb191-92"><a href="s02.html#cb191-92" tabindex="-1"></a>    <span class="co"># check for duplicate treeID</span></span>
<span id="cb191-93"><a href="s02.html#cb191-93" tabindex="-1"></a>    <span class="cf">if</span>(</span>
<span id="cb191-94"><a href="s02.html#cb191-94" tabindex="-1"></a>      <span class="fu">nrow</span>(trees_poly) <span class="sc">!=</span> <span class="fu">length</span>(<span class="fu">unique</span>(trees_poly<span class="sc">$</span>treeID))</span>
<span id="cb191-95"><a href="s02.html#cb191-95" tabindex="-1"></a>    ){</span>
<span id="cb191-96"><a href="s02.html#cb191-96" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">&quot;Duplicates found in the treeID column. Please remove duplicates and try again.&quot;</span>)</span>
<span id="cb191-97"><a href="s02.html#cb191-97" tabindex="-1"></a>    }</span>
<span id="cb191-98"><a href="s02.html#cb191-98" tabindex="-1"></a>    <span class="co"># ensure that treeID is numeric</span></span>
<span id="cb191-99"><a href="s02.html#cb191-99" tabindex="-1"></a>    <span class="co"># generate a treeID index because it needs to be numeric for LadderFuelsR</span></span>
<span id="cb191-100"><a href="s02.html#cb191-100" tabindex="-1"></a>    trees_poly <span class="ot">&lt;-</span> trees_poly <span class="sc">%&gt;%</span> </span>
<span id="cb191-101"><a href="s02.html#cb191-101" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb191-102"><a href="s02.html#cb191-102" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb191-103"><a href="s02.html#cb191-103" tabindex="-1"></a>        <span class="at">treeID_backup =</span> treeID</span>
<span id="cb191-104"><a href="s02.html#cb191-104" tabindex="-1"></a>        , <span class="at">treeID =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>()</span>
<span id="cb191-105"><a href="s02.html#cb191-105" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb191-106"><a href="s02.html#cb191-106" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">relocate</span>(treeID)</span>
<span id="cb191-107"><a href="s02.html#cb191-107" tabindex="-1"></a>  }</span>
<span id="cb191-108"><a href="s02.html#cb191-108" tabindex="-1"></a>  </span>
<span id="cb191-109"><a href="s02.html#cb191-109" tabindex="-1"></a>  <span class="do">##################################</span></span>
<span id="cb191-110"><a href="s02.html#cb191-110" tabindex="-1"></a>  <span class="co"># ensure spatial polygon data</span></span>
<span id="cb191-111"><a href="s02.html#cb191-111" tabindex="-1"></a>  <span class="do">##################################</span></span>
<span id="cb191-112"><a href="s02.html#cb191-112" tabindex="-1"></a>  sf_msg <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb191-113"><a href="s02.html#cb191-113" tabindex="-1"></a>      <span class="st">&quot;`trees_poly` data must be an object of class `sf` with only POLYGON type.&quot;</span></span>
<span id="cb191-114"><a href="s02.html#cb191-114" tabindex="-1"></a>      , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">Provide an `sf` object and see `sf::st_geometry_type()`.&quot;</span></span>
<span id="cb191-115"><a href="s02.html#cb191-115" tabindex="-1"></a>    )</span>
<span id="cb191-116"><a href="s02.html#cb191-116" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(trees_poly, <span class="st">&quot;sf&quot;</span>)){<span class="fu">stop</span>(sf_msg)}</span>
<span id="cb191-117"><a href="s02.html#cb191-117" tabindex="-1"></a>  <span class="cf">if</span>( <span class="fu">min</span>(sf<span class="sc">::</span><span class="fu">st_is</span>(trees_poly, <span class="at">type =</span> <span class="fu">c</span>(<span class="st">&quot;POLYGON&quot;</span>, <span class="st">&quot;MULTIPOLYGON&quot;</span>))) <span class="sc">==</span> <span class="dv">0</span> ){<span class="fu">stop</span>(sf_msg)}</span>
<span id="cb191-118"><a href="s02.html#cb191-118" tabindex="-1"></a>  </span>
<span id="cb191-119"><a href="s02.html#cb191-119" tabindex="-1"></a>  <span class="do">##################################</span></span>
<span id="cb191-120"><a href="s02.html#cb191-120" tabindex="-1"></a>  <span class="co"># ensure the las and sf are same projection</span></span>
<span id="cb191-121"><a href="s02.html#cb191-121" tabindex="-1"></a>  <span class="do">##################################</span></span>
<span id="cb191-122"><a href="s02.html#cb191-122" tabindex="-1"></a>  <span class="co"># get crs</span></span>
<span id="cb191-123"><a href="s02.html#cb191-123" tabindex="-1"></a>    crs_las <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_crs</span>(nlas_ctg)</span>
<span id="cb191-124"><a href="s02.html#cb191-124" tabindex="-1"></a>    crs_poly <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_crs</span>(trees_poly)</span>
<span id="cb191-125"><a href="s02.html#cb191-125" tabindex="-1"></a>  <span class="co"># test equal epsg</span></span>
<span id="cb191-126"><a href="s02.html#cb191-126" tabindex="-1"></a>    <span class="cf">if</span>(</span>
<span id="cb191-127"><a href="s02.html#cb191-127" tabindex="-1"></a>      <span class="fu">is.na</span>(crs_las<span class="sc">$</span>epsg) <span class="sc">|</span></span>
<span id="cb191-128"><a href="s02.html#cb191-128" tabindex="-1"></a>      <span class="fu">is.na</span>(crs_poly<span class="sc">$</span>epsg) <span class="sc">|</span></span>
<span id="cb191-129"><a href="s02.html#cb191-129" tabindex="-1"></a>      crs_las<span class="sc">$</span>epsg <span class="sc">!=</span> crs_poly<span class="sc">$</span>epsg</span>
<span id="cb191-130"><a href="s02.html#cb191-130" tabindex="-1"></a>    ){</span>
<span id="cb191-131"><a href="s02.html#cb191-131" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">&quot;The `trees_poly` and `norm_las` data have differing CRS projections. Please see `sf::st_crs()` and ensure compatibility.&quot;</span>)</span>
<span id="cb191-132"><a href="s02.html#cb191-132" tabindex="-1"></a>    }</span>
<span id="cb191-133"><a href="s02.html#cb191-133" tabindex="-1"></a>  </span>
<span id="cb191-134"><a href="s02.html#cb191-134" tabindex="-1"></a>  <span class="do">####################################################################</span></span>
<span id="cb191-135"><a href="s02.html#cb191-135" tabindex="-1"></a>  <span class="co"># map over ladderfuelsr_cbh function</span></span>
<span id="cb191-136"><a href="s02.html#cb191-136" tabindex="-1"></a>  <span class="do">####################################################################</span></span>
<span id="cb191-137"><a href="s02.html#cb191-137" tabindex="-1"></a>  cbh_df <span class="ot">&lt;-</span> trees_poly <span class="sc">%&gt;%</span> </span>
<span id="cb191-138"><a href="s02.html#cb191-138" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">slice_sample</span>(<span class="at">prop =</span> <span class="fu">min</span>(<span class="fu">as.numeric</span>(tree_sample_prop), <span class="dv">1</span>, <span class="at">na.rm =</span> T)) <span class="sc">%&gt;%</span> </span>
<span id="cb191-139"><a href="s02.html#cb191-139" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(treeID) <span class="sc">%&gt;%</span> </span>
<span id="cb191-140"><a href="s02.html#cb191-140" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">map</span>(\(x) <span class="fu">call_ladderfuelsr_cbh</span>(</span>
<span id="cb191-141"><a href="s02.html#cb191-141" tabindex="-1"></a>      <span class="at">id =</span> x</span>
<span id="cb191-142"><a href="s02.html#cb191-142" tabindex="-1"></a>      , <span class="at">poly_df =</span> trees_poly</span>
<span id="cb191-143"><a href="s02.html#cb191-143" tabindex="-1"></a>      , <span class="at">nlas =</span> nlas_ctg</span>
<span id="cb191-144"><a href="s02.html#cb191-144" tabindex="-1"></a>      , <span class="at">my_min_vhp_n =</span> min_vhp_n</span>
<span id="cb191-145"><a href="s02.html#cb191-145" tabindex="-1"></a>      , <span class="at">my_voxel_grain_size_m =</span> voxel_grain_size_m</span>
<span id="cb191-146"><a href="s02.html#cb191-146" tabindex="-1"></a>      , <span class="at">my_dist_btwn_bins_m =</span> dist_btwn_bins_m</span>
<span id="cb191-147"><a href="s02.html#cb191-147" tabindex="-1"></a>      , <span class="at">my_min_fuel_layer_ht_m =</span> min_fuel_layer_ht_m</span>
<span id="cb191-148"><a href="s02.html#cb191-148" tabindex="-1"></a>      , <span class="at">my_lad_pct_gap =</span> lad_pct_gap</span>
<span id="cb191-149"><a href="s02.html#cb191-149" tabindex="-1"></a>      , <span class="at">my_lad_pct_base =</span> lad_pct_base</span>
<span id="cb191-150"><a href="s02.html#cb191-150" tabindex="-1"></a>      , <span class="at">my_num_jump_steps =</span> num_jump_steps</span>
<span id="cb191-151"><a href="s02.html#cb191-151" tabindex="-1"></a>      , <span class="at">my_min_lad_pct =</span> min_lad_pct</span>
<span id="cb191-152"><a href="s02.html#cb191-152" tabindex="-1"></a>      , <span class="at">my_frst_layer_min_ht_m =</span> frst_layer_min_ht_m</span>
<span id="cb191-153"><a href="s02.html#cb191-153" tabindex="-1"></a>    )) <span class="sc">%&gt;%</span> </span>
<span id="cb191-154"><a href="s02.html#cb191-154" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>() <span class="sc">%&gt;%</span></span>
<span id="cb191-155"><a href="s02.html#cb191-155" tabindex="-1"></a>    <span class="co"># get rid of treeID</span></span>
<span id="cb191-156"><a href="s02.html#cb191-156" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb191-157"><a href="s02.html#cb191-157" tabindex="-1"></a>      <span class="at">treeID =</span> treeID_backup</span>
<span id="cb191-158"><a href="s02.html#cb191-158" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb191-159"><a href="s02.html#cb191-159" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>treeID_backup) <span class="sc">%&gt;%</span></span>
<span id="cb191-160"><a href="s02.html#cb191-160" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">relocate</span>(treeID) <span class="sc">%&gt;%</span> </span>
<span id="cb191-161"><a href="s02.html#cb191-161" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>()</span>
<span id="cb191-162"><a href="s02.html#cb191-162" tabindex="-1"></a>  </span>
<span id="cb191-163"><a href="s02.html#cb191-163" tabindex="-1"></a>  <span class="co"># pick a cbh</span></span>
<span id="cb191-164"><a href="s02.html#cb191-164" tabindex="-1"></a>  <span class="cf">if</span>(which_cbh <span class="sc">==</span> <span class="st">&quot;max_lad&quot;</span>){</span>
<span id="cb191-165"><a href="s02.html#cb191-165" tabindex="-1"></a>    cbh_df <span class="ot">&lt;-</span> cbh_df <span class="sc">%&gt;%</span> </span>
<span id="cb191-166"><a href="s02.html#cb191-166" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb191-167"><a href="s02.html#cb191-167" tabindex="-1"></a>        <span class="at">tree_cbh_m =</span> cbh_maxlad_height_m</span>
<span id="cb191-168"><a href="s02.html#cb191-168" tabindex="-1"></a>        , <span class="at">is_training_cbh =</span> <span class="sc">!</span><span class="fu">is.na</span>(cbh_maxlad_height_m)</span>
<span id="cb191-169"><a href="s02.html#cb191-169" tabindex="-1"></a>      )</span>
<span id="cb191-170"><a href="s02.html#cb191-170" tabindex="-1"></a>  }<span class="cf">else</span> <span class="cf">if</span>(which_cbh <span class="sc">==</span> <span class="st">&quot;highest&quot;</span>){</span>
<span id="cb191-171"><a href="s02.html#cb191-171" tabindex="-1"></a>    cbh_df <span class="ot">&lt;-</span> cbh_df <span class="sc">%&gt;%</span> </span>
<span id="cb191-172"><a href="s02.html#cb191-172" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb191-173"><a href="s02.html#cb191-173" tabindex="-1"></a>        <span class="at">tree_cbh_m =</span> cbh_max_height_m</span>
<span id="cb191-174"><a href="s02.html#cb191-174" tabindex="-1"></a>        , <span class="at">is_training_cbh =</span> <span class="sc">!</span><span class="fu">is.na</span>(cbh_max_height_m)</span>
<span id="cb191-175"><a href="s02.html#cb191-175" tabindex="-1"></a>      )</span>
<span id="cb191-176"><a href="s02.html#cb191-176" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb191-177"><a href="s02.html#cb191-177" tabindex="-1"></a>    cbh_df <span class="ot">&lt;-</span> cbh_df <span class="sc">%&gt;%</span> </span>
<span id="cb191-178"><a href="s02.html#cb191-178" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb191-179"><a href="s02.html#cb191-179" tabindex="-1"></a>        <span class="at">tree_cbh_m =</span> cbh_last_height_m</span>
<span id="cb191-180"><a href="s02.html#cb191-180" tabindex="-1"></a>        , <span class="at">is_training_cbh =</span> <span class="sc">!</span><span class="fu">is.na</span>(cbh_last_height_m)</span>
<span id="cb191-181"><a href="s02.html#cb191-181" tabindex="-1"></a>      )</span>
<span id="cb191-182"><a href="s02.html#cb191-182" tabindex="-1"></a>  }</span>
<span id="cb191-183"><a href="s02.html#cb191-183" tabindex="-1"></a>    </span>
<span id="cb191-184"><a href="s02.html#cb191-184" tabindex="-1"></a>  <span class="co"># get rid of treeID</span></span>
<span id="cb191-185"><a href="s02.html#cb191-185" tabindex="-1"></a>  trees_poly <span class="ot">&lt;-</span> trees_poly <span class="sc">%&gt;%</span> </span>
<span id="cb191-186"><a href="s02.html#cb191-186" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">treeID =</span> treeID_backup) <span class="sc">%&gt;%</span></span>
<span id="cb191-187"><a href="s02.html#cb191-187" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>treeID_backup) <span class="sc">%&gt;%</span></span>
<span id="cb191-188"><a href="s02.html#cb191-188" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">relocate</span>(treeID)</span>
<span id="cb191-189"><a href="s02.html#cb191-189" tabindex="-1"></a>  </span>
<span id="cb191-190"><a href="s02.html#cb191-190" tabindex="-1"></a>  <span class="co"># ensure that there are enough data to estimate</span></span>
<span id="cb191-191"><a href="s02.html#cb191-191" tabindex="-1"></a>  n_cbh <span class="ot">&lt;-</span> cbh_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(is_training_cbh<span class="sc">==</span>T) <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()</span>
<span id="cb191-192"><a href="s02.html#cb191-192" tabindex="-1"></a>  </span>
<span id="cb191-193"><a href="s02.html#cb191-193" tabindex="-1"></a>  <span class="co"># ensure that tree height data exists</span></span>
<span id="cb191-194"><a href="s02.html#cb191-194" tabindex="-1"></a>  f <span class="ot">&lt;-</span> trees_poly <span class="sc">%&gt;%</span> <span class="fu">names</span>()</span>
<span id="cb191-195"><a href="s02.html#cb191-195" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(f)<span class="sc">==</span><span class="dv">0</span>){f <span class="ot">&lt;-</span> <span class="st">&quot;&quot;</span>}</span>
<span id="cb191-196"><a href="s02.html#cb191-196" tabindex="-1"></a>  </span>
<span id="cb191-197"><a href="s02.html#cb191-197" tabindex="-1"></a>  <span class="do">#############################################</span></span>
<span id="cb191-198"><a href="s02.html#cb191-198" tabindex="-1"></a>  <span class="co"># check for estimate missing</span></span>
<span id="cb191-199"><a href="s02.html#cb191-199" tabindex="-1"></a>  <span class="do">#############################################</span></span>
<span id="cb191-200"><a href="s02.html#cb191-200" tabindex="-1"></a>  <span class="cf">if</span>(</span>
<span id="cb191-201"><a href="s02.html#cb191-201" tabindex="-1"></a>    estimate_missing_cbh<span class="sc">==</span>T </span>
<span id="cb191-202"><a href="s02.html#cb191-202" tabindex="-1"></a>    <span class="sc">&amp;</span> n_cbh <span class="sc">&gt;</span> <span class="dv">10</span></span>
<span id="cb191-203"><a href="s02.html#cb191-203" tabindex="-1"></a>    <span class="sc">&amp;</span> <span class="fu">max</span>(<span class="fu">grepl</span>(<span class="st">&quot;tree_height_m&quot;</span>, f))<span class="sc">==</span><span class="dv">1</span></span>
<span id="cb191-204"><a href="s02.html#cb191-204" tabindex="-1"></a>  ){</span>
<span id="cb191-205"><a href="s02.html#cb191-205" tabindex="-1"></a>    <span class="co"># add x,y to data</span></span>
<span id="cb191-206"><a href="s02.html#cb191-206" tabindex="-1"></a>    mod_df <span class="ot">&lt;-</span> trees_poly <span class="sc">%&gt;%</span> </span>
<span id="cb191-207"><a href="s02.html#cb191-207" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb191-208"><a href="s02.html#cb191-208" tabindex="-1"></a>        cbh_df <span class="sc">%&gt;%</span> </span>
<span id="cb191-209"><a href="s02.html#cb191-209" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(treeID, tree_cbh_m, is_training_cbh)</span>
<span id="cb191-210"><a href="s02.html#cb191-210" tabindex="-1"></a>        , <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span></span>
<span id="cb191-211"><a href="s02.html#cb191-211" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb191-212"><a href="s02.html#cb191-212" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">is_training_cbh =</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(is_training_cbh, F)) <span class="sc">%&gt;%</span> </span>
<span id="cb191-213"><a href="s02.html#cb191-213" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(treeID, tree_height_m, tree_cbh_m, is_training_cbh) <span class="sc">%&gt;%</span> </span>
<span id="cb191-214"><a href="s02.html#cb191-214" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_centroid</span>() <span class="sc">%&gt;%</span></span>
<span id="cb191-215"><a href="s02.html#cb191-215" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb191-216"><a href="s02.html#cb191-216" tabindex="-1"></a>        <span class="at">tree_xxx =</span> sf<span class="sc">::</span><span class="fu">st_coordinates</span>(.)[,<span class="dv">1</span>]</span>
<span id="cb191-217"><a href="s02.html#cb191-217" tabindex="-1"></a>        , <span class="at">tree_yyy =</span> sf<span class="sc">::</span><span class="fu">st_coordinates</span>(.)[,<span class="dv">2</span>]</span>
<span id="cb191-218"><a href="s02.html#cb191-218" tabindex="-1"></a>        , <span class="at">crown_area_zzz =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.)</span>
<span id="cb191-219"><a href="s02.html#cb191-219" tabindex="-1"></a>        , <span class="at">tree_height_m =</span> <span class="fu">as.numeric</span>(tree_height_m)</span>
<span id="cb191-220"><a href="s02.html#cb191-220" tabindex="-1"></a>        , <span class="at">tree_cbh_m =</span> <span class="fu">as.numeric</span>(tree_cbh_m)</span>
<span id="cb191-221"><a href="s02.html#cb191-221" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb191-222"><a href="s02.html#cb191-222" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>()</span>
<span id="cb191-223"><a href="s02.html#cb191-223" tabindex="-1"></a>    <span class="co"># training versus predict data</span></span>
<span id="cb191-224"><a href="s02.html#cb191-224" tabindex="-1"></a>    training_df <span class="ot">&lt;-</span> mod_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(is_training_cbh<span class="sc">==</span>T) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>is_training_cbh)</span>
<span id="cb191-225"><a href="s02.html#cb191-225" tabindex="-1"></a>    predict_df <span class="ot">&lt;-</span> mod_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(is_training_cbh<span class="sc">==</span>F) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>is_training_cbh)</span>
<span id="cb191-226"><a href="s02.html#cb191-226" tabindex="-1"></a>    </span>
<span id="cb191-227"><a href="s02.html#cb191-227" tabindex="-1"></a>    <span class="do">### tuning RF model</span></span>
<span id="cb191-228"><a href="s02.html#cb191-228" tabindex="-1"></a>      <span class="co"># If we are interested with just starting out and tuning the mtry parameter</span></span>
<span id="cb191-229"><a href="s02.html#cb191-229" tabindex="-1"></a>      <span class="co"># we can use randomForest::tuneRF for a quick and easy tuning assessment.</span></span>
<span id="cb191-230"><a href="s02.html#cb191-230" tabindex="-1"></a>      <span class="co"># tuneRf will start at a value of mtry that you supply and increase by a</span></span>
<span id="cb191-231"><a href="s02.html#cb191-231" tabindex="-1"></a>      <span class="co"># certain step factor until the OOB error stops improving be a specified amount.</span></span>
<span id="cb191-232"><a href="s02.html#cb191-232" tabindex="-1"></a>      <span class="co"># quiet this</span></span>
<span id="cb191-233"><a href="s02.html#cb191-233" tabindex="-1"></a>      quiet_tuneRF <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">quietly</span>(randomForest<span class="sc">::</span>tuneRF)</span>
<span id="cb191-234"><a href="s02.html#cb191-234" tabindex="-1"></a>      <span class="co"># run it</span></span>
<span id="cb191-235"><a href="s02.html#cb191-235" tabindex="-1"></a>      rf_tune_temp <span class="ot">&lt;-</span> <span class="fu">quiet_tuneRF</span>(</span>
<span id="cb191-236"><a href="s02.html#cb191-236" tabindex="-1"></a>        <span class="co"># randomForest::tuneRF(</span></span>
<span id="cb191-237"><a href="s02.html#cb191-237" tabindex="-1"></a>        <span class="at">y =</span> training_df<span class="sc">$</span>tree_cbh_m</span>
<span id="cb191-238"><a href="s02.html#cb191-238" tabindex="-1"></a>        , <span class="at">x =</span> training_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(treeID,tree_cbh_m))</span>
<span id="cb191-239"><a href="s02.html#cb191-239" tabindex="-1"></a>        , <span class="at">stepFactor =</span> <span class="fl">0.5</span></span>
<span id="cb191-240"><a href="s02.html#cb191-240" tabindex="-1"></a>        , <span class="at">ntreeTry =</span> <span class="dv">200</span></span>
<span id="cb191-241"><a href="s02.html#cb191-241" tabindex="-1"></a>        , <span class="at">mtryStart =</span> <span class="fl">0.5</span></span>
<span id="cb191-242"><a href="s02.html#cb191-242" tabindex="-1"></a>        , <span class="at">improve =</span> <span class="fl">0.01</span></span>
<span id="cb191-243"><a href="s02.html#cb191-243" tabindex="-1"></a>        , <span class="at">plot =</span> F</span>
<span id="cb191-244"><a href="s02.html#cb191-244" tabindex="-1"></a>        , <span class="at">trace =</span> F</span>
<span id="cb191-245"><a href="s02.html#cb191-245" tabindex="-1"></a>      )</span>
<span id="cb191-246"><a href="s02.html#cb191-246" tabindex="-1"></a>      <span class="co"># just get the result</span></span>
<span id="cb191-247"><a href="s02.html#cb191-247" tabindex="-1"></a>      rf_tune_temp <span class="ot">&lt;-</span> rf_tune_temp<span class="sc">$</span>result</span>
<span id="cb191-248"><a href="s02.html#cb191-248" tabindex="-1"></a>      </span>
<span id="cb191-249"><a href="s02.html#cb191-249" tabindex="-1"></a>      <span class="co"># Extract the optimal mtry value</span></span>
<span id="cb191-250"><a href="s02.html#cb191-250" tabindex="-1"></a>      optimal_mtry <span class="ot">&lt;-</span> rf_tune_temp <span class="sc">%&gt;%</span></span>
<span id="cb191-251"><a href="s02.html#cb191-251" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb191-252"><a href="s02.html#cb191-252" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(OOBError<span class="sc">==</span><span class="fu">min</span>(OOBError)) <span class="sc">%&gt;%</span></span>
<span id="cb191-253"><a href="s02.html#cb191-253" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(dplyr<span class="sc">::</span><span class="fu">row_number</span>() <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb191-254"><a href="s02.html#cb191-254" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">pull</span>(mtry)</span>
<span id="cb191-255"><a href="s02.html#cb191-255" tabindex="-1"></a>      <span class="co"># ensure that the mtry value is not greater than the number of predictors</span></span>
<span id="cb191-256"><a href="s02.html#cb191-256" tabindex="-1"></a>      optimal_mtry <span class="ot">&lt;-</span> <span class="fu">min</span>(</span>
<span id="cb191-257"><a href="s02.html#cb191-257" tabindex="-1"></a>        optimal_mtry</span>
<span id="cb191-258"><a href="s02.html#cb191-258" tabindex="-1"></a>        , <span class="fu">ncol</span>(</span>
<span id="cb191-259"><a href="s02.html#cb191-259" tabindex="-1"></a>          training_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(treeID,tree_cbh_m))</span>
<span id="cb191-260"><a href="s02.html#cb191-260" tabindex="-1"></a>        )</span>
<span id="cb191-261"><a href="s02.html#cb191-261" tabindex="-1"></a>      )</span>
<span id="cb191-262"><a href="s02.html#cb191-262" tabindex="-1"></a></span>
<span id="cb191-263"><a href="s02.html#cb191-263" tabindex="-1"></a>      <span class="do">### Run a randomForest model to predict DBH using various crown predictors</span></span>
<span id="cb191-264"><a href="s02.html#cb191-264" tabindex="-1"></a>      cbh_mod <span class="ot">&lt;-</span> randomForest<span class="sc">::</span><span class="fu">randomForest</span>(</span>
<span id="cb191-265"><a href="s02.html#cb191-265" tabindex="-1"></a>        <span class="at">y =</span> training_df<span class="sc">$</span>tree_cbh_m</span>
<span id="cb191-266"><a href="s02.html#cb191-266" tabindex="-1"></a>        , <span class="at">x =</span> training_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(treeID,tree_cbh_m))</span>
<span id="cb191-267"><a href="s02.html#cb191-267" tabindex="-1"></a>        , <span class="at">mtry =</span> optimal_mtry</span>
<span id="cb191-268"><a href="s02.html#cb191-268" tabindex="-1"></a>        , <span class="at">na.action =</span> na.omit</span>
<span id="cb191-269"><a href="s02.html#cb191-269" tabindex="-1"></a>      )</span>
<span id="cb191-270"><a href="s02.html#cb191-270" tabindex="-1"></a></span>
<span id="cb191-271"><a href="s02.html#cb191-271" tabindex="-1"></a>    <span class="co"># # model</span></span>
<span id="cb191-272"><a href="s02.html#cb191-272" tabindex="-1"></a>    <span class="co"># cbh_mod &lt;- stats::lm(</span></span>
<span id="cb191-273"><a href="s02.html#cb191-273" tabindex="-1"></a>    <span class="co">#   formula = tree_cbh_m ~ tree_xxx + tree_yyy + tree_xxx:tree_yyy + tree_height_m + crown_area_zzz</span></span>
<span id="cb191-274"><a href="s02.html#cb191-274" tabindex="-1"></a>    <span class="co">#   , data = training_df</span></span>
<span id="cb191-275"><a href="s02.html#cb191-275" tabindex="-1"></a>    <span class="co"># )</span></span>
<span id="cb191-276"><a href="s02.html#cb191-276" tabindex="-1"></a></span>
<span id="cb191-277"><a href="s02.html#cb191-277" tabindex="-1"></a>    <span class="co"># predict missing</span></span>
<span id="cb191-278"><a href="s02.html#cb191-278" tabindex="-1"></a>    predicted_cbh_temp <span class="ot">&lt;-</span> <span class="fu">predict</span>(</span>
<span id="cb191-279"><a href="s02.html#cb191-279" tabindex="-1"></a>        cbh_mod</span>
<span id="cb191-280"><a href="s02.html#cb191-280" tabindex="-1"></a>        , predict_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(treeID,tree_cbh_m))</span>
<span id="cb191-281"><a href="s02.html#cb191-281" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb191-282"><a href="s02.html#cb191-282" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb191-283"><a href="s02.html#cb191-283" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">pull</span>(<span class="dv">1</span>)</span>
<span id="cb191-284"><a href="s02.html#cb191-284" tabindex="-1"></a></span>
<span id="cb191-285"><a href="s02.html#cb191-285" tabindex="-1"></a>    <span class="do">## combine predicted data with training data for full data set</span></span>
<span id="cb191-286"><a href="s02.html#cb191-286" tabindex="-1"></a>    trees_poly <span class="ot">&lt;-</span> trees_poly <span class="sc">%&gt;%</span></span>
<span id="cb191-287"><a href="s02.html#cb191-287" tabindex="-1"></a>      <span class="co"># join with training data estimates</span></span>
<span id="cb191-288"><a href="s02.html#cb191-288" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb191-289"><a href="s02.html#cb191-289" tabindex="-1"></a>        cbh_df <span class="sc">%&gt;%</span></span>
<span id="cb191-290"><a href="s02.html#cb191-290" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(is_training_cbh<span class="sc">==</span>T) <span class="sc">%&gt;%</span></span>
<span id="cb191-291"><a href="s02.html#cb191-291" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(treeID, tree_cbh_m, is_training_cbh)</span>
<span id="cb191-292"><a href="s02.html#cb191-292" tabindex="-1"></a>        , <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span></span>
<span id="cb191-293"><a href="s02.html#cb191-293" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb191-294"><a href="s02.html#cb191-294" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">is_training_cbh =</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(is_training_cbh, F)) <span class="sc">%&gt;%</span></span>
<span id="cb191-295"><a href="s02.html#cb191-295" tabindex="-1"></a>      <span class="co"># join with predicted data estimates</span></span>
<span id="cb191-296"><a href="s02.html#cb191-296" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb191-297"><a href="s02.html#cb191-297" tabindex="-1"></a>        predict_df <span class="sc">%&gt;%</span></span>
<span id="cb191-298"><a href="s02.html#cb191-298" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb191-299"><a href="s02.html#cb191-299" tabindex="-1"></a>            <span class="at">predicted_cbh =</span> predicted_cbh_temp</span>
<span id="cb191-300"><a href="s02.html#cb191-300" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span></span>
<span id="cb191-301"><a href="s02.html#cb191-301" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(treeID, predicted_cbh)</span>
<span id="cb191-302"><a href="s02.html#cb191-302" tabindex="-1"></a>        , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(<span class="st">&quot;treeID&quot;</span>)</span>
<span id="cb191-303"><a href="s02.html#cb191-303" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb191-304"><a href="s02.html#cb191-304" tabindex="-1"></a>      <span class="co"># clean up data</span></span>
<span id="cb191-305"><a href="s02.html#cb191-305" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb191-306"><a href="s02.html#cb191-306" tabindex="-1"></a>        <span class="at">tree_cbh_m =</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(tree_cbh_m, predicted_cbh)</span>
<span id="cb191-307"><a href="s02.html#cb191-307" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb191-308"><a href="s02.html#cb191-308" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>predicted_cbh)</span>
<span id="cb191-309"><a href="s02.html#cb191-309" tabindex="-1"></a></span>
<span id="cb191-310"><a href="s02.html#cb191-310" tabindex="-1"></a>    <span class="do">## prevent the CBH from being &gt; the tree height</span></span>
<span id="cb191-311"><a href="s02.html#cb191-311" tabindex="-1"></a>      <span class="co"># find the 95th percentile of height-cbh ratio</span></span>
<span id="cb191-312"><a href="s02.html#cb191-312" tabindex="-1"></a>      max_ratio <span class="ot">&lt;-</span> cbh_df <span class="sc">%&gt;%</span></span>
<span id="cb191-313"><a href="s02.html#cb191-313" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb191-314"><a href="s02.html#cb191-314" tabindex="-1"></a>          is_training_cbh<span class="sc">==</span>T</span>
<span id="cb191-315"><a href="s02.html#cb191-315" tabindex="-1"></a>          <span class="sc">&amp;</span> tree_cbh_m <span class="sc">&lt;</span> tree_height_m</span>
<span id="cb191-316"><a href="s02.html#cb191-316" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb191-317"><a href="s02.html#cb191-317" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">ratio =</span> tree_cbh_m<span class="sc">/</span>tree_height_m) <span class="sc">%&gt;%</span></span>
<span id="cb191-318"><a href="s02.html#cb191-318" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">pull</span>(ratio) <span class="sc">%&gt;%</span></span>
<span id="cb191-319"><a href="s02.html#cb191-319" tabindex="-1"></a>        stats<span class="sc">::</span><span class="fu">quantile</span>(<span class="at">probs =</span> <span class="fl">0.95</span>)</span>
<span id="cb191-320"><a href="s02.html#cb191-320" tabindex="-1"></a>      <span class="co"># update values</span></span>
<span id="cb191-321"><a href="s02.html#cb191-321" tabindex="-1"></a>      trees_poly <span class="ot">&lt;-</span> trees_poly <span class="sc">%&gt;%</span></span>
<span id="cb191-322"><a href="s02.html#cb191-322" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb191-323"><a href="s02.html#cb191-323" tabindex="-1"></a>          <span class="co"># update training data where tree_cbh_m &gt; tree_height_m</span></span>
<span id="cb191-324"><a href="s02.html#cb191-324" tabindex="-1"></a>          <span class="at">is_training_cbh =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb191-325"><a href="s02.html#cb191-325" tabindex="-1"></a>            is_training_cbh<span class="sc">==</span>T <span class="sc">&amp;</span> tree_cbh_m <span class="sc">&gt;=</span> tree_height_m <span class="sc">~</span> <span class="cn">FALSE</span></span>
<span id="cb191-326"><a href="s02.html#cb191-326" tabindex="-1"></a>            , T <span class="sc">~</span> is_training_cbh</span>
<span id="cb191-327"><a href="s02.html#cb191-327" tabindex="-1"></a>          )</span>
<span id="cb191-328"><a href="s02.html#cb191-328" tabindex="-1"></a>          <span class="co"># update tree_cbh_m</span></span>
<span id="cb191-329"><a href="s02.html#cb191-329" tabindex="-1"></a>          , <span class="at">tree_cbh_m =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb191-330"><a href="s02.html#cb191-330" tabindex="-1"></a>            is_training_cbh<span class="sc">==</span>F <span class="sc">&amp;</span> tree_cbh_m<span class="sc">/</span>tree_height_m <span class="sc">&gt;</span> max_ratio <span class="sc">~</span> max_ratio<span class="sc">*</span>tree_height_m</span>
<span id="cb191-331"><a href="s02.html#cb191-331" tabindex="-1"></a>            , T <span class="sc">~</span> tree_cbh_m</span>
<span id="cb191-332"><a href="s02.html#cb191-332" tabindex="-1"></a>          )</span>
<span id="cb191-333"><a href="s02.html#cb191-333" tabindex="-1"></a>        )</span>
<span id="cb191-334"><a href="s02.html#cb191-334" tabindex="-1"></a></span>
<span id="cb191-335"><a href="s02.html#cb191-335" tabindex="-1"></a>  }<span class="cf">else</span> <span class="cf">if</span>(estimate_missing_cbh<span class="sc">==</span>T){</span>
<span id="cb191-336"><a href="s02.html#cb191-336" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">max</span>(<span class="fu">grepl</span>(<span class="st">&quot;tree_height_m&quot;</span>, f))<span class="sc">==</span><span class="dv">0</span>){</span>
<span id="cb191-337"><a href="s02.html#cb191-337" tabindex="-1"></a>      <span class="fu">message</span>(<span class="fu">paste0</span>(</span>
<span id="cb191-338"><a href="s02.html#cb191-338" tabindex="-1"></a>        <span class="st">&quot;`trees_poly` data must contain `tree_height_m` column to estimate CBH.&quot;</span></span>
<span id="cb191-339"><a href="s02.html#cb191-339" tabindex="-1"></a>        , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">Setting `estimate_missing_cbh=TRUE` requires this data.&quot;</span></span>
<span id="cb191-340"><a href="s02.html#cb191-340" tabindex="-1"></a>        , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">Returning CBH values extracted from cloud only.&quot;</span></span>
<span id="cb191-341"><a href="s02.html#cb191-341" tabindex="-1"></a>      ))</span>
<span id="cb191-342"><a href="s02.html#cb191-342" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb191-343"><a href="s02.html#cb191-343" tabindex="-1"></a>      <span class="fu">message</span>(<span class="fu">paste0</span>(</span>
<span id="cb191-344"><a href="s02.html#cb191-344" tabindex="-1"></a>        <span class="st">&quot;Insufficient data available to estimate missing CBH values.&quot;</span></span>
<span id="cb191-345"><a href="s02.html#cb191-345" tabindex="-1"></a>        , <span class="st">&quot;</span><span class="sc">\n</span><span class="st">Returning CBH values extracted from cloud only.&quot;</span></span>
<span id="cb191-346"><a href="s02.html#cb191-346" tabindex="-1"></a>      ))</span>
<span id="cb191-347"><a href="s02.html#cb191-347" tabindex="-1"></a>    }</span>
<span id="cb191-348"><a href="s02.html#cb191-348" tabindex="-1"></a>    <span class="do">## combine predicted data with training data for full data set</span></span>
<span id="cb191-349"><a href="s02.html#cb191-349" tabindex="-1"></a>    trees_poly <span class="ot">&lt;-</span> trees_poly <span class="sc">%&gt;%</span></span>
<span id="cb191-350"><a href="s02.html#cb191-350" tabindex="-1"></a>      <span class="co"># join with training data estimates</span></span>
<span id="cb191-351"><a href="s02.html#cb191-351" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb191-352"><a href="s02.html#cb191-352" tabindex="-1"></a>        cbh_df <span class="sc">%&gt;%</span></span>
<span id="cb191-353"><a href="s02.html#cb191-353" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(is_training_cbh<span class="sc">==</span>T) <span class="sc">%&gt;%</span></span>
<span id="cb191-354"><a href="s02.html#cb191-354" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(treeID, tree_cbh_m, is_training_cbh)</span>
<span id="cb191-355"><a href="s02.html#cb191-355" tabindex="-1"></a>        , <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span></span>
<span id="cb191-356"><a href="s02.html#cb191-356" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb191-357"><a href="s02.html#cb191-357" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">is_training_cbh =</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(is_training_cbh, F))</span>
<span id="cb191-358"><a href="s02.html#cb191-358" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb191-359"><a href="s02.html#cb191-359" tabindex="-1"></a>    <span class="do">## combine predicted data with training data for full data set</span></span>
<span id="cb191-360"><a href="s02.html#cb191-360" tabindex="-1"></a>    trees_poly <span class="ot">&lt;-</span> trees_poly <span class="sc">%&gt;%</span></span>
<span id="cb191-361"><a href="s02.html#cb191-361" tabindex="-1"></a>      <span class="co"># join with training data estimates</span></span>
<span id="cb191-362"><a href="s02.html#cb191-362" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb191-363"><a href="s02.html#cb191-363" tabindex="-1"></a>        cbh_df <span class="sc">%&gt;%</span></span>
<span id="cb191-364"><a href="s02.html#cb191-364" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(is_training_cbh<span class="sc">==</span>T) <span class="sc">%&gt;%</span></span>
<span id="cb191-365"><a href="s02.html#cb191-365" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(treeID, tree_cbh_m, is_training_cbh)</span>
<span id="cb191-366"><a href="s02.html#cb191-366" tabindex="-1"></a>        , <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span></span>
<span id="cb191-367"><a href="s02.html#cb191-367" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb191-368"><a href="s02.html#cb191-368" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">is_training_cbh =</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(is_training_cbh, F))</span>
<span id="cb191-369"><a href="s02.html#cb191-369" tabindex="-1"></a>  }</span>
<span id="cb191-370"><a href="s02.html#cb191-370" tabindex="-1"></a>  <span class="co"># return</span></span>
<span id="cb191-371"><a href="s02.html#cb191-371" tabindex="-1"></a>  <span class="fu">return</span>(trees_poly)</span>
<span id="cb191-372"><a href="s02.html#cb191-372" tabindex="-1"></a>  </span>
<span id="cb191-373"><a href="s02.html#cb191-373" tabindex="-1"></a>  <span class="co"># return(list(</span></span>
<span id="cb191-374"><a href="s02.html#cb191-374" tabindex="-1"></a>  <span class="co">#   trees_poly = trees_poly</span></span>
<span id="cb191-375"><a href="s02.html#cb191-375" tabindex="-1"></a>  <span class="co">#   , cbh_mod = cbh_mod</span></span>
<span id="cb191-376"><a href="s02.html#cb191-376" tabindex="-1"></a>  <span class="co"># ))</span></span>
<span id="cb191-377"><a href="s02.html#cb191-377" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="test_l" class="section level2 hasAnchor" number="3.4">
<h2><span class="header-section-number">3.4</span> Test CBH process - lidar<a href="s02.html#test_l" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Test it and set the parameters based on recommendations from the literature (alternatively, we could keep the default parameter settings)</p>
<p>With respect to the the <code>voxel_grain_size_m</code> parameter (see <code>grain.size</code> in <code>leafR::lad.voxels()</code>):</p>
<blockquote>
<p>In general, the LAD and LAI estimates tended to stabilize with an increasing grain size and increasing ALS pulse density. At small grain sizes of 1 m, 2 m, and 5 m, absolute LAD profiles became stable at respective pulse densities of 15, 15, and 10 pulses per m<sup>2</sup>…the lower accuracy particularly of the LAD profile estimation at a coarse grain size or at low pulse densities may be unacceptable for some applications, particularly in models and methods that rely on the fine scale vertical and horizontal heterogeneity of the canopy structure to make ecological inferences. Examples include the estimation of timber stock or demographic structure or light interception and absorption…For these applications our results suggest that pulse densities of 20 pulses per m<sup>2</sup> or greater and grain sizes between 2 and 5 m, which maximize accuracy and stability, should be utilized. (<a href="https://scholar.google.com/scholar?cluster=5085674356305592014&amp;hl=en&amp;as_sdt=0,6">de Almeida et al., 2019</a>, p. 9-10)</p>
</blockquote>
<p>…however the documentation of <code>leafR::lad.voxels()</code> recommends “1 meter for lad profiles”</p>
<p>Regarding the <code>min_fuel_layer_ht_m</code> parameter (see <code>min_height</code> in <code>LadderFuelsR::get_gaps_fbhs()</code>):</p>
<blockquote>
<p>The LAD strata estimated from both ALS and ground lidar were limited to pulse returns above one meter from the ground. This avoids ground-return interference in the ALS data and is also imposed by the ground lidar sensor height. (<a href="https://scholar.google.com/scholar?cluster=5085674356305592014&amp;hl=en&amp;as_sdt=0,6">de Almeida et al., 2019</a>, p. 6)</p>
</blockquote>
<p>Finally, for the <code>frst_layer_min_ht_m</code> parameter (see <code>hdepth1_height</code> in <code>LadderFuelsR::get_cbh_metrics()</code>):</p>
<blockquote>
<p>In the case of maximum LAD (%), the output also gives the CBH from the second fuel layer when the first one has the maximum LAD (%) but its depth is smaller than the value indicated in the parameter “hdepth1_height” (default 2 m). (<a href="https://doi.org/10.1111/2041-210X.14427">Viedma et al. 2024</a>, p. 8)</p>
</blockquote>
<p>and from the package:</p>
<blockquote>
<p>If the first fuel layer has the maximum LAD and its depth is greater than the indicated value, then this fuel layer is considered as the CBH of the tree. On the contrary, if its depth is &lt;= the value, the CBH with maximum LAD will be the second fuel layer, although it has not the maximum LAD.</p>
</blockquote>
<p>We’ll leave all of the other values at their default</p>
<div class="sourceCode" id="cb192"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb192-1"><a href="s02.html#cb192-1" tabindex="-1"></a>trees_cbh_ans <span class="ot">&lt;-</span> cloud2trees<span class="sc">::</span><span class="fu">trees_cbh</span>(</span>
<span id="cb192-2"><a href="s02.html#cb192-2" tabindex="-1"></a>  <span class="at">trees_poly =</span> cloud2trees_ans<span class="sc">$</span>crowns_sf</span>
<span id="cb192-3"><a href="s02.html#cb192-3" tabindex="-1"></a>  , <span class="at">norm_las =</span> norm_las_dir <span class="co"># pull this from create_project_structure.R</span></span>
<span id="cb192-4"><a href="s02.html#cb192-4" tabindex="-1"></a>  , <span class="at">tree_sample_prop =</span> .<span class="dv">5</span></span>
<span id="cb192-5"><a href="s02.html#cb192-5" tabindex="-1"></a>  , <span class="at">estimate_missing_cbh =</span> T</span>
<span id="cb192-6"><a href="s02.html#cb192-6" tabindex="-1"></a>  , <span class="at">which_cbh =</span> <span class="st">&quot;lowest&quot;</span></span>
<span id="cb192-7"><a href="s02.html#cb192-7" tabindex="-1"></a>  , <span class="at">min_vhp_n =</span> <span class="dv">4</span> <span class="co"># = 2.5m with min_fuel_layer_ht_m=1 and dist_btwn_bins_m = 0.5</span></span>
<span id="cb192-8"><a href="s02.html#cb192-8" tabindex="-1"></a>  , <span class="at">min_fuel_layer_ht_m =</span> <span class="dv">1</span> <span class="co"># default = 1.5</span></span>
<span id="cb192-9"><a href="s02.html#cb192-9" tabindex="-1"></a>  , <span class="at">dist_btwn_bins_m =</span> <span class="fl">0.5</span> <span class="co"># default = 1</span></span>
<span id="cb192-10"><a href="s02.html#cb192-10" tabindex="-1"></a>  , <span class="at">num_jump_steps =</span> <span class="fl">0.5</span> <span class="co"># default = 1</span></span>
<span id="cb192-11"><a href="s02.html#cb192-11" tabindex="-1"></a>  , <span class="at">frst_layer_min_ht_m =</span> <span class="fl">0.5</span> <span class="co"># default = 2.5</span></span>
<span id="cb192-12"><a href="s02.html#cb192-12" tabindex="-1"></a>)</span></code></pre></div>
<p>what?</p>
<div class="sourceCode" id="cb193"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb193-1"><a href="s02.html#cb193-1" tabindex="-1"></a>trees_cbh_ans <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 107
## Columns: 22
## $ treeID                    &lt;chr&gt; &quot;1_453532.6_4458594.6&quot;, &quot;2_453544.6_4458594.…
## $ tree_height_m             &lt;dbl&gt; 3.185, 12.866, 11.826, 4.287, 8.980, 7.009, …
## $ tree_x                    &lt;dbl&gt; 453532.6, 453544.6, 453542.6, 453547.4, 4535…
## $ tree_y                    &lt;dbl&gt; 4458595, 4458595, 4458594, 4458593, 4458592,…
## $ crown_area_m2             &lt;dbl&gt; 0.8750, 10.0000, 11.0625, 0.5625, 5.1875, 1.…
## $ geometry                  &lt;GEOMETRY [m]&gt; POLYGON ((453532.5 4458595,..., POL…
## $ fia_est_dbh_cm            &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ fia_est_dbh_cm_lower      &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ fia_est_dbh_cm_upper      &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ dbh_cm                    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ is_training_data          &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ dbh_m                     &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ radius_m                  &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ basal_area_m2             &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ basal_area_ft2            &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ ptcld_extracted_dbh_cm    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ ptcld_predicted_dbh_cm    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ comp_trees_per_ha         &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ comp_relative_tree_height &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ comp_dist_to_nearest_m    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ tree_cbh_m                &lt;dbl&gt; 2.438955, 4.011466, 3.822230, 3.282826, 3.95…
## $ is_training_cbh           &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, TRUE, FAL…</code></pre>
<p>let’s view the height versus CBH relationship by training data</p>
<div class="sourceCode" id="cb195"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb195-1"><a href="s02.html#cb195-1" tabindex="-1"></a>trees_cbh_ans <span class="sc">%&gt;%</span> </span>
<span id="cb195-2"><a href="s02.html#cb195-2" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> tree_height_m, <span class="at">y =</span> tree_cbh_m, <span class="at">color =</span> is_training_cbh)) <span class="sc">+</span></span>
<span id="cb195-3"><a href="s02.html#cb195-3" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb195-4"><a href="s02.html#cb195-4" tabindex="-1"></a>  harrypotter<span class="sc">::</span><span class="fu">scale_color_hp_d</span>(<span class="st">&quot;ronweasley&quot;</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb195-5"><a href="s02.html#cb195-5" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="dv">12</span>)) <span class="sc">+</span></span>
<span id="cb195-6"><a href="s02.html#cb195-6" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="dv">12</span>)) <span class="sc">+</span></span>
<span id="cb195-7"><a href="s02.html#cb195-7" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">&quot;CBH (m)&quot;</span>, <span class="at">x =</span> <span class="st">&quot;Height (m)&quot;</span>, <span class="at">color =</span> <span class="st">&quot;is training data&quot;</span>) <span class="sc">+</span></span>
<span id="cb195-8"><a href="s02.html#cb195-8" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb195-9"><a href="s02.html#cb195-9" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>)</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-126-1.png" width="1008" /></p>
<p>check out the CBH spatially</p>
<div class="sourceCode" id="cb196"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb196-1"><a href="s02.html#cb196-1" tabindex="-1"></a>trees_cbh_ans <span class="sc">%&gt;%</span> </span>
<span id="cb196-2"><a href="s02.html#cb196-2" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">color =</span> is_training_cbh, <span class="at">fill =</span> tree_cbh_m)) <span class="sc">+</span></span>
<span id="cb196-3"><a href="s02.html#cb196-3" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">lwd =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb196-4"><a href="s02.html#cb196-4" tabindex="-1"></a>  harrypotter<span class="sc">::</span><span class="fu">scale_color_hp_d</span>(<span class="st">&quot;ronweasley&quot;</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb196-5"><a href="s02.html#cb196-5" tabindex="-1"></a>  harrypotter<span class="sc">::</span><span class="fu">scale_fill_hp</span>(<span class="st">&quot;always&quot;</span>) <span class="sc">+</span></span>
<span id="cb196-6"><a href="s02.html#cb196-6" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">&quot;CBH (m)&quot;</span>, <span class="at">color =</span> <span class="st">&quot;is training data&quot;</span>) <span class="sc">+</span></span>
<span id="cb196-7"><a href="s02.html#cb196-7" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb196-8"><a href="s02.html#cb196-8" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>, <span class="at">axis.text =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb196-9"><a href="s02.html#cb196-9" tabindex="-1"></a>  <span class="fu">guides</span>(</span>
<span id="cb196-10"><a href="s02.html#cb196-10" tabindex="-1"></a>    <span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">order =</span> <span class="dv">1</span>, <span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">lwd =</span> <span class="dv">3</span>, <span class="at">fill =</span> <span class="cn">NA</span>))</span>
<span id="cb196-11"><a href="s02.html#cb196-11" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-127-1.png" width="1008" /></p>
<div id="comparison-to-ladderfuelsr-defaults" class="section level3 hasAnchor" number="3.4.1">
<h3><span class="header-section-number">3.4.1</span> Comparison to <code>LadderFuelsR</code> defaults<a href="s02.html#comparison-to-ladderfuelsr-defaults" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We just calculated the estimates of CBH using custom parameter values for the <code>LadderFuelsR</code> process. Let’s compare these custom values to values obtained if we just use the defaults from the <code>LadderFuelsR</code> package.</p>
<div class="sourceCode" id="cb197"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb197-1"><a href="s02.html#cb197-1" tabindex="-1"></a><span class="co"># compare to default values from LadderFuelsR</span></span>
<span id="cb197-2"><a href="s02.html#cb197-2" tabindex="-1"></a>trees_cbh_ans2 <span class="ot">&lt;-</span> cloud2trees<span class="sc">::</span><span class="fu">trees_cbh</span>(</span>
<span id="cb197-3"><a href="s02.html#cb197-3" tabindex="-1"></a>  <span class="at">trees_poly =</span> cloud2trees_ans<span class="sc">$</span>crowns_sf</span>
<span id="cb197-4"><a href="s02.html#cb197-4" tabindex="-1"></a>  , <span class="at">norm_las =</span> norm_las_dir</span>
<span id="cb197-5"><a href="s02.html#cb197-5" tabindex="-1"></a>  , <span class="at">tree_sample_prop =</span> .<span class="dv">5</span></span>
<span id="cb197-6"><a href="s02.html#cb197-6" tabindex="-1"></a>  , <span class="at">estimate_missing_cbh =</span> T</span>
<span id="cb197-7"><a href="s02.html#cb197-7" tabindex="-1"></a>  , <span class="at">which_cbh =</span> <span class="st">&quot;lowest&quot;</span></span>
<span id="cb197-8"><a href="s02.html#cb197-8" tabindex="-1"></a>  <span class="co"># we can leave all other parameters at defaults</span></span>
<span id="cb197-9"><a href="s02.html#cb197-9" tabindex="-1"></a>)</span>
<span id="cb197-10"><a href="s02.html#cb197-10" tabindex="-1"></a><span class="co"># join to initial data</span></span>
<span id="cb197-11"><a href="s02.html#cb197-11" tabindex="-1"></a>trees_cbh_ans <span class="ot">&lt;-</span> trees_cbh_ans <span class="sc">%&gt;%</span> </span>
<span id="cb197-12"><a href="s02.html#cb197-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb197-13"><a href="s02.html#cb197-13" tabindex="-1"></a>    trees_cbh_ans2 <span class="sc">%&gt;%</span> </span>
<span id="cb197-14"><a href="s02.html#cb197-14" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb197-15"><a href="s02.html#cb197-15" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb197-16"><a href="s02.html#cb197-16" tabindex="-1"></a>        treeID,is_training_cbh,tree_cbh_m</span>
<span id="cb197-17"><a href="s02.html#cb197-17" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb197-18"><a href="s02.html#cb197-18" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">rename</span>(</span>
<span id="cb197-19"><a href="s02.html#cb197-19" tabindex="-1"></a>        <span class="at">def_is_training_cbh =</span> is_training_cbh</span>
<span id="cb197-20"><a href="s02.html#cb197-20" tabindex="-1"></a>        , <span class="at">def_tree_cbh_m =</span> tree_cbh_m</span>
<span id="cb197-21"><a href="s02.html#cb197-21" tabindex="-1"></a>      )</span>
<span id="cb197-22"><a href="s02.html#cb197-22" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span></span>
<span id="cb197-23"><a href="s02.html#cb197-23" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb197-24"><a href="s02.html#cb197-24" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb197-25"><a href="s02.html#cb197-25" tabindex="-1"></a>    <span class="at">pct_diff_cbh =</span> (tree_cbh_m<span class="sc">-</span>def_tree_cbh_m)<span class="sc">/</span>def_tree_cbh_m</span>
<span id="cb197-26"><a href="s02.html#cb197-26" tabindex="-1"></a>  )</span></code></pre></div>
<p>what does the distribution of the percent difference look like (negative values = custom CBH &lt; default CBH and vice versa)?</p>
<div class="sourceCode" id="cb198"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb198-1"><a href="s02.html#cb198-1" tabindex="-1"></a>trees_cbh_ans <span class="sc">%&gt;%</span> </span>
<span id="cb198-2"><a href="s02.html#cb198-2" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb198-3"><a href="s02.html#cb198-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_cbh_m&quot;</span>), pct_diff_cbh) <span class="sc">%&gt;%</span> </span>
<span id="cb198-4"><a href="s02.html#cb198-4" tabindex="-1"></a>  <span class="fu">summary</span>()</span></code></pre></div>
<pre><code>##    tree_cbh_m    def_tree_cbh_m   pct_diff_cbh     
##  Min.   :2.117   Min.   :1.817   Min.   :-0.22181  
##  1st Qu.:3.500   1st Qu.:3.159   1st Qu.: 0.02369  
##  Median :3.647   Median :3.314   Median : 0.12396  
##  Mean   :3.786   Mean   :3.289   Mean   : 0.15985  
##  3rd Qu.:4.113   3rd Qu.:3.500   3rd Qu.: 0.16675  
##  Max.   :9.500   Max.   :5.500   Max.   : 1.87788</code></pre>
<p>so maybe the CBH estimates are sensitive to the parameterization of the <code>LadderFuelsR</code> process…</p>
<div class="sourceCode" id="cb200"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb200-1"><a href="s02.html#cb200-1" tabindex="-1"></a>trees_cbh_ans <span class="sc">%&gt;%</span> </span>
<span id="cb200-2"><a href="s02.html#cb200-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb200-3"><a href="s02.html#cb200-3" tabindex="-1"></a>    <span class="at">cbh_bin =</span> ggplot2<span class="sc">::</span><span class="fu">cut_width</span>(pct_diff_cbh, <span class="at">width =</span> <span class="fl">0.1</span>, <span class="at">center =</span> <span class="fl">0.05</span>)</span>
<span id="cb200-4"><a href="s02.html#cb200-4" tabindex="-1"></a>    , <span class="at">is_ltz =</span> pct_diff_cbh<span class="sc">&lt;=</span><span class="dv">0</span></span>
<span id="cb200-5"><a href="s02.html#cb200-5" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb200-6"><a href="s02.html#cb200-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(cbh_bin, is_ltz) <span class="sc">%&gt;%</span> </span>
<span id="cb200-7"><a href="s02.html#cb200-7" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb200-8"><a href="s02.html#cb200-8" tabindex="-1"></a>    <span class="at">x =</span> cbh_bin, <span class="at">y =</span> n, <span class="at">fill =</span> is_ltz</span>
<span id="cb200-9"><a href="s02.html#cb200-9" tabindex="-1"></a>  )) <span class="sc">+</span></span>
<span id="cb200-10"><a href="s02.html#cb200-10" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">width =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb200-11"><a href="s02.html#cb200-11" tabindex="-1"></a>  harrypotter<span class="sc">::</span><span class="fu">scale_fill_hp_d</span>(<span class="st">&quot;slytherin&quot;</span>, <span class="at">begin =</span> <span class="fl">0.2</span>, <span class="at">end =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb200-12"><a href="s02.html#cb200-12" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">&quot;# Trees&quot;</span>, <span class="at">x =</span> <span class="st">&quot;CBH % diff&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;custom CBH &lt; default&quot;</span>) <span class="sc">+</span></span>
<span id="cb200-13"><a href="s02.html#cb200-13" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb200-14"><a href="s02.html#cb200-14" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>, <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="dv">0</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-130-1.png" width="1008" /></p>
<p>look at how the CBH estimates changed</p>
<div class="sourceCode" id="cb201"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb201-1"><a href="s02.html#cb201-1" tabindex="-1"></a>trees_cbh_ans <span class="sc">%&gt;%</span> </span>
<span id="cb201-2"><a href="s02.html#cb201-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb201-3"><a href="s02.html#cb201-3" tabindex="-1"></a>    <span class="at">is_ltz =</span> pct_diff_cbh<span class="sc">&lt;=</span><span class="dv">0</span></span>
<span id="cb201-4"><a href="s02.html#cb201-4" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb201-5"><a href="s02.html#cb201-5" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb201-6"><a href="s02.html#cb201-6" tabindex="-1"></a>    <span class="at">x =</span> def_tree_cbh_m, <span class="at">y =</span> tree_cbh_m, <span class="at">color =</span> is_ltz</span>
<span id="cb201-7"><a href="s02.html#cb201-7" tabindex="-1"></a>  )) <span class="sc">+</span></span>
<span id="cb201-8"><a href="s02.html#cb201-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_abline</span>() <span class="sc">+</span></span>
<span id="cb201-9"><a href="s02.html#cb201-9" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb201-10"><a href="s02.html#cb201-10" tabindex="-1"></a>  harrypotter<span class="sc">::</span><span class="fu">scale_color_hp_d</span>(<span class="st">&quot;slytherin&quot;</span>, <span class="at">begin =</span> <span class="fl">0.2</span>, <span class="at">end =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb201-11"><a href="s02.html#cb201-11" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="cn">NA</span>), <span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="dv">12</span>)) <span class="sc">+</span></span>
<span id="cb201-12"><a href="s02.html#cb201-12" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="cn">NA</span>), <span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="dv">12</span>)) <span class="sc">+</span></span>
<span id="cb201-13"><a href="s02.html#cb201-13" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">&quot;custom CBH (m)&quot;</span>, <span class="at">x =</span> <span class="st">&quot;default CBH (m)&quot;</span>, <span class="at">color =</span> <span class="st">&quot;custom CBH &lt; default&quot;</span>) <span class="sc">+</span></span>
<span id="cb201-14"><a href="s02.html#cb201-14" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb201-15"><a href="s02.html#cb201-15" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>)</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-131-1.png" width="1008" /></p>
<p>one more way to look at how the CBH estimates changed</p>
<div class="sourceCode" id="cb202"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb202-1"><a href="s02.html#cb202-1" tabindex="-1"></a>dta_temp <span class="ot">&lt;-</span> </span>
<span id="cb202-2"><a href="s02.html#cb202-2" tabindex="-1"></a>  trees_cbh_ans <span class="sc">%&gt;%</span> </span>
<span id="cb202-3"><a href="s02.html#cb202-3" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb202-4"><a href="s02.html#cb202-4" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb202-5"><a href="s02.html#cb202-5" tabindex="-1"></a>      <span class="at">is_ltz =</span> pct_diff_cbh<span class="sc">&lt;=</span><span class="dv">0</span></span>
<span id="cb202-6"><a href="s02.html#cb202-6" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb202-7"><a href="s02.html#cb202-7" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(treeID, is_ltz, tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_cbh_m&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb202-8"><a href="s02.html#cb202-8" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(</span>
<span id="cb202-9"><a href="s02.html#cb202-9" tabindex="-1"></a>      <span class="at">cols =</span> tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_cbh_m&quot;</span>)</span>
<span id="cb202-10"><a href="s02.html#cb202-10" tabindex="-1"></a>      , <span class="at">names_to =</span> <span class="st">&quot;cbh_type&quot;</span></span>
<span id="cb202-11"><a href="s02.html#cb202-11" tabindex="-1"></a>      , <span class="at">values_to =</span> <span class="st">&quot;cbh&quot;</span></span>
<span id="cb202-12"><a href="s02.html#cb202-12" tabindex="-1"></a>      , <span class="at">values_drop_na =</span> F</span>
<span id="cb202-13"><a href="s02.html#cb202-13" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb202-14"><a href="s02.html#cb202-14" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb202-15"><a href="s02.html#cb202-15" tabindex="-1"></a>      <span class="at">cbh_type =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb202-16"><a href="s02.html#cb202-16" tabindex="-1"></a>        cbh_type <span class="sc">==</span> <span class="st">&quot;def_tree_cbh_m&quot;</span> <span class="sc">~</span> <span class="st">&quot;default CBH&quot;</span></span>
<span id="cb202-17"><a href="s02.html#cb202-17" tabindex="-1"></a>        , T <span class="sc">~</span> <span class="st">&quot;custom CBH&quot;</span></span>
<span id="cb202-18"><a href="s02.html#cb202-18" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb202-19"><a href="s02.html#cb202-19" tabindex="-1"></a>      <span class="fu">factor</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb202-20"><a href="s02.html#cb202-20" tabindex="-1"></a>      forcats<span class="sc">::</span><span class="fu">fct_rev</span>()</span>
<span id="cb202-21"><a href="s02.html#cb202-21" tabindex="-1"></a>    )</span>
<span id="cb202-22"><a href="s02.html#cb202-22" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb202-23"><a href="s02.html#cb202-23" tabindex="-1"></a>  <span class="fu">ggplot</span>(</span>
<span id="cb202-24"><a href="s02.html#cb202-24" tabindex="-1"></a>    <span class="at">data =</span> dta_temp</span>
<span id="cb202-25"><a href="s02.html#cb202-25" tabindex="-1"></a>    , <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> cbh_type, <span class="at">y =</span> cbh, <span class="at">color =</span> is_ltz, <span class="at">group =</span> treeID)</span>
<span id="cb202-26"><a href="s02.html#cb202-26" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb202-27"><a href="s02.html#cb202-27" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">data =</span> dta_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(is_ltz <span class="sc">==</span> F), <span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb202-28"><a href="s02.html#cb202-28" tabindex="-1"></a>  <span class="co"># ggplot2::geom_point(data = dta_temp %&gt;% dplyr::filter(is_ltz == F)) +</span></span>
<span id="cb202-29"><a href="s02.html#cb202-29" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">data =</span> dta_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(is_ltz <span class="sc">==</span> T), <span class="at">lwd =</span> <span class="fl">1.1</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb202-30"><a href="s02.html#cb202-30" tabindex="-1"></a>  <span class="co"># ggplot2::geom_point(data = dta_temp %&gt;% dplyr::filter(is_ltz == T), alpha = 0.6) +</span></span>
<span id="cb202-31"><a href="s02.html#cb202-31" tabindex="-1"></a>  harrypotter<span class="sc">::</span><span class="fu">scale_color_hp_d</span>(<span class="st">&quot;slytherin&quot;</span>, <span class="at">begin =</span> <span class="fl">0.2</span>, <span class="at">end =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb202-32"><a href="s02.html#cb202-32" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="cn">NA</span>), <span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="dv">12</span>)) <span class="sc">+</span></span>
<span id="cb202-33"><a href="s02.html#cb202-33" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">&quot;CBH (m)&quot;</span>, <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">color =</span> <span class="st">&quot;custom CBH &lt; default&quot;</span>) <span class="sc">+</span></span>
<span id="cb202-34"><a href="s02.html#cb202-34" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb202-35"><a href="s02.html#cb202-35" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-132-1.png" width="1008" /></p>
<p>In selecting parameter levels, Let’s err on the side of a lower CBH for fuel modelling: 1) to be conservative with how “high” we say the CBH is; 2) since it looks like the minimum CBH extracted from lidar data via the <code>LadderFuelsR</code> process is ~1.5 m; 3) and since lower density lidar gets very few returns closer to the ground level due to canopy occlusion.</p>
<p>for completeness, let’s view the height versus CBH relationship by training data using the default parameter values</p>
<div class="sourceCode" id="cb203"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb203-1"><a href="s02.html#cb203-1" tabindex="-1"></a>trees_cbh_ans <span class="sc">%&gt;%</span> </span>
<span id="cb203-2"><a href="s02.html#cb203-2" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> tree_height_m, <span class="at">y =</span> def_tree_cbh_m, <span class="at">color =</span> def_is_training_cbh)) <span class="sc">+</span></span>
<span id="cb203-3"><a href="s02.html#cb203-3" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb203-4"><a href="s02.html#cb203-4" tabindex="-1"></a>  harrypotter<span class="sc">::</span><span class="fu">scale_color_hp_d</span>(<span class="st">&quot;ronweasley&quot;</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb203-5"><a href="s02.html#cb203-5" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="dv">12</span>)) <span class="sc">+</span></span>
<span id="cb203-6"><a href="s02.html#cb203-6" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="dv">12</span>)) <span class="sc">+</span></span>
<span id="cb203-7"><a href="s02.html#cb203-7" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">&quot;CBH (m)&quot;</span>, <span class="at">x =</span> <span class="st">&quot;Height (m)&quot;</span>, <span class="at">color =</span> <span class="st">&quot;is training data&quot;</span>) <span class="sc">+</span></span>
<span id="cb203-8"><a href="s02.html#cb203-8" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb203-9"><a href="s02.html#cb203-9" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>)</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-133-1.png" width="1008" /></p>
</div>
<div id="test-cbh-based-on-parameterization-of-ladderfuelsr" class="section level3 hasAnchor" number="3.4.2">
<h3><span class="header-section-number">3.4.2</span> test CBH based on parameterization of <code id="test_l2">LadderFuelsR</code><a href="s02.html#test-cbh-based-on-parameterization-of-ladderfuelsr" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>let’s build a test for different levels of the <code>min_fuel_layer_ht_m</code> and <code>dist_btwn_bins_m</code> parameters</p>
<p>we’ll increase the sample proportion of data to attempt to extract a CBH from the point cloud for this exercise (<code>tree_sample_prop = 0.5</code> in <code>trees_cbh()</code>) for this exercise. we’ll also hold the minimum number of vertical height profile records constant (<code>min_vhp_n = 2</code> in <code>trees_cbh()</code>).</p>
<p>we’ll also put in a timer to see how long this generally takes.</p>
<div class="sourceCode" id="cb204"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb204-1"><a href="s02.html#cb204-1" tabindex="-1"></a><span class="co"># build a data frame of potential values</span></span>
<span id="cb204-2"><a href="s02.html#cb204-2" tabindex="-1"></a>dta_temp <span class="ot">&lt;-</span> tidyr<span class="sc">::</span><span class="fu">crossing</span>(</span>
<span id="cb204-3"><a href="s02.html#cb204-3" tabindex="-1"></a>    <span class="at">min_fuel_layer_ht_m =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">2.5</span>, <span class="at">by =</span> <span class="fl">0.5</span>) <span class="co"># default = 1.5</span></span>
<span id="cb204-4"><a href="s02.html#cb204-4" tabindex="-1"></a>    , <span class="at">dist_btwn_bins_m =</span> <span class="fu">seq</span>(<span class="fl">0.5</span>, <span class="fl">2.5</span>, <span class="at">by =</span> <span class="fl">0.5</span>) <span class="co"># default = 1</span></span>
<span id="cb204-5"><a href="s02.html#cb204-5" tabindex="-1"></a>  ) </span>
<span id="cb204-6"><a href="s02.html#cb204-6" tabindex="-1"></a>  <span class="co"># # something in LadderFuelsR is making the program crash if:</span></span>
<span id="cb204-7"><a href="s02.html#cb204-7" tabindex="-1"></a>  <span class="co">#   # 1) dist_btwn_bins_m - min_fuel_layer_ht_m &gt;= 1.5</span></span>
<span id="cb204-8"><a href="s02.html#cb204-8" tabindex="-1"></a>  <span class="co">#   # 2) min_fuel_layer_ht_m = 1 &amp; dist_btwn_bins_m = 1</span></span>
<span id="cb204-9"><a href="s02.html#cb204-9" tabindex="-1"></a>  <span class="co">#   # 2) min_fuel_layer_ht_m = 1 &amp; dist_btwn_bins_m = 2</span></span>
<span id="cb204-10"><a href="s02.html#cb204-10" tabindex="-1"></a>  <span class="co">#   # 2) min_fuel_layer_ht_m = 1.5 &amp; dist_btwn_bins_m = 2</span></span>
<span id="cb204-11"><a href="s02.html#cb204-11" tabindex="-1"></a>  <span class="co"># dplyr::filter(</span></span>
<span id="cb204-12"><a href="s02.html#cb204-12" tabindex="-1"></a>  <span class="co">#   dist_btwn_bins_m - min_fuel_layer_ht_m &lt; 1.5</span></span>
<span id="cb204-13"><a href="s02.html#cb204-13" tabindex="-1"></a>  <span class="co">#   &amp; (min_fuel_layer_ht_m != 1 &amp; dist_btwn_bins_m != 1)</span></span>
<span id="cb204-14"><a href="s02.html#cb204-14" tabindex="-1"></a>  <span class="co">#   &amp; (min_fuel_layer_ht_m != 1 &amp; dist_btwn_bins_m != 2)</span></span>
<span id="cb204-15"><a href="s02.html#cb204-15" tabindex="-1"></a>  <span class="co"># )</span></span>
<span id="cb204-16"><a href="s02.html#cb204-16" tabindex="-1"></a><span class="co"># tester function</span></span>
<span id="cb204-17"><a href="s02.html#cb204-17" tabindex="-1"></a>test_cbh_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(i, <span class="at">my_min_vhp_n =</span> <span class="dv">4</span>, <span class="at">my_tree_sample_prop =</span> <span class="dv">1</span>) {</span>
<span id="cb204-18"><a href="s02.html#cb204-18" tabindex="-1"></a>  <span class="co"># parameters</span></span>
<span id="cb204-19"><a href="s02.html#cb204-19" tabindex="-1"></a>  my_min_fuel_layer_ht_m <span class="ot">&lt;-</span> dta_temp <span class="sc">%&gt;%</span> </span>
<span id="cb204-20"><a href="s02.html#cb204-20" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(dplyr<span class="sc">::</span><span class="fu">row_number</span>()<span class="sc">==</span>i) <span class="sc">%&gt;%</span> </span>
<span id="cb204-21"><a href="s02.html#cb204-21" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(min_fuel_layer_ht_m)</span>
<span id="cb204-22"><a href="s02.html#cb204-22" tabindex="-1"></a>  my_dist_btwn_bins_m <span class="ot">&lt;-</span> dta_temp <span class="sc">%&gt;%</span> </span>
<span id="cb204-23"><a href="s02.html#cb204-23" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(dplyr<span class="sc">::</span><span class="fu">row_number</span>()<span class="sc">==</span>i) <span class="sc">%&gt;%</span> </span>
<span id="cb204-24"><a href="s02.html#cb204-24" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(dist_btwn_bins_m)</span>
<span id="cb204-25"><a href="s02.html#cb204-25" tabindex="-1"></a>  <span class="co"># run it</span></span>
<span id="cb204-26"><a href="s02.html#cb204-26" tabindex="-1"></a>  safe_trees_cbh <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">safely</span>(cloud2trees<span class="sc">::</span>trees_cbh)</span>
<span id="cb204-27"><a href="s02.html#cb204-27" tabindex="-1"></a>  st <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb204-28"><a href="s02.html#cb204-28" tabindex="-1"></a>  trees_cbh_ans <span class="ot">&lt;-</span> <span class="fu">safe_trees_cbh</span>(</span>
<span id="cb204-29"><a href="s02.html#cb204-29" tabindex="-1"></a>    <span class="at">trees_poly =</span> cloud2trees_ans<span class="sc">$</span>crowns_sf</span>
<span id="cb204-30"><a href="s02.html#cb204-30" tabindex="-1"></a>    , <span class="at">norm_las =</span> norm_las_dir</span>
<span id="cb204-31"><a href="s02.html#cb204-31" tabindex="-1"></a>    , <span class="at">tree_sample_prop =</span> my_tree_sample_prop</span>
<span id="cb204-32"><a href="s02.html#cb204-32" tabindex="-1"></a>    , <span class="at">estimate_missing_cbh =</span> T</span>
<span id="cb204-33"><a href="s02.html#cb204-33" tabindex="-1"></a>    , <span class="at">min_vhp_n =</span> my_min_vhp_n</span>
<span id="cb204-34"><a href="s02.html#cb204-34" tabindex="-1"></a>    , <span class="at">which_cbh =</span> <span class="st">&quot;lowest&quot;</span></span>
<span id="cb204-35"><a href="s02.html#cb204-35" tabindex="-1"></a>    <span class="co"># we can leave all other parameters at defaults</span></span>
<span id="cb204-36"><a href="s02.html#cb204-36" tabindex="-1"></a>    , <span class="at">min_fuel_layer_ht_m =</span> my_min_fuel_layer_ht_m <span class="co"># default = 1.5</span></span>
<span id="cb204-37"><a href="s02.html#cb204-37" tabindex="-1"></a>    , <span class="at">dist_btwn_bins_m =</span> my_dist_btwn_bins_m <span class="co"># default = 1</span></span>
<span id="cb204-38"><a href="s02.html#cb204-38" tabindex="-1"></a>  )</span>
<span id="cb204-39"><a href="s02.html#cb204-39" tabindex="-1"></a>  end <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb204-40"><a href="s02.html#cb204-40" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(trees_cbh_ans<span class="sc">$</span>result)){</span>
<span id="cb204-41"><a href="s02.html#cb204-41" tabindex="-1"></a>    <span class="fu">message</span>(<span class="fu">paste</span>(</span>
<span id="cb204-42"><a href="s02.html#cb204-42" tabindex="-1"></a>      <span class="st">&quot;my_min_fuel_layer_ht_m=&quot;</span></span>
<span id="cb204-43"><a href="s02.html#cb204-43" tabindex="-1"></a>      , my_min_fuel_layer_ht_m</span>
<span id="cb204-44"><a href="s02.html#cb204-44" tabindex="-1"></a>      , <span class="st">&quot;; my_dist_btwn_bins_m=&quot;</span></span>
<span id="cb204-45"><a href="s02.html#cb204-45" tabindex="-1"></a>      , my_dist_btwn_bins_m</span>
<span id="cb204-46"><a href="s02.html#cb204-46" tabindex="-1"></a>    ))</span>
<span id="cb204-47"><a href="s02.html#cb204-47" tabindex="-1"></a>    <span class="co"># return</span></span>
<span id="cb204-48"><a href="s02.html#cb204-48" tabindex="-1"></a>    <span class="fu">return</span>(</span>
<span id="cb204-49"><a href="s02.html#cb204-49" tabindex="-1"></a>      trees_cbh_ans<span class="sc">$</span>result <span class="sc">%&gt;%</span> </span>
<span id="cb204-50"><a href="s02.html#cb204-50" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb204-51"><a href="s02.html#cb204-51" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(treeID, tree_height_m, tidyselect<span class="sc">::</span><span class="fu">contains</span>(<span class="st">&quot;cbh&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb204-52"><a href="s02.html#cb204-52" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb204-53"><a href="s02.html#cb204-53" tabindex="-1"></a>          <span class="at">min_fuel_layer_ht_m =</span> my_min_fuel_layer_ht_m</span>
<span id="cb204-54"><a href="s02.html#cb204-54" tabindex="-1"></a>          , <span class="at">dist_btwn_bins_m =</span> my_dist_btwn_bins_m</span>
<span id="cb204-55"><a href="s02.html#cb204-55" tabindex="-1"></a>          , <span class="at">timer_secs =</span> <span class="fu">difftime</span>(end, st, <span class="at">units =</span> <span class="st">&quot;secs&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb204-56"><a href="s02.html#cb204-56" tabindex="-1"></a>        )</span>
<span id="cb204-57"><a href="s02.html#cb204-57" tabindex="-1"></a>    )</span>
<span id="cb204-58"><a href="s02.html#cb204-58" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb204-59"><a href="s02.html#cb204-59" tabindex="-1"></a>    <span class="fu">message</span>(<span class="fu">paste</span>(</span>
<span id="cb204-60"><a href="s02.html#cb204-60" tabindex="-1"></a>      <span class="st">&quot;ERROR: my_min_fuel_layer_ht_m=&quot;</span></span>
<span id="cb204-61"><a href="s02.html#cb204-61" tabindex="-1"></a>      , my_min_fuel_layer_ht_m</span>
<span id="cb204-62"><a href="s02.html#cb204-62" tabindex="-1"></a>      , <span class="st">&quot;; my_dist_btwn_bins_m=&quot;</span></span>
<span id="cb204-63"><a href="s02.html#cb204-63" tabindex="-1"></a>      , my_dist_btwn_bins_m</span>
<span id="cb204-64"><a href="s02.html#cb204-64" tabindex="-1"></a>      <span class="co"># , &quot;\n&quot;</span></span>
<span id="cb204-65"><a href="s02.html#cb204-65" tabindex="-1"></a>      <span class="co"># , trees_cbh_ans$error</span></span>
<span id="cb204-66"><a href="s02.html#cb204-66" tabindex="-1"></a>      <span class="co"># , &quot;\n&quot;</span></span>
<span id="cb204-67"><a href="s02.html#cb204-67" tabindex="-1"></a>    ))</span>
<span id="cb204-68"><a href="s02.html#cb204-68" tabindex="-1"></a>    <span class="fu">message</span>()</span>
<span id="cb204-69"><a href="s02.html#cb204-69" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb204-70"><a href="s02.html#cb204-70" tabindex="-1"></a>  }</span>
<span id="cb204-71"><a href="s02.html#cb204-71" tabindex="-1"></a>}</span>
<span id="cb204-72"><a href="s02.html#cb204-72" tabindex="-1"></a><span class="co"># run it</span></span>
<span id="cb204-73"><a href="s02.html#cb204-73" tabindex="-1"></a>test_cbh_dta <span class="ot">&lt;-</span> </span>
<span id="cb204-74"><a href="s02.html#cb204-74" tabindex="-1"></a>  <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(dta_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb204-75"><a href="s02.html#cb204-75" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(\(x) <span class="fu">test_cbh_fn</span>(x, <span class="at">my_min_vhp_n =</span> <span class="dv">4</span>, <span class="at">my_tree_sample_prop =</span> <span class="fl">0.5</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb204-76"><a href="s02.html#cb204-76" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span></code></pre></div>
<p>which combinations caused errors?</p>
<p><em>Update: in the cloud2trees package I have included error handling so that the function does not return the errors that happen in the LadderfulesR package. Additionally, if no trees return CBH based on the parameters passed to the LadderfulesR package, I attempt update the parameters to settings that have previously been successful for most data sets to get a successful result in the trees_cbh() call.</em></p>
<div class="sourceCode" id="cb205"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb205-1"><a href="s02.html#cb205-1" tabindex="-1"></a><span class="co"># which combinations caused errors?</span></span>
<span id="cb205-2"><a href="s02.html#cb205-2" tabindex="-1"></a>  dta_temp <span class="sc">%&gt;%</span> </span>
<span id="cb205-3"><a href="s02.html#cb205-3" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">anti_join</span>(</span>
<span id="cb205-4"><a href="s02.html#cb205-4" tabindex="-1"></a>      test_cbh_dta</span>
<span id="cb205-5"><a href="s02.html#cb205-5" tabindex="-1"></a>      , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(min_fuel_layer_ht_m, dist_btwn_bins_m)</span>
<span id="cb205-6"><a href="s02.html#cb205-6" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb205-7"><a href="s02.html#cb205-7" tabindex="-1"></a>    kableExtra<span class="sc">::</span><span class="fu">kbl</span>(<span class="at">caption =</span> <span class="st">&quot;lidar: these combintations resulted in ERROR!&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb205-8"><a href="s02.html#cb205-8" tabindex="-1"></a>    kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>()</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-134">Table 3.1: </span>lidar: these combintations resulted in ERROR!
</caption>
<thead>
<tr>
<th style="text-align:right;">
min_fuel_layer_ht_m
</th>
<th style="text-align:right;">
dist_btwn_bins_m
</th>
</tr>
</thead>
<tbody>
<tr>
</tr>
</tbody>
</table>
<p>which combinations resulted in success?</p>
<div class="sourceCode" id="cb206"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb206-1"><a href="s02.html#cb206-1" tabindex="-1"></a><span class="co"># which combinations caused success?</span></span>
<span id="cb206-2"><a href="s02.html#cb206-2" tabindex="-1"></a>dta_temp <span class="sc">%&gt;%</span> </span>
<span id="cb206-3"><a href="s02.html#cb206-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb206-4"><a href="s02.html#cb206-4" tabindex="-1"></a>    test_cbh_dta <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">distinct</span>(min_fuel_layer_ht_m, dist_btwn_bins_m)</span>
<span id="cb206-5"><a href="s02.html#cb206-5" tabindex="-1"></a>    , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(min_fuel_layer_ht_m, dist_btwn_bins_m)</span>
<span id="cb206-6"><a href="s02.html#cb206-6" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb206-7"><a href="s02.html#cb206-7" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(<span class="at">caption =</span> <span class="st">&quot;lidar: these combintations resulted in SUCCESS!&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb206-8"><a href="s02.html#cb206-8" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>()</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-135">Table 3.2: </span>lidar: these combintations resulted in SUCCESS!
</caption>
<thead>
<tr>
<th style="text-align:right;">
min_fuel_layer_ht_m
</th>
<th style="text-align:right;">
dist_btwn_bins_m
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
0.5
</td>
</tr>
<tr>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
1.0
</td>
</tr>
<tr>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
1.5
</td>
</tr>
<tr>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
2.0
</td>
</tr>
<tr>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
2.5
</td>
</tr>
<tr>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0.5
</td>
</tr>
<tr>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
1.0
</td>
</tr>
<tr>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
1.5
</td>
</tr>
<tr>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
2.0
</td>
</tr>
<tr>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
2.5
</td>
</tr>
<tr>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
0.5
</td>
</tr>
<tr>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
1.0
</td>
</tr>
<tr>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
1.5
</td>
</tr>
<tr>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
2.0
</td>
</tr>
<tr>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
2.5
</td>
</tr>
<tr>
<td style="text-align:right;">
1.5
</td>
<td style="text-align:right;">
0.5
</td>
</tr>
<tr>
<td style="text-align:right;">
1.5
</td>
<td style="text-align:right;">
1.0
</td>
</tr>
<tr>
<td style="text-align:right;">
1.5
</td>
<td style="text-align:right;">
1.5
</td>
</tr>
<tr>
<td style="text-align:right;">
1.5
</td>
<td style="text-align:right;">
2.0
</td>
</tr>
<tr>
<td style="text-align:right;">
1.5
</td>
<td style="text-align:right;">
2.5
</td>
</tr>
<tr>
<td style="text-align:right;">
2.0
</td>
<td style="text-align:right;">
0.5
</td>
</tr>
<tr>
<td style="text-align:right;">
2.0
</td>
<td style="text-align:right;">
1.0
</td>
</tr>
<tr>
<td style="text-align:right;">
2.0
</td>
<td style="text-align:right;">
1.5
</td>
</tr>
<tr>
<td style="text-align:right;">
2.0
</td>
<td style="text-align:right;">
2.0
</td>
</tr>
<tr>
<td style="text-align:right;">
2.0
</td>
<td style="text-align:right;">
2.5
</td>
</tr>
<tr>
<td style="text-align:right;">
2.5
</td>
<td style="text-align:right;">
0.5
</td>
</tr>
<tr>
<td style="text-align:right;">
2.5
</td>
<td style="text-align:right;">
1.0
</td>
</tr>
<tr>
<td style="text-align:right;">
2.5
</td>
<td style="text-align:right;">
1.5
</td>
</tr>
<tr>
<td style="text-align:right;">
2.5
</td>
<td style="text-align:right;">
2.0
</td>
</tr>
<tr>
<td style="text-align:right;">
2.5
</td>
<td style="text-align:right;">
2.5
</td>
</tr>
</tbody>
</table>
<p>is there a pattern??</p>
<ul>
<li>ERROR if : min_fuel_layer_ht_m == dist_btwn_bins_m (except 0.5,1.5,2.5)??</li>
<li>ERROR if : dist_btwn_bins_m - min_fuel_layer_ht_m &gt;= 1.5</li>
</ul>
<p>perhaps the pattern is driven by the interaction with another parameter that we did’t adjust</p>
<p>anyway…..</p>
<p>what does the success data look like?</p>
<div class="sourceCode" id="cb207"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb207-1"><a href="s02.html#cb207-1" tabindex="-1"></a>test_cbh_dta <span class="sc">%&gt;%</span> </span>
<span id="cb207-2"><a href="s02.html#cb207-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 3,210
## Columns: 7
## $ treeID              &lt;chr&gt; &quot;1_453532.6_4458594.6&quot;, &quot;2_453544.6_4458594.6&quot;, &quot;3…
## $ tree_height_m       &lt;dbl&gt; 3.185, 12.866, 11.826, 4.287, 8.980, 7.009, 6.352,…
## $ tree_cbh_m          &lt;dbl&gt; 1.274369, 1.895744, 1.856778, 1.715297, 2.000000, …
## $ is_training_cbh     &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, TRUE, FALSE, TRUE, FAL…
## $ min_fuel_layer_ht_m &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
## $ dist_btwn_bins_m    &lt;dbl&gt; 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, …
## $ timer_secs          &lt;dbl&gt; 15.52875, 15.52875, 15.52875, 15.52875, 15.52875, …</code></pre>
<p>sick, how about by data set?</p>
<div class="sourceCode" id="cb209"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb209-1"><a href="s02.html#cb209-1" tabindex="-1"></a>test_cbh_dta <span class="sc">%&gt;%</span> </span>
<span id="cb209-2"><a href="s02.html#cb209-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(min_fuel_layer_ht_m, dist_btwn_bins_m) <span class="sc">%&gt;%</span> </span>
<span id="cb209-3"><a href="s02.html#cb209-3" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(<span class="at">caption =</span> <span class="st">&quot;look at our test data combintation successes&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb209-4"><a href="s02.html#cb209-4" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>()</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-137">Table 3.3: </span>look at our test data combintation successes
</caption>
<thead>
<tr>
<th style="text-align:right;">
min_fuel_layer_ht_m
</th>
<th style="text-align:right;">
dist_btwn_bins_m
</th>
<th style="text-align:right;">
n
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
107
</td>
</tr>
<tr>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
107
</td>
</tr>
<tr>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
1.5
</td>
<td style="text-align:right;">
107
</td>
</tr>
<tr>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
2.0
</td>
<td style="text-align:right;">
107
</td>
</tr>
<tr>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
2.5
</td>
<td style="text-align:right;">
107
</td>
</tr>
<tr>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
107
</td>
</tr>
<tr>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
107
</td>
</tr>
<tr>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
1.5
</td>
<td style="text-align:right;">
107
</td>
</tr>
<tr>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
2.0
</td>
<td style="text-align:right;">
107
</td>
</tr>
<tr>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
2.5
</td>
<td style="text-align:right;">
107
</td>
</tr>
<tr>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
107
</td>
</tr>
<tr>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
107
</td>
</tr>
<tr>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
1.5
</td>
<td style="text-align:right;">
107
</td>
</tr>
<tr>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
2.0
</td>
<td style="text-align:right;">
107
</td>
</tr>
<tr>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
2.5
</td>
<td style="text-align:right;">
107
</td>
</tr>
<tr>
<td style="text-align:right;">
1.5
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
107
</td>
</tr>
<tr>
<td style="text-align:right;">
1.5
</td>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
107
</td>
</tr>
<tr>
<td style="text-align:right;">
1.5
</td>
<td style="text-align:right;">
1.5
</td>
<td style="text-align:right;">
107
</td>
</tr>
<tr>
<td style="text-align:right;">
1.5
</td>
<td style="text-align:right;">
2.0
</td>
<td style="text-align:right;">
107
</td>
</tr>
<tr>
<td style="text-align:right;">
1.5
</td>
<td style="text-align:right;">
2.5
</td>
<td style="text-align:right;">
107
</td>
</tr>
<tr>
<td style="text-align:right;">
2.0
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
107
</td>
</tr>
<tr>
<td style="text-align:right;">
2.0
</td>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
107
</td>
</tr>
<tr>
<td style="text-align:right;">
2.0
</td>
<td style="text-align:right;">
1.5
</td>
<td style="text-align:right;">
107
</td>
</tr>
<tr>
<td style="text-align:right;">
2.0
</td>
<td style="text-align:right;">
2.0
</td>
<td style="text-align:right;">
107
</td>
</tr>
<tr>
<td style="text-align:right;">
2.0
</td>
<td style="text-align:right;">
2.5
</td>
<td style="text-align:right;">
107
</td>
</tr>
<tr>
<td style="text-align:right;">
2.5
</td>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
107
</td>
</tr>
<tr>
<td style="text-align:right;">
2.5
</td>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
107
</td>
</tr>
<tr>
<td style="text-align:right;">
2.5
</td>
<td style="text-align:right;">
1.5
</td>
<td style="text-align:right;">
107
</td>
</tr>
<tr>
<td style="text-align:right;">
2.5
</td>
<td style="text-align:right;">
2.0
</td>
<td style="text-align:right;">
107
</td>
</tr>
<tr>
<td style="text-align:right;">
2.5
</td>
<td style="text-align:right;">
2.5
</td>
<td style="text-align:right;">
107
</td>
</tr>
</tbody>
</table>
<p>let’s check those CBH values</p>
<div class="sourceCode" id="cb210"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb210-1"><a href="s02.html#cb210-1" tabindex="-1"></a>test_cbh_dta <span class="sc">%&gt;%</span> </span>
<span id="cb210-2"><a href="s02.html#cb210-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb210-3"><a href="s02.html#cb210-3" tabindex="-1"></a>    <span class="at">is_default =</span> min_fuel_layer_ht_m <span class="sc">==</span> <span class="fl">1.5</span> <span class="sc">&amp;</span></span>
<span id="cb210-4"><a href="s02.html#cb210-4" tabindex="-1"></a>      dist_btwn_bins_m <span class="sc">==</span> <span class="dv">1</span></span>
<span id="cb210-5"><a href="s02.html#cb210-5" tabindex="-1"></a>    , <span class="at">minHT_step =</span> forcats<span class="sc">::</span><span class="fu">fct_cross</span>(</span>
<span id="cb210-6"><a href="s02.html#cb210-6" tabindex="-1"></a>      <span class="fu">factor</span>(min_fuel_layer_ht_m), <span class="fu">factor</span>(dist_btwn_bins_m)</span>
<span id="cb210-7"><a href="s02.html#cb210-7" tabindex="-1"></a>      , <span class="at">keep_empty =</span> F</span>
<span id="cb210-8"><a href="s02.html#cb210-8" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb210-9"><a href="s02.html#cb210-9" tabindex="-1"></a>    forcats<span class="sc">::</span><span class="fu">fct_reorder</span>(</span>
<span id="cb210-10"><a href="s02.html#cb210-10" tabindex="-1"></a>      <span class="at">.x =</span> tree_cbh_m</span>
<span id="cb210-11"><a href="s02.html#cb210-11" tabindex="-1"></a>      , <span class="at">.fun =</span> median</span>
<span id="cb210-12"><a href="s02.html#cb210-12" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb210-13"><a href="s02.html#cb210-13" tabindex="-1"></a>    forcats<span class="sc">::</span><span class="fu">fct_rev</span>()</span>
<span id="cb210-14"><a href="s02.html#cb210-14" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb210-15"><a href="s02.html#cb210-15" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> minHT_step, <span class="at">x =</span> tree_cbh_m, <span class="at">fill =</span> is_default)) <span class="sc">+</span></span>
<span id="cb210-16"><a href="s02.html#cb210-16" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">width =</span> <span class="fl">0.7</span>, <span class="at">outliers =</span> F) <span class="sc">+</span></span>
<span id="cb210-17"><a href="s02.html#cb210-17" tabindex="-1"></a>  harrypotter<span class="sc">::</span><span class="fu">scale_fill_hp_d</span>(<span class="st">&quot;dracomalfoy&quot;</span>, <span class="at">begin =</span> <span class="fl">0.8</span>, <span class="at">end =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb210-18"><a href="s02.html#cb210-18" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="dv">12</span>)) <span class="sc">+</span></span>
<span id="cb210-19"><a href="s02.html#cb210-19" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">&quot;min_fuel_layer_ht_m : dist_btwn_bins_m&quot;</span>, <span class="at">x =</span> <span class="st">&quot;CBH (m)&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;is the default&quot;</span>) <span class="sc">+</span></span>
<span id="cb210-20"><a href="s02.html#cb210-20" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb210-21"><a href="s02.html#cb210-21" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>)</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-138-1.png" width="1008" /></p>
<p>very interesting. it seems that the default settings result in variable CBH estimates that are generally lower than other parameter settings tested. Setting <code>min_fuel_layer_ht_m = 1</code> and <code>dist_btwn_bins_m = 0.5</code> results in CBH estimates that are lower (what we are aiming for) than the default settings and similarly variable to the default setting. Increasing the <code>min_fuel_layer_ht_m</code> to values &gt;= 2 does indeed result in increase CBH estimates that are also more consistent (potentially a desirable result) which may be due to the limited number of taller trees in this particular test data.</p>
<p><em>let’s proceed by using these settings: <code>min_fuel_layer_ht_m = 1</code> and <code>dist_btwn_bins_m = 0.5</code></em></p>
<p>we need to perform a study measuring the accuracy of the CBH estimated from the point cloud versus field validation data to properly determine what parameter settings to use in the <code>LadderFuelsR</code> process</p>
<p>let’s check out the timer on a per tree basis</p>
<div class="sourceCode" id="cb211"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb211-1"><a href="s02.html#cb211-1" tabindex="-1"></a>secs_per_tree <span class="ot">&lt;-</span> test_cbh_dta <span class="sc">%&gt;%</span> </span>
<span id="cb211-2"><a href="s02.html#cb211-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(min_fuel_layer_ht_m, dist_btwn_bins_m, timer_secs) <span class="sc">%&gt;%</span> </span>
<span id="cb211-3"><a href="s02.html#cb211-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb211-4"><a href="s02.html#cb211-4" tabindex="-1"></a>    <span class="at">secs_per_tree =</span> timer_secs<span class="sc">/</span>n</span>
<span id="cb211-5"><a href="s02.html#cb211-5" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb211-6"><a href="s02.html#cb211-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(secs_per_tree)</span>
<span id="cb211-7"><a href="s02.html#cb211-7" tabindex="-1"></a>secs_per_tree <span class="sc">%&gt;%</span> <span class="fu">summary</span>()</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##  0.1325  0.1502  0.1560  0.1564  0.1613  0.1734</code></pre>
<p>that’s not too shabby but let’s remember that this is a lower density point cloud. the estimate is that for every 1,000 trees the CBH extraction from the point cloud would take 2.6 minutes. how does that sound?</p>
<p>this is also based on the point density of this test data:</p>
<div class="sourceCode" id="cb213"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb213-1"><a href="s02.html#cb213-1" tabindex="-1"></a>lidR<span class="sc">::</span><span class="fu">readLAScatalog</span>(norm_las_dir)</span></code></pre></div>
<pre><code>## class       : LAScatalog (v1.3 format 1)
## extent      : 453532.6, 453572.6, 4458556, 4458596 (xmin, xmax, ymin, ymax)
## coord. ref. : WGS 84 / UTM zone 13N 
## area        : 1599.8 m²
## points      : 20.4 thousand points
## density     : 12.7 points/m²
## density     : 7.9 pulses/m²
## num. files  : 1</code></pre>
</div>
</div>
<div id="test-cbh-process---uas" class="section level2 hasAnchor" number="3.5">
<h2><span class="header-section-number">3.5</span> Test CBH process - UAS<a href="s02.html#test-cbh-process---uas" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In the <a href="s02.html#test_l">analysis above</a> we tested extracting CBH from lidar point cloud data. Let’s test the process for UAS data</p>
<div id="cloud2trees-that-uas-data" class="section level3 hasAnchor" number="3.5.1">
<h3><span class="header-section-number">3.5.1</span> <code>cloud2trees</code> that UAS data<a href="s02.html#cloud2trees-that-uas-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>extract trees from the UAS data using <code>cloud2trees</code> to create some example tree-level point cloud data to test the <code>LadderFuelsR</code> process</p>
<div class="sourceCode" id="cb215"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb215-1"><a href="s02.html#cb215-1" tabindex="-1"></a><span class="cf">if</span>(F){</span>
<span id="cb215-2"><a href="s02.html#cb215-2" tabindex="-1"></a>  cloud2trees_ans <span class="ot">&lt;-</span> cloud2trees<span class="sc">::</span><span class="fu">cloud2trees</span>(</span>
<span id="cb215-3"><a href="s02.html#cb215-3" tabindex="-1"></a>    <span class="at">input_las_dir =</span> <span class="st">&quot;../data/uas&quot;</span></span>
<span id="cb215-4"><a href="s02.html#cb215-4" tabindex="-1"></a>    , <span class="at">output_dir =</span> <span class="st">&quot;../data/uas&quot;</span></span>
<span id="cb215-5"><a href="s02.html#cb215-5" tabindex="-1"></a>    , <span class="at">estimate_tree_dbh =</span> F</span>
<span id="cb215-6"><a href="s02.html#cb215-6" tabindex="-1"></a>    , <span class="at">keep_intrmdt =</span> T</span>
<span id="cb215-7"><a href="s02.html#cb215-7" tabindex="-1"></a>  )</span>
<span id="cb215-8"><a href="s02.html#cb215-8" tabindex="-1"></a>  norm_las_dir <span class="ot">&lt;-</span> <span class="st">&quot;../data/uas/point_cloud_processing_temp/02_normalize/&quot;</span></span>
<span id="cb215-9"><a href="s02.html#cb215-9" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb215-10"><a href="s02.html#cb215-10" tabindex="-1"></a>  cloud2trees_ans <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb215-11"><a href="s02.html#cb215-11" tabindex="-1"></a>    <span class="at">crowns_sf =</span> sf<span class="sc">::</span><span class="fu">st_read</span>(<span class="st">&quot;../data/uas/point_cloud_processing_delivery/final_detected_crowns.gpkg&quot;</span>, <span class="at">quiet=</span>T)</span>
<span id="cb215-12"><a href="s02.html#cb215-12" tabindex="-1"></a>    , <span class="at">treetops_sf =</span> sf<span class="sc">::</span><span class="fu">st_read</span>(<span class="st">&quot;../data/uas/point_cloud_processing_delivery/final_detected_tree_tops.gpkg&quot;</span>, <span class="at">quiet=</span>T)</span>
<span id="cb215-13"><a href="s02.html#cb215-13" tabindex="-1"></a>  )</span>
<span id="cb215-14"><a href="s02.html#cb215-14" tabindex="-1"></a>  norm_las_dir <span class="ot">&lt;-</span> <span class="st">&quot;../data/uas/point_cloud_processing_temp/02_normalize/&quot;</span></span>
<span id="cb215-15"><a href="s02.html#cb215-15" tabindex="-1"></a>}</span></code></pre></div>
<p>look at that point density</p>
<div class="sourceCode" id="cb216"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb216-1"><a href="s02.html#cb216-1" tabindex="-1"></a>lidR<span class="sc">::</span><span class="fu">readLAScatalog</span>(</span>
<span id="cb216-2"><a href="s02.html#cb216-2" tabindex="-1"></a>  <span class="fu">list.files</span>(<span class="st">&quot;../data/uas&quot;</span>, <span class="at">pattern =</span> <span class="st">&quot;.*</span><span class="sc">\\</span><span class="st">.(laz|las)$&quot;</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>]</span>
<span id="cb216-3"><a href="s02.html#cb216-3" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## class       : LAScatalog (v1.2 format 3)
## extent      : 490067.8, 490329.8, 4330744, 4330951 (xmin, xmax, ymin, ymax)
## coord. ref. : WGS 84 / UTM zone 13N 
## area        : 54091.95 m²
## points      : 14.31 million points
## density     : 264.6 points/m²
## num. files  : 1</code></pre>
<p>how many trees did we get?</p>
<div class="sourceCode" id="cb218"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb218-1"><a href="s02.html#cb218-1" tabindex="-1"></a>cloud2trees_ans<span class="sc">$</span>crowns_sf <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()</span></code></pre></div>
<pre><code>## [1] 1626</code></pre>
<p>we’ll reduce our sample to estimate cbh from</p>
</div>
<div id="extract-cbh-example" class="section level3 hasAnchor" number="3.5.2">
<h3><span class="header-section-number">3.5.2</span> Extract CBH example<a href="s02.html#extract-cbh-example" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>here, we’ll use the parameter settings in the <code>LadderFuelsR</code> process that we <a href="s02.html#test_l2">found worked the best</a> for lidar point cloud data and we’ll decrease the</p>
<div class="sourceCode" id="cb220"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb220-1"><a href="s02.html#cb220-1" tabindex="-1"></a>trees_cbh_ans <span class="ot">&lt;-</span> cloud2trees<span class="sc">::</span><span class="fu">trees_cbh</span>(</span>
<span id="cb220-2"><a href="s02.html#cb220-2" tabindex="-1"></a>  <span class="at">trees_poly =</span> cloud2trees_ans<span class="sc">$</span>crowns_sf</span>
<span id="cb220-3"><a href="s02.html#cb220-3" tabindex="-1"></a>  , <span class="at">norm_las =</span> norm_las_dir <span class="co"># pull this from create_project_structure.R</span></span>
<span id="cb220-4"><a href="s02.html#cb220-4" tabindex="-1"></a>  , <span class="at">tree_sample_prop =</span> .<span class="dv">1</span></span>
<span id="cb220-5"><a href="s02.html#cb220-5" tabindex="-1"></a>  , <span class="at">estimate_missing_cbh =</span> T</span>
<span id="cb220-6"><a href="s02.html#cb220-6" tabindex="-1"></a>  , <span class="at">which_cbh =</span> <span class="st">&quot;lowest&quot;</span></span>
<span id="cb220-7"><a href="s02.html#cb220-7" tabindex="-1"></a>  , <span class="at">min_vhp_n =</span> <span class="dv">4</span> <span class="co"># = 2.5m with min_fuel_layer_ht_m=1 and dist_btwn_bins_m = 0.5</span></span>
<span id="cb220-8"><a href="s02.html#cb220-8" tabindex="-1"></a>  , <span class="at">min_fuel_layer_ht_m =</span> <span class="dv">1</span> <span class="co"># default = 1.5</span></span>
<span id="cb220-9"><a href="s02.html#cb220-9" tabindex="-1"></a>  , <span class="at">dist_btwn_bins_m =</span> <span class="fl">0.5</span> <span class="co"># default = 1</span></span>
<span id="cb220-10"><a href="s02.html#cb220-10" tabindex="-1"></a>)</span></code></pre></div>
<p>what?</p>
<div class="sourceCode" id="cb221"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb221-1"><a href="s02.html#cb221-1" tabindex="-1"></a>trees_cbh_ans <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 1,626
## Columns: 22
## $ treeID                    &lt;chr&gt; &quot;1_490176.4_4330945.1&quot;, &quot;2_490177.6_4330944.…
## $ tree_height_m             &lt;dbl&gt; 6.780, 3.685, 4.972, 18.424, 7.200, 3.069, 1…
## $ tree_x                    &lt;dbl&gt; 490176.4, 490177.6, 490235.9, 490117.1, 4901…
## $ tree_y                    &lt;dbl&gt; 4330945, 4330944, 4330944, 4330943, 4330943,…
## $ crown_area_m2             &lt;dbl&gt; 3.0000, 0.8750, 1.1250, 16.3125, 0.7500, 0.9…
## $ fia_est_dbh_cm            &lt;dbl&gt; 11.316934, 6.064179, 8.071623, 42.559879, 12…
## $ fia_est_dbh_cm_lower      &lt;dbl&gt; 6.514868, 3.477446, 4.650148, 24.469235, 6.9…
## $ fia_est_dbh_cm_upper      &lt;dbl&gt; 17.299223, 9.144170, 12.312182, 65.605321, 1…
## $ dbh_cm                    &lt;dbl&gt; 11.316934, 6.064179, 8.071623, 42.559879, 12…
## $ is_training_data          &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FA…
## $ dbh_m                     &lt;dbl&gt; 0.11316934, 0.06064179, 0.08071623, 0.425598…
## $ radius_m                  &lt;dbl&gt; 0.05658467, 0.03032089, 0.04035812, 0.212799…
## $ basal_area_m2             &lt;dbl&gt; 0.010058830, 0.002888244, 0.005116955, 0.142…
## $ basal_area_ft2            &lt;dbl&gt; 0.10827324, 0.03108906, 0.05507891, 1.531314…
## $ ptcld_extracted_dbh_cm    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ ptcld_predicted_dbh_cm    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ comp_trees_per_ha         &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ comp_relative_tree_height &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ comp_dist_to_nearest_m    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ tree_cbh_m                &lt;dbl&gt; 4.947117, 3.114765, 4.202608, 7.257119, 4.88…
## $ is_training_cbh           &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FA…
## $ geom                      &lt;MULTIPOLYGON [m]&gt; MULTIPOLYGON (((490177 4330...,…</code></pre>
<p>let’s view the height versus CBH relationship by training data</p>
<div class="sourceCode" id="cb223"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb223-1"><a href="s02.html#cb223-1" tabindex="-1"></a>trees_cbh_ans <span class="sc">%&gt;%</span> </span>
<span id="cb223-2"><a href="s02.html#cb223-2" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> tree_height_m, <span class="at">y =</span> tree_cbh_m, <span class="at">color =</span> is_training_cbh)) <span class="sc">+</span></span>
<span id="cb223-3"><a href="s02.html#cb223-3" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb223-4"><a href="s02.html#cb223-4" tabindex="-1"></a>  harrypotter<span class="sc">::</span><span class="fu">scale_color_hp_d</span>(<span class="st">&quot;ronweasley&quot;</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb223-5"><a href="s02.html#cb223-5" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="dv">12</span>)) <span class="sc">+</span></span>
<span id="cb223-6"><a href="s02.html#cb223-6" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="dv">12</span>)) <span class="sc">+</span></span>
<span id="cb223-7"><a href="s02.html#cb223-7" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">&quot;CBH (m)&quot;</span>, <span class="at">x =</span> <span class="st">&quot;Height (m)&quot;</span>, <span class="at">color =</span> <span class="st">&quot;is training data&quot;</span>) <span class="sc">+</span></span>
<span id="cb223-8"><a href="s02.html#cb223-8" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb223-9"><a href="s02.html#cb223-9" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>)</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-146-1.png" width="1008" /></p>
<p>check out the CBH spatially</p>
<div class="sourceCode" id="cb224"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb224-1"><a href="s02.html#cb224-1" tabindex="-1"></a>trees_cbh_ans <span class="sc">%&gt;%</span> </span>
<span id="cb224-2"><a href="s02.html#cb224-2" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">color =</span> is_training_cbh, <span class="at">fill =</span> tree_cbh_m)) <span class="sc">+</span></span>
<span id="cb224-3"><a href="s02.html#cb224-3" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">lwd =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb224-4"><a href="s02.html#cb224-4" tabindex="-1"></a>  harrypotter<span class="sc">::</span><span class="fu">scale_color_hp_d</span>(<span class="st">&quot;ronweasley&quot;</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb224-5"><a href="s02.html#cb224-5" tabindex="-1"></a>  harrypotter<span class="sc">::</span><span class="fu">scale_fill_hp</span>(<span class="st">&quot;always&quot;</span>) <span class="sc">+</span></span>
<span id="cb224-6"><a href="s02.html#cb224-6" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">&quot;CBH (m)&quot;</span>, <span class="at">color =</span> <span class="st">&quot;is training data&quot;</span>) <span class="sc">+</span></span>
<span id="cb224-7"><a href="s02.html#cb224-7" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb224-8"><a href="s02.html#cb224-8" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>, <span class="at">axis.text =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb224-9"><a href="s02.html#cb224-9" tabindex="-1"></a>  <span class="fu">guides</span>(</span>
<span id="cb224-10"><a href="s02.html#cb224-10" tabindex="-1"></a>    <span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">order =</span> <span class="dv">1</span>, <span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">lwd =</span> <span class="dv">3</span>, <span class="at">fill =</span> <span class="cn">NA</span>))</span>
<span id="cb224-11"><a href="s02.html#cb224-11" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-147-1.png" width="1008" /></p>
</div>
<div id="test-cbh-based-on-parameterization-of-ladderfuelsr-1" class="section level3 hasAnchor" number="3.5.3">
<h3><span class="header-section-number">3.5.3</span> test CBH based on parameterization of <code>LadderFuelsR</code><a href="s02.html#test-cbh-based-on-parameterization-of-ladderfuelsr-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Above, we <a href="s02.html#test_l2">tested different parameterization settings</a> for the lidar data. Let’s do the same for UAS data to test for different levels of the <code>min_fuel_layer_ht_m</code> and <code>dist_btwn_bins_m</code> parameters</p>
<p>Notice here that we adjusted the <code>min_vhp_n</code> and <code>tree_sample_prop</code> in the <code>trees_cbh()</code> function compared to the lidar data test</p>
<div class="sourceCode" id="cb225"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb225-1"><a href="s02.html#cb225-1" tabindex="-1"></a><span class="co"># run it</span></span>
<span id="cb225-2"><a href="s02.html#cb225-2" tabindex="-1"></a>test_cbh_dta_u <span class="ot">&lt;-</span> </span>
<span id="cb225-3"><a href="s02.html#cb225-3" tabindex="-1"></a>  <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(dta_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb225-4"><a href="s02.html#cb225-4" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(\(x) <span class="fu">test_cbh_fn</span>(x, <span class="at">my_min_vhp_n =</span> <span class="dv">4</span>, <span class="at">my_tree_sample_prop =</span> <span class="fl">0.08</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb225-5"><a href="s02.html#cb225-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span></code></pre></div>
<p>which combinations caused errors?</p>
<p><em>Update: in the cloud2trees package I have included error handling so that the function does not return the errors that happen in the LadderfulesR package. Additionally, if no trees return CBH based on the parameters passed to the LadderfulesR package, I attempt update the parameters to settings that have previously been successful for most data sets to get a successful result in the trees_cbh() call.</em></p>
<div class="sourceCode" id="cb226"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb226-1"><a href="s02.html#cb226-1" tabindex="-1"></a><span class="co"># which combinations caused errors?</span></span>
<span id="cb226-2"><a href="s02.html#cb226-2" tabindex="-1"></a>dta_temp <span class="sc">%&gt;%</span> </span>
<span id="cb226-3"><a href="s02.html#cb226-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">anti_join</span>(</span>
<span id="cb226-4"><a href="s02.html#cb226-4" tabindex="-1"></a>    test_cbh_dta_u</span>
<span id="cb226-5"><a href="s02.html#cb226-5" tabindex="-1"></a>    , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(min_fuel_layer_ht_m, dist_btwn_bins_m)</span>
<span id="cb226-6"><a href="s02.html#cb226-6" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb226-7"><a href="s02.html#cb226-7" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(<span class="at">caption =</span> <span class="st">&quot;uas: these combintations resulted in ERROR!&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb226-8"><a href="s02.html#cb226-8" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>()</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-148">Table 3.4: </span>uas: these combintations resulted in ERROR!
</caption>
<thead>
<tr>
<th style="text-align:right;">
min_fuel_layer_ht_m
</th>
<th style="text-align:right;">
dist_btwn_bins_m
</th>
</tr>
</thead>
<tbody>
<tr>
</tr>
</tbody>
</table>
<p>which combinations resulted in success?</p>
<div class="sourceCode" id="cb227"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb227-1"><a href="s02.html#cb227-1" tabindex="-1"></a><span class="co"># which combinations caused success?</span></span>
<span id="cb227-2"><a href="s02.html#cb227-2" tabindex="-1"></a>dta_temp <span class="sc">%&gt;%</span> </span>
<span id="cb227-3"><a href="s02.html#cb227-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb227-4"><a href="s02.html#cb227-4" tabindex="-1"></a>    test_cbh_dta_u <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">distinct</span>(min_fuel_layer_ht_m, dist_btwn_bins_m)</span>
<span id="cb227-5"><a href="s02.html#cb227-5" tabindex="-1"></a>    , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(min_fuel_layer_ht_m, dist_btwn_bins_m)</span>
<span id="cb227-6"><a href="s02.html#cb227-6" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb227-7"><a href="s02.html#cb227-7" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(<span class="at">caption =</span> <span class="st">&quot;uas: these combintations resulted in SUCCESS!&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb227-8"><a href="s02.html#cb227-8" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>()</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-149">Table 3.5: </span>uas: these combintations resulted in SUCCESS!
</caption>
<thead>
<tr>
<th style="text-align:right;">
min_fuel_layer_ht_m
</th>
<th style="text-align:right;">
dist_btwn_bins_m
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
0.5
</td>
</tr>
<tr>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
1.0
</td>
</tr>
<tr>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
1.5
</td>
</tr>
<tr>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
2.0
</td>
</tr>
<tr>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
2.5
</td>
</tr>
<tr>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
0.5
</td>
</tr>
<tr>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
1.0
</td>
</tr>
<tr>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
1.5
</td>
</tr>
<tr>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
2.0
</td>
</tr>
<tr>
<td style="text-align:right;">
0.5
</td>
<td style="text-align:right;">
2.5
</td>
</tr>
<tr>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
0.5
</td>
</tr>
<tr>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
1.0
</td>
</tr>
<tr>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
1.5
</td>
</tr>
<tr>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
2.0
</td>
</tr>
<tr>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
2.5
</td>
</tr>
<tr>
<td style="text-align:right;">
1.5
</td>
<td style="text-align:right;">
0.5
</td>
</tr>
<tr>
<td style="text-align:right;">
1.5
</td>
<td style="text-align:right;">
1.0
</td>
</tr>
<tr>
<td style="text-align:right;">
1.5
</td>
<td style="text-align:right;">
1.5
</td>
</tr>
<tr>
<td style="text-align:right;">
1.5
</td>
<td style="text-align:right;">
2.0
</td>
</tr>
<tr>
<td style="text-align:right;">
1.5
</td>
<td style="text-align:right;">
2.5
</td>
</tr>
<tr>
<td style="text-align:right;">
2.0
</td>
<td style="text-align:right;">
0.5
</td>
</tr>
<tr>
<td style="text-align:right;">
2.0
</td>
<td style="text-align:right;">
1.0
</td>
</tr>
<tr>
<td style="text-align:right;">
2.0
</td>
<td style="text-align:right;">
1.5
</td>
</tr>
<tr>
<td style="text-align:right;">
2.0
</td>
<td style="text-align:right;">
2.0
</td>
</tr>
<tr>
<td style="text-align:right;">
2.0
</td>
<td style="text-align:right;">
2.5
</td>
</tr>
<tr>
<td style="text-align:right;">
2.5
</td>
<td style="text-align:right;">
0.5
</td>
</tr>
<tr>
<td style="text-align:right;">
2.5
</td>
<td style="text-align:right;">
1.0
</td>
</tr>
<tr>
<td style="text-align:right;">
2.5
</td>
<td style="text-align:right;">
1.5
</td>
</tr>
<tr>
<td style="text-align:right;">
2.5
</td>
<td style="text-align:right;">
2.0
</td>
</tr>
<tr>
<td style="text-align:right;">
2.5
</td>
<td style="text-align:right;">
2.5
</td>
</tr>
</tbody>
</table>
<p>which combinations caused errors IN BOTH LIDAR AND UAS DATA?</p>
<div class="sourceCode" id="cb228"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb228-1"><a href="s02.html#cb228-1" tabindex="-1"></a><span class="co"># which combinations caused errors?</span></span>
<span id="cb228-2"><a href="s02.html#cb228-2" tabindex="-1"></a>  <span class="co"># UAS ERRORS</span></span>
<span id="cb228-3"><a href="s02.html#cb228-3" tabindex="-1"></a>  dta_temp <span class="sc">%&gt;%</span> </span>
<span id="cb228-4"><a href="s02.html#cb228-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">anti_join</span>(</span>
<span id="cb228-5"><a href="s02.html#cb228-5" tabindex="-1"></a>    test_cbh_dta_u</span>
<span id="cb228-6"><a href="s02.html#cb228-6" tabindex="-1"></a>    , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(min_fuel_layer_ht_m, dist_btwn_bins_m)</span>
<span id="cb228-7"><a href="s02.html#cb228-7" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb228-8"><a href="s02.html#cb228-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb228-9"><a href="s02.html#cb228-9" tabindex="-1"></a>    <span class="co"># lidar ERRORS</span></span>
<span id="cb228-10"><a href="s02.html#cb228-10" tabindex="-1"></a>    dta_temp <span class="sc">%&gt;%</span> </span>
<span id="cb228-11"><a href="s02.html#cb228-11" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">anti_join</span>(</span>
<span id="cb228-12"><a href="s02.html#cb228-12" tabindex="-1"></a>      test_cbh_dta</span>
<span id="cb228-13"><a href="s02.html#cb228-13" tabindex="-1"></a>      , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(min_fuel_layer_ht_m, dist_btwn_bins_m)</span>
<span id="cb228-14"><a href="s02.html#cb228-14" tabindex="-1"></a>    ) </span>
<span id="cb228-15"><a href="s02.html#cb228-15" tabindex="-1"></a>    , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(min_fuel_layer_ht_m, dist_btwn_bins_m)</span>
<span id="cb228-16"><a href="s02.html#cb228-16" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb228-17"><a href="s02.html#cb228-17" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(<span class="at">caption =</span> <span class="st">&quot;lidar AND uas: these combintations resulted in ERROR!&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb228-18"><a href="s02.html#cb228-18" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>()</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-150">Table 3.6: </span>lidar AND uas: these combintations resulted in ERROR!
</caption>
<thead>
<tr>
<th style="text-align:right;">
min_fuel_layer_ht_m
</th>
<th style="text-align:right;">
dist_btwn_bins_m
</th>
</tr>
</thead>
<tbody>
<tr>
</tr>
</tbody>
</table>
<p>is there a pattern??</p>
<ul>
<li>ERROR if : min_fuel_layer_ht_m == dist_btwn_bins_m (except 0.5,1.5,2.5)??</li>
<li>ERROR if : dist_btwn_bins_m - min_fuel_layer_ht_m &gt;= 1.5</li>
</ul>
<p>perhaps the pattern is driven by the interaction with another parameter that we did’t adjust</p>
<p>anyway…..</p>
<p>let’s check those CBH values</p>
<div class="sourceCode" id="cb229"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb229-1"><a href="s02.html#cb229-1" tabindex="-1"></a>test_cbh_dta_u <span class="sc">%&gt;%</span> </span>
<span id="cb229-2"><a href="s02.html#cb229-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb229-3"><a href="s02.html#cb229-3" tabindex="-1"></a>    <span class="at">is_default =</span> min_fuel_layer_ht_m <span class="sc">==</span> <span class="fl">1.5</span> <span class="sc">&amp;</span></span>
<span id="cb229-4"><a href="s02.html#cb229-4" tabindex="-1"></a>      dist_btwn_bins_m <span class="sc">==</span> <span class="dv">1</span></span>
<span id="cb229-5"><a href="s02.html#cb229-5" tabindex="-1"></a>    , <span class="at">minHT_step =</span> forcats<span class="sc">::</span><span class="fu">fct_cross</span>(</span>
<span id="cb229-6"><a href="s02.html#cb229-6" tabindex="-1"></a>      <span class="fu">factor</span>(min_fuel_layer_ht_m), <span class="fu">factor</span>(dist_btwn_bins_m)</span>
<span id="cb229-7"><a href="s02.html#cb229-7" tabindex="-1"></a>      , <span class="at">keep_empty =</span> F</span>
<span id="cb229-8"><a href="s02.html#cb229-8" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb229-9"><a href="s02.html#cb229-9" tabindex="-1"></a>    forcats<span class="sc">::</span><span class="fu">fct_reorder</span>(</span>
<span id="cb229-10"><a href="s02.html#cb229-10" tabindex="-1"></a>      <span class="at">.x =</span> tree_cbh_m</span>
<span id="cb229-11"><a href="s02.html#cb229-11" tabindex="-1"></a>      , <span class="at">.fun =</span> median</span>
<span id="cb229-12"><a href="s02.html#cb229-12" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb229-13"><a href="s02.html#cb229-13" tabindex="-1"></a>    forcats<span class="sc">::</span><span class="fu">fct_rev</span>()</span>
<span id="cb229-14"><a href="s02.html#cb229-14" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb229-15"><a href="s02.html#cb229-15" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> minHT_step, <span class="at">x =</span> tree_cbh_m, <span class="at">fill =</span> is_default)) <span class="sc">+</span></span>
<span id="cb229-16"><a href="s02.html#cb229-16" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">width =</span> <span class="fl">0.7</span>, <span class="at">outliers =</span> F) <span class="sc">+</span></span>
<span id="cb229-17"><a href="s02.html#cb229-17" tabindex="-1"></a>  harrypotter<span class="sc">::</span><span class="fu">scale_fill_hp_d</span>(<span class="st">&quot;dracomalfoy&quot;</span>, <span class="at">begin =</span> <span class="fl">0.8</span>, <span class="at">end =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb229-18"><a href="s02.html#cb229-18" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="dv">12</span>)) <span class="sc">+</span></span>
<span id="cb229-19"><a href="s02.html#cb229-19" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">&quot;min_fuel_layer_ht_m : dist_btwn_bins_m&quot;</span>, <span class="at">x =</span> <span class="st">&quot;CBH (m)&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;is the default&quot;</span>) <span class="sc">+</span></span>
<span id="cb229-20"><a href="s02.html#cb229-20" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb229-21"><a href="s02.html#cb229-21" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>)</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-151-1.png" width="1008" /></p>
<p>is this interesting?</p>
<p>we need to perform a study measuring the accuracy of the CBH estimated from the point cloud versus field validation data to properly determine what parameter settings to use in the <code>LadderFuelsR</code> process</p>
<p>let’s check out the timer on a per tree basis</p>
<div class="sourceCode" id="cb230"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb230-1"><a href="s02.html#cb230-1" tabindex="-1"></a>secs_per_tree <span class="ot">&lt;-</span> test_cbh_dta_u <span class="sc">%&gt;%</span> </span>
<span id="cb230-2"><a href="s02.html#cb230-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(min_fuel_layer_ht_m, dist_btwn_bins_m, timer_secs) <span class="sc">%&gt;%</span> </span>
<span id="cb230-3"><a href="s02.html#cb230-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb230-4"><a href="s02.html#cb230-4" tabindex="-1"></a>    <span class="at">secs_per_tree =</span> timer_secs<span class="sc">/</span>n</span>
<span id="cb230-5"><a href="s02.html#cb230-5" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb230-6"><a href="s02.html#cb230-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(secs_per_tree)</span>
<span id="cb230-7"><a href="s02.html#cb230-7" tabindex="-1"></a>secs_per_tree <span class="sc">%&gt;%</span> <span class="fu">summary</span>()</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
## 0.02982 0.03199 0.03373 0.03331 0.03491 0.03730</code></pre>
<p>the estimate is that for every 1,000 trees the CBH extraction from the point cloud would take 0.6 minutes. how does that sound?</p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="s01.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="s03.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
