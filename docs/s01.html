<!DOCTYPE html>
<html lang="en-US" xml:lang="en-US">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Section 2 Data Load and Methods Explore | Aerial LiDAR for Fire Model Inputs</title>
  <meta name="description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  <meta name="generator" content="bookdown 0.34 and GitBook 2.6.7" />

  <meta property="og:title" content="Section 2 Data Load and Methods Explore | Aerial LiDAR for Fire Model Inputs" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Section 2 Data Load and Methods Explore | Aerial LiDAR for Fire Model Inputs" />
  
  <meta name="twitter:description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  

<meta name="author" content="George Woolsey" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="index.html"/>
<link rel="next" href="s02.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
<link href="libs/bsTable-3.3.7/bootstrapTable.min.css" rel="stylesheet" />
<script src="libs/bsTable-3.3.7/bootstrapTable.js"></script>
<link href="libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet" />
<script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.2.2/leaflet.js"></script>
<script src="libs/leaflet-providers-2.0.0/leaflet-providers_2.0.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.2.2/leaflet-providers-plugin.js"></script>
<script src="libs/clipboard-0.0.1/setClipboardText.js"></script>
<link href="libs/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet" />
<link href="libs/mapviewCSS-0.0.1/mapview.css" rel="stylesheet" />
<script type="text/javascript">

// toggle visibility of R source blocks in R Markdown output
function toggle_R() {
  var x = document.getElementsByClassName('r');
  if (x.length == 0) return;
  function toggle_vis(o) {
    var d = o.style.display;
    o.style.display = (d == 'block' || d == '') ? 'none':'block';
  }

  for (i = 0; i < x.length; i++) {
    var y = x[i];
    if (y.tagName.toLowerCase() === 'pre') toggle_vis(y);
  }

    var elem = document.getElementById("myButton1");
    if (elem.value === "Hide Code") elem.value = "Show Code";
    else elem.value = "Hide Code";
}

document.write('<input onclick="toggle_R();" type="button" value="Hide Code" id="myButton1" style="position: absolute; top: 10%; right: 2%; z-index: 200"></input>')

</script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#objective"><i class="fa fa-check"></i><b>1.1</b> Objective</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#data"><i class="fa fa-check"></i><b>1.2</b> Data</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="s01.html"><a href="s01.html"><i class="fa fa-check"></i><b>2</b> Data Load and Methods Explore</a>
<ul>
<li class="chapter" data-level="2.1" data-path="s01.html"><a href="s01.html#neontreeevaluation"><i class="fa fa-check"></i><b>2.1</b> <code id="neon">NeonTreeEvaluation</code></a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="s01.html"><a href="s01.html#explore-lidar-data-from-package"><i class="fa fa-check"></i><b>2.1.1</b> Explore LiDAR data from package</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="s01.html"><a href="s01.html#cloud2trees"><i class="fa fa-check"></i><b>2.2</b> <code id="cloud2trees">cloud2trees</code></a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="s01.html"><a href="s01.html#get-tree-list-and-normalized-cloud"><i class="fa fa-check"></i><b>2.2.1</b> Get tree list and normalized cloud</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="s01.html"><a href="s01.html#ladderfuelsr"><i class="fa fa-check"></i><b>2.3</b> <code id="ladr">LadderFuelsR</code></a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="s01.html"><a href="s01.html#prep-for-the-package"><i class="fa fa-check"></i><b>2.3.1</b> Prep for the package</a></li>
<li class="chapter" data-level="2.3.2" data-path="s01.html"><a href="s01.html#defining-function-for-computing-crown-level-metrics"><i class="fa fa-check"></i><b>2.3.2</b> Defining function for computing crown-level metrics</a></li>
<li class="chapter" data-level="2.3.3" data-path="s01.html"><a href="s01.html#computing-crown-level-standard-metrics-within-all-trees-detected"><i class="fa fa-check"></i><b>2.3.3</b> Computing crown level standard metrics within all trees detected</a></li>
<li class="chapter" data-level="2.3.4" data-path="s01.html"><a href="s01.html#lai-lad-metrics-by-trees"><i class="fa fa-check"></i><b>2.3.4</b> LAI-LAD metrics by Trees</a></li>
<li class="chapter" data-level="2.3.5" data-path="s01.html"><a href="s01.html#i-quit"><i class="fa fa-check"></i><b>2.3.5</b> I quit</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="s01.html"><a href="s01.html#ladr_s"><i class="fa fa-check"></i><b>2.4</b> <code>LadderFuelsR</code> - simplified</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="s01.html"><a href="s01.html#setup"><i class="fa fa-check"></i><b>2.4.1</b> Setup</a></li>
<li class="chapter" data-level="2.4.2" data-path="s01.html"><a href="s01.html#step-0---leafr-steps"><i class="fa fa-check"></i><b>2.4.2</b> Step 0 - <code>leafR</code> steps</a></li>
<li class="chapter" data-level="2.4.3" data-path="s01.html"><a href="s01.html#step-1---ladderfuelsrget_gaps_fbhs"><i class="fa fa-check"></i><b>2.4.3</b> Step 1 - <code>LadderFuelsR::get_gaps_fbhs</code></a></li>
<li class="chapter" data-level="2.4.4" data-path="s01.html"><a href="s01.html#step-2---ladderfuelsrcalculate_gaps_perc"><i class="fa fa-check"></i><b>2.4.4</b> Step 2 - <code>LadderFuelsR::calculate_gaps_perc</code></a></li>
<li class="chapter" data-level="2.4.5" data-path="s01.html"><a href="s01.html#step-3---ladderfuelsrget_distance"><i class="fa fa-check"></i><b>2.4.5</b> Step 3 - <code>LadderFuelsR::get_distance</code></a></li>
<li class="chapter" data-level="2.4.6" data-path="s01.html"><a href="s01.html#step-4---ladderfuelsrget_depths"><i class="fa fa-check"></i><b>2.4.6</b> Step 4 - <code>LadderFuelsR::get_depths</code></a></li>
<li class="chapter" data-level="2.4.7" data-path="s01.html"><a href="s01.html#step-5---ladderfuelsrget_real_fbh"><i class="fa fa-check"></i><b>2.4.7</b> Step 5 - <code>LadderFuelsR::get_real_fbh</code></a></li>
<li class="chapter" data-level="2.4.8" data-path="s01.html"><a href="s01.html#step-6---ladderfuelsrget_real_depths"><i class="fa fa-check"></i><b>2.4.8</b> Step 6 - <code>LadderFuelsR::get_real_depths</code></a></li>
<li class="chapter" data-level="2.4.9" data-path="s01.html"><a href="s01.html#step-7---ladderfuelsrget_effective_gap"><i class="fa fa-check"></i><b>2.4.9</b> Step 7 - <code>LadderFuelsR::get_effective_gap</code></a></li>
<li class="chapter" data-level="2.4.10" data-path="s01.html"><a href="s01.html#step-8---ladderfuelsrget_layers_lad"><i class="fa fa-check"></i><b>2.4.10</b> Step 8 - <code>LadderFuelsR::get_layers_lad</code></a></li>
<li class="chapter" data-level="2.4.11" data-path="s01.html"><a href="s01.html#step-9---ladderfuelsrget_cbh_dist-ladderfuelsrget_cbh_metrics"><i class="fa fa-check"></i><b>2.4.11</b> Step 9 - <del><code>LadderFuelsR::get_cbh_dist</code></del> <code>LadderFuelsR::get_cbh_metrics</code></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="s02.html"><a href="s02.html"><i class="fa fa-check"></i><b>3</b> Process</a>
<ul>
<li class="chapter" data-level="3.1" data-path="s02.html"><a href="s02.html#get-some-lidar-data"><i class="fa fa-check"></i><b>3.1</b> Get some lidar data</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="s02.html"><a href="s02.html#cloud2trees-that-lidar-data"><i class="fa fa-check"></i><b>3.1.1</b> <code>cloud2trees</code> that lidar data</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="s02.html"><a href="s02.html#define-ladderfuelsr-processing-function"><i class="fa fa-check"></i><b>3.2</b> Define <code>LadderFuelsR</code> Processing Function</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="s02.html"><a href="s02.html#return-cbh-metrics"><i class="fa fa-check"></i><b>3.2.1</b> Return CBH Metrics</a></li>
<li class="chapter" data-level="3.2.2" data-path="s02.html"><a href="s02.html#cbh-on-the-point-cloud"><i class="fa fa-check"></i><b>3.2.2</b> CBH on the point cloud</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="s02.html"><a href="s02.html#function-to-cbh-a-tree-list"><i class="fa fa-check"></i><b>3.3</b> Function to CBH a tree list</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="s02.html"><a href="s02.html#test-the-cbh-function"><i class="fa fa-check"></i><b>3.3.1</b> Test the CBH function</a></li>
<li class="chapter" data-level="3.3.2" data-path="s02.html"><a href="s02.html#comparison-to-ladderfuelsr-defaults"><i class="fa fa-check"></i><b>3.3.2</b> Comparison to <code>LadderFuelsR</code> defaults</a></li>
<li class="chapter" data-level="3.3.3" data-path="s02.html"><a href="s02.html#test-cbh-based-on-parameterization-of-ladderfuelsr"><i class="fa fa-check"></i><b>3.3.3</b> test CBH based on parameterization of <code>LadderFuelsR</code></a></li>
</ul></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Aerial LiDAR for Fire Model Inputs</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="s01" class="section level1 hasAnchor" number="2">
<h1><span class="header-section-number">Section 2</span> Data Load and Methods Explore<a href="s01.html#s01" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>In this section we’ll review the packages we’ll be using to process and evaluate the lidar data. None of the analysis is happening here, just reviewing the methodologies.</p>
<p>Load the standard libraries</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="s01.html#cb1-1" tabindex="-1"></a><span class="co"># bread-and-butter</span></span>
<span id="cb1-2"><a href="s01.html#cb1-2" tabindex="-1"></a><span class="fu">library</span>(tidyverse) <span class="co"># the tidyverse</span></span>
<span id="cb1-3"><a href="s01.html#cb1-3" tabindex="-1"></a><span class="fu">library</span>(viridis) <span class="co"># viridis colors</span></span>
<span id="cb1-4"><a href="s01.html#cb1-4" tabindex="-1"></a><span class="fu">library</span>(harrypotter) <span class="co"># hp colors</span></span>
<span id="cb1-5"><a href="s01.html#cb1-5" tabindex="-1"></a><span class="fu">library</span>(RColorBrewer) <span class="co"># brewer colors</span></span>
<span id="cb1-6"><a href="s01.html#cb1-6" tabindex="-1"></a><span class="fu">library</span>(scales) <span class="co"># work with number and plot scales</span></span>
<span id="cb1-7"><a href="s01.html#cb1-7" tabindex="-1"></a><span class="fu">library</span>(latex2exp)</span>
<span id="cb1-8"><a href="s01.html#cb1-8" tabindex="-1"></a></span>
<span id="cb1-9"><a href="s01.html#cb1-9" tabindex="-1"></a><span class="co"># visualization</span></span>
<span id="cb1-10"><a href="s01.html#cb1-10" tabindex="-1"></a><span class="fu">library</span>(mapview) <span class="co"># interactive html maps</span></span>
<span id="cb1-11"><a href="s01.html#cb1-11" tabindex="-1"></a><span class="fu">library</span>(kableExtra) <span class="co"># tables</span></span>
<span id="cb1-12"><a href="s01.html#cb1-12" tabindex="-1"></a><span class="fu">library</span>(patchwork) <span class="co"># combine plots</span></span>
<span id="cb1-13"><a href="s01.html#cb1-13" tabindex="-1"></a><span class="fu">library</span>(ggnewscale) <span class="co"># ggnewscale</span></span>
<span id="cb1-14"><a href="s01.html#cb1-14" tabindex="-1"></a><span class="fu">library</span>(plot3D) <span class="co"># 3d plotting</span></span>
<span id="cb1-15"><a href="s01.html#cb1-15" tabindex="-1"></a><span class="fu">library</span>(rgl) <span class="co"># rgl plotting</span></span>
<span id="cb1-16"><a href="s01.html#cb1-16" tabindex="-1"></a></span>
<span id="cb1-17"><a href="s01.html#cb1-17" tabindex="-1"></a><span class="co"># spatial analysis</span></span>
<span id="cb1-18"><a href="s01.html#cb1-18" tabindex="-1"></a><span class="fu">library</span>(terra) <span class="co"># raster</span></span>
<span id="cb1-19"><a href="s01.html#cb1-19" tabindex="-1"></a><span class="fu">library</span>(sf) <span class="co"># simple features</span></span>
<span id="cb1-20"><a href="s01.html#cb1-20" tabindex="-1"></a><span class="fu">library</span>(lidR) <span class="co"># lidar data</span></span>
<span id="cb1-21"><a href="s01.html#cb1-21" tabindex="-1"></a></span>
<span id="cb1-22"><a href="s01.html#cb1-22" tabindex="-1"></a><span class="co"># models</span></span>
<span id="cb1-23"><a href="s01.html#cb1-23" tabindex="-1"></a><span class="fu">library</span>(brms) <span class="co"># bayesian modelling</span></span>
<span id="cb1-24"><a href="s01.html#cb1-24" tabindex="-1"></a></span>
<span id="cb1-25"><a href="s01.html#cb1-25" tabindex="-1"></a><span class="co"># utilities</span></span>
<span id="cb1-26"><a href="s01.html#cb1-26" tabindex="-1"></a><span class="fu">library</span>(rvest) <span class="co"># web scraping</span></span></code></pre></div>
<p>Load the libraries from GitHub. Here we’ll load:</p>
<ul>
<li><a href="https://github.com/weecology/NeonTreeEvaluation_package"><code>NeonTreeEvaluation</code></a>: benchmark data set to evaluate lidar-based tree detection (<a href="https://scholar.google.com/scholar?cluster=4986448711981898434&amp;hl=en&amp;as_sdt=0,6">Weinstein et al. 2021</a>)</li>
<li><a href="https://github.com/georgewoolsey/cloud2trees"><code>cloud2trees</code></a>: routines for processing point cloud data collected by airborne lidar to detect forest trees (Woolsey and Tinkham, 2024)</li>
<li><a href="https://github.com/olgaviedma/LadderFuelsR"><code>LadderFuelsR</code></a>: vertical fuel continuity quantification and crown base height (CBH) calculation (<a href="https://doi.org/10.1111/2041-210X.14427">Viedma et al. 2024</a>)</li>
<li><a href="https://github.com/r-lidar/lasR"><code>lasR</code></a>: complex processing pipelines on lidar data (<a href="https://r-lidar.github.io/lasR/index.html">Roussel 2024</a>)</li>
<li><a href="https://github.com/DRAAlmeida/leafR"><code>leafR</code></a>: set of functions for analyzing the ecological structure of forests based on LAI and LAD measures derived from LiDAR data (<a href="https://r-lidar.github.io/lasR/index.html">Roussel 2024</a>). Data from this package used in the <code>LadderFuelsR</code> workflow even though this process is never explained by Viedma et al. 2024.</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="s01.html#cb2-1" tabindex="-1"></a><span class="fu">library</span>(pak)</span>
<span id="cb2-2"><a href="s01.html#cb2-2" tabindex="-1"></a><span class="co"># load them</span></span>
<span id="cb2-3"><a href="s01.html#cb2-3" tabindex="-1"></a><span class="fu">c</span>(<span class="st">&quot;NeonTreeEvaluation&quot;</span>, <span class="st">&quot;cloud2trees&quot;</span>, <span class="st">&quot;LadderFuelsR&quot;</span>, <span class="st">&quot;lasR&quot;</span>, <span class="st">&quot;leafR&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb2-4"><a href="s01.html#cb2-4" tabindex="-1"></a><span class="co"># install and load</span></span>
<span id="cb2-5"><a href="s01.html#cb2-5" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(<span class="cf">function</span>(x){</span>
<span id="cb2-6"><a href="s01.html#cb2-6" tabindex="-1"></a>    <span class="co"># locations</span></span>
<span id="cb2-7"><a href="s01.html#cb2-7" tabindex="-1"></a>    df <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb2-8"><a href="s01.html#cb2-8" tabindex="-1"></a>      <span class="at">p =</span> <span class="fu">c</span>(<span class="st">&quot;NeonTreeEvaluation&quot;</span>, <span class="st">&quot;cloud2trees&quot;</span>, <span class="st">&quot;LadderFuelsR&quot;</span>, <span class="st">&quot;lasR&quot;</span>, <span class="st">&quot;leafR&quot;</span>)</span>
<span id="cb2-9"><a href="s01.html#cb2-9" tabindex="-1"></a>      , <span class="at">l =</span> <span class="fu">c</span>(</span>
<span id="cb2-10"><a href="s01.html#cb2-10" tabindex="-1"></a>        <span class="st">&quot;weecology/NeonTreeEvaluation_package&quot;</span></span>
<span id="cb2-11"><a href="s01.html#cb2-11" tabindex="-1"></a>        , <span class="st">&quot;georgewoolsey/cloud2trees&quot;</span></span>
<span id="cb2-12"><a href="s01.html#cb2-12" tabindex="-1"></a>        , <span class="st">&quot;olgaviedma/LadderFuelsR&quot;</span></span>
<span id="cb2-13"><a href="s01.html#cb2-13" tabindex="-1"></a>        , <span class="st">&quot;r-lidar/lasR&quot;</span></span>
<span id="cb2-14"><a href="s01.html#cb2-14" tabindex="-1"></a>        , <span class="st">&quot;DRAAlmeida/leafR&quot;</span></span>
<span id="cb2-15"><a href="s01.html#cb2-15" tabindex="-1"></a>      )</span>
<span id="cb2-16"><a href="s01.html#cb2-16" tabindex="-1"></a>    )</span>
<span id="cb2-17"><a href="s01.html#cb2-17" tabindex="-1"></a>    <span class="co"># install if needed</span></span>
<span id="cb2-18"><a href="s01.html#cb2-18" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(x, <span class="at">character.only =</span> T)){</span>
<span id="cb2-19"><a href="s01.html#cb2-19" tabindex="-1"></a>      pak<span class="sc">::</span><span class="fu">pkg_install</span>(</span>
<span id="cb2-20"><a href="s01.html#cb2-20" tabindex="-1"></a>        <span class="at">pkg =</span> df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="fu">tolower</span>(p)<span class="sc">==</span><span class="fu">tolower</span>(x)) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">pull</span>(l)</span>
<span id="cb2-21"><a href="s01.html#cb2-21" tabindex="-1"></a>        , <span class="at">upgrade =</span> T</span>
<span id="cb2-22"><a href="s01.html#cb2-22" tabindex="-1"></a>      )</span>
<span id="cb2-23"><a href="s01.html#cb2-23" tabindex="-1"></a>    }</span>
<span id="cb2-24"><a href="s01.html#cb2-24" tabindex="-1"></a>    <span class="co"># load</span></span>
<span id="cb2-25"><a href="s01.html#cb2-25" tabindex="-1"></a>    <span class="fu">library</span>(x, <span class="at">character.only =</span> T)</span>
<span id="cb2-26"><a href="s01.html#cb2-26" tabindex="-1"></a>  })</span></code></pre></div>
<div id="neontreeevaluation" class="section level2 hasAnchor" number="2.1">
<h2><span class="header-section-number">2.1</span> <code id="neon">NeonTreeEvaluation</code><a href="s01.html#neontreeevaluation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Weinstein et al. (<a href="https://scholar.google.com/scholar?cluster=4986448711981898434&amp;hl=en&amp;as_sdt=0,6">2021</a>) developed:</p>
<blockquote>
<p>a benchmark dataset of individual canopy crowns derived from multi-sensor imagery in the National Ecological Observatory Network (Table 1) that provides: 1) co-registered remote sensing data from multiple sensors (LiDAR, RGB imagery, and hyperspectral imagery) to allow comparisons of methods based on any single sensor (e.g., for LiDAR based methods), or any combination of sensors (e.g., combining RGB and hyperspectral), and 2) three types of evaluation data to allow assessing both ‘tree detection’, defined as the identifying the location of individual trees using evaluation data with a point at the crown center , and ‘crown delineation’ defined as identifying the boundary edge of crowns across a broad range of forest types. The benchmark is designed to allow flexibility in both workflow and sensor selection. (p. 2)</p>
</blockquote>
<p><strong>Table 1.</strong> Summary of datasets included in the benchmark dataset. All sensor data has been cropped to the extent of NEON field sampling plots.</p>
<p><img src="../data/journal.pcbi.1009180.t001.PNG" width="100%" height="100%" style="display: block; margin: auto;" /></p>
<p>The objective of the present analysis is to evaluate the use of this benchmark data set (<a href="https://scholar.google.com/scholar?cluster=4986448711981898434&amp;hl=en&amp;as_sdt=0,6">Weinstein et al. 2021</a>) for a scientific publication describing a workflow to ingest raw LiDAR data and export a tabular tree list for use as an input to the QUIC-Fire physics-based fire spread model (<a href="https://scholar.google.com/scholar?cluster=5135309566348498660&amp;hl=en&amp;as_sdt=0,6">Linn et al. 2020</a>).</p>
<p>Weinstein et al. (<a href="https://scholar.google.com/scholar?cluster=4986448711981898434&amp;hl=en&amp;as_sdt=0,6">2021</a>) describe the LiDAR data in the benchmark data set:</p>
<blockquote>
<p>The LiDAR data are 3D coordinates (~5 points/m2) that provide high resolution information about canopy crown shape and height. LiDAR data are stored as 1000m x 1000m.laz files (Fig 2). These files contain the x,y,z coordinates for each return, as well as metadata on return intensity and point classification. Boundaries of individual canopy crowns are often apparent due to gaps among neighboring trees or differences in height among overlapping canopy crowns. For more information on NEON LiDAR data processing see NEON technical document NEON.DOC.001292. Due to the large spatial coverage of the collection effort, the point density of the NEON LiDAR clouds is much lower than the point density used for most studies of crown detection models ([20, 21]; point densities of 8–1000 pt/m2). (p. 4)</p>
</blockquote>
<p>what’s in this package?</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="s01.html#cb3-1" tabindex="-1"></a><span class="fu">lsf.str</span>(<span class="st">&quot;package:NeonTreeEvaluation&quot;</span>)</span></code></pre></div>
<pre><code>## boxes_to_spatial_polygons : function (boxes, raster_object, project_boxes = TRUE)  
## canopy_model : function (las, res = 0.5)  
## check_download : function ()  
## compute_precision_recall : function (ground_truth, predictions, threshold = 0.4, summarize = TRUE)  
## download : function (training = FALSE, savedir = NULL, force = F)  
## evaluate_field_crowns : function (predictions, summarize = TRUE, show = TRUE, project = FALSE)  
## evaluate_field_stems : function (predictions, project = TRUE, show = T, summarize = T)  
## evaluate_image_crowns : function (predictions, project = FALSE, show = TRUE, summarize = TRUE)  
## field_crowns : function (x, show = TRUE, project_boxes = TRUE)  
## get_data : function (plot_name, type)  
## grand_summary : function (results, threshold = 0.4)  
## image_crowns : function (predictions, show = TRUE, project_boxes = TRUE)  
## list_annotations : function ()  
## list_chm : function ()  
## list_field_crowns : function ()  
## list_field_stems : function ()  
## list_rgb : function ()  
## load_field_crown : function (plot_name, show = TRUE)  
## load_ground_truth : function (plot_name, show = TRUE)  
## xml_parse : function (path)  
## zenodo_url : function (concept_rec_id = 3723356, rec_version = &quot;latest&quot;, rec_id = NULL)  
## zenodo_versions : function (concept_rec_id, arg_checks = TRUE)</code></pre>
<p>we first have to download evaluation data from the Zenodo archive (1GB), use the download() function to place the data in the correct package location. Download the much larger training data, set <code>training=TRUE</code>.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="s01.html#cb5-1" tabindex="-1"></a>NeonTreeEvaluation<span class="sc">::</span><span class="fu">download</span>(<span class="at">training =</span> T, <span class="at">force =</span> F)</span></code></pre></div>
<pre><code>## NULL</code></pre>
<p>what data is in this package?</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="s01.html#cb7-1" tabindex="-1"></a><span class="co"># what/where is this data</span></span>
<span id="cb7-2"><a href="s01.html#cb7-2" tabindex="-1"></a><span class="fu">paste0</span>(<span class="fu">system.file</span>(<span class="at">package =</span> <span class="st">&quot;NeonTreeEvaluation&quot;</span>),<span class="st">&quot;/extdata/&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb7-3"><a href="s01.html#cb7-3" tabindex="-1"></a>  <span class="fu">list.files</span>(<span class="at">recursive =</span> T, <span class="at">pattern =</span> <span class="st">&quot;.*</span><span class="sc">\\</span><span class="st">.(laz|las)$&quot;</span>, <span class="at">full.names =</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb7-4"><a href="s01.html#cb7-4" tabindex="-1"></a>  <span class="fu">sample</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb7-5"><a href="s01.html#cb7-5" tabindex="-1"></a>  .[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]</span></code></pre></div>
<pre><code>##  [1] &quot;NeonTreeEvaluation/evaluation/LiDAR/BONA_023_2019.laz&quot;  
##  [2] &quot;NeonTreeEvaluation/evaluation/LiDAR/RMNP_003_2018.laz&quot;  
##  [3] &quot;NeonTreeEvaluation/evaluation/LiDAR/SJER_055_2018.laz&quot;  
##  [4] &quot;NeonTreeEvaluation/evaluation/LiDAR/BLAN_012_2019.laz&quot;  
##  [5] &quot;NeonTreeEvaluation/evaluation/LiDAR/MOAB_028_2019.laz&quot;  
##  [6] &quot;NeonTreeEvaluation/evaluation/LiDAR/YELL_023_2020.laz&quot;  
##  [7] &quot;NeonTreeEvaluation/evaluation/LiDAR/unnamed_plot_89.las&quot;
##  [8] &quot;NeonTreeEvaluation/evaluation/LiDAR/CLBJ_040_2019.laz&quot;  
##  [9] &quot;NeonTreeEvaluation/evaluation/LiDAR/OSBS_015_2019.laz&quot;  
## [10] &quot;NeonTreeEvaluation/evaluation/LiDAR/TALL_012_2019.laz&quot;</code></pre>
<p>For a list of NEON site abbreviations <a href="https://www.neonscience.org/field-sites/field-sites-map">https://www.neonscience.org/field-sites/field-sites-map</a></p>
<p><code>NeonTreeEvaluation::list_annotations</code> looks into package contents for ground truth annotations for the image-annotated crowns.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="s01.html#cb9-1" tabindex="-1"></a><span class="co"># list_annotations</span></span>
<span id="cb9-2"><a href="s01.html#cb9-2" tabindex="-1"></a>NeonTreeEvaluation<span class="sc">::</span><span class="fu">list_annotations</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb9-3"><a href="s01.html#cb9-3" tabindex="-1"></a>  <span class="fu">sample</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb9-4"><a href="s01.html#cb9-4" tabindex="-1"></a>  .[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]</span></code></pre></div>
<pre><code>##  [1] &quot;OSBS_037_2019&quot;                       
##  [2] &quot;OSBS_029_2019&quot;                       
##  [3] &quot;2018_SJER_3_253000_4105000_image_72&quot; 
##  [4] &quot;2018_TEAK_3_319000_4095000_image_175&quot;
##  [5] &quot;2018_SJER_3_252000_4108000_image_517&quot;
##  [6] &quot;SJER_015_2018&quot;                       
##  [7] &quot;WREF_072_2019&quot;                       
##  [8] &quot;DSNY_025_2018&quot;                       
##  [9] &quot;SCBI_046_2019&quot;                       
## [10] &quot;DELA_047_2019&quot;</code></pre>
<p>The field collected stems are individual points for each tree. They overlap with a subset of the sensor data. Use the <code>NeonTreeEvaluation::list_field_stems</code> function to determine which plots have stem data.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="s01.html#cb11-1" tabindex="-1"></a><span class="co"># list_field_stems</span></span>
<span id="cb11-2"><a href="s01.html#cb11-2" tabindex="-1"></a>NeonTreeEvaluation<span class="sc">::</span><span class="fu">list_field_stems</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb11-3"><a href="s01.html#cb11-3" tabindex="-1"></a>  <span class="fu">sample</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb11-4"><a href="s01.html#cb11-4" tabindex="-1"></a>  .[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]</span></code></pre></div>
<pre><code>##  [1] &quot;DELA_052&quot; &quot;GUAN_006&quot; &quot;LENO_008&quot; &quot;SERC_056&quot; &quot;SOAP_052&quot; &quot;MLBS_005&quot;
##  [7] &quot;RMNP_005&quot; &quot;TALL_001&quot; &quot;DELA_015&quot; &quot;BART_074&quot;</code></pre>
<p>The <code>NeonTreeEvaluation::crown_polygons</code> function lists “field-annotated crowns” in which an observer annotates a polygon on the remote-sensing image on a tablet while standing in the field. From Ordway Swisher Biological Station, Florida and Mountain Lake Biological Station.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="s01.html#cb13-1" tabindex="-1"></a><span class="co"># crown_polygons</span></span>
<span id="cb13-2"><a href="s01.html#cb13-2" tabindex="-1"></a>NeonTreeEvaluation<span class="sc">::</span>crown_polygons <span class="sc">%&gt;%</span> </span>
<span id="cb13-3"><a href="s01.html#cb13-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 564</code></pre>
<pre><code>## Columns: 7
## $ indvdID      &lt;chr&gt; &quot;MLBSE00007&quot;, &quot;MLBSE00012&quot;, &quot;MLBSE00027&quot;, &quot;MLBSE00049&quot;, &quot;…
## $ geometry     &lt;POLYGON [m]&gt; POLYGON ((541983.5 4136174,..., POLYGON ((542127 …
## $ plotID       &lt;fct&gt; MLBS_14, MLBS_37, MLBS_42, MLBS_1, MLBS_21, MLBS_23, MLBS…
## $ siteID       &lt;fct&gt; MLBS, MLBS, MLBS, MLBS, MLBS, MLBS, MLBS, MLBS, MLBS, MLB…
## $ utmZone      &lt;fct&gt; 17N, 17N, 17N, 17N, 17N, 17N, 17N, 17N, 17N, 17N, 17N, 17…
## $ plotEasting  &lt;dbl&gt; 541986.3, 542125.7, 542267.8, 541883.4, 542053.1, 542075.…
## $ plotNorthing &lt;dbl&gt; 4136173, 4136182, 4136994, 4136586, 4136390, 4136400, 413…</code></pre>
<p>Sites with field annotated crowns</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="s01.html#cb16-1" tabindex="-1"></a><span class="co"># crown_polygons</span></span>
<span id="cb16-2"><a href="s01.html#cb16-2" tabindex="-1"></a>NeonTreeEvaluation<span class="sc">::</span>crown_polygons <span class="sc">%&gt;%</span> </span>
<span id="cb16-3"><a href="s01.html#cb16-3" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb16-4"><a href="s01.html#cb16-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(siteID)</span></code></pre></div>
<pre><code>## # A tibble: 2 × 2
##   siteID     n
##   &lt;fct&gt;  &lt;int&gt;
## 1 MLBS     106
## 2 OSBS     458</code></pre>
<p>hmmm this data only exists for two NEON sites</p>
<p>The woody vegetation structure data contains information on field estimated height and maximum crown diameter for the majority of field collected stems. We annotated all trees in the 40x40 m plot, regardless of health status, provided they were visible in the image.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="s01.html#cb18-1" tabindex="-1"></a>NeonTreeEvaluation<span class="sc">::</span>field <span class="sc">%&gt;%</span> </span>
<span id="cb18-2"><a href="s01.html#cb18-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 37,776
## Columns: 67
## $ uid                           &lt;fct&gt; 411f5c60-79c4-41ef-b3d0-4e9b5365870e, 0d…
## $ namedLocation                 &lt;fct&gt; ABBY_063.basePlot.vst, ABBY_063.basePlot…
## $ date                          &lt;fct&gt; 2015-07-23, 2015-07-23, 2015-07-23, 2015…
## $ tagEventID                    &lt;fct&gt; vst_ABBY_2015, vst_ABBY_2015, vst_ABBY_2…
## $ domainID                      &lt;fct&gt; D16, D16, D16, D16, D16, D16, D16, D16, …
## $ siteID                        &lt;fct&gt; ABBY, ABBY, ABBY, ABBY, ABBY, ABBY, ABBY…
## $ plotID                        &lt;fct&gt; ABBY_063, ABBY_063, ABBY_063, ABBY_063, …
## $ subplotID                     &lt;int&gt; 39, 21, 21, 21, 39, 39, 39, 39, 39, 39, …
## $ nestedSubplotID               &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ pointID                       &lt;int&gt; 57, 21, 21, 21, 39, 41, 41, 41, 41, 41, …
## $ stemDistance                  &lt;dbl&gt; 3.0, 23.8, 23.8, 23.8, 26.2, 16.0, 16.0,…
## $ stemAzimuth                   &lt;dbl&gt; 111.0, 50.0, 50.0, 50.0, 45.4, 346.0, 34…
## $ recordType                    &lt;fct&gt; , , , , , , , , , , , , , , , , , , , , …
## $ individualID                  &lt;fct&gt; NEON.PLA.D16.ABBY.00441, NEON.PLA.D16.AB…
## $ supportingStemIndividualID    &lt;fct&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ previouslyTaggedAs            &lt;fct&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ samplingProtocolVersion       &lt;fct&gt; NEON.DOC.000987vE, NEON.DOC.000987vE, NE…
## $ taxonID                       &lt;fct&gt; PSMEM, PSMEM, PSMEM, PSMEM, PSMEM, PSMEM…
## $ scientificName                &lt;fct&gt; &quot;Pseudotsuga menziesii (Mirb.) Franco va…
## $ taxonRank                     &lt;fct&gt; variety, variety, variety, variety, vari…
## $ identificationReferences      &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ morphospeciesID               &lt;fct&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ morphospeciesIDRemarks        &lt;fct&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ identificationQualifier       &lt;fct&gt; , , , , , , , , , , , , , , , , , , , , …
## $ remarks                       &lt;fct&gt; &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;corrected using 201…
## $ measuredBy                    &lt;fct&gt; krian@neoninc.org, krian@neoninc.org, kr…
## $ recordedBy                    &lt;fct&gt; kzias@field-ops.org, kzias@field-ops.org…
## $ dataQF                        &lt;fct&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ plotType                      &lt;fct&gt; tower, tower, tower, tower, tower, tower…
## $ subtype                       &lt;fct&gt; basePlot, basePlot, basePlot, basePlot, …
## $ plotLatitude                  &lt;dbl&gt; 45.76074, 45.76037, 45.76037, 45.76037, …
## $ plotLongitude                 &lt;dbl&gt; -122.3303, -122.3303, -122.3303, -122.33…
## $ datum                         &lt;fct&gt; WGS84, WGS84, WGS84, WGS84, WGS84, WGS84…
## $ utmZone                       &lt;fct&gt; 10N, 10N, 10N, 10N, 10N, 10N, 10N, 10N, …
## $ plotEasting                   &lt;dbl&gt; 552081.2, 552079.1, 552079.1, 552079.1, …
## $ plotNorthing                  &lt;dbl&gt; 5067683, 5067642, 5067642, 5067642, 5067…
## $ horzUncert                    &lt;dbl&gt; 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10…
## $ crdSource                     &lt;fct&gt; Geo 7X, Geo 7X, Geo 7X, Geo 7X, Geo 7X, …
## $ elevation                     &lt;dbl&gt; 363.22, 362.29, 362.29, 362.29, 362.34, …
## $ vertUncert                    &lt;dbl&gt; 0.10, 0.10, 0.10, 0.10, 0.10, 0.10, 0.10…
## $ nlcdClass                     &lt;fct&gt; evergreenForest, evergreenForest, evergr…
## $ appMods                       &lt;fct&gt; bbc|bgc|cdw|cfc|dhp|hbp|ltr|sme|vst, bbc…
## $ geometry                      &lt;fct&gt; &quot;c(-122.330278, 45.76074)&quot;, &quot;c(-122.3303…
## $ itcEasting                    &lt;dbl&gt; 552084.0, 552097.3, 552097.3, 552097.3, …
## $ itcNorthing                   &lt;dbl&gt; 5067682, 5067657, 5067657, 5067657, 5067…
## $ itcLongitude                  &lt;dbl&gt; -122.3302, -122.3301, -122.3301, -122.33…
## $ itcLatitude                   &lt;dbl&gt; 45.76073, 45.76051, 45.76051, 45.76051, …
## $ eventID                       &lt;fct&gt; vst_ABBY_2015, vst_ABBY_2016, vst_ABBY_2…
## $ tempShrubStemID               &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ tagStatus                     &lt;fct&gt; NA, ok, ok, ok, NA, NA, ok, ok, ok, NA, …
## $ growthForm                    &lt;fct&gt; single bole tree, single bole tree, sing…
## $ plantStatus                   &lt;fct&gt; &quot;Standing dead&quot;, &quot;Standing dead&quot;, &quot;Dead,…
## $ stemDiameter                  &lt;dbl&gt; 40.0, 90.0, 89.1, 88.3, 105.0, 28.3, 29.…
## $ measurementHeight             &lt;int&gt; 130, 130, 130, 130, 130, 130, 140, 130, …
## $ height                        &lt;dbl&gt; NA, 7.5, 6.7, 6.8, NA, NA, NA, 22.5, 21.…
## $ baseCrownHeight               &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ breakHeight                   &lt;dbl&gt; NA, NA, NA, 6.8, NA, NA, NA, NA, NA, NA,…
## $ breakDiameter                 &lt;dbl&gt; NA, NA, 61, NA, NA, NA, NA, NA, NA, NA, …
## $ maxCrownDiameter              &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ ninetyCrownDiameter           &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ canopyPosition                &lt;fct&gt; NA, , NA, NA, NA, NA, , NA, NA, NA, , NA…
## $ shape                         &lt;fct&gt; , , , , , , , , , , , , , , , , , , , , …
## $ basalStemDiameter             &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ basalStemDiameterMsrmntHeight &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ maxBaseCrownDiameter          &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ ninetyBaseCrownDiameter       &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ area                          &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …</code></pre>
<p>Nice, there appears to be some useful data in here: <code>uid</code>, <code>siteID</code>, <code>plotID</code>, <code>stemDiameter</code>, <code>height</code>, <code>maxCrownDiameter</code>, <code>ninetyCrownDiameter</code>, <code>baseCrownHeight</code>, <code>plantStatus</code>, <code>taxonID</code></p>
<p>Also, I just found that there is a hidden function in the package to filter the field tree data</p>
<p>…except for I’m going to change the minimum diameter from 15 cm to 10 cm</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="s01.html#cb20-1" tabindex="-1"></a>clean_field_data<span class="ot">&lt;-</span><span class="cf">function</span>(field){</span>
<span id="cb20-2"><a href="s01.html#cb20-2" tabindex="-1"></a>  field<span class="sc">$</span>area<span class="ot">&lt;-</span>field<span class="sc">$</span>maxCrownDiameter<span class="sc">*</span>field<span class="sc">$</span>ninetyCrownDiameter</span>
<span id="cb20-3"><a href="s01.html#cb20-3" tabindex="-1"></a>  field<span class="ot">&lt;-</span>field <span class="sc">%&gt;%</span>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(itcEasting),<span class="sc">!</span>stringr<span class="sc">::</span><span class="fu">str_detect</span>(eventID,<span class="st">&quot;2014&quot;</span>),growthForm <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;single bole tree&quot;</span>,<span class="st">&quot;multi-bole tree&quot;</span>,<span class="st">&quot;small tree&quot;</span>,<span class="st">&quot;sapling&quot;</span>),stemDiameter<span class="sc">&gt;</span><span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb20-4"><a href="s01.html#cb20-4" tabindex="-1"></a>    <span class="fu">droplevels</span>() <span class="sc">%&gt;%</span></span>
<span id="cb20-5"><a href="s01.html#cb20-5" tabindex="-1"></a>    <span class="fu">filter</span>(height<span class="sc">&gt;</span><span class="dv">3</span><span class="sc">|</span><span class="fu">is.na</span>(height))</span>
<span id="cb20-6"><a href="s01.html#cb20-6" tabindex="-1"></a></span>
<span id="cb20-7"><a href="s01.html#cb20-7" tabindex="-1"></a>  <span class="co">#Limit difference in heights</span></span>
<span id="cb20-8"><a href="s01.html#cb20-8" tabindex="-1"></a>  to_remove<span class="ot">&lt;-</span>field <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(individualID) <span class="sc">%&gt;%</span></span>
<span id="cb20-9"><a href="s01.html#cb20-9" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">mean=</span><span class="fu">mean</span>(height),<span class="at">sum_difference =</span> <span class="fu">abs</span>(<span class="fu">sum</span>(<span class="fu">diff</span>(height)))) <span class="sc">%&gt;%</span></span>
<span id="cb20-10"><a href="s01.html#cb20-10" tabindex="-1"></a>    <span class="fu">filter</span>(sum_difference <span class="sc">&gt;</span> <span class="dv">8</span>)</span>
<span id="cb20-11"><a href="s01.html#cb20-11" tabindex="-1"></a>  field<span class="ot">&lt;-</span>field <span class="sc">%&gt;%</span></span>
<span id="cb20-12"><a href="s01.html#cb20-12" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span>individualID <span class="sc">%in%</span> to_remove<span class="sc">$</span>individualID)</span>
<span id="cb20-13"><a href="s01.html#cb20-13" tabindex="-1"></a>}</span></code></pre></div>
<p>clean this data and filter it</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="s01.html#cb21-1" tabindex="-1"></a><span class="co"># filter it</span></span>
<span id="cb21-2"><a href="s01.html#cb21-2" tabindex="-1"></a>field_trees <span class="ot">&lt;-</span> NeonTreeEvaluation<span class="sc">::</span>field <span class="sc">%&gt;%</span> </span>
<span id="cb21-3"><a href="s01.html#cb21-3" tabindex="-1"></a>  <span class="fu">clean_field_data</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb21-4"><a href="s01.html#cb21-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb21-5"><a href="s01.html#cb21-5" tabindex="-1"></a>    uid, siteID, plotID, stemDiameter</span>
<span id="cb21-6"><a href="s01.html#cb21-6" tabindex="-1"></a>    , height, maxCrownDiameter, ninetyCrownDiameter</span>
<span id="cb21-7"><a href="s01.html#cb21-7" tabindex="-1"></a>    , baseCrownHeight, plantStatus, taxonID</span>
<span id="cb21-8"><a href="s01.html#cb21-8" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb21-9"><a href="s01.html#cb21-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(maxCrownDiameter) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(height)) <span class="sc">%&gt;%</span> </span>
<span id="cb21-10"><a href="s01.html#cb21-10" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">CrownRadius =</span> maxCrownDiameter<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb21-11"><a href="s01.html#cb21-11" tabindex="-1"></a><span class="co"># see it</span></span>
<span id="cb21-12"><a href="s01.html#cb21-12" tabindex="-1"></a>field_trees <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 6,878
## Columns: 11
## $ uid                 &lt;fct&gt; b4305401-a7d9-4e79-afc4-a7f0c82e98d3, 346b66a5-cd8…
## $ siteID              &lt;fct&gt; ABBY, ABBY, ABBY, ABBY, ABBY, ABBY, ABBY, ABBY, AB…
## $ plotID              &lt;fct&gt; ABBY_007, ABBY_007, ABBY_007, ABBY_007, ABBY_007, …
## $ stemDiameter        &lt;dbl&gt; 68.2, 54.1, 54.7, 58.0, 68.1, 20.2, 15.6, 19.6, 18…
## $ height              &lt;dbl&gt; 49.6, 13.1, 22.9, 35.6, 50.2, 19.0, 10.8, 12.5, 9.…
## $ maxCrownDiameter    &lt;dbl&gt; 9.7, 3.2, 9.1, 9.5, 11.3, 8.6, 4.5, 4.7, 5.2, 4.3,…
## $ ninetyCrownDiameter &lt;dbl&gt; 8.5, 0.0, 7.8, 7.9, 6.7, 7.6, 4.2, 4.5, 4.8, 3.8, …
## $ baseCrownHeight     &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…
## $ plantStatus         &lt;fct&gt; &quot;Live&quot;, &quot;Dead, broken bole&quot;, &quot;Live&quot;, &quot;Live&quot;, &quot;Live…
## $ taxonID             &lt;fct&gt; PSMEM, PSMEM, PSMEM, PSMEM, PSMEM, PSMEM, PSMEM, P…
## $ CrownRadius         &lt;dbl&gt; 4.85, 1.60, 4.55, 4.75, 5.65, 4.30, 2.25, 2.35, 2.…</code></pre>
<p>what are these data?</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="s01.html#cb23-1" tabindex="-1"></a>field_trees <span class="sc">%&gt;%</span> </span>
<span id="cb23-2"><a href="s01.html#cb23-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(dplyr<span class="sc">::</span><span class="fu">where</span>(is.numeric)) <span class="sc">%&gt;%</span> </span>
<span id="cb23-3"><a href="s01.html#cb23-3" tabindex="-1"></a>  <span class="fu">summary</span>()</span></code></pre></div>
<pre><code>##   stemDiameter        height      maxCrownDiameter ninetyCrownDiameter
##  Min.   : 15.10   Min.   : 3.10   Min.   : 0.100   Min.   : 0.000     
##  1st Qu.: 18.60   1st Qu.: 9.90   1st Qu.: 3.800   1st Qu.: 2.900     
##  Median : 23.30   Median :13.30   Median : 6.200   Median : 4.700     
##  Mean   : 27.44   Mean   :14.97   Mean   : 6.975   Mean   : 5.296     
##  3rd Qu.: 31.80   3rd Qu.:18.90   3rd Qu.: 9.200   3rd Qu.: 7.000     
##  Max.   :255.00   Max.   :52.90   Max.   :62.000   Max.   :31.000     
##                                                    NA&#39;s   :115        
##  baseCrownHeight  CrownRadius    
##  Min.   : NA     Min.   : 0.050  
##  1st Qu.: NA     1st Qu.: 1.900  
##  Median : NA     Median : 3.100  
##  Mean   :NaN     Mean   : 3.487  
##  3rd Qu.: NA     3rd Qu.: 4.600  
##  Max.   : NA     Max.   :31.000  
##  NA&#39;s   :6878</code></pre>
<p>status?</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="s01.html#cb25-1" tabindex="-1"></a>field_trees <span class="sc">%&gt;%</span> </span>
<span id="cb25-2"><a href="s01.html#cb25-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(plantStatus)</span></code></pre></div>
<pre><code>##                 plantStatus    n
## 1         Dead, broken bole   75
## 2                    Downed    2
## 3                      Live 5486
## 4       Live,  other damage  135
## 5         Live, broken bole   43
## 6     Live, disease damaged  199
## 7      Live, insect damaged  157
## 8  Live, physically damaged  154
## 9       No longer qualifies   12
## 10                  Removed    1
## 11            Standing dead  614</code></pre>
<p>keep only live</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="s01.html#cb27-1" tabindex="-1"></a>field_trees <span class="ot">&lt;-</span> field_trees <span class="sc">%&gt;%</span> </span>
<span id="cb27-2"><a href="s01.html#cb27-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(plantStatus <span class="sc">%&gt;%</span> <span class="fu">tolower</span>() <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_starts</span>(<span class="st">&quot;live&quot;</span>))</span></code></pre></div>
<p>taxonID?</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="s01.html#cb28-1" tabindex="-1"></a>field_trees <span class="sc">%&gt;%</span> </span>
<span id="cb28-2"><a href="s01.html#cb28-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(taxonID) <span class="sc">%&gt;%</span> </span>
<span id="cb28-3"><a href="s01.html#cb28-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb28-4"><a href="s01.html#cb28-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">20</span>)</span></code></pre></div>
<pre><code>##    taxonID   n
## 1    PICOL 535
## 2     PIEN 500
## 3     ACRU 367
## 4    ABLAL 333
## 5     LITU 270
## 6     QURU 267
## 7    LIST2 238
## 8     TSCA 211
## 9     QUAL 197
## 10   PIPA2 177
## 11   ACSA3 137
## 12   PIFL2 132
## 13   OXYDE 117
## 14   PSMEM  96
## 15    PITA  95
## 16    PSME  91
## 17   CATO6  88
## 18    PIMA  84
## 19   POTR5  81
## 20   JUNIP  80</code></pre>
<p>let’s see the height versus diameter relationship</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="s01.html#cb30-1" tabindex="-1"></a>field_trees <span class="sc">%&gt;%</span> </span>
<span id="cb30-2"><a href="s01.html#cb30-2" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> height, <span class="at">y =</span> stemDiameter)) <span class="sc">+</span></span>
<span id="cb30-3"><a href="s01.html#cb30-3" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb30-4"><a href="s01.html#cb30-4" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="cn">NA</span>)) <span class="sc">+</span></span>
<span id="cb30-5"><a href="s01.html#cb30-5" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="cn">NA</span>)) <span class="sc">+</span></span>
<span id="cb30-6"><a href="s01.html#cb30-6" tabindex="-1"></a>  <span class="fu">theme_light</span>()</span></code></pre></div>
<p><img src="uas_sfm_tree_detection_files/figure-html/unnamed-chunk-19-1.png" width="1008" /></p>
<p>let’s get conifer trees only???</p>
<p>….sure, i found a NEON plant list with the codes: <a href="https://data.neonscience.org/taxonomic-lists?taxonTypeCode=PLANT">https://data.neonscience.org/taxonomic-lists?taxonTypeCode=PLANT</a></p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="s01.html#cb31-1" tabindex="-1"></a>conifer_spp <span class="ot">&lt;-</span></span>
<span id="cb31-2"><a href="s01.html#cb31-2" tabindex="-1"></a>  readr<span class="sc">::</span><span class="fu">read_csv</span>(</span>
<span id="cb31-3"><a href="s01.html#cb31-3" tabindex="-1"></a>    <span class="st">&quot;../data/OS_TAXON_PLANT-20220330T142149.csv&quot;</span></span>
<span id="cb31-4"><a href="s01.html#cb31-4" tabindex="-1"></a>    , <span class="at">show_col_types =</span> F</span>
<span id="cb31-5"><a href="s01.html#cb31-5" tabindex="-1"></a>    , <span class="at">progress =</span> F</span>
<span id="cb31-6"><a href="s01.html#cb31-6" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb31-7"><a href="s01.html#cb31-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb31-8"><a href="s01.html#cb31-8" tabindex="-1"></a>    <span class="fu">tolower</span>(family) <span class="sc">%in%</span> <span class="fu">c</span>(</span>
<span id="cb31-9"><a href="s01.html#cb31-9" tabindex="-1"></a>      <span class="st">&quot;pinaceae&quot;</span>, <span class="st">&quot;podocarpaceae&quot;</span>, <span class="st">&quot;araucariaceae&quot;</span></span>
<span id="cb31-10"><a href="s01.html#cb31-10" tabindex="-1"></a>      , <span class="st">&quot;taxaceae&quot;</span>, <span class="st">&quot;cephalotaxaceae&quot;</span>, <span class="st">&quot;taxodiaceae&quot;</span>, <span class="st">&quot;cupressaceae&quot;</span></span>
<span id="cb31-11"><a href="s01.html#cb31-11" tabindex="-1"></a>    )</span>
<span id="cb31-12"><a href="s01.html#cb31-12" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb31-13"><a href="s01.html#cb31-13" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb31-14"><a href="s01.html#cb31-14" tabindex="-1"></a>    <span class="at">taxonID =</span> <span class="fu">toupper</span>(taxonID)</span>
<span id="cb31-15"><a href="s01.html#cb31-15" tabindex="-1"></a>    , <span class="at">vernacularName =</span> <span class="fu">tolower</span>(vernacularName)</span>
<span id="cb31-16"><a href="s01.html#cb31-16" tabindex="-1"></a>    , <span class="at">genus =</span> stringr<span class="sc">::</span><span class="fu">str_to_title</span>(genus)</span>
<span id="cb31-17"><a href="s01.html#cb31-17" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb31-18"><a href="s01.html#cb31-18" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">distinct</span>(taxonID, vernacularName, genus)</span>
<span id="cb31-19"><a href="s01.html#cb31-19" tabindex="-1"></a><span class="co"># huh?</span></span>
<span id="cb31-20"><a href="s01.html#cb31-20" tabindex="-1"></a>conifer_spp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">10</span>)</span></code></pre></div>
<pre><code>## # A tibble: 10 × 3
##    taxonID  vernacularName                genus         
##    &lt;chr&gt;    &lt;chr&gt;                         &lt;chr&gt;         
##  1 TAAS     pond cypress                  Taxodium      
##  2 PIWA3    bhutan pine                   Pinus         
##  3 ABIESSPP fir                           Abies         
##  4 HEAB2    santa cruz cypress            Hesperocyparis
##  5 HEFO10   tecate cypress                Hesperocyparis
##  6 PODOCA   &lt;NA&gt;                          &lt;NA&gt;          
##  7 TSCA2    carolina hemlock              Tsuga         
##  8 TORRESPP torreya                       Torreya       
##  9 ABAM     pacific silver fir            Abies         
## 10 PITOI    santa cruz island torrey pine Pinus</code></pre>
<p>filter that field tree list for conifers</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="s01.html#cb33-1" tabindex="-1"></a>conifer_trees <span class="ot">&lt;-</span> field_trees <span class="sc">%&gt;%</span> </span>
<span id="cb33-2"><a href="s01.html#cb33-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(conifer_spp, <span class="at">by =</span> <span class="st">&quot;taxonID&quot;</span>)</span></code></pre></div>
<p>check those conifers height and diameter</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="s01.html#cb34-1" tabindex="-1"></a>conifer_trees <span class="sc">%&gt;%</span> </span>
<span id="cb34-2"><a href="s01.html#cb34-2" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> height, <span class="at">y =</span> stemDiameter, <span class="at">color =</span> genus)) <span class="sc">+</span></span>
<span id="cb34-3"><a href="s01.html#cb34-3" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb34-4"><a href="s01.html#cb34-4" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="cn">NA</span>)) <span class="sc">+</span></span>
<span id="cb34-5"><a href="s01.html#cb34-5" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="cn">NA</span>)) <span class="sc">+</span></span>
<span id="cb34-6"><a href="s01.html#cb34-6" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="at">facets =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(genus)) <span class="sc">+</span></span>
<span id="cb34-7"><a href="s01.html#cb34-7" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;turbo&quot;</span>) <span class="sc">+</span></span>
<span id="cb34-8"><a href="s01.html#cb34-8" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span> </span>
<span id="cb34-9"><a href="s01.html#cb34-9" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="uas_sfm_tree_detection_files/figure-html/unnamed-chunk-22-1.png" width="1008" /></p>
<p>what about this crown area data?</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="s01.html#cb35-1" tabindex="-1"></a>conifer_trees <span class="sc">%&gt;%</span> </span>
<span id="cb35-2"><a href="s01.html#cb35-2" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> CrownRadius, <span class="at">y =</span> genus, <span class="at">fill =</span> genus)) <span class="sc">+</span></span>
<span id="cb35-3"><a href="s01.html#cb35-3" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">width =</span> <span class="fl">0.7</span>, <span class="at">outliers =</span> F) <span class="sc">+</span></span>
<span id="cb35-4"><a href="s01.html#cb35-4" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_d</span>(<span class="at">option =</span> <span class="st">&quot;turbo&quot;</span>) <span class="sc">+</span></span>
<span id="cb35-5"><a href="s01.html#cb35-5" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span> </span>
<span id="cb35-6"><a href="s01.html#cb35-6" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="uas_sfm_tree_detection_files/figure-html/unnamed-chunk-23-1.png" width="1008" /></p>
<p>radius data</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="s01.html#cb36-1" tabindex="-1"></a><span class="co"># height</span></span>
<span id="cb36-2"><a href="s01.html#cb36-2" tabindex="-1"></a>conifer_trees<span class="sc">$</span>height <span class="sc">%&gt;%</span> </span>
<span id="cb36-3"><a href="s01.html#cb36-3" tabindex="-1"></a>  <span class="fu">quantile</span>(<span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.01</span>,<span class="fl">0.05</span>,<span class="fl">0.5</span>,<span class="fl">0.95</span>,<span class="fl">0.99</span>))</span></code></pre></div>
<pre><code>##     1%     5%    50%    95%    99% 
##  3.500  5.600 11.500 25.210 41.753</code></pre>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="s01.html#cb38-1" tabindex="-1"></a><span class="co"># radius</span></span>
<span id="cb38-2"><a href="s01.html#cb38-2" tabindex="-1"></a>conifer_trees<span class="sc">$</span>CrownRadius <span class="sc">%&gt;%</span> </span>
<span id="cb38-3"><a href="s01.html#cb38-3" tabindex="-1"></a>  <span class="fu">quantile</span>(<span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.01</span>,<span class="fl">0.05</span>,<span class="fl">0.5</span>,<span class="fl">0.95</span>,<span class="fl">0.99</span>))</span></code></pre></div>
<pre><code>##     1%     5%    50%    95%    99% 
## 0.8500 1.1000 2.0000 5.1000 6.6255</code></pre>
<p>let’s model crown radius based on height</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="s01.html#cb40-1" tabindex="-1"></a><span class="fu">lm</span>(<span class="at">formula =</span> CrownRadius <span class="sc">~</span> height, <span class="at">data =</span> conifer_trees) <span class="sc">%&gt;%</span> </span>
<span id="cb40-2"><a href="s01.html#cb40-2" tabindex="-1"></a>  broom<span class="sc">::</span><span class="fu">tidy</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb40-3"><a href="s01.html#cb40-3" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(<span class="at">digits =</span> <span class="dv">4</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb40-4"><a href="s01.html#cb40-4" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>()</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
term
</th>
<th style="text-align:right;">
estimate
</th>
<th style="text-align:right;">
std.error
</th>
<th style="text-align:right;">
statistic
</th>
<th style="text-align:right;">
p.value
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
(Intercept)
</td>
<td style="text-align:right;">
1.0900
</td>
<td style="text-align:right;">
0.0464
</td>
<td style="text-align:right;">
23.5090
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
height
</td>
<td style="text-align:right;">
0.1014
</td>
<td style="text-align:right;">
0.0032
</td>
<td style="text-align:right;">
31.7895
</td>
<td style="text-align:right;">
0
</td>
</tr>
</tbody>
</table>
<p>plot this</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="s01.html#cb41-1" tabindex="-1"></a>conifer_trees <span class="sc">%&gt;%</span> </span>
<span id="cb41-2"><a href="s01.html#cb41-2" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> height, <span class="at">y =</span> CrownRadius)) <span class="sc">+</span></span>
<span id="cb41-3"><a href="s01.html#cb41-3" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb41-4"><a href="s01.html#cb41-4" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>) <span class="sc">+</span></span>
<span id="cb41-5"><a href="s01.html#cb41-5" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="cn">NA</span>)) <span class="sc">+</span></span>
<span id="cb41-6"><a href="s01.html#cb41-6" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="cn">NA</span>)) <span class="sc">+</span></span>
<span id="cb41-7"><a href="s01.html#cb41-7" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span> </span>
<span id="cb41-8"><a href="s01.html#cb41-8" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="uas_sfm_tree_detection_files/figure-html/unnamed-chunk-26-1.png" width="1008" /></p>
<p>what about a non-linear model?</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="s01.html#cb42-1" tabindex="-1"></a>crown_height_model <span class="ot">&lt;-</span> brms<span class="sc">::</span><span class="fu">brm</span>(</span>
<span id="cb42-2"><a href="s01.html#cb42-2" tabindex="-1"></a>  <span class="at">formula =</span> brms<span class="sc">::</span><span class="fu">bf</span>(</span>
<span id="cb42-3"><a href="s01.html#cb42-3" tabindex="-1"></a>    <span class="at">formula =</span> CrownRadius <span class="sc">~</span> (b1 <span class="sc">*</span> height) <span class="sc">+</span> height<span class="sc">^</span>b2</span>
<span id="cb42-4"><a href="s01.html#cb42-4" tabindex="-1"></a>    , b1 <span class="sc">+</span> b2 <span class="sc">~</span> <span class="dv">1</span></span>
<span id="cb42-5"><a href="s01.html#cb42-5" tabindex="-1"></a>    , <span class="at">nl =</span> <span class="cn">TRUE</span> <span class="co"># !! specify non-linear</span></span>
<span id="cb42-6"><a href="s01.html#cb42-6" tabindex="-1"></a>  )</span>
<span id="cb42-7"><a href="s01.html#cb42-7" tabindex="-1"></a>  , <span class="at">data =</span> conifer_trees</span>
<span id="cb42-8"><a href="s01.html#cb42-8" tabindex="-1"></a>  , <span class="at">family =</span> brms<span class="sc">::</span><span class="fu">brmsfamily</span>(<span class="st">&quot;Gamma&quot;</span>)</span>
<span id="cb42-9"><a href="s01.html#cb42-9" tabindex="-1"></a>  , <span class="at">iter =</span> <span class="dv">6000</span>, <span class="at">warmup =</span> <span class="dv">3000</span>, <span class="at">chains =</span> <span class="dv">4</span></span>
<span id="cb42-10"><a href="s01.html#cb42-10" tabindex="-1"></a>  , <span class="at">cores =</span> lasR<span class="sc">::</span><span class="fu">half_cores</span>()</span>
<span id="cb42-11"><a href="s01.html#cb42-11" tabindex="-1"></a>  , <span class="at">file =</span> <span class="st">&quot;../data/crown_height_model&quot;</span></span>
<span id="cb42-12"><a href="s01.html#cb42-12" tabindex="-1"></a>)</span>
<span id="cb42-13"><a href="s01.html#cb42-13" tabindex="-1"></a><span class="co"># plot(crown_height_model)</span></span>
<span id="cb42-14"><a href="s01.html#cb42-14" tabindex="-1"></a><span class="fu">summary</span>(crown_height_model)</span></code></pre></div>
<pre><code>##  Family: gamma 
##   Links: mu = log; shape = identity 
## Formula: CrownRadius ~ (b1 * height) + height^b2 
##          b1 ~ 1
##          b2 ~ 1
##    Data: conifer_trees (Number of observations: 2750) 
##   Draws: 4 chains, each with iter = 6000; warmup = 3000; thin = 1;
##          total post-warmup draws = 12000
## 
## Regression Coefficients:
##              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## b1_Intercept     0.04      0.00     0.04     0.05 1.00     5784     6848
## b2_Intercept    -0.55      0.03    -0.61    -0.51 1.00     5397     5756
## 
## Further Distributional Parameters:
##       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## shape     5.72      0.15     5.43     6.02 1.00     6131     5494
## 
## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="s01.html#cb44-1" tabindex="-1"></a><span class="do">## write out model estimates to tabular file</span></span>
<span id="cb44-2"><a href="s01.html#cb44-2" tabindex="-1"></a><span class="do">#### extract posterior draws to a df</span></span>
<span id="cb44-3"><a href="s01.html#cb44-3" tabindex="-1"></a>brms<span class="sc">::</span><span class="fu">as_draws_df</span>(</span>
<span id="cb44-4"><a href="s01.html#cb44-4" tabindex="-1"></a>  crown_height_model</span>
<span id="cb44-5"><a href="s01.html#cb44-5" tabindex="-1"></a>  , <span class="at">variable =</span> <span class="fu">c</span>(<span class="st">&quot;^b_&quot;</span>, <span class="st">&quot;shape&quot;</span>)</span>
<span id="cb44-6"><a href="s01.html#cb44-6" tabindex="-1"></a>  , <span class="at">regex =</span> <span class="cn">TRUE</span></span>
<span id="cb44-7"><a href="s01.html#cb44-7" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb44-8"><a href="s01.html#cb44-8" tabindex="-1"></a>  <span class="co"># quick way to get a table of summary statistics and diagnostics</span></span>
<span id="cb44-9"><a href="s01.html#cb44-9" tabindex="-1"></a>  posterior<span class="sc">::</span><span class="fu">summarize_draws</span>(</span>
<span id="cb44-10"><a href="s01.html#cb44-10" tabindex="-1"></a>    <span class="st">&quot;mean&quot;</span>, <span class="st">&quot;median&quot;</span>, <span class="st">&quot;sd&quot;</span></span>
<span id="cb44-11"><a href="s01.html#cb44-11" tabindex="-1"></a>    ,  <span class="sc">~</span><span class="fu">quantile</span>(.x, <span class="at">probs =</span> <span class="fu">c</span>(</span>
<span id="cb44-12"><a href="s01.html#cb44-12" tabindex="-1"></a>      <span class="fl">0.05</span>, <span class="fl">0.95</span></span>
<span id="cb44-13"><a href="s01.html#cb44-13" tabindex="-1"></a>      , <span class="fl">0.025</span>, <span class="fl">0.975</span></span>
<span id="cb44-14"><a href="s01.html#cb44-14" tabindex="-1"></a>    ))</span>
<span id="cb44-15"><a href="s01.html#cb44-15" tabindex="-1"></a>    , <span class="st">&quot;rhat&quot;</span></span>
<span id="cb44-16"><a href="s01.html#cb44-16" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb44-17"><a href="s01.html#cb44-17" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb44-18"><a href="s01.html#cb44-18" tabindex="-1"></a>    <span class="at">variable =</span> stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(variable, <span class="st">&quot;_Intercept&quot;</span>)</span>
<span id="cb44-19"><a href="s01.html#cb44-19" tabindex="-1"></a>    , <span class="at">formula =</span> <span class="fu">summary</span>(crown_height_model)<span class="sc">$</span>formula <span class="sc">%&gt;%</span> </span>
<span id="cb44-20"><a href="s01.html#cb44-20" tabindex="-1"></a>      <span class="fu">as.character</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb44-21"><a href="s01.html#cb44-21" tabindex="-1"></a>      .[<span class="dv">1</span>]</span>
<span id="cb44-22"><a href="s01.html#cb44-22" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb44-23"><a href="s01.html#cb44-23" tabindex="-1"></a>  <span class="fu">write.csv</span>(</span>
<span id="cb44-24"><a href="s01.html#cb44-24" tabindex="-1"></a>    <span class="st">&quot;../data/crown_height_model.csv&quot;</span></span>
<span id="cb44-25"><a href="s01.html#cb44-25" tabindex="-1"></a>    , <span class="at">row.names =</span> F</span>
<span id="cb44-26"><a href="s01.html#cb44-26" tabindex="-1"></a>  )</span></code></pre></div>
<p>plot this</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="s01.html#cb45-1" tabindex="-1"></a><span class="fu">plot</span>(brms<span class="sc">::</span><span class="fu">conditional_effects</span>(crown_height_model), <span class="at">points =</span> T)</span></code></pre></div>
<p><img src="uas_sfm_tree_detection_files/figure-html/unnamed-chunk-28-1.png" width="1008" /></p>
<p>what if we try to plot it with a function using the regression coefficients?</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="s01.html#cb46-1" tabindex="-1"></a>ws_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb46-2"><a href="s01.html#cb46-2" tabindex="-1"></a>  y <span class="ot">=</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb46-3"><a href="s01.html#cb46-3" tabindex="-1"></a>    <span class="fu">is.na</span>(x) <span class="sc">~</span> <span class="fl">1e-3</span> <span class="co"># requires non-null</span></span>
<span id="cb46-4"><a href="s01.html#cb46-4" tabindex="-1"></a>    , x <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="fl">1e-3</span> <span class="co"># requires positive</span></span>
<span id="cb46-5"><a href="s01.html#cb46-5" tabindex="-1"></a>    , x <span class="sc">&lt;</span> <span class="fl">2.5</span> <span class="sc">~</span> <span class="dv">1</span> <span class="co"># set lower bound</span></span>
<span id="cb46-6"><a href="s01.html#cb46-6" tabindex="-1"></a>    , x <span class="sc">&gt;</span> <span class="dv">40</span> <span class="sc">~</span> <span class="fl">6.7</span>  <span class="co"># set upper bound</span></span>
<span id="cb46-7"><a href="s01.html#cb46-7" tabindex="-1"></a>    <span class="co"># , TRUE ~ 0.75 + (x * 0.14)</span></span>
<span id="cb46-8"><a href="s01.html#cb46-8" tabindex="-1"></a>    , <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fu">exp</span>( (<span class="fl">0.0446</span><span class="sc">*</span>x) <span class="sc">+</span> (x<span class="sc">^-</span><span class="fl">0.555</span>) ) <span class="co"># used gamma regression so exp the result</span></span>
<span id="cb46-9"><a href="s01.html#cb46-9" tabindex="-1"></a>  )</span>
<span id="cb46-10"><a href="s01.html#cb46-10" tabindex="-1"></a>  <span class="fu">return</span>(y)</span>
<span id="cb46-11"><a href="s01.html#cb46-11" tabindex="-1"></a>}</span></code></pre></div>
<p>plot it</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="s01.html#cb47-1" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">xlim</span>(<span class="dv">0</span>,<span class="dv">60</span>) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">ylim</span>(<span class="dv">0</span>,<span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb47-2"><a href="s01.html#cb47-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">data =</span> conifer_trees, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">y =</span> CrownRadius, <span class="at">x =</span> height)) <span class="sc">+</span></span>
<span id="cb47-3"><a href="s01.html#cb47-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_function</span>(<span class="at">fun =</span> ws_fn, <span class="at">lwd =</span> <span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>)</span></code></pre></div>
<p><img src="uas_sfm_tree_detection_files/figure-html/unnamed-chunk-30-1.png" width="1008" /></p>
<p><code>NeonTreeEvaluation::get_data</code> is a set of utility functions for finding the path of benchmark data on disk</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="s01.html#cb48-1" tabindex="-1"></a>NeonTreeEvaluation<span class="sc">::</span><span class="fu">get_data</span>(<span class="at">plot_name =</span> <span class="st">&quot;RMNP_047&quot;</span>, <span class="at">type =</span> <span class="st">&quot;lidar&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;C:/Program Files/R/R-4.3.0/library/NeonTreeEvaluation/extdata/NeonTreeEvaluation/evaluation/LiDAR/RMNP_047.laz&quot;</code></pre>
<p>let’s pull out all sites with <code>.laz</code> data and create a data frame for tracking purposes</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="s01.html#cb50-1" tabindex="-1"></a>las_df <span class="ot">&lt;-</span></span>
<span id="cb50-2"><a href="s01.html#cb50-2" tabindex="-1"></a>  <span class="fu">paste0</span>(<span class="fu">system.file</span>(<span class="at">package =</span> <span class="st">&quot;NeonTreeEvaluation&quot;</span>),<span class="st">&quot;/extdata/&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb50-3"><a href="s01.html#cb50-3" tabindex="-1"></a>    <span class="fu">list.files</span>(<span class="at">recursive =</span> T, <span class="at">pattern =</span> <span class="st">&quot;.*</span><span class="sc">\\</span><span class="st">.(laz|las)$&quot;</span>, <span class="at">full.names =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb50-4"><a href="s01.html#cb50-4" tabindex="-1"></a>    <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb50-5"><a href="s01.html#cb50-5" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb50-6"><a href="s01.html#cb50-6" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">f_path =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb50-7"><a href="s01.html#cb50-7" tabindex="-1"></a>    <span class="co"># create some other variables</span></span>
<span id="cb50-8"><a href="s01.html#cb50-8" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb50-9"><a href="s01.html#cb50-9" tabindex="-1"></a>      <span class="at">f_nm =</span> f_path <span class="sc">%&gt;%</span> <span class="fu">basename</span>() <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(<span class="st">&quot;</span><span class="sc">\\</span><span class="st">.(laz|las)$&quot;</span>)</span>
<span id="cb50-10"><a href="s01.html#cb50-10" tabindex="-1"></a>      , <span class="at">plot_nm =</span> f_nm <span class="sc">%&gt;%</span> <span class="co"># this matches the file name with the plot name </span></span>
<span id="cb50-11"><a href="s01.html#cb50-11" tabindex="-1"></a>        <span class="fu">toupper</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb50-12"><a href="s01.html#cb50-12" tabindex="-1"></a>        stringr<span class="sc">::</span><span class="fu">str_extract</span>(</span>
<span id="cb50-13"><a href="s01.html#cb50-13" tabindex="-1"></a>          <span class="at">pattern =</span> NeonTreeEvaluation<span class="sc">::</span><span class="fu">list_field_stems</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb50-14"><a href="s01.html#cb50-14" tabindex="-1"></a>            <span class="fu">toupper</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb50-15"><a href="s01.html#cb50-15" tabindex="-1"></a>            <span class="fu">paste</span>(<span class="at">collapse =</span> <span class="st">&quot;|&quot;</span>)</span>
<span id="cb50-16"><a href="s01.html#cb50-16" tabindex="-1"></a>        )</span>
<span id="cb50-17"><a href="s01.html#cb50-17" tabindex="-1"></a>      , <span class="at">neon_site =</span> plot_nm <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">word</span>(<span class="at">start =</span> <span class="dv">1</span>, <span class="at">sep =</span> <span class="fu">fixed</span>(<span class="st">&quot;_&quot;</span>))</span>
<span id="cb50-18"><a href="s01.html#cb50-18" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb50-19"><a href="s01.html#cb50-19" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(plot_nm)) <span class="sc">%&gt;%</span> <span class="co"># keep only las files with field stems</span></span>
<span id="cb50-20"><a href="s01.html#cb50-20" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(neon_site, plot_nm, f_nm, f_path)</span>
<span id="cb50-21"><a href="s01.html#cb50-21" tabindex="-1"></a><span class="co"># what?</span></span>
<span id="cb50-22"><a href="s01.html#cb50-22" tabindex="-1"></a>las_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 278
## Columns: 4
## $ neon_site &lt;chr&gt; &quot;ABBY&quot;, &quot;ABBY&quot;, &quot;ABBY&quot;, &quot;ABBY&quot;, &quot;ABBY&quot;, &quot;BART&quot;, &quot;BART&quot;, &quot;BAR…
## $ plot_nm   &lt;chr&gt; &quot;ABBY_003&quot;, &quot;ABBY_008&quot;, &quot;ABBY_010&quot;, &quot;ABBY_023&quot;, &quot;ABBY_068&quot;, …
## $ f_nm      &lt;chr&gt; &quot;ABBY_003_2018&quot;, &quot;ABBY_008_2018&quot;, &quot;ABBY_010_2018&quot;, &quot;ABBY_023…
## $ f_path    &lt;chr&gt; &quot;C:/Program Files/R/R-4.3.0/library/NeonTreeEvaluation/extda…</code></pre>
<div id="explore-lidar-data-from-package" class="section level3 hasAnchor" number="2.1.1">
<h3><span class="header-section-number">2.1.1</span> Explore LiDAR data from package<a href="s01.html#explore-lidar-data-from-package" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>which NEON sites have data?</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="s01.html#cb52-1" tabindex="-1"></a>las_df <span class="sc">%&gt;%</span> </span>
<span id="cb52-2"><a href="s01.html#cb52-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(neon_site) <span class="sc">%&gt;%</span> </span>
<span id="cb52-3"><a href="s01.html#cb52-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb52-4"><a href="s01.html#cb52-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">neon_site =</span> forcats<span class="sc">::</span><span class="fu">fct_reorder</span>(neon_site, n)) <span class="sc">%&gt;%</span> </span>
<span id="cb52-5"><a href="s01.html#cb52-5" tabindex="-1"></a>  <span class="co"># plot</span></span>
<span id="cb52-6"><a href="s01.html#cb52-6" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> neon_site, <span class="at">x =</span> n, <span class="at">fill =</span> n)) <span class="sc">+</span></span>
<span id="cb52-7"><a href="s01.html#cb52-7" tabindex="-1"></a>    <span class="fu">geom_col</span>(<span class="at">width =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb52-8"><a href="s01.html#cb52-8" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">&quot;NEON site&quot;</span>, <span class="at">x =</span> <span class="st">&quot;lidar data plots&quot;</span>) <span class="sc">+</span></span>
<span id="cb52-9"><a href="s01.html#cb52-9" tabindex="-1"></a>    harrypotter<span class="sc">::</span><span class="fu">scale_fill_hp</span>(<span class="st">&quot;slytherin&quot;</span>) <span class="sc">+</span></span>
<span id="cb52-10"><a href="s01.html#cb52-10" tabindex="-1"></a>    <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb52-11"><a href="s01.html#cb52-11" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="uas_sfm_tree_detection_files/figure-html/unnamed-chunk-33-1.png" width="1008" /></p>
<p>where is this data?</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="s01.html#cb53-1" tabindex="-1"></a>get_site_bbox <span class="ot">&lt;-</span> <span class="cf">function</span>(site, <span class="at">dta =</span> las_df) {</span>
<span id="cb53-2"><a href="s01.html#cb53-2" tabindex="-1"></a><span class="co"># read the las files for a site  </span></span>
<span id="cb53-3"><a href="s01.html#cb53-3" tabindex="-1"></a>  las_ctg <span class="ot">=</span> dta <span class="sc">%&gt;%</span> </span>
<span id="cb53-4"><a href="s01.html#cb53-4" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(neon_site <span class="sc">==</span> site) <span class="sc">%&gt;%</span> </span>
<span id="cb53-5"><a href="s01.html#cb53-5" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(f_path) <span class="sc">%&gt;%</span> </span>
<span id="cb53-6"><a href="s01.html#cb53-6" tabindex="-1"></a>    lidR<span class="sc">::</span><span class="fu">readLAScatalog</span>()</span>
<span id="cb53-7"><a href="s01.html#cb53-7" tabindex="-1"></a><span class="co"># bbox that site</span></span>
<span id="cb53-8"><a href="s01.html#cb53-8" tabindex="-1"></a>  <span class="cf">if</span>( <span class="fu">is.na</span>( sf<span class="sc">::</span><span class="fu">st_crs</span>(las_ctg<span class="sc">@</span>data) ) ){</span>
<span id="cb53-9"><a href="s01.html#cb53-9" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb53-10"><a href="s01.html#cb53-10" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb53-11"><a href="s01.html#cb53-11" tabindex="-1"></a>    las_ctg<span class="sc">@</span>data <span class="sc">%&gt;%</span> </span>
<span id="cb53-12"><a href="s01.html#cb53-12" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_bbox</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb53-13"><a href="s01.html#cb53-13" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_as_sfc</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb53-14"><a href="s01.html#cb53-14" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb53-15"><a href="s01.html#cb53-15" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">neon_site =</span> site)  <span class="sc">%&gt;%</span> </span>
<span id="cb53-16"><a href="s01.html#cb53-16" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_set_crs</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(las_ctg<span class="sc">@</span>data)) <span class="sc">%&gt;%</span> </span>
<span id="cb53-17"><a href="s01.html#cb53-17" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_transform</span>(<span class="at">crs =</span> <span class="fu">paste0</span>(<span class="st">&quot;EPSG:&quot;</span>, <span class="dv">5070</span>))</span>
<span id="cb53-18"><a href="s01.html#cb53-18" tabindex="-1"></a>  }</span>
<span id="cb53-19"><a href="s01.html#cb53-19" tabindex="-1"></a>}</span>
<span id="cb53-20"><a href="s01.html#cb53-20" tabindex="-1"></a><span class="co"># take this for a spin</span></span>
<span id="cb53-21"><a href="s01.html#cb53-21" tabindex="-1"></a>las_df <span class="sc">%&gt;%</span></span>
<span id="cb53-22"><a href="s01.html#cb53-22" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(neon_site) <span class="sc">%&gt;%</span></span>
<span id="cb53-23"><a href="s01.html#cb53-23" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span></span>
<span id="cb53-24"><a href="s01.html#cb53-24" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(get_site_bbox) <span class="sc">%&gt;%</span> </span>
<span id="cb53-25"><a href="s01.html#cb53-25" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">bind_rows</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb53-26"><a href="s01.html#cb53-26" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb53-27"><a href="s01.html#cb53-27" tabindex="-1"></a>    las_df <span class="sc">%&gt;%</span> </span>
<span id="cb53-28"><a href="s01.html#cb53-28" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">group_by</span>(neon_site) <span class="sc">%&gt;%</span> </span>
<span id="cb53-29"><a href="s01.html#cb53-29" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">n =</span> dplyr<span class="sc">::</span><span class="fu">n</span>())</span>
<span id="cb53-30"><a href="s01.html#cb53-30" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;neon_site&quot;</span></span>
<span id="cb53-31"><a href="s01.html#cb53-31" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb53-32"><a href="s01.html#cb53-32" tabindex="-1"></a>  <span class="fu">st_centroid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb53-33"><a href="s01.html#cb53-33" tabindex="-1"></a>  mapview<span class="sc">::</span><span class="fu">mapview</span>(</span>
<span id="cb53-34"><a href="s01.html#cb53-34" tabindex="-1"></a>    <span class="at">zcol =</span> <span class="st">&quot;n&quot;</span></span>
<span id="cb53-35"><a href="s01.html#cb53-35" tabindex="-1"></a>    , <span class="at">layer.name =</span> <span class="st">&quot;LiDAR plots&quot;</span></span>
<span id="cb53-36"><a href="s01.html#cb53-36" tabindex="-1"></a>    , <span class="at">label =</span> <span class="fu">c</span>(<span class="st">&quot;neon_site&quot;</span>)</span>
<span id="cb53-37"><a href="s01.html#cb53-37" tabindex="-1"></a>    , <span class="at">col.regions =</span> viridis<span class="sc">::</span><span class="fu">mako</span>(<span class="dv">10</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb53-38"><a href="s01.html#cb53-38" tabindex="-1"></a>  )</span></code></pre></div>
<div class="leaflet html-widget html-fill-item" id="htmlwidget-e771e7f81664d9bbc017" style="width:1008px;height:672px;"></div>
<script type="application/json" data-for="htmlwidget-e771e7f81664d9bbc017">{"x":{"options":{"minZoom":1,"maxZoom":52,"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}},"preferCanvas":false,"bounceAtZoomLimits":false,"maxBounds":[[[-90,-370]],[[90,370]]]},"calls":[{"method":"addProviderTiles","args":["OpenStreetMap","OpenStreetMap","OpenStreetMap",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["Esri.WorldImagery","Esri.WorldImagery","Esri.WorldImagery",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"createMapPane","args":["point",440]},{"method":"addCircleMarkers","args":[[45.7604365371426,44.05134228611964,39.08441923650567,65.15580106715423,32.53146987229301,35.63657407348276,17.97016335836158,42.48178459977508,63.8730700576182,31.19755391134177,18.03446131564425,31.83288133103487,37.39485338226996,29.69467221927716,19.55176532568917,40.21768034597346,38.88174906720172,38.88903715244572,37.03334948861171,32.93127899686993,37.00036908866564,46.23181219215382],[-122.354988357329,-71.28321396065959,-77.96444171329743,-147.5046299578157,-87.80909504367152,-83.55862176680898,-66.85011338901158,-72.21990895355928,-149.2878858987199,-84.46375895717473,-67.06682374881446,-88.18132552074428,-80.53072406777669,-81.97208079047266,-155.3177383431732,-105.5072086703649,-78.14448685530846,-76.55092900230224,-119.263296547448,-87.42350315755769,-119.0025432518736,-89.53653678808381],6,null,"LiDAR plots",{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}},"pane":"point","stroke":true,"color":"#333333","weight":1,"opacity":[0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9],"fill":true,"fillColor":["#79D3B3","#79D3B3","#4DC1AC","#DEF5E5","#201324","#79D3B3","#40498E","#79D3B3","#DEF5E5","#DEF5E5","#DEF5E5","#38619A","#312446","#4DC1AC","#AFE4C3","#38619A","#3C3569","#0B0405","#79D3B3","#40498E","#DEF5E5","#AFE4C3"],"fillOpacity":[0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6]},null,null,["<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>1&emsp;<\/td><\/tr><tr><td>1<\/td><th>neon_site&emsp;<\/th><td>ABBY&emsp;<\/td><\/tr><tr><td>2<\/td><th>n&emsp;<\/th><td> 5&emsp;<\/td><\/tr><tr><td>3<\/td><th>x&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>2&emsp;<\/td><\/tr><tr><td>1<\/td><th>neon_site&emsp;<\/th><td>BART&emsp;<\/td><\/tr><tr><td>2<\/td><th>n&emsp;<\/th><td> 5&emsp;<\/td><\/tr><tr><td>3<\/td><th>x&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>3&emsp;<\/td><\/tr><tr><td>1<\/td><th>neon_site&emsp;<\/th><td>BLAN&emsp;<\/td><\/tr><tr><td>2<\/td><th>n&emsp;<\/th><td> 9&emsp;<\/td><\/tr><tr><td>3<\/td><th>x&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>4&emsp;<\/td><\/tr><tr><td>1<\/td><th>neon_site&emsp;<\/th><td>BONA&emsp;<\/td><\/tr><tr><td>2<\/td><th>n&emsp;<\/th><td> 1&emsp;<\/td><\/tr><tr><td>3<\/td><th>x&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>5&emsp;<\/td><\/tr><tr><td>1<\/td><th>neon_site&emsp;<\/th><td>DELA&emsp;<\/td><\/tr><tr><td>2<\/td><th>n&emsp;<\/th><td>33&emsp;<\/td><\/tr><tr><td>3<\/td><th>x&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>6&emsp;<\/td><\/tr><tr><td>1<\/td><th>neon_site&emsp;<\/th><td>GRSM&emsp;<\/td><\/tr><tr><td>2<\/td><th>n&emsp;<\/th><td> 7&emsp;<\/td><\/tr><tr><td>3<\/td><th>x&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>7&emsp;<\/td><\/tr><tr><td>1<\/td><th>neon_site&emsp;<\/th><td>GUAN&emsp;<\/td><\/tr><tr><td>2<\/td><th>n&emsp;<\/th><td>25&emsp;<\/td><\/tr><tr><td>3<\/td><th>x&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>8&emsp;<\/td><\/tr><tr><td>1<\/td><th>neon_site&emsp;<\/th><td>HARV&emsp;<\/td><\/tr><tr><td>2<\/td><th>n&emsp;<\/th><td> 5&emsp;<\/td><\/tr><tr><td>3<\/td><th>x&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>9&emsp;<\/td><\/tr><tr><td>1<\/td><th>neon_site&emsp;<\/th><td>HEAL&emsp;<\/td><\/tr><tr><td>2<\/td><th>n&emsp;<\/th><td> 1&emsp;<\/td><\/tr><tr><td>3<\/td><th>x&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>10&emsp;<\/td><\/tr><tr><td>1<\/td><th>neon_site&emsp;<\/th><td>JERC&emsp;<\/td><\/tr><tr><td>2<\/td><th>n&emsp;<\/th><td> 1&emsp;<\/td><\/tr><tr><td>3<\/td><th>x&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>11&emsp;<\/td><\/tr><tr><td>1<\/td><th>neon_site&emsp;<\/th><td>LAJA&emsp;<\/td><\/tr><tr><td>2<\/td><th>n&emsp;<\/th><td> 1&emsp;<\/td><\/tr><tr><td>3<\/td><th>x&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>12&emsp;<\/td><\/tr><tr><td>1<\/td><th>neon_site&emsp;<\/th><td>LENO&emsp;<\/td><\/tr><tr><td>2<\/td><th>n&emsp;<\/th><td>22&emsp;<\/td><\/tr><tr><td>3<\/td><th>x&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>13&emsp;<\/td><\/tr><tr><td>1<\/td><th>neon_site&emsp;<\/th><td>MLBS&emsp;<\/td><\/tr><tr><td>2<\/td><th>n&emsp;<\/th><td>32&emsp;<\/td><\/tr><tr><td>3<\/td><th>x&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>14&emsp;<\/td><\/tr><tr><td>1<\/td><th>neon_site&emsp;<\/th><td>OSBS&emsp;<\/td><\/tr><tr><td>2<\/td><th>n&emsp;<\/th><td> 9&emsp;<\/td><\/tr><tr><td>3<\/td><th>x&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>15&emsp;<\/td><\/tr><tr><td>1<\/td><th>neon_site&emsp;<\/th><td>PUUM&emsp;<\/td><\/tr><tr><td>2<\/td><th>n&emsp;<\/th><td> 3&emsp;<\/td><\/tr><tr><td>3<\/td><th>x&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>16&emsp;<\/td><\/tr><tr><td>1<\/td><th>neon_site&emsp;<\/th><td>RMNP&emsp;<\/td><\/tr><tr><td>2<\/td><th>n&emsp;<\/th><td>21&emsp;<\/td><\/tr><tr><td>3<\/td><th>x&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>17&emsp;<\/td><\/tr><tr><td>1<\/td><th>neon_site&emsp;<\/th><td>SCBI&emsp;<\/td><\/tr><tr><td>2<\/td><th>n&emsp;<\/th><td>28&emsp;<\/td><\/tr><tr><td>3<\/td><th>x&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>18&emsp;<\/td><\/tr><tr><td>1<\/td><th>neon_site&emsp;<\/th><td>SERC&emsp;<\/td><\/tr><tr><td>2<\/td><th>n&emsp;<\/th><td>36&emsp;<\/td><\/tr><tr><td>3<\/td><th>x&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>19&emsp;<\/td><\/tr><tr><td>1<\/td><th>neon_site&emsp;<\/th><td>SOAP&emsp;<\/td><\/tr><tr><td>2<\/td><th>n&emsp;<\/th><td> 5&emsp;<\/td><\/tr><tr><td>3<\/td><th>x&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>20&emsp;<\/td><\/tr><tr><td>1<\/td><th>neon_site&emsp;<\/th><td>TALL&emsp;<\/td><\/tr><tr><td>2<\/td><th>n&emsp;<\/th><td>24&emsp;<\/td><\/tr><tr><td>3<\/td><th>x&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>21&emsp;<\/td><\/tr><tr><td>1<\/td><th>neon_site&emsp;<\/th><td>TEAK&emsp;<\/td><\/tr><tr><td>2<\/td><th>n&emsp;<\/th><td> 1&emsp;<\/td><\/tr><tr><td>3<\/td><th>x&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>22&emsp;<\/td><\/tr><tr><td>1<\/td><th>neon_site&emsp;<\/th><td>UNDE&emsp;<\/td><\/tr><tr><td>2<\/td><th>n&emsp;<\/th><td> 3&emsp;<\/td><\/tr><tr><td>3<\/td><th>x&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><\/table><\/div>"],{"maxWidth":800,"minWidth":50,"autoPan":true,"keepInView":false,"closeButton":true,"closeOnClick":true,"className":""},["ABBY","BART","BLAN","BONA","DELA","GRSM","GUAN","HARV","HEAL","JERC","LAJA","LENO","MLBS","OSBS","PUUM","RMNP","SCBI","SERC","SOAP","TALL","TEAK","UNDE"],{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addScaleBar","args":[{"maxWidth":100,"metric":true,"imperial":true,"updateWhenIdle":true,"position":"bottomleft"}]},{"method":"addLayersControl","args":[["OpenStreetMap","Esri.WorldImagery"],"LiDAR plots",{"collapsed":true,"autoZIndex":true,"position":"topleft"}]},{"method":"addLegend","args":[{"colors":["#DEF5E5 , #9CDEBD 11.4285714285714%, #4BBFAC 25.7142857142857%, #3697A8 40%, #376D9E 54.2857142857143%, #3F4485 68.5714285714286%, #322548 82.8571428571429%, #140A13 97.1428571428571%, #0B0405 "],"labels":["5","10","15","20","25","30","35"],"na_color":null,"na_label":"NA","opacity":1,"position":"topright","type":"numeric","title":"LiDAR plots","extra":{"p_1":0.1142857142857143,"p_n":0.9714285714285714},"layerId":null,"className":"info legend","group":"LiDAR plots"}]}],"limits":{"lat":[17.97016335836158,65.15580106715423],"lng":[-155.3177383431732,-66.85011338901158]},"fitBounds":[17.97016335836158,-155.3177383431732,65.15580106715423,-66.85011338901158,[]]},"evals":[],"jsHooks":{"render":[{"code":"function(el, x, data) {\n  return (\n      function(el, x, data) {\n      // get the leaflet map\n      var map = this; //HTMLWidgets.find('#' + el.id);\n      // we need a new div element because we have to handle\n      // the mouseover output separately\n      // debugger;\n      function addElement () {\n      // generate new div Element\n      var newDiv = $(document.createElement('div'));\n      // append at end of leaflet htmlwidget container\n      $(el).append(newDiv);\n      //provide ID and style\n      newDiv.addClass('lnlt');\n      newDiv.css({\n      'position': 'relative',\n      'bottomleft':  '0px',\n      'background-color': 'rgba(255, 255, 255, 0.7)',\n      'box-shadow': '0 0 2px #bbb',\n      'background-clip': 'padding-box',\n      'margin': '0',\n      'padding-left': '5px',\n      'color': '#333',\n      'font': '9px/1.5 \"Helvetica Neue\", Arial, Helvetica, sans-serif',\n      'z-index': '700',\n      });\n      return newDiv;\n      }\n\n\n      // check for already existing lnlt class to not duplicate\n      var lnlt = $(el).find('.lnlt');\n\n      if(!lnlt.length) {\n      lnlt = addElement();\n\n      // grab the special div we generated in the beginning\n      // and put the mousmove output there\n\n      map.on('mousemove', function (e) {\n      if (e.originalEvent.ctrlKey) {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                           ' lon: ' + (e.latlng.lng).toFixed(5) +\n                           ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                           ' | zoom: ' + map.getZoom() +\n                           ' | x: ' + L.CRS.EPSG3857.project(e.latlng).x.toFixed(0) +\n                           ' | y: ' + L.CRS.EPSG3857.project(e.latlng).y.toFixed(0) +\n                           ' | epsg: 3857 ' +\n                           ' | proj4: +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs ');\n      } else {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                      ' | zoom: ' + map.getZoom() + ' ');\n      }\n      });\n\n      // remove the lnlt div when mouse leaves map\n      map.on('mouseout', function (e) {\n      var strip = document.querySelector('.lnlt');\n      if( strip !==null) strip.remove();\n      });\n\n      };\n\n      //$(el).keypress(67, function(e) {\n      map.on('preclick', function(e) {\n      if (e.originalEvent.ctrlKey) {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                      ' | zoom: ' + map.getZoom() + ' ');\n      var txt = document.querySelector('.lnlt').textContent;\n      console.log(txt);\n      //txt.innerText.focus();\n      //txt.select();\n      setClipboardText('\"' + txt + '\"');\n      }\n      });\n\n      }\n      ).call(this.getMap(), el, x, data);\n}","data":null},{"code":"function(el, x, data) {\n  return (function(el,x,data){\n           var map = this;\n\n           map.on('keypress', function(e) {\n               console.log(e.originalEvent.code);\n               var key = e.originalEvent.code;\n               if (key === 'KeyE') {\n                   var bb = this.getBounds();\n                   var txt = JSON.stringify(bb);\n                   console.log(txt);\n\n                   setClipboardText('\\'' + txt + '\\'');\n               }\n           })\n        }).call(this.getMap(), el, x, data);\n}","data":null}]}}</script>
<p>load one las data</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="s01.html#cb54-1" tabindex="-1"></a>f_temp <span class="ot">=</span> las_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">pull</span>(f_path)</span>
<span id="cb54-2"><a href="s01.html#cb54-2" tabindex="-1"></a>las_temp <span class="ot">=</span> lidR<span class="sc">::</span><span class="fu">readLAS</span>(f_temp)</span>
<span id="cb54-3"><a href="s01.html#cb54-3" tabindex="-1"></a><span class="co"># quick summary</span></span>
<span id="cb54-4"><a href="s01.html#cb54-4" tabindex="-1"></a>las_temp</span></code></pre></div>
<pre><code>## class        : LAS (v1.3 format 3)
## memory       : 889.1 Kb 
## extent       : 364547.1, 364587, 4305320, 4305360 (xmin, xmax, ymin, ymax)
## coord. ref.  : WGS 84 / UTM zone 18N 
## area         : 1632 m²
## points       : 11.9 thousand points
## density      : 7.31 points/m²
## density      : 4.63 pulses/m²</code></pre>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="s01.html#cb56-1" tabindex="-1"></a><span class="co"># data str</span></span>
<span id="cb56-2"><a href="s01.html#cb56-2" tabindex="-1"></a>las_temp<span class="sc">@</span>data <span class="sc">%&gt;%</span> </span>
<span id="cb56-3"><a href="s01.html#cb56-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 11,935
## Columns: 19
## $ X                 &lt;dbl&gt; 364586.8, 364586.5, 364585.4, 364584.6, 364583.9, 36…
## $ Y                 &lt;dbl&gt; 4305320, 4305321, 4305321, 4305321, 4305321, 4305321…
## $ Z                 &lt;dbl&gt; 10.01, 9.86, 11.99, 11.85, 11.93, 11.66, 8.00, 7.43,…
## $ gpstime           &lt;dbl&gt; 314473.4, 314473.4, 314473.4, 314473.4, 314473.4, 31…
## $ Intensity         &lt;int&gt; 5, 4, 3, 4, 6, 9, 8, 12, 6, 7, 3, 3, 1, 2, 8, 6, 5, …
## $ ReturnNumber      &lt;int&gt; 2, 2, 2, 2, 1, 1, 1, 2, 1, 1, 2, 2, 3, 2, 1, 1, 1, 2…
## $ NumberOfReturns   &lt;int&gt; 2, 2, 2, 2, 1, 1, 1, 2, 1, 2, 2, 2, 3, 2, 1, 1, 2, 2…
## $ ScanDirectionFlag &lt;int&gt; 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0…
## $ EdgeOfFlightline  &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ Classification    &lt;int&gt; 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 1, 5, 5, 5, 5, 5…
## $ Synthetic_flag    &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FAL…
## $ Keypoint_flag     &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FAL…
## $ Withheld_flag     &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FAL…
## $ ScanAngleRank     &lt;int&gt; 10, 10, 10, 10, 10, 10, 10, 10, 11, 11, 11, 11, 11, …
## $ UserData          &lt;int&gt; 70, 69, 90, 89, 90, 87, 52, 47, 44, 95, 45, 51, 3, 1…
## $ PointSourceID     &lt;int&gt; 1311, 1311, 1311, 1311, 1311, 1311, 1311, 1311, 1311…
## $ R                 &lt;int&gt; 31488, 30720, 37632, 7936, 8192, 11264, 8192, 7168, …
## $ G                 &lt;int&gt; 38400, 35840, 40960, 11520, 12800, 16896, 11776, 122…
## $ B                 &lt;int&gt; 25344, 26112, 34560, 8448, 11520, 17152, 15616, 1689…</code></pre>
<p>summarize x, y, z</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="s01.html#cb58-1" tabindex="-1"></a>las_temp<span class="sc">@</span>data <span class="sc">%&gt;%</span> </span>
<span id="cb58-2"><a href="s01.html#cb58-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(X,Y,Z) <span class="sc">%&gt;%</span> </span>
<span id="cb58-3"><a href="s01.html#cb58-3" tabindex="-1"></a>  <span class="fu">summary</span>()</span></code></pre></div>
<pre><code>##        X                Y                 Z        
##  Min.   :364547   Min.   :4305320   Min.   : 1.83  
##  1st Qu.:364557   1st Qu.:4305329   1st Qu.:19.92  
##  Median :364567   Median :4305339   Median :29.84  
##  Mean   :364567   Mean   :4305339   Mean   :26.26  
##  3rd Qu.:364577   3rd Qu.:4305349   3rd Qu.:34.81  
##  Max.   :364587   Max.   :4305360   Max.   :41.42</code></pre>
<p>plot this las</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="s01.html#cb60-1" tabindex="-1"></a>plot3D<span class="sc">::</span><span class="fu">scatter3D</span>(</span>
<span id="cb60-2"><a href="s01.html#cb60-2" tabindex="-1"></a>  <span class="at">x =</span> las_temp<span class="sc">@</span>data<span class="sc">$</span>X</span>
<span id="cb60-3"><a href="s01.html#cb60-3" tabindex="-1"></a>  , <span class="at">y =</span> las_temp<span class="sc">@</span>data<span class="sc">$</span>Y</span>
<span id="cb60-4"><a href="s01.html#cb60-4" tabindex="-1"></a>  , <span class="at">z =</span> las_temp<span class="sc">@</span>data<span class="sc">$</span>Z</span>
<span id="cb60-5"><a href="s01.html#cb60-5" tabindex="-1"></a>  , <span class="at">colvar =</span> las_temp<span class="sc">@</span>data<span class="sc">$</span>Z</span>
<span id="cb60-6"><a href="s01.html#cb60-6" tabindex="-1"></a>  , <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">cex =</span> <span class="fl">0.3</span></span>
<span id="cb60-7"><a href="s01.html#cb60-7" tabindex="-1"></a>  , <span class="at">colkey =</span> F</span>
<span id="cb60-8"><a href="s01.html#cb60-8" tabindex="-1"></a>  , <span class="at">phi =</span> <span class="fl">0.5</span></span>
<span id="cb60-9"><a href="s01.html#cb60-9" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="uas_sfm_tree_detection_files/figure-html/unnamed-chunk-37-1.png" width="1008" /></p>
<p>let’s look at the classification (see <a href="https://www.usgs.gov/ngp-standards-and-specifications/lidar-base-specification-tables">table 5 here</a>)</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="s01.html#cb61-1" tabindex="-1"></a>las_temp<span class="sc">@</span>data <span class="sc">%&gt;%</span> </span>
<span id="cb61-2"><a href="s01.html#cb61-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(Classification)</span></code></pre></div>
<pre><code>##    Classification     n
##             &lt;int&gt; &lt;int&gt;
## 1:              1   416
## 2:              2   398
## 3:              5 11117
## 4:              7     4</code></pre>
<p>plot color by classification</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="s01.html#cb63-1" tabindex="-1"></a>plot3D<span class="sc">::</span><span class="fu">scatter3D</span>(</span>
<span id="cb63-2"><a href="s01.html#cb63-2" tabindex="-1"></a>  <span class="at">x =</span> las_temp<span class="sc">@</span>data<span class="sc">$</span>X</span>
<span id="cb63-3"><a href="s01.html#cb63-3" tabindex="-1"></a>  , <span class="at">y =</span> las_temp<span class="sc">@</span>data<span class="sc">$</span>Y</span>
<span id="cb63-4"><a href="s01.html#cb63-4" tabindex="-1"></a>  , <span class="at">z =</span> las_temp<span class="sc">@</span>data<span class="sc">$</span>Z</span>
<span id="cb63-5"><a href="s01.html#cb63-5" tabindex="-1"></a>  , <span class="at">colvar =</span> las_temp<span class="sc">@</span>data<span class="sc">$</span>Classification</span>
<span id="cb63-6"><a href="s01.html#cb63-6" tabindex="-1"></a>  , <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">cex =</span> <span class="fl">0.3</span></span>
<span id="cb63-7"><a href="s01.html#cb63-7" tabindex="-1"></a>  , <span class="at">colkey =</span> F</span>
<span id="cb63-8"><a href="s01.html#cb63-8" tabindex="-1"></a>  , <span class="at">phi =</span> <span class="fl">0.5</span></span>
<span id="cb63-9"><a href="s01.html#cb63-9" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="uas_sfm_tree_detection_files/figure-html/unnamed-chunk-39-1.png" width="1008" /></p>
</div>
</div>
<div id="cloud2trees" class="section level2 hasAnchor" number="2.2">
<h2><span class="header-section-number">2.2</span> <code id="cloud2trees">cloud2trees</code><a href="s01.html#cloud2trees" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The <a href="https://github.com/georgewoolsey/cloud2trees"><code>cloud2trees</code></a> package provides routines for processing point cloud data (.las|.laz format) to detect forest trees.</p>
<p>let’s use it for one of the data sets from a conifer forest in the <code>NeonTreeEvaluation</code> benchmark</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="s01.html#cb64-1" tabindex="-1"></a><span class="co"># get one file</span></span>
<span id="cb64-2"><a href="s01.html#cb64-2" tabindex="-1"></a>(f_temp <span class="ot">&lt;-</span> las_df <span class="sc">%&gt;%</span> </span>
<span id="cb64-3"><a href="s01.html#cb64-3" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(neon_site<span class="sc">==</span><span class="st">&quot;RMNP&quot;</span>) <span class="sc">%&gt;%</span>  <span class="co"># rocky mtn national park</span></span>
<span id="cb64-4"><a href="s01.html#cb64-4" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb64-5"><a href="s01.html#cb64-5" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">pull</span>(f_path))</span></code></pre></div>
<pre><code>## [1] &quot;C:/Program Files/R/R-4.3.0/library/NeonTreeEvaluation/extdata/NeonTreeEvaluation/evaluation/LiDAR/RMNP_042_2018.laz&quot;</code></pre>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="s01.html#cb66-1" tabindex="-1"></a><span class="co"># read in the data</span></span>
<span id="cb66-2"><a href="s01.html#cb66-2" tabindex="-1"></a>las_temp <span class="ot">&lt;-</span> lidR<span class="sc">::</span><span class="fu">readLAS</span>(f_temp)</span></code></pre></div>
<p>what is this data?</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="s01.html#cb67-1" tabindex="-1"></a>las_temp<span class="sc">@</span>data <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 20,407
## Columns: 16
## $ X                 &lt;dbl&gt; 453532.6, 453546.3, 453546.8, 453547.2, 453547.7, 45…
## $ Y                 &lt;dbl&gt; 4458594, 4458556, 4458556, 4458556, 4458556, 4458556…
## $ Z                 &lt;dbl&gt; 2750.133, 2746.354, 2746.339, 2746.320, 2746.295, 27…
## $ gpstime           &lt;dbl&gt; 409989.8, 409990.3, 409990.3, 409990.3, 409990.3, 40…
## $ Intensity         &lt;int&gt; 74, 306, 289, 344, 273, 270, 306, 324, 344, 330, 335…
## $ ReturnNumber      &lt;int&gt; 4, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
## $ NumberOfReturns   &lt;int&gt; 4, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
## $ ScanDirectionFlag &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ EdgeOfFlightline  &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ Classification    &lt;int&gt; 5, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2…
## $ Synthetic_flag    &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FAL…
## $ Keypoint_flag     &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FAL…
## $ Withheld_flag     &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FAL…
## $ ScanAngleRank     &lt;int&gt; -6, -7, -7, -7, -7, -6, -6, -6, -6, -6, -6, -6, -6, …
## $ UserData          &lt;int&gt; 34, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …
## $ PointSourceID     &lt;int&gt; 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9…</code></pre>
<p>We can plot the point cloud with and color by the point height</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="s01.html#cb69-1" tabindex="-1"></a>lidR<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb69-2"><a href="s01.html#cb69-2" tabindex="-1"></a>  las_temp</span>
<span id="cb69-3"><a href="s01.html#cb69-3" tabindex="-1"></a> , <span class="at">color =</span> <span class="st">&quot;Z&quot;</span>, <span class="at">breaks =</span> <span class="st">&quot;quantile&quot;</span>, <span class="at">bg =</span> <span class="st">&quot;white&quot;</span>, <span class="at">legend =</span> T</span>
<span id="cb69-4"><a href="s01.html#cb69-4" tabindex="-1"></a> , <span class="at">pal =</span> harrypotter<span class="sc">::</span><span class="fu">hp</span>(<span class="at">n=</span><span class="dv">50</span>, <span class="at">house =</span> <span class="st">&quot;gryffindor&quot;</span>)</span>
<span id="cb69-5"><a href="s01.html#cb69-5" tabindex="-1"></a>)</span></code></pre></div>
<p>notice the Z values are in meters above sea level</p>
<div id="get-tree-list-and-normalized-cloud" class="section level3 hasAnchor" number="2.2.1">
<h3><span class="header-section-number">2.2.1</span> Get tree list and normalized cloud<a href="s01.html#get-tree-list-and-normalized-cloud" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We’ll use the <code>cloud2trees::cloud2trees()</code> function to get a tree list from the lidar data with a regional estimate of the DBH because we enabled the <code>estimate_tree_dbh</code> parameter. Also returned is a canopy height model (CHM) raster and because we enabled the <code>keep_intrmdt</code> parameter we’ll get the normalized point cloud data as well.</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="s01.html#cb70-1" tabindex="-1"></a>cloud2trees_ans <span class="ot">&lt;-</span> cloud2trees<span class="sc">::</span><span class="fu">cloud2trees</span>(</span>
<span id="cb70-2"><a href="s01.html#cb70-2" tabindex="-1"></a>  <span class="at">input_las_dir =</span> f_temp</span>
<span id="cb70-3"><a href="s01.html#cb70-3" tabindex="-1"></a>  , <span class="at">output_dir =</span> <span class="st">&quot;../data&quot;</span></span>
<span id="cb70-4"><a href="s01.html#cb70-4" tabindex="-1"></a>  , <span class="at">estimate_tree_dbh =</span> T</span>
<span id="cb70-5"><a href="s01.html#cb70-5" tabindex="-1"></a>  , <span class="at">keep_intrmdt =</span> T</span>
<span id="cb70-6"><a href="s01.html#cb70-6" tabindex="-1"></a>)</span></code></pre></div>
<p>let’s see what we got</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="s01.html#cb71-1" tabindex="-1"></a><span class="fu">names</span>(cloud2trees_ans)</span></code></pre></div>
<pre><code>## [1] &quot;crowns_sf&quot;   &quot;treetops_sf&quot; &quot;dtm_rast&quot;    &quot;chm_rast&quot;</code></pre>
<p>we got a CHM</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="s01.html#cb73-1" tabindex="-1"></a><span class="co"># could make an easy plot with...</span></span>
<span id="cb73-2"><a href="s01.html#cb73-2" tabindex="-1"></a><span class="co"># terra::plot(cloud2trees_ans$chm_rast)</span></span>
<span id="cb73-3"><a href="s01.html#cb73-3" tabindex="-1"></a><span class="co"># ...but we&#39;ll customize and save it as our base plot</span></span>
<span id="cb73-4"><a href="s01.html#cb73-4" tabindex="-1"></a>plt_chm <span class="ot">&lt;-</span> </span>
<span id="cb73-5"><a href="s01.html#cb73-5" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb73-6"><a href="s01.html#cb73-6" tabindex="-1"></a>    <span class="fu">geom_tile</span>(</span>
<span id="cb73-7"><a href="s01.html#cb73-7" tabindex="-1"></a>      <span class="at">data =</span> cloud2trees_ans<span class="sc">$</span>chm_rast <span class="sc">%&gt;%</span> </span>
<span id="cb73-8"><a href="s01.html#cb73-8" tabindex="-1"></a>        <span class="fu">as.data.frame</span>(<span class="at">xy=</span>T) <span class="sc">%&gt;%</span> </span>
<span id="cb73-9"><a href="s01.html#cb73-9" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">f=</span><span class="dv">3</span>)</span>
<span id="cb73-10"><a href="s01.html#cb73-10" tabindex="-1"></a>      , <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x=</span>x,<span class="at">y=</span>y,<span class="at">fill=</span>f)</span>
<span id="cb73-11"><a href="s01.html#cb73-11" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb73-12"><a href="s01.html#cb73-12" tabindex="-1"></a>    harrypotter<span class="sc">::</span><span class="fu">scale_fill_hp</span>(<span class="st">&quot;gryffindor&quot;</span>, <span class="at">name =</span> <span class="st">&quot;height (m)&quot;</span>) <span class="sc">+</span></span>
<span id="cb73-13"><a href="s01.html#cb73-13" tabindex="-1"></a>    <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb73-14"><a href="s01.html#cb73-14" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb73-15"><a href="s01.html#cb73-15" tabindex="-1"></a>      <span class="at">axis.text =</span> <span class="fu">element_blank</span>()</span>
<span id="cb73-16"><a href="s01.html#cb73-16" tabindex="-1"></a>    )</span>
<span id="cb73-17"><a href="s01.html#cb73-17" tabindex="-1"></a><span class="co"># view</span></span>
<span id="cb73-18"><a href="s01.html#cb73-18" tabindex="-1"></a>plt_chm</span></code></pre></div>
<p><img src="uas_sfm_tree_detection_files/figure-html/unnamed-chunk-47-1.png" width="1008" /></p>
<p>we also got tree top points</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="s01.html#cb74-1" tabindex="-1"></a>plt_chm <span class="sc">+</span></span>
<span id="cb74-2"><a href="s01.html#cb74-2" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> cloud2trees_ans<span class="sc">$</span>treetops_sf, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>)</span></code></pre></div>
<p><img src="uas_sfm_tree_detection_files/figure-html/unnamed-chunk-48-1.png" width="1008" /></p>
<p>and we got tree crowns</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="s01.html#cb75-1" tabindex="-1"></a>plt_chm <span class="sc">+</span></span>
<span id="cb75-2"><a href="s01.html#cb75-2" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> cloud2trees_ans<span class="sc">$</span>treetops_sf, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>) <span class="sc">+</span></span>
<span id="cb75-3"><a href="s01.html#cb75-3" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> cloud2trees_ans<span class="sc">$</span>crowns_sf, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;steelblue&quot;</span>)</span></code></pre></div>
<p><img src="uas_sfm_tree_detection_files/figure-html/unnamed-chunk-49-1.png" width="1008" /></p>
<p>there is data on the individual trees in the crowns and tree tops data (which are the same data but one spaltial polygons and the other is spatial points).</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="s01.html#cb76-1" tabindex="-1"></a>cloud2trees_ans<span class="sc">$</span>crowns_sf <span class="sc">%&gt;%</span> </span>
<span id="cb76-2"><a href="s01.html#cb76-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 107
## Columns: 20
## $ treeID                    &lt;chr&gt; &quot;1_453532.6_4458594.6&quot;, &quot;2_453544.6_4458594.…
## $ tree_height_m             &lt;dbl&gt; 3.185, 12.866, 11.826, 4.287, 8.980, 7.009, …
## $ tree_x                    &lt;dbl&gt; 453532.6, 453544.6, 453542.6, 453547.4, 4535…
## $ tree_y                    &lt;dbl&gt; 4458595, 4458595, 4458594, 4458593, 4458592,…
## $ crown_area_m2             &lt;dbl&gt; 0.8750, 10.0000, 11.0625, 0.5625, 5.1875, 1.…
## $ geometry                  &lt;GEOMETRY [m]&gt; POLYGON ((453532.5 4458595,..., POL…
## $ fia_est_dbh_cm            &lt;dbl&gt; 4.891438, 19.776269, 17.793208, 6.265440, 13…
## $ fia_est_dbh_cm_lower      &lt;dbl&gt; 2.646565, 10.478410, 9.483730, 3.344581, 6.9…
## $ fia_est_dbh_cm_upper      &lt;dbl&gt; 7.763825, 31.669043, 27.979694, 9.838453, 20…
## $ dbh_cm                    &lt;dbl&gt; 4.891438, 19.776269, 17.793208, 6.265440, 13…
## $ is_training_data          &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FA…
## $ dbh_m                     &lt;dbl&gt; 0.04891438, 0.19776269, 0.17793208, 0.062654…
## $ radius_m                  &lt;dbl&gt; 0.02445719, 0.09888134, 0.08896604, 0.031327…
## $ basal_area_m2             &lt;dbl&gt; 0.001879156, 0.030716986, 0.024865567, 0.003…
## $ basal_area_ft2            &lt;dbl&gt; 0.02022724, 0.33063764, 0.26765296, 0.033186…
## $ ptcld_extracted_dbh_cm    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ ptcld_predicted_dbh_cm    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ comp_trees_per_ha         &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ comp_relative_tree_height &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ comp_dist_to_nearest_m    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …</code></pre>
<p>let’s check the height to DBH relationship</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="s01.html#cb78-1" tabindex="-1"></a>cloud2trees_ans<span class="sc">$</span>crowns_sf <span class="sc">%&gt;%</span> </span>
<span id="cb78-2"><a href="s01.html#cb78-2" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> tree_height_m, <span class="at">y =</span> dbh_cm)) <span class="sc">+</span></span>
<span id="cb78-3"><a href="s01.html#cb78-3" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">&quot;navy&quot;</span>) <span class="sc">+</span></span>
<span id="cb78-4"><a href="s01.html#cb78-4" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;height (m)&quot;</span>, <span class="at">y =</span> <span class="st">&quot;DBH (cm)&quot;</span>) <span class="sc">+</span></span>
<span id="cb78-5"><a href="s01.html#cb78-5" tabindex="-1"></a>    <span class="fu">theme_light</span>()</span></code></pre></div>
<p><img src="uas_sfm_tree_detection_files/figure-html/unnamed-chunk-51-1.png" width="1008" /></p>
<p>this all looks great.</p>
<p>let’s check the normalized point cloud. for that we’ll dig in the output directory from the <code>cloud2trees::cloud2trees()</code> function (see that <code>output_dir</code> parameter).</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="s01.html#cb79-1" tabindex="-1"></a>(n_f_temp <span class="ot">&lt;-</span> <span class="fu">list.files</span>(</span>
<span id="cb79-2"><a href="s01.html#cb79-2" tabindex="-1"></a>  <span class="st">&quot;../data/point_cloud_processing_temp/02_normalize/&quot;</span></span>
<span id="cb79-3"><a href="s01.html#cb79-3" tabindex="-1"></a>  , <span class="at">pattern =</span> <span class="st">&quot;.las&quot;</span></span>
<span id="cb79-4"><a href="s01.html#cb79-4" tabindex="-1"></a>  , <span class="at">full.names =</span> T</span>
<span id="cb79-5"><a href="s01.html#cb79-5" tabindex="-1"></a>))</span></code></pre></div>
<pre><code>## [1] &quot;../data/point_cloud_processing_temp/02_normalize/RMNP_042_2018_normalize.las&quot;</code></pre>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="s01.html#cb81-1" tabindex="-1"></a><span class="co"># read in the data</span></span>
<span id="cb81-2"><a href="s01.html#cb81-2" tabindex="-1"></a>nlas_temp <span class="ot">&lt;-</span> lidR<span class="sc">::</span><span class="fu">readLAS</span>(n_f_temp)</span></code></pre></div>
<p>plot it to check that it is height normalized</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="s01.html#cb82-1" tabindex="-1"></a>lidR<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb82-2"><a href="s01.html#cb82-2" tabindex="-1"></a>  nlas_temp</span>
<span id="cb82-3"><a href="s01.html#cb82-3" tabindex="-1"></a> , <span class="at">color =</span> <span class="st">&quot;Z&quot;</span>, <span class="at">bg =</span> <span class="st">&quot;white&quot;</span>, <span class="at">legend =</span> T</span>
<span id="cb82-4"><a href="s01.html#cb82-4" tabindex="-1"></a> , <span class="at">pal =</span> harrypotter<span class="sc">::</span><span class="fu">hp</span>(<span class="at">n=</span><span class="dv">50</span>, <span class="at">house =</span> <span class="st">&quot;gryffindor&quot;</span>)</span>
<span id="cb82-5"><a href="s01.html#cb82-5" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="uas_sfm_tree_detection_files/figure-html/unnamed-chunk-53-1.png" width="1008" /></p>
<p>nice! let’s remove the ground points to check out potential vegetation</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="s01.html#cb83-1" tabindex="-1"></a>nlas_temp <span class="sc">%&gt;%</span> </span>
<span id="cb83-2"><a href="s01.html#cb83-2" tabindex="-1"></a>  lidR<span class="sc">::</span><span class="fu">filter_poi</span>(Classification<span class="sc">!=</span><span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb83-3"><a href="s01.html#cb83-3" tabindex="-1"></a>  lidR<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb83-4"><a href="s01.html#cb83-4" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">&quot;Z&quot;</span>, <span class="at">breaks =</span> <span class="st">&quot;quantile&quot;</span>, <span class="at">bg =</span> <span class="st">&quot;white&quot;</span>, <span class="at">legend =</span> T</span>
<span id="cb83-5"><a href="s01.html#cb83-5" tabindex="-1"></a>    , <span class="at">pal =</span> harrypotter<span class="sc">::</span><span class="fu">hp</span>(<span class="at">n=</span><span class="dv">50</span>, <span class="at">house =</span> <span class="st">&quot;gryffindor&quot;</span>)</span>
<span id="cb83-6"><a href="s01.html#cb83-6" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="uas_sfm_tree_detection_files/figure-html/unnamed-chunk-54-1.png" width="1008" /></p>
<p>that’s a great workflow, guy.</p>
<p>i’m not your guy, buddy.</p>
</div>
</div>
<div id="ladderfuelsr" class="section level2 hasAnchor" number="2.3">
<h2><span class="header-section-number">2.3</span> <code id="ladr">LadderFuelsR</code><a href="s01.html#ladderfuelsr" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The <code>LadderFuelsR</code> package (<a href="https://doi.org/10.1111/2041-210X.14427">Viedma et al. 2024</a>) is described as enabling the use of “LiDAR data and the LadderFuelsR package…[to] provide an automated tool for analysing the vertical fuel structure of a forest and to calculate crown base height (CBH) at tree-level, among other parameters” (p.1).</p>
<p>let’s check what’s in this package</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="s01.html#cb84-1" tabindex="-1"></a><span class="fu">lsf.str</span>(<span class="st">&quot;package:LadderFuelsR&quot;</span>)</span></code></pre></div>
<pre><code>## calculate_gaps_perc : function (LAD_profiles, min_height = 1.5)  
## get_cbh_metrics : function (effective_LAD, min_height = 1.5, hdepth1_height = 2.5, verbose = TRUE)  
## get_cum_break : function (LAD_profiles, cbh_metrics, threshold = 75, min_height = 1.5, 
##     verbose = TRUE)  
## get_depths : function (LAD_profiles, distance_metrics, step = 1, min_height = 1.5, verbose = TRUE)  
## get_distance : function (gap_cbh_metrics, gaps_perc, step = 1, min_height = 1.5, verbose = TRUE)  
## get_effective_gap : function (effective_depth, number_steps = 1, min_height = 1.5, verbose = TRUE)  
## get_gaps_fbhs : function (LAD_profiles, step = 1, min_height = 1.5, perc_gap = 25, perc_base = 25, 
##     verbose = TRUE)  
## get_layers_lad : function (LAD_profiles, effective_distances, threshold = 10, step = 1, 
##     min_height = 1.5, verbose = TRUE)  
## get_plots_cbh_bp : function (LAD_profiles, cummulative_LAD, min_height = 1.5)  
## get_plots_cbh_LAD : function (LAD_profiles, cbh_metrics, min_height = 1.5)  
## get_plots_cbh_lastdist : function (LAD_profiles, cbh_metrics, min_height = 1.5)  
## get_plots_cbh_maxdist : function (LAD_profiles, cbh_metrics, min_height = 1.5)  
## get_plots_effective : function (LAD_profiles, effective_LAD, min_height = 1.5)  
## get_plots_gap_fbh : function (LAD_profiles, gap_cbh_metrics, min_height = 1.5)  
## get_real_depths : function (effective_fbh, step = 1, min_height = 1.5, verbose = TRUE)  
## get_real_fbh : function (depth_metrics, step = 1, number_steps = 1, min_height = 1.5, 
##     verbose = TRUE)  
## get_renamed_df : function (df)  
## get_renamed0_df : function (df)</code></pre>
<div id="prep-for-the-package" class="section level3 hasAnchor" number="2.3.1">
<h3><span class="header-section-number">2.3.1</span> Prep for the package<a href="s01.html#prep-for-the-package" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>For this package we need to do some cleaning of our las data and our polygon crown data. We need to attach the <code>treeID</code> column from our spatial crowns to the las data using <code>lidR::merge_spatial()</code>. This function allows for only polygons so we need to get rid of the multipolygons in the crown data. We’ll keep the largest part of the multipolygon as the smaller part is usually a residual pixel from the CHM. We also generate a <code>tree_index</code> as a numeric id which is needed by the <code>LadderFuelsR</code> package since <code>treeID</code> is character.</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="s01.html#cb86-1" tabindex="-1"></a><span class="co"># the lidR::merge_spatial requires only polygons so we need to rid the multipolygons</span></span>
<span id="cb86-2"><a href="s01.html#cb86-2" tabindex="-1"></a>crowns_sf_poly <span class="ot">&lt;-</span></span>
<span id="cb86-3"><a href="s01.html#cb86-3" tabindex="-1"></a>  <span class="co"># start with only polygons</span></span>
<span id="cb86-4"><a href="s01.html#cb86-4" tabindex="-1"></a>  cloud2trees_ans<span class="sc">$</span>crowns_sf <span class="sc">%&gt;%</span> </span>
<span id="cb86-5"><a href="s01.html#cb86-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_geometry_type</span>(geometry)<span class="sc">==</span><span class="st">&quot;POLYGON&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb86-6"><a href="s01.html#cb86-6" tabindex="-1"></a>  <span class="co"># union on cleaned multipolygons</span></span>
<span id="cb86-7"><a href="s01.html#cb86-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb86-8"><a href="s01.html#cb86-8" tabindex="-1"></a>    cloud2trees_ans<span class="sc">$</span>crowns_sf <span class="sc">%&gt;%</span> </span>
<span id="cb86-9"><a href="s01.html#cb86-9" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(sf<span class="sc">::</span><span class="fu">st_geometry_type</span>(geometry)<span class="sc">==</span><span class="st">&quot;MULTIPOLYGON&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb86-10"><a href="s01.html#cb86-10" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_cast</span>(<span class="at">to =</span> <span class="st">&quot;POLYGON&quot;</span>, <span class="at">do_split =</span> T, <span class="at">warn =</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb86-11"><a href="s01.html#cb86-11" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">axxx =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(geometry)) <span class="sc">%&gt;%</span> <span class="co"># axxx is so we don&#39;t overwrite a column</span></span>
<span id="cb86-12"><a href="s01.html#cb86-12" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">group_by</span>(treeID) <span class="sc">%&gt;%</span> </span>
<span id="cb86-13"><a href="s01.html#cb86-13" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(axxx <span class="sc">==</span> <span class="fu">max</span>(axxx)) <span class="sc">%&gt;%</span> <span class="co"># keep the biggest crown polygon by treeID</span></span>
<span id="cb86-14"><a href="s01.html#cb86-14" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb86-15"><a href="s01.html#cb86-15" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>axxx)</span>
<span id="cb86-16"><a href="s01.html#cb86-16" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb86-17"><a href="s01.html#cb86-17" tabindex="-1"></a>  <span class="co"># generate a treeID index because it needs to be numeric</span></span>
<span id="cb86-18"><a href="s01.html#cb86-18" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb86-19"><a href="s01.html#cb86-19" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">tree_index =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>())</span></code></pre></div>
<p>does it look good?</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="s01.html#cb87-1" tabindex="-1"></a>plt_chm <span class="sc">+</span></span>
<span id="cb87-2"><a href="s01.html#cb87-2" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> cloud2trees_ans<span class="sc">$</span>treetops_sf, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>) <span class="sc">+</span></span>
<span id="cb87-3"><a href="s01.html#cb87-3" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> crowns_sf_poly, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;steelblue&quot;</span>)</span></code></pre></div>
<p><img src="uas_sfm_tree_detection_files/figure-html/unnamed-chunk-57-1.png" width="1008" /></p>
<p>now we’ll attach the <code>treeID</code> column to the normalized las file and keep only the points that fall within a tree crown.</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="s01.html#cb88-1" tabindex="-1"></a>crowns_nlas_temp <span class="ot">&lt;-</span> lidR<span class="sc">::</span><span class="fu">merge_spatial</span>(</span>
<span id="cb88-2"><a href="s01.html#cb88-2" tabindex="-1"></a>    <span class="at">las =</span> nlas_temp</span>
<span id="cb88-3"><a href="s01.html#cb88-3" tabindex="-1"></a>    , <span class="at">source =</span> crowns_sf_poly</span>
<span id="cb88-4"><a href="s01.html#cb88-4" tabindex="-1"></a>    , <span class="at">attribute =</span> <span class="st">&quot;tree_index&quot;</span></span>
<span id="cb88-5"><a href="s01.html#cb88-5" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb88-6"><a href="s01.html#cb88-6" tabindex="-1"></a>  lidR<span class="sc">::</span><span class="fu">filter_poi</span>(<span class="sc">!</span><span class="fu">is.na</span>(tree_index)) <span class="sc">%&gt;%</span> </span>
<span id="cb88-7"><a href="s01.html#cb88-7" tabindex="-1"></a>  lidR<span class="sc">::</span><span class="fu">filter_poi</span>(Classification<span class="sc">!=</span><span class="dv">2</span>)</span>
<span id="cb88-8"><a href="s01.html#cb88-8" tabindex="-1"></a><span class="co"># what is this data?</span></span>
<span id="cb88-9"><a href="s01.html#cb88-9" tabindex="-1"></a>crowns_nlas_temp<span class="sc">@</span>data <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 9,885
## Columns: 17
## $ X                 &lt;dbl&gt; 453540.9, 453541.3, 453541.5, 453541.8, 453542.0, 45…
## $ Y                 &lt;dbl&gt; 4458556, 4458556, 4458556, 4458556, 4458556, 4458556…
## $ Z                 &lt;dbl&gt; 6.196, 7.331, 5.996, 7.657, 6.043, 10.264, 8.629, 7.…
## $ gpstime           &lt;dbl&gt; 409990.3, 409990.3, 409990.3, 409990.3, 409990.3, 40…
## $ Intensity         &lt;int&gt; 15, 24, 47, 137, 41, 83, 43, 37, 9, 168, 151, 9, 92,…
## $ ReturnNumber      &lt;int&gt; 1, 1, 2, 1, 2, 1, 2, 3, 4, 1, 1, 1, 1, 2, 1, 2, 3, 1…
## $ NumberOfReturns   &lt;int&gt; 2, 3, 3, 3, 3, 5, 5, 5, 5, 1, 1, 2, 3, 3, 3, 3, 3, 2…
## $ ScanDirectionFlag &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ EdgeOfFlightline  &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ Classification    &lt;int&gt; 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5…
## $ Synthetic_flag    &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FAL…
## $ Keypoint_flag     &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FAL…
## $ Withheld_flag     &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FAL…
## $ ScanAngleRank     &lt;int&gt; -7, -7, -7, -7, -7, -7, -7, -7, -7, -7, -7, -7, -7, …
## $ UserData          &lt;int&gt; 62, 74, 61, 76, 60, 102, 85, 76, 60, 103, 115, 32, 8…
## $ PointSourceID     &lt;int&gt; 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9…
## $ tree_index        &lt;int&gt; 64, 64, 64, 67, 67, 67, 67, 67, 67, 67, 67, 68, 68, …</code></pre>
<p>plot the las data colored by <code>tree_index</code></p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="s01.html#cb90-1" tabindex="-1"></a>crowns_nlas_temp <span class="sc">%&gt;%</span> </span>
<span id="cb90-2"><a href="s01.html#cb90-2" tabindex="-1"></a>  lidR<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb90-3"><a href="s01.html#cb90-3" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">&quot;tree_index&quot;</span>, <span class="at">bg =</span> <span class="st">&quot;white&quot;</span>, <span class="at">legend =</span> F</span>
<span id="cb90-4"><a href="s01.html#cb90-4" tabindex="-1"></a>    , <span class="at">pal =</span> viridis<span class="sc">::</span><span class="fu">turbo</span>(</span>
<span id="cb90-5"><a href="s01.html#cb90-5" tabindex="-1"></a>    <span class="at">n =</span> crowns_nlas_temp<span class="sc">@</span>data<span class="sc">$</span>tree_index <span class="sc">%&gt;%</span> <span class="co"># this whole thing gets n unique colors </span></span>
<span id="cb90-6"><a href="s01.html#cb90-6" tabindex="-1"></a>          <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb90-7"><a href="s01.html#cb90-7" tabindex="-1"></a>          <span class="fu">length</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb90-8"><a href="s01.html#cb90-8" tabindex="-1"></a>          <span class="st">`</span><span class="at">*</span><span class="st">`</span>(<span class="dv">2</span>) <span class="co"># with some separation between the hues</span></span>
<span id="cb90-9"><a href="s01.html#cb90-9" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb90-10"><a href="s01.html#cb90-10" tabindex="-1"></a>      <span class="fu">sample</span>(</span>
<span id="cb90-11"><a href="s01.html#cb90-11" tabindex="-1"></a>        crowns_nlas_temp<span class="sc">@</span>data<span class="sc">$</span>tree_index <span class="sc">%&gt;%</span> </span>
<span id="cb90-12"><a href="s01.html#cb90-12" tabindex="-1"></a>          <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb90-13"><a href="s01.html#cb90-13" tabindex="-1"></a>          <span class="fu">length</span>()</span>
<span id="cb90-14"><a href="s01.html#cb90-14" tabindex="-1"></a>      )</span>
<span id="cb90-15"><a href="s01.html#cb90-15" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="uas_sfm_tree_detection_files/figure-html/unnamed-chunk-59-1.png" width="1008" /></p>
<p>check it for one tree</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="s01.html#cb91-1" tabindex="-1"></a>crowns_nlas_temp <span class="sc">%&gt;%</span> </span>
<span id="cb91-2"><a href="s01.html#cb91-2" tabindex="-1"></a>  lidR<span class="sc">::</span><span class="fu">filter_poi</span>(</span>
<span id="cb91-3"><a href="s01.html#cb91-3" tabindex="-1"></a>    tree_index <span class="sc">==</span> </span>
<span id="cb91-4"><a href="s01.html#cb91-4" tabindex="-1"></a>      <span class="co"># get the tree with the most points</span></span>
<span id="cb91-5"><a href="s01.html#cb91-5" tabindex="-1"></a>      crowns_nlas_temp<span class="sc">@</span>data <span class="sc">%&gt;%</span> </span>
<span id="cb91-6"><a href="s01.html#cb91-6" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">count</span>(tree_index) <span class="sc">%&gt;%</span> </span>
<span id="cb91-7"><a href="s01.html#cb91-7" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(n <span class="sc">==</span> <span class="fu">max</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb91-8"><a href="s01.html#cb91-8" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">slice_head</span>(<span class="at">n=</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb91-9"><a href="s01.html#cb91-9" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">pull</span>(tree_index)</span>
<span id="cb91-10"><a href="s01.html#cb91-10" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb91-11"><a href="s01.html#cb91-11" tabindex="-1"></a>  lidR<span class="sc">::</span><span class="fu">plot</span>(<span class="at">color =</span> <span class="st">&quot;tree_index&quot;</span>, <span class="at">bg =</span> <span class="st">&quot;white&quot;</span>, <span class="at">legend =</span> F)</span></code></pre></div>
<p><img src="uas_sfm_tree_detection_files/figure-html/unnamed-chunk-61-1.png" width="1008" /></p>
<p>interesting, with more dense point clouds this would look more like a tree</p>
</div>
<div id="defining-function-for-computing-crown-level-metrics" class="section level3 hasAnchor" number="2.3.2">
<h3><span class="header-section-number">2.3.2</span> Defining function for computing crown-level metrics<a href="s01.html#defining-function-for-computing-crown-level-metrics" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Not sure how necessary this is, but pulling it from the <a href="https://github.com/olgaviedma/LadderFuelsR?tab=readme-ov-file#4-defining-function-for-computing-crown-level-metrics">package README</a></p>
<p>notice, none of these functions utilize the intensity, or “i”, parameter</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="s01.html#cb92-1" tabindex="-1"></a>custom_crown_metrics <span class="ot">&lt;-</span> <span class="cf">function</span>(z, i) { <span class="co"># user-defined function</span></span>
<span id="cb92-2"><a href="s01.html#cb92-2" tabindex="-1"></a>  metrics <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb92-3"><a href="s01.html#cb92-3" tabindex="-1"></a>     <span class="at">dz =</span> <span class="dv">1</span>,</span>
<span id="cb92-4"><a href="s01.html#cb92-4" tabindex="-1"></a>     <span class="at">th =</span> <span class="dv">1</span>,</span>
<span id="cb92-5"><a href="s01.html#cb92-5" tabindex="-1"></a>     <span class="at">z_max =</span> <span class="fu">max</span>(z),<span class="co"># max height</span></span>
<span id="cb92-6"><a href="s01.html#cb92-6" tabindex="-1"></a>     <span class="at">z_min =</span> <span class="fu">min</span>(z),<span class="co"># min height</span></span>
<span id="cb92-7"><a href="s01.html#cb92-7" tabindex="-1"></a>     <span class="at">z_mean =</span> <span class="fu">mean</span>(z),<span class="co"># mean height</span></span>
<span id="cb92-8"><a href="s01.html#cb92-8" tabindex="-1"></a>     <span class="at">z_sd =</span> <span class="fu">sd</span>(z), <span class="co"># vertical variability of points</span></span>
<span id="cb92-9"><a href="s01.html#cb92-9" tabindex="-1"></a>     <span class="at">z_q1=</span><span class="fu">quantile</span>(z, <span class="at">probs =</span> <span class="fl">0.01</span>),</span>
<span id="cb92-10"><a href="s01.html#cb92-10" tabindex="-1"></a>     <span class="at">z_q5=</span><span class="fu">quantile</span>(z, <span class="at">probs =</span> <span class="fl">0.05</span>),</span>
<span id="cb92-11"><a href="s01.html#cb92-11" tabindex="-1"></a>    <span class="at">z_q25=</span><span class="fu">quantile</span>(z, <span class="at">probs =</span> <span class="fl">0.25</span>),</span>
<span id="cb92-12"><a href="s01.html#cb92-12" tabindex="-1"></a>    <span class="at">z_q50=</span><span class="fu">quantile</span>(z, <span class="at">probs =</span> <span class="fl">0.50</span>),</span>
<span id="cb92-13"><a href="s01.html#cb92-13" tabindex="-1"></a>    <span class="at">z_q75=</span><span class="fu">quantile</span>(z, <span class="at">probs =</span> <span class="fl">0.75</span>),</span>
<span id="cb92-14"><a href="s01.html#cb92-14" tabindex="-1"></a>    <span class="at">z_q95=</span><span class="fu">quantile</span>(z, <span class="at">probs =</span> <span class="fl">0.95</span>),</span>
<span id="cb92-15"><a href="s01.html#cb92-15" tabindex="-1"></a>     <span class="at">crr=</span>(<span class="fu">mean</span>(z)<span class="sc">-</span><span class="fu">min</span>(z))<span class="sc">/</span>(<span class="fu">max</span>(z)<span class="sc">-</span><span class="fu">min</span>(z))</span>
<span id="cb92-16"><a href="s01.html#cb92-16" tabindex="-1"></a>   )</span>
<span id="cb92-17"><a href="s01.html#cb92-17" tabindex="-1"></a>   <span class="fu">return</span>(metrics) <span class="co"># output</span></span>
<span id="cb92-18"><a href="s01.html#cb92-18" tabindex="-1"></a>}</span>
<span id="cb92-19"><a href="s01.html#cb92-19" tabindex="-1"></a><span class="co"># idk why they did this...just for shorthand? just define it like that from the start</span></span>
<span id="cb92-20"><a href="s01.html#cb92-20" tabindex="-1"></a><span class="co"># ccm = ~custom_crown_metrics(z = Z, i = Intensity)</span></span></code></pre></div>
</div>
<div id="computing-crown-level-standard-metrics-within-all-trees-detected" class="section level3 hasAnchor" number="2.3.3">
<h3><span class="header-section-number">2.3.3</span> Computing crown level standard metrics within all trees detected<a href="s01.html#computing-crown-level-standard-metrics-within-all-trees-detected" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>let’s see how they do it from the <a href="https://github.com/olgaviedma/LadderFuelsR?tab=readme-ov-file#5computing-crown-level-standard-metrics-within-all-trees-detected">package README</a></p>
<p>first, calculate metrics from the las data by tree (with code updates by gw)</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="s01.html#cb93-1" tabindex="-1"></a><span class="co"># setting a minimum Z height to look at crown metrics</span></span>
<span id="cb93-2"><a href="s01.html#cb93-2" tabindex="-1"></a>fcrowns_nlas_temp <span class="ot">&lt;-</span> lidR<span class="sc">::</span><span class="fu">filter_poi</span>(crowns_nlas_temp, Z <span class="sc">&gt;=</span> <span class="dv">1</span>)</span>
<span id="cb93-3"><a href="s01.html#cb93-3" tabindex="-1"></a><span class="co"># Metric derivation at different levels of regularization</span></span>
<span id="cb93-4"><a href="s01.html#cb93-4" tabindex="-1"></a>crowns_metrics_df <span class="ot">&lt;-</span> </span>
<span id="cb93-5"><a href="s01.html#cb93-5" tabindex="-1"></a>  <span class="co"># gw updated this to do it all at once</span></span>
<span id="cb93-6"><a href="s01.html#cb93-6" tabindex="-1"></a>  lidR<span class="sc">::</span><span class="fu">crown_metrics</span>(</span>
<span id="cb93-7"><a href="s01.html#cb93-7" tabindex="-1"></a>    <span class="at">las =</span> fcrowns_nlas_temp</span>
<span id="cb93-8"><a href="s01.html#cb93-8" tabindex="-1"></a>    , <span class="at">func =</span> .stdtreemetrics <span class="co"># stdtreemetrics is a lidR predefined function for tree-based metrics</span></span>
<span id="cb93-9"><a href="s01.html#cb93-9" tabindex="-1"></a>    , <span class="at">geom =</span> <span class="st">&quot;convex&quot;</span> <span class="co"># Geometry type of the output</span></span>
<span id="cb93-10"><a href="s01.html#cb93-10" tabindex="-1"></a>    , <span class="at">attribute =</span> <span class="st">&quot;tree_index&quot;</span></span>
<span id="cb93-11"><a href="s01.html#cb93-11" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb93-12"><a href="s01.html#cb93-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb93-13"><a href="s01.html#cb93-13" tabindex="-1"></a>    lidR<span class="sc">::</span><span class="fu">crown_metrics</span>(</span>
<span id="cb93-14"><a href="s01.html#cb93-14" tabindex="-1"></a>      <span class="at">las =</span> fcrowns_nlas_temp</span>
<span id="cb93-15"><a href="s01.html#cb93-15" tabindex="-1"></a>      , <span class="at">func =</span> <span class="sc">~</span> <span class="fu">custom_crown_metrics</span>(<span class="at">z =</span> Z) <span class="co"># the custom function defined above</span></span>
<span id="cb93-16"><a href="s01.html#cb93-16" tabindex="-1"></a>      , <span class="at">geom =</span> <span class="st">&quot;convex&quot;</span> <span class="co"># Geometry type of the output</span></span>
<span id="cb93-17"><a href="s01.html#cb93-17" tabindex="-1"></a>      , <span class="at">attribute =</span> <span class="st">&quot;tree_index&quot;</span></span>
<span id="cb93-18"><a href="s01.html#cb93-18" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb93-19"><a href="s01.html#cb93-19" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>()</span>
<span id="cb93-20"><a href="s01.html#cb93-20" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;tree_index&quot;</span></span>
<span id="cb93-21"><a href="s01.html#cb93-21" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb93-22"><a href="s01.html#cb93-22" tabindex="-1"></a>  <span class="co"># define crown diameter</span></span>
<span id="cb93-23"><a href="s01.html#cb93-23" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb93-24"><a href="s01.html#cb93-24" tabindex="-1"></a>    <span class="at">crown_diam =</span> <span class="fu">sqrt</span>(convhull_area<span class="sc">/</span> pi) <span class="sc">*</span> <span class="dv">2</span></span>
<span id="cb93-25"><a href="s01.html#cb93-25" tabindex="-1"></a>  )</span>
<span id="cb93-26"><a href="s01.html#cb93-26" tabindex="-1"></a><span class="co"># a df, ok</span></span>
<span id="cb93-27"><a href="s01.html#cb93-27" tabindex="-1"></a>crowns_metrics_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 89
## Columns: 19
## $ tree_index    &lt;int&gt; 2, 3, 5, 6, 7, 8, 10, 12, 13, 14, 16, 18, 21, 22, 23, 24…
## $ Z             &lt;dbl&gt; 12.866, 11.826, 8.980, 7.009, 6.352, 6.489, 7.472, 9.940…
## $ npoints       &lt;int&gt; 108, 73, 48, 13, 11, 16, 11, 25, 118, 128, 8, 80, 21, 27…
## $ convhull_area &lt;dbl&gt; 7.166, 8.132, 3.042, 0.853, 1.141, 1.137, 0.554, 5.327, …
## $ dz            &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
## $ th            &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
## $ z_max         &lt;dbl&gt; 12.866, 11.826, 8.980, 7.009, 6.352, 6.489, 7.472, 9.940…
## $ z_min         &lt;dbl&gt; 1.926, 1.705, 2.469, 2.513, 1.702, 1.456, 2.428, 2.994, …
## $ z_mean        &lt;dbl&gt; 7.870843, 8.036315, 5.881000, 4.762000, 4.380545, 4.4591…
## $ z_sd          &lt;dbl&gt; 2.8488448, 2.2873433, 1.8985180, 1.6263112, 1.6196375, 1…
## $ z_q1          &lt;dbl&gt; 2.02244, 3.89092, 2.54702, 2.53208, 1.71760, 1.69855, 2.…
## $ z_q5          &lt;dbl&gt; 2.80340, 4.96060, 2.76435, 2.60840, 1.78000, 2.66875, 2.…
## $ z_q25         &lt;dbl&gt; 5.75425, 5.91900, 4.03000, 3.00000, 3.45850, 3.41000, 3.…
## $ z_q50         &lt;dbl&gt; 7.8825, 8.0970, 6.3520, 5.2200, 5.0770, 4.9280, 4.9980, …
## $ z_q75         &lt;dbl&gt; 10.27750, 10.05700, 7.25700, 5.75000, 5.36450, 5.44450, …
## $ z_q95         &lt;dbl&gt; 12.19095, 11.50240, 8.42115, 6.95260, 6.34900, 6.34575, …
## $ crr           &lt;dbl&gt; 0.5434043, 0.6255622, 0.5240362, 0.5002224, 0.5760313, 0…
## $ geometry      &lt;POLYGON [m]&gt; POLYGON ((453546.1 4458594,..., POLYGON ((453543…
## $ crown_diam    &lt;dbl&gt; 3.0206017, 3.2177607, 1.9680434, 1.0421484, 1.2053076, 1…</code></pre>
<p>what “tree-based metrics” come from the <code>.stdtreemetrics</code>? maybe maximum Z, number of points, and crown area…not sure how useful these are for defining CBH. we shall see. the “z_” metrics are neat.</p>
<p>does every crown have some crown metrics?</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="s01.html#cb95-1" tabindex="-1"></a><span class="co"># has the same number of trees as our crown polygons?</span></span>
<span id="cb95-2"><a href="s01.html#cb95-2" tabindex="-1"></a>dplyr<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb95-3"><a href="s01.html#cb95-3" tabindex="-1"></a>  <span class="at">crowns_sf_poly_trees =</span> <span class="fu">nrow</span>(crowns_sf_poly)</span>
<span id="cb95-4"><a href="s01.html#cb95-4" tabindex="-1"></a>  , <span class="at">crowns_nlas_trees =</span> fcrowns_nlas_temp<span class="sc">@</span>data<span class="sc">$</span>tree_index <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">length</span>()</span>
<span id="cb95-5"><a href="s01.html#cb95-5" tabindex="-1"></a>  , <span class="at">crowns_metrics_df_trees =</span> <span class="fu">nrow</span>(crowns_metrics_df)</span>
<span id="cb95-6"><a href="s01.html#cb95-6" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb95-7"><a href="s01.html#cb95-7" tabindex="-1"></a>kableExtra<span class="sc">::</span><span class="fu">kbl</span>() <span class="sc">%&gt;%</span> kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>()</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:right;">
crowns_sf_poly_trees
</th>
<th style="text-align:right;">
crowns_nlas_trees
</th>
<th style="text-align:right;">
crowns_metrics_df_trees
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
107
</td>
<td style="text-align:right;">
107
</td>
<td style="text-align:right;">
89
</td>
</tr>
</tbody>
</table>
<p>guess not. let’s look at some of those metrics and the convex hull polygons created by the <code>lidR::crown_metrics()</code></p>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="s01.html#cb96-1" tabindex="-1"></a>plt_chm <span class="sc">+</span></span>
<span id="cb96-2"><a href="s01.html#cb96-2" tabindex="-1"></a>  ggnewscale<span class="sc">::</span><span class="fu">new_scale_fill</span>() <span class="sc">+</span></span>
<span id="cb96-3"><a href="s01.html#cb96-3" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> crowns_metrics_df, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">fill =</span> z_mean), <span class="at">color =</span> <span class="st">&quot;steelblue&quot;</span>) <span class="sc">+</span></span>
<span id="cb96-4"><a href="s01.html#cb96-4" tabindex="-1"></a>  harrypotter<span class="sc">::</span><span class="fu">scale_fill_hp</span>(<span class="st">&quot;always&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>)</span></code></pre></div>
<p><img src="uas_sfm_tree_detection_files/figure-html/unnamed-chunk-65-1.png" width="1008" /></p>
<p>note the overlap of those polygons. what if we attach the crown metrics to the original crown polygons?</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="s01.html#cb97-1" tabindex="-1"></a>plt_chm <span class="sc">+</span></span>
<span id="cb97-2"><a href="s01.html#cb97-2" tabindex="-1"></a>  ggnewscale<span class="sc">::</span><span class="fu">new_scale_fill</span>() <span class="sc">+</span></span>
<span id="cb97-3"><a href="s01.html#cb97-3" tabindex="-1"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb97-4"><a href="s01.html#cb97-4" tabindex="-1"></a>    <span class="at">data =</span> crowns_sf_poly <span class="sc">%&gt;%</span> </span>
<span id="cb97-5"><a href="s01.html#cb97-5" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb97-6"><a href="s01.html#cb97-6" tabindex="-1"></a>        crowns_metrics_df <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>()</span>
<span id="cb97-7"><a href="s01.html#cb97-7" tabindex="-1"></a>        , <span class="at">by =</span> <span class="st">&quot;tree_index&quot;</span></span>
<span id="cb97-8"><a href="s01.html#cb97-8" tabindex="-1"></a>      )</span>
<span id="cb97-9"><a href="s01.html#cb97-9" tabindex="-1"></a>    , <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">fill =</span> z_mean), <span class="at">color =</span> <span class="st">&quot;steelblue&quot;</span></span>
<span id="cb97-10"><a href="s01.html#cb97-10" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb97-11"><a href="s01.html#cb97-11" tabindex="-1"></a>  harrypotter<span class="sc">::</span><span class="fu">scale_fill_hp</span>(<span class="st">&quot;always&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="at">na.value =</span> <span class="st">&quot;black&quot;</span>)</span></code></pre></div>
<p><img src="uas_sfm_tree_detection_files/figure-html/unnamed-chunk-66-1.png" width="1008" /></p>
<p>what is this <code>crr=(mean(z)-min(z))/(max(z)-min(z))</code> variable?</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="s01.html#cb98-1" tabindex="-1"></a>plt_chm <span class="sc">+</span></span>
<span id="cb98-2"><a href="s01.html#cb98-2" tabindex="-1"></a>  ggnewscale<span class="sc">::</span><span class="fu">new_scale_fill</span>() <span class="sc">+</span></span>
<span id="cb98-3"><a href="s01.html#cb98-3" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> crowns_metrics_df, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">fill =</span> crr), <span class="at">color =</span> <span class="st">&quot;steelblue&quot;</span>) <span class="sc">+</span></span>
<span id="cb98-4"><a href="s01.html#cb98-4" tabindex="-1"></a>  harrypotter<span class="sc">::</span><span class="fu">scale_fill_hp</span>(<span class="st">&quot;always&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>)</span></code></pre></div>
<p><img src="uas_sfm_tree_detection_files/figure-html/unnamed-chunk-67-1.png" width="1008" /></p>
<p>how about crown diameter?</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="s01.html#cb99-1" tabindex="-1"></a>plt_chm <span class="sc">+</span></span>
<span id="cb99-2"><a href="s01.html#cb99-2" tabindex="-1"></a>  ggnewscale<span class="sc">::</span><span class="fu">new_scale_fill</span>() <span class="sc">+</span></span>
<span id="cb99-3"><a href="s01.html#cb99-3" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> crowns_metrics_df, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">fill =</span> crown_diam), <span class="at">color =</span> <span class="st">&quot;steelblue&quot;</span>) <span class="sc">+</span></span>
<span id="cb99-4"><a href="s01.html#cb99-4" tabindex="-1"></a>  harrypotter<span class="sc">::</span><span class="fu">scale_fill_hp</span>(<span class="st">&quot;always&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>)</span></code></pre></div>
<p><img src="uas_sfm_tree_detection_files/figure-html/unnamed-chunk-68-1.png" width="1008" /></p>
</div>
<div id="lai-lad-metrics-by-trees" class="section level3 hasAnchor" number="2.3.4">
<h3><span class="header-section-number">2.3.4</span> LAI-LAD metrics by Trees<a href="s01.html#lai-lad-metrics-by-trees" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>see this section of the <a href="https://github.com/olgaviedma/LadderFuelsR?tab=readme-ov-file#7lai-lad-metrics-by-trees">package README</a></p>
<blockquote>
<p>after height normalization and crown segmentation, the LiDAR returns were cropped with the crown contours being voxelized to obtain VHPs from which the absolute mean LAD at each height bin was retrieved (<a href="https://doi.org/10.1111/2041-210X.14427">Viedma et al. 2024</a>, p.2).</p>
</blockquote>
<p>in this section, the las files cropped to individual trees (i.e. one tree at a time) are passed to the <code>leafR</code> package to calculate the LAI-LAD metrics. it seems very inefficient to perform this one-by-one for individual tree point clouds and not something that would work well if many, many trees.</p>
<p>let’s go through the process for one tree point cloud</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="s01.html#cb100-1" tabindex="-1"></a><span class="co"># leafR::lad.voxels requires a file location :\</span></span>
<span id="cb100-2"><a href="s01.html#cb100-2" tabindex="-1"></a>fn <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">tempdir</span>(), <span class="st">&quot;/temp.las&quot;</span>)</span>
<span id="cb100-3"><a href="s01.html#cb100-3" tabindex="-1"></a><span class="co"># let&#39;s sample the tree with the most points</span></span>
<span id="cb100-4"><a href="s01.html#cb100-4" tabindex="-1"></a>ti <span class="ot">&lt;-</span> crowns_nlas_temp<span class="sc">@</span>data <span class="sc">%&gt;%</span> </span>
<span id="cb100-5"><a href="s01.html#cb100-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(tree_index) <span class="sc">%&gt;%</span> </span>
<span id="cb100-6"><a href="s01.html#cb100-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb100-7"><a href="s01.html#cb100-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice_head</span>(<span class="at">n=</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb100-8"><a href="s01.html#cb100-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(tree_index)</span>
<span id="cb100-9"><a href="s01.html#cb100-9" tabindex="-1"></a>f <span class="ot">&lt;-</span> crowns_nlas_temp <span class="sc">%&gt;%</span> </span>
<span id="cb100-10"><a href="s01.html#cb100-10" tabindex="-1"></a>    lidR<span class="sc">::</span><span class="fu">filter_poi</span>(tree_index <span class="sc">==</span> ti) <span class="sc">%&gt;%</span> <span class="co"># put this in a function and map over trees</span></span>
<span id="cb100-11"><a href="s01.html#cb100-11" tabindex="-1"></a>    lidR<span class="sc">::</span><span class="fu">writeLAS</span>(<span class="at">file =</span> fn)</span></code></pre></div>
<div id="leafrlad.voxels" class="section level4 hasAnchor" number="2.3.4.1">
<h4><span class="header-section-number">2.3.4.1</span> <code>leafR::lad.voxels</code><a href="s01.html#leafrlad.voxels" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Creates a data frame of the 3D voxels information (xyz) with Leaf Area Density values from las file.</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb101-1"><a href="s01.html#cb101-1" tabindex="-1"></a><span class="do">##### leafR::lad.voxels</span></span>
<span id="cb101-2"><a href="s01.html#cb101-2" tabindex="-1"></a>  <span class="co"># Creates a data frame of the 3D voxels information (xyz) with Leaf Area Density values from las file</span></span>
<span id="cb101-3"><a href="s01.html#cb101-3" tabindex="-1"></a>  lad_voxels <span class="ot">&lt;-</span> leafR<span class="sc">::</span><span class="fu">lad.voxels</span>(</span>
<span id="cb101-4"><a href="s01.html#cb101-4" tabindex="-1"></a>    <span class="co"># normlas.file requires a file location :\</span></span>
<span id="cb101-5"><a href="s01.html#cb101-5" tabindex="-1"></a>    <span class="at">normlas.file =</span> f</span>
<span id="cb101-6"><a href="s01.html#cb101-6" tabindex="-1"></a>    , <span class="at">grain.size =</span> <span class="dv">2</span></span>
<span id="cb101-7"><a href="s01.html#cb101-7" tabindex="-1"></a>  )</span>
<span id="cb101-8"><a href="s01.html#cb101-8" tabindex="-1"></a><span class="fu">class</span>(lad_voxels)</span></code></pre></div>
<pre><code>## [1] &quot;list&quot;</code></pre>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="s01.html#cb103-1" tabindex="-1"></a><span class="fu">str</span>(lad_voxels)</span></code></pre></div>
<pre><code>## List of 2
##  $ LAD        : num [1:20, 1:14] NA 0 0 0 0 ...
##  $ coordenates:&#39;data.frame&#39;: 20 obs. of  2 variables:
##   ..$ X: num [1:20] 453559 453561 453563 453565 453567 ...
##   ..$ Y: num [1:20] 4458585 4458585 4458585 4458585 4458585 ...</code></pre>
</div>
<div id="leafrlad.profile" class="section level4 hasAnchor" number="2.3.4.2">
<h4><span class="header-section-number">2.3.4.2</span> <code>leafR::lad.profile</code><a href="s01.html#leafrlad.profile" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This function calculate the lad profile from the input lad.voxels. By “profile” I think they mean “vertical height profile”</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb105-1"><a href="s01.html#cb105-1" tabindex="-1"></a><span class="do">##### leafR::lad.profile</span></span>
<span id="cb105-2"><a href="s01.html#cb105-2" tabindex="-1"></a>  <span class="co"># This function calculate the lad profile from the input lad.voxels</span></span>
<span id="cb105-3"><a href="s01.html#cb105-3" tabindex="-1"></a>  lad_profile <span class="ot">&lt;-</span> leafR<span class="sc">::</span><span class="fu">lad.profile</span>(lad_voxels, <span class="at">relative =</span> F)</span>
<span id="cb105-4"><a href="s01.html#cb105-4" tabindex="-1"></a>  <span class="fu">class</span>(lad_profile)</span></code></pre></div>
<pre><code>## [1] &quot;data.frame&quot;</code></pre>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="s01.html#cb107-1" tabindex="-1"></a>  <span class="fu">str</span>(lad_profile)</span></code></pre></div>
<pre><code>## &#39;data.frame&#39;:    14 obs. of  2 variables:
##  $ height: num  1.5 2.5 3.5 4.5 5.5 6.5 7.5 8.5 9.5 10.5 ...
##  $ lad   : num  0.693 0.405 0.78 0.45 0.289 ...</code></pre>
</div>
<div id="leafrlai" class="section level4 hasAnchor" number="2.3.4.3">
<h4><span class="header-section-number">2.3.4.3</span> <code>leafR::lai</code><a href="s01.html#leafrlai" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>calculates the lead area index (LAI)</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="s01.html#cb109-1" tabindex="-1"></a>lai_tot <span class="ot">&lt;-</span> leafR<span class="sc">::</span><span class="fu">lai</span>(lad_profile)</span>
<span id="cb109-2"><a href="s01.html#cb109-2" tabindex="-1"></a>lai_understory <span class="ot">&lt;-</span> leafR<span class="sc">::</span><span class="fu">lai</span>(lad_profile, <span class="at">min =</span> <span class="fl">0.3</span>, <span class="at">max =</span> <span class="fl">2.5</span>)</span>
<span id="cb109-3"><a href="s01.html#cb109-3" tabindex="-1"></a><span class="fu">class</span>(lai_tot)</span></code></pre></div>
<pre><code>## [1] &quot;numeric&quot;</code></pre>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="s01.html#cb111-1" tabindex="-1"></a><span class="fu">str</span>(lai_tot)</span></code></pre></div>
<pre><code>##  num 3.83</code></pre>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb113-1"><a href="s01.html#cb113-1" tabindex="-1"></a><span class="fu">str</span>(lai_understory)</span></code></pre></div>
<pre><code>##  num 1.1</code></pre>
</div>
<div id="leafrlahv" class="section level4 hasAnchor" number="2.3.4.4">
<h4><span class="header-section-number">2.3.4.4</span> <code>leafR::LAHV</code><a href="s01.html#leafrlahv" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Calculates the leaf area height volume (LAHV) metric as described in <a href="https://scholar.google.com/scholar?cluster=7365610385622591776&amp;hl=en&amp;as_sdt=0,6">Almeida et al. (2019)</a></p>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb115-1"><a href="s01.html#cb115-1" tabindex="-1"></a>lahv_metric <span class="ot">&lt;-</span> leafR<span class="sc">::</span><span class="fu">LAHV</span>(lad_profile, <span class="at">LAI.weighting =</span> <span class="cn">FALSE</span>, <span class="at">height.weighting =</span> <span class="cn">FALSE</span>)</span>
<span id="cb115-2"><a href="s01.html#cb115-2" tabindex="-1"></a><span class="fu">class</span>(lahv_metric)</span></code></pre></div>
<pre><code>## [1] &quot;numeric&quot;</code></pre>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb117-1"><a href="s01.html#cb117-1" tabindex="-1"></a><span class="fu">str</span>(lahv_metric)</span></code></pre></div>
<pre><code>##  num 18.2</code></pre>
</div>
<div id="huh" class="section level4 hasAnchor" number="2.3.4.5">
<h4><span class="header-section-number">2.3.4.5</span> Bring together and clean<a href="s01.html#huh" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>they call this “Depurating Tree LAD profiles”</p>
<ul>
<li>replace missing LAD values with <code>0.01</code> (no explanation of “why”)</li>
<li>keep only trees where there are at least 6 profile (vertical height profile) records (&gt;5)</li>
</ul>
<div class="sourceCode" id="cb119"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb119-1"><a href="s01.html#cb119-1" tabindex="-1"></a>leafr_df <span class="ot">&lt;-</span></span>
<span id="cb119-2"><a href="s01.html#cb119-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb119-3"><a href="s01.html#cb119-3" tabindex="-1"></a>    <span class="at">tree_index =</span> ti <span class="co"># put this in a function and map over trees</span></span>
<span id="cb119-4"><a href="s01.html#cb119-4" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb119-5"><a href="s01.html#cb119-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(lad_profile) <span class="sc">%&gt;%</span> </span>
<span id="cb119-6"><a href="s01.html#cb119-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb119-7"><a href="s01.html#cb119-7" tabindex="-1"></a>    <span class="at">lad =</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(lad, <span class="fl">0.01</span>) <span class="co"># not sure why they put in 0.01 here</span></span>
<span id="cb119-8"><a href="s01.html#cb119-8" tabindex="-1"></a>    , <span class="at">lai_tot =</span> lai_tot[<span class="dv">1</span>]</span>
<span id="cb119-9"><a href="s01.html#cb119-9" tabindex="-1"></a>    , <span class="at">lai_understory =</span> lai_understory[<span class="dv">1</span>]</span>
<span id="cb119-10"><a href="s01.html#cb119-10" tabindex="-1"></a>    , <span class="at">lahv =</span> lahv_metric[<span class="dv">1</span>]</span>
<span id="cb119-11"><a href="s01.html#cb119-11" tabindex="-1"></a>    , <span class="at">vhp_n =</span> dplyr<span class="sc">::</span><span class="fu">n</span>() <span class="co"># they keep trees where there are at least 6 (&gt;5)</span></span>
<span id="cb119-12"><a href="s01.html#cb119-12" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb119-13"><a href="s01.html#cb119-13" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(tree_index, height)</span></code></pre></div>
<p>what is this?</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb120-1"><a href="s01.html#cb120-1" tabindex="-1"></a>leafr_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 14
## Columns: 7
## $ tree_index     &lt;int&gt; 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78
## $ height         &lt;dbl&gt; 1.5, 2.5, 3.5, 4.5, 5.5, 6.5, 7.5, 8.5, 9.5, 10.5, 11.5…
## $ lad            &lt;dbl&gt; 0.693147181, 0.405465108, 0.780157428, 0.449590086, 0.2…
## $ lai_tot        &lt;dbl&gt; 3.825655, 3.825655, 3.825655, 3.825655, 3.825655, 3.825…
## $ lai_understory &lt;dbl&gt; 1.098612, 1.098612, 1.098612, 1.098612, 1.098612, 1.098…
## $ lahv           &lt;dbl&gt; 18.2418, 18.2418, 18.2418, 18.2418, 18.2418, 18.2418, 1…
## $ vhp_n          &lt;int&gt; 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14</code></pre>
<p>seems like the data used to create Figure 1 (b)</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb122-1"><a href="s01.html#cb122-1" tabindex="-1"></a>leafr_df <span class="sc">%&gt;%</span> </span>
<span id="cb122-2"><a href="s01.html#cb122-2" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> lad, <span class="at">y =</span> height)) <span class="sc">+</span> </span>
<span id="cb122-3"><a href="s01.html#cb122-3" tabindex="-1"></a>    <span class="fu">geom_path</span>() <span class="sc">+</span></span>
<span id="cb122-4"><a href="s01.html#cb122-4" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb122-5"><a href="s01.html#cb122-5" tabindex="-1"></a>    <span class="fu">theme_light</span>()</span></code></pre></div>
<p><img src="uas_sfm_tree_detection_files/figure-html/unnamed-chunk-77-1.png" width="1008" /></p>
<p>what about the point cloud in voxels?</p>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb123-1"><a href="s01.html#cb123-1" tabindex="-1"></a><span class="co"># calculate voxel metrics</span></span>
<span id="cb123-2"><a href="s01.html#cb123-2" tabindex="-1"></a><span class="fu">voxel_metrics</span>(</span>
<span id="cb123-3"><a href="s01.html#cb123-3" tabindex="-1"></a>  crowns_nlas_temp <span class="sc">%&gt;%</span> lidR<span class="sc">::</span><span class="fu">filter_poi</span>(tree_index <span class="sc">==</span> ti)</span>
<span id="cb123-4"><a href="s01.html#cb123-4" tabindex="-1"></a>  , <span class="sc">~</span><span class="fu">list</span>(<span class="at">N =</span> <span class="fu">length</span>(Z))</span>
<span id="cb123-5"><a href="s01.html#cb123-5" tabindex="-1"></a>  , <span class="dv">2</span></span>
<span id="cb123-6"><a href="s01.html#cb123-6" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb123-7"><a href="s01.html#cb123-7" tabindex="-1"></a>  lidR<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb123-8"><a href="s01.html#cb123-8" tabindex="-1"></a>    <span class="at">color=</span><span class="st">&quot;N&quot;</span>, <span class="at">pal =</span> viridis<span class="sc">::</span><span class="fu">mako</span>(<span class="at">n =</span> <span class="dv">11</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb123-9"><a href="s01.html#cb123-9" tabindex="-1"></a>    , <span class="at">size =</span> <span class="dv">2</span>, <span class="at">bg =</span> <span class="st">&quot;white&quot;</span>, <span class="at">voxel =</span> <span class="cn">TRUE</span>, <span class="at">legend =</span> T</span>
<span id="cb123-10"><a href="s01.html#cb123-10" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="uas_sfm_tree_detection_files/figure-html/unnamed-chunk-79-1.png" width="1008" /></p>
</div>
</div>
<div id="i-quit" class="section level3 hasAnchor" number="2.3.5">
<h3><span class="header-section-number">2.3.5</span> I quit<a href="s01.html#i-quit" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>I quit following the <a href="https://github.com/olgaviedma/LadderFuelsR">package README</a> because it’s unnecessarily complex</p>
</div>
</div>
<div id="ladr_s" class="section level2 hasAnchor" number="2.4">
<h2><span class="header-section-number">2.4</span> <code>LadderFuelsR</code> - simplified<a href="s01.html#ladr_s" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>the <a href="https://github.com/olgaviedma/LadderFuelsR">package README</a> is so convoluted and difficult to follow. let’s just cut the superfluity (i’ll see your <a href="s01.html#huh">“depurating”</a> and raise you “superfluity”).</p>
<p>someone had to identify the minimum steps needed to get CBH and cut out the superfluous clutter (bonus points if you see what i did there ;).</p>
<div id="setup" class="section level3 hasAnchor" number="2.4.1">
<h3><span class="header-section-number">2.4.1</span> Setup<a href="s01.html#setup" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>the las files cropped to individual trees (i.e. one tree at a time) are passed to the <code>leafR</code> package to calculate the LAI-LAD metrics. it seems very inefficient to perform this one-by-one for individual tree point clouds and not something that would work well if many, many trees.</p>
<p>let’s go through the process for one tree point cloud</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb124-1"><a href="s01.html#cb124-1" tabindex="-1"></a><span class="co"># leafR::lad.voxels requires a file location :\</span></span>
<span id="cb124-2"><a href="s01.html#cb124-2" tabindex="-1"></a>fn <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">tempdir</span>(), <span class="st">&quot;/temp.las&quot;</span>)</span>
<span id="cb124-3"><a href="s01.html#cb124-3" tabindex="-1"></a><span class="co"># let&#39;s sample the tree with the most points</span></span>
<span id="cb124-4"><a href="s01.html#cb124-4" tabindex="-1"></a>ti <span class="ot">&lt;-</span> crowns_nlas_temp<span class="sc">@</span>data <span class="sc">%&gt;%</span> </span>
<span id="cb124-5"><a href="s01.html#cb124-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(tree_index) <span class="sc">%&gt;%</span> </span>
<span id="cb124-6"><a href="s01.html#cb124-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb124-7"><a href="s01.html#cb124-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice_head</span>(<span class="at">n=</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb124-8"><a href="s01.html#cb124-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(tree_index)</span>
<span id="cb124-9"><a href="s01.html#cb124-9" tabindex="-1"></a>(</span>
<span id="cb124-10"><a href="s01.html#cb124-10" tabindex="-1"></a>f <span class="ot">&lt;-</span> crowns_nlas_temp <span class="sc">%&gt;%</span> </span>
<span id="cb124-11"><a href="s01.html#cb124-11" tabindex="-1"></a>    lidR<span class="sc">::</span><span class="fu">filter_poi</span>(tree_index <span class="sc">==</span> ti) <span class="sc">%&gt;%</span> <span class="co"># put this in a function and map over trees</span></span>
<span id="cb124-12"><a href="s01.html#cb124-12" tabindex="-1"></a>    lidR<span class="sc">::</span><span class="fu">writeLAS</span>(<span class="at">file =</span> fn)</span>
<span id="cb124-13"><a href="s01.html#cb124-13" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## [1] &quot;C:\\Users\\georg\\AppData\\Local\\Temp\\RtmpMLixba/temp.las&quot;</code></pre>
</div>
<div id="step-0---leafr-steps" class="section level3 hasAnchor" number="2.4.2">
<h3><span class="header-section-number">2.4.2</span> Step 0 - <code>leafR</code> steps<a href="s01.html#step-0---leafr-steps" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ol style="list-style-type: decimal">
<li><code>leafR::lad.voxels()</code> - use normalized las file to create a data frame of the 3D voxels information (xyz) with Leaf Area Density values</li>
<li><code>leafR::lad.profile()</code> - calculate the lad profile from the input lad.voxels (step 1)</li>
<li>ensure that the data frame returned from <code>leafR::lad.profile()</code> has a column named <code>treeID</code> which uniquely identifies individual trees. also, that column has to be the first column (bad practice by the authors)</li>
</ol>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb126-1"><a href="s01.html#cb126-1" tabindex="-1"></a><span class="do">## leafR::lad.voxels</span></span>
<span id="cb126-2"><a href="s01.html#cb126-2" tabindex="-1"></a>lad_voxels <span class="ot">&lt;-</span> leafR<span class="sc">::</span><span class="fu">lad.voxels</span>(<span class="at">normlas.file =</span> f, <span class="at">grain.size =</span> <span class="dv">2</span>)</span>
<span id="cb126-3"><a href="s01.html#cb126-3" tabindex="-1"></a>lad_voxels <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## List of 2
##  $ LAD        : num [1:20, 1:14] NA 0 0 0 0 ...
##  $ coordenates:&#39;data.frame&#39;: 20 obs. of  2 variables:
##   ..$ X: num [1:20] 453559 453561 453563 453565 453567 ...
##   ..$ Y: num [1:20] 4458585 4458585 4458585 4458585 4458585 ...</code></pre>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb128-1"><a href="s01.html#cb128-1" tabindex="-1"></a><span class="do">## leafR::lad.profile</span></span>
<span id="cb128-2"><a href="s01.html#cb128-2" tabindex="-1"></a>lad_profile <span class="ot">&lt;-</span> leafR<span class="sc">::</span><span class="fu">lad.profile</span>(lad_voxels, <span class="at">relative =</span> F)</span>
<span id="cb128-3"><a href="s01.html#cb128-3" tabindex="-1"></a><span class="do">## add treeID column that is required by the package, though it&#39;s never stated</span></span>
<span id="cb128-4"><a href="s01.html#cb128-4" tabindex="-1"></a>lad_profile <span class="ot">&lt;-</span> lad_profile <span class="sc">%&gt;%</span> </span>
<span id="cb128-5"><a href="s01.html#cb128-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">tree_index =</span> ti, <span class="at">treeID =</span> <span class="fu">factor</span>(tree_index)) <span class="sc">%&gt;%</span> </span>
<span id="cb128-6"><a href="s01.html#cb128-6" tabindex="-1"></a>  <span class="do">## !!!!! not only does the treeID column have to exist...it has to be the first column</span></span>
<span id="cb128-7"><a href="s01.html#cb128-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(treeID)</span>
<span id="cb128-8"><a href="s01.html#cb128-8" tabindex="-1"></a>lad_profile <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 14
## Columns: 4
## $ treeID     &lt;fct&gt; 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78
## $ height     &lt;dbl&gt; 1.5, 2.5, 3.5, 4.5, 5.5, 6.5, 7.5, 8.5, 9.5, 10.5, 11.5, 12…
## $ lad        &lt;dbl&gt; 0.693147181, 0.405465108, 0.780157428, 0.449590086, 0.28920…
## $ tree_index &lt;int&gt; 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78</code></pre>
</div>
<div id="step-1---ladderfuelsrget_gaps_fbhs" class="section level3 hasAnchor" number="2.4.3">
<h3><span class="header-section-number">2.4.3</span> Step 1 - <code>LadderFuelsR::get_gaps_fbhs</code><a href="s01.html#step-1---ladderfuelsrget_gaps_fbhs" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>calculates gaps and fuel layers base height (FBH) as the difference in percentiles between consecutive LAD values along the vertical tree profile (VTP). Negative differences are linked to gaps and positive differences to fuel base height.</p>
<p><strong>notice that this function is broken in the package…see <a href="https://github.com/olgaviedma/LadderFuelsR/issues/2">this issue</a></strong></p>
<p><a href="https://doi.org/10.1111/2041-210X.14427">Viedma et al. 2024</a> note:</p>
<blockquote>
<p>Function <code>get_gaps_fbhs()</code> identifies height bins with negative differences in LAD percentile for identifying gaps. When among consecutive height bins differences are negative, it selects the height bin with the lowest LAD (&lt;= perc_gap [P25th]). Additionally, the function looks for height bins with LAD &lt;= P25th, and when they are consecutive, it takes only the first and last values of the set being considered. For obtaining fuel layer base heights (FBHs), it identifies height bins with positive differences in LAD percentile. When such positive differences are consecutive, it selects the height bin with minimum LAD (&gt; perc_base [P25th]). Moreover, it filters height bins with LAD &gt; P25th, and when these are consecutive it takes only the first and last values of each set. Finally, to avoid any duplicated height bins in gaps and FBHs, it selects only the height bins identified as gaps that were not present in the FBH file, giving preference to the FBH height bins (p.3-5)</p>
</blockquote>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb130-1"><a href="s01.html#cb130-1" tabindex="-1"></a><span class="do">### this function is broken!!!!!!!!!!!!!!!!!!!!!!!!!!</span></span>
<span id="cb130-2"><a href="s01.html#cb130-2" tabindex="-1"></a><span class="fu">source</span>(<span class="st">&quot;_broken_gap_fbh_from_LadderFuelsR.R&quot;</span>) <span class="co"># gw fix here</span></span>
<span id="cb130-3"><a href="s01.html#cb130-3" tabindex="-1"></a><span class="do">## LadderFuelsR::get_gaps_fbhs</span></span>
<span id="cb130-4"><a href="s01.html#cb130-4" tabindex="-1"></a>gaps_fbhs <span class="ot">&lt;-</span> </span>
<span id="cb130-5"><a href="s01.html#cb130-5" tabindex="-1"></a>  <span class="fu">gw_get_gaps_fbhs</span>(</span>
<span id="cb130-6"><a href="s01.html#cb130-6" tabindex="-1"></a>  <span class="co"># LadderFuelsR::get_gaps_fbhs(</span></span>
<span id="cb130-7"><a href="s01.html#cb130-7" tabindex="-1"></a>    <span class="at">LAD_profiles =</span> lad_profile</span>
<span id="cb130-8"><a href="s01.html#cb130-8" tabindex="-1"></a>    , <span class="at">step=</span><span class="dv">1</span></span>
<span id="cb130-9"><a href="s01.html#cb130-9" tabindex="-1"></a>    , <span class="at">min_height=</span><span class="fl">1.5</span></span>
<span id="cb130-10"><a href="s01.html#cb130-10" tabindex="-1"></a>    , <span class="at">perc_gap=</span> <span class="dv">25</span>, <span class="at">perc_base=</span> <span class="dv">25</span></span>
<span id="cb130-11"><a href="s01.html#cb130-11" tabindex="-1"></a>    , <span class="at">verbose=</span><span class="cn">TRUE</span></span>
<span id="cb130-12"><a href="s01.html#cb130-12" tabindex="-1"></a>  )</span>
<span id="cb130-13"><a href="s01.html#cb130-13" tabindex="-1"></a>gaps_fbhs <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 1
## Columns: 24
## $ treeID     &lt;fct&gt; 78
## $ cbh1       &lt;chr&gt; &quot;1.5&quot;
## $ cbh2       &lt;chr&gt; &quot;3.5&quot;
## $ cbh3       &lt;chr&gt; &quot;6.5&quot;
## $ cbh4       &lt;chr&gt; &quot;9.5&quot;
## $ gap1       &lt;chr&gt; &quot;10.5&quot;
## $ cbh5       &lt;chr&gt; &quot;11.5&quot;
## $ gap2       &lt;chr&gt; &quot;12.5&quot;
## $ gap3       &lt;chr&gt; &quot;14.5&quot;
## $ gap_lad1   &lt;dbl&gt; 0
## $ gap_lad2   &lt;dbl&gt; 0
## $ gap_lad3   &lt;dbl&gt; 0
## $ cbh_perc1  &lt;dbl&gt; 95
## $ cbh_perc2  &lt;dbl&gt; 100
## $ cbh_perc3  &lt;dbl&gt; 80
## $ cbh_perc4  &lt;dbl&gt; 40
## $ cbh_perc5  &lt;dbl&gt; 35
## $ cbh_lad1   &lt;dbl&gt; 1
## $ cbh_lad2   &lt;dbl&gt; 3
## $ cbh_lad3   &lt;dbl&gt; 6
## $ cbh_lad4   &lt;dbl&gt; 9
## $ cbh_lad5   &lt;dbl&gt; 11
## $ max_height &lt;dbl&gt; 14.5
## $ treeID1    &lt;dbl&gt; 78</code></pre>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb132-1"><a href="s01.html#cb132-1" tabindex="-1"></a><span class="co"># fix the columns that should be numeric</span></span>
<span id="cb132-2"><a href="s01.html#cb132-2" tabindex="-1"></a>gaps_fbhs <span class="ot">&lt;-</span> gaps_fbhs <span class="sc">%&gt;%</span> </span>
<span id="cb132-3"><a href="s01.html#cb132-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(dplyr<span class="sc">::</span><span class="fu">across</span>(</span>
<span id="cb132-4"><a href="s01.html#cb132-4" tabindex="-1"></a>    <span class="sc">!</span>tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;treeID&quot;</span>)</span>
<span id="cb132-5"><a href="s01.html#cb132-5" tabindex="-1"></a>    , as.numeric</span>
<span id="cb132-6"><a href="s01.html#cb132-6" tabindex="-1"></a>  ))</span></code></pre></div>
<p>let’s take <code>LadderFuelsR::get_plots_gap_fbh()</code> for a spin which creates the plot in Figure 3 (plots of leaf area density profiles with fuel base heights in green and gaps &gt;= step: Distance between bins in red).</p>
<blockquote>
<p>This function plots gaps and fuel layers base height (fbh) in the vertical tree profile (VTP).</p>
</blockquote>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb133-1"><a href="s01.html#cb133-1" tabindex="-1"></a>LadderFuelsR<span class="sc">::</span><span class="fu">get_plots_gap_fbh</span>(</span>
<span id="cb133-2"><a href="s01.html#cb133-2" tabindex="-1"></a>  <span class="at">LAD_profiles =</span> lad_profile</span>
<span id="cb133-3"><a href="s01.html#cb133-3" tabindex="-1"></a>  , <span class="at">gap_cbh_metrics =</span> gaps_fbhs</span>
<span id="cb133-4"><a href="s01.html#cb133-4" tabindex="-1"></a>  , <span class="at">min_height =</span> <span class="fl">1.5</span></span>
<span id="cb133-5"><a href="s01.html#cb133-5" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## $`78`</code></pre>
<p><img src="uas_sfm_tree_detection_files/figure-html/unnamed-chunk-83-1.png" width="1008" /></p>
<p>in RED are the GAPS and in GREEN the FBHs</p>
<p>can we re-create this?</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb135-1"><a href="s01.html#cb135-1" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb135-2"><a href="s01.html#cb135-2" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="at">data =</span> lad_profile, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> lad, <span class="at">y =</span> height)) <span class="sc">+</span></span>
<span id="cb135-3"><a href="s01.html#cb135-3" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> lad_profile, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> lad, <span class="at">y =</span> height)) <span class="sc">+</span></span>
<span id="cb135-4"><a href="s01.html#cb135-4" tabindex="-1"></a>  <span class="co"># gaps data</span></span>
<span id="cb135-5"><a href="s01.html#cb135-5" tabindex="-1"></a>  <span class="fu">geom_hline</span>(</span>
<span id="cb135-6"><a href="s01.html#cb135-6" tabindex="-1"></a>    <span class="at">data =</span> gaps_fbhs <span class="sc">%&gt;%</span> </span>
<span id="cb135-7"><a href="s01.html#cb135-7" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb135-8"><a href="s01.html#cb135-8" tabindex="-1"></a>        tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;gap&quot;</span>) <span class="sc">&amp;</span> <span class="sc">!</span>tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;gap_&quot;</span>)</span>
<span id="cb135-9"><a href="s01.html#cb135-9" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb135-10"><a href="s01.html#cb135-10" tabindex="-1"></a>      tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(dplyr<span class="sc">::</span><span class="fu">everything</span>())</span>
<span id="cb135-11"><a href="s01.html#cb135-11" tabindex="-1"></a>    , <span class="fu">aes</span>(<span class="at">yintercept =</span> value, <span class="at">color =</span> <span class="st">&quot;gaps&quot;</span>)</span>
<span id="cb135-12"><a href="s01.html#cb135-12" tabindex="-1"></a>    , <span class="at">linetype =</span> <span class="st">&quot;dotted&quot;</span></span>
<span id="cb135-13"><a href="s01.html#cb135-13" tabindex="-1"></a>    , <span class="at">lwd =</span> <span class="fl">1.2</span></span>
<span id="cb135-14"><a href="s01.html#cb135-14" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb135-15"><a href="s01.html#cb135-15" tabindex="-1"></a>  <span class="co"># fbh data</span></span>
<span id="cb135-16"><a href="s01.html#cb135-16" tabindex="-1"></a>  <span class="fu">geom_hline</span>(</span>
<span id="cb135-17"><a href="s01.html#cb135-17" tabindex="-1"></a>    <span class="at">data =</span> gaps_fbhs <span class="sc">%&gt;%</span> </span>
<span id="cb135-18"><a href="s01.html#cb135-18" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb135-19"><a href="s01.html#cb135-19" tabindex="-1"></a>        tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;cbh&quot;</span>) <span class="sc">&amp;</span> <span class="sc">!</span>tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;cbh_&quot;</span>)</span>
<span id="cb135-20"><a href="s01.html#cb135-20" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb135-21"><a href="s01.html#cb135-21" tabindex="-1"></a>      tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(dplyr<span class="sc">::</span><span class="fu">everything</span>())</span>
<span id="cb135-22"><a href="s01.html#cb135-22" tabindex="-1"></a>    , <span class="fu">aes</span>(<span class="at">yintercept =</span> value, <span class="at">color =</span> <span class="st">&quot;FBHs&quot;</span>)</span>
<span id="cb135-23"><a href="s01.html#cb135-23" tabindex="-1"></a>    , <span class="at">linetype =</span> <span class="st">&quot;dotdash&quot;</span></span>
<span id="cb135-24"><a href="s01.html#cb135-24" tabindex="-1"></a>    , <span class="at">lwd =</span> <span class="fl">1.2</span></span>
<span id="cb135-25"><a href="s01.html#cb135-25" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb135-26"><a href="s01.html#cb135-26" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;green4&quot;</span>, <span class="st">&quot;red&quot;</span>), <span class="at">name =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb135-27"><a href="s01.html#cb135-27" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">extended_breaks</span>(<span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb135-28"><a href="s01.html#cb135-28" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb135-29"><a href="s01.html#cb135-29" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>)</span></code></pre></div>
<p><img src="uas_sfm_tree_detection_files/figure-html/unnamed-chunk-84-1.png" width="1008" /></p>
<p>yes. the <code>gap</code> and <code>cbh</code> columns contain the data ( but not the <code>gap_</code> and <code>cbh_</code> columns ;/ ).</p>
<p>but what are these columns?</p>
<ul>
<li><code>cbh</code> - Height of the fuel layer base height (m)</li>
<li><code>gap</code> - Height of gap between fuel layers (m)</li>
</ul>
</div>
<div id="step-2---ladderfuelsrcalculate_gaps_perc" class="section level3 hasAnchor" number="2.4.4">
<h3><span class="header-section-number">2.4.4</span> Step 2 - <code>LadderFuelsR::calculate_gaps_perc</code><a href="s01.html#step-2---ladderfuelsrcalculate_gaps_perc" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>this function calculates the percentile value of each height</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb136-1"><a href="s01.html#cb136-1" tabindex="-1"></a><span class="do">## LadderFuelsR::calculate_gaps_perc</span></span>
<span id="cb136-2"><a href="s01.html#cb136-2" tabindex="-1"></a><span class="co">#!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! ERROR if treeID is not the first column</span></span>
<span id="cb136-3"><a href="s01.html#cb136-3" tabindex="-1"></a>gaps_perc <span class="ot">&lt;-</span> LadderFuelsR<span class="sc">::</span><span class="fu">calculate_gaps_perc</span>(</span>
<span id="cb136-4"><a href="s01.html#cb136-4" tabindex="-1"></a>  <span class="at">LAD_profiles =</span> lad_profile <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>tree_index)</span>
<span id="cb136-5"><a href="s01.html#cb136-5" tabindex="-1"></a>  , <span class="at">min_height=</span><span class="fl">1.5</span></span>
<span id="cb136-6"><a href="s01.html#cb136-6" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## [1] &quot;treeID: 78&quot;</code></pre>
<div class="sourceCode" id="cb138"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb138-1"><a href="s01.html#cb138-1" tabindex="-1"></a>gaps_perc <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 14
## Columns: 5
## $ treeID          &lt;fct&gt; 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78, 78
## $ height          &lt;dbl&gt; 1.5, 2.5, 3.5, 4.5, 5.5, 6.5, 7.5, 8.5, 9.5, 10.5, 11.…
## $ lad             &lt;dbl&gt; 0.693147181, 0.405465108, 0.780157428, 0.449590086, 0.…
## $ critical_points &lt;dbl&gt; -0.0000002167, 0.0000920681, -0.0000699130, 0.00015765…
## $ percentil       &lt;dbl&gt; 95, 70, 100, 85, 65, 80, 55, 50, 40, 25, 35, 20, 10, 5</code></pre>
</div>
<div id="step-3---ladderfuelsrget_distance" class="section level3 hasAnchor" number="2.4.5">
<h3><span class="header-section-number">2.4.5</span> Step 3 - <code>LadderFuelsR::get_distance</code><a href="s01.html#step-3---ladderfuelsrget_distance" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>calculates distances (and their heights) between fuel layers as the difference between consecutive gaps and fuel bases (the gap height always must be lower than the fuel base height).</p>
<p><a href="https://doi.org/10.1111/2041-210X.14427">Viedma et al. 2024</a> note:</p>
<blockquote>
<p>Function <code>get_distance()</code> calculates the distance between fuel layers as the height difference between each pair of consecutive gaps and FBHs (Figure 4a). In addition, when there are consecutive gaps, the distance is calculated as the difference between the minimum gap and the next FBH encountered (Figure 4b). Similarly, when there were consecutive FBHs, the distance was calculated as the difference between the minimum FBH and the previous gap encountered. When there are gaps above the last FBH, these values were removed for further analysis. (p.5)</p>
</blockquote>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb140-1"><a href="s01.html#cb140-1" tabindex="-1"></a><span class="do">## LadderFuelsR::get_distance</span></span>
<span id="cb140-2"><a href="s01.html#cb140-2" tabindex="-1"></a>metrics_distance <span class="ot">&lt;-</span> LadderFuelsR<span class="sc">::</span><span class="fu">get_distance</span>(</span>
<span id="cb140-3"><a href="s01.html#cb140-3" tabindex="-1"></a>  <span class="at">gap_cbh_metrics =</span> gaps_fbhs</span>
<span id="cb140-4"><a href="s01.html#cb140-4" tabindex="-1"></a>  , <span class="at">gaps_perc =</span> gaps_perc</span>
<span id="cb140-5"><a href="s01.html#cb140-5" tabindex="-1"></a>  , <span class="at">step=</span><span class="dv">1</span>, <span class="at">min_height=</span><span class="fl">1.5</span></span>
<span id="cb140-6"><a href="s01.html#cb140-6" tabindex="-1"></a>)</span>
<span id="cb140-7"><a href="s01.html#cb140-7" tabindex="-1"></a>metrics_distance <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 1
## Columns: 21
## $ treeID1    &lt;fct&gt; 78
## $ treeID     &lt;fct&gt; 78
## $ cbh1       &lt;dbl&gt; 1.5
## $ cbh2       &lt;dbl&gt; 3.5
## $ cbh3       &lt;dbl&gt; 6.5
## $ cbh4       &lt;dbl&gt; 9.5
## $ gap1       &lt;dbl&gt; 10.5
## $ cbh5       &lt;dbl&gt; 11.5
## $ gap2       &lt;dbl&gt; 12.5
## $ gap3       &lt;dbl&gt; 14.5
## $ dist5      &lt;dbl&gt; 1
## $ dist1      &lt;dbl&gt; 0
## $ max_height &lt;dbl&gt; 14.5
## $ dist2      &lt;dbl&gt; 0
## $ dist3      &lt;dbl&gt; 0
## $ dist4      &lt;dbl&gt; 0
## $ Hdist5     &lt;dbl&gt; 10.5
## $ Hdist1     &lt;dbl&gt; 1.5
## $ Hdist2     &lt;dbl&gt; 0
## $ Hdist3     &lt;dbl&gt; 0
## $ Hdist4     &lt;dbl&gt; 0</code></pre>
</div>
<div id="step-4---ladderfuelsrget_depths" class="section level3 hasAnchor" number="2.4.6">
<h3><span class="header-section-number">2.4.6</span> Step 4 - <code>LadderFuelsR::get_depths</code><a href="s01.html#step-4---ladderfuelsrget_depths" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>calculates fuels depth as the difference between gaps interleaved between fuel layers minus one step if the fuel depths are greater than one step.</p>
<p><a href="https://doi.org/10.1111/2041-210X.14427">Viedma et al. 2024</a> note:</p>
<blockquote>
<p>Function <code>get_depths()</code> calculates the depth of each fuel layer as the difference between the gaps comprising the FBHs. Finally, to get the real layer depth, and only when layer depth is greater than the step, it subtracts the step value from the depth (Figure 5). There are special cases when there are no gaps between FBHs: (i) if the gap height is less than the minimum height of the FBHs, depth is calculated as the difference between the maximum height of the FBHs set and the height of that gap minus the step (Figure 6a); (ii) if the gap height is greater than the maximum height of FBHs, depth is the difference between the maximum gap height and the minimum height of the FBHs set minus the step (Figure 6b). (p.5)</p>
</blockquote>
<div class="sourceCode" id="cb142"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb142-1"><a href="s01.html#cb142-1" tabindex="-1"></a><span class="do">## LadderFuelsR::get_depths</span></span>
<span id="cb142-2"><a href="s01.html#cb142-2" tabindex="-1"></a>metrics_depth <span class="ot">&lt;-</span> LadderFuelsR<span class="sc">::</span><span class="fu">get_depths</span>(</span>
<span id="cb142-3"><a href="s01.html#cb142-3" tabindex="-1"></a>  <span class="at">LAD_profiles =</span> lad_profile</span>
<span id="cb142-4"><a href="s01.html#cb142-4" tabindex="-1"></a>  , <span class="at">distance_metrics =</span> metrics_distance</span>
<span id="cb142-5"><a href="s01.html#cb142-5" tabindex="-1"></a>  , <span class="at">step=</span> <span class="dv">1</span>, <span class="at">min_height=</span> <span class="fl">1.5</span></span>
<span id="cb142-6"><a href="s01.html#cb142-6" tabindex="-1"></a>)</span>
<span id="cb142-7"><a href="s01.html#cb142-7" tabindex="-1"></a>metrics_depth <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 1
## Columns: 13
## $ treeID     &lt;fct&gt; 78
## $ treeID1    &lt;fct&gt; 78
## $ Hdepth1    &lt;dbl&gt; 9.5
## $ Hdepth2    &lt;dbl&gt; 11.5
## $ dist1      &lt;dbl&gt; 1.5
## $ dist2      &lt;dbl&gt; 1
## $ Hdist1     &lt;dbl&gt; 1.5
## $ Hdist2     &lt;dbl&gt; 10.5
## $ depth1     &lt;dbl&gt; 8
## $ depth2     &lt;dbl&gt; 1
## $ cbh1       &lt;dbl&gt; 1.5
## $ cbh2       &lt;dbl&gt; 11.5
## $ max_height &lt;dbl&gt; 14.5</code></pre>
</div>
<div id="step-5---ladderfuelsrget_real_fbh" class="section level3 hasAnchor" number="2.4.7">
<h3><span class="header-section-number">2.4.7</span> Step 5 - <code>LadderFuelsR::get_real_fbh</code><a href="s01.html#step-5---ladderfuelsrget_real_fbh" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>reshapes fuel layers after removing distances equal to any number of height bin steps, keeping the first “base height” from those consecutive ones separated by such distance.</p>
<p><a href="https://doi.org/10.1111/2041-210X.14427">Viedma et al. 2024</a> note:</p>
<blockquote>
<p>Function <code>get_real_fbh()</code> identifies the first FBH from consecutive FBHs or the first FBH from those separated by a distance equal to number of steps that can be skipped to reshape the fuel layers. For each distance value, it locates the next FBH value. If distance = num_step, the height of that FBH is propagated upwards. If distance &gt; num_step, the height of that FBH is kept (Figure 7a,b). (p.5-6)</p>
</blockquote>
<div class="sourceCode" id="cb144"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb144-1"><a href="s01.html#cb144-1" tabindex="-1"></a><span class="do">## LadderFuelsR::get_real_fbh</span></span>
<span id="cb144-2"><a href="s01.html#cb144-2" tabindex="-1"></a>real_fbh <span class="ot">&lt;-</span> LadderFuelsR<span class="sc">::</span><span class="fu">get_real_fbh</span>(</span>
<span id="cb144-3"><a href="s01.html#cb144-3" tabindex="-1"></a>  <span class="at">depth_metrics =</span> metrics_depth</span>
<span id="cb144-4"><a href="s01.html#cb144-4" tabindex="-1"></a>  , <span class="at">step=</span> <span class="dv">1</span>, <span class="at">number_steps =</span> <span class="dv">1</span>, <span class="at">min_height=</span><span class="fl">1.5</span></span>
<span id="cb144-5"><a href="s01.html#cb144-5" tabindex="-1"></a>)</span>
<span id="cb144-6"><a href="s01.html#cb144-6" tabindex="-1"></a>real_fbh <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 1
## Columns: 13
## $ treeID1    &lt;dbl&gt; 78
## $ Hdepth1    &lt;dbl&gt; 9.5
## $ dist1      &lt;dbl&gt; 1.5
## $ Hdist1     &lt;dbl&gt; 1.5
## $ depth1     &lt;dbl&gt; 8
## $ Hcbh1      &lt;dbl&gt; 1.5
## $ Hdepth2    &lt;dbl&gt; 11.5
## $ dist2      &lt;dbl&gt; 1
## $ Hdist2     &lt;dbl&gt; 10.5
## $ depth2     &lt;dbl&gt; 1
## $ Hcbh2      &lt;dbl&gt; 1.5
## $ treeID     &lt;fct&gt; 78
## $ max_height &lt;dbl&gt; 14.5</code></pre>
</div>
<div id="step-6---ladderfuelsrget_real_depths" class="section level3 hasAnchor" number="2.4.8">
<h3><span class="header-section-number">2.4.8</span> Step 6 - <code>LadderFuelsR::get_real_depths</code><a href="s01.html#step-6---ladderfuelsrget_real_depths" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>recalculates fuel layers depth after considering distances greater than the actual height bin step.</p>
<p><a href="https://doi.org/10.1111/2041-210X.14427">Viedma et al. 2024</a> note:</p>
<blockquote>
<p>Function <code>get_real_depths()</code> calculates the cumulative heights of depth values when distance = num_step. It iterates over each distance value and if dist[i] &gt; num_step, it keeps the corresponding depth value. However, if dist[i] = num_step, it sums all consecutive distances and corresponding depth values (Figure 7a,b). (p.6)</p>
</blockquote>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb146-1"><a href="s01.html#cb146-1" tabindex="-1"></a><span class="do">## LadderFuelsR::get_real_depths</span></span>
<span id="cb146-2"><a href="s01.html#cb146-2" tabindex="-1"></a>real_depth <span class="ot">&lt;-</span> LadderFuelsR<span class="sc">::</span><span class="fu">get_real_depths</span>(<span class="at">effective_fbh =</span> real_fbh, <span class="at">step=</span><span class="dv">1</span>, <span class="at">min_height=</span><span class="fl">1.5</span>)</span>
<span id="cb146-3"><a href="s01.html#cb146-3" tabindex="-1"></a>real_depth <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 1
## Columns: 8
## $ treeID     &lt;fct&gt; 78
## $ treeID1    &lt;dbl&gt; 78
## $ Hdptf1     &lt;dbl&gt; 11.5
## $ dist1      &lt;dbl&gt; 0
## $ dptf1      &lt;dbl&gt; 10
## $ Hcbh1      &lt;dbl&gt; 1.5
## $ Hdist1     &lt;dbl&gt; 1.5
## $ max_height &lt;dbl&gt; 14.5</code></pre>
</div>
<div id="step-7---ladderfuelsrget_effective_gap" class="section level3 hasAnchor" number="2.4.9">
<h3><span class="header-section-number">2.4.9</span> Step 7 - <code>LadderFuelsR::get_effective_gap</code><a href="s01.html#step-7---ladderfuelsrget_effective_gap" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>recalculates the distance between fuel layers after considering distances greater than any number of height bin steps.</p>
<p><a href="https://doi.org/10.1111/2041-210X.14427">Viedma et al. 2024</a> note:</p>
<blockquote>
<p>Function <code>get_effective_gap()</code> calculates the effective distance between fuel layers based on the previously identified FBHs. It loops over all the FBHs and, at each iteration, it checks if the current value and the next value in FBHs are not equal. If they are not equal, it keeps the corresponding distance value, otherwise it removes it (Figure 8). (p.6)</p>
</blockquote>
<div class="sourceCode" id="cb148"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb148-1"><a href="s01.html#cb148-1" tabindex="-1"></a><span class="do">## LadderFuelsR::get_effective_gap</span></span>
<span id="cb148-2"><a href="s01.html#cb148-2" tabindex="-1"></a>eff_gap <span class="ot">&lt;-</span> LadderFuelsR<span class="sc">::</span><span class="fu">get_effective_gap</span>(</span>
<span id="cb148-3"><a href="s01.html#cb148-3" tabindex="-1"></a>  <span class="at">effective_depth =</span> real_depth</span>
<span id="cb148-4"><a href="s01.html#cb148-4" tabindex="-1"></a>  , <span class="at">number_steps =</span> <span class="dv">1</span>, <span class="at">min_height=</span> <span class="fl">1.5</span></span>
<span id="cb148-5"><a href="s01.html#cb148-5" tabindex="-1"></a>)</span>
<span id="cb148-6"><a href="s01.html#cb148-6" tabindex="-1"></a>eff_gap <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 1
## Columns: 9
## $ treeID     &lt;fct&gt; 78
## $ treeID1    &lt;dbl&gt; 78
## $ dist1      &lt;dbl&gt; 0
## $ dptf1      &lt;dbl&gt; 10
## $ effdist1   &lt;dbl&gt; 0
## $ Hcbh1      &lt;dbl&gt; 1.5
## $ Hdist1     &lt;dbl&gt; 1.5
## $ Hdptf1     &lt;dbl&gt; 11.5
## $ max_height &lt;dbl&gt; 14.5</code></pre>
</div>
<div id="step-8---ladderfuelsrget_layers_lad" class="section level3 hasAnchor" number="2.4.10">
<h3><span class="header-section-number">2.4.10</span> Step 8 - <code>LadderFuelsR::get_layers_lad</code><a href="s01.html#step-8---ladderfuelsrget_layers_lad" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>calculates the percentage of Leaf Area Density (LAD) within each fuel layer (first output) and removes those fuel layers with LAD percentage less than a specified threshold (default 10 the depth of the remaining ones (second output).</p>
<p><a href="https://doi.org/10.1111/2041-210X.14427">Viedma et al. 2024</a> note:</p>
<blockquote>
<p>Function <code>get_layers_lad()</code> calculates LAD (%) within each fuel layer, which is defined by the height range between the FBH and its depth. First, it calculates the total LAD from the original profile. Next, it retrieves the beginning and end height bin of each fuel layer and calculates the percentage of total LAD that falls within that height range. Later, the fuel layers that had a LAD (%) less than a specified threshold (default 10%) were removed, recalculating the distances (Figure 9). (p.7)</p>
</blockquote>
<div class="sourceCode" id="cb150"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb150-1"><a href="s01.html#cb150-1" tabindex="-1"></a><span class="do">## LadderFuelsR::get_layers_lad</span></span>
<span id="cb150-2"><a href="s01.html#cb150-2" tabindex="-1"></a>layers_lad_df <span class="ot">&lt;-</span> LadderFuelsR<span class="sc">::</span><span class="fu">get_layers_lad</span>(</span>
<span id="cb150-3"><a href="s01.html#cb150-3" tabindex="-1"></a>  <span class="at">LAD_profiles =</span> lad_profile</span>
<span id="cb150-4"><a href="s01.html#cb150-4" tabindex="-1"></a>  , <span class="at">effective_distances =</span> eff_gap</span>
<span id="cb150-5"><a href="s01.html#cb150-5" tabindex="-1"></a>  , <span class="at">threshold=</span><span class="dv">10</span>,<span class="at">step =</span> <span class="dv">1</span>,<span class="at">min_height=</span> <span class="fl">1.5</span></span>
<span id="cb150-6"><a href="s01.html#cb150-6" tabindex="-1"></a>)</span>
<span id="cb150-7"><a href="s01.html#cb150-7" tabindex="-1"></a>layers_lad_df <span class="sc">%&gt;%</span> <span class="fu">str</span>()</span></code></pre></div>
<pre><code>## List of 2
##  $ df1:&#39;data.frame&#39;: 1 obs. of  12 variables:
##   ..$ treeID1     : num 78
##   ..$ treeID      : Factor w/ 1 level &quot;78&quot;: 1
##   ..$ dist1       : num 0
##   ..$ dptf1       : num 10
##   ..$ effdist1    : num 0
##   ..$ Hcbh1       : num 1.5
##   ..$ Hdist1      : num 1.5
##   ..$ Hdptf1      : num 11.5
##   ..$ max1        : num 14.5
##   ..$ Hcbh1_Hdptf1: num 99.5
##   ..$ max_height  : num 14.5
##   ..$ nlayers     : int 1
##  $ df2:&#39;data.frame&#39;: 1 obs. of  11 variables:
##   ..$ treeID1     : num 78
##   ..$ treeID      : Factor w/ 1 level &quot;78&quot;: 1
##   ..$ dptf1       : num 10
##   ..$ effdist1    : num 0
##   ..$ Hcbh1       : num 1.5
##   ..$ Hdist1      : num 1.5
##   ..$ Hdptf1      : num 11.5
##   ..$ max1        : num 14.5
##   ..$ max_height  : num 14.5
##   ..$ Hcbh1_Hdptf1: num 99.5
##   ..$ nlayers     : int 1</code></pre>
<p>idk why it is a list of 2 with the same data just the order of the <code>max_height</code> and <code>Hcbh1_Hdptf1</code> columns are switched. do you spot another difference??</p>
<p>looking through the befuddling README it looks like the authors only keep the second data frame in the list</p>
<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb152-1"><a href="s01.html#cb152-1" tabindex="-1"></a>(layers_lad_df <span class="ot">&lt;-</span> layers_lad_df[[<span class="dv">2</span>]])</span></code></pre></div>
<pre><code>##   treeID1 treeID dptf1 effdist1 Hcbh1 Hdist1 Hdptf1 max1 max_height
## 1      78     78    10        0   1.5    1.5   11.5 14.5       14.5
##   Hcbh1_Hdptf1 nlayers
## 1     99.47572       1</code></pre>
<p>is CBH in here? did we do it?</p>
<ul>
<li>treeID: tree ID with strings and numeric values</li>
<li>treeID1: tree ID with only numeric values</li>
<li>dptf: Depth of fuel layers (m) after considering distances greater than the actual height bin step</li>
<li>effdist: Effective distance between consecutive fuel layers (m) after considering distances greater than any number of steps</li>
<li>Hcbh: Base height of each fuel separated by a distance greater than the certain number of steps</li>
<li>Hdptf: Height of the depth of fuel layers (m) after considering distances greater than the actual step</li>
<li>Hdist: Height of the distance (&gt; any number of steps) between consecutive fuel layers (m)</li>
<li>Hcbh_Hdptf - Percentage of LAD values comprised in each effective fuel layer</li>
<li>max_height - Maximum height of the tree profile</li>
<li>nlayers - Number of effective fuel layers</li>
</ul>
<p>is it possible to have multiple <code>Hcbh</code> values for one tree? is step 9 below even necessary at this point?</p>
<p>let’s take the <code>LadderFuelsR::get_plots_effective()</code> function for a spin</p>
<div class="sourceCode" id="cb154"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb154-1"><a href="s01.html#cb154-1" tabindex="-1"></a>LadderFuelsR<span class="sc">::</span><span class="fu">get_plots_effective</span>(</span>
<span id="cb154-2"><a href="s01.html#cb154-2" tabindex="-1"></a>  <span class="at">LAD_profiles =</span> lad_profile</span>
<span id="cb154-3"><a href="s01.html#cb154-3" tabindex="-1"></a>  , <span class="at">effective_LAD =</span> layers_lad_df</span>
<span id="cb154-4"><a href="s01.html#cb154-4" tabindex="-1"></a>  , <span class="at">min_height =</span> <span class="fl">1.5</span></span>
<span id="cb154-5"><a href="s01.html#cb154-5" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## $`78`</code></pre>
<p><img src="uas_sfm_tree_detection_files/figure-html/unnamed-chunk-93-1.png" width="1008" /></p>
<p>maybe we’ll try to recreate this plot at some point</p>
<div class="sourceCode" id="cb156"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb156-1"><a href="s01.html#cb156-1" tabindex="-1"></a><span class="co"># wanna recreate this?</span></span></code></pre></div>
</div>
<div id="step-9---ladderfuelsrget_cbh_dist-ladderfuelsrget_cbh_metrics" class="section level3 hasAnchor" number="2.4.11">
<h3><span class="header-section-number">2.4.11</span> Step 9 - <del><code>LadderFuelsR::get_cbh_dist</code></del> <code>LadderFuelsR::get_cbh_metrics</code><a href="s01.html#step-9---ladderfuelsrget_cbh_dist-ladderfuelsrget_cbh_metrics" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>LadderFuelsR::get_cbh_dist</code> is described in the research article but does not exist in the package or README. Looks like <code>LadderFuelsR::get_cbh_metrics</code> is there though.</p>
<p>determines the CBH of a segmented tree using three criteria: maximum LAD percentage, maximum distance and the last distance.</p>
<p><a href="https://doi.org/10.1111/2041-210X.14427">Viedma et al. 2024</a> note:</p>
<blockquote>
<p>Function <code>get_cbh_dist()</code> applies three criteria to define the CBH in a segmented tree: the fuel layer containing the maximum LAD (%) (Figure 10a), the fuel layer located at the highest distance (Figure 10b), and the fuel layer separated by the last effective distance (Figure 10c). In the case of maximum LAD (%), the output also gives the CBH from the second fuel layer when the first one has the maximum LAD (%) but its depth is smaller than the value indicated in the parameter ‘hdepth1_height’ (default 2m). (p.8)</p>
</blockquote>
<div class="sourceCode" id="cb157"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb157-1"><a href="s01.html#cb157-1" tabindex="-1"></a><span class="do">## LadderFuelsR::get_cbh_metrics</span></span>
<span id="cb157-2"><a href="s01.html#cb157-2" tabindex="-1"></a>cbh_metrics <span class="ot">&lt;-</span> LadderFuelsR<span class="sc">::</span><span class="fu">get_cbh_metrics</span>(<span class="at">effective_LAD =</span> layers_lad_df, <span class="at">min_height=</span> <span class="fl">1.5</span>)</span>
<span id="cb157-3"><a href="s01.html#cb157-3" tabindex="-1"></a>cbh_metrics <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 1
## Columns: 29
## $ treeID1        &lt;dbl&gt; 78
## $ dptf1          &lt;dbl&gt; 10
## $ effdist1       &lt;dbl&gt; 0
## $ Hcbh1          &lt;dbl&gt; 1.5
## $ Hdist1         &lt;dbl&gt; 1.5
## $ Hdptf1         &lt;dbl&gt; 11.5
## $ max1           &lt;dbl&gt; 14.5
## $ Hcbh1_Hdptf1   &lt;dbl&gt; 99.47572
## $ treeID         &lt;fct&gt; 78
## $ max_height     &lt;dbl&gt; 14.5
## $ nlayers        &lt;int&gt; 1
## $ maxlad_Hcbh    &lt;dbl&gt; 1.5
## $ maxlad_Hdist   &lt;dbl&gt; 1.5
## $ maxlad_Hdptf   &lt;dbl&gt; 11.5
## $ maxlad_dptf    &lt;dbl&gt; 10
## $ maxlad_effdist &lt;dbl&gt; 0
## $ maxlad_lad     &lt;dbl&gt; 99.47572
## $ max_Hcbh       &lt;dbl&gt; 1.5
## $ max_Hdist      &lt;dbl&gt; 1.5
## $ max_Hdptf      &lt;dbl&gt; 11.5
## $ max_dptf       &lt;dbl&gt; 10
## $ max_effdist    &lt;dbl&gt; 0
## $ max_lad        &lt;dbl&gt; 99.47572
## $ last_Hcbh      &lt;dbl&gt; 1.5
## $ last_Hdist     &lt;dbl&gt; 1.5
## $ last_Hdptf     &lt;dbl&gt; 11.5
## $ last_dptf      &lt;dbl&gt; 10
## $ last_effdist   &lt;dbl&gt; 0
## $ last_lad       &lt;dbl&gt; 99.47572</code></pre>
<p>what are these?</p>
<ul>
<li>treeID: tree ID with strings and numeric values</li>
<li>treeID1: tree ID with only numeric values</li>
<li>dptf: Depth of fuel layers (m) after considering distances greater than the actual height bin step</li>
<li>effdist: Effective distance between consecutive fuel layers (m) after considering distances greater than any number of steps</li>
<li>Hcbh: Base height of each fuel separated by a distance greater than the certain number of steps</li>
<li>Hdptf: Height of the depth of fuel layers (m) after considering distances greater than the actual step</li>
<li>Hdist: Height of the distance (&gt; any number of steps) between consecutive fuel layers (m)</li>
<li>Hcbh_Hdptf - Percentage of LAD values comprised in each effective fuel layer</li>
<li>maxlad_Hcbh - Height of the CBH of the segmented tree based on the maximum LAD percentage</li>
<li>maxlad1_Hcbh - Height of the CBH from the second fuel layer when the maximum LAD occurred in the first fuel layer but its depth &lt;= “hdepth1_height”</li>
<li>max_Hcbh - Height of the CBH of the segmented tree based on the maximum distance found in its profile</li>
<li>last_Hcbh - Height of the CBH of the segmented tree based on the last distance found in its profile</li>
<li>maxlad_ - Values of distance and fuel depth and their corresponding heights at the maximum LAD percentage</li>
<li>maxlad1_ - Values of distance and fuel depth and their corresponding heights for the second fuel layer when the maximum LAD occurred in the first fuel layer but its depth &lt;= “hdepth1_height”</li>
<li>max_ - Values of distance and fuel depth and their corresponding heights at the maximum distance</li>
<li>last_ - Values of distance and fuel depth and their corresponding heights at the last distance</li>
<li>nlayers - Number of effective fuel layers</li>
<li>max_height - Maximum height of the tree profile</li>
</ul>
<p>there are also some plotting functions</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb159-1"><a href="s01.html#cb159-1" tabindex="-1"></a><span class="co"># Generate plots for fuels LAD metrics</span></span>
<span id="cb159-2"><a href="s01.html#cb159-2" tabindex="-1"></a>plots_cbh_maxlad <span class="ot">&lt;-</span> LadderFuelsR<span class="sc">::</span><span class="fu">get_plots_cbh_LAD</span>(</span>
<span id="cb159-3"><a href="s01.html#cb159-3" tabindex="-1"></a>  <span class="at">LAD_profiles =</span> lad_profile</span>
<span id="cb159-4"><a href="s01.html#cb159-4" tabindex="-1"></a>  , <span class="at">cbh_metrics =</span> cbh_metrics</span>
<span id="cb159-5"><a href="s01.html#cb159-5" tabindex="-1"></a>  , <span class="at">min_height=</span><span class="fl">1.5</span></span>
<span id="cb159-6"><a href="s01.html#cb159-6" tabindex="-1"></a>)</span>
<span id="cb159-7"><a href="s01.html#cb159-7" tabindex="-1"></a>plots_cbh_maxdist <span class="ot">&lt;-</span> LadderFuelsR<span class="sc">::</span><span class="fu">get_plots_cbh_maxdist</span>(</span>
<span id="cb159-8"><a href="s01.html#cb159-8" tabindex="-1"></a>  <span class="at">LAD_profiles =</span> lad_profile</span>
<span id="cb159-9"><a href="s01.html#cb159-9" tabindex="-1"></a>  , <span class="at">cbh_metrics =</span> cbh_metrics</span>
<span id="cb159-10"><a href="s01.html#cb159-10" tabindex="-1"></a>  , <span class="at">min_height=</span><span class="fl">1.5</span></span>
<span id="cb159-11"><a href="s01.html#cb159-11" tabindex="-1"></a>)</span>
<span id="cb159-12"><a href="s01.html#cb159-12" tabindex="-1"></a>plots_cbh_lastdist <span class="ot">&lt;-</span> LadderFuelsR<span class="sc">::</span><span class="fu">get_plots_cbh_lastdist</span>(</span>
<span id="cb159-13"><a href="s01.html#cb159-13" tabindex="-1"></a>  <span class="at">LAD_profiles =</span> lad_profile</span>
<span id="cb159-14"><a href="s01.html#cb159-14" tabindex="-1"></a>  , <span class="at">cbh_metrics =</span> cbh_metrics</span>
<span id="cb159-15"><a href="s01.html#cb159-15" tabindex="-1"></a>  , <span class="at">min_height=</span><span class="fl">1.5</span></span>
<span id="cb159-16"><a href="s01.html#cb159-16" tabindex="-1"></a>)</span>
<span id="cb159-17"><a href="s01.html#cb159-17" tabindex="-1"></a><span class="co"># patchwork them</span></span>
<span id="cb159-18"><a href="s01.html#cb159-18" tabindex="-1"></a>(plots_cbh_maxlad[[<span class="dv">1</span>]] <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;get_plots_cbh_LAD&quot;</span>)) <span class="sc">+</span></span>
<span id="cb159-19"><a href="s01.html#cb159-19" tabindex="-1"></a>(plots_cbh_maxdist[[<span class="dv">1</span>]] <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;get_plots_cbh_maxdist&quot;</span>)) <span class="sc">+</span></span>
<span id="cb159-20"><a href="s01.html#cb159-20" tabindex="-1"></a>(plots_cbh_lastdist[[<span class="dv">1</span>]] <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;get_plots_cbh_lastdist&quot;</span>)) <span class="sc">+</span></span>
<span id="cb159-21"><a href="s01.html#cb159-21" tabindex="-1"></a>  patchwork<span class="sc">::</span><span class="fu">plot_layout</span>(<span class="at">ncol =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="uas_sfm_tree_detection_files/figure-html/unnamed-chunk-96-1.png" width="1008" /></p>
<p>these plots represent the three criteria to define the CBH in a segmented tree:</p>
<ul>
<li><code>get_plots_cbh_LAD</code> = the fuel layer containing the maximum LAD percentage (column named <code>maxlad_Hcbh</code>)</li>
<li><code>get_plots_cbh_maxdist</code> = the fuel layer located at the highest distance (column named <code>max_Hcbh</code>)</li>
<li><code>get_plots_cbh_lastdist</code> = the fuel layer separated by the last effective distance (column named <code>last_Hcbh</code>)</li>
</ul>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="index.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="s02.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
