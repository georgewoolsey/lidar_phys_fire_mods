<!DOCTYPE html>
<html lang="en-US" xml:lang="en-US">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Section 4 Validate Tree Detection and Crown Delineation | Aerial LiDAR for Fire Model Inputs</title>
  <meta name="description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  <meta name="generator" content="bookdown 0.34 and GitBook 2.6.7" />

  <meta property="og:title" content="Section 4 Validate Tree Detection and Crown Delineation | Aerial LiDAR for Fire Model Inputs" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Section 4 Validate Tree Detection and Crown Delineation | Aerial LiDAR for Fire Model Inputs" />
  
  <meta name="twitter:description" content="Using the bookdown package to write a book of data exploration. The output format for this example is bookdown::gitbook." />
  

<meta name="author" content="George Woolsey" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="forest-stand-summary.html"/>
<link rel="next" href="appendix.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<link href="libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet" />
<script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.2.2/leaflet.js"></script>
<script src="libs/leaflet-providers-2.0.0/leaflet-providers_2.0.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.2.2/leaflet-providers-plugin.js"></script>
<script src="libs/clipboard-0.0.1/setClipboardText.js"></script>
<link href="libs/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet" />
<link href="libs/mapviewCSS-0.0.1/mapview.css" rel="stylesheet" />
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
<link href="libs/bsTable-3.3.7/bootstrapTable.min.css" rel="stylesheet" />
<script src="libs/bsTable-3.3.7/bootstrapTable.js"></script>
<script type="text/javascript">

// toggle visibility of R source blocks in R Markdown output
function toggle_R() {
  var x = document.getElementsByClassName('r');
  if (x.length == 0) return;
  function toggle_vis(o) {
    var d = o.style.display;
    o.style.display = (d == 'block' || d == '') ? 'none':'block';
  }

  for (i = 0; i < x.length; i++) {
    var y = x[i];
    if (y.tagName.toLowerCase() === 'pre') toggle_vis(y);
  }

    var elem = document.getElementById("myButton1");
    if (elem.value === "Hide Code") elem.value = "Show Code";
    else elem.value = "Hide Code";
}

document.write('<input onclick="toggle_R();" type="button" value="Hide Code" id="myButton1" style="position: absolute; top: 10%; right: 2%; z-index: 200"></input>')

</script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#objective"><i class="fa fa-check"></i><b>1.1</b> Objective</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#data_desc"><i class="fa fa-check"></i><b>1.2</b> Data</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="processing.html"><a href="processing.html"><i class="fa fa-check"></i><b>2</b> Point Cloud Processing</a>
<ul>
<li class="chapter" data-level="2.1" data-path="processing.html"><a href="processing.html#lidar-data-location"><i class="fa fa-check"></i><b>2.1</b> Lidar Data Location</a></li>
<li class="chapter" data-level="2.2" data-path="processing.html"><a href="processing.html#individial-tree-detection-tuning-itd_tuning"><i class="fa fa-check"></i><b>2.2</b> Individial Tree Detection Tuning: <code id="itd">itd_tuning()</code></a></li>
<li class="chapter" data-level="2.3" data-path="processing.html"><a href="processing.html#point-cloud-tree-extraction-cloud2trees"><i class="fa fa-check"></i><b>2.3</b> Point Cloud Tree Extraction: <code id="trees">cloud2trees()</code></a></li>
<li class="chapter" data-level="2.4" data-path="processing.html"><a href="processing.html#dbh-modeling-trees_dbh"><i class="fa fa-check"></i><b>2.4</b> DBH Modeling: <code>trees_dbh()</code></a></li>
<li class="chapter" data-level="2.5" data-path="processing.html"><a href="processing.html#hmd-modeling-trees_hmd"><i class="fa fa-check"></i><b>2.5</b> HMD Modeling: <code>trees_hmd()</code></a></li>
<li class="chapter" data-level="2.6" data-path="processing.html"><a href="processing.html#cbh-modeling-trees_cbh"><i class="fa fa-check"></i><b>2.6</b> CBH Modeling: <code>trees_cbh()</code></a></li>
<li class="chapter" data-level="2.7" data-path="processing.html"><a href="processing.html#forest-type-trees_type"><i class="fa fa-check"></i><b>2.7</b> Forest Type: <code id="trees_type">trees_type()</code></a></li>
<li class="chapter" data-level="2.8" data-path="processing.html"><a href="processing.html#combine-data"><i class="fa fa-check"></i><b>2.8</b> Combine data</a></li>
<li class="chapter" data-level="2.9" data-path="processing.html"><a href="processing.html#crown-biomass-trees_biomass"><i class="fa fa-check"></i><b>2.9</b> Crown Biomass: <code id="trees_biomass">trees_biomass()</code></a></li>
<li class="chapter" data-level="2.10" data-path="processing.html"><a href="processing.html#processing-time-summary"><i class="fa fa-check"></i><b>2.10</b> Processing Time Summary</a></li>
<li class="chapter" data-level="2.11" data-path="processing.html"><a href="processing.html#data-export"><i class="fa fa-check"></i><b>2.11</b> Data Export</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="forest-stand-summary.html"><a href="forest-stand-summary.html"><i class="fa fa-check"></i><b>3</b> Forest Stand Summary</a>
<ul>
<li class="chapter" data-level="3.1" data-path="forest-stand-summary.html"><a href="forest-stand-summary.html#load-data"><i class="fa fa-check"></i><b>3.1</b> Load data</a></li>
<li class="chapter" data-level="3.2" data-path="forest-stand-summary.html"><a href="forest-stand-summary.html#silvicultural-metrics"><i class="fa fa-check"></i><b>3.2</b> Silvicultural metrics</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="forest-stand-summary.html"><a href="forest-stand-summary.html#height-distribution"><i class="fa fa-check"></i><b>3.2.1</b> Height Distribution</a></li>
<li class="chapter" data-level="3.2.2" data-path="forest-stand-summary.html"><a href="forest-stand-summary.html#dbh-distribution"><i class="fa fa-check"></i><b>3.2.2</b> DBH Distribution</a></li>
<li class="chapter" data-level="3.2.3" data-path="forest-stand-summary.html"><a href="forest-stand-summary.html#forest-type"><i class="fa fa-check"></i><b>3.2.3</b> Forest Type</a></li>
<li class="chapter" data-level="3.2.4" data-path="forest-stand-summary.html"><a href="forest-stand-summary.html#crown-biomass"><i class="fa fa-check"></i><b>3.2.4</b> Crown Biomass</a></li>
<li class="chapter" data-level="3.2.5" data-path="forest-stand-summary.html"><a href="forest-stand-summary.html#summary-statistics"><i class="fa fa-check"></i><b>3.2.5</b> Summary Statistics</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="forest-stand-summary.html"><a href="forest-stand-summary.html#spatial-forest-structure"><i class="fa fa-check"></i><b>3.3</b> Spatial Forest Structure</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="forest-stand-summary.html"><a href="forest-stand-summary.html#chm_plt"><i class="fa fa-check"></i><b>3.3.1</b> CHM</a></li>
<li class="chapter" data-level="3.3.2" data-path="forest-stand-summary.html"><a href="forest-stand-summary.html#function-to-rasterize"><i class="fa fa-check"></i><b>3.3.2</b> Function to Rasterize</a></li>
<li class="chapter" data-level="3.3.3" data-path="forest-stand-summary.html"><a href="forest-stand-summary.html#mean-dbh"><i class="fa fa-check"></i><b>3.3.3</b> Mean DBH</a></li>
<li class="chapter" data-level="3.3.4" data-path="forest-stand-summary.html"><a href="forest-stand-summary.html#mean-height"><i class="fa fa-check"></i><b>3.3.4</b> Mean Height</a></li>
<li class="chapter" data-level="3.3.5" data-path="forest-stand-summary.html"><a href="forest-stand-summary.html#qmd"><i class="fa fa-check"></i><b>3.3.5</b> QMD</a></li>
<li class="chapter" data-level="3.3.6" data-path="forest-stand-summary.html"><a href="forest-stand-summary.html#basal-area"><i class="fa fa-check"></i><b>3.3.6</b> Basal Area</a></li>
<li class="chapter" data-level="3.3.7" data-path="forest-stand-summary.html"><a href="forest-stand-summary.html#tph"><i class="fa fa-check"></i><b>3.3.7</b> TPH</a></li>
<li class="chapter" data-level="3.3.8" data-path="forest-stand-summary.html"><a href="forest-stand-summary.html#cfl-cruz"><i class="fa fa-check"></i><b>3.3.8</b> CFL Cruz</a></li>
<li class="chapter" data-level="3.3.9" data-path="forest-stand-summary.html"><a href="forest-stand-summary.html#cfl-landfire"><i class="fa fa-check"></i><b>3.3.9</b> CFL LANDFIRE</a></li>
<li class="chapter" data-level="3.3.10" data-path="forest-stand-summary.html"><a href="forest-stand-summary.html#fia-forest-type-group"><i class="fa fa-check"></i><b>3.3.10</b> FIA Forest Type Group</a></li>
<li class="chapter" data-level="3.3.11" data-path="forest-stand-summary.html"><a href="forest-stand-summary.html#combine-by-stand-unit"><i class="fa fa-check"></i><b>3.3.11</b> Combine by stand unit</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="forest-stand-summary.html"><a href="forest-stand-summary.html#canopy-cover"><i class="fa fa-check"></i><b>3.4</b> Canopy Cover</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="forest-stand-summary.html"><a href="forest-stand-summary.html#entire-area"><i class="fa fa-check"></i><b>3.4.1</b> Entire Area</a></li>
<li class="chapter" data-level="3.4.2" data-path="forest-stand-summary.html"><a href="forest-stand-summary.html#stands"><i class="fa fa-check"></i><b>3.4.2</b> Stands</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="forest-stand-summary.html"><a href="forest-stand-summary.html#write-data"><i class="fa fa-check"></i><b>3.5</b> Write Data</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="validate-tree-detection-and-crown-delineation.html"><a href="validate-tree-detection-and-crown-delineation.html"><i class="fa fa-check"></i><b>4</b> Validate Tree Detection and Crown Delineation</a>
<ul>
<li class="chapter" data-level="4.1" data-path="validate-tree-detection-and-crown-delineation.html"><a href="validate-tree-detection-and-crown-delineation.html#itd_more"><i class="fa fa-check"></i><b>4.1</b> ITD tuning</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="validate-tree-detection-and-crown-delineation.html"><a href="validate-tree-detection-and-crown-delineation.html#default-variable-window-functions"><i class="fa fa-check"></i><b>4.1.1</b> Default variable window functions</a></li>
<li class="chapter" data-level="4.1.2" data-path="validate-tree-detection-and-crown-delineation.html"><a href="validate-tree-detection-and-crown-delineation.html#augmented-variable-window-functions"><i class="fa fa-check"></i><b>4.1.2</b> Augmented variable window functions</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="validate-tree-detection-and-crown-delineation.html"><a href="validate-tree-detection-and-crown-delineation.html#neontreeevaluation-benchmark"><i class="fa fa-check"></i><b>4.2</b> <code>NeonTreeEvaluation</code> benchmark</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="validate-tree-detection-and-crown-delineation.html"><a href="validate-tree-detection-and-crown-delineation.html#lidar-data-in-neontreeevaluation"><i class="fa fa-check"></i><b>4.2.1</b> lidar data in <code id="neon_lidar">NeonTreeEvaluation</code></a></li>
<li class="chapter" data-level="4.2.2" data-path="validate-tree-detection-and-crown-delineation.html"><a href="validate-tree-detection-and-crown-delineation.html#ht_filter"><i class="fa fa-check"></i><b>4.2.2</b> Height threshold for “canopy” trees</a></li>
<li class="chapter" data-level="4.2.3" data-path="validate-tree-detection-and-crown-delineation.html"><a href="validate-tree-detection-and-crown-delineation.html#ex_valid"><i class="fa fa-check"></i><b>4.2.3</b> Example validation process</a></li>
<li class="chapter" data-level="4.2.4" data-path="validate-tree-detection-and-crown-delineation.html"><a href="validate-tree-detection-and-crown-delineation.html#training-validation-process"><i class="fa fa-check"></i><b>4.2.4</b> Training validation process</a></li>
<li class="chapter" data-level="4.2.5" data-path="validate-tree-detection-and-crown-delineation.html"><a href="validate-tree-detection-and-crown-delineation.html#evaluation-validation-process"><i class="fa fa-check"></i><b>4.2.5</b> Evaluation validation process</a></li>
<li class="chapter" data-level="4.2.6" data-path="validate-tree-detection-and-crown-delineation.html"><a href="validate-tree-detection-and-crown-delineation.html#valid_sum"><i class="fa fa-check"></i><b>4.2.6</b> Summary of validation against ground truth</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="validate-tree-detection-and-crown-delineation.html"><a href="validate-tree-detection-and-crown-delineation.html#for-instance-benchmark"><i class="fa fa-check"></i><b>4.3</b> FOR-instance benchmark</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="validate-tree-detection-and-crown-delineation.html"><a href="validate-tree-detection-and-crown-delineation.html#lidar-data-in-for-instance"><i class="fa fa-check"></i><b>4.3.1</b> lidar data in <strong>FOR-instance</strong></a></li>
<li class="chapter" data-level="4.3.2" data-path="validate-tree-detection-and-crown-delineation.html"><a href="validate-tree-detection-and-crown-delineation.html#ex_valid2"><i class="fa fa-check"></i><b>4.3.2</b> Example validation process</a></li>
<li class="chapter" data-level="4.3.3" data-path="validate-tree-detection-and-crown-delineation.html"><a href="validate-tree-detection-and-crown-delineation.html#training-validation-process-1"><i class="fa fa-check"></i><b>4.3.3</b> Training validation process</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="appendix.html"><a href="appendix.html"><i class="fa fa-check"></i><b>5</b> Appendix</a>
<ul>
<li class="chapter" data-level="5.1" data-path="appendix.html"><a href="appendix.html#data_ex"><i class="fa fa-check"></i><b>5.1</b> Example lidar data</a></li>
<li class="chapter" data-level="5.2" data-path="appendix.html"><a href="appendix.html#cbh"><i class="fa fa-check"></i><b>5.2</b> CBH Process</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="appendix.html"><a href="appendix.html#return-cbh-metrics"><i class="fa fa-check"></i><b>5.2.1</b> Return CBH Metrics</a></li>
<li class="chapter" data-level="5.2.2" data-path="appendix.html"><a href="appendix.html#cbh-on-the-point-cloud"><i class="fa fa-check"></i><b>5.2.2</b> CBH on the point cloud</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="appendix.html"><a href="appendix.html#hmd"><i class="fa fa-check"></i><b>5.3</b> HMD Process</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="appendix.html"><a href="appendix.html#one-tree-example"><i class="fa fa-check"></i><b>5.3.1</b> One Tree Example</a></li>
<li class="chapter" data-level="5.3.2" data-path="appendix.html"><a href="appendix.html#tree-list-example"><i class="fa fa-check"></i><b>5.3.2</b> Tree List Example</a></li>
</ul></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Aerial LiDAR for Fire Model Inputs</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="validate-tree-detection-and-crown-delineation" class="section level1 hasAnchor" number="4">
<h1><span class="header-section-number">Section 4</span> Validate Tree Detection and Crown Delineation<a href="validate-tree-detection-and-crown-delineation.html#validate-tree-detection-and-crown-delineation" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>In this section we’ll use the benchmark data made available in the <a href="https://github.com/weecology/NeonTreeEvaluation_package"><code>NeonTreeEvaluation</code></a> data set (<a href="https://scholar.google.com/scholar?cluster=4986448711981898434&amp;hl=en&amp;as_sdt=0,6">Weinstein et al. 2021</a>) to evaluate our process for lidar-based tree detection. We’ll implement our tree detection process via the <a href="https://github.com/georgewoolsey/cloud2trees"><code>cloud2trees</code></a> package.</p>
<p>Puliti et al. <a href="https://doi.org/10.48550/arXiv.2309.01279">(2023)</a> also provide the benchmarking dataset “FOR-instance” for dense airborne laser scanning data. The dataset comprises five curated UAV-based laser scanning data collections from diverse global locations, representing various forest types. The data was collected over five sites in Norway, Czech Republic, Austria, Australia, and New Zealand and covers mature forests for the following forest types: boreal (42% of the number of trees) and temperate coniferous (5%), temperate mixed deciduous (29%), coniferous plantation (13%), and dry sclerophyll forests (11%). We might also consider this data for validation of our methods.</p>
<p>First, load the standard libraries</p>
<div class="sourceCode" id="cb175"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb175-1"><a href="validate-tree-detection-and-crown-delineation.html#cb175-1" tabindex="-1"></a><span class="co"># bread-and-butter</span></span>
<span id="cb175-2"><a href="validate-tree-detection-and-crown-delineation.html#cb175-2" tabindex="-1"></a><span class="fu">library</span>(tidyverse) <span class="co"># the tidyverse</span></span>
<span id="cb175-3"><a href="validate-tree-detection-and-crown-delineation.html#cb175-3" tabindex="-1"></a><span class="fu">library</span>(viridis) <span class="co"># viridis colors</span></span>
<span id="cb175-4"><a href="validate-tree-detection-and-crown-delineation.html#cb175-4" tabindex="-1"></a><span class="fu">library</span>(harrypotter) <span class="co"># hp colors</span></span>
<span id="cb175-5"><a href="validate-tree-detection-and-crown-delineation.html#cb175-5" tabindex="-1"></a><span class="fu">library</span>(RColorBrewer) <span class="co"># brewer colors</span></span>
<span id="cb175-6"><a href="validate-tree-detection-and-crown-delineation.html#cb175-6" tabindex="-1"></a><span class="fu">library</span>(scales) <span class="co"># work with number and plot scales</span></span>
<span id="cb175-7"><a href="validate-tree-detection-and-crown-delineation.html#cb175-7" tabindex="-1"></a><span class="fu">library</span>(latex2exp)</span>
<span id="cb175-8"><a href="validate-tree-detection-and-crown-delineation.html#cb175-8" tabindex="-1"></a></span>
<span id="cb175-9"><a href="validate-tree-detection-and-crown-delineation.html#cb175-9" tabindex="-1"></a><span class="co"># visualization</span></span>
<span id="cb175-10"><a href="validate-tree-detection-and-crown-delineation.html#cb175-10" tabindex="-1"></a><span class="fu">library</span>(mapview) <span class="co"># interactive html maps</span></span>
<span id="cb175-11"><a href="validate-tree-detection-and-crown-delineation.html#cb175-11" tabindex="-1"></a><span class="fu">library</span>(kableExtra) <span class="co"># tables</span></span>
<span id="cb175-12"><a href="validate-tree-detection-and-crown-delineation.html#cb175-12" tabindex="-1"></a><span class="fu">library</span>(patchwork) <span class="co"># combine plots</span></span>
<span id="cb175-13"><a href="validate-tree-detection-and-crown-delineation.html#cb175-13" tabindex="-1"></a><span class="fu">library</span>(ggnewscale) <span class="co"># ggnewscale</span></span>
<span id="cb175-14"><a href="validate-tree-detection-and-crown-delineation.html#cb175-14" tabindex="-1"></a><span class="fu">library</span>(rgl) <span class="co"># rgl plotting</span></span>
<span id="cb175-15"><a href="validate-tree-detection-and-crown-delineation.html#cb175-15" tabindex="-1"></a></span>
<span id="cb175-16"><a href="validate-tree-detection-and-crown-delineation.html#cb175-16" tabindex="-1"></a><span class="co"># spatial analysis</span></span>
<span id="cb175-17"><a href="validate-tree-detection-and-crown-delineation.html#cb175-17" tabindex="-1"></a><span class="fu">library</span>(sf) <span class="co"># simple features</span></span>
<span id="cb175-18"><a href="validate-tree-detection-and-crown-delineation.html#cb175-18" tabindex="-1"></a><span class="fu">library</span>(lidR) <span class="co"># lidar data</span></span>
<span id="cb175-19"><a href="validate-tree-detection-and-crown-delineation.html#cb175-19" tabindex="-1"></a><span class="fu">library</span>(cloud2trees) <span class="co"># tha cloud2trees</span></span>
<span id="cb175-20"><a href="validate-tree-detection-and-crown-delineation.html#cb175-20" tabindex="-1"></a><span class="fu">library</span>(NeonTreeEvaluation) <span class="co"># benchmark data</span></span></code></pre></div>
<div id="itd_more" class="section level2 hasAnchor" number="4.1">
<h2><span class="header-section-number">4.1</span> ITD tuning<a href="validate-tree-detection-and-crown-delineation.html#itd_more" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Before we perform tree extraction on the evaluation data we’ll use the training data to tune our process for lidar-based tree detection implemented via the [<code>cloud2trees</code>]<a href="https://github.com/georgewoolsey/cloud2trees" class="uri">https://github.com/georgewoolsey/cloud2trees</a>) package. Specifically, we are going to use the training data to determine the “best” ITD window function to use for a given NEON site since the <code>cloud2trees</code> package <a href="https://github.com/georgewoolsey/cloud2trees?tab=readme-ov-file#individual-tree-detection-itd-tuning">strongly recommends</a> that “a different window size function is defined for each region of your study area with significantly different forest structure”. See the <code>lidR</code> <a href="https://r-lidar.github.io/lidRbook/itd.html">package book section</a> by point cloud processing expert <a href="https://github.com/Jean-Romain">Jean-Romain Roussel</a> for excellent detail on ITD and defining window size.</p>
<div id="default-variable-window-functions" class="section level3 hasAnchor" number="4.1.1">
<h3><span class="header-section-number">4.1.1</span> Default variable window functions<a href="validate-tree-detection-and-crown-delineation.html#default-variable-window-functions" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We discussed our method for individual tree detection (ITD) in <a href="processing.html#itd">this prior section</a>. For the purpose of working across different conifer sites with potentially vastly different forest structures we are going to augment the default ITD variable window size functions in <code>cloud2trees::itd_ws_functions()</code></p>
<p>Let’s see what the default variable window functions look like</p>
<div class="sourceCode" id="cb176"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb176-1"><a href="validate-tree-detection-and-crown-delineation.html#cb176-1" tabindex="-1"></a><span class="co"># get ws by ht for each fn</span></span>
<span id="cb176-2"><a href="validate-tree-detection-and-crown-delineation.html#cb176-2" tabindex="-1"></a>ws_fn_df <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(cloud2trees<span class="sc">::</span><span class="fu">itd_ws_functions</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb176-3"><a href="validate-tree-detection-and-crown-delineation.html#cb176-3" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(<span class="cf">function</span>(x){</span>
<span id="cb176-4"><a href="validate-tree-detection-and-crown-delineation.html#cb176-4" tabindex="-1"></a>    nm <span class="ot">&lt;-</span> cloud2trees<span class="sc">::</span><span class="fu">itd_ws_functions</span>()[x] <span class="sc">%&gt;%</span> <span class="fu">names</span>() <span class="sc">%&gt;%</span> <span class="fu">as.character</span>()</span>
<span id="cb176-5"><a href="validate-tree-detection-and-crown-delineation.html#cb176-5" tabindex="-1"></a>    fn <span class="ot">&lt;-</span> cloud2trees<span class="sc">::</span><span class="fu">itd_ws_functions</span>()[[x]]</span>
<span id="cb176-6"><a href="validate-tree-detection-and-crown-delineation.html#cb176-6" tabindex="-1"></a>    <span class="co"># est</span></span>
<span id="cb176-7"><a href="validate-tree-detection-and-crown-delineation.html#cb176-7" tabindex="-1"></a>    height <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from=</span><span class="dv">0</span>,<span class="at">to=</span><span class="dv">60</span>,<span class="at">by=</span><span class="fl">0.5</span>)</span>
<span id="cb176-8"><a href="validate-tree-detection-and-crown-delineation.html#cb176-8" tabindex="-1"></a>    ws <span class="ot">&lt;-</span> <span class="fu">fn</span>(height) <span class="sc">%&gt;%</span> <span class="fu">unlist</span>()</span>
<span id="cb176-9"><a href="validate-tree-detection-and-crown-delineation.html#cb176-9" tabindex="-1"></a>    df <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb176-10"><a href="validate-tree-detection-and-crown-delineation.html#cb176-10" tabindex="-1"></a>        <span class="at">height =</span> height</span>
<span id="cb176-11"><a href="validate-tree-detection-and-crown-delineation.html#cb176-11" tabindex="-1"></a>        , <span class="at">ws =</span> ws</span>
<span id="cb176-12"><a href="validate-tree-detection-and-crown-delineation.html#cb176-12" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb176-13"><a href="validate-tree-detection-and-crown-delineation.html#cb176-13" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">ws_fn_nm =</span> nm) <span class="sc">%&gt;%</span> </span>
<span id="cb176-14"><a href="validate-tree-detection-and-crown-delineation.html#cb176-14" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">relocate</span>(ws_fn_nm)</span>
<span id="cb176-15"><a href="validate-tree-detection-and-crown-delineation.html#cb176-15" tabindex="-1"></a>    <span class="fu">return</span>(df)</span>
<span id="cb176-16"><a href="validate-tree-detection-and-crown-delineation.html#cb176-16" tabindex="-1"></a>  }) <span class="sc">%&gt;%</span> </span>
<span id="cb176-17"><a href="validate-tree-detection-and-crown-delineation.html#cb176-17" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span>
<span id="cb176-18"><a href="validate-tree-detection-and-crown-delineation.html#cb176-18" tabindex="-1"></a><span class="co"># huh?</span></span>
<span id="cb176-19"><a href="validate-tree-detection-and-crown-delineation.html#cb176-19" tabindex="-1"></a>ws_fn_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 363
## Columns: 3
## $ ws_fn_nm &lt;chr&gt; &quot;lin_fn&quot;, &quot;lin_fn&quot;, &quot;lin_fn&quot;, &quot;lin_fn&quot;, &quot;lin_fn&quot;, &quot;lin_fn&quot;, &quot;…
## $ height   &lt;dbl&gt; 0.0, 0.5, 1.0, 1.5, 2.0, 2.5, 3.0, 3.5, 4.0, 4.5, 5.0, 5.5, 6…
## $ ws       &lt;dbl&gt; 1.00, 1.00, 1.00, 1.00, 1.03, 1.10, 1.17, 1.24, 1.31, 1.38, 1…</code></pre>
<p>plot of <code>cloud2trees</code> default ITD variable window function</p>
<div class="sourceCode" id="cb178"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb178-1"><a href="validate-tree-detection-and-crown-delineation.html#cb178-1" tabindex="-1"></a><span class="co"># define custom colors</span></span>
<span id="cb178-2"><a href="validate-tree-detection-and-crown-delineation.html#cb178-2" tabindex="-1"></a>pal_ws <span class="ot">&lt;-</span> </span>
<span id="cb178-3"><a href="validate-tree-detection-and-crown-delineation.html#cb178-3" tabindex="-1"></a>  <span class="fu">c</span>(</span>
<span id="cb178-4"><a href="validate-tree-detection-and-crown-delineation.html#cb178-4" tabindex="-1"></a>    RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(<span class="at">n =</span> <span class="dv">7</span>, <span class="at">name =</span> <span class="st">&quot;Purples&quot;</span>)[<span class="dv">2</span><span class="sc">:</span><span class="dv">6</span>] <span class="sc">%&gt;%</span> <span class="fu">rev</span>()</span>
<span id="cb178-5"><a href="validate-tree-detection-and-crown-delineation.html#cb178-5" tabindex="-1"></a>    , RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(<span class="at">n =</span> <span class="dv">11</span>, <span class="at">name =</span> <span class="st">&quot;BrBG&quot;</span>)[<span class="dv">7</span><span class="sc">:</span><span class="dv">11</span>] <span class="sc">%&gt;%</span> <span class="fu">rev</span>()</span>
<span id="cb178-6"><a href="validate-tree-detection-and-crown-delineation.html#cb178-6" tabindex="-1"></a>    , RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(<span class="at">n =</span> <span class="dv">7</span>, <span class="at">name =</span> <span class="st">&quot;Oranges&quot;</span>)[<span class="dv">2</span><span class="sc">:</span><span class="dv">6</span>] <span class="sc">%&gt;%</span> <span class="fu">rev</span>()</span>
<span id="cb178-7"><a href="validate-tree-detection-and-crown-delineation.html#cb178-7" tabindex="-1"></a>    , RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(<span class="at">n =</span> <span class="dv">7</span>, <span class="at">name =</span> <span class="st">&quot;Greys&quot;</span>)[<span class="dv">2</span><span class="sc">:</span><span class="dv">6</span>] <span class="sc">%&gt;%</span> <span class="fu">rev</span>()</span>
<span id="cb178-8"><a href="validate-tree-detection-and-crown-delineation.html#cb178-8" tabindex="-1"></a>  )</span>
<span id="cb178-9"><a href="validate-tree-detection-and-crown-delineation.html#cb178-9" tabindex="-1"></a><span class="co"># scales::show_col(pal_ws)</span></span>
<span id="cb178-10"><a href="validate-tree-detection-and-crown-delineation.html#cb178-10" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb178-11"><a href="validate-tree-detection-and-crown-delineation.html#cb178-11" tabindex="-1"></a>ws_fn_df <span class="sc">%&gt;%</span> </span>
<span id="cb178-12"><a href="validate-tree-detection-and-crown-delineation.html#cb178-12" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> height, <span class="at">y =</span> ws, <span class="at">color =</span> ws_fn_nm)) <span class="sc">+</span></span>
<span id="cb178-13"><a href="validate-tree-detection-and-crown-delineation.html#cb178-13" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">lwd=</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb178-14"><a href="validate-tree-detection-and-crown-delineation.html#cb178-14" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> pal_ws[<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">6</span>,<span class="dv">11</span>)]) <span class="sc">+</span></span>
<span id="cb178-15"><a href="validate-tree-detection-and-crown-delineation.html#cb178-15" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">xlim</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb178-16"><a href="validate-tree-detection-and-crown-delineation.html#cb178-16" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ylim</span>(<span class="sc">-</span><span class="fl">0.1</span>,<span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb178-17"><a href="validate-tree-detection-and-crown-delineation.html#cb178-17" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb178-18"><a href="validate-tree-detection-and-crown-delineation.html#cb178-18" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;heights&quot;</span>, <span class="at">y =</span> <span class="st">&quot;ws&quot;</span></span>
<span id="cb178-19"><a href="validate-tree-detection-and-crown-delineation.html#cb178-19" tabindex="-1"></a>    , <span class="at">color =</span> <span class="st">&quot;variable</span><span class="sc">\n</span><span class="st">window</span><span class="sc">\n</span><span class="st">function&quot;</span></span>
<span id="cb178-20"><a href="validate-tree-detection-and-crown-delineation.html#cb178-20" tabindex="-1"></a>    , <span class="at">subtitle =</span> <span class="st">&quot;`cloud2trees` default ITD variable window function&quot;</span></span>
<span id="cb178-21"><a href="validate-tree-detection-and-crown-delineation.html#cb178-21" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb178-22"><a href="validate-tree-detection-and-crown-delineation.html#cb178-22" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb178-23"><a href="validate-tree-detection-and-crown-delineation.html#cb178-23" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">guides</span>(</span>
<span id="cb178-24"><a href="validate-tree-detection-and-crown-delineation.html#cb178-24" tabindex="-1"></a>    <span class="at">color =</span> ggplot2<span class="sc">::</span><span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">lwd =</span> <span class="dv">6</span>))</span>
<span id="cb178-25"><a href="validate-tree-detection-and-crown-delineation.html#cb178-25" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-157-1.png" width="1008" /></p>
</div>
<div id="augmented-variable-window-functions" class="section level3 hasAnchor" number="4.1.2">
<h3><span class="header-section-number">4.1.2</span> Augmented variable window functions<a href="validate-tree-detection-and-crown-delineation.html#augmented-variable-window-functions" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>now we’ll augment the default functions to make:</p>
<ul>
<li>the exponential function (concave up) have slightly less (“les”), less (“less”), much less (“lesss”) and slightly more (“mor”) concavity (4 new functions)</li>
<li>the logarithmic function (concave down) have slightly more (“mor”), more (“morr”), slightly less (“les”), and less (“less”) concavity (4 new functions)</li>
<li>the linear function have a higher and lower intercept and a higher and lower slope (4 new functions)</li>
</ul>
<p>for a total of 15 functions tested</p>
<div class="sourceCode" id="cb179"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb179-1"><a href="validate-tree-detection-and-crown-delineation.html#cb179-1" tabindex="-1"></a><span class="co"># set up initial list with default functions</span></span>
<span id="cb179-2"><a href="validate-tree-detection-and-crown-delineation.html#cb179-2" tabindex="-1"></a>my_ws_functions <span class="ot">&lt;-</span> cloud2trees<span class="sc">::</span><span class="fu">itd_ws_functions</span>()</span>
<span id="cb179-3"><a href="validate-tree-detection-and-crown-delineation.html#cb179-3" tabindex="-1"></a><span class="co"># add to list</span></span>
<span id="cb179-4"><a href="validate-tree-detection-and-crown-delineation.html#cb179-4" tabindex="-1"></a>my_ws_functions<span class="sc">$</span>log_les_ccv_fn <span class="ot">&lt;-</span> <span class="cf">function</span> (x) {</span>
<span id="cb179-5"><a href="validate-tree-detection-and-crown-delineation.html#cb179-5" tabindex="-1"></a>    y <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb179-6"><a href="validate-tree-detection-and-crown-delineation.html#cb179-6" tabindex="-1"></a>      <span class="fu">is.na</span>(x) <span class="sc">~</span> <span class="fl">0.001</span></span>
<span id="cb179-7"><a href="validate-tree-detection-and-crown-delineation.html#cb179-7" tabindex="-1"></a>      , x <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="fl">0.001</span></span>
<span id="cb179-8"><a href="validate-tree-detection-and-crown-delineation.html#cb179-8" tabindex="-1"></a>      , x <span class="sc">&gt;</span> <span class="fu">exp</span>(<span class="dv">5</span>)<span class="sc">-</span><span class="dv">1</span> <span class="sc">~</span> <span class="dv">5</span></span>
<span id="cb179-9"><a href="validate-tree-detection-and-crown-delineation.html#cb179-9" tabindex="-1"></a>      , <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fu">log</span>(x<span class="sc">+</span><span class="dv">1</span>)</span>
<span id="cb179-10"><a href="validate-tree-detection-and-crown-delineation.html#cb179-10" tabindex="-1"></a>    )</span>
<span id="cb179-11"><a href="validate-tree-detection-and-crown-delineation.html#cb179-11" tabindex="-1"></a>    <span class="fu">return</span>(y)</span>
<span id="cb179-12"><a href="validate-tree-detection-and-crown-delineation.html#cb179-12" tabindex="-1"></a>}</span>
<span id="cb179-13"><a href="validate-tree-detection-and-crown-delineation.html#cb179-13" tabindex="-1"></a><span class="co"># add to list</span></span>
<span id="cb179-14"><a href="validate-tree-detection-and-crown-delineation.html#cb179-14" tabindex="-1"></a>my_ws_functions<span class="sc">$</span>log_less_ccv_fn <span class="ot">&lt;-</span> <span class="cf">function</span> (x) {</span>
<span id="cb179-15"><a href="validate-tree-detection-and-crown-delineation.html#cb179-15" tabindex="-1"></a>    y <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb179-16"><a href="validate-tree-detection-and-crown-delineation.html#cb179-16" tabindex="-1"></a>      <span class="fu">is.na</span>(x) <span class="sc">~</span> <span class="fl">0.001</span></span>
<span id="cb179-17"><a href="validate-tree-detection-and-crown-delineation.html#cb179-17" tabindex="-1"></a>      , x <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="fl">0.001</span></span>
<span id="cb179-18"><a href="validate-tree-detection-and-crown-delineation.html#cb179-18" tabindex="-1"></a>      , x <span class="sc">&gt;</span> <span class="fu">exp</span>(<span class="dv">3</span><span class="sc">/</span><span class="fl">0.5</span>)<span class="sc">-</span><span class="dv">1</span> <span class="sc">~</span> <span class="dv">3</span></span>
<span id="cb179-19"><a href="validate-tree-detection-and-crown-delineation.html#cb179-19" tabindex="-1"></a>      , <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fl">0.5</span><span class="sc">*</span><span class="fu">log</span>(x<span class="sc">+</span><span class="dv">1</span>)</span>
<span id="cb179-20"><a href="validate-tree-detection-and-crown-delineation.html#cb179-20" tabindex="-1"></a>    )</span>
<span id="cb179-21"><a href="validate-tree-detection-and-crown-delineation.html#cb179-21" tabindex="-1"></a>    <span class="fu">return</span>(y)</span>
<span id="cb179-22"><a href="validate-tree-detection-and-crown-delineation.html#cb179-22" tabindex="-1"></a>}</span>
<span id="cb179-23"><a href="validate-tree-detection-and-crown-delineation.html#cb179-23" tabindex="-1"></a><span class="co"># add to list</span></span>
<span id="cb179-24"><a href="validate-tree-detection-and-crown-delineation.html#cb179-24" tabindex="-1"></a>my_ws_functions<span class="sc">$</span>log_morr_ccv_fn <span class="ot">&lt;-</span> <span class="cf">function</span> (x) {</span>
<span id="cb179-25"><a href="validate-tree-detection-and-crown-delineation.html#cb179-25" tabindex="-1"></a>    y <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb179-26"><a href="validate-tree-detection-and-crown-delineation.html#cb179-26" tabindex="-1"></a>      <span class="fu">is.na</span>(x) <span class="sc">~</span> <span class="fl">0.001</span></span>
<span id="cb179-27"><a href="validate-tree-detection-and-crown-delineation.html#cb179-27" tabindex="-1"></a>      , x <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="fl">0.001</span></span>
<span id="cb179-28"><a href="validate-tree-detection-and-crown-delineation.html#cb179-28" tabindex="-1"></a>      , x <span class="sc">&gt;</span> <span class="fu">exp</span>(<span class="dv">9</span><span class="sc">/</span><span class="dv">2</span>)<span class="sc">-</span><span class="dv">1</span> <span class="sc">~</span> <span class="dv">9</span></span>
<span id="cb179-29"><a href="validate-tree-detection-and-crown-delineation.html#cb179-29" tabindex="-1"></a>      , <span class="cn">TRUE</span> <span class="sc">~</span> <span class="dv">2</span><span class="sc">*</span><span class="fu">log</span>(x<span class="sc">+</span><span class="dv">1</span>)</span>
<span id="cb179-30"><a href="validate-tree-detection-and-crown-delineation.html#cb179-30" tabindex="-1"></a>    )</span>
<span id="cb179-31"><a href="validate-tree-detection-and-crown-delineation.html#cb179-31" tabindex="-1"></a>    <span class="fu">return</span>(y)</span>
<span id="cb179-32"><a href="validate-tree-detection-and-crown-delineation.html#cb179-32" tabindex="-1"></a>}</span>
<span id="cb179-33"><a href="validate-tree-detection-and-crown-delineation.html#cb179-33" tabindex="-1"></a><span class="co"># add to list</span></span>
<span id="cb179-34"><a href="validate-tree-detection-and-crown-delineation.html#cb179-34" tabindex="-1"></a>my_ws_functions<span class="sc">$</span>log_mor_ccv_fn <span class="ot">&lt;-</span> <span class="cf">function</span> (x) {</span>
<span id="cb179-35"><a href="validate-tree-detection-and-crown-delineation.html#cb179-35" tabindex="-1"></a>    y <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb179-36"><a href="validate-tree-detection-and-crown-delineation.html#cb179-36" tabindex="-1"></a>      <span class="fu">is.na</span>(x) <span class="sc">~</span> <span class="fl">0.001</span></span>
<span id="cb179-37"><a href="validate-tree-detection-and-crown-delineation.html#cb179-37" tabindex="-1"></a>      , x <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="fl">0.001</span></span>
<span id="cb179-38"><a href="validate-tree-detection-and-crown-delineation.html#cb179-38" tabindex="-1"></a>      , x <span class="sc">&gt;</span> <span class="fu">exp</span>(<span class="dv">7</span><span class="sc">/</span><span class="fl">1.5</span>)<span class="sc">-</span><span class="dv">1</span> <span class="sc">~</span> <span class="dv">7</span></span>
<span id="cb179-39"><a href="validate-tree-detection-and-crown-delineation.html#cb179-39" tabindex="-1"></a>      , <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fl">1.5</span><span class="sc">*</span><span class="fu">log</span>(x<span class="sc">+</span><span class="dv">1</span>)</span>
<span id="cb179-40"><a href="validate-tree-detection-and-crown-delineation.html#cb179-40" tabindex="-1"></a>    )</span>
<span id="cb179-41"><a href="validate-tree-detection-and-crown-delineation.html#cb179-41" tabindex="-1"></a>    <span class="fu">return</span>(y)</span>
<span id="cb179-42"><a href="validate-tree-detection-and-crown-delineation.html#cb179-42" tabindex="-1"></a>}</span>
<span id="cb179-43"><a href="validate-tree-detection-and-crown-delineation.html#cb179-43" tabindex="-1"></a><span class="co"># add to list</span></span>
<span id="cb179-44"><a href="validate-tree-detection-and-crown-delineation.html#cb179-44" tabindex="-1"></a>my_ws_functions<span class="sc">$</span>exp_mor_ccv_fn <span class="ot">&lt;-</span> <span class="cf">function</span> (x) {</span>
<span id="cb179-45"><a href="validate-tree-detection-and-crown-delineation.html#cb179-45" tabindex="-1"></a>    y <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb179-46"><a href="validate-tree-detection-and-crown-delineation.html#cb179-46" tabindex="-1"></a>      <span class="fu">is.na</span>(x) <span class="sc">~</span> <span class="fl">0.001</span></span>
<span id="cb179-47"><a href="validate-tree-detection-and-crown-delineation.html#cb179-47" tabindex="-1"></a>      , x <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="fl">0.001</span></span>
<span id="cb179-48"><a href="validate-tree-detection-and-crown-delineation.html#cb179-48" tabindex="-1"></a>      , x <span class="sc">&gt;</span> <span class="fu">log</span>(<span class="dv">8</span><span class="sc">+</span><span class="dv">1</span>)<span class="sc">/</span><span class="fu">log</span>(<span class="fl">1.1</span>) <span class="sc">~</span> <span class="dv">8</span></span>
<span id="cb179-49"><a href="validate-tree-detection-and-crown-delineation.html#cb179-49" tabindex="-1"></a>      , <span class="cn">TRUE</span> <span class="sc">~</span> (<span class="fl">1.1</span><span class="sc">^</span>x)<span class="sc">-</span><span class="dv">1</span></span>
<span id="cb179-50"><a href="validate-tree-detection-and-crown-delineation.html#cb179-50" tabindex="-1"></a>    )</span>
<span id="cb179-51"><a href="validate-tree-detection-and-crown-delineation.html#cb179-51" tabindex="-1"></a>    <span class="fu">return</span>(y)</span>
<span id="cb179-52"><a href="validate-tree-detection-and-crown-delineation.html#cb179-52" tabindex="-1"></a>}</span>
<span id="cb179-53"><a href="validate-tree-detection-and-crown-delineation.html#cb179-53" tabindex="-1"></a><span class="co"># add to list</span></span>
<span id="cb179-54"><a href="validate-tree-detection-and-crown-delineation.html#cb179-54" tabindex="-1"></a>my_ws_functions<span class="sc">$</span>exp_lesss_ccv_fn <span class="ot">&lt;-</span> <span class="cf">function</span> (x) {</span>
<span id="cb179-55"><a href="validate-tree-detection-and-crown-delineation.html#cb179-55" tabindex="-1"></a>    y <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb179-56"><a href="validate-tree-detection-and-crown-delineation.html#cb179-56" tabindex="-1"></a>      <span class="fu">is.na</span>(x) <span class="sc">~</span> <span class="fl">0.001</span></span>
<span id="cb179-57"><a href="validate-tree-detection-and-crown-delineation.html#cb179-57" tabindex="-1"></a>      , x <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="fl">0.001</span></span>
<span id="cb179-58"><a href="validate-tree-detection-and-crown-delineation.html#cb179-58" tabindex="-1"></a>      , x <span class="sc">&gt;</span> <span class="fu">log</span>(<span class="dv">5</span><span class="sc">+</span><span class="dv">1</span>)<span class="sc">/</span><span class="fu">log</span>(<span class="fl">1.015</span>) <span class="sc">~</span> <span class="dv">5</span></span>
<span id="cb179-59"><a href="validate-tree-detection-and-crown-delineation.html#cb179-59" tabindex="-1"></a>      , <span class="cn">TRUE</span> <span class="sc">~</span> (<span class="fl">1.015</span><span class="sc">^</span>x)<span class="sc">-</span><span class="dv">1</span></span>
<span id="cb179-60"><a href="validate-tree-detection-and-crown-delineation.html#cb179-60" tabindex="-1"></a>    )</span>
<span id="cb179-61"><a href="validate-tree-detection-and-crown-delineation.html#cb179-61" tabindex="-1"></a>    <span class="fu">return</span>(y)</span>
<span id="cb179-62"><a href="validate-tree-detection-and-crown-delineation.html#cb179-62" tabindex="-1"></a>}</span>
<span id="cb179-63"><a href="validate-tree-detection-and-crown-delineation.html#cb179-63" tabindex="-1"></a><span class="co"># add to list</span></span>
<span id="cb179-64"><a href="validate-tree-detection-and-crown-delineation.html#cb179-64" tabindex="-1"></a>my_ws_functions<span class="sc">$</span>exp_less_ccv_fn <span class="ot">&lt;-</span> <span class="cf">function</span> (x) {</span>
<span id="cb179-65"><a href="validate-tree-detection-and-crown-delineation.html#cb179-65" tabindex="-1"></a>    y <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb179-66"><a href="validate-tree-detection-and-crown-delineation.html#cb179-66" tabindex="-1"></a>      <span class="fu">is.na</span>(x) <span class="sc">~</span> <span class="fl">0.001</span></span>
<span id="cb179-67"><a href="validate-tree-detection-and-crown-delineation.html#cb179-67" tabindex="-1"></a>      , x <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="fl">0.001</span></span>
<span id="cb179-68"><a href="validate-tree-detection-and-crown-delineation.html#cb179-68" tabindex="-1"></a>      , x <span class="sc">&gt;</span> <span class="fu">log</span>(<span class="dv">5</span><span class="sc">+</span><span class="dv">1</span>)<span class="sc">/</span><span class="fu">log</span>(<span class="fl">1.03</span>) <span class="sc">~</span> <span class="dv">5</span></span>
<span id="cb179-69"><a href="validate-tree-detection-and-crown-delineation.html#cb179-69" tabindex="-1"></a>      , <span class="cn">TRUE</span> <span class="sc">~</span> (<span class="fl">1.03</span><span class="sc">^</span>x)<span class="sc">-</span><span class="dv">1</span></span>
<span id="cb179-70"><a href="validate-tree-detection-and-crown-delineation.html#cb179-70" tabindex="-1"></a>    )</span>
<span id="cb179-71"><a href="validate-tree-detection-and-crown-delineation.html#cb179-71" tabindex="-1"></a>    <span class="fu">return</span>(y)</span>
<span id="cb179-72"><a href="validate-tree-detection-and-crown-delineation.html#cb179-72" tabindex="-1"></a>}</span>
<span id="cb179-73"><a href="validate-tree-detection-and-crown-delineation.html#cb179-73" tabindex="-1"></a><span class="co"># add to list</span></span>
<span id="cb179-74"><a href="validate-tree-detection-and-crown-delineation.html#cb179-74" tabindex="-1"></a>my_ws_functions<span class="sc">$</span>exp_les_ccv_fn <span class="ot">&lt;-</span> <span class="cf">function</span> (x) {</span>
<span id="cb179-75"><a href="validate-tree-detection-and-crown-delineation.html#cb179-75" tabindex="-1"></a>    y <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb179-76"><a href="validate-tree-detection-and-crown-delineation.html#cb179-76" tabindex="-1"></a>      <span class="fu">is.na</span>(x) <span class="sc">~</span> <span class="fl">0.001</span></span>
<span id="cb179-77"><a href="validate-tree-detection-and-crown-delineation.html#cb179-77" tabindex="-1"></a>      , x <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="fl">0.001</span></span>
<span id="cb179-78"><a href="validate-tree-detection-and-crown-delineation.html#cb179-78" tabindex="-1"></a>      , x <span class="sc">&gt;</span> <span class="fu">log</span>(<span class="dv">5</span><span class="sc">+</span><span class="dv">1</span>)<span class="sc">/</span><span class="fu">log</span>(<span class="fl">1.05</span>) <span class="sc">~</span> <span class="dv">5</span></span>
<span id="cb179-79"><a href="validate-tree-detection-and-crown-delineation.html#cb179-79" tabindex="-1"></a>      , <span class="cn">TRUE</span> <span class="sc">~</span> (<span class="fl">1.05</span><span class="sc">^</span>x)<span class="sc">-</span><span class="dv">1</span></span>
<span id="cb179-80"><a href="validate-tree-detection-and-crown-delineation.html#cb179-80" tabindex="-1"></a>    )</span>
<span id="cb179-81"><a href="validate-tree-detection-and-crown-delineation.html#cb179-81" tabindex="-1"></a>    <span class="fu">return</span>(y)</span>
<span id="cb179-82"><a href="validate-tree-detection-and-crown-delineation.html#cb179-82" tabindex="-1"></a>}</span>
<span id="cb179-83"><a href="validate-tree-detection-and-crown-delineation.html#cb179-83" tabindex="-1"></a><span class="co"># add to list</span></span>
<span id="cb179-84"><a href="validate-tree-detection-and-crown-delineation.html#cb179-84" tabindex="-1"></a>my_ws_functions<span class="sc">$</span>lin_hi_int_fn <span class="ot">&lt;-</span> <span class="cf">function</span> (x) {</span>
<span id="cb179-85"><a href="validate-tree-detection-and-crown-delineation.html#cb179-85" tabindex="-1"></a>    y <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb179-86"><a href="validate-tree-detection-and-crown-delineation.html#cb179-86" tabindex="-1"></a>      <span class="fu">is.na</span>(x) <span class="sc">~</span> <span class="fl">0.001</span></span>
<span id="cb179-87"><a href="validate-tree-detection-and-crown-delineation.html#cb179-87" tabindex="-1"></a>      , x <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="fl">0.001</span></span>
<span id="cb179-88"><a href="validate-tree-detection-and-crown-delineation.html#cb179-88" tabindex="-1"></a>      , x <span class="sc">&gt;</span> (<span class="dv">8</span><span class="fl">-1.2</span>)<span class="sc">/</span><span class="fl">0.14</span> <span class="sc">~</span> <span class="dv">8</span></span>
<span id="cb179-89"><a href="validate-tree-detection-and-crown-delineation.html#cb179-89" tabindex="-1"></a>      , <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fl">1.2</span> <span class="sc">+</span> (x <span class="sc">*</span> <span class="fl">0.14</span>)</span>
<span id="cb179-90"><a href="validate-tree-detection-and-crown-delineation.html#cb179-90" tabindex="-1"></a>    )</span>
<span id="cb179-91"><a href="validate-tree-detection-and-crown-delineation.html#cb179-91" tabindex="-1"></a>    <span class="fu">return</span>(y)</span>
<span id="cb179-92"><a href="validate-tree-detection-and-crown-delineation.html#cb179-92" tabindex="-1"></a>}</span>
<span id="cb179-93"><a href="validate-tree-detection-and-crown-delineation.html#cb179-93" tabindex="-1"></a><span class="co"># add to list</span></span>
<span id="cb179-94"><a href="validate-tree-detection-and-crown-delineation.html#cb179-94" tabindex="-1"></a>my_ws_functions<span class="sc">$</span>lin_lo_int_fn <span class="ot">&lt;-</span> <span class="cf">function</span> (x) {</span>
<span id="cb179-95"><a href="validate-tree-detection-and-crown-delineation.html#cb179-95" tabindex="-1"></a>    y <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb179-96"><a href="validate-tree-detection-and-crown-delineation.html#cb179-96" tabindex="-1"></a>      <span class="fu">is.na</span>(x) <span class="sc">~</span> <span class="fl">0.001</span></span>
<span id="cb179-97"><a href="validate-tree-detection-and-crown-delineation.html#cb179-97" tabindex="-1"></a>      , x <span class="sc">&lt;</span> (<span class="fl">0.5</span><span class="sc">+</span><span class="dv">2</span>)<span class="sc">/</span><span class="fl">0.14</span> <span class="sc">~</span> <span class="fl">0.5</span></span>
<span id="cb179-98"><a href="validate-tree-detection-and-crown-delineation.html#cb179-98" tabindex="-1"></a>      , x <span class="sc">&gt;</span> (<span class="dv">6</span><span class="sc">+</span><span class="dv">2</span>)<span class="sc">/</span><span class="fl">0.14</span> <span class="sc">~</span> <span class="dv">6</span></span>
<span id="cb179-99"><a href="validate-tree-detection-and-crown-delineation.html#cb179-99" tabindex="-1"></a>      , <span class="cn">TRUE</span> <span class="sc">~</span> <span class="sc">-</span><span class="dv">2</span> <span class="sc">+</span> (x <span class="sc">*</span> <span class="fl">0.14</span>)</span>
<span id="cb179-100"><a href="validate-tree-detection-and-crown-delineation.html#cb179-100" tabindex="-1"></a>    )</span>
<span id="cb179-101"><a href="validate-tree-detection-and-crown-delineation.html#cb179-101" tabindex="-1"></a>    <span class="fu">return</span>(y)</span>
<span id="cb179-102"><a href="validate-tree-detection-and-crown-delineation.html#cb179-102" tabindex="-1"></a>}</span>
<span id="cb179-103"><a href="validate-tree-detection-and-crown-delineation.html#cb179-103" tabindex="-1"></a><span class="co"># add to list</span></span>
<span id="cb179-104"><a href="validate-tree-detection-and-crown-delineation.html#cb179-104" tabindex="-1"></a>my_ws_functions<span class="sc">$</span>lin_hi_slp_fn <span class="ot">&lt;-</span> <span class="cf">function</span> (x) {</span>
<span id="cb179-105"><a href="validate-tree-detection-and-crown-delineation.html#cb179-105" tabindex="-1"></a>    y <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb179-106"><a href="validate-tree-detection-and-crown-delineation.html#cb179-106" tabindex="-1"></a>      <span class="fu">is.na</span>(x) <span class="sc">~</span> <span class="fl">0.001</span></span>
<span id="cb179-107"><a href="validate-tree-detection-and-crown-delineation.html#cb179-107" tabindex="-1"></a>      , x <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="fl">0.001</span></span>
<span id="cb179-108"><a href="validate-tree-detection-and-crown-delineation.html#cb179-108" tabindex="-1"></a>      , x <span class="sc">&gt;</span> (<span class="dv">8</span><span class="fl">-0.75</span>)<span class="sc">/</span><span class="fl">0.3</span> <span class="sc">~</span> <span class="dv">8</span></span>
<span id="cb179-109"><a href="validate-tree-detection-and-crown-delineation.html#cb179-109" tabindex="-1"></a>      , <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fl">0.75</span> <span class="sc">+</span> (x <span class="sc">*</span> <span class="fl">0.3</span>)</span>
<span id="cb179-110"><a href="validate-tree-detection-and-crown-delineation.html#cb179-110" tabindex="-1"></a>    )</span>
<span id="cb179-111"><a href="validate-tree-detection-and-crown-delineation.html#cb179-111" tabindex="-1"></a>    <span class="fu">return</span>(y)</span>
<span id="cb179-112"><a href="validate-tree-detection-and-crown-delineation.html#cb179-112" tabindex="-1"></a>}</span>
<span id="cb179-113"><a href="validate-tree-detection-and-crown-delineation.html#cb179-113" tabindex="-1"></a><span class="co"># add to list</span></span>
<span id="cb179-114"><a href="validate-tree-detection-and-crown-delineation.html#cb179-114" tabindex="-1"></a>my_ws_functions<span class="sc">$</span>lin_lo_slp_fn <span class="ot">&lt;-</span> <span class="cf">function</span> (x) {</span>
<span id="cb179-115"><a href="validate-tree-detection-and-crown-delineation.html#cb179-115" tabindex="-1"></a>    y <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb179-116"><a href="validate-tree-detection-and-crown-delineation.html#cb179-116" tabindex="-1"></a>      <span class="fu">is.na</span>(x) <span class="sc">~</span> <span class="fl">0.001</span></span>
<span id="cb179-117"><a href="validate-tree-detection-and-crown-delineation.html#cb179-117" tabindex="-1"></a>      , x <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="fl">0.001</span></span>
<span id="cb179-118"><a href="validate-tree-detection-and-crown-delineation.html#cb179-118" tabindex="-1"></a>      , x <span class="sc">&gt;</span> (<span class="dv">4</span><span class="fl">-0.75</span>)<span class="sc">/</span><span class="fl">0.04</span> <span class="sc">~</span> <span class="dv">4</span></span>
<span id="cb179-119"><a href="validate-tree-detection-and-crown-delineation.html#cb179-119" tabindex="-1"></a>      , <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fl">0.75</span> <span class="sc">+</span> (x <span class="sc">*</span> <span class="fl">0.04</span>)</span>
<span id="cb179-120"><a href="validate-tree-detection-and-crown-delineation.html#cb179-120" tabindex="-1"></a>    )</span>
<span id="cb179-121"><a href="validate-tree-detection-and-crown-delineation.html#cb179-121" tabindex="-1"></a>    <span class="fu">return</span>(y)</span>
<span id="cb179-122"><a href="validate-tree-detection-and-crown-delineation.html#cb179-122" tabindex="-1"></a>}</span></code></pre></div>
<p>run each function over a range of heights to see what they return on a plot</p>
<div class="sourceCode" id="cb180"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb180-1"><a href="validate-tree-detection-and-crown-delineation.html#cb180-1" tabindex="-1"></a><span class="co"># get ws by ht for each fn</span></span>
<span id="cb180-2"><a href="validate-tree-detection-and-crown-delineation.html#cb180-2" tabindex="-1"></a>ws_fn_df <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(my_ws_functions) <span class="sc">%&gt;%</span></span>
<span id="cb180-3"><a href="validate-tree-detection-and-crown-delineation.html#cb180-3" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(<span class="cf">function</span>(x){</span>
<span id="cb180-4"><a href="validate-tree-detection-and-crown-delineation.html#cb180-4" tabindex="-1"></a>    nm <span class="ot">&lt;-</span> my_ws_functions[x] <span class="sc">%&gt;%</span> <span class="fu">names</span>() <span class="sc">%&gt;%</span> <span class="fu">as.character</span>()</span>
<span id="cb180-5"><a href="validate-tree-detection-and-crown-delineation.html#cb180-5" tabindex="-1"></a>    fn <span class="ot">&lt;-</span> my_ws_functions[[x]]</span>
<span id="cb180-6"><a href="validate-tree-detection-and-crown-delineation.html#cb180-6" tabindex="-1"></a>    <span class="co"># est</span></span>
<span id="cb180-7"><a href="validate-tree-detection-and-crown-delineation.html#cb180-7" tabindex="-1"></a>    height <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from=</span><span class="dv">0</span>,<span class="at">to=</span><span class="dv">60</span>,<span class="at">by=</span><span class="fl">0.5</span>)</span>
<span id="cb180-8"><a href="validate-tree-detection-and-crown-delineation.html#cb180-8" tabindex="-1"></a>    ws <span class="ot">&lt;-</span> <span class="fu">fn</span>(height) <span class="sc">%&gt;%</span> <span class="fu">unlist</span>()</span>
<span id="cb180-9"><a href="validate-tree-detection-and-crown-delineation.html#cb180-9" tabindex="-1"></a>    df <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb180-10"><a href="validate-tree-detection-and-crown-delineation.html#cb180-10" tabindex="-1"></a>        <span class="at">height =</span> height</span>
<span id="cb180-11"><a href="validate-tree-detection-and-crown-delineation.html#cb180-11" tabindex="-1"></a>        , <span class="at">ws =</span> ws</span>
<span id="cb180-12"><a href="validate-tree-detection-and-crown-delineation.html#cb180-12" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb180-13"><a href="validate-tree-detection-and-crown-delineation.html#cb180-13" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">ws_fn_nm =</span> nm) <span class="sc">%&gt;%</span> </span>
<span id="cb180-14"><a href="validate-tree-detection-and-crown-delineation.html#cb180-14" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">relocate</span>(ws_fn_nm)</span>
<span id="cb180-15"><a href="validate-tree-detection-and-crown-delineation.html#cb180-15" tabindex="-1"></a>    <span class="fu">return</span>(df)</span>
<span id="cb180-16"><a href="validate-tree-detection-and-crown-delineation.html#cb180-16" tabindex="-1"></a>  }) <span class="sc">%&gt;%</span> </span>
<span id="cb180-17"><a href="validate-tree-detection-and-crown-delineation.html#cb180-17" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span>
<span id="cb180-18"><a href="validate-tree-detection-and-crown-delineation.html#cb180-18" tabindex="-1"></a><span class="co"># huh?</span></span>
<span id="cb180-19"><a href="validate-tree-detection-and-crown-delineation.html#cb180-19" tabindex="-1"></a>ws_fn_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 1,815
## Columns: 3
## $ ws_fn_nm &lt;chr&gt; &quot;lin_fn&quot;, &quot;lin_fn&quot;, &quot;lin_fn&quot;, &quot;lin_fn&quot;, &quot;lin_fn&quot;, &quot;lin_fn&quot;, &quot;…
## $ height   &lt;dbl&gt; 0.0, 0.5, 1.0, 1.5, 2.0, 2.5, 3.0, 3.5, 4.0, 4.5, 5.0, 5.5, 6…
## $ ws       &lt;dbl&gt; 1.00, 1.00, 1.00, 1.00, 1.03, 1.10, 1.17, 1.24, 1.31, 1.38, 1…</code></pre>
<p>plot of all ITD variable window functions for testing</p>
<div class="sourceCode" id="cb182"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb182-1"><a href="validate-tree-detection-and-crown-delineation.html#cb182-1" tabindex="-1"></a>ws_fn_df <span class="sc">%&gt;%</span> </span>
<span id="cb182-2"><a href="validate-tree-detection-and-crown-delineation.html#cb182-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> height, <span class="at">y =</span> ws, <span class="at">color =</span> ws_fn_nm)) <span class="sc">+</span></span>
<span id="cb182-3"><a href="validate-tree-detection-and-crown-delineation.html#cb182-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">lwd=</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb182-4"><a href="validate-tree-detection-and-crown-delineation.html#cb182-4" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> pal_ws) <span class="sc">+</span></span>
<span id="cb182-5"><a href="validate-tree-detection-and-crown-delineation.html#cb182-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">xlim</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb182-6"><a href="validate-tree-detection-and-crown-delineation.html#cb182-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ylim</span>(<span class="sc">-</span><span class="fl">0.1</span>,<span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb182-7"><a href="validate-tree-detection-and-crown-delineation.html#cb182-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb182-8"><a href="validate-tree-detection-and-crown-delineation.html#cb182-8" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;heights&quot;</span>, <span class="at">y =</span> <span class="st">&quot;ws&quot;</span></span>
<span id="cb182-9"><a href="validate-tree-detection-and-crown-delineation.html#cb182-9" tabindex="-1"></a>    , <span class="at">color =</span> <span class="st">&quot;variable</span><span class="sc">\n</span><span class="st">window</span><span class="sc">\n</span><span class="st">function&quot;</span></span>
<span id="cb182-10"><a href="validate-tree-detection-and-crown-delineation.html#cb182-10" tabindex="-1"></a>    , <span class="at">subtitle =</span> <span class="st">&quot;ITD variable window functions for testing&quot;</span></span>
<span id="cb182-11"><a href="validate-tree-detection-and-crown-delineation.html#cb182-11" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb182-12"><a href="validate-tree-detection-and-crown-delineation.html#cb182-12" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb182-13"><a href="validate-tree-detection-and-crown-delineation.html#cb182-13" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">guides</span>(</span>
<span id="cb182-14"><a href="validate-tree-detection-and-crown-delineation.html#cb182-14" tabindex="-1"></a>    <span class="at">color =</span> ggplot2<span class="sc">::</span><span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">lwd =</span> <span class="dv">6</span>))</span>
<span id="cb182-15"><a href="validate-tree-detection-and-crown-delineation.html#cb182-15" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-161-1.png" width="1008" /></p>
</div>
</div>
<div id="neontreeevaluation-benchmark" class="section level2 hasAnchor" number="4.2">
<h2><span class="header-section-number">4.2</span> <code>NeonTreeEvaluation</code> benchmark<a href="validate-tree-detection-and-crown-delineation.html#neontreeevaluation-benchmark" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Weinstein et al. (<a href="https://scholar.google.com/scholar?cluster=4986448711981898434&amp;hl=en&amp;as_sdt=0,6">2021</a>) developed:</p>
<blockquote>
<p>a benchmark dataset of individual canopy crowns derived from multi-sensor imagery in the National Ecological Observatory Network (Table 1) that provides: 1) co-registered remote sensing data from multiple sensors (LiDAR, RGB imagery, and hyperspectral imagery) to allow comparisons of methods based on any single sensor (e.g., for LiDAR based methods), or any combination of sensors (e.g., combining RGB and hyperspectral), and 2) three types of evaluation data to allow assessing both ‘tree detection’, defined as the identifying the location of individual trees using evaluation data with a point at the crown center , and ‘crown delineation’ defined as identifying the boundary edge of crowns across a broad range of forest types. The benchmark is designed to allow flexibility in both workflow and sensor selection. (p. 2)</p>
</blockquote>
<p><strong>Table 1.</strong> Summary of datasets included in the benchmark dataset. All sensor data has been cropped to the extent of NEON field sampling plots.</p>
<p><img src="https://i.ibb.co/9kpdPKLN/journal-pcbi-1009180-t001.png" width="100%" height="100%" style="display: block; margin: auto;" /></p>
<p>Note the three data labeled as “Evaluation data” in the table. If you are asking “why three evaluation datasets?”, the authors provide some detail:</p>
<blockquote>
<p>The inclusion of multiple evaluation types is critical because each type of evaluation data has strengths and limitations in evaluating model performance. Field collected stems are the most common evaluation data used in crown detection work due to high confidence that each stem represents a location of a single tree. However, the position of a tree stem can fail to accurately represent the position of the crown as viewed from above due to a combination of spatial errors in alignment with the image data and the tendency for trees to grow at acute angles (tree lean is not measured in the NEON data), such that the center of the crown and position of the stem can be offset by several meters….Image-annotated crowns are relatively easy to scale, allowing the collection of data for a wide range of forest types and for annotation of every visible crown in the image. Using image-annotated crowns supports the evaluation of methods across a broad range of forest types and allows both recall and precision to be calculated. However, since these annotations are not generated by an observer in the field there can be errors due to interpreting the images. This problem is solved using field-annotated crowns in which an observer annotates the remote-sensing imagery on a tablet while in the field [33]. The main limitation to this approach is that it is labor intensive, meaning that only a relatively small amount of validation data can be collected, making it difficult to obtain a large number of crowns across broad scales or assess model precision. Given the tradeoffs in each evaluation type, providing multiple criteria is a useful way of balancing the need for broad scale model verification with rigorous evaluation of field-based measurements. (p. 14-15)</p>
</blockquote>
<p>To evaluate the performance of our aerial point cloud-based algorithm for 1) tree detection and 2) crown delineation using <code>NeonTreeEvaluation</code> we need to ensure our tree polygon data is formatted properly:</p>
<blockquote>
<p>This package takes a standard submission format of predicted crowns in either bounding box or polygons as input and returns the evaluation scores of the detections for each of the three evaluation datasets. This reproducible workflow will facilitate creating a transparent process for future comparisons among crown detection algorithms. (p. 14)</p>
</blockquote>
<p>The authors describe the “standard submission format” on the <a href="https://github.com/weecology/NeonTreeEvaluation_package">package GitHub</a>:</p>
<blockquote>
<p>Each row contains information for one predicted bounding box. The plot_name should be named the same as the files in the dataset without extension (e.g. SJER_021_2018 not SJER_021_2018.tif) and not the full path to the file on disk. Not all evaluation data are available for all plots. Functions like <code>evaluate_field_crowns</code> and <code>evaluate_image_crowns</code> will look for matching plot name and ignore other plots. Depending on the speed of the algorithm, the simplest thing to do is predict all images in the RGB folder (see list_rgb()) and the package will handle matching images with the correct data to the correct evaluation procedure…Instead of bounding boxes, some methods may return polygons. To submit as polygons, create a single unprojected shapefile with polygons in image coordinates. Polygons must be complete with no holes. Here is an example of the above csv file in polygon format. Here the xmin, xmax, etc. columns are ignored since the information is stored in the geometry data.</p>
</blockquote>
<div class="sourceCode" id="cb183"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb183-1"><a href="validate-tree-detection-and-crown-delineation.html#cb183-1" tabindex="-1"></a>Simple feature collection with <span class="dv">6</span> features and <span class="dv">7</span> fields</span>
<span id="cb183-2"><a href="validate-tree-detection-and-crown-delineation.html#cb183-2" tabindex="-1"></a>geometry type<span class="sc">:</span>  POLYGON</span>
<span id="cb183-3"><a href="validate-tree-detection-and-crown-delineation.html#cb183-3" tabindex="-1"></a>dimension<span class="sc">:</span>      XY</span>
<span id="cb183-4"><a href="validate-tree-detection-and-crown-delineation.html#cb183-4" tabindex="-1"></a>bbox<span class="sc">:</span>           xmin<span class="sc">:</span> <span class="fl">30.39723</span> ymin<span class="sc">:</span> <span class="fl">122.1164</span> xmax<span class="sc">:</span> <span class="fl">397.5746</span> ymax<span class="sc">:</span> <span class="dv">400</span></span>
<span id="cb183-5"><a href="validate-tree-detection-and-crown-delineation.html#cb183-5" tabindex="-1"></a>CRS<span class="sc">:</span>            <span class="cn">NA</span></span>
<span id="cb183-6"><a href="validate-tree-detection-and-crown-delineation.html#cb183-6" tabindex="-1"></a>       xmin     ymin      xmax     ymax     score label     plot_name</span>
<span id="cb183-7"><a href="validate-tree-detection-and-crown-delineation.html#cb183-7" tabindex="-1"></a><span class="dv">1</span>  <span class="fl">41.01716</span> <span class="fl">230.8854</span> <span class="fl">151.08607</span> <span class="fl">342.6985</span> <span class="fl">0.8098674</span>  Tree DSNY_014_2019</span>
<span id="cb183-8"><a href="validate-tree-detection-and-crown-delineation.html#cb183-8" tabindex="-1"></a><span class="dv">2</span> <span class="fl">357.32129</span> <span class="fl">122.1164</span> <span class="fl">397.57458</span> <span class="fl">159.3758</span> <span class="fl">0.6968824</span>  Tree DSNY_014_2019</span>
<span id="cb183-9"><a href="validate-tree-detection-and-crown-delineation.html#cb183-9" tabindex="-1"></a><span class="dv">3</span>  <span class="fl">30.39723</span> <span class="fl">136.9157</span>  <span class="fl">73.79434</span> <span class="fl">184.9473</span> <span class="fl">0.5713338</span>  Tree DSNY_014_2019</span>
<span id="cb183-10"><a href="validate-tree-detection-and-crown-delineation.html#cb183-10" tabindex="-1"></a><span class="dv">4</span> <span class="fl">260.65921</span> <span class="fl">285.6689</span> <span class="fl">299.68811</span> <span class="fl">326.7933</span> <span class="fl">0.5511004</span>  Tree DSNY_014_2019</span>
<span id="cb183-11"><a href="validate-tree-detection-and-crown-delineation.html#cb183-11" tabindex="-1"></a><span class="dv">5</span> <span class="fl">179.34564</span> <span class="fl">371.6130</span> <span class="fl">232.49385</span> <span class="fl">400.0000</span> <span class="fl">0.4697072</span>  Tree DSNY_014_2019</span>
<span id="cb183-12"><a href="validate-tree-detection-and-crown-delineation.html#cb183-12" tabindex="-1"></a><span class="dv">6</span> <span class="fl">316.27377</span> <span class="fl">378.9802</span> <span class="fl">363.67542</span> <span class="fl">400.0000</span> <span class="fl">0.3259409</span>  Tree DSNY_014_2019</span>
<span id="cb183-13"><a href="validate-tree-detection-and-crown-delineation.html#cb183-13" tabindex="-1"></a>                     st_sfc.lst.</span>
<span id="cb183-14"><a href="validate-tree-detection-and-crown-delineation.html#cb183-14" tabindex="-1"></a><span class="dv">1</span> <span class="fu">POLYGON</span> ((<span class="fl">41.01716</span> <span class="dv">230</span>.<span class="dv">8854</span>...</span>
<span id="cb183-15"><a href="validate-tree-detection-and-crown-delineation.html#cb183-15" tabindex="-1"></a><span class="dv">2</span> <span class="fu">POLYGON</span> ((<span class="fl">357.3213</span> <span class="dv">122</span>.<span class="dv">1164</span>...</span>
<span id="cb183-16"><a href="validate-tree-detection-and-crown-delineation.html#cb183-16" tabindex="-1"></a><span class="dv">3</span> <span class="fu">POLYGON</span> ((<span class="fl">30.39723</span> <span class="dv">136</span>.<span class="dv">9157</span>...</span>
<span id="cb183-17"><a href="validate-tree-detection-and-crown-delineation.html#cb183-17" tabindex="-1"></a><span class="dv">4</span> <span class="fu">POLYGON</span> ((<span class="fl">260.6592</span> <span class="dv">285</span>.<span class="dv">6689</span>...</span>
<span id="cb183-18"><a href="validate-tree-detection-and-crown-delineation.html#cb183-18" tabindex="-1"></a><span class="dv">5</span> <span class="fu">POLYGON</span> ((<span class="fl">179.3456</span> <span class="fl">371.613</span>,...</span>
<span id="cb183-19"><a href="validate-tree-detection-and-crown-delineation.html#cb183-19" tabindex="-1"></a><span class="dv">6</span> <span class="fu">POLYGON</span> ((<span class="fl">316.2738</span> <span class="dv">378</span>.<span class="dv">9802</span>...</span></code></pre></div>
<p>So we are going to: run <code>cloud2trees::cloud2trees()</code> on all of the lidar data for which there is evaluation (i.e. ground truth) data, combine into a single tree list with a row unique by a detected tree and the <code>plot_name</code> column (e.g. “SJER_021_2018”), as an unprojected <code>sf</code> data with polygons in image coordinates. We may need to run <code>cloud2trees::simplify_multipolygon_crowns()</code> prior to submission.</p>
<div id="lidar-data-in-neontreeevaluation" class="section level3 hasAnchor" number="4.2.1">
<h3><span class="header-section-number">4.2.1</span> lidar data in <code id="neon_lidar">NeonTreeEvaluation</code><a href="validate-tree-detection-and-crown-delineation.html#lidar-data-in-neontreeevaluation" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>we first have to download evaluation data from the Zenodo archive (1GB), use the <code>NeonTreeEvaluation::download()</code> function to place the data in the correct package location. Download the much larger training data, set <code>training=TRUE</code>. We are going to use the training data to determine the “best” ITD window function to use for a given NEON site since the <code>cloud2trees</code> package <a href="https://github.com/georgewoolsey/cloud2trees?tab=readme-ov-file#individual-tree-detection-itd-tuning">strongly recommends</a> that “a different window size function is defined for each region of your study area with significantly different forest structure”.</p>
<p>Weinstein et al. (<a href="https://scholar.google.com/scholar?cluster=4986448711981898434&amp;hl=en&amp;as_sdt=0,6">2021</a>) describe the training data:</p>
<blockquote>
<p>During our research on canopy crown detection algorithms, we annotated many geographic tiles separate from the evaluation data. The training sites were selected to capture a range of forest conditions…The training tiles were chosen at random from the NEON data portal, with the requirement that they did not contain a large amount of missing data and they did not overlap with any evaluation plots. Depending on the tree density at the site, we either annotated the entire 1 km2 tile or cropped it to a smaller size to create more tractable sizes for annotation. This data is released alongside the benchmark dataset; however, our goal is to promote the best possible crown-delineation algorithm regardless of training data, and it is not necessary to use this training data to generate predictions. Given the large size of training tiles, the training annotations were less thoroughly reviewed and were only based on the RGB imagery. (p. 11)</p>
</blockquote>
<p><em>Note: the current version of <code>NeonTreeEvaluation::download()</code> does not download the training data even if setting <code>training = T</code>. I dug around and found the archive of the training data at <a href="https://zenodo.org/records/5914554">https://zenodo.org/records/5914554</a>. I’ll need to circle back with a GitHub pull request to fix the <code>NeonTreeEvaluation::download()</code> function so that it gets the training data which is hosted at the link mentioned previously and does not reside at where the function currently points to (<a href="https://zenodo.org/records/4770593">https://zenodo.org/records/4770593</a>). I also manually copied the files in “NeonTreeEvaluation/extdata/NeonTreeEvaluation/training/RGB” to “NeonTreeEvaluation/extdata/NeonTreeEvaluation/evaluation/RGB” so that evaluation could be performed. See <code>list.dirs(system.file(package = "NeonTreeEvaluation"),recursive=T)</code></em></p>
<div class="sourceCode" id="cb184"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb184-1"><a href="validate-tree-detection-and-crown-delineation.html#cb184-1" tabindex="-1"></a>NeonTreeEvaluation<span class="sc">::</span><span class="fu">download</span>(<span class="at">training =</span> T, <span class="at">force =</span> F)</span></code></pre></div>
<div id="training-data" class="section level4 hasAnchor" number="4.2.1.1">
<h4><span class="header-section-number">4.2.1.1</span> Training data<a href="validate-tree-detection-and-crown-delineation.html#training-data" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Let’s find what <em>training</em> data is available. We’ll use this data to determine the best window size function for use in our individual tree detection (ITD) process</p>
<div class="sourceCode" id="cb185"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb185-1"><a href="validate-tree-detection-and-crown-delineation.html#cb185-1" tabindex="-1"></a><span class="co"># i did some digging around and the TRAINING lidar data is here</span></span>
<span id="cb185-2"><a href="validate-tree-detection-and-crown-delineation.html#cb185-2" tabindex="-1"></a>training_dir_temp <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="at">package =</span> <span class="st">&quot;NeonTreeEvaluation&quot;</span>, <span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;NeonTreeEvaluation&quot;</span>, <span class="st">&quot;training&quot;</span>, <span class="st">&quot;LiDAR&quot;</span>)</span>
<span id="cb185-3"><a href="validate-tree-detection-and-crown-delineation.html#cb185-3" tabindex="-1"></a><span class="co"># files</span></span>
<span id="cb185-4"><a href="validate-tree-detection-and-crown-delineation.html#cb185-4" tabindex="-1"></a>training_files_temp <span class="ot">&lt;-</span> training_dir_temp <span class="sc">%&gt;%</span> <span class="fu">list.files</span>(<span class="at">recursive =</span> T, <span class="at">pattern =</span> <span class="st">&quot;.*</span><span class="sc">\\</span><span class="st">.(laz|las)$&quot;</span>, <span class="at">full.names =</span> T) <span class="sc">%&gt;%</span> <span class="fu">unique</span>()</span></code></pre></div>
<p>let’s pull out all NEON sites with point cloud data and create a data frame for tracking purposes</p>
<div class="sourceCode" id="cb186"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb186-1"><a href="validate-tree-detection-and-crown-delineation.html#cb186-1" tabindex="-1"></a><span class="co"># let&#39;s pull out all sites with `.laz` data and create a data frame for tracking purposes</span></span>
<span id="cb186-2"><a href="validate-tree-detection-and-crown-delineation.html#cb186-2" tabindex="-1"></a>lidar_df <span class="ot">&lt;-</span> training_files_temp <span class="sc">%&gt;%</span> </span>
<span id="cb186-3"><a href="validate-tree-detection-and-crown-delineation.html#cb186-3" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb186-4"><a href="validate-tree-detection-and-crown-delineation.html#cb186-4" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">f_path =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb186-5"><a href="validate-tree-detection-and-crown-delineation.html#cb186-5" tabindex="-1"></a>    <span class="co"># create some other variables</span></span>
<span id="cb186-6"><a href="validate-tree-detection-and-crown-delineation.html#cb186-6" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb186-7"><a href="validate-tree-detection-and-crown-delineation.html#cb186-7" tabindex="-1"></a>      <span class="at">plot_name =</span> f_path <span class="sc">%&gt;%</span> <span class="fu">basename</span>() <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(<span class="st">&quot;</span><span class="sc">\\</span><span class="st">.(laz|las)$&quot;</span>)</span>
<span id="cb186-8"><a href="validate-tree-detection-and-crown-delineation.html#cb186-8" tabindex="-1"></a>      , <span class="at">data_type =</span> <span class="st">&quot;training&quot;</span></span>
<span id="cb186-9"><a href="validate-tree-detection-and-crown-delineation.html#cb186-9" tabindex="-1"></a>    )</span>
<span id="cb186-10"><a href="validate-tree-detection-and-crown-delineation.html#cb186-10" tabindex="-1"></a><span class="co"># what?</span></span>
<span id="cb186-11"><a href="validate-tree-detection-and-crown-delineation.html#cb186-11" tabindex="-1"></a>lidar_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 16
## Columns: 3
## $ f_path    &lt;chr&gt; &quot;C:/Program Files/R/R-4.3.0/library/NeonTreeEvaluation/extda…
## $ plot_name &lt;chr&gt; &quot;2018_BART_4_322000_4882000_image_crop&quot;, &quot;2018_HARV_5_733000…
## $ data_type &lt;chr&gt; &quot;training&quot;, &quot;training&quot;, &quot;training&quot;, &quot;training&quot;, &quot;training&quot;, …</code></pre>
</div>
<div id="evaluation-data" class="section level4 hasAnchor" number="4.2.1.2">
<h4><span class="header-section-number">4.2.1.2</span> Evaluation data<a href="validate-tree-detection-and-crown-delineation.html#evaluation-data" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Let’s find what <em>evaluation</em> data is available. We’ll use this data to evaluate our point cloud-based tree detection methodology.</p>
<div class="sourceCode" id="cb188"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb188-1"><a href="validate-tree-detection-and-crown-delineation.html#cb188-1" tabindex="-1"></a><span class="co"># i did some digging around and the EVALUATION lidar data is here</span></span>
<span id="cb188-2"><a href="validate-tree-detection-and-crown-delineation.html#cb188-2" tabindex="-1"></a>eval_dir_temp <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="at">package =</span> <span class="st">&quot;NeonTreeEvaluation&quot;</span>, <span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;NeonTreeEvaluation&quot;</span>, <span class="st">&quot;evaluation&quot;</span>, <span class="st">&quot;LiDAR&quot;</span>)</span>
<span id="cb188-3"><a href="validate-tree-detection-and-crown-delineation.html#cb188-3" tabindex="-1"></a><span class="co"># files</span></span>
<span id="cb188-4"><a href="validate-tree-detection-and-crown-delineation.html#cb188-4" tabindex="-1"></a>eval_files_temp <span class="ot">&lt;-</span> eval_dir_temp <span class="sc">%&gt;%</span> <span class="fu">list.files</span>(<span class="at">recursive =</span> T, <span class="at">pattern =</span> <span class="st">&quot;.*</span><span class="sc">\\</span><span class="st">.(laz|las)$&quot;</span>, <span class="at">full.names =</span> T) <span class="sc">%&gt;%</span> <span class="fu">unique</span>()</span></code></pre></div>
<p>bind the rows onto our tracking data</p>
<div class="sourceCode" id="cb189"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb189-1"><a href="validate-tree-detection-and-crown-delineation.html#cb189-1" tabindex="-1"></a>lidar_df <span class="ot">&lt;-</span> lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb189-2"><a href="validate-tree-detection-and-crown-delineation.html#cb189-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb189-3"><a href="validate-tree-detection-and-crown-delineation.html#cb189-3" tabindex="-1"></a>    eval_files_temp <span class="sc">%&gt;%</span> </span>
<span id="cb189-4"><a href="validate-tree-detection-and-crown-delineation.html#cb189-4" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb189-5"><a href="validate-tree-detection-and-crown-delineation.html#cb189-5" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">f_path =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb189-6"><a href="validate-tree-detection-and-crown-delineation.html#cb189-6" tabindex="-1"></a>    <span class="co"># create some other variables</span></span>
<span id="cb189-7"><a href="validate-tree-detection-and-crown-delineation.html#cb189-7" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb189-8"><a href="validate-tree-detection-and-crown-delineation.html#cb189-8" tabindex="-1"></a>      <span class="at">plot_name =</span> f_path <span class="sc">%&gt;%</span> <span class="fu">basename</span>() <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(<span class="st">&quot;</span><span class="sc">\\</span><span class="st">.(laz|las)$&quot;</span>)</span>
<span id="cb189-9"><a href="validate-tree-detection-and-crown-delineation.html#cb189-9" tabindex="-1"></a>      , <span class="at">data_type =</span> <span class="st">&quot;evaluation&quot;</span></span>
<span id="cb189-10"><a href="validate-tree-detection-and-crown-delineation.html#cb189-10" tabindex="-1"></a>    )</span>
<span id="cb189-11"><a href="validate-tree-detection-and-crown-delineation.html#cb189-11" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb189-12"><a href="validate-tree-detection-and-crown-delineation.html#cb189-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">data_type =</span> <span class="fu">as.factor</span>(data_type))</span></code></pre></div>
</div>
<div id="filter-for-ground-truth-data" class="section level4 hasAnchor" number="4.2.1.3">
<h4><span class="header-section-number">4.2.1.3</span> Filter for ground truth data<a href="validate-tree-detection-and-crown-delineation.html#filter-for-ground-truth-data" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>that’s a lot of files…let’s only process the sites with evaluation data or image annotated crowns classified as training annotations</p>
<div class="sourceCode" id="cb190"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb190-1"><a href="validate-tree-detection-and-crown-delineation.html#cb190-1" tabindex="-1"></a><span class="co"># there are functions to get a list of all evaluation data</span></span>
<span id="cb190-2"><a href="validate-tree-detection-and-crown-delineation.html#cb190-2" tabindex="-1"></a><span class="co"># let&#39;s use these to filter our lidar files</span></span>
<span id="cb190-3"><a href="validate-tree-detection-and-crown-delineation.html#cb190-3" tabindex="-1"></a>plotnames_temp <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb190-4"><a href="validate-tree-detection-and-crown-delineation.html#cb190-4" tabindex="-1"></a>    NeonTreeEvaluation<span class="sc">::</span><span class="fu">list_annotations</span>()</span>
<span id="cb190-5"><a href="validate-tree-detection-and-crown-delineation.html#cb190-5" tabindex="-1"></a>    , NeonTreeEvaluation<span class="sc">::</span><span class="fu">list_field_stems</span>()</span>
<span id="cb190-6"><a href="validate-tree-detection-and-crown-delineation.html#cb190-6" tabindex="-1"></a>    <span class="co"># this one includes file paths, so we have to clean</span></span>
<span id="cb190-7"><a href="validate-tree-detection-and-crown-delineation.html#cb190-7" tabindex="-1"></a>    , NeonTreeEvaluation<span class="sc">::</span><span class="fu">list_field_crowns</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb190-8"><a href="validate-tree-detection-and-crown-delineation.html#cb190-8" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_match</span>(<span class="at">pattern=</span><span class="st">&quot;(</span><span class="sc">\\</span><span class="st">w+).tif&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb190-9"><a href="validate-tree-detection-and-crown-delineation.html#cb190-9" tabindex="-1"></a>      .[,<span class="dv">2</span>]</span>
<span id="cb190-10"><a href="validate-tree-detection-and-crown-delineation.html#cb190-10" tabindex="-1"></a>    <span class="co"># there are plot_names from the submission data too</span></span>
<span id="cb190-11"><a href="validate-tree-detection-and-crown-delineation.html#cb190-11" tabindex="-1"></a>    , NeonTreeEvaluation<span class="sc">::</span>submission_polygons<span class="sc">$</span>plot_name <span class="sc">%&gt;%</span> <span class="fu">unique</span>()</span>
<span id="cb190-12"><a href="validate-tree-detection-and-crown-delineation.html#cb190-12" tabindex="-1"></a>    , NeonTreeEvaluation<span class="sc">::</span>submission<span class="sc">$</span>plot_name <span class="sc">%&gt;%</span> <span class="fu">unique</span>()</span>
<span id="cb190-13"><a href="validate-tree-detection-and-crown-delineation.html#cb190-13" tabindex="-1"></a>    <span class="co"># make sure we have all image annotated crowns</span></span>
<span id="cb190-14"><a href="validate-tree-detection-and-crown-delineation.html#cb190-14" tabindex="-1"></a>    , <span class="fu">system.file</span>(<span class="at">package =</span> <span class="st">&quot;NeonTreeEvaluation&quot;</span>, <span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;NeonTreeEvaluation&quot;</span>, <span class="st">&quot;annotations&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb190-15"><a href="validate-tree-detection-and-crown-delineation.html#cb190-15" tabindex="-1"></a>      <span class="fu">list.files</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb190-16"><a href="validate-tree-detection-and-crown-delineation.html#cb190-16" tabindex="-1"></a>      <span class="fu">basename</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb190-17"><a href="validate-tree-detection-and-crown-delineation.html#cb190-17" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(<span class="st">&quot;</span><span class="sc">\\</span><span class="st">.(xml)$&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb190-18"><a href="validate-tree-detection-and-crown-delineation.html#cb190-18" tabindex="-1"></a>      <span class="fu">unique</span>()</span>
<span id="cb190-19"><a href="validate-tree-detection-and-crown-delineation.html#cb190-19" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb190-20"><a href="validate-tree-detection-and-crown-delineation.html#cb190-20" tabindex="-1"></a>  <span class="fu">unique</span>()</span>
<span id="cb190-21"><a href="validate-tree-detection-and-crown-delineation.html#cb190-21" tabindex="-1"></a><span class="co"># huh?</span></span>
<span id="cb190-22"><a href="validate-tree-detection-and-crown-delineation.html#cb190-22" tabindex="-1"></a><span class="co"># plotnames_temp %&gt;% sample(11) %&gt;% sort()</span></span></code></pre></div>
<p>The field collected stem validation data will take a bit more to get the actual plots for which there is validation data. We have to pull <code>clean_field_data()</code> from <a href="https://github.com/weecology/NeonTreeEvaluation_package/blob/724bdb0a9a3ea6433450f62c69a8fadce9ccdb66/R/evaluate_field_stems.R"><code>NeonTreeEvaluation</code></a> as an internal function which is used to filter <code>NeonTreeEvaluation::field</code>…we’ll than match other filters used in <code>NeonTreeEvaluation::evaluate_field_stems()</code></p>
<div class="sourceCode" id="cb191"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb191-1"><a href="validate-tree-detection-and-crown-delineation.html#cb191-1" tabindex="-1"></a><span class="co"># this is an internal function from `NeonTreeEvaluation::evaluate_field_stems()`</span></span>
<span id="cb191-2"><a href="validate-tree-detection-and-crown-delineation.html#cb191-2" tabindex="-1"></a>clean_field_data<span class="ot">&lt;-</span><span class="cf">function</span>(field){</span>
<span id="cb191-3"><a href="validate-tree-detection-and-crown-delineation.html#cb191-3" tabindex="-1"></a>  field<span class="sc">$</span>area<span class="ot">&lt;-</span>field<span class="sc">$</span>maxCrownDiameter<span class="sc">*</span>field<span class="sc">$</span>ninetyCrownDiameter</span>
<span id="cb191-4"><a href="validate-tree-detection-and-crown-delineation.html#cb191-4" tabindex="-1"></a>  field<span class="ot">&lt;-</span>field <span class="sc">%&gt;%</span>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(itcEasting),<span class="sc">!</span>stringr<span class="sc">::</span><span class="fu">str_detect</span>(eventID,<span class="st">&quot;2014&quot;</span>),growthForm <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;single bole tree&quot;</span>,<span class="st">&quot;multi-bole tree&quot;</span>,<span class="st">&quot;small tree&quot;</span>,<span class="st">&quot;sapling&quot;</span>),stemDiameter<span class="sc">&gt;</span><span class="dv">15</span>) <span class="sc">%&gt;%</span></span>
<span id="cb191-5"><a href="validate-tree-detection-and-crown-delineation.html#cb191-5" tabindex="-1"></a>    <span class="fu">droplevels</span>() <span class="sc">%&gt;%</span></span>
<span id="cb191-6"><a href="validate-tree-detection-and-crown-delineation.html#cb191-6" tabindex="-1"></a>    <span class="fu">filter</span>(height<span class="sc">&gt;</span><span class="dv">3</span><span class="sc">|</span><span class="fu">is.na</span>(height))</span>
<span id="cb191-7"><a href="validate-tree-detection-and-crown-delineation.html#cb191-7" tabindex="-1"></a></span>
<span id="cb191-8"><a href="validate-tree-detection-and-crown-delineation.html#cb191-8" tabindex="-1"></a>  <span class="co">#Limit difference in heights</span></span>
<span id="cb191-9"><a href="validate-tree-detection-and-crown-delineation.html#cb191-9" tabindex="-1"></a>  to_remove<span class="ot">&lt;-</span>field <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(individualID) <span class="sc">%&gt;%</span></span>
<span id="cb191-10"><a href="validate-tree-detection-and-crown-delineation.html#cb191-10" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">mean=</span><span class="fu">mean</span>(height),<span class="at">sum_difference =</span> <span class="fu">abs</span>(<span class="fu">sum</span>(<span class="fu">diff</span>(height)))) <span class="sc">%&gt;%</span></span>
<span id="cb191-11"><a href="validate-tree-detection-and-crown-delineation.html#cb191-11" tabindex="-1"></a>    <span class="fu">filter</span>(sum_difference <span class="sc">&gt;</span> <span class="dv">8</span>)</span>
<span id="cb191-12"><a href="validate-tree-detection-and-crown-delineation.html#cb191-12" tabindex="-1"></a>  field<span class="ot">&lt;-</span>field <span class="sc">%&gt;%</span></span>
<span id="cb191-13"><a href="validate-tree-detection-and-crown-delineation.html#cb191-13" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span>individualID <span class="sc">%in%</span> to_remove<span class="sc">$</span>individualID)</span>
<span id="cb191-14"><a href="validate-tree-detection-and-crown-delineation.html#cb191-14" tabindex="-1"></a>}</span>
<span id="cb191-15"><a href="validate-tree-detection-and-crown-delineation.html#cb191-15" tabindex="-1"></a><span class="co"># apply all the filters for field collected stems used in `NeonTreeEvaluation::evaluate_field_stems()`</span></span>
<span id="cb191-16"><a href="validate-tree-detection-and-crown-delineation.html#cb191-16" tabindex="-1"></a>field_plots_temp <span class="ot">&lt;-</span> NeonTreeEvaluation<span class="sc">::</span>field <span class="sc">%&gt;%</span> </span>
<span id="cb191-17"><a href="validate-tree-detection-and-crown-delineation.html#cb191-17" tabindex="-1"></a>  <span class="fu">clean_field_data</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb191-18"><a href="validate-tree-detection-and-crown-delineation.html#cb191-18" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(height<span class="sc">&gt;</span><span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb191-19"><a href="validate-tree-detection-and-crown-delineation.html#cb191-19" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(plotID,individualID) <span class="sc">%&gt;%</span></span>
<span id="cb191-20"><a href="validate-tree-detection-and-crown-delineation.html#cb191-20" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">samples=</span><span class="fu">length</span>(<span class="fu">unique</span>(eventID))) <span class="sc">%&gt;%</span></span>
<span id="cb191-21"><a href="validate-tree-detection-and-crown-delineation.html#cb191-21" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(samples<span class="sc">&gt;</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb191-22"><a href="validate-tree-detection-and-crown-delineation.html#cb191-22" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb191-23"><a href="validate-tree-detection-and-crown-delineation.html#cb191-23" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">plotID=</span><span class="fu">as.character</span>(plotID)) <span class="sc">%&gt;%</span> </span>
<span id="cb191-24"><a href="validate-tree-detection-and-crown-delineation.html#cb191-24" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(plotID) <span class="sc">%&gt;%</span> </span>
<span id="cb191-25"><a href="validate-tree-detection-and-crown-delineation.html#cb191-25" tabindex="-1"></a>  <span class="fu">unique</span>()</span>
<span id="cb191-26"><a href="validate-tree-detection-and-crown-delineation.html#cb191-26" tabindex="-1"></a><span class="co"># `NeonTreeEvaluation::evaluate_field_stems()` also requires rgb and chm data</span></span>
<span id="cb191-27"><a href="validate-tree-detection-and-crown-delineation.html#cb191-27" tabindex="-1"></a>chm_temp <span class="ot">&lt;-</span> NeonTreeEvaluation<span class="sc">::</span><span class="fu">list_chm</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb191-28"><a href="validate-tree-detection-and-crown-delineation.html#cb191-28" tabindex="-1"></a>  <span class="fu">basename</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb191-29"><a href="validate-tree-detection-and-crown-delineation.html#cb191-29" tabindex="-1"></a>  stringr<span class="sc">::</span><span class="fu">str_match</span>(<span class="st">&quot;(</span><span class="sc">\\</span><span class="st">w+)_</span><span class="sc">\\</span><span class="st">d+&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb191-30"><a href="validate-tree-detection-and-crown-delineation.html#cb191-30" tabindex="-1"></a>  .[,<span class="dv">2</span>] <span class="sc">%&gt;%</span> </span>
<span id="cb191-31"><a href="validate-tree-detection-and-crown-delineation.html#cb191-31" tabindex="-1"></a>  <span class="fu">unique</span>()</span>
<span id="cb191-32"><a href="validate-tree-detection-and-crown-delineation.html#cb191-32" tabindex="-1"></a>field_plots_temp <span class="ot">&lt;-</span> field_plots_temp[field_plots_temp <span class="sc">%in%</span> chm_temp]</span>
<span id="cb191-33"><a href="validate-tree-detection-and-crown-delineation.html#cb191-33" tabindex="-1"></a>rgb_temp <span class="ot">&lt;-</span> NeonTreeEvaluation<span class="sc">::</span><span class="fu">list_rgb</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb191-34"><a href="validate-tree-detection-and-crown-delineation.html#cb191-34" tabindex="-1"></a>  <span class="fu">basename</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb191-35"><a href="validate-tree-detection-and-crown-delineation.html#cb191-35" tabindex="-1"></a>  stringr<span class="sc">::</span><span class="fu">str_match</span>(<span class="st">&quot;(</span><span class="sc">\\</span><span class="st">w+)_</span><span class="sc">\\</span><span class="st">d+&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb191-36"><a href="validate-tree-detection-and-crown-delineation.html#cb191-36" tabindex="-1"></a>  .[,<span class="dv">2</span>] <span class="sc">%&gt;%</span> </span>
<span id="cb191-37"><a href="validate-tree-detection-and-crown-delineation.html#cb191-37" tabindex="-1"></a>  <span class="fu">unique</span>()</span>
<span id="cb191-38"><a href="validate-tree-detection-and-crown-delineation.html#cb191-38" tabindex="-1"></a>field_plots_temp <span class="ot">&lt;-</span> field_plots_temp[field_plots_temp <span class="sc">%in%</span> rgb_temp]</span></code></pre></div>
<p>filter our lidar data list to keep only point clouds in plots for which there is validation data</p>
<div class="sourceCode" id="cb192"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb192-1"><a href="validate-tree-detection-and-crown-delineation.html#cb192-1" tabindex="-1"></a>lidar_df <span class="ot">&lt;-</span></span>
<span id="cb192-2"><a href="validate-tree-detection-and-crown-delineation.html#cb192-2" tabindex="-1"></a>  lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb192-3"><a href="validate-tree-detection-and-crown-delineation.html#cb192-3" tabindex="-1"></a>  <span class="co">#filter based on plots in evaluation data</span></span>
<span id="cb192-4"><a href="validate-tree-detection-and-crown-delineation.html#cb192-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(plot_name <span class="sc">%in%</span> plotnames_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb192-5"><a href="validate-tree-detection-and-crown-delineation.html#cb192-5" tabindex="-1"></a>  <span class="co"># filter for field plots</span></span>
<span id="cb192-6"><a href="validate-tree-detection-and-crown-delineation.html#cb192-6" tabindex="-1"></a>  <span class="co"># pull out site </span></span>
<span id="cb192-7"><a href="validate-tree-detection-and-crown-delineation.html#cb192-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb192-8"><a href="validate-tree-detection-and-crown-delineation.html#cb192-8" tabindex="-1"></a>    <span class="at">plot_temp =</span> stringr<span class="sc">::</span><span class="fu">str_extract</span>(</span>
<span id="cb192-9"><a href="validate-tree-detection-and-crown-delineation.html#cb192-9" tabindex="-1"></a>      <span class="at">string =</span> plot_name</span>
<span id="cb192-10"><a href="validate-tree-detection-and-crown-delineation.html#cb192-10" tabindex="-1"></a>      , <span class="at">pattern =</span> field_plots_temp <span class="sc">%&gt;%</span></span>
<span id="cb192-11"><a href="validate-tree-detection-and-crown-delineation.html#cb192-11" tabindex="-1"></a>        <span class="fu">unique</span>() <span class="sc">%&gt;%</span></span>
<span id="cb192-12"><a href="validate-tree-detection-and-crown-delineation.html#cb192-12" tabindex="-1"></a>        <span class="fu">toupper</span>() <span class="sc">%&gt;%</span></span>
<span id="cb192-13"><a href="validate-tree-detection-and-crown-delineation.html#cb192-13" tabindex="-1"></a>        <span class="fu">paste</span>(<span class="at">collapse =</span> <span class="st">&quot;|&quot;</span>)</span>
<span id="cb192-14"><a href="validate-tree-detection-and-crown-delineation.html#cb192-14" tabindex="-1"></a>    )</span>
<span id="cb192-15"><a href="validate-tree-detection-and-crown-delineation.html#cb192-15" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb192-16"><a href="validate-tree-detection-and-crown-delineation.html#cb192-16" tabindex="-1"></a>  <span class="co"># flag the data with image annotated crowns or field stems which we&#39;ll use to train our ws fn</span></span>
<span id="cb192-17"><a href="validate-tree-detection-and-crown-delineation.html#cb192-17" tabindex="-1"></a>  <span class="co"># if this doesn&#39;t make sense yet, keep reading down</span></span>
<span id="cb192-18"><a href="validate-tree-detection-and-crown-delineation.html#cb192-18" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb192-19"><a href="validate-tree-detection-and-crown-delineation.html#cb192-19" tabindex="-1"></a>    <span class="at">has_image_annotation =</span> plot_name <span class="sc">%in%</span> NeonTreeEvaluation<span class="sc">::</span><span class="fu">list_annotations</span>()</span>
<span id="cb192-20"><a href="validate-tree-detection-and-crown-delineation.html#cb192-20" tabindex="-1"></a>    , <span class="at">has_field_stems =</span> <span class="sc">!</span><span class="fu">is.na</span>(plot_temp)</span>
<span id="cb192-21"><a href="validate-tree-detection-and-crown-delineation.html#cb192-21" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb192-22"><a href="validate-tree-detection-and-crown-delineation.html#cb192-22" tabindex="-1"></a>  <span class="co"># keep only those with field stems or image annotated crowns</span></span>
<span id="cb192-23"><a href="validate-tree-detection-and-crown-delineation.html#cb192-23" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(has_image_annotation <span class="sc">|</span> has_field_stems) <span class="sc">%&gt;%</span> </span>
<span id="cb192-24"><a href="validate-tree-detection-and-crown-delineation.html#cb192-24" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(plot_temp))</span></code></pre></div>
<p>We need to put the NEON site identifier in our data. We’ll use the field-collected tree data from NEON sites made available which will also serve to filter our point cloud list for forested NEON sites only.</p>
<div class="sourceCode" id="cb193"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb193-1"><a href="validate-tree-detection-and-crown-delineation.html#cb193-1" tabindex="-1"></a><span class="co"># get a list of siteID</span></span>
<span id="cb193-2"><a href="validate-tree-detection-and-crown-delineation.html#cb193-2" tabindex="-1"></a>neon_sites_temp <span class="ot">&lt;-</span></span>
<span id="cb193-3"><a href="validate-tree-detection-and-crown-delineation.html#cb193-3" tabindex="-1"></a>  NeonTreeEvaluation<span class="sc">::</span>field <span class="sc">%&gt;%</span> </span>
<span id="cb193-4"><a href="validate-tree-detection-and-crown-delineation.html#cb193-4" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb193-5"><a href="validate-tree-detection-and-crown-delineation.html#cb193-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">distinct</span>(siteID) <span class="sc">%&gt;%</span> </span>
<span id="cb193-6"><a href="validate-tree-detection-and-crown-delineation.html#cb193-6" tabindex="-1"></a>  <span class="co"># there are siteID&#39;s here too</span></span>
<span id="cb193-7"><a href="validate-tree-detection-and-crown-delineation.html#cb193-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb193-8"><a href="validate-tree-detection-and-crown-delineation.html#cb193-8" tabindex="-1"></a>    NeonTreeEvaluation<span class="sc">::</span>crown_polygons <span class="sc">%&gt;%</span> </span>
<span id="cb193-9"><a href="validate-tree-detection-and-crown-delineation.html#cb193-9" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb193-10"><a href="validate-tree-detection-and-crown-delineation.html#cb193-10" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">distinct</span>(siteID)</span>
<span id="cb193-11"><a href="validate-tree-detection-and-crown-delineation.html#cb193-11" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb193-12"><a href="validate-tree-detection-and-crown-delineation.html#cb193-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">siteID =</span> <span class="fu">as.character</span>(siteID)) <span class="sc">%&gt;%</span> </span>
<span id="cb193-13"><a href="validate-tree-detection-and-crown-delineation.html#cb193-13" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">distinct</span>(siteID) <span class="sc">%&gt;%</span> </span>
<span id="cb193-14"><a href="validate-tree-detection-and-crown-delineation.html#cb193-14" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(siteID)</span>
<span id="cb193-15"><a href="validate-tree-detection-and-crown-delineation.html#cb193-15" tabindex="-1"></a><span class="co"># extract the siteID from the plot_name</span></span>
<span id="cb193-16"><a href="validate-tree-detection-and-crown-delineation.html#cb193-16" tabindex="-1"></a>lidar_df <span class="ot">&lt;-</span> lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb193-17"><a href="validate-tree-detection-and-crown-delineation.html#cb193-17" tabindex="-1"></a>  <span class="co"># pull out site </span></span>
<span id="cb193-18"><a href="validate-tree-detection-and-crown-delineation.html#cb193-18" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb193-19"><a href="validate-tree-detection-and-crown-delineation.html#cb193-19" tabindex="-1"></a>    <span class="at">siteID =</span> stringr<span class="sc">::</span><span class="fu">str_extract</span>(</span>
<span id="cb193-20"><a href="validate-tree-detection-and-crown-delineation.html#cb193-20" tabindex="-1"></a>      <span class="at">string =</span> plot_name</span>
<span id="cb193-21"><a href="validate-tree-detection-and-crown-delineation.html#cb193-21" tabindex="-1"></a>      , <span class="at">pattern =</span> neon_sites_temp <span class="sc">%&gt;%</span></span>
<span id="cb193-22"><a href="validate-tree-detection-and-crown-delineation.html#cb193-22" tabindex="-1"></a>        <span class="fu">unique</span>() <span class="sc">%&gt;%</span></span>
<span id="cb193-23"><a href="validate-tree-detection-and-crown-delineation.html#cb193-23" tabindex="-1"></a>        <span class="fu">toupper</span>() <span class="sc">%&gt;%</span></span>
<span id="cb193-24"><a href="validate-tree-detection-and-crown-delineation.html#cb193-24" tabindex="-1"></a>        <span class="fu">paste</span>(<span class="at">collapse =</span> <span class="st">&quot;|&quot;</span>)</span>
<span id="cb193-25"><a href="validate-tree-detection-and-crown-delineation.html#cb193-25" tabindex="-1"></a>    )</span>
<span id="cb193-26"><a href="validate-tree-detection-and-crown-delineation.html#cb193-26" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb193-27"><a href="validate-tree-detection-and-crown-delineation.html#cb193-27" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(siteID))</span></code></pre></div>
<p>what is the breakdown of training vs eval?</p>
<div class="sourceCode" id="cb194"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb194-1"><a href="validate-tree-detection-and-crown-delineation.html#cb194-1" tabindex="-1"></a>lidar_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">count</span>(data_type)</span></code></pre></div>
<pre><code>## # A tibble: 2 × 2
##   data_type      n
##   &lt;fct&gt;      &lt;int&gt;
## 1 evaluation   522
## 2 training      15</code></pre>
</div>
<div id="filter-for-conifer-sites" class="section level4 hasAnchor" number="4.2.1.4">
<h4><span class="header-section-number">4.2.1.4</span> Filter for conifer sites<a href="validate-tree-detection-and-crown-delineation.html#filter-for-conifer-sites" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>we will want to limit our evaluation to only sites with conifer trees since <code>cloud2trees</code> implements methods developed specifically to quantify conifer forest structure that may not be appropriate for other forest types</p>
<p>we’ll use the field data in the package to look for NEON sites with conifer trees. We’ll use the NEON plant list to identify conifer species: <a href="https://data.neonscience.org/taxonomic-lists?taxonTypeCode=PLANT">https://data.neonscience.org/taxonomic-lists?taxonTypeCode=PLANT</a> (click “DOWNLOAD TAXONOMIC LIST”). We’ll filter for species belonging to Class Pinopsida.</p>
<div class="sourceCode" id="cb196"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb196-1"><a href="validate-tree-detection-and-crown-delineation.html#cb196-1" tabindex="-1"></a>conifer_spp <span class="ot">&lt;-</span></span>
<span id="cb196-2"><a href="validate-tree-detection-and-crown-delineation.html#cb196-2" tabindex="-1"></a>  readr<span class="sc">::</span><span class="fu">read_csv</span>(</span>
<span id="cb196-3"><a href="validate-tree-detection-and-crown-delineation.html#cb196-3" tabindex="-1"></a>    <span class="st">&quot;../data/OS_TAXON_PLANT-20220330T142149.csv&quot;</span></span>
<span id="cb196-4"><a href="validate-tree-detection-and-crown-delineation.html#cb196-4" tabindex="-1"></a>    , <span class="at">show_col_types =</span> F</span>
<span id="cb196-5"><a href="validate-tree-detection-and-crown-delineation.html#cb196-5" tabindex="-1"></a>    , <span class="at">progress =</span> F</span>
<span id="cb196-6"><a href="validate-tree-detection-and-crown-delineation.html#cb196-6" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb196-7"><a href="validate-tree-detection-and-crown-delineation.html#cb196-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb196-8"><a href="validate-tree-detection-and-crown-delineation.html#cb196-8" tabindex="-1"></a>    <span class="fu">tolower</span>(<span class="st">`</span><span class="at">class</span><span class="st">`</span>) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;pinopsida&quot;</span>)</span>
<span id="cb196-9"><a href="validate-tree-detection-and-crown-delineation.html#cb196-9" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb196-10"><a href="validate-tree-detection-and-crown-delineation.html#cb196-10" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb196-11"><a href="validate-tree-detection-and-crown-delineation.html#cb196-11" tabindex="-1"></a>    <span class="at">taxonID =</span> <span class="fu">toupper</span>(taxonID)</span>
<span id="cb196-12"><a href="validate-tree-detection-and-crown-delineation.html#cb196-12" tabindex="-1"></a>    , <span class="at">vernacularName =</span> <span class="fu">tolower</span>(vernacularName)</span>
<span id="cb196-13"><a href="validate-tree-detection-and-crown-delineation.html#cb196-13" tabindex="-1"></a>    , <span class="at">genus =</span> stringr<span class="sc">::</span><span class="fu">str_to_title</span>(genus)</span>
<span id="cb196-14"><a href="validate-tree-detection-and-crown-delineation.html#cb196-14" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb196-15"><a href="validate-tree-detection-and-crown-delineation.html#cb196-15" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">distinct</span>(taxonID, vernacularName, genus)</span></code></pre></div>
<p>what are some of these conifers?</p>
<div class="sourceCode" id="cb197"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb197-1"><a href="validate-tree-detection-and-crown-delineation.html#cb197-1" tabindex="-1"></a><span class="co"># huh?</span></span>
<span id="cb197-2"><a href="validate-tree-detection-and-crown-delineation.html#cb197-2" tabindex="-1"></a>conifer_spp <span class="sc">%&gt;%</span> </span>
<span id="cb197-3"><a href="validate-tree-detection-and-crown-delineation.html#cb197-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb197-4"><a href="validate-tree-detection-and-crown-delineation.html#cb197-4" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(<span class="at">caption =</span> <span class="st">&quot;Conifer species taxonID examples&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb197-5"><a href="validate-tree-detection-and-crown-delineation.html#cb197-5" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>()</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-176">Table 4.1: </span>Conifer species taxonID examples
</caption>
<thead>
<tr>
<th style="text-align:left;">
taxonID
</th>
<th style="text-align:left;">
vernacularName
</th>
<th style="text-align:left;">
genus
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
CAGL23
</td>
<td style="text-align:left;">
white cypress-pine
</td>
<td style="text-align:left;">
Callitris
</td>
</tr>
<tr>
<td style="text-align:left;">
SEQUO2
</td>
<td style="text-align:left;">
giant sequoia
</td>
<td style="text-align:left;">
Sequoiadendron
</td>
</tr>
<tr>
<td style="text-align:left;">
PISY
</td>
<td style="text-align:left;">
scots pine
</td>
<td style="text-align:left;">
Pinus
</td>
</tr>
<tr>
<td style="text-align:left;">
AGATH2
</td>
<td style="text-align:left;">
agathis
</td>
<td style="text-align:left;">
Agathis
</td>
</tr>
<tr>
<td style="text-align:left;">
PILA
</td>
<td style="text-align:left;">
sugar pine
</td>
<td style="text-align:left;">
Pinus
</td>
</tr>
<tr>
<td style="text-align:left;">
CRJA3
</td>
<td style="text-align:left;">
japanese cedar
</td>
<td style="text-align:left;">
Cryptomeria
</td>
</tr>
<tr>
<td style="text-align:left;">
PIGL2
</td>
<td style="text-align:left;">
spruce pine
</td>
<td style="text-align:left;">
Pinus
</td>
</tr>
<tr>
<td style="text-align:left;">
HENE2
</td>
<td style="text-align:left;">
paiute cypress
</td>
<td style="text-align:left;">
Hesperocyparis
</td>
</tr>
<tr>
<td style="text-align:left;">
PICOL
</td>
<td style="text-align:left;">
lodgepole pine
</td>
<td style="text-align:left;">
Pinus
</td>
</tr>
<tr>
<td style="text-align:left;">
PINUSSPP
</td>
<td style="text-align:left;">
pine
</td>
<td style="text-align:left;">
Pinus
</td>
</tr>
</tbody>
</table>
<p>filter for NEON sites that have conifer trees based on field data from all terrestrial NEON sites with qualifying woody vegetation: <a href="https://data.neonscience.org/data-products/DP1.10098.001">https://data.neonscience.org/data-products/DP1.10098.001</a></p>
<div class="sourceCode" id="cb198"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb198-1"><a href="validate-tree-detection-and-crown-delineation.html#cb198-1" tabindex="-1"></a>conifer_sites <span class="ot">&lt;-</span> NeonTreeEvaluation<span class="sc">::</span>field <span class="sc">%&gt;%</span> </span>
<span id="cb198-2"><a href="validate-tree-detection-and-crown-delineation.html#cb198-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb198-3"><a href="validate-tree-detection-and-crown-delineation.html#cb198-3" tabindex="-1"></a>    conifer_spp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">is_conifer =</span> <span class="dv">1</span>)</span>
<span id="cb198-4"><a href="validate-tree-detection-and-crown-delineation.html#cb198-4" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;taxonID&quot;</span></span>
<span id="cb198-5"><a href="validate-tree-detection-and-crown-delineation.html#cb198-5" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb198-6"><a href="validate-tree-detection-and-crown-delineation.html#cb198-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">is_conifer =</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(is_conifer, <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb198-7"><a href="validate-tree-detection-and-crown-delineation.html#cb198-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(siteID) <span class="sc">%&gt;%</span> </span>
<span id="cb198-8"><a href="validate-tree-detection-and-crown-delineation.html#cb198-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb198-9"><a href="validate-tree-detection-and-crown-delineation.html#cb198-9" tabindex="-1"></a>    <span class="at">tot =</span> dplyr<span class="sc">::</span><span class="fu">n</span>()</span>
<span id="cb198-10"><a href="validate-tree-detection-and-crown-delineation.html#cb198-10" tabindex="-1"></a>    , <span class="at">conifer =</span> <span class="fu">sum</span>(is_conifer)</span>
<span id="cb198-11"><a href="validate-tree-detection-and-crown-delineation.html#cb198-11" tabindex="-1"></a>    , <span class="at">latitude =</span> <span class="fu">mean</span>(plotLatitude)</span>
<span id="cb198-12"><a href="validate-tree-detection-and-crown-delineation.html#cb198-12" tabindex="-1"></a>    , <span class="at">longitude =</span> <span class="fu">mean</span>(plotLongitude)</span>
<span id="cb198-13"><a href="validate-tree-detection-and-crown-delineation.html#cb198-13" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb198-14"><a href="validate-tree-detection-and-crown-delineation.html#cb198-14" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb198-15"><a href="validate-tree-detection-and-crown-delineation.html#cb198-15" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pct_conifer =</span> conifer<span class="sc">/</span>tot)</span></code></pre></div>
<p>what is the breakdown of woody vegetation sampled in NEON sites by the percent conifer?</p>
<div class="sourceCode" id="cb199"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb199-1"><a href="validate-tree-detection-and-crown-delineation.html#cb199-1" tabindex="-1"></a>conifer_sites <span class="sc">%&gt;%</span> </span>
<span id="cb199-2"><a href="validate-tree-detection-and-crown-delineation.html#cb199-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(longitude,latitude)) <span class="sc">%&gt;%</span> </span>
<span id="cb199-3"><a href="validate-tree-detection-and-crown-delineation.html#cb199-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(pct_conifer), <span class="fu">desc</span>(tot)) <span class="sc">%&gt;%</span> </span>
<span id="cb199-4"><a href="validate-tree-detection-and-crown-delineation.html#cb199-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">19</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb199-5"><a href="validate-tree-detection-and-crown-delineation.html#cb199-5" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(</span>
<span id="cb199-6"><a href="validate-tree-detection-and-crown-delineation.html#cb199-6" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">&quot;Conifers in NEON sites&quot;</span></span>
<span id="cb199-7"><a href="validate-tree-detection-and-crown-delineation.html#cb199-7" tabindex="-1"></a>    , <span class="at">digits =</span> <span class="dv">2</span></span>
<span id="cb199-8"><a href="validate-tree-detection-and-crown-delineation.html#cb199-8" tabindex="-1"></a>    , <span class="at">col.names =</span> <span class="fu">c</span>(</span>
<span id="cb199-9"><a href="validate-tree-detection-and-crown-delineation.html#cb199-9" tabindex="-1"></a>      <span class="st">&quot;site&quot;</span>,<span class="st">&quot;total trees&quot;</span>,<span class="st">&quot;conifer trees&quot;</span>, <span class="st">&quot;% conifer&quot;</span></span>
<span id="cb199-10"><a href="validate-tree-detection-and-crown-delineation.html#cb199-10" tabindex="-1"></a>    )</span>
<span id="cb199-11"><a href="validate-tree-detection-and-crown-delineation.html#cb199-11" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb199-12"><a href="validate-tree-detection-and-crown-delineation.html#cb199-12" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>()</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-178">Table 4.2: </span>Conifers in NEON sites
</caption>
<thead>
<tr>
<th style="text-align:left;">
site
</th>
<th style="text-align:right;">
total trees
</th>
<th style="text-align:right;">
conifer trees
</th>
<th style="text-align:right;">
% conifer
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
NIWO
</td>
<td style="text-align:right;">
1804
</td>
<td style="text-align:right;">
1804
</td>
<td style="text-align:right;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
ONAQ
</td>
<td style="text-align:right;">
88
</td>
<td style="text-align:right;">
88
</td>
<td style="text-align:right;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
MOAB
</td>
<td style="text-align:right;">
29
</td>
<td style="text-align:right;">
29
</td>
<td style="text-align:right;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
HEAL
</td>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
YELL
</td>
<td style="text-align:right;">
13
</td>
<td style="text-align:right;">
13
</td>
<td style="text-align:right;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
TEAK
</td>
<td style="text-align:right;">
621
</td>
<td style="text-align:right;">
619
</td>
<td style="text-align:right;">
1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
DEJU
</td>
<td style="text-align:right;">
173
</td>
<td style="text-align:right;">
169
</td>
<td style="text-align:right;">
0.98
</td>
</tr>
<tr>
<td style="text-align:left;">
ABBY
</td>
<td style="text-align:right;">
268
</td>
<td style="text-align:right;">
241
</td>
<td style="text-align:right;">
0.90
</td>
</tr>
<tr>
<td style="text-align:left;">
RMNP
</td>
<td style="text-align:right;">
1375
</td>
<td style="text-align:right;">
1083
</td>
<td style="text-align:right;">
0.79
</td>
</tr>
<tr>
<td style="text-align:left;">
SOAP
</td>
<td style="text-align:right;">
503
</td>
<td style="text-align:right;">
389
</td>
<td style="text-align:right;">
0.77
</td>
</tr>
<tr>
<td style="text-align:left;">
DSNY
</td>
<td style="text-align:right;">
34
</td>
<td style="text-align:right;">
26
</td>
<td style="text-align:right;">
0.76
</td>
</tr>
<tr>
<td style="text-align:left;">
TALL
</td>
<td style="text-align:right;">
2144
</td>
<td style="text-align:right;">
1521
</td>
<td style="text-align:right;">
0.71
</td>
</tr>
<tr>
<td style="text-align:left;">
OSBS
</td>
<td style="text-align:right;">
1288
</td>
<td style="text-align:right;">
858
</td>
<td style="text-align:right;">
0.67
</td>
</tr>
<tr>
<td style="text-align:left;">
JERC
</td>
<td style="text-align:right;">
562
</td>
<td style="text-align:right;">
336
</td>
<td style="text-align:right;">
0.60
</td>
</tr>
<tr>
<td style="text-align:left;">
HARV
</td>
<td style="text-align:right;">
3736
</td>
<td style="text-align:right;">
1701
</td>
<td style="text-align:right;">
0.46
</td>
</tr>
<tr>
<td style="text-align:left;">
TREE
</td>
<td style="text-align:right;">
1303
</td>
<td style="text-align:right;">
430
</td>
<td style="text-align:right;">
0.33
</td>
</tr>
<tr>
<td style="text-align:left;">
BART
</td>
<td style="text-align:right;">
3636
</td>
<td style="text-align:right;">
1022
</td>
<td style="text-align:right;">
0.28
</td>
</tr>
<tr>
<td style="text-align:left;">
BONA
</td>
<td style="text-align:right;">
188
</td>
<td style="text-align:right;">
48
</td>
<td style="text-align:right;">
0.26
</td>
</tr>
<tr>
<td style="text-align:left;">
STEI
</td>
<td style="text-align:right;">
754
</td>
<td style="text-align:right;">
151
</td>
<td style="text-align:right;">
0.20
</td>
</tr>
</tbody>
</table>
<p>let’s only keep NEON sites with a minimum threshold of the woody vegetation sampled as conifer</p>
<div class="sourceCode" id="cb200"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb200-1"><a href="validate-tree-detection-and-crown-delineation.html#cb200-1" tabindex="-1"></a><span class="co"># minimum pct conifer</span></span>
<span id="cb200-2"><a href="validate-tree-detection-and-crown-delineation.html#cb200-2" tabindex="-1"></a>min_conifer_pct <span class="ot">&lt;-</span> .<span class="dv">5</span></span></code></pre></div>
<p>now join on our proportion of conifer by NEON site to our lidar data list</p>
<div class="sourceCode" id="cb201"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb201-1"><a href="validate-tree-detection-and-crown-delineation.html#cb201-1" tabindex="-1"></a>lidar_df <span class="ot">&lt;-</span> lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb201-2"><a href="validate-tree-detection-and-crown-delineation.html#cb201-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(conifer_sites, <span class="at">by =</span> <span class="st">&quot;siteID&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb201-3"><a href="validate-tree-detection-and-crown-delineation.html#cb201-3" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;longitude&quot;</span>,<span class="st">&quot;latitude&quot;</span>), <span class="at">crs =</span> <span class="dv">4326</span>, <span class="at">remove =</span> F)</span></code></pre></div>
<p>before we filter for conifer sites only, let’s check which sites we have lidar data from and whether or not they are classified as a conifer site based on this threshold of 50%</p>
<div class="sourceCode" id="cb202"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb202-1"><a href="validate-tree-detection-and-crown-delineation.html#cb202-1" tabindex="-1"></a>lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb202-2"><a href="validate-tree-detection-and-crown-delineation.html#cb202-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(siteID) <span class="sc">%&gt;%</span> </span>
<span id="cb202-3"><a href="validate-tree-detection-and-crown-delineation.html#cb202-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">pct_conifer =</span> dplyr<span class="sc">::</span><span class="fu">first</span>(pct_conifer)) <span class="sc">%&gt;%</span> </span>
<span id="cb202-4"><a href="validate-tree-detection-and-crown-delineation.html#cb202-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb202-5"><a href="validate-tree-detection-and-crown-delineation.html#cb202-5" tabindex="-1"></a>    <span class="at">is_conifer_site =</span> <span class="fu">ifelse</span>(pct_conifer<span class="sc">&gt;</span>min_conifer_pct,<span class="st">&quot;conifer site&quot;</span>,<span class="st">&quot;non-conifer site&quot;</span>)</span>
<span id="cb202-6"><a href="validate-tree-detection-and-crown-delineation.html#cb202-6" tabindex="-1"></a>    , <span class="at">pct_conifer =</span> scales<span class="sc">::</span><span class="fu">percent</span>(pct_conifer,<span class="at">accuracy=</span><span class="fl">0.1</span>)</span>
<span id="cb202-7"><a href="validate-tree-detection-and-crown-delineation.html#cb202-7" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb202-8"><a href="validate-tree-detection-and-crown-delineation.html#cb202-8" tabindex="-1"></a>  mapview<span class="sc">::</span><span class="fu">mapview</span>(</span>
<span id="cb202-9"><a href="validate-tree-detection-and-crown-delineation.html#cb202-9" tabindex="-1"></a>    <span class="at">zcol =</span> <span class="st">&quot;is_conifer_site&quot;</span>, <span class="at">legend =</span> T</span>
<span id="cb202-10"><a href="validate-tree-detection-and-crown-delineation.html#cb202-10" tabindex="-1"></a>    , <span class="at">layer.name =</span> <span class="st">&quot;conifer site?&quot;</span></span>
<span id="cb202-11"><a href="validate-tree-detection-and-crown-delineation.html#cb202-11" tabindex="-1"></a>    , <span class="at">col.regions =</span> viridis<span class="sc">::</span><span class="fu">viridis</span>(<span class="at">n=</span><span class="dv">2</span>,<span class="at">begin =</span> <span class="fl">0.1</span>,<span class="at">end =</span> <span class="fl">0.9</span>)</span>
<span id="cb202-12"><a href="validate-tree-detection-and-crown-delineation.html#cb202-12" tabindex="-1"></a>  )</span></code></pre></div>
<div class="leaflet html-widget html-fill-item" id="htmlwidget-0cb097f718e7db368c13" style="width:1008px;height:672px;"></div>
<script type="application/json" data-for="htmlwidget-0cb097f718e7db368c13">{"x":{"options":{"minZoom":1,"maxZoom":52,"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}},"preferCanvas":false,"bounceAtZoomLimits":false,"maxBounds":[[[-90,-370]],[[90,370]]]},"calls":[{"method":"addProviderTiles","args":["OpenStreetMap","OpenStreetMap","OpenStreetMap",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["Esri.WorldImagery","Esri.WorldImagery","Esri.WorldImagery",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"createMapPane","args":["point",440]},{"method":"addCircleMarkers","args":[[45.76170271641791,44.06187242959296,39.07476012753623,65.16681257978723,33.39979854090354,63.87034470520231,32.53909047666196,28.08222958823529,42.53603728800857,31.19748024733096,31.85038757111756,37.38124129809103,38.26231868965518,40.04172801108648,40.17957887499999,29.69109949456522,19.55187788106796,38.89187079812206,38.88725247451963,37.11112712790698,37.03389210536779,32.94875689412314,37.00258338164251,39.03917837990581,46.23239715042118],[-122.3339110559701,-71.28638906353136,-78.01215299710145,-147.5119089095745,-97.57645736630036,-145.7525825260116,-87.80625378170674,-81.40931664705882,-72.17855873447537,-84.46601650711743,-88.16464241146589,-80.52715028671072,-109.3457485172414,-105.5650561036585,-112.5173911477273,-81.98834036801242,-155.3184096165049,-78.13963286019822,-76.55769414536341,-119.7334487383721,-119.2642730019881,-87.39915964505597,-119.0076350660226,-95.19310532025118,-89.53771875330926],6,null,"conifer site?",{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}},"pane":"point","stroke":true,"color":"#333333","weight":1,"opacity":[0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9],"fill":true,"fillColor":["#482576","#BBDF27","#BBDF27","#BBDF27","#BBDF27","#482576","#BBDF27","#482576","#BBDF27","#482576","#BBDF27","#BBDF27","#482576","#482576","#482576","#482576","#BBDF27","#BBDF27","#BBDF27","#BBDF27","#482576","#482576","#482576","#BBDF27","#BBDF27"],"fillOpacity":[0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6]},null,null,["<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>1&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>ABBY&emsp;<\/td><\/tr><tr><td>2<\/td><th>pct_conifer&emsp;<\/th><td>89.9%&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><tr><td>4<\/td><th>is_conifer_site&emsp;<\/th><td>conifer site&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>2&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>BART&emsp;<\/td><\/tr><tr><td>2<\/td><th>pct_conifer&emsp;<\/th><td>28.1%&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><tr><td>4<\/td><th>is_conifer_site&emsp;<\/th><td>non-conifer site&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>3&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>BLAN&emsp;<\/td><\/tr><tr><td>2<\/td><th>pct_conifer&emsp;<\/th><td>2.3%&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><tr><td>4<\/td><th>is_conifer_site&emsp;<\/th><td>non-conifer site&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>4&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>BONA&emsp;<\/td><\/tr><tr><td>2<\/td><th>pct_conifer&emsp;<\/th><td>25.5%&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><tr><td>4<\/td><th>is_conifer_site&emsp;<\/th><td>non-conifer site&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>5&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>CLBJ&emsp;<\/td><\/tr><tr><td>2<\/td><th>pct_conifer&emsp;<\/th><td>8.7%&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><tr><td>4<\/td><th>is_conifer_site&emsp;<\/th><td>non-conifer site&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>6&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>DEJU&emsp;<\/td><\/tr><tr><td>2<\/td><th>pct_conifer&emsp;<\/th><td>97.7%&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><tr><td>4<\/td><th>is_conifer_site&emsp;<\/th><td>conifer site&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>7&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>DELA&emsp;<\/td><\/tr><tr><td>2<\/td><th>pct_conifer&emsp;<\/th><td>0.9%&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><tr><td>4<\/td><th>is_conifer_site&emsp;<\/th><td>non-conifer site&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>8&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>DSNY&emsp;<\/td><\/tr><tr><td>2<\/td><th>pct_conifer&emsp;<\/th><td>76.5%&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><tr><td>4<\/td><th>is_conifer_site&emsp;<\/th><td>conifer site&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>9&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>HARV&emsp;<\/td><\/tr><tr><td>2<\/td><th>pct_conifer&emsp;<\/th><td>45.5%&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><tr><td>4<\/td><th>is_conifer_site&emsp;<\/th><td>non-conifer site&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>10&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>JERC&emsp;<\/td><\/tr><tr><td>2<\/td><th>pct_conifer&emsp;<\/th><td>59.8%&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><tr><td>4<\/td><th>is_conifer_site&emsp;<\/th><td>conifer site&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>11&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>LENO&emsp;<\/td><\/tr><tr><td>2<\/td><th>pct_conifer&emsp;<\/th><td>5.6%&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><tr><td>4<\/td><th>is_conifer_site&emsp;<\/th><td>non-conifer site&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>12&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>MLBS&emsp;<\/td><\/tr><tr><td>2<\/td><th>pct_conifer&emsp;<\/th><td>5.2%&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><tr><td>4<\/td><th>is_conifer_site&emsp;<\/th><td>non-conifer site&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>13&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>MOAB&emsp;<\/td><\/tr><tr><td>2<\/td><th>pct_conifer&emsp;<\/th><td>100.0%&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><tr><td>4<\/td><th>is_conifer_site&emsp;<\/th><td>conifer site&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>14&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>NIWO&emsp;<\/td><\/tr><tr><td>2<\/td><th>pct_conifer&emsp;<\/th><td>100.0%&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><tr><td>4<\/td><th>is_conifer_site&emsp;<\/th><td>conifer site&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>15&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>ONAQ&emsp;<\/td><\/tr><tr><td>2<\/td><th>pct_conifer&emsp;<\/th><td>100.0%&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><tr><td>4<\/td><th>is_conifer_site&emsp;<\/th><td>conifer site&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>16&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>OSBS&emsp;<\/td><\/tr><tr><td>2<\/td><th>pct_conifer&emsp;<\/th><td>66.6%&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><tr><td>4<\/td><th>is_conifer_site&emsp;<\/th><td>conifer site&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>17&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>PUUM&emsp;<\/td><\/tr><tr><td>2<\/td><th>pct_conifer&emsp;<\/th><td>0.0%&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><tr><td>4<\/td><th>is_conifer_site&emsp;<\/th><td>non-conifer site&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>18&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>SCBI&emsp;<\/td><\/tr><tr><td>2<\/td><th>pct_conifer&emsp;<\/th><td>0.1%&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><tr><td>4<\/td><th>is_conifer_site&emsp;<\/th><td>non-conifer site&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>19&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>SERC&emsp;<\/td><\/tr><tr><td>2<\/td><th>pct_conifer&emsp;<\/th><td>0.9%&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><tr><td>4<\/td><th>is_conifer_site&emsp;<\/th><td>non-conifer site&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>20&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>SJER&emsp;<\/td><\/tr><tr><td>2<\/td><th>pct_conifer&emsp;<\/th><td>15.7%&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><tr><td>4<\/td><th>is_conifer_site&emsp;<\/th><td>non-conifer site&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>21&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>SOAP&emsp;<\/td><\/tr><tr><td>2<\/td><th>pct_conifer&emsp;<\/th><td>77.3%&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><tr><td>4<\/td><th>is_conifer_site&emsp;<\/th><td>conifer site&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>22&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>TALL&emsp;<\/td><\/tr><tr><td>2<\/td><th>pct_conifer&emsp;<\/th><td>70.9%&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><tr><td>4<\/td><th>is_conifer_site&emsp;<\/th><td>conifer site&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>23&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>TEAK&emsp;<\/td><\/tr><tr><td>2<\/td><th>pct_conifer&emsp;<\/th><td>99.7%&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><tr><td>4<\/td><th>is_conifer_site&emsp;<\/th><td>conifer site&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>24&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>UKFS&emsp;<\/td><\/tr><tr><td>2<\/td><th>pct_conifer&emsp;<\/th><td>9.7%&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><tr><td>4<\/td><th>is_conifer_site&emsp;<\/th><td>non-conifer site&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>25&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>UNDE&emsp;<\/td><\/tr><tr><td>2<\/td><th>pct_conifer&emsp;<\/th><td>19.4%&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><tr><td>4<\/td><th>is_conifer_site&emsp;<\/th><td>non-conifer site&emsp;<\/td><\/tr><\/table><\/div>"],{"maxWidth":800,"minWidth":50,"autoPan":true,"keepInView":false,"closeButton":true,"closeOnClick":true,"className":""},["conifer site","non-conifer site","non-conifer site","non-conifer site","non-conifer site","conifer site","non-conifer site","conifer site","non-conifer site","conifer site","non-conifer site","non-conifer site","conifer site","conifer site","conifer site","conifer site","non-conifer site","non-conifer site","non-conifer site","non-conifer site","conifer site","conifer site","conifer site","non-conifer site","non-conifer site"],{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addScaleBar","args":[{"maxWidth":100,"metric":true,"imperial":true,"updateWhenIdle":true,"position":"bottomleft"}]},{"method":"addLayersControl","args":[["OpenStreetMap","Esri.WorldImagery"],"conifer site?",{"collapsed":true,"autoZIndex":true,"position":"topleft"}]},{"method":"addLegend","args":[{"colors":["#482576","#BBDF27"],"labels":["conifer site","non-conifer site"],"na_color":null,"na_label":"NA","opacity":1,"position":"topright","type":"factor","title":"conifer site?","extra":null,"layerId":null,"className":"info legend","group":"conifer site?"}]}],"limits":{"lat":[19.55187788106796,65.16681257978723],"lng":[-155.3184096165049,-71.28638906353136]},"fitBounds":[19.55187788106796,-155.3184096165049,65.16681257978723,-71.28638906353136,[]]},"evals":[],"jsHooks":{"render":[{"code":"function(el, x, data) {\n  return (\n      function(el, x, data) {\n      // get the leaflet map\n      var map = this; //HTMLWidgets.find('#' + el.id);\n      // we need a new div element because we have to handle\n      // the mouseover output separately\n      // debugger;\n      function addElement () {\n      // generate new div Element\n      var newDiv = $(document.createElement('div'));\n      // append at end of leaflet htmlwidget container\n      $(el).append(newDiv);\n      //provide ID and style\n      newDiv.addClass('lnlt');\n      newDiv.css({\n      'position': 'relative',\n      'bottomleft':  '0px',\n      'background-color': 'rgba(255, 255, 255, 0.7)',\n      'box-shadow': '0 0 2px #bbb',\n      'background-clip': 'padding-box',\n      'margin': '0',\n      'padding-left': '5px',\n      'color': '#333',\n      'font': '9px/1.5 \"Helvetica Neue\", Arial, Helvetica, sans-serif',\n      'z-index': '700',\n      });\n      return newDiv;\n      }\n\n\n      // check for already existing lnlt class to not duplicate\n      var lnlt = $(el).find('.lnlt');\n\n      if(!lnlt.length) {\n      lnlt = addElement();\n\n      // grab the special div we generated in the beginning\n      // and put the mousmove output there\n\n      map.on('mousemove', function (e) {\n      if (e.originalEvent.ctrlKey) {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                           ' lon: ' + (e.latlng.lng).toFixed(5) +\n                           ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                           ' | zoom: ' + map.getZoom() +\n                           ' | x: ' + L.CRS.EPSG3857.project(e.latlng).x.toFixed(0) +\n                           ' | y: ' + L.CRS.EPSG3857.project(e.latlng).y.toFixed(0) +\n                           ' | epsg: 3857 ' +\n                           ' | proj4: +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs ');\n      } else {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                      ' | zoom: ' + map.getZoom() + ' ');\n      }\n      });\n\n      // remove the lnlt div when mouse leaves map\n      map.on('mouseout', function (e) {\n      var strip = document.querySelector('.lnlt');\n      if( strip !==null) strip.remove();\n      });\n\n      };\n\n      //$(el).keypress(67, function(e) {\n      map.on('preclick', function(e) {\n      if (e.originalEvent.ctrlKey) {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                      ' | zoom: ' + map.getZoom() + ' ');\n      var txt = document.querySelector('.lnlt').textContent;\n      console.log(txt);\n      //txt.innerText.focus();\n      //txt.select();\n      setClipboardText('\"' + txt + '\"');\n      }\n      });\n\n      }\n      ).call(this.getMap(), el, x, data);\n}","data":null},{"code":"function(el, x, data) {\n  return (function(el,x,data){\n           var map = this;\n\n           map.on('keypress', function(e) {\n               console.log(e.originalEvent.code);\n               var key = e.originalEvent.code;\n               if (key === 'KeyE') {\n                   var bb = this.getBounds();\n                   var txt = JSON.stringify(bb);\n                   console.log(txt);\n\n                   setClipboardText('\\'' + txt + '\\'');\n               }\n           })\n        }).call(this.getMap(), el, x, data);\n}","data":null}]}}</script>
<p>looks reasonable, let’s filter our point cloud processing data for conifer sites based on our proportional threshold of 50%</p>
<div class="sourceCode" id="cb203"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb203-1"><a href="validate-tree-detection-and-crown-delineation.html#cb203-1" tabindex="-1"></a><span class="co"># data frame of sites</span></span>
<span id="cb203-2"><a href="validate-tree-detection-and-crown-delineation.html#cb203-2" tabindex="-1"></a>lidar_df <span class="ot">&lt;-</span> lidar_df <span class="sc">%&gt;%</span></span>
<span id="cb203-3"><a href="validate-tree-detection-and-crown-delineation.html#cb203-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(pct_conifer<span class="sc">&gt;</span>min_conifer_pct) <span class="sc">%&gt;%</span> </span>
<span id="cb203-4"><a href="validate-tree-detection-and-crown-delineation.html#cb203-4" tabindex="-1"></a>  <span class="co"># filter out corrupt las files</span></span>
<span id="cb203-5"><a href="validate-tree-detection-and-crown-delineation.html#cb203-5" tabindex="-1"></a>  <span class="co"># these don&#39;t load in lasR...maybe extrabytes issue???</span></span>
<span id="cb203-6"><a href="validate-tree-detection-and-crown-delineation.html#cb203-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb203-7"><a href="validate-tree-detection-and-crown-delineation.html#cb203-7" tabindex="-1"></a>    <span class="sc">!</span>plot_name <span class="sc">%in%</span> <span class="fu">c</span>(</span>
<span id="cb203-8"><a href="validate-tree-detection-and-crown-delineation.html#cb203-8" tabindex="-1"></a>      <span class="st">&quot;NIWO_005_2018&quot;</span></span>
<span id="cb203-9"><a href="validate-tree-detection-and-crown-delineation.html#cb203-9" tabindex="-1"></a>      , <span class="st">&quot;SOAP_014_2018&quot;</span></span>
<span id="cb203-10"><a href="validate-tree-detection-and-crown-delineation.html#cb203-10" tabindex="-1"></a>      , <span class="st">&quot;MOAB_003_2018&quot;</span></span>
<span id="cb203-11"><a href="validate-tree-detection-and-crown-delineation.html#cb203-11" tabindex="-1"></a>      , <span class="st">&quot;NIWO_009_2018&quot;</span></span>
<span id="cb203-12"><a href="validate-tree-detection-and-crown-delineation.html#cb203-12" tabindex="-1"></a>      , <span class="st">&quot;TEAK_028_2018&quot;</span></span>
<span id="cb203-13"><a href="validate-tree-detection-and-crown-delineation.html#cb203-13" tabindex="-1"></a>      , <span class="st">&quot;YELL_058_2020&quot;</span></span>
<span id="cb203-14"><a href="validate-tree-detection-and-crown-delineation.html#cb203-14" tabindex="-1"></a>      , <span class="st">&quot;RMNP_011_2018&quot;</span></span>
<span id="cb203-15"><a href="validate-tree-detection-and-crown-delineation.html#cb203-15" tabindex="-1"></a>      , <span class="st">&quot;YELL_030_2018&quot;</span></span>
<span id="cb203-16"><a href="validate-tree-detection-and-crown-delineation.html#cb203-16" tabindex="-1"></a>      , <span class="st">&quot;YELL_051_2019&quot;</span></span>
<span id="cb203-17"><a href="validate-tree-detection-and-crown-delineation.html#cb203-17" tabindex="-1"></a>      , <span class="st">&quot;SOAP_014_2019&quot;</span></span>
<span id="cb203-18"><a href="validate-tree-detection-and-crown-delineation.html#cb203-18" tabindex="-1"></a>      , <span class="st">&quot;TEAK_005_2018&quot;</span></span>
<span id="cb203-19"><a href="validate-tree-detection-and-crown-delineation.html#cb203-19" tabindex="-1"></a>      , <span class="st">&quot;DSNY_019_2019&quot;</span></span>
<span id="cb203-20"><a href="validate-tree-detection-and-crown-delineation.html#cb203-20" tabindex="-1"></a>      , <span class="st">&quot;HEAL_004_2019&quot;</span></span>
<span id="cb203-21"><a href="validate-tree-detection-and-crown-delineation.html#cb203-21" tabindex="-1"></a>      , <span class="st">&quot;SOAP_049_2018&quot;</span></span>
<span id="cb203-22"><a href="validate-tree-detection-and-crown-delineation.html#cb203-22" tabindex="-1"></a>      , <span class="st">&quot;TEAK_016_2019&quot;</span></span>
<span id="cb203-23"><a href="validate-tree-detection-and-crown-delineation.html#cb203-23" tabindex="-1"></a>      , <span class="st">&quot;YELL_006_2018&quot;</span></span>
<span id="cb203-24"><a href="validate-tree-detection-and-crown-delineation.html#cb203-24" tabindex="-1"></a>    )</span>
<span id="cb203-25"><a href="validate-tree-detection-and-crown-delineation.html#cb203-25" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb203-26"><a href="validate-tree-detection-and-crown-delineation.html#cb203-26" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb203-27"><a href="validate-tree-detection-and-crown-delineation.html#cb203-27" tabindex="-1"></a>    <span class="co"># these plots not corrupt but there are no field trees to evaluate against</span></span>
<span id="cb203-28"><a href="validate-tree-detection-and-crown-delineation.html#cb203-28" tabindex="-1"></a>    <span class="at">has_field_stems =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb203-29"><a href="validate-tree-detection-and-crown-delineation.html#cb203-29" tabindex="-1"></a>      plot_name <span class="sc">%in%</span> <span class="fu">c</span>(</span>
<span id="cb203-30"><a href="validate-tree-detection-and-crown-delineation.html#cb203-30" tabindex="-1"></a>        <span class="st">&quot;DEJU_021_2018&quot;</span> </span>
<span id="cb203-31"><a href="validate-tree-detection-and-crown-delineation.html#cb203-31" tabindex="-1"></a>        , <span class="st">&quot;DEJU_021_2019&quot;</span></span>
<span id="cb203-32"><a href="validate-tree-detection-and-crown-delineation.html#cb203-32" tabindex="-1"></a>        , <span class="st">&quot;JERC_055_2018&quot;</span></span>
<span id="cb203-33"><a href="validate-tree-detection-and-crown-delineation.html#cb203-33" tabindex="-1"></a>        , <span class="st">&quot;JERC_055_2019&quot;</span></span>
<span id="cb203-34"><a href="validate-tree-detection-and-crown-delineation.html#cb203-34" tabindex="-1"></a>        , <span class="st">&quot;ABBY_064_2018&quot;</span></span>
<span id="cb203-35"><a href="validate-tree-detection-and-crown-delineation.html#cb203-35" tabindex="-1"></a>        , <span class="st">&quot;ABBY_064_2019&quot;</span></span>
<span id="cb203-36"><a href="validate-tree-detection-and-crown-delineation.html#cb203-36" tabindex="-1"></a>      ) <span class="sc">~</span> F</span>
<span id="cb203-37"><a href="validate-tree-detection-and-crown-delineation.html#cb203-37" tabindex="-1"></a>      , T <span class="sc">~</span> has_field_stems</span>
<span id="cb203-38"><a href="validate-tree-detection-and-crown-delineation.html#cb203-38" tabindex="-1"></a>    )</span>
<span id="cb203-39"><a href="validate-tree-detection-and-crown-delineation.html#cb203-39" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb203-40"><a href="validate-tree-detection-and-crown-delineation.html#cb203-40" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb203-41"><a href="validate-tree-detection-and-crown-delineation.html#cb203-41" tabindex="-1"></a>    data_type <span class="sc">==</span> <span class="st">&quot;training&quot;</span> <span class="sc">|</span> has_field_stems <span class="sc">|</span> has_image_annotation </span>
<span id="cb203-42"><a href="validate-tree-detection-and-crown-delineation.html#cb203-42" tabindex="-1"></a>  )</span></code></pre></div>
<p>what NEON sites have conifers and training/evaluation data?</p>
<div class="sourceCode" id="cb204"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb204-1"><a href="validate-tree-detection-and-crown-delineation.html#cb204-1" tabindex="-1"></a>lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb204-2"><a href="validate-tree-detection-and-crown-delineation.html#cb204-2" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb204-3"><a href="validate-tree-detection-and-crown-delineation.html#cb204-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(siteID) <span class="sc">%&gt;%</span> </span>
<span id="cb204-4"><a href="validate-tree-detection-and-crown-delineation.html#cb204-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb204-5"><a href="validate-tree-detection-and-crown-delineation.html#cb204-5" tabindex="-1"></a>    <span class="at">n =</span> dplyr<span class="sc">::</span><span class="fu">n</span>()</span>
<span id="cb204-6"><a href="validate-tree-detection-and-crown-delineation.html#cb204-6" tabindex="-1"></a>    , <span class="at">training_plots =</span> <span class="fu">sum</span>(<span class="fu">ifelse</span>(data_type<span class="sc">==</span><span class="st">&quot;training&quot;</span>,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb204-7"><a href="validate-tree-detection-and-crown-delineation.html#cb204-7" tabindex="-1"></a>    , <span class="at">evaluation_plots =</span> <span class="fu">sum</span>(<span class="fu">ifelse</span>(data_type<span class="sc">==</span><span class="st">&quot;evaluation&quot;</span>,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb204-8"><a href="validate-tree-detection-and-crown-delineation.html#cb204-8" tabindex="-1"></a>    , <span class="at">evaluation_ann_plots =</span> <span class="fu">sum</span>(<span class="fu">ifelse</span>(has_image_annotation <span class="sc">&amp;</span> data_type<span class="sc">==</span><span class="st">&quot;evaluation&quot;</span>,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb204-9"><a href="validate-tree-detection-and-crown-delineation.html#cb204-9" tabindex="-1"></a>    , <span class="at">evaluation_fld_plots =</span> <span class="fu">sum</span>(<span class="fu">ifelse</span>(has_field_stems <span class="sc">&amp;</span> data_type<span class="sc">==</span><span class="st">&quot;evaluation&quot;</span>,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb204-10"><a href="validate-tree-detection-and-crown-delineation.html#cb204-10" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb204-11"><a href="validate-tree-detection-and-crown-delineation.html#cb204-11" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb204-12"><a href="validate-tree-detection-and-crown-delineation.html#cb204-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>n) <span class="sc">%&gt;%</span> </span>
<span id="cb204-13"><a href="validate-tree-detection-and-crown-delineation.html#cb204-13" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(</span>
<span id="cb204-14"><a href="validate-tree-detection-and-crown-delineation.html#cb204-14" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">&quot;NEON sites with conifers and lidar plots&quot;</span></span>
<span id="cb204-15"><a href="validate-tree-detection-and-crown-delineation.html#cb204-15" tabindex="-1"></a>    , <span class="at">col.names =</span> <span class="fu">c</span>(</span>
<span id="cb204-16"><a href="validate-tree-detection-and-crown-delineation.html#cb204-16" tabindex="-1"></a>      <span class="st">&quot;site&quot;</span>,<span class="st">&quot;training plots&quot;</span>,<span class="st">&quot;evaluation plots&quot;</span></span>
<span id="cb204-17"><a href="validate-tree-detection-and-crown-delineation.html#cb204-17" tabindex="-1"></a>      ,<span class="st">&quot;evaluation plots&lt;br&gt;with ground truth&lt;br&gt;image ann. crowns&quot;</span></span>
<span id="cb204-18"><a href="validate-tree-detection-and-crown-delineation.html#cb204-18" tabindex="-1"></a>      ,<span class="st">&quot;evaluation plots&lt;br&gt;with ground truth&lt;br&gt;field collected stems&quot;</span></span>
<span id="cb204-19"><a href="validate-tree-detection-and-crown-delineation.html#cb204-19" tabindex="-1"></a>    )</span>
<span id="cb204-20"><a href="validate-tree-detection-and-crown-delineation.html#cb204-20" tabindex="-1"></a>    , <span class="at">escape =</span> F</span>
<span id="cb204-21"><a href="validate-tree-detection-and-crown-delineation.html#cb204-21" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb204-22"><a href="validate-tree-detection-and-crown-delineation.html#cb204-22" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>()</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-183">Table 4.3: </span>NEON sites with conifers and lidar plots
</caption>
<thead>
<tr>
<th style="text-align:left;">
site
</th>
<th style="text-align:right;">
training plots
</th>
<th style="text-align:right;">
evaluation plots
</th>
<th style="text-align:right;">
evaluation plots<br>with ground truth<br>image ann. crowns
</th>
<th style="text-align:right;">
evaluation plots<br>with ground truth<br>field collected stems
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
OSBS
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
49
</td>
<td style="text-align:right;">
14
</td>
<td style="text-align:right;">
46
</td>
</tr>
<tr>
<td style="text-align:left;">
TEAK
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
51
</td>
<td style="text-align:right;">
51
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
NIWO
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
42
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
41
</td>
</tr>
<tr>
<td style="text-align:left;">
JERC
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
22
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
21
</td>
</tr>
<tr>
<td style="text-align:left;">
TALL
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
23
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
22
</td>
</tr>
<tr>
<td style="text-align:left;">
ABBY
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
14
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
13
</td>
</tr>
<tr>
<td style="text-align:left;">
DEJU
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
14
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
14
</td>
</tr>
<tr>
<td style="text-align:left;">
DSNY
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
MOAB
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:left;">
SOAP
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
ONAQ
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
</tr>
</tbody>
</table>
<p>note that the sum of the evaluation plots with image annotated crowns and with field collected stems does not necessarily equate to the number of evaluation plots since one plot can have both image annotated and field collected data.</p>
<p>what is the spatial distribution of these conifer sites for which lidar data is available?</p>
<div class="sourceCode" id="cb205"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb205-1"><a href="validate-tree-detection-and-crown-delineation.html#cb205-1" tabindex="-1"></a>lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb205-2"><a href="validate-tree-detection-and-crown-delineation.html#cb205-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(siteID) <span class="sc">%&gt;%</span> </span>
<span id="cb205-3"><a href="validate-tree-detection-and-crown-delineation.html#cb205-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb205-4"><a href="validate-tree-detection-and-crown-delineation.html#cb205-4" tabindex="-1"></a>    <span class="at">training_plots =</span> <span class="fu">sum</span>(<span class="fu">ifelse</span>(data_type<span class="sc">==</span><span class="st">&quot;training&quot;</span>,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb205-5"><a href="validate-tree-detection-and-crown-delineation.html#cb205-5" tabindex="-1"></a>    , <span class="at">evaluation_plots =</span> <span class="fu">sum</span>(<span class="fu">ifelse</span>(data_type<span class="sc">==</span><span class="st">&quot;evaluation&quot;</span>,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb205-6"><a href="validate-tree-detection-and-crown-delineation.html#cb205-6" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb205-7"><a href="validate-tree-detection-and-crown-delineation.html#cb205-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb205-8"><a href="validate-tree-detection-and-crown-delineation.html#cb205-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb205-9"><a href="validate-tree-detection-and-crown-delineation.html#cb205-9" tabindex="-1"></a>    <span class="at">data_type =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb205-10"><a href="validate-tree-detection-and-crown-delineation.html#cb205-10" tabindex="-1"></a>      training_plots<span class="sc">&gt;</span><span class="dv">0</span> <span class="sc">&amp;</span> evaluation_plots<span class="sc">==</span><span class="dv">0</span> <span class="sc">~</span> <span class="st">&quot;training&quot;</span></span>
<span id="cb205-11"><a href="validate-tree-detection-and-crown-delineation.html#cb205-11" tabindex="-1"></a>      , training_plots<span class="sc">&gt;</span><span class="dv">0</span> <span class="sc">&amp;</span> evaluation_plots<span class="sc">&gt;</span><span class="dv">0</span> <span class="sc">~</span> <span class="st">&quot;training+evaluation&quot;</span></span>
<span id="cb205-12"><a href="validate-tree-detection-and-crown-delineation.html#cb205-12" tabindex="-1"></a>      , training_plots<span class="sc">==</span><span class="dv">0</span> <span class="sc">&amp;</span> evaluation_plots<span class="sc">&gt;</span><span class="dv">0</span> <span class="sc">~</span> <span class="st">&quot;evaluation&quot;</span></span>
<span id="cb205-13"><a href="validate-tree-detection-and-crown-delineation.html#cb205-13" tabindex="-1"></a>      , T <span class="sc">~</span> <span class="st">&quot;other&quot;</span></span>
<span id="cb205-14"><a href="validate-tree-detection-and-crown-delineation.html#cb205-14" tabindex="-1"></a>    )</span>
<span id="cb205-15"><a href="validate-tree-detection-and-crown-delineation.html#cb205-15" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb205-16"><a href="validate-tree-detection-and-crown-delineation.html#cb205-16" tabindex="-1"></a>  mapview<span class="sc">::</span><span class="fu">mapview</span>(</span>
<span id="cb205-17"><a href="validate-tree-detection-and-crown-delineation.html#cb205-17" tabindex="-1"></a>    <span class="at">zcol =</span> <span class="st">&quot;data_type&quot;</span>, <span class="at">legend =</span> T</span>
<span id="cb205-18"><a href="validate-tree-detection-and-crown-delineation.html#cb205-18" tabindex="-1"></a>    , <span class="at">layer.name =</span> <span class="st">&quot;data type&quot;</span></span>
<span id="cb205-19"><a href="validate-tree-detection-and-crown-delineation.html#cb205-19" tabindex="-1"></a>    , <span class="at">col.regions =</span> viridis<span class="sc">::</span><span class="fu">magma</span>(<span class="at">n=</span><span class="dv">2</span>,<span class="at">begin =</span> <span class="fl">0.2</span>,<span class="at">end =</span> <span class="fl">0.8</span>)</span>
<span id="cb205-20"><a href="validate-tree-detection-and-crown-delineation.html#cb205-20" tabindex="-1"></a>  )</span></code></pre></div>
<div class="leaflet html-widget html-fill-item" id="htmlwidget-da63c534be5c91bcf38c" style="width:1008px;height:672px;"></div>
<script type="application/json" data-for="htmlwidget-da63c534be5c91bcf38c">{"x":{"options":{"minZoom":1,"maxZoom":52,"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}},"preferCanvas":false,"bounceAtZoomLimits":false,"maxBounds":[[[-90,-370]],[[90,370]]]},"calls":[{"method":"addProviderTiles","args":["OpenStreetMap","OpenStreetMap","OpenStreetMap",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["Esri.WorldImagery","Esri.WorldImagery","Esri.WorldImagery",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"createMapPane","args":["point",440]},{"method":"addCircleMarkers","args":[[45.76170271641791,63.87034470520231,28.08222958823529,31.19748024733096,38.26231868965518,40.04172801108648,40.17957887499999,29.69109949456522,37.03389210536779,32.94875689412314,37.00258338164251],[-122.3339110559701,-145.7525825260116,-81.40931664705882,-84.46601650711743,-109.3457485172414,-105.5650561036585,-112.5173911477273,-81.98834036801242,-119.2642730019881,-87.39915964505597,-119.0076350660226],6,null,"data type",{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}},"pane":"point","stroke":true,"color":"#333333","weight":1,"opacity":[0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9,0.9],"fill":true,"fillColor":["#3B0F70","#3B0F70","#3B0F70","#FE9F6D","#3B0F70","#FE9F6D","#3B0F70","#FE9F6D","#3B0F70","#3B0F70","#FE9F6D"],"fillOpacity":[0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6,0.6]},null,null,["<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>1&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>ABBY&emsp;<\/td><\/tr><tr><td>2<\/td><th>training_plots&emsp;<\/th><td>0&emsp;<\/td><\/tr><tr><td>3<\/td><th>evaluation_plots&emsp;<\/th><td>14&emsp;<\/td><\/tr><tr><td>4<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><tr><td>5<\/td><th>data_type&emsp;<\/th><td>evaluation&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>2&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>DEJU&emsp;<\/td><\/tr><tr><td>2<\/td><th>training_plots&emsp;<\/th><td>0&emsp;<\/td><\/tr><tr><td>3<\/td><th>evaluation_plots&emsp;<\/th><td>14&emsp;<\/td><\/tr><tr><td>4<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><tr><td>5<\/td><th>data_type&emsp;<\/th><td>evaluation&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>3&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>DSNY&emsp;<\/td><\/tr><tr><td>2<\/td><th>training_plots&emsp;<\/th><td>0&emsp;<\/td><\/tr><tr><td>3<\/td><th>evaluation_plots&emsp;<\/th><td> 6&emsp;<\/td><\/tr><tr><td>4<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><tr><td>5<\/td><th>data_type&emsp;<\/th><td>evaluation&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>4&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>JERC&emsp;<\/td><\/tr><tr><td>2<\/td><th>training_plots&emsp;<\/th><td>1&emsp;<\/td><\/tr><tr><td>3<\/td><th>evaluation_plots&emsp;<\/th><td>22&emsp;<\/td><\/tr><tr><td>4<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><tr><td>5<\/td><th>data_type&emsp;<\/th><td>training+evaluation&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>5&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>MOAB&emsp;<\/td><\/tr><tr><td>2<\/td><th>training_plots&emsp;<\/th><td>0&emsp;<\/td><\/tr><tr><td>3<\/td><th>evaluation_plots&emsp;<\/th><td> 2&emsp;<\/td><\/tr><tr><td>4<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><tr><td>5<\/td><th>data_type&emsp;<\/th><td>evaluation&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>6&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>NIWO&emsp;<\/td><\/tr><tr><td>2<\/td><th>training_plots&emsp;<\/th><td>1&emsp;<\/td><\/tr><tr><td>3<\/td><th>evaluation_plots&emsp;<\/th><td>42&emsp;<\/td><\/tr><tr><td>4<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><tr><td>5<\/td><th>data_type&emsp;<\/th><td>training+evaluation&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>7&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>ONAQ&emsp;<\/td><\/tr><tr><td>2<\/td><th>training_plots&emsp;<\/th><td>0&emsp;<\/td><\/tr><tr><td>3<\/td><th>evaluation_plots&emsp;<\/th><td> 1&emsp;<\/td><\/tr><tr><td>4<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><tr><td>5<\/td><th>data_type&emsp;<\/th><td>evaluation&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>8&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>OSBS&emsp;<\/td><\/tr><tr><td>2<\/td><th>training_plots&emsp;<\/th><td>3&emsp;<\/td><\/tr><tr><td>3<\/td><th>evaluation_plots&emsp;<\/th><td>49&emsp;<\/td><\/tr><tr><td>4<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><tr><td>5<\/td><th>data_type&emsp;<\/th><td>training+evaluation&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>9&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>SOAP&emsp;<\/td><\/tr><tr><td>2<\/td><th>training_plots&emsp;<\/th><td>0&emsp;<\/td><\/tr><tr><td>3<\/td><th>evaluation_plots&emsp;<\/th><td> 2&emsp;<\/td><\/tr><tr><td>4<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><tr><td>5<\/td><th>data_type&emsp;<\/th><td>evaluation&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>10&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>TALL&emsp;<\/td><\/tr><tr><td>2<\/td><th>training_plots&emsp;<\/th><td>0&emsp;<\/td><\/tr><tr><td>3<\/td><th>evaluation_plots&emsp;<\/th><td>23&emsp;<\/td><\/tr><tr><td>4<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><tr><td>5<\/td><th>data_type&emsp;<\/th><td>evaluation&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>11&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>TEAK&emsp;<\/td><\/tr><tr><td>2<\/td><th>training_plots&emsp;<\/th><td>1&emsp;<\/td><\/tr><tr><td>3<\/td><th>evaluation_plots&emsp;<\/th><td>51&emsp;<\/td><\/tr><tr><td>4<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><tr><td>5<\/td><th>data_type&emsp;<\/th><td>training+evaluation&emsp;<\/td><\/tr><\/table><\/div>"],{"maxWidth":800,"minWidth":50,"autoPan":true,"keepInView":false,"closeButton":true,"closeOnClick":true,"className":""},["evaluation","evaluation","evaluation","training+evaluation","evaluation","training+evaluation","evaluation","training+evaluation","evaluation","evaluation","training+evaluation"],{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addScaleBar","args":[{"maxWidth":100,"metric":true,"imperial":true,"updateWhenIdle":true,"position":"bottomleft"}]},{"method":"addLayersControl","args":[["OpenStreetMap","Esri.WorldImagery"],"data type",{"collapsed":true,"autoZIndex":true,"position":"topleft"}]},{"method":"addLegend","args":[{"colors":["#3B0F70","#FE9F6D"],"labels":["evaluation","training+evaluation"],"na_color":null,"na_label":"NA","opacity":1,"position":"topright","type":"factor","title":"data type","extra":null,"layerId":null,"className":"info legend","group":"data type"}]}],"limits":{"lat":[28.08222958823529,63.87034470520231],"lng":[-145.7525825260116,-81.40931664705882]},"fitBounds":[28.08222958823529,-145.7525825260116,63.87034470520231,-81.40931664705882,[]]},"evals":[],"jsHooks":{"render":[{"code":"function(el, x, data) {\n  return (\n      function(el, x, data) {\n      // get the leaflet map\n      var map = this; //HTMLWidgets.find('#' + el.id);\n      // we need a new div element because we have to handle\n      // the mouseover output separately\n      // debugger;\n      function addElement () {\n      // generate new div Element\n      var newDiv = $(document.createElement('div'));\n      // append at end of leaflet htmlwidget container\n      $(el).append(newDiv);\n      //provide ID and style\n      newDiv.addClass('lnlt');\n      newDiv.css({\n      'position': 'relative',\n      'bottomleft':  '0px',\n      'background-color': 'rgba(255, 255, 255, 0.7)',\n      'box-shadow': '0 0 2px #bbb',\n      'background-clip': 'padding-box',\n      'margin': '0',\n      'padding-left': '5px',\n      'color': '#333',\n      'font': '9px/1.5 \"Helvetica Neue\", Arial, Helvetica, sans-serif',\n      'z-index': '700',\n      });\n      return newDiv;\n      }\n\n\n      // check for already existing lnlt class to not duplicate\n      var lnlt = $(el).find('.lnlt');\n\n      if(!lnlt.length) {\n      lnlt = addElement();\n\n      // grab the special div we generated in the beginning\n      // and put the mousmove output there\n\n      map.on('mousemove', function (e) {\n      if (e.originalEvent.ctrlKey) {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                           ' lon: ' + (e.latlng.lng).toFixed(5) +\n                           ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                           ' | zoom: ' + map.getZoom() +\n                           ' | x: ' + L.CRS.EPSG3857.project(e.latlng).x.toFixed(0) +\n                           ' | y: ' + L.CRS.EPSG3857.project(e.latlng).y.toFixed(0) +\n                           ' | epsg: 3857 ' +\n                           ' | proj4: +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs ');\n      } else {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                      ' | zoom: ' + map.getZoom() + ' ');\n      }\n      });\n\n      // remove the lnlt div when mouse leaves map\n      map.on('mouseout', function (e) {\n      var strip = document.querySelector('.lnlt');\n      if( strip !==null) strip.remove();\n      });\n\n      };\n\n      //$(el).keypress(67, function(e) {\n      map.on('preclick', function(e) {\n      if (e.originalEvent.ctrlKey) {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                      ' | zoom: ' + map.getZoom() + ' ');\n      var txt = document.querySelector('.lnlt').textContent;\n      console.log(txt);\n      //txt.innerText.focus();\n      //txt.select();\n      setClipboardText('\"' + txt + '\"');\n      }\n      });\n\n      }\n      ).call(this.getMap(), el, x, data);\n}","data":null},{"code":"function(el, x, data) {\n  return (function(el,x,data){\n           var map = this;\n\n           map.on('keypress', function(e) {\n               console.log(e.originalEvent.code);\n               var key = e.originalEvent.code;\n               if (key === 'KeyE') {\n                   var bb = this.getBounds();\n                   var txt = JSON.stringify(bb);\n                   console.log(txt);\n\n                   setClipboardText('\\'' + txt + '\\'');\n               }\n           })\n        }).call(this.getMap(), el, x, data);\n}","data":null}]}}</script>
</div>
<div id="trn_dta" class="section level4 hasAnchor" number="4.2.1.5">
<h4><span class="header-section-number">4.2.1.5</span> Augment training data<a href="validate-tree-detection-and-crown-delineation.html#trn_dta" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>While the map above shows that the training and evaluation data are in places that we expect to have conifers, the spatial coverage of training data is limited. This is especially true when one considers that even NEON sites that are close in proximity can have very different forest types. For example, the “TEAK” site east of Fresno, CA has both training and evaluation data and features vegetation described as “dominant tree species include red and white ﬁr (<em>Abies magniﬁca</em> and <em>Abies concolor</em>), Jeﬀrey pine (<em>Pinus jeﬀreyi</em>), and lodgepole pine (<em>Pinus contorta</em>)” (<a href="https://www.neonscience.org/field-sites/teak">source</a>). While the “SOAP” site that is close in proximity and lacks training data has vegetation described as “Ponderosa pine (<em>Pinus ponderosa</em>) and incense cedar (<em>Calocedrus decurrens</em>) dominate the overstory” (<a href="https://www.neonscience.org/field-sites/soap">source</a>).</p>
<p>We will augment the training data by NEON site to validate against the image annotated crown ground truth using <code>NeonTreeEvaluation::evaluate_image_crowns()</code> by:</p>
<ul>
<li>if a site has image annotated crowns marked as training data, use those plots</li>
<li>otherwise, if a site has at least 5 image annotated crown evaluation data sets borrow two plots to validate against</li>
<li>otherwise, if a site has at least 4 image annotated crown evaluation data sets borrow one plot to validate against</li>
</ul>
<p>We will augment the training data by NEON site to validate against the field collected stems ground truth using <code>NeonTreeEvaluation::evaluate_field_stems()</code> by:</p>
<ul>
<li>if a site has at least 5 field collected stem validation data sets, borrow two plots to validate against even if the site has image annotated crowns marked as out-of-box training data</li>
<li>otherwise, if a site has at least 4 field collected stem evaluation data sets, borrow one plot to validate against</li>
</ul>
<p>We will then use the results of the validation based on the training data to select the best variable window search function based on the precision and recall metrics by NEON site. If a NEON site does not have training data the best overall variable window function will be used.</p>
<div class="sourceCode" id="cb206"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb206-1"><a href="validate-tree-detection-and-crown-delineation.html#cb206-1" tabindex="-1"></a><span class="co"># set seed to replicate results</span></span>
<span id="cb206-2"><a href="validate-tree-detection-and-crown-delineation.html#cb206-2" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">444</span>)</span>
<span id="cb206-3"><a href="validate-tree-detection-and-crown-delineation.html#cb206-3" tabindex="-1"></a><span class="co"># randomly assign plots as training:</span></span>
<span id="cb206-4"><a href="validate-tree-detection-and-crown-delineation.html#cb206-4" tabindex="-1"></a>lidar_df <span class="ot">&lt;-</span></span>
<span id="cb206-5"><a href="validate-tree-detection-and-crown-delineation.html#cb206-5" tabindex="-1"></a>  lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb206-6"><a href="validate-tree-detection-and-crown-delineation.html#cb206-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb206-7"><a href="validate-tree-detection-and-crown-delineation.html#cb206-7" tabindex="-1"></a>  <span class="co"># generate rand</span></span>
<span id="cb206-8"><a href="validate-tree-detection-and-crown-delineation.html#cb206-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">rand =</span> <span class="fu">runif</span>(<span class="at">n=</span>dplyr<span class="sc">::</span><span class="fu">n</span>())) <span class="sc">%&gt;%</span> </span>
<span id="cb206-9"><a href="validate-tree-detection-and-crown-delineation.html#cb206-9" tabindex="-1"></a>  <span class="co"># count training/eval by site and flag new training</span></span>
<span id="cb206-10"><a href="validate-tree-detection-and-crown-delineation.html#cb206-10" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(siteID) <span class="sc">%&gt;%</span> </span>
<span id="cb206-11"><a href="validate-tree-detection-and-crown-delineation.html#cb206-11" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb206-12"><a href="validate-tree-detection-and-crown-delineation.html#cb206-12" tabindex="-1"></a>    <span class="at">training_plots =</span> <span class="fu">sum</span>(<span class="fu">ifelse</span>(data_type<span class="sc">==</span><span class="st">&quot;training&quot;</span>,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb206-13"><a href="validate-tree-detection-and-crown-delineation.html#cb206-13" tabindex="-1"></a>    , <span class="at">evaluation_ann_plots =</span> <span class="fu">sum</span>(<span class="fu">ifelse</span>(has_image_annotation <span class="sc">&amp;</span> data_type<span class="sc">==</span><span class="st">&quot;evaluation&quot;</span>,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb206-14"><a href="validate-tree-detection-and-crown-delineation.html#cb206-14" tabindex="-1"></a>    , <span class="at">evaluation_fld_plots =</span> <span class="fu">sum</span>(<span class="fu">ifelse</span>(has_field_stems <span class="sc">&amp;</span> data_type<span class="sc">==</span><span class="st">&quot;evaluation&quot;</span>,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb206-15"><a href="validate-tree-detection-and-crown-delineation.html#cb206-15" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb206-16"><a href="validate-tree-detection-and-crown-delineation.html#cb206-16" tabindex="-1"></a>  <span class="co"># sample img annotated data</span></span>
<span id="cb206-17"><a href="validate-tree-detection-and-crown-delineation.html#cb206-17" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(siteID, has_image_annotation, rand) <span class="sc">%&gt;%</span> </span>
<span id="cb206-18"><a href="validate-tree-detection-and-crown-delineation.html#cb206-18" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(siteID,has_image_annotation) <span class="sc">%&gt;%</span> </span>
<span id="cb206-19"><a href="validate-tree-detection-and-crown-delineation.html#cb206-19" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb206-20"><a href="validate-tree-detection-and-crown-delineation.html#cb206-20" tabindex="-1"></a>    <span class="at">is_new_image_annotation_training =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb206-21"><a href="validate-tree-detection-and-crown-delineation.html#cb206-21" tabindex="-1"></a>      training_plots <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb206-22"><a href="validate-tree-detection-and-crown-delineation.html#cb206-22" tabindex="-1"></a>        evaluation_ann_plots<span class="sc">&gt;=</span><span class="dv">5</span> <span class="sc">&amp;</span> </span>
<span id="cb206-23"><a href="validate-tree-detection-and-crown-delineation.html#cb206-23" tabindex="-1"></a>        has_image_annotation <span class="sc">==</span> T <span class="sc">&amp;</span></span>
<span id="cb206-24"><a href="validate-tree-detection-and-crown-delineation.html#cb206-24" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">row_number</span>()<span class="sc">&lt;=</span><span class="dv">2</span> <span class="sc">~</span> T</span>
<span id="cb206-25"><a href="validate-tree-detection-and-crown-delineation.html#cb206-25" tabindex="-1"></a>      , training_plots <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb206-26"><a href="validate-tree-detection-and-crown-delineation.html#cb206-26" tabindex="-1"></a>        evaluation_ann_plots<span class="sc">&gt;=</span><span class="dv">4</span> <span class="sc">&amp;</span> </span>
<span id="cb206-27"><a href="validate-tree-detection-and-crown-delineation.html#cb206-27" tabindex="-1"></a>        has_image_annotation <span class="sc">==</span> T <span class="sc">&amp;</span></span>
<span id="cb206-28"><a href="validate-tree-detection-and-crown-delineation.html#cb206-28" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">row_number</span>()<span class="sc">&lt;=</span><span class="dv">1</span> <span class="sc">~</span> T</span>
<span id="cb206-29"><a href="validate-tree-detection-and-crown-delineation.html#cb206-29" tabindex="-1"></a>      , T <span class="sc">~</span> F</span>
<span id="cb206-30"><a href="validate-tree-detection-and-crown-delineation.html#cb206-30" tabindex="-1"></a>    )</span>
<span id="cb206-31"><a href="validate-tree-detection-and-crown-delineation.html#cb206-31" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb206-32"><a href="validate-tree-detection-and-crown-delineation.html#cb206-32" tabindex="-1"></a>  <span class="co"># sample fld stems data</span></span>
<span id="cb206-33"><a href="validate-tree-detection-and-crown-delineation.html#cb206-33" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(siteID, has_field_stems, rand) <span class="sc">%&gt;%</span> </span>
<span id="cb206-34"><a href="validate-tree-detection-and-crown-delineation.html#cb206-34" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(siteID,has_field_stems) <span class="sc">%&gt;%</span> </span>
<span id="cb206-35"><a href="validate-tree-detection-and-crown-delineation.html#cb206-35" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb206-36"><a href="validate-tree-detection-and-crown-delineation.html#cb206-36" tabindex="-1"></a>    <span class="at">is_new_field_stems_training =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb206-37"><a href="validate-tree-detection-and-crown-delineation.html#cb206-37" tabindex="-1"></a>      evaluation_fld_plots<span class="sc">&gt;=</span><span class="dv">5</span> <span class="sc">&amp;</span> </span>
<span id="cb206-38"><a href="validate-tree-detection-and-crown-delineation.html#cb206-38" tabindex="-1"></a>        has_field_stems <span class="sc">==</span> T <span class="sc">&amp;</span></span>
<span id="cb206-39"><a href="validate-tree-detection-and-crown-delineation.html#cb206-39" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">row_number</span>()<span class="sc">&lt;=</span><span class="dv">2</span> <span class="sc">~</span> T</span>
<span id="cb206-40"><a href="validate-tree-detection-and-crown-delineation.html#cb206-40" tabindex="-1"></a>      , evaluation_fld_plots<span class="sc">&gt;=</span><span class="dv">4</span> <span class="sc">&amp;</span> </span>
<span id="cb206-41"><a href="validate-tree-detection-and-crown-delineation.html#cb206-41" tabindex="-1"></a>        has_field_stems <span class="sc">==</span> T <span class="sc">&amp;</span></span>
<span id="cb206-42"><a href="validate-tree-detection-and-crown-delineation.html#cb206-42" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">row_number</span>()<span class="sc">&lt;=</span><span class="dv">1</span> <span class="sc">~</span> T</span>
<span id="cb206-43"><a href="validate-tree-detection-and-crown-delineation.html#cb206-43" tabindex="-1"></a>      , T <span class="sc">~</span> F</span>
<span id="cb206-44"><a href="validate-tree-detection-and-crown-delineation.html#cb206-44" tabindex="-1"></a>    )</span>
<span id="cb206-45"><a href="validate-tree-detection-and-crown-delineation.html#cb206-45" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb206-46"><a href="validate-tree-detection-and-crown-delineation.html#cb206-46" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb206-47"><a href="validate-tree-detection-and-crown-delineation.html#cb206-47" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(rand,tot,conifer,tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_plots&quot;</span>)))</span></code></pre></div>
<p>check our new table of training/evaluation data by NEON site after we augmented the training data</p>
<div class="sourceCode" id="cb207"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb207-1"><a href="validate-tree-detection-and-crown-delineation.html#cb207-1" tabindex="-1"></a>lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb207-2"><a href="validate-tree-detection-and-crown-delineation.html#cb207-2" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb207-3"><a href="validate-tree-detection-and-crown-delineation.html#cb207-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(siteID) <span class="sc">%&gt;%</span> </span>
<span id="cb207-4"><a href="validate-tree-detection-and-crown-delineation.html#cb207-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb207-5"><a href="validate-tree-detection-and-crown-delineation.html#cb207-5" tabindex="-1"></a>    <span class="at">n =</span> dplyr<span class="sc">::</span><span class="fu">n</span>()</span>
<span id="cb207-6"><a href="validate-tree-detection-and-crown-delineation.html#cb207-6" tabindex="-1"></a>    , <span class="at">training_plots =</span> <span class="fu">sum</span>(<span class="fu">ifelse</span>(data_type<span class="sc">==</span><span class="st">&quot;training&quot;</span>,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb207-7"><a href="validate-tree-detection-and-crown-delineation.html#cb207-7" tabindex="-1"></a>    <span class="co"># validation type</span></span>
<span id="cb207-8"><a href="validate-tree-detection-and-crown-delineation.html#cb207-8" tabindex="-1"></a>    , <span class="at">ann_plots =</span> <span class="fu">sum</span>(<span class="fu">ifelse</span>(has_image_annotation,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb207-9"><a href="validate-tree-detection-and-crown-delineation.html#cb207-9" tabindex="-1"></a>    , <span class="at">fld_plots =</span> <span class="fu">sum</span>(<span class="fu">ifelse</span>(has_field_stems,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb207-10"><a href="validate-tree-detection-and-crown-delineation.html#cb207-10" tabindex="-1"></a>    <span class="co"># training/eval</span></span>
<span id="cb207-11"><a href="validate-tree-detection-and-crown-delineation.html#cb207-11" tabindex="-1"></a>    , <span class="at">training_ann_plots =</span> <span class="fu">sum</span>(<span class="fu">ifelse</span>(has_image_annotation <span class="sc">&amp;</span> (is_new_image_annotation_training <span class="sc">|</span> data_type<span class="sc">==</span><span class="st">&quot;training&quot;</span>),<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb207-12"><a href="validate-tree-detection-and-crown-delineation.html#cb207-12" tabindex="-1"></a>    , <span class="at">training_fld_plots =</span> <span class="fu">sum</span>(<span class="fu">ifelse</span>(has_field_stems <span class="sc">&amp;</span> (is_new_field_stems_training <span class="sc">|</span> data_type<span class="sc">==</span><span class="st">&quot;training&quot;</span>),<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb207-13"><a href="validate-tree-detection-and-crown-delineation.html#cb207-13" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb207-14"><a href="validate-tree-detection-and-crown-delineation.html#cb207-14" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb207-15"><a href="validate-tree-detection-and-crown-delineation.html#cb207-15" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb207-16"><a href="validate-tree-detection-and-crown-delineation.html#cb207-16" tabindex="-1"></a>    <span class="co"># training/eval</span></span>
<span id="cb207-17"><a href="validate-tree-detection-and-crown-delineation.html#cb207-17" tabindex="-1"></a>    <span class="at">eval_ann_plots =</span> ann_plots<span class="sc">-</span>training_ann_plots</span>
<span id="cb207-18"><a href="validate-tree-detection-and-crown-delineation.html#cb207-18" tabindex="-1"></a>    , <span class="at">eval_fld_plots =</span> fld_plots<span class="sc">-</span>training_fld_plots</span>
<span id="cb207-19"><a href="validate-tree-detection-and-crown-delineation.html#cb207-19" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb207-20"><a href="validate-tree-detection-and-crown-delineation.html#cb207-20" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb207-21"><a href="validate-tree-detection-and-crown-delineation.html#cb207-21" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(n,ann_plots,fld_plots)) <span class="sc">%&gt;%</span> </span>
<span id="cb207-22"><a href="validate-tree-detection-and-crown-delineation.html#cb207-22" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(</span>
<span id="cb207-23"><a href="validate-tree-detection-and-crown-delineation.html#cb207-23" tabindex="-1"></a>    <span class="fu">c</span>(tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;ann_plots&quot;</span>),tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;fld_plots&quot;</span>))</span>
<span id="cb207-24"><a href="validate-tree-detection-and-crown-delineation.html#cb207-24" tabindex="-1"></a>    ,<span class="at">.after =</span> dplyr<span class="sc">::</span><span class="fu">last_col</span>()</span>
<span id="cb207-25"><a href="validate-tree-detection-and-crown-delineation.html#cb207-25" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb207-26"><a href="validate-tree-detection-and-crown-delineation.html#cb207-26" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(</span>
<span id="cb207-27"><a href="validate-tree-detection-and-crown-delineation.html#cb207-27" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">&quot;NEON sites with conifers and lidar plots using augmented training data&quot;</span></span>
<span id="cb207-28"><a href="validate-tree-detection-and-crown-delineation.html#cb207-28" tabindex="-1"></a>    , <span class="at">col.names =</span> <span class="fu">c</span>(</span>
<span id="cb207-29"><a href="validate-tree-detection-and-crown-delineation.html#cb207-29" tabindex="-1"></a>      <span class="st">&quot;site&quot;</span>,<span class="st">&quot;original&lt;br&gt;training plots&quot;</span></span>
<span id="cb207-30"><a href="validate-tree-detection-and-crown-delineation.html#cb207-30" tabindex="-1"></a>      ,<span class="st">&quot;training plots&quot;</span>,<span class="st">&quot;evaluation plots&quot;</span></span>
<span id="cb207-31"><a href="validate-tree-detection-and-crown-delineation.html#cb207-31" tabindex="-1"></a>      ,<span class="st">&quot;training plots&quot;</span>,<span class="st">&quot;evaluation plots&quot;</span></span>
<span id="cb207-32"><a href="validate-tree-detection-and-crown-delineation.html#cb207-32" tabindex="-1"></a>    )</span>
<span id="cb207-33"><a href="validate-tree-detection-and-crown-delineation.html#cb207-33" tabindex="-1"></a>    , <span class="at">escape =</span> F</span>
<span id="cb207-34"><a href="validate-tree-detection-and-crown-delineation.html#cb207-34" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb207-35"><a href="validate-tree-detection-and-crown-delineation.html#cb207-35" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb207-36"><a href="validate-tree-detection-and-crown-delineation.html#cb207-36" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">add_header_above</span>(</span>
<span id="cb207-37"><a href="validate-tree-detection-and-crown-delineation.html#cb207-37" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">&quot; &quot;</span><span class="ot">=</span><span class="dv">2</span>, <span class="st">&quot;image annotated crowns&quot;</span> <span class="ot">=</span> <span class="dv">2</span>, <span class="st">&quot;field collected stems&quot;</span> <span class="ot">=</span> <span class="dv">2</span>)</span>
<span id="cb207-38"><a href="validate-tree-detection-and-crown-delineation.html#cb207-38" tabindex="-1"></a>  )</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-186">Table 4.4: </span>NEON sites with conifers and lidar plots using augmented training data
</caption>
<thead>
<tr>
<th style="empty-cells: hide;border-bottom:hidden;" colspan="2">
</th>
<th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="2">
<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
image annotated crowns
</div>
</th>
<th style="border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="2">
<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
field collected stems
</div>
</th>
</tr>
<tr>
<th style="text-align:left;">
site
</th>
<th style="text-align:right;">
original<br>training plots
</th>
<th style="text-align:right;">
training plots
</th>
<th style="text-align:right;">
evaluation plots
</th>
<th style="text-align:right;">
training plots
</th>
<th style="text-align:right;">
evaluation plots
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
OSBS
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
14
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
44
</td>
</tr>
<tr>
<td style="text-align:left;">
TEAK
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
51
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
NIWO
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
39
</td>
</tr>
<tr>
<td style="text-align:left;">
JERC
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
19
</td>
</tr>
<tr>
<td style="text-align:left;">
TALL
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
20
</td>
</tr>
<tr>
<td style="text-align:left;">
ABBY
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
11
</td>
</tr>
<tr>
<td style="text-align:left;">
DEJU
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
12
</td>
</tr>
<tr>
<td style="text-align:left;">
DSNY
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
MOAB
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:left;">
SOAP
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
ONAQ
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="ht_filter" class="section level3 hasAnchor" number="4.2.2">
<h3><span class="header-section-number">4.2.2</span> Height threshold for “canopy” trees<a href="validate-tree-detection-and-crown-delineation.html#ht_filter" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We’ll process the point cloud and get a tree list using our <code>cloud2trees::cloud2trees()</code> method with all default settings except for the ITD window function (see section below). However, an important consideration in the evaluation of our method is that the Weinstein et al. (<a href="https://scholar.google.com/scholar?cluster=4986448711981898434&amp;hl=en&amp;as_sdt=0,6">2021</a>) benchmark was developed specifically for “canopy” trees and the field-collected stems evaluation data only includes &gt;10 cm DBH trees:</p>
<blockquote>
<p>NEON field crews sample all trees within a plot that are greater than 10cm DBH, regardless of whether the tree crown can be seen in the remote sensing image data. While understory tree detection is an important area of future work, the scope of this benchmark is focused on crowns in the canopy that are visible from above. (p. 10)</p>
</blockquote>
<p>In order to align our point cloud-based algorithm with the evaluation data inclusion of only “canopy” trees, we’ll identify the shortest live tree in the field-collected stems evaluation data by NEON site. We’ll use this value to filter our <code>cloud2trees::cloud2trees()</code> tree list in post-processing. This filtering process is analogous to setting a diameter threshold during a forest inventory (e.g. &gt;10 cm DBH), meaning only trees with a DBH of 10 cm, for example, or greater are tallied and measured which a common practice because it focuses on trees that are potentially merchantable.</p>
<p>In working with the <code>NeonTreeEvaluation::field</code> data we’ll use the filters found in <code>clean_field_data()</code> from <a href="https://github.com/weecology/NeonTreeEvaluation_package/blob/724bdb0a9a3ea6433450f62c69a8fadce9ccdb66/R/evaluate_field_stems.R"><code>NeonTreeEvaluation</code></a> as an internal function</p>
<div class="sourceCode" id="cb208"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb208-1"><a href="validate-tree-detection-and-crown-delineation.html#cb208-1" tabindex="-1"></a><span class="co"># set the percentile to determine the shortest live tree in the field-collected stems evaluation data</span></span>
<span id="cb208-2"><a href="validate-tree-detection-and-crown-delineation.html#cb208-2" tabindex="-1"></a><span class="co"># using a percentile helps to avoid outlier measurements that might occur if we used a minimum value</span></span>
<span id="cb208-3"><a href="validate-tree-detection-and-crown-delineation.html#cb208-3" tabindex="-1"></a>percentile_for_ht <span class="ot">&lt;-</span> <span class="fl">0.05</span></span>
<span id="cb208-4"><a href="validate-tree-detection-and-crown-delineation.html#cb208-4" tabindex="-1"></a><span class="co"># get non-na heights from neon field measured trees</span></span>
<span id="cb208-5"><a href="validate-tree-detection-and-crown-delineation.html#cb208-5" tabindex="-1"></a>neon_field_heights <span class="ot">&lt;-</span></span>
<span id="cb208-6"><a href="validate-tree-detection-and-crown-delineation.html#cb208-6" tabindex="-1"></a>  NeonTreeEvaluation<span class="sc">::</span>field <span class="sc">%&gt;%</span> </span>
<span id="cb208-7"><a href="validate-tree-detection-and-crown-delineation.html#cb208-7" tabindex="-1"></a>  <span class="co"># filters found in `clean_field_data()`</span></span>
<span id="cb208-8"><a href="validate-tree-detection-and-crown-delineation.html#cb208-8" tabindex="-1"></a>  <span class="fu">clean_field_data</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb208-9"><a href="validate-tree-detection-and-crown-delineation.html#cb208-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(height) <span class="sc">&amp;</span> height<span class="sc">&gt;</span><span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb208-10"><a href="validate-tree-detection-and-crown-delineation.html#cb208-10" tabindex="-1"></a>  <span class="co"># and finally, filter for our conifer sites only</span></span>
<span id="cb208-11"><a href="validate-tree-detection-and-crown-delineation.html#cb208-11" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb208-12"><a href="validate-tree-detection-and-crown-delineation.html#cb208-12" tabindex="-1"></a>    conifer_sites <span class="sc">%&gt;%</span> </span>
<span id="cb208-13"><a href="validate-tree-detection-and-crown-delineation.html#cb208-13" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(pct_conifer<span class="sc">&gt;</span>min_conifer_pct)</span>
<span id="cb208-14"><a href="validate-tree-detection-and-crown-delineation.html#cb208-14" tabindex="-1"></a>  )</span>
<span id="cb208-15"><a href="validate-tree-detection-and-crown-delineation.html#cb208-15" tabindex="-1"></a><span class="co"># get 5th tile ht by site</span></span>
<span id="cb208-16"><a href="validate-tree-detection-and-crown-delineation.html#cb208-16" tabindex="-1"></a>neon_site_heights <span class="ot">&lt;-</span> </span>
<span id="cb208-17"><a href="validate-tree-detection-and-crown-delineation.html#cb208-17" tabindex="-1"></a>  neon_field_heights <span class="sc">%&gt;%</span> </span>
<span id="cb208-18"><a href="validate-tree-detection-and-crown-delineation.html#cb208-18" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(siteID) <span class="sc">%&gt;%</span> </span>
<span id="cb208-19"><a href="validate-tree-detection-and-crown-delineation.html#cb208-19" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb208-20"><a href="validate-tree-detection-and-crown-delineation.html#cb208-20" tabindex="-1"></a>    <span class="at">site_prcntl_ht =</span> <span class="fu">quantile</span>(<span class="fu">floor</span>(height), <span class="at">probs =</span> percentile_for_ht, <span class="at">na.rm =</span> T)</span>
<span id="cb208-21"><a href="validate-tree-detection-and-crown-delineation.html#cb208-21" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb208-22"><a href="validate-tree-detection-and-crown-delineation.html#cb208-22" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>()</span></code></pre></div>
<p>look at the summary of height data across all sites and plots</p>
<div class="sourceCode" id="cb209"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb209-1"><a href="validate-tree-detection-and-crown-delineation.html#cb209-1" tabindex="-1"></a><span class="fu">summary</span>(neon_field_heights<span class="sc">$</span>height)</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##    3.10    9.60   12.80   13.72   16.40   53.90</code></pre>
<p>what does this look like for each NEON site?</p>
<div class="sourceCode" id="cb211"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb211-1"><a href="validate-tree-detection-and-crown-delineation.html#cb211-1" tabindex="-1"></a>neon_field_heights <span class="sc">%&gt;%</span> </span>
<span id="cb211-2"><a href="validate-tree-detection-and-crown-delineation.html#cb211-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(neon_site_heights, <span class="at">by =</span> <span class="st">&quot;siteID&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb211-3"><a href="validate-tree-detection-and-crown-delineation.html#cb211-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> height, <span class="at">group =</span> siteID)) <span class="sc">+</span></span>
<span id="cb211-4"><a href="validate-tree-detection-and-crown-delineation.html#cb211-4" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(<span class="at">color =</span> <span class="st">&quot;gold&quot;</span>,<span class="at">fill =</span> <span class="st">&quot;gold&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">lwd =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb211-5"><a href="validate-tree-detection-and-crown-delineation.html#cb211-5" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> site_prcntl_ht), <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span></span>
<span id="cb211-6"><a href="validate-tree-detection-and-crown-delineation.html#cb211-6" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="at">facets =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(siteID), <span class="at">ncol =</span> <span class="dv">6</span>, <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>) <span class="sc">+</span></span>
<span id="cb211-7"><a href="validate-tree-detection-and-crown-delineation.html#cb211-7" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="dv">6</span>)) <span class="sc">+</span></span>
<span id="cb211-8"><a href="validate-tree-detection-and-crown-delineation.html#cb211-8" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb211-9"><a href="validate-tree-detection-and-crown-delineation.html#cb211-9" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">&quot;height (m)&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb211-10"><a href="validate-tree-detection-and-crown-delineation.html#cb211-10" tabindex="-1"></a>      , <span class="at">subtitle =</span> <span class="fu">paste0</span>(</span>
<span id="cb211-11"><a href="validate-tree-detection-and-crown-delineation.html#cb211-11" tabindex="-1"></a>        <span class="st">&quot;field-collected heights of </span><span class="sc">\&quot;</span><span class="st">canopy</span><span class="sc">\&quot;</span><span class="st"> trees in conifer NEON sites with &quot;</span></span>
<span id="cb211-12"><a href="validate-tree-detection-and-crown-delineation.html#cb211-12" tabindex="-1"></a>        , scales<span class="sc">::</span><span class="fu">number</span>(percentile_for_ht<span class="sc">*</span><span class="dv">100</span>, <span class="at">accuracy =</span> <span class="dv">1</span>)</span>
<span id="cb211-13"><a href="validate-tree-detection-and-crown-delineation.html#cb211-13" tabindex="-1"></a>        , <span class="st">&quot;th percentile by site&quot;</span></span>
<span id="cb211-14"><a href="validate-tree-detection-and-crown-delineation.html#cb211-14" tabindex="-1"></a>      )</span>
<span id="cb211-15"><a href="validate-tree-detection-and-crown-delineation.html#cb211-15" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb211-16"><a href="validate-tree-detection-and-crown-delineation.html#cb211-16" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb211-17"><a href="validate-tree-detection-and-crown-delineation.html#cb211-17" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb211-18"><a href="validate-tree-detection-and-crown-delineation.html#cb211-18" tabindex="-1"></a>      <span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb211-19"><a href="validate-tree-detection-and-crown-delineation.html#cb211-19" tabindex="-1"></a>      , <span class="at">axis.ticks.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb211-20"><a href="validate-tree-detection-and-crown-delineation.html#cb211-20" tabindex="-1"></a>      , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb211-21"><a href="validate-tree-detection-and-crown-delineation.html#cb211-21" tabindex="-1"></a>    )</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-190-1.png" width="1008" /></p>
<p>what is the overall 5th percentile to use for minimum height?</p>
<div class="sourceCode" id="cb212"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb212-1"><a href="validate-tree-detection-and-crown-delineation.html#cb212-1" tabindex="-1"></a>(neon_min_ht <span class="ot">&lt;-</span> <span class="fu">quantile</span>(neon_field_heights<span class="sc">$</span>height, <span class="at">probs =</span> percentile_for_ht) <span class="sc">%&gt;%</span> <span class="fu">floor</span>())</span></code></pre></div>
<pre><code>## 5% 
##  5</code></pre>
<p>let’s attach this to our data frame of lidar data files</p>
<div class="sourceCode" id="cb214"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb214-1"><a href="validate-tree-detection-and-crown-delineation.html#cb214-1" tabindex="-1"></a>lidar_df <span class="ot">&lt;-</span> lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb214-2"><a href="validate-tree-detection-and-crown-delineation.html#cb214-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(neon_site_heights, <span class="at">by =</span> <span class="st">&quot;siteID&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb214-3"><a href="validate-tree-detection-and-crown-delineation.html#cb214-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb214-4"><a href="validate-tree-detection-and-crown-delineation.html#cb214-4" tabindex="-1"></a>   <span class="at">site_prcntl_ht =</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(site_prcntl_ht,neon_min_ht)</span>
<span id="cb214-5"><a href="validate-tree-detection-and-crown-delineation.html#cb214-5" tabindex="-1"></a>   , <span class="at">plot_name_sans_yr =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb214-6"><a href="validate-tree-detection-and-crown-delineation.html#cb214-6" tabindex="-1"></a>     stringr<span class="sc">::</span><span class="fu">str_ends</span>(plot_name,<span class="st">&quot;_20</span><span class="sc">\\</span><span class="st">d{2}$&quot;</span>) <span class="sc">~</span> stringr<span class="sc">::</span><span class="fu">str_match</span>(plot_name,<span class="st">&quot;(</span><span class="sc">\\</span><span class="st">w+)_</span><span class="sc">\\</span><span class="st">d+&quot;</span>)[,<span class="dv">2</span>]</span>
<span id="cb214-7"><a href="validate-tree-detection-and-crown-delineation.html#cb214-7" tabindex="-1"></a>     , T <span class="sc">~</span> plot_name</span>
<span id="cb214-8"><a href="validate-tree-detection-and-crown-delineation.html#cb214-8" tabindex="-1"></a>   )</span>
<span id="cb214-9"><a href="validate-tree-detection-and-crown-delineation.html#cb214-9" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb214-10"><a href="validate-tree-detection-and-crown-delineation.html#cb214-10" tabindex="-1"></a>  <span class="co"># create a count by plot name sans year for use later ;/</span></span>
<span id="cb214-11"><a href="validate-tree-detection-and-crown-delineation.html#cb214-11" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(plot_name, plot_name_sans_yr, has_field_stems) <span class="sc">%&gt;%</span> </span>
<span id="cb214-12"><a href="validate-tree-detection-and-crown-delineation.html#cb214-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(plot_name_sans_yr, has_field_stems) <span class="sc">%&gt;%</span> </span>
<span id="cb214-13"><a href="validate-tree-detection-and-crown-delineation.html#cb214-13" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">plot_name_sans_yr_grp =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb214-14"><a href="validate-tree-detection-and-crown-delineation.html#cb214-14" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(plot_name_sans_yr) <span class="sc">%&gt;%</span> </span>
<span id="cb214-15"><a href="validate-tree-detection-and-crown-delineation.html#cb214-15" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">plot_has_multiple_years =</span> <span class="fu">max</span>(plot_name_sans_yr_grp)<span class="sc">&gt;</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb214-16"><a href="validate-tree-detection-and-crown-delineation.html#cb214-16" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>()</span>
<span id="cb214-17"><a href="validate-tree-detection-and-crown-delineation.html#cb214-17" tabindex="-1"></a><span class="co"># dplyr::glimpse(lidar_df)</span></span>
<span id="cb214-18"><a href="validate-tree-detection-and-crown-delineation.html#cb214-18" tabindex="-1"></a><span class="co"># save</span></span>
<span id="cb214-19"><a href="validate-tree-detection-and-crown-delineation.html#cb214-19" tabindex="-1"></a>readr<span class="sc">::</span><span class="fu">write_csv</span>(lidar_df, <span class="st">&quot;../data/NeonTreeEvaluation_lidar_df.csv&quot;</span>, <span class="at">append =</span> F, <span class="at">progress =</span> F)</span></code></pre></div>
</div>
<div id="ex_valid" class="section level3 hasAnchor" number="4.2.3">
<h3><span class="header-section-number">4.2.3</span> Example validation process<a href="validate-tree-detection-and-crown-delineation.html#ex_valid" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>now that we have our lidar data list and post-processing height filter that we can test our point cloud-based tree detection and crown segmentation process against, let’s walk through the validation for a single point cloud</p>
<p>we’ll test with a single evaluation point cloud</p>
<div class="sourceCode" id="cb215"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb215-1"><a href="validate-tree-detection-and-crown-delineation.html#cb215-1" tabindex="-1"></a>lidar_df_row <span class="ot">&lt;-</span> lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb215-2"><a href="validate-tree-detection-and-crown-delineation.html#cb215-2" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb215-3"><a href="validate-tree-detection-and-crown-delineation.html#cb215-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb215-4"><a href="validate-tree-detection-and-crown-delineation.html#cb215-4" tabindex="-1"></a>    <span class="at">rn =</span> <span class="fu">ifelse</span>(</span>
<span id="cb215-5"><a href="validate-tree-detection-and-crown-delineation.html#cb215-5" tabindex="-1"></a>      data_type<span class="sc">==</span><span class="st">&quot;evaluation&quot;</span> <span class="sc">&amp;</span> has_image_annotation <span class="sc">&amp;</span> has_field_stems</span>
<span id="cb215-6"><a href="validate-tree-detection-and-crown-delineation.html#cb215-6" tabindex="-1"></a>      ,dplyr<span class="sc">::</span><span class="fu">row_number</span>()</span>
<span id="cb215-7"><a href="validate-tree-detection-and-crown-delineation.html#cb215-7" tabindex="-1"></a>      ,<span class="cn">NA</span></span>
<span id="cb215-8"><a href="validate-tree-detection-and-crown-delineation.html#cb215-8" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span> </span>
<span id="cb215-9"><a href="validate-tree-detection-and-crown-delineation.html#cb215-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(rn)) <span class="sc">%&gt;%</span> </span>
<span id="cb215-10"><a href="validate-tree-detection-and-crown-delineation.html#cb215-10" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb215-11"><a href="validate-tree-detection-and-crown-delineation.html#cb215-11" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(rn)</span>
<span id="cb215-12"><a href="validate-tree-detection-and-crown-delineation.html#cb215-12" tabindex="-1"></a><span class="co"># lidar_df$f_path[lidar_df_row] %&gt;% lidR::readLAS() %&gt;% lidR::st_crs()</span></span></code></pre></div>
<div id="view-the-point-cloud" class="section level4 hasAnchor" number="4.2.3.1">
<h4><span class="header-section-number">4.2.3.1</span> View the point cloud<a href="validate-tree-detection-and-crown-delineation.html#view-the-point-cloud" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This step isn’t necessary for validation, but let’s see what this point cloud data looks like. We can plot the point cloud with and color by the point height</p>
<div class="sourceCode" id="cb216"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb216-1"><a href="validate-tree-detection-and-crown-delineation.html#cb216-1" tabindex="-1"></a>lidar_df<span class="sc">$</span>f_path[lidar_df_row] <span class="sc">%&gt;%</span> </span>
<span id="cb216-2"><a href="validate-tree-detection-and-crown-delineation.html#cb216-2" tabindex="-1"></a>  lidR<span class="sc">::</span><span class="fu">readLAS</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb216-3"><a href="validate-tree-detection-and-crown-delineation.html#cb216-3" tabindex="-1"></a>  lidR<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb216-4"><a href="validate-tree-detection-and-crown-delineation.html#cb216-4" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">&quot;Z&quot;</span>, <span class="at">breaks =</span> <span class="st">&quot;quantile&quot;</span>, <span class="at">bg =</span> <span class="st">&quot;white&quot;</span>, <span class="at">legend =</span> T</span>
<span id="cb216-5"><a href="validate-tree-detection-and-crown-delineation.html#cb216-5" tabindex="-1"></a>   , <span class="at">pal =</span> harrypotter<span class="sc">::</span><span class="fu">hp</span>(<span class="at">n=</span><span class="dv">50</span>, <span class="at">house =</span> <span class="st">&quot;gryffindor&quot;</span>)</span>
<span id="cb216-6"><a href="validate-tree-detection-and-crown-delineation.html#cb216-6" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-195-1.png" width="1008" /></p>
<p>there are trees in there for sure (and conifer trees by the looks of it)</p>
<p>let’s look at the RGB imagery and image annotated crowns (notice that the <code>NeonTreeEvaluation</code> commands rely on the deprecated <code>raster</code> package :/ )</p>
<div class="sourceCode" id="cb217"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb217-1"><a href="validate-tree-detection-and-crown-delineation.html#cb217-1" tabindex="-1"></a><span class="co"># read rgb</span></span>
<span id="cb217-2"><a href="validate-tree-detection-and-crown-delineation.html#cb217-2" tabindex="-1"></a>rgb_temp <span class="ot">&lt;-</span> lidar_df<span class="sc">$</span>plot_name[lidar_df_row] <span class="sc">%&gt;%</span></span>
<span id="cb217-3"><a href="validate-tree-detection-and-crown-delineation.html#cb217-3" tabindex="-1"></a>  NeonTreeEvaluation<span class="sc">::</span><span class="fu">get_data</span>(<span class="at">type =</span> <span class="st">&quot;rgb&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb217-4"><a href="validate-tree-detection-and-crown-delineation.html#cb217-4" tabindex="-1"></a>  raster<span class="sc">::</span><span class="fu">stack</span>()</span>
<span id="cb217-5"><a href="validate-tree-detection-and-crown-delineation.html#cb217-5" tabindex="-1"></a></span>
<span id="cb217-6"><a href="validate-tree-detection-and-crown-delineation.html#cb217-6" tabindex="-1"></a><span class="co"># read image annotated crown data and make polygons</span></span>
<span id="cb217-7"><a href="validate-tree-detection-and-crown-delineation.html#cb217-7" tabindex="-1"></a>polys_temp <span class="ot">&lt;-</span></span>
<span id="cb217-8"><a href="validate-tree-detection-and-crown-delineation.html#cb217-8" tabindex="-1"></a>  lidar_df<span class="sc">$</span>plot_name[lidar_df_row] <span class="sc">%&gt;%</span></span>
<span id="cb217-9"><a href="validate-tree-detection-and-crown-delineation.html#cb217-9" tabindex="-1"></a>  NeonTreeEvaluation<span class="sc">::</span><span class="fu">get_data</span>(<span class="at">type =</span> <span class="st">&quot;annotations&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb217-10"><a href="validate-tree-detection-and-crown-delineation.html#cb217-10" tabindex="-1"></a>  NeonTreeEvaluation<span class="sc">::</span><span class="fu">xml_parse</span>() </span>
<span id="cb217-11"><a href="validate-tree-detection-and-crown-delineation.html#cb217-11" tabindex="-1"></a>polys_temp <span class="ot">&lt;-</span> NeonTreeEvaluation<span class="sc">::</span><span class="fu">boxes_to_spatial_polygons</span>(polys_temp,rgb_temp)</span>
<span id="cb217-12"><a href="validate-tree-detection-and-crown-delineation.html#cb217-12" tabindex="-1"></a></span>
<span id="cb217-13"><a href="validate-tree-detection-and-crown-delineation.html#cb217-13" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb217-14"><a href="validate-tree-detection-and-crown-delineation.html#cb217-14" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plotRGB</span>(rgb_temp <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">rast</span>())</span>
<span id="cb217-15"><a href="validate-tree-detection-and-crown-delineation.html#cb217-15" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb217-16"><a href="validate-tree-detection-and-crown-delineation.html#cb217-16" tabindex="-1"></a>  polys_temp <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb217-17"><a href="validate-tree-detection-and-crown-delineation.html#cb217-17" tabindex="-1"></a>  , <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">border =</span> <span class="st">&quot;red&quot;</span></span>
<span id="cb217-18"><a href="validate-tree-detection-and-crown-delineation.html#cb217-18" tabindex="-1"></a>  , <span class="at">lwd =</span> <span class="dv">2</span> , <span class="at">add =</span> <span class="cn">TRUE</span></span>
<span id="cb217-19"><a href="validate-tree-detection-and-crown-delineation.html#cb217-19" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-196-1.png" width="1008" /></p>
</div>
<div id="cloud2treescloud2trees" class="section level4 hasAnchor" number="4.2.3.2">
<h4><span class="header-section-number">4.2.3.2</span> <code>cloud2trees::cloud2trees()</code><a href="validate-tree-detection-and-crown-delineation.html#cloud2treescloud2trees" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>for our example, we’ll use all default settings in <code>cloud2trees::cloud2trees()</code> to get a point cloud-detected tree list</p>
<div class="sourceCode" id="cb218"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb218-1"><a href="validate-tree-detection-and-crown-delineation.html#cb218-1" tabindex="-1"></a>ans <span class="ot">&lt;-</span> cloud2trees<span class="sc">::</span><span class="fu">cloud2trees</span>(</span>
<span id="cb218-2"><a href="validate-tree-detection-and-crown-delineation.html#cb218-2" tabindex="-1"></a>  <span class="at">input_las_dir =</span> lidar_df<span class="sc">$</span>f_path[lidar_df_row]</span>
<span id="cb218-3"><a href="validate-tree-detection-and-crown-delineation.html#cb218-3" tabindex="-1"></a>  , <span class="at">output_dir =</span> <span class="fu">tempdir</span>()</span>
<span id="cb218-4"><a href="validate-tree-detection-and-crown-delineation.html#cb218-4" tabindex="-1"></a>)</span>
<span id="cb218-5"><a href="validate-tree-detection-and-crown-delineation.html#cb218-5" tabindex="-1"></a><span class="co"># filter the tree list based on the height threshold</span></span>
<span id="cb218-6"><a href="validate-tree-detection-and-crown-delineation.html#cb218-6" tabindex="-1"></a>ans<span class="sc">$</span>crowns_sf <span class="ot">&lt;-</span> ans<span class="sc">$</span>crowns_sf <span class="sc">%&gt;%</span> </span>
<span id="cb218-7"><a href="validate-tree-detection-and-crown-delineation.html#cb218-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(tree_height_m <span class="sc">&gt;=</span> lidar_df<span class="sc">$</span>site_prcntl_ht[lidar_df_row])</span></code></pre></div>
<p>quick check of our heights</p>
<div class="sourceCode" id="cb219"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb219-1"><a href="validate-tree-detection-and-crown-delineation.html#cb219-1" tabindex="-1"></a>ans<span class="sc">$</span>crowns_sf<span class="sc">$</span>tree_height_m <span class="sc">%&gt;%</span> <span class="fu">summary</span>()</span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##   4.068   5.632   7.182   6.943   8.411   9.706</code></pre>
</div>
<div id="format-extracted-tree-polygons" class="section level4 hasAnchor" number="4.2.3.3">
<h4><span class="header-section-number">4.2.3.3</span> Format extracted tree polygons<a href="validate-tree-detection-and-crown-delineation.html#format-extracted-tree-polygons" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>we need to format our extracted trees for <code>NeonTreeEvaluation</code> evaluation and submission</p>
<p>first, we’ll simplify multipolygon crowns</p>
<div class="sourceCode" id="cb221"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb221-1"><a href="validate-tree-detection-and-crown-delineation.html#cb221-1" tabindex="-1"></a>ans<span class="sc">$</span>crowns_sf <span class="ot">&lt;-</span> cloud2trees<span class="sc">::</span><span class="fu">simplify_multipolygon_crowns</span>(ans<span class="sc">$</span>crowns_sf)</span></code></pre></div>
<p>check out our extracted trees</p>
<div class="sourceCode" id="cb222"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb222-1"><a href="validate-tree-detection-and-crown-delineation.html#cb222-1" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb222-2"><a href="validate-tree-detection-and-crown-delineation.html#cb222-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_tile</span>(</span>
<span id="cb222-3"><a href="validate-tree-detection-and-crown-delineation.html#cb222-3" tabindex="-1"></a>    <span class="at">data =</span> ans<span class="sc">$</span>chm_rast <span class="sc">%&gt;%</span></span>
<span id="cb222-4"><a href="validate-tree-detection-and-crown-delineation.html#cb222-4" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">as.data.frame</span>(<span class="at">xy=</span>T) <span class="sc">%&gt;%</span></span>
<span id="cb222-5"><a href="validate-tree-detection-and-crown-delineation.html#cb222-5" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">f=</span><span class="dv">3</span>)</span>
<span id="cb222-6"><a href="validate-tree-detection-and-crown-delineation.html#cb222-6" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">fill =</span> f)</span>
<span id="cb222-7"><a href="validate-tree-detection-and-crown-delineation.html#cb222-7" tabindex="-1"></a>    , <span class="at">na.rm =</span> T</span>
<span id="cb222-8"><a href="validate-tree-detection-and-crown-delineation.html#cb222-8" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb222-9"><a href="validate-tree-detection-and-crown-delineation.html#cb222-9" tabindex="-1"></a>  harrypotter<span class="sc">::</span><span class="fu">scale_fill_hp</span>(</span>
<span id="cb222-10"><a href="validate-tree-detection-and-crown-delineation.html#cb222-10" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">&quot;gryffindor&quot;</span></span>
<span id="cb222-11"><a href="validate-tree-detection-and-crown-delineation.html#cb222-11" tabindex="-1"></a>    , <span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="at">n=</span><span class="dv">10</span>)</span>
<span id="cb222-12"><a href="validate-tree-detection-and-crown-delineation.html#cb222-12" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb222-13"><a href="validate-tree-detection-and-crown-delineation.html#cb222-13" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb222-14"><a href="validate-tree-detection-and-crown-delineation.html#cb222-14" tabindex="-1"></a>    <span class="at">data =</span> ans<span class="sc">$</span>crowns_sf</span>
<span id="cb222-15"><a href="validate-tree-detection-and-crown-delineation.html#cb222-15" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;gray44&quot;</span>, <span class="at">lwd =</span> <span class="fl">1.2</span></span>
<span id="cb222-16"><a href="validate-tree-detection-and-crown-delineation.html#cb222-16" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb222-17"><a href="validate-tree-detection-and-crown-delineation.html#cb222-17" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb222-18"><a href="validate-tree-detection-and-crown-delineation.html#cb222-18" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb222-19"><a href="validate-tree-detection-and-crown-delineation.html#cb222-19" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;CHM (m)&quot;</span>) <span class="sc">+</span></span>
<span id="cb222-20"><a href="validate-tree-detection-and-crown-delineation.html#cb222-20" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb222-21"><a href="validate-tree-detection-and-crown-delineation.html#cb222-21" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">axis.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-202-1.png" width="1008" /></p>
<p>we’ll reserve judgement and let the data talk</p>
<p>format the data for <code>NeonTreeEvaluation</code> submission and evaluation</p>
<div class="sourceCode" id="cb223"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb223-1"><a href="validate-tree-detection-and-crown-delineation.html#cb223-1" tabindex="-1"></a>return_sf <span class="ot">&lt;-</span></span>
<span id="cb223-2"><a href="validate-tree-detection-and-crown-delineation.html#cb223-2" tabindex="-1"></a>  ans<span class="sc">$</span>crowns_sf <span class="sc">%&gt;%</span> </span>
<span id="cb223-3"><a href="validate-tree-detection-and-crown-delineation.html#cb223-3" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_set_geometry</span>(<span class="st">&quot;geometry&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb223-4"><a href="validate-tree-detection-and-crown-delineation.html#cb223-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rowwise</span>(<span class="st">&quot;treeID&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb223-5"><a href="validate-tree-detection-and-crown-delineation.html#cb223-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb223-6"><a href="validate-tree-detection-and-crown-delineation.html#cb223-6" tabindex="-1"></a>    <span class="at">xmin =</span> sf<span class="sc">::</span><span class="fu">st_bbox</span>(geometry)[<span class="dv">1</span>]</span>
<span id="cb223-7"><a href="validate-tree-detection-and-crown-delineation.html#cb223-7" tabindex="-1"></a>    , <span class="at">ymin =</span> sf<span class="sc">::</span><span class="fu">st_bbox</span>(geometry)[<span class="dv">2</span>]</span>
<span id="cb223-8"><a href="validate-tree-detection-and-crown-delineation.html#cb223-8" tabindex="-1"></a>    , <span class="at">xmax =</span> sf<span class="sc">::</span><span class="fu">st_bbox</span>(geometry)[<span class="dv">3</span>]</span>
<span id="cb223-9"><a href="validate-tree-detection-and-crown-delineation.html#cb223-9" tabindex="-1"></a>    , <span class="at">ymax =</span> sf<span class="sc">::</span><span class="fu">st_bbox</span>(geometry)[<span class="dv">4</span>]</span>
<span id="cb223-10"><a href="validate-tree-detection-and-crown-delineation.html#cb223-10" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb223-11"><a href="validate-tree-detection-and-crown-delineation.html#cb223-11" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb223-12"><a href="validate-tree-detection-and-crown-delineation.html#cb223-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb223-13"><a href="validate-tree-detection-and-crown-delineation.html#cb223-13" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">&quot;Tree&quot;</span></span>
<span id="cb223-14"><a href="validate-tree-detection-and-crown-delineation.html#cb223-14" tabindex="-1"></a>    , <span class="at">plot_name =</span> lidar_df<span class="sc">$</span>plot_name[lidar_df_row]</span>
<span id="cb223-15"><a href="validate-tree-detection-and-crown-delineation.html#cb223-15" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb223-16"><a href="validate-tree-detection-and-crown-delineation.html#cb223-16" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(xmin,xmax,ymin,ymax,label,plot_name) <span class="sc">%&gt;%</span> </span>
<span id="cb223-17"><a href="validate-tree-detection-and-crown-delineation.html#cb223-17" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_set_crs</span>(<span class="cn">NA</span>)</span>
<span id="cb223-18"><a href="validate-tree-detection-and-crown-delineation.html#cb223-18" tabindex="-1"></a><span class="co"># what?</span></span>
<span id="cb223-19"><a href="validate-tree-detection-and-crown-delineation.html#cb223-19" tabindex="-1"></a>return_sf <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 74
## Columns: 7
## $ xmin      &lt;dbl&gt; 552095.5, 552089.8, 552081.2, 552085.2, 552084.2, 552080.2, …
## $ xmax      &lt;dbl&gt; 552099.5, 552093.0, 552085.2, 552088.2, 552087.2, 552084.5, …
## $ ymin      &lt;dbl&gt; 5067679, 5067678, 5067677, 5067677, 5067674, 5067674, 506767…
## $ ymax      &lt;dbl&gt; 5067681, 5067681, 5067680, 5067679, 5067679, 5067678, 506767…
## $ label     &lt;chr&gt; &quot;Tree&quot;, &quot;Tree&quot;, &quot;Tree&quot;, &quot;Tree&quot;, &quot;Tree&quot;, &quot;Tree&quot;, &quot;Tree&quot;, &quot;Tre…
## $ plot_name &lt;chr&gt; &quot;ABBY_063_2019&quot;, &quot;ABBY_063_2019&quot;, &quot;ABBY_063_2019&quot;, &quot;ABBY_063…
## $ geometry  &lt;POLYGON&gt; POLYGON ((552095.8 5067681,..., POLYGON ((552090.8 50676…</code></pre>
<p>does this match the submission polygon data from the <code>NeonTreeEvaluation</code> package?</p>
<div class="sourceCode" id="cb225"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb225-1"><a href="validate-tree-detection-and-crown-delineation.html#cb225-1" tabindex="-1"></a>NeonTreeEvaluation<span class="sc">::</span>submission_polygons <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 126,574
## Columns: 8
## $ xmin        &lt;dbl&gt; 41.01716, 357.32129, 30.39723, 260.65921, 179.34564, 316.2…
## $ ymin        &lt;dbl&gt; 230.8854218, 122.1164017, 136.9156647, 285.6688843, 371.61…
## $ xmax        &lt;dbl&gt; 151.08607, 397.57458, 73.79434, 299.68811, 232.49385, 363.…
## $ ymax        &lt;dbl&gt; 342.69846, 159.37578, 184.94730, 326.79330, 400.00000, 400…
## $ score       &lt;dbl&gt; 0.8098674, 0.6968824, 0.5713338, 0.5511004, 0.4697072, 0.3…
## $ label       &lt;chr&gt; &quot;Tree&quot;, &quot;Tree&quot;, &quot;Tree&quot;, &quot;Tree&quot;, &quot;Tree&quot;, &quot;Tree&quot;, &quot;Tree&quot;, &quot;T…
## $ plot_name   &lt;chr&gt; &quot;DSNY_014_2019&quot;, &quot;DSNY_014_2019&quot;, &quot;DSNY_014_2019&quot;, &quot;DSNY_0…
## $ st_sfc.lst. &lt;POLYGON&gt; POLYGON ((41.01716 230.8854..., POLYGON ((357.3213 122…</code></pre>
<p>yes, except for the “score” column which I’m pretty sure is an artifact from after evaluation?</p>
</div>
<div id="test-evaluation" class="section level4 hasAnchor" number="4.2.3.4">
<h4><span class="header-section-number">4.2.3.4</span> Test evaluation<a href="validate-tree-detection-and-crown-delineation.html#test-evaluation" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>We compared our tree detection and crown delineation results to the three types of evaluation data (i.e. “ground truth” data) presented by Weinstein et al. (<a href="https://scholar.google.com/scholar?cluster=4986448711981898434&amp;hl=en&amp;as_sdt=0,6">2021</a>): field-collected stems, image-annotated crowns, and field-annotated crowns. Field-collected stems offer precise tree locations but might not align with the position of the tree crown as viewed from above (e.g. due to tree lean), image-annotated crowns outline crown boundaries but are subjective, and field-annotated crowns combine the benefits of both but are highly resource-intensive.</p>
<div id="scores-for-image-annotated-crowns" class="section level5 hasAnchor" number="4.2.3.4.1">
<h5><span class="header-section-number">4.2.3.4.1</span> Scores for image-annotated crowns<a href="validate-tree-detection-and-crown-delineation.html#scores-for-image-annotated-crowns" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>The main data source are image-annotated crowns, in which a single observer annotated visible trees in 200 40m x 40m images from across the United States. Get the benchmark score image-annotated “ground truth” data.</p>
<p><em>in testing, including the <code>sf</code> polygon data did not work…switching to the bbox method with <code>sf::st_drop_geometry()</code></em></p>
<div class="sourceCode" id="cb227"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb227-1"><a href="validate-tree-detection-and-crown-delineation.html#cb227-1" tabindex="-1"></a>rslt_img_annttd_crwns <span class="ot">&lt;-</span> NeonTreeEvaluation<span class="sc">::</span><span class="fu">evaluate_image_crowns</span>(</span>
<span id="cb227-2"><a href="validate-tree-detection-and-crown-delineation.html#cb227-2" tabindex="-1"></a>  <span class="at">predictions =</span> return_sf <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>()</span>
<span id="cb227-3"><a href="validate-tree-detection-and-crown-delineation.html#cb227-3" tabindex="-1"></a>  , <span class="at">show =</span> T</span>
<span id="cb227-4"><a href="validate-tree-detection-and-crown-delineation.html#cb227-4" tabindex="-1"></a>  , <span class="at">summarize =</span> T</span>
<span id="cb227-5"><a href="validate-tree-detection-and-crown-delineation.html#cb227-5" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## [1] &quot;ABBY_063_2019&quot;</code></pre>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-205-1.png" width="1008" /></p>
<p>in the plot (if there is a plot), “red” boxes are crowns our point cloud-based method extracted and “black” are the image annotated crowns</p>
<p>it looks like the overlay is generally the same but we are still extracting trees that may not be considered “canopy” trees ;<br />
</p>
<p>what is in the return from <code>NeonTreeEvaluation::evaluate_image_crowns()</code> ?</p>
<div class="sourceCode" id="cb229"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb229-1"><a href="validate-tree-detection-and-crown-delineation.html#cb229-1" tabindex="-1"></a>rslt_img_annttd_crwns <span class="sc">%&gt;%</span> <span class="fu">names</span>()</span></code></pre></div>
<pre><code>## [1] &quot;overall&quot;     &quot;by_site&quot;     &quot;plot_level&quot;  &quot;count_error&quot;</code></pre>
<p><code>overall</code>: must be across all NEON sites, plots, and trees included for evaluation</p>
<div class="sourceCode" id="cb231"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb231-1"><a href="validate-tree-detection-and-crown-delineation.html#cb231-1" tabindex="-1"></a>rslt_img_annttd_crwns<span class="sc">$</span>overall</span></code></pre></div>
<pre><code>## # A tibble: 1 × 2
##   precision recall
##       &lt;dbl&gt;  &lt;dbl&gt;
## 1     0.554  0.719</code></pre>
<p><code>by_site</code>: must be across plots, and trees included for evaluation in a NEON sites</p>
<div class="sourceCode" id="cb233"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb233-1"><a href="validate-tree-detection-and-crown-delineation.html#cb233-1" tabindex="-1"></a>rslt_img_annttd_crwns<span class="sc">$</span>by_site</span></code></pre></div>
<pre><code>## # A tibble: 1 × 3
## # Groups:   Site [1]
##   Site  recall precision
##   &lt;chr&gt;  &lt;dbl&gt;     &lt;dbl&gt;
## 1 ABBY   0.719     0.554</code></pre>
<p><code>plot_level</code>: must be across trees included for evaluation in a NEON site, plot combination</p>
<div class="sourceCode" id="cb235"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb235-1"><a href="validate-tree-detection-and-crown-delineation.html#cb235-1" tabindex="-1"></a>rslt_img_annttd_crwns<span class="sc">$</span>plot_level</span></code></pre></div>
<pre><code>## # A tibble: 1 × 3
## # Groups:   plot_name [1]
##   plot_name     recall precision
##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;
## 1 ABBY_063_2019  0.719     0.554</code></pre>
<p>count_error is the number of predicted trees minus the number of “ground truth” trees but in graphical form so we’ll skip it</p>
</div>
<div id="scores-for-field-annotated-crowns" class="section level5 hasAnchor" number="4.2.3.4.2">
<h5><span class="header-section-number">4.2.3.4.2</span> Scores for field-annotated crowns<a href="validate-tree-detection-and-crown-delineation.html#scores-for-field-annotated-crowns" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>The second data source is a small number of field-annotated crowns from two geographic sites. These crowns were drawn on a tablet while physically standing in the field, thereby reducing the uncertainty in crown segmentation.</p>
<p><em>not all plots have field-annotated crowns</em></p>
<p><code>NeonTreeEvaluation::evaluate_field_crowns()</code> returns an error if “No plot names matching the field crown data, see list_field_crowns for paths to RGB field crown imagery.”… so, we’ll have to capture errors in our checks?</p>
<div class="sourceCode" id="cb237"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb237-1"><a href="validate-tree-detection-and-crown-delineation.html#cb237-1" tabindex="-1"></a><span class="co"># safe it</span></span>
<span id="cb237-2"><a href="validate-tree-detection-and-crown-delineation.html#cb237-2" tabindex="-1"></a>safe_evaluate_field_crowns <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">safely</span>(NeonTreeEvaluation<span class="sc">::</span>evaluate_field_crowns)</span>
<span id="cb237-3"><a href="validate-tree-detection-and-crown-delineation.html#cb237-3" tabindex="-1"></a><span class="co"># test it</span></span>
<span id="cb237-4"><a href="validate-tree-detection-and-crown-delineation.html#cb237-4" tabindex="-1"></a>rslt_fld_crwns <span class="ot">&lt;-</span> <span class="fu">safe_evaluate_field_crowns</span>(</span>
<span id="cb237-5"><a href="validate-tree-detection-and-crown-delineation.html#cb237-5" tabindex="-1"></a>  <span class="at">predictions =</span> return_sf <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>()</span>
<span id="cb237-6"><a href="validate-tree-detection-and-crown-delineation.html#cb237-6" tabindex="-1"></a>  , <span class="at">show =</span> T</span>
<span id="cb237-7"><a href="validate-tree-detection-and-crown-delineation.html#cb237-7" tabindex="-1"></a>  , <span class="at">summarize =</span> T</span>
<span id="cb237-8"><a href="validate-tree-detection-and-crown-delineation.html#cb237-8" tabindex="-1"></a>)</span></code></pre></div>
<p>did it do it?</p>
<div class="sourceCode" id="cb238"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb238-1"><a href="validate-tree-detection-and-crown-delineation.html#cb238-1" tabindex="-1"></a>rslt_fld_crwns<span class="sc">$</span>error</span></code></pre></div>
<pre><code>## &lt;simpleError in .f(...): No plot names matching the field crown data, see list_field_crowns for paths to RGB field crown imagery.&gt;</code></pre>
<p>nope!</p>
</div>
<div id="scores-for-field-collected-stems" class="section level5 hasAnchor" number="4.2.3.4.3">
<h5><span class="header-section-number">4.2.3.4.3</span> Scores for field-collected stems<a href="validate-tree-detection-and-crown-delineation.html#scores-for-field-collected-stems" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>The third data source is the NEON Woody Vegetation Structure Dataset. Each tree stem is represented by a single point. This data has been filtered to represent overstory trees visible in the remote sensing imagery.</p>
<p><em>not all plots have field-collected stems</em></p>
<p><code>NeonTreeEvaluation::evaluate_field_stems()</code> returns an error if “No submitted plot_names with matching field stem data, see list_field_stems()”… so, we’ll have to capture errors in our checks?</p>
<div class="sourceCode" id="cb240"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb240-1"><a href="validate-tree-detection-and-crown-delineation.html#cb240-1" tabindex="-1"></a><span class="co"># safe it</span></span>
<span id="cb240-2"><a href="validate-tree-detection-and-crown-delineation.html#cb240-2" tabindex="-1"></a>safe_evaluate_field_stems <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">safely</span>(NeonTreeEvaluation<span class="sc">::</span>evaluate_field_stems)</span>
<span id="cb240-3"><a href="validate-tree-detection-and-crown-delineation.html#cb240-3" tabindex="-1"></a><span class="co"># test it</span></span>
<span id="cb240-4"><a href="validate-tree-detection-and-crown-delineation.html#cb240-4" tabindex="-1"></a>rslt_fld_stems <span class="ot">&lt;-</span> <span class="fu">safe_evaluate_field_stems</span>(</span>
<span id="cb240-5"><a href="validate-tree-detection-and-crown-delineation.html#cb240-5" tabindex="-1"></a>  <span class="at">predictions =</span> return_sf <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>()</span>
<span id="cb240-6"><a href="validate-tree-detection-and-crown-delineation.html#cb240-6" tabindex="-1"></a>  , <span class="at">show =</span> T</span>
<span id="cb240-7"><a href="validate-tree-detection-and-crown-delineation.html#cb240-7" tabindex="-1"></a>  , <span class="at">summarize =</span> T</span>
<span id="cb240-8"><a href="validate-tree-detection-and-crown-delineation.html#cb240-8" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## [1] &quot;ABBY_063&quot;</code></pre>
<p>did it do it?</p>
<div class="sourceCode" id="cb242"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb242-1"><a href="validate-tree-detection-and-crown-delineation.html#cb242-1" tabindex="-1"></a>rslt_fld_stems<span class="sc">$</span>error</span></code></pre></div>
<pre><code>## &lt;error/rlang_error&gt;
## Error in `summarize()`:
## ℹ In argument: `recall = mean(recall)`.
## Caused by error:
## ! object &#39;recall&#39; not found
## ---
## Backtrace:
##      ▆
##   1. ├─purrr (local) safe_evaluate_field_stems(...)
##   2. │ ├─purrr:::capture_error(.f(...), otherwise, quiet)
##   3. │ │ └─base::tryCatch(...)
##   4. │ │   └─base (local) tryCatchList(expr, classes, parentenv, handlers)
##   5. │ │     └─base (local) tryCatchOne(expr, names, parentenv, handlers[[1L]])
##   6. │ │       └─base (local) doTryCatch(return(expr), name, parentenv, handler)
##   7. │ └─NeonTreeEvaluation (local) .f(...)
##   8. │   └─results %&gt;% summarize(recall = mean(recall))
##   9. ├─dplyr::summarize(., recall = mean(recall))
##  10. ├─dplyr:::summarise.data.frame(., recall = mean(recall))
##  11. │ └─dplyr:::summarise_cols(.data, dplyr_quosures(...), by, &quot;summarise&quot;)
##  12. │   ├─base::withCallingHandlers(...)
##  13. │   └─dplyr:::map(quosures, summarise_eval_one, mask = mask)
##  14. │     └─base::lapply(.x, .f, ...)
##  15. │       └─dplyr (local) FUN(X[[i]], ...)
##  16. │         └─mask$eval_all_summarise(quo)
##  17. │           └─dplyr (local) eval()
##  18. └─base::mean(recall)</code></pre>
<p>nope!</p>
</div>
</div>
</div>
<div id="training-validation-process" class="section level3 hasAnchor" number="4.2.4">
<h3><span class="header-section-number">4.2.4</span> Training validation process<a href="validate-tree-detection-and-crown-delineation.html#training-validation-process" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Now that we have been through the validation process for a <a href="validate-tree-detection-and-crown-delineation.html#ex_valid">single sample plot</a> and <a href="validate-tree-detection-and-crown-delineation.html#itd_more">defined different variable window functions</a> for use in ITD, we’ll create a function to detect trees and delineate tree crowns using our <code>cloud2trees::cloud2trees()</code> method to apply over each lidar data set.</p>
<p>We’ll extract trees on each training data set using all 15 variable window functions, compare our point cloud-detected trees to the image annotated crowns (i.e. ground truth), and store the best variable window function by NEON site for use in validation on the evaluation lidar data. If a NEON site does not have training data, the best variable window function across NEON sites will be used.</p>
<div id="summary-of-training-lidar-data" class="section level4 hasAnchor" number="4.2.4.1">
<h4><span class="header-section-number">4.2.4.1</span> Summary of training lidar data<a href="validate-tree-detection-and-crown-delineation.html#summary-of-training-lidar-data" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Let’s get a quick summary of the lidar data available for training. Note, we expect our augmented training data sets to be sized around 40m x 40m while the original training data sets will cover a larger area.</p>
<div class="sourceCode" id="cb244"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb244-1"><a href="validate-tree-detection-and-crown-delineation.html#cb244-1" tabindex="-1"></a>training_lidar_sum_temp <span class="ot">&lt;-</span></span>
<span id="cb244-2"><a href="validate-tree-detection-and-crown-delineation.html#cb244-2" tabindex="-1"></a>  lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb244-3"><a href="validate-tree-detection-and-crown-delineation.html#cb244-3" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb244-4"><a href="validate-tree-detection-and-crown-delineation.html#cb244-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(data_type<span class="sc">==</span><span class="st">&quot;training&quot;</span> <span class="sc">|</span> is_new_image_annotation_training <span class="sc">|</span> is_new_field_stems_training) <span class="sc">%&gt;%</span> </span>
<span id="cb244-5"><a href="validate-tree-detection-and-crown-delineation.html#cb244-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(f_path) <span class="sc">%&gt;%</span> </span>
<span id="cb244-6"><a href="validate-tree-detection-and-crown-delineation.html#cb244-6" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(<span class="cf">function</span>(x){</span>
<span id="cb244-7"><a href="validate-tree-detection-and-crown-delineation.html#cb244-7" tabindex="-1"></a>    ctg <span class="ot">&lt;-</span> lidR<span class="sc">::</span><span class="fu">readLAScatalog</span>(x)</span>
<span id="cb244-8"><a href="validate-tree-detection-and-crown-delineation.html#cb244-8" tabindex="-1"></a>    ctg<span class="sc">@</span>data <span class="sc">%&gt;%</span> </span>
<span id="cb244-9"><a href="validate-tree-detection-and-crown-delineation.html#cb244-9" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb244-10"><a href="validate-tree-detection-and-crown-delineation.html#cb244-10" tabindex="-1"></a>        <span class="at">num_points =</span> <span class="fu">sum</span>(Number.of.point.records)</span>
<span id="cb244-11"><a href="validate-tree-detection-and-crown-delineation.html#cb244-11" tabindex="-1"></a>        , <span class="at">area_m2 =</span> <span class="fu">sum</span>(<span class="fu">as.numeric</span>(sf<span class="sc">::</span><span class="fu">st_area</span>(.)))</span>
<span id="cb244-12"><a href="validate-tree-detection-and-crown-delineation.html#cb244-12" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb244-13"><a href="validate-tree-detection-and-crown-delineation.html#cb244-13" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">points_per_m2 =</span> num_points<span class="sc">/</span>area_m2) <span class="sc">%&gt;%</span> </span>
<span id="cb244-14"><a href="validate-tree-detection-and-crown-delineation.html#cb244-14" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb244-15"><a href="validate-tree-detection-and-crown-delineation.html#cb244-15" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb244-16"><a href="validate-tree-detection-and-crown-delineation.html#cb244-16" tabindex="-1"></a>        <span class="at">plot_name =</span> x <span class="sc">%&gt;%</span> <span class="fu">basename</span>() <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(<span class="st">&quot;</span><span class="sc">\\</span><span class="st">.(laz|las)$&quot;</span>)    </span>
<span id="cb244-17"><a href="validate-tree-detection-and-crown-delineation.html#cb244-17" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb244-18"><a href="validate-tree-detection-and-crown-delineation.html#cb244-18" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">relocate</span>(plot_name)</span>
<span id="cb244-19"><a href="validate-tree-detection-and-crown-delineation.html#cb244-19" tabindex="-1"></a>  }) <span class="sc">%&gt;%</span> </span>
<span id="cb244-20"><a href="validate-tree-detection-and-crown-delineation.html#cb244-20" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span>
<span id="cb244-21"><a href="validate-tree-detection-and-crown-delineation.html#cb244-21" tabindex="-1"></a><span class="co"># check it</span></span>
<span id="cb244-22"><a href="validate-tree-detection-and-crown-delineation.html#cb244-22" tabindex="-1"></a>training_lidar_sum_temp <span class="sc">%&gt;%</span> </span>
<span id="cb244-23"><a href="validate-tree-detection-and-crown-delineation.html#cb244-23" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb244-24"><a href="validate-tree-detection-and-crown-delineation.html#cb244-24" tabindex="-1"></a>    lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb244-25"><a href="validate-tree-detection-and-crown-delineation.html#cb244-25" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb244-26"><a href="validate-tree-detection-and-crown-delineation.html#cb244-26" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(plot_name,siteID) </span>
<span id="cb244-27"><a href="validate-tree-detection-and-crown-delineation.html#cb244-27" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;plot_name&quot;</span></span>
<span id="cb244-28"><a href="validate-tree-detection-and-crown-delineation.html#cb244-28" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb244-29"><a href="validate-tree-detection-and-crown-delineation.html#cb244-29" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(dplyr<span class="sc">::</span><span class="fu">across</span>(dplyr<span class="sc">::</span><span class="fu">where</span>(is.numeric),<span class="sc">~</span>scales<span class="sc">::</span><span class="fu">comma</span>(.x,<span class="at">accuracy=</span>.<span class="dv">1</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb244-30"><a href="validate-tree-detection-and-crown-delineation.html#cb244-30" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(siteID) <span class="sc">%&gt;%</span> </span>
<span id="cb244-31"><a href="validate-tree-detection-and-crown-delineation.html#cb244-31" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(siteID,plot_name) <span class="sc">%&gt;%</span> </span>
<span id="cb244-32"><a href="validate-tree-detection-and-crown-delineation.html#cb244-32" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(</span>
<span id="cb244-33"><a href="validate-tree-detection-and-crown-delineation.html#cb244-33" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">&quot;summary of training lidar data&quot;</span></span>
<span id="cb244-34"><a href="validate-tree-detection-and-crown-delineation.html#cb244-34" tabindex="-1"></a>    , <span class="at">digits =</span> <span class="dv">1</span></span>
<span id="cb244-35"><a href="validate-tree-detection-and-crown-delineation.html#cb244-35" tabindex="-1"></a>    , <span class="at">col.names =</span> <span class="fu">c</span>(</span>
<span id="cb244-36"><a href="validate-tree-detection-and-crown-delineation.html#cb244-36" tabindex="-1"></a>      <span class="st">&quot;site&quot;</span>,<span class="st">&quot;plot&quot;</span>,<span class="st">&quot;# points&quot;</span>,<span class="st">&quot;area m&lt;sup&gt;2&lt;/sup&gt;&quot;</span>, <span class="st">&quot;points&lt;br&gt;per m&lt;sup&gt;2&lt;/sup&gt;&quot;</span></span>
<span id="cb244-37"><a href="validate-tree-detection-and-crown-delineation.html#cb244-37" tabindex="-1"></a>    )</span>
<span id="cb244-38"><a href="validate-tree-detection-and-crown-delineation.html#cb244-38" tabindex="-1"></a>    , <span class="at">escape =</span> F</span>
<span id="cb244-39"><a href="validate-tree-detection-and-crown-delineation.html#cb244-39" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb244-40"><a href="validate-tree-detection-and-crown-delineation.html#cb244-40" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb244-41"><a href="validate-tree-detection-and-crown-delineation.html#cb244-41" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">scroll_box</span>(<span class="at">height =</span> <span class="st">&quot;622px&quot;</span>,<span class="at">fixed_thead =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb244-42"><a href="validate-tree-detection-and-crown-delineation.html#cb244-42" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">collapse_rows</span>(<span class="at">columns =</span> <span class="dv">1</span>, <span class="at">valign =</span> <span class="st">&quot;top&quot;</span>)</span></code></pre></div>
<div style="border: 1px solid #ddd; padding: 0px; overflow-y: scroll; height:622px; ">
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-215">Table 4.5: </span>summary of training lidar data
</caption>
<thead>
<tr>
<th style="text-align:left;position: sticky; top:0; background-color: #FFFFFF;">
site
</th>
<th style="text-align:left;position: sticky; top:0; background-color: #FFFFFF;">
plot
</th>
<th style="text-align:left;position: sticky; top:0; background-color: #FFFFFF;">
# points
</th>
<th style="text-align:left;position: sticky; top:0; background-color: #FFFFFF;">
area m<sup>2</sup>
</th>
<th style="text-align:left;position: sticky; top:0; background-color: #FFFFFF;">
points<br>per m<sup>2</sup>
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="2">
ABBY
</td>
<td style="text-align:left;">
ABBY_065_2018
</td>
<td style="text-align:left;">
29,310.0
</td>
<td style="text-align:left;">
1,599.8
</td>
<td style="text-align:left;">
18.3
</td>
</tr>
<tr>
<td style="text-align:left;">
ABBY_075_2018
</td>
<td style="text-align:left;">
21,142.0
</td>
<td style="text-align:left;">
1,599.8
</td>
<td style="text-align:left;">
13.2
</td>
</tr>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="2">
DEJU
</td>
<td style="text-align:left;">
DEJU_014_2018
</td>
<td style="text-align:left;">
11,293.0
</td>
<td style="text-align:left;">
1,599.2
</td>
<td style="text-align:left;">
7.1
</td>
</tr>
<tr>
<td style="text-align:left;">
DEJU_016_2019
</td>
<td style="text-align:left;">
9,292.0
</td>
<td style="text-align:left;">
1,599.2
</td>
<td style="text-align:left;">
5.8
</td>
</tr>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="2">
DSNY
</td>
<td style="text-align:left;">
DSNY_005_2018
</td>
<td style="text-align:left;">
11,215.0
</td>
<td style="text-align:left;">
1,599.2
</td>
<td style="text-align:left;">
7.0
</td>
</tr>
<tr>
<td style="text-align:left;">
DSNY_025_2018
</td>
<td style="text-align:left;">
6,559.0
</td>
<td style="text-align:left;">
1,599.2
</td>
<td style="text-align:left;">
4.1
</td>
</tr>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="3">
JERC
</td>
<td style="text-align:left;">
2018_JERC_4_742000_3451000_image_crop
</td>
<td style="text-align:left;">
63,925.0
</td>
<td style="text-align:left;">
16,129.8
</td>
<td style="text-align:left;">
4.0
</td>
</tr>
<tr>
<td style="text-align:left;">
JERC_049_2018
</td>
<td style="text-align:left;">
17,010.0
</td>
<td style="text-align:left;">
1,599.2
</td>
<td style="text-align:left;">
10.6
</td>
</tr>
<tr>
<td style="text-align:left;">
JERC_063_2018
</td>
<td style="text-align:left;">
4,299.0
</td>
<td style="text-align:left;">
1,597.6
</td>
<td style="text-align:left;">
2.7
</td>
</tr>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="3">
NIWO
</td>
<td style="text-align:left;">
2018_NIWO_2_450000_4426000_image_crop
</td>
<td style="text-align:left;">
2,101,996.0
</td>
<td style="text-align:left;">
103,753.9
</td>
<td style="text-align:left;">
20.3
</td>
</tr>
<tr>
<td style="text-align:left;">
NIWO_009_2020
</td>
<td style="text-align:left;">
8,899.0
</td>
<td style="text-align:left;">
1,599.2
</td>
<td style="text-align:left;">
5.6
</td>
</tr>
<tr>
<td style="text-align:left;">
NIWO_040_2020
</td>
<td style="text-align:left;">
10,535.0
</td>
<td style="text-align:left;">
1,599.2
</td>
<td style="text-align:left;">
6.6
</td>
</tr>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="5">
OSBS
</td>
<td style="text-align:left;">
2018_OSBS_4_405000_3286000_image
</td>
<td style="text-align:left;">
3,813,514.0
</td>
<td style="text-align:left;">
999,980.0
</td>
<td style="text-align:left;">
3.8
</td>
</tr>
<tr>
<td style="text-align:left;">
2019_OSBS_5_405000_3287000_image_crop
</td>
<td style="text-align:left;">
145,549.0
</td>
<td style="text-align:left;">
30,315.4
</td>
<td style="text-align:left;">
4.8
</td>
</tr>
<tr>
<td style="text-align:left;">
2019_OSBS_5_405000_3287000_image_crop2
</td>
<td style="text-align:left;">
237,076.0
</td>
<td style="text-align:left;">
59,741.7
</td>
<td style="text-align:left;">
4.0
</td>
</tr>
<tr>
<td style="text-align:left;">
OSBS_004_2019
</td>
<td style="text-align:left;">
13,684.0
</td>
<td style="text-align:left;">
1,599.8
</td>
<td style="text-align:left;">
8.6
</td>
</tr>
<tr>
<td style="text-align:left;">
OSBS_035_2019
</td>
<td style="text-align:left;">
9,981.0
</td>
<td style="text-align:left;">
1,599.3
</td>
<td style="text-align:left;">
6.2
</td>
</tr>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="2">
TALL
</td>
<td style="text-align:left;">
TALL_053_2018
</td>
<td style="text-align:left;">
22,711.0
</td>
<td style="text-align:left;">
1,599.6
</td>
<td style="text-align:left;">
14.2
</td>
</tr>
<tr>
<td style="text-align:left;">
TALL_061_2019
</td>
<td style="text-align:left;">
8,117.0
</td>
<td style="text-align:left;">
1,598.4
</td>
<td style="text-align:left;">
5.1
</td>
</tr>
<tr>
<td style="text-align:left;">
TEAK
</td>
<td style="text-align:left;">
2018_TEAK_3_315000_4094000_image_crop
</td>
<td style="text-align:left;">
2,817,056.0
</td>
<td style="text-align:left;">
359,998.8
</td>
<td style="text-align:left;">
7.8
</td>
</tr>
</tbody>
</table>
</div>
<p>note the out-of-box training plots are much larger – that’s why we didn’t augment the training set for these sites – and check out the spread in point density</p>
<p>do the 2019 “OSBS” point clouds overlap?</p>
<div class="sourceCode" id="cb245"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb245-1"><a href="validate-tree-detection-and-crown-delineation.html#cb245-1" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb245-2"><a href="validate-tree-detection-and-crown-delineation.html#cb245-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb245-3"><a href="validate-tree-detection-and-crown-delineation.html#cb245-3" tabindex="-1"></a>    <span class="at">data =</span> lidR<span class="sc">::</span><span class="fu">readLAScatalog</span>(</span>
<span id="cb245-4"><a href="validate-tree-detection-and-crown-delineation.html#cb245-4" tabindex="-1"></a>        lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb245-5"><a href="validate-tree-detection-and-crown-delineation.html#cb245-5" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(plot_name <span class="sc">==</span> <span class="st">&quot;2019_OSBS_5_405000_3287000_image_crop&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb245-6"><a href="validate-tree-detection-and-crown-delineation.html#cb245-6" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">pull</span>(f_path)</span>
<span id="cb245-7"><a href="validate-tree-detection-and-crown-delineation.html#cb245-7" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb245-8"><a href="validate-tree-detection-and-crown-delineation.html#cb245-8" tabindex="-1"></a>      purrr<span class="sc">::</span><span class="fu">pluck</span>(<span class="st">&quot;data&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb245-9"><a href="validate-tree-detection-and-crown-delineation.html#cb245-9" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">plot_name =</span> <span class="fu">basename</span>(filename) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(<span class="st">&quot;</span><span class="sc">\\</span><span class="st">.(laz|las)$&quot;</span>))</span>
<span id="cb245-10"><a href="validate-tree-detection-and-crown-delineation.html#cb245-10" tabindex="-1"></a>    , ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">color =</span> plot_name)</span>
<span id="cb245-11"><a href="validate-tree-detection-and-crown-delineation.html#cb245-11" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">2</span></span>
<span id="cb245-12"><a href="validate-tree-detection-and-crown-delineation.html#cb245-12" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb245-13"><a href="validate-tree-detection-and-crown-delineation.html#cb245-13" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb245-14"><a href="validate-tree-detection-and-crown-delineation.html#cb245-14" tabindex="-1"></a>    <span class="at">data =</span> lidR<span class="sc">::</span><span class="fu">readLAScatalog</span>(</span>
<span id="cb245-15"><a href="validate-tree-detection-and-crown-delineation.html#cb245-15" tabindex="-1"></a>        lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb245-16"><a href="validate-tree-detection-and-crown-delineation.html#cb245-16" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(plot_name <span class="sc">==</span> <span class="st">&quot;2019_OSBS_5_405000_3287000_image_crop2&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb245-17"><a href="validate-tree-detection-and-crown-delineation.html#cb245-17" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">pull</span>(f_path)</span>
<span id="cb245-18"><a href="validate-tree-detection-and-crown-delineation.html#cb245-18" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb245-19"><a href="validate-tree-detection-and-crown-delineation.html#cb245-19" tabindex="-1"></a>      purrr<span class="sc">::</span><span class="fu">pluck</span>(<span class="st">&quot;data&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb245-20"><a href="validate-tree-detection-and-crown-delineation.html#cb245-20" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">plot_name =</span> <span class="fu">basename</span>(filename) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(<span class="st">&quot;</span><span class="sc">\\</span><span class="st">.(laz|las)$&quot;</span>))</span>
<span id="cb245-21"><a href="validate-tree-detection-and-crown-delineation.html#cb245-21" tabindex="-1"></a>    , ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">color =</span> plot_name)</span>
<span id="cb245-22"><a href="validate-tree-detection-and-crown-delineation.html#cb245-22" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">lwd =</span> <span class="dv">2</span></span>
<span id="cb245-23"><a href="validate-tree-detection-and-crown-delineation.html#cb245-23" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb245-24"><a href="validate-tree-detection-and-crown-delineation.html#cb245-24" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;navy&quot;</span>,<span class="st">&quot;gold&quot;</span>)) <span class="sc">+</span></span>
<span id="cb245-25"><a href="validate-tree-detection-and-crown-delineation.html#cb245-25" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">color=</span><span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb245-26"><a href="validate-tree-detection-and-crown-delineation.html#cb245-26" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb245-27"><a href="validate-tree-detection-and-crown-delineation.html#cb245-27" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>,<span class="at">axis.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">6</span>)) <span class="sc">+</span></span>
<span id="cb245-28"><a href="validate-tree-detection-and-crown-delineation.html#cb245-28" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">guides</span>(<span class="at">col =</span> ggplot2<span class="sc">::</span><span class="fu">guide_legend</span>(<span class="at">ncol =</span> <span class="dv">1</span>))</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-216-1.png" width="1008" /></p>
<p>no</p>
<p>let’s look at the RGB imagery and image annotated crowns (notice that the <code>NeonTreeEvaluation</code> commands rely on the deprecated <code>raster</code> package :)</p>
<div class="sourceCode" id="cb246"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb246-1"><a href="validate-tree-detection-and-crown-delineation.html#cb246-1" tabindex="-1"></a>neontree_plot_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(plot_name,<span class="at">lwd=</span><span class="dv">2</span>) {</span>
<span id="cb246-2"><a href="validate-tree-detection-and-crown-delineation.html#cb246-2" tabindex="-1"></a>  <span class="co"># read rgb</span></span>
<span id="cb246-3"><a href="validate-tree-detection-and-crown-delineation.html#cb246-3" tabindex="-1"></a>  rgb_temp <span class="ot">&lt;-</span> </span>
<span id="cb246-4"><a href="validate-tree-detection-and-crown-delineation.html#cb246-4" tabindex="-1"></a>    NeonTreeEvaluation<span class="sc">::</span><span class="fu">get_data</span>(<span class="at">plot_name =</span> plot_name, <span class="at">type =</span> <span class="st">&quot;rgb&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb246-5"><a href="validate-tree-detection-and-crown-delineation.html#cb246-5" tabindex="-1"></a>    raster<span class="sc">::</span><span class="fu">stack</span>()</span>
<span id="cb246-6"><a href="validate-tree-detection-and-crown-delineation.html#cb246-6" tabindex="-1"></a>  </span>
<span id="cb246-7"><a href="validate-tree-detection-and-crown-delineation.html#cb246-7" tabindex="-1"></a>  <span class="co"># read image annotated crown data and make polygons</span></span>
<span id="cb246-8"><a href="validate-tree-detection-and-crown-delineation.html#cb246-8" tabindex="-1"></a>  polys_temp <span class="ot">&lt;-</span></span>
<span id="cb246-9"><a href="validate-tree-detection-and-crown-delineation.html#cb246-9" tabindex="-1"></a>    NeonTreeEvaluation<span class="sc">::</span><span class="fu">get_data</span>(<span class="at">plot_name =</span> plot_name, <span class="at">type =</span> <span class="st">&quot;annotations&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb246-10"><a href="validate-tree-detection-and-crown-delineation.html#cb246-10" tabindex="-1"></a>    NeonTreeEvaluation<span class="sc">::</span><span class="fu">xml_parse</span>() </span>
<span id="cb246-11"><a href="validate-tree-detection-and-crown-delineation.html#cb246-11" tabindex="-1"></a>  polys_temp <span class="ot">&lt;-</span> NeonTreeEvaluation<span class="sc">::</span><span class="fu">boxes_to_spatial_polygons</span>(polys_temp,rgb_temp)</span>
<span id="cb246-12"><a href="validate-tree-detection-and-crown-delineation.html#cb246-12" tabindex="-1"></a>  </span>
<span id="cb246-13"><a href="validate-tree-detection-and-crown-delineation.html#cb246-13" tabindex="-1"></a>  <span class="co"># plot</span></span>
<span id="cb246-14"><a href="validate-tree-detection-and-crown-delineation.html#cb246-14" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">plotRGB</span>(rgb_temp <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">rast</span>(), <span class="at">main =</span> plot_name)</span>
<span id="cb246-15"><a href="validate-tree-detection-and-crown-delineation.html#cb246-15" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">plot</span>(</span>
<span id="cb246-16"><a href="validate-tree-detection-and-crown-delineation.html#cb246-16" tabindex="-1"></a>    polys_temp <span class="sc">%&gt;%</span> terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb246-17"><a href="validate-tree-detection-and-crown-delineation.html#cb246-17" tabindex="-1"></a>    , <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">border =</span> <span class="st">&quot;red&quot;</span></span>
<span id="cb246-18"><a href="validate-tree-detection-and-crown-delineation.html#cb246-18" tabindex="-1"></a>    , <span class="at">lwd =</span> lwd , <span class="at">add =</span> <span class="cn">TRUE</span></span>
<span id="cb246-19"><a href="validate-tree-detection-and-crown-delineation.html#cb246-19" tabindex="-1"></a>  )</span>
<span id="cb246-20"><a href="validate-tree-detection-and-crown-delineation.html#cb246-20" tabindex="-1"></a>}</span>
<span id="cb246-21"><a href="validate-tree-detection-and-crown-delineation.html#cb246-21" tabindex="-1"></a><span class="co"># 2019_OSBS_5_405000_3287000_image_crop</span></span>
<span id="cb246-22"><a href="validate-tree-detection-and-crown-delineation.html#cb246-22" tabindex="-1"></a><span class="fu">neontree_plot_fn</span>(<span class="st">&quot;2019_OSBS_5_405000_3287000_image_crop&quot;</span>)</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-217-1.png" width="1008" /></p>
<div class="sourceCode" id="cb247"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb247-1"><a href="validate-tree-detection-and-crown-delineation.html#cb247-1" tabindex="-1"></a><span class="co"># 2019_OSBS_5_405000_3287000_image_crop2</span></span>
<span id="cb247-2"><a href="validate-tree-detection-and-crown-delineation.html#cb247-2" tabindex="-1"></a><span class="fu">neontree_plot_fn</span>(<span class="st">&quot;2019_OSBS_5_405000_3287000_image_crop2&quot;</span>)</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-217-2.png" width="1008" /></p>
</div>
<div id="xtract" class="section level4 hasAnchor" number="4.2.4.2">
<h4><span class="header-section-number">4.2.4.2</span> Function to extract trees<a href="validate-tree-detection-and-crown-delineation.html#xtract" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>let’s create a function to extract trees and format for evaluation using our <code>lidar_df</code> data which includes a data frame of file paths with the appropriate plot name</p>
<div class="sourceCode" id="cb248"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb248-1"><a href="validate-tree-detection-and-crown-delineation.html#cb248-1" tabindex="-1"></a>cloud2trees_for_eval <span class="ot">&lt;-</span> <span class="cf">function</span>(lidar_df_row, lidar_df, ws) {</span>
<span id="cb248-2"><a href="validate-tree-detection-and-crown-delineation.html#cb248-2" tabindex="-1"></a>  <span class="co"># message</span></span>
<span id="cb248-3"><a href="validate-tree-detection-and-crown-delineation.html#cb248-3" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">paste0</span>(<span class="st">&quot;doing the work for ...... &quot;</span>, lidar_df<span class="sc">$</span>plot_name[lidar_df_row]))</span>
<span id="cb248-4"><a href="validate-tree-detection-and-crown-delineation.html#cb248-4" tabindex="-1"></a>  <span class="co"># run c2t</span></span>
<span id="cb248-5"><a href="validate-tree-detection-and-crown-delineation.html#cb248-5" tabindex="-1"></a>  qc2t <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">safely</span>(cloud2trees<span class="sc">::</span>cloud2trees)</span>
<span id="cb248-6"><a href="validate-tree-detection-and-crown-delineation.html#cb248-6" tabindex="-1"></a>  ans <span class="ot">&lt;-</span> <span class="fu">qc2t</span>(</span>
<span id="cb248-7"><a href="validate-tree-detection-and-crown-delineation.html#cb248-7" tabindex="-1"></a>    <span class="at">input_las_dir =</span> lidar_df<span class="sc">$</span>f_path[lidar_df_row]</span>
<span id="cb248-8"><a href="validate-tree-detection-and-crown-delineation.html#cb248-8" tabindex="-1"></a>    , <span class="at">output_dir =</span> <span class="fu">tempdir</span>()</span>
<span id="cb248-9"><a href="validate-tree-detection-and-crown-delineation.html#cb248-9" tabindex="-1"></a>    , <span class="at">ws =</span> ws</span>
<span id="cb248-10"><a href="validate-tree-detection-and-crown-delineation.html#cb248-10" tabindex="-1"></a>  )</span>
<span id="cb248-11"><a href="validate-tree-detection-and-crown-delineation.html#cb248-11" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(ans<span class="sc">$</span>error)){<span class="fu">return</span>(<span class="cn">NULL</span>)}</span>
<span id="cb248-12"><a href="validate-tree-detection-and-crown-delineation.html#cb248-12" tabindex="-1"></a>  ans <span class="ot">&lt;-</span> ans<span class="sc">$</span>result</span>
<span id="cb248-13"><a href="validate-tree-detection-and-crown-delineation.html#cb248-13" tabindex="-1"></a>  <span class="co"># simp</span></span>
<span id="cb248-14"><a href="validate-tree-detection-and-crown-delineation.html#cb248-14" tabindex="-1"></a>  ans<span class="sc">$</span>crowns_sf <span class="ot">&lt;-</span> cloud2trees<span class="sc">::</span><span class="fu">simplify_multipolygon_crowns</span>(ans<span class="sc">$</span>crowns_sf)</span>
<span id="cb248-15"><a href="validate-tree-detection-and-crown-delineation.html#cb248-15" tabindex="-1"></a>  <span class="co"># return</span></span>
<span id="cb248-16"><a href="validate-tree-detection-and-crown-delineation.html#cb248-16" tabindex="-1"></a>  return_sf <span class="ot">&lt;-</span></span>
<span id="cb248-17"><a href="validate-tree-detection-and-crown-delineation.html#cb248-17" tabindex="-1"></a>    ans<span class="sc">$</span>crowns_sf <span class="sc">%&gt;%</span> </span>
<span id="cb248-18"><a href="validate-tree-detection-and-crown-delineation.html#cb248-18" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_set_geometry</span>(<span class="st">&quot;geometry&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb248-19"><a href="validate-tree-detection-and-crown-delineation.html#cb248-19" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rowwise</span>(<span class="st">&quot;treeID&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb248-20"><a href="validate-tree-detection-and-crown-delineation.html#cb248-20" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb248-21"><a href="validate-tree-detection-and-crown-delineation.html#cb248-21" tabindex="-1"></a>      <span class="at">xmin =</span> sf<span class="sc">::</span><span class="fu">st_bbox</span>(geometry)[<span class="dv">1</span>]</span>
<span id="cb248-22"><a href="validate-tree-detection-and-crown-delineation.html#cb248-22" tabindex="-1"></a>      , <span class="at">ymin =</span> sf<span class="sc">::</span><span class="fu">st_bbox</span>(geometry)[<span class="dv">2</span>]</span>
<span id="cb248-23"><a href="validate-tree-detection-and-crown-delineation.html#cb248-23" tabindex="-1"></a>      , <span class="at">xmax =</span> sf<span class="sc">::</span><span class="fu">st_bbox</span>(geometry)[<span class="dv">3</span>]</span>
<span id="cb248-24"><a href="validate-tree-detection-and-crown-delineation.html#cb248-24" tabindex="-1"></a>      , <span class="at">ymax =</span> sf<span class="sc">::</span><span class="fu">st_bbox</span>(geometry)[<span class="dv">4</span>]</span>
<span id="cb248-25"><a href="validate-tree-detection-and-crown-delineation.html#cb248-25" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb248-26"><a href="validate-tree-detection-and-crown-delineation.html#cb248-26" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb248-27"><a href="validate-tree-detection-and-crown-delineation.html#cb248-27" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb248-28"><a href="validate-tree-detection-and-crown-delineation.html#cb248-28" tabindex="-1"></a>      <span class="at">label =</span> <span class="st">&quot;Tree&quot;</span></span>
<span id="cb248-29"><a href="validate-tree-detection-and-crown-delineation.html#cb248-29" tabindex="-1"></a>      , <span class="at">plot_name =</span> lidar_df<span class="sc">$</span>plot_name[lidar_df_row]</span>
<span id="cb248-30"><a href="validate-tree-detection-and-crown-delineation.html#cb248-30" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb248-31"><a href="validate-tree-detection-and-crown-delineation.html#cb248-31" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(xmin,xmax,ymin,ymax,label,plot_name,tree_height_m) <span class="sc">%&gt;%</span> </span>
<span id="cb248-32"><a href="validate-tree-detection-and-crown-delineation.html#cb248-32" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_set_crs</span>(<span class="cn">NA</span>)</span>
<span id="cb248-33"><a href="validate-tree-detection-and-crown-delineation.html#cb248-33" tabindex="-1"></a>  <span class="co"># give the workers a rest</span></span>
<span id="cb248-34"><a href="validate-tree-detection-and-crown-delineation.html#cb248-34" tabindex="-1"></a>  <span class="fu">Sys.sleep</span>(<span class="dv">2</span>)</span>
<span id="cb248-35"><a href="validate-tree-detection-and-crown-delineation.html#cb248-35" tabindex="-1"></a>  <span class="fu">return</span>(return_sf)</span>
<span id="cb248-36"><a href="validate-tree-detection-and-crown-delineation.html#cb248-36" tabindex="-1"></a>}</span>
<span id="cb248-37"><a href="validate-tree-detection-and-crown-delineation.html#cb248-37" tabindex="-1"></a><span class="co"># function to apply cloud2trees_for_eval over each ws</span></span>
<span id="cb248-38"><a href="validate-tree-detection-and-crown-delineation.html#cb248-38" tabindex="-1"></a>ws_fn_eval <span class="ot">&lt;-</span> <span class="cf">function</span>(lidar_df, lidar_df_row, ws_fn_list) {</span>
<span id="cb248-39"><a href="validate-tree-detection-and-crown-delineation.html#cb248-39" tabindex="-1"></a>  <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(ws_fn_list) <span class="sc">%&gt;%</span> </span>
<span id="cb248-40"><a href="validate-tree-detection-and-crown-delineation.html#cb248-40" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">map</span>(<span class="cf">function</span>(x){</span>
<span id="cb248-41"><a href="validate-tree-detection-and-crown-delineation.html#cb248-41" tabindex="-1"></a>      ans <span class="ot">&lt;-</span> <span class="fu">cloud2trees_for_eval</span>(</span>
<span id="cb248-42"><a href="validate-tree-detection-and-crown-delineation.html#cb248-42" tabindex="-1"></a>        <span class="at">lidar_df_row =</span> lidar_df_row</span>
<span id="cb248-43"><a href="validate-tree-detection-and-crown-delineation.html#cb248-43" tabindex="-1"></a>        , <span class="at">lidar_df =</span> lidar_df</span>
<span id="cb248-44"><a href="validate-tree-detection-and-crown-delineation.html#cb248-44" tabindex="-1"></a>        , <span class="at">ws =</span> ws_fn_list[[x]]</span>
<span id="cb248-45"><a href="validate-tree-detection-and-crown-delineation.html#cb248-45" tabindex="-1"></a>      )</span>
<span id="cb248-46"><a href="validate-tree-detection-and-crown-delineation.html#cb248-46" tabindex="-1"></a>      <span class="do">### some of these ws functions may not extract any trees</span></span>
<span id="cb248-47"><a href="validate-tree-detection-and-crown-delineation.html#cb248-47" tabindex="-1"></a>      <span class="do">### account for this</span></span>
<span id="cb248-48"><a href="validate-tree-detection-and-crown-delineation.html#cb248-48" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">is.null</span>(ans) <span class="sc">||</span> <span class="sc">!</span><span class="fu">inherits</span>(ans,<span class="st">&quot;data.frame&quot;</span>)){</span>
<span id="cb248-49"><a href="validate-tree-detection-and-crown-delineation.html#cb248-49" tabindex="-1"></a>        <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb248-50"><a href="validate-tree-detection-and-crown-delineation.html#cb248-50" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb248-51"><a href="validate-tree-detection-and-crown-delineation.html#cb248-51" tabindex="-1"></a>        <span class="fu">return</span>(</span>
<span id="cb248-52"><a href="validate-tree-detection-and-crown-delineation.html#cb248-52" tabindex="-1"></a>          ans <span class="sc">%&gt;%</span> </span>
<span id="cb248-53"><a href="validate-tree-detection-and-crown-delineation.html#cb248-53" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">ws_fn_nm =</span> ws_fn_list[x] <span class="sc">%&gt;%</span> <span class="fu">names</span>() <span class="sc">%&gt;%</span> <span class="fu">as.character</span>())</span>
<span id="cb248-54"><a href="validate-tree-detection-and-crown-delineation.html#cb248-54" tabindex="-1"></a>        )</span>
<span id="cb248-55"><a href="validate-tree-detection-and-crown-delineation.html#cb248-55" tabindex="-1"></a>      }</span>
<span id="cb248-56"><a href="validate-tree-detection-and-crown-delineation.html#cb248-56" tabindex="-1"></a>    }) <span class="sc">%&gt;%</span> </span>
<span id="cb248-57"><a href="validate-tree-detection-and-crown-delineation.html#cb248-57" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span>
<span id="cb248-58"><a href="validate-tree-detection-and-crown-delineation.html#cb248-58" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="extract-trees-for-training-data" class="section level4 hasAnchor" number="4.2.4.3">
<h4><span class="header-section-number">4.2.4.3</span> Extract trees for training data<a href="validate-tree-detection-and-crown-delineation.html#extract-trees-for-training-data" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Now we’ll extract trees from the training lidar data using each variable window function</p>
<div class="sourceCode" id="cb249"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb249-1"><a href="validate-tree-detection-and-crown-delineation.html#cb249-1" tabindex="-1"></a><span class="co"># where should we save the file?</span></span>
<span id="cb249-2"><a href="validate-tree-detection-and-crown-delineation.html#cb249-2" tabindex="-1"></a>submission_fn <span class="ot">&lt;-</span> <span class="st">&quot;../data/NeonTreeEvaluation_training_submission.gpkg&quot;</span></span>
<span id="cb249-3"><a href="validate-tree-detection-and-crown-delineation.html#cb249-3" tabindex="-1"></a><span class="co"># if we don&#39;t already have the data, run it</span></span>
<span id="cb249-4"><a href="validate-tree-detection-and-crown-delineation.html#cb249-4" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(submission_fn)){</span>
<span id="cb249-5"><a href="validate-tree-detection-and-crown-delineation.html#cb249-5" tabindex="-1"></a><span class="co"># if(T){ </span><span class="al">###</span><span class="co"> !!!!!!! take out when it gets real</span></span>
<span id="cb249-6"><a href="validate-tree-detection-and-crown-delineation.html#cb249-6" tabindex="-1"></a>  <span class="co"># just get training</span></span>
<span id="cb249-7"><a href="validate-tree-detection-and-crown-delineation.html#cb249-7" tabindex="-1"></a>  training_df_temp <span class="ot">&lt;-</span> lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb249-8"><a href="validate-tree-detection-and-crown-delineation.html#cb249-8" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(data_type <span class="sc">==</span> <span class="st">&quot;training&quot;</span> <span class="sc">|</span> is_new_image_annotation_training <span class="sc">|</span> is_new_field_stems_training)</span>
<span id="cb249-9"><a href="validate-tree-detection-and-crown-delineation.html#cb249-9" tabindex="-1"></a>  <span class="co"># get trees for each training plot and ws fn combination</span></span>
<span id="cb249-10"><a href="validate-tree-detection-and-crown-delineation.html#cb249-10" tabindex="-1"></a>  training_submission <span class="ot">&lt;-</span> </span>
<span id="cb249-11"><a href="validate-tree-detection-and-crown-delineation.html#cb249-11" tabindex="-1"></a>    <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(training_df_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb249-12"><a href="validate-tree-detection-and-crown-delineation.html#cb249-12" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">map</span>(\(x) </span>
<span id="cb249-13"><a href="validate-tree-detection-and-crown-delineation.html#cb249-13" tabindex="-1"></a>      <span class="fu">ws_fn_eval</span>(</span>
<span id="cb249-14"><a href="validate-tree-detection-and-crown-delineation.html#cb249-14" tabindex="-1"></a>        <span class="at">lidar_df =</span> training_df_temp </span>
<span id="cb249-15"><a href="validate-tree-detection-and-crown-delineation.html#cb249-15" tabindex="-1"></a>        , <span class="at">lidar_df_row =</span> x</span>
<span id="cb249-16"><a href="validate-tree-detection-and-crown-delineation.html#cb249-16" tabindex="-1"></a>        , <span class="at">ws_fn_list =</span> my_ws_functions</span>
<span id="cb249-17"><a href="validate-tree-detection-and-crown-delineation.html#cb249-17" tabindex="-1"></a>      )</span>
<span id="cb249-18"><a href="validate-tree-detection-and-crown-delineation.html#cb249-18" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb249-19"><a href="validate-tree-detection-and-crown-delineation.html#cb249-19" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span>
<span id="cb249-20"><a href="validate-tree-detection-and-crown-delineation.html#cb249-20" tabindex="-1"></a>  <span class="co"># save it </span></span>
<span id="cb249-21"><a href="validate-tree-detection-and-crown-delineation.html#cb249-21" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_write</span>(training_submission, submission_fn, <span class="at">append =</span> F)</span>
<span id="cb249-22"><a href="validate-tree-detection-and-crown-delineation.html#cb249-22" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb249-23"><a href="validate-tree-detection-and-crown-delineation.html#cb249-23" tabindex="-1"></a>  training_submission <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(submission_fn, <span class="at">quiet =</span> T)</span>
<span id="cb249-24"><a href="validate-tree-detection-and-crown-delineation.html#cb249-24" tabindex="-1"></a>}</span></code></pre></div>
<p>what did we get?</p>
<div class="sourceCode" id="cb250"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb250-1"><a href="validate-tree-detection-and-crown-delineation.html#cb250-1" tabindex="-1"></a>training_submission <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 1,676,534
## Columns: 9
## $ xmin          &lt;dbl&gt; 551846.5, 551848.5, 551856.2, 551865.0, 551866.2, 551875…
## $ xmax          &lt;dbl&gt; 551848.8, 551849.8, 551857.0, 551866.2, 551867.5, 551877…
## $ ymin          &lt;dbl&gt; 5067861, 5067862, 5067862, 5067862, 5067861, 5067862, 50…
## $ ymax          &lt;dbl&gt; 5067863, 5067863, 5067863, 5067863, 5067863, 5067863, 50…
## $ label         &lt;chr&gt; &quot;Tree&quot;, &quot;Tree&quot;, &quot;Tree&quot;, &quot;Tree&quot;, &quot;Tree&quot;, &quot;Tree&quot;, &quot;Tree&quot;, …
## $ plot_name     &lt;chr&gt; &quot;ABBY_065_2018&quot;, &quot;ABBY_065_2018&quot;, &quot;ABBY_065_2018&quot;, &quot;ABBY…
## $ tree_height_m &lt;dbl&gt; 5.064, 3.792, 2.466, 5.998, 3.700, 4.503, 2.574, 6.829, …
## $ ws_fn_nm      &lt;chr&gt; &quot;lin_fn&quot;, &quot;lin_fn&quot;, &quot;lin_fn&quot;, &quot;lin_fn&quot;, &quot;lin_fn&quot;, &quot;lin_f…
## $ geom          &lt;POLYGON&gt; POLYGON ((551846.5 5067863,..., POLYGON ((551848.5 5…</code></pre>
<p>now we need to filter our tree list based on the <a href="validate-tree-detection-and-crown-delineation.html#ht_filter">height threshold for “canopy” trees</a></p>
<div class="sourceCode" id="cb252"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb252-1"><a href="validate-tree-detection-and-crown-delineation.html#cb252-1" tabindex="-1"></a>training_submission <span class="ot">&lt;-</span></span>
<span id="cb252-2"><a href="validate-tree-detection-and-crown-delineation.html#cb252-2" tabindex="-1"></a>  training_submission <span class="sc">%&gt;%</span> </span>
<span id="cb252-3"><a href="validate-tree-detection-and-crown-delineation.html#cb252-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb252-4"><a href="validate-tree-detection-and-crown-delineation.html#cb252-4" tabindex="-1"></a>    lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb252-5"><a href="validate-tree-detection-and-crown-delineation.html#cb252-5" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb252-6"><a href="validate-tree-detection-and-crown-delineation.html#cb252-6" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb252-7"><a href="validate-tree-detection-and-crown-delineation.html#cb252-7" tabindex="-1"></a>        data_type<span class="sc">==</span><span class="st">&quot;training&quot;</span> <span class="sc">|</span> is_new_image_annotation_training <span class="sc">|</span> is_new_field_stems_training</span>
<span id="cb252-8"><a href="validate-tree-detection-and-crown-delineation.html#cb252-8" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb252-9"><a href="validate-tree-detection-and-crown-delineation.html#cb252-9" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(plot_name,site_prcntl_ht)</span>
<span id="cb252-10"><a href="validate-tree-detection-and-crown-delineation.html#cb252-10" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;plot_name&quot;</span></span>
<span id="cb252-11"><a href="validate-tree-detection-and-crown-delineation.html#cb252-11" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb252-12"><a href="validate-tree-detection-and-crown-delineation.html#cb252-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(tree_height_m<span class="sc">&gt;=</span>site_prcntl_ht) <span class="sc">%&gt;%</span> </span>
<span id="cb252-13"><a href="validate-tree-detection-and-crown-delineation.html#cb252-13" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(tree_height_m,site_prcntl_ht))</span></code></pre></div>
<p>tabulate detected “canopy” trees by plot and variable window function and plot it</p>
<div class="sourceCode" id="cb253"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb253-1"><a href="validate-tree-detection-and-crown-delineation.html#cb253-1" tabindex="-1"></a>training_submission <span class="sc">%&gt;%</span> </span>
<span id="cb253-2"><a href="validate-tree-detection-and-crown-delineation.html#cb253-2" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb253-3"><a href="validate-tree-detection-and-crown-delineation.html#cb253-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(plot_name,ws_fn_nm) <span class="sc">%&gt;%</span> </span>
<span id="cb253-4"><a href="validate-tree-detection-and-crown-delineation.html#cb253-4" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> n, <span class="at">y =</span> plot_name, <span class="at">color =</span> ws_fn_nm)) <span class="sc">+</span></span>
<span id="cb253-5"><a href="validate-tree-detection-and-crown-delineation.html#cb253-5" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb253-6"><a href="validate-tree-detection-and-crown-delineation.html#cb253-6" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> pal_ws) <span class="sc">+</span></span>
<span id="cb253-7"><a href="validate-tree-detection-and-crown-delineation.html#cb253-7" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_x_log10</span>(<span class="at">labels=</span>scales<span class="sc">::</span>comma) <span class="sc">+</span></span>
<span id="cb253-8"><a href="validate-tree-detection-and-crown-delineation.html#cb253-8" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb253-9"><a href="validate-tree-detection-and-crown-delineation.html#cb253-9" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">&quot;# trees&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb253-10"><a href="validate-tree-detection-and-crown-delineation.html#cb253-10" tabindex="-1"></a>      , <span class="at">color =</span> <span class="st">&quot;variable</span><span class="sc">\n</span><span class="st">window</span><span class="sc">\n</span><span class="st">function&quot;</span></span>
<span id="cb253-11"><a href="validate-tree-detection-and-crown-delineation.html#cb253-11" tabindex="-1"></a>      , <span class="at">subtitle =</span> <span class="st">&quot;Training data: number of detected canopy trees&quot;</span></span>
<span id="cb253-12"><a href="validate-tree-detection-and-crown-delineation.html#cb253-12" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb253-13"><a href="validate-tree-detection-and-crown-delineation.html#cb253-13" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb253-14"><a href="validate-tree-detection-and-crown-delineation.html#cb253-14" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb253-15"><a href="validate-tree-detection-and-crown-delineation.html#cb253-15" tabindex="-1"></a>      <span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">8</span>)</span>
<span id="cb253-16"><a href="validate-tree-detection-and-crown-delineation.html#cb253-16" tabindex="-1"></a>      , <span class="at">panel.grid.major.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_line</span>(<span class="at">color=</span><span class="st">&quot;gray22&quot;</span>)</span>
<span id="cb253-17"><a href="validate-tree-detection-and-crown-delineation.html#cb253-17" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb253-18"><a href="validate-tree-detection-and-crown-delineation.html#cb253-18" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">guides</span>(</span>
<span id="cb253-19"><a href="validate-tree-detection-and-crown-delineation.html#cb253-19" tabindex="-1"></a>      <span class="at">color =</span> ggplot2<span class="sc">::</span><span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">shape =</span> <span class="dv">15</span>, <span class="at">size =</span> <span class="dv">6</span>))</span>
<span id="cb253-20"><a href="validate-tree-detection-and-crown-delineation.html#cb253-20" tabindex="-1"></a>    )</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-224-1.png" width="1008" /></p>
</div>
<div id="training-validation-against-ground-truth" class="section level4 hasAnchor" number="4.2.4.4">
<h4><span class="header-section-number">4.2.4.4</span> Training: validation against ground truth<a href="validate-tree-detection-and-crown-delineation.html#training-validation-against-ground-truth" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>We’ll compare our aerial point cloud-based tree detection and crown delineation results to two types of evaluation data (i.e. “ground truth” data) presented by Weinstein et al. (<a href="https://scholar.google.com/scholar?cluster=4986448711981898434&amp;hl=en&amp;as_sdt=0,6">2021</a>): field-collected stems and image-annotated crowns. Field-collected stems offer precise tree locations but might not align with the position of the tree crown as viewed from above (e.g. due to tree lean), image-annotated crowns outline crown boundaries but are subjective.</p>
<p>Precision quantifies the proportion of correctly identified tree crowns among all detected crowns (how many of the trees it found were real trees). Recall measures the proportion of correctly identified crowns relative to the total image-annotated tree crowns (how many of the actual trees it managed to find).</p>
<p><code>NeonTreeEvaluation::evaluate_image_crowns()</code> is used to evaluate our data against the image-annotated crowns ground truth. This function returns precision and recall per image (i.e. “plot”). <code>NeonTreeEvaluation::evaluate_field_stems()</code> is used to evaluate our data against the field collected stems ground truth. This function returns recall – the proportion of field stems that fall within a single predicted crown – per image (i.e. “plot”). We will apply both evaluation methods over each variable window function tested for each plot marked as training data.</p>
<div id="scores-for-image-annotated-crowns-1" class="section level5 hasAnchor" number="4.2.4.4.1">
<h5><span class="header-section-number">4.2.4.4.1</span> Scores for image-annotated crowns<a href="validate-tree-detection-and-crown-delineation.html#scores-for-image-annotated-crowns-1" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Get the benchmark score compared to image-annotated “ground truth” data.</p>
<p><em>in testing, including the <code>sf</code> polygon data did not work…switching to the bbox method with <code>sf::st_drop_geometry()</code></em></p>
<div class="sourceCode" id="cb254"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb254-1"><a href="validate-tree-detection-and-crown-delineation.html#cb254-1" tabindex="-1"></a><span class="co"># where should we save the file?</span></span>
<span id="cb254-2"><a href="validate-tree-detection-and-crown-delineation.html#cb254-2" tabindex="-1"></a>training_eval_temp <span class="ot">&lt;-</span> <span class="st">&quot;../data/NeonTreeEvaluation_training_evaluate_image_crowns.csv&quot;</span></span>
<span id="cb254-3"><a href="validate-tree-detection-and-crown-delineation.html#cb254-3" tabindex="-1"></a><span class="co"># if we don&#39;t already have the data, run it</span></span>
<span id="cb254-4"><a href="validate-tree-detection-and-crown-delineation.html#cb254-4" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(training_eval_temp)){</span>
<span id="cb254-5"><a href="validate-tree-detection-and-crown-delineation.html#cb254-5" tabindex="-1"></a><span class="co"># if(T){</span></span>
<span id="cb254-6"><a href="validate-tree-detection-and-crown-delineation.html#cb254-6" tabindex="-1"></a>  <span class="co"># filter for only those with this type of validation data</span></span>
<span id="cb254-7"><a href="validate-tree-detection-and-crown-delineation.html#cb254-7" tabindex="-1"></a>  submission_temp <span class="ot">&lt;-</span> training_submission <span class="sc">%&gt;%</span> </span>
<span id="cb254-8"><a href="validate-tree-detection-and-crown-delineation.html#cb254-8" tabindex="-1"></a>    <span class="do">## !!!!!!!!!!!! do these separate b/c memory crash :/</span></span>
<span id="cb254-9"><a href="validate-tree-detection-and-crown-delineation.html#cb254-9" tabindex="-1"></a>    <span class="do">## hate that this is manual but i&#39;m.....tired</span></span>
<span id="cb254-10"><a href="validate-tree-detection-and-crown-delineation.html#cb254-10" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb254-11"><a href="validate-tree-detection-and-crown-delineation.html#cb254-11" tabindex="-1"></a>      <span class="sc">!</span>plot_name <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;2018_NIWO_2_450000_4426000_image_crop&quot;</span>,<span class="st">&quot;2018_TEAK_3_315000_4094000_image_crop&quot;</span>)</span>
<span id="cb254-12"><a href="validate-tree-detection-and-crown-delineation.html#cb254-12" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb254-13"><a href="validate-tree-detection-and-crown-delineation.html#cb254-13" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb254-14"><a href="validate-tree-detection-and-crown-delineation.html#cb254-14" tabindex="-1"></a>      lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb254-15"><a href="validate-tree-detection-and-crown-delineation.html#cb254-15" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb254-16"><a href="validate-tree-detection-and-crown-delineation.html#cb254-16" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(has_image_annotation<span class="sc">==</span>T <span class="sc">&amp;</span> (data_type <span class="sc">==</span> <span class="st">&quot;training&quot;</span> <span class="sc">|</span> is_new_image_annotation_training)) <span class="sc">%&gt;%</span> </span>
<span id="cb254-17"><a href="validate-tree-detection-and-crown-delineation.html#cb254-17" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">distinct</span>(plot_name)</span>
<span id="cb254-18"><a href="validate-tree-detection-and-crown-delineation.html#cb254-18" tabindex="-1"></a>      , <span class="at">by =</span> <span class="st">&quot;plot_name&quot;</span></span>
<span id="cb254-19"><a href="validate-tree-detection-and-crown-delineation.html#cb254-19" tabindex="-1"></a>    )</span>
<span id="cb254-20"><a href="validate-tree-detection-and-crown-delineation.html#cb254-20" tabindex="-1"></a>  </span>
<span id="cb254-21"><a href="validate-tree-detection-and-crown-delineation.html#cb254-21" tabindex="-1"></a>  <span class="co"># safe it bc: error in `clue::solve_LSAP()`: long vectors (argument 1) are not supported</span></span>
<span id="cb254-22"><a href="validate-tree-detection-and-crown-delineation.html#cb254-22" tabindex="-1"></a>  <span class="co"># would need to dig through NeonTreeEvaluation, fix, and pull request...</span></span>
<span id="cb254-23"><a href="validate-tree-detection-and-crown-delineation.html#cb254-23" tabindex="-1"></a>  safe_evaluate_image_crowns <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">safely</span>(NeonTreeEvaluation<span class="sc">::</span>evaluate_image_crowns)</span>
<span id="cb254-24"><a href="validate-tree-detection-and-crown-delineation.html#cb254-24" tabindex="-1"></a>  <span class="co"># validate</span></span>
<span id="cb254-25"><a href="validate-tree-detection-and-crown-delineation.html#cb254-25" tabindex="-1"></a>  training_img_annttd_crwns <span class="ot">&lt;-</span></span>
<span id="cb254-26"><a href="validate-tree-detection-and-crown-delineation.html#cb254-26" tabindex="-1"></a>    submission_temp<span class="sc">$</span>ws_fn_nm <span class="sc">%&gt;%</span> </span>
<span id="cb254-27"><a href="validate-tree-detection-and-crown-delineation.html#cb254-27" tabindex="-1"></a>    <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb254-28"><a href="validate-tree-detection-and-crown-delineation.html#cb254-28" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">map</span>(<span class="cf">function</span>(x){</span>
<span id="cb254-29"><a href="validate-tree-detection-and-crown-delineation.html#cb254-29" tabindex="-1"></a>      ans <span class="ot">&lt;-</span> <span class="fu">safe_evaluate_image_crowns</span>(</span>
<span id="cb254-30"><a href="validate-tree-detection-and-crown-delineation.html#cb254-30" tabindex="-1"></a>        <span class="at">predictions =</span> submission_temp <span class="sc">%&gt;%</span> </span>
<span id="cb254-31"><a href="validate-tree-detection-and-crown-delineation.html#cb254-31" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb254-32"><a href="validate-tree-detection-and-crown-delineation.html#cb254-32" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(ws_fn_nm <span class="sc">==</span> x) <span class="sc">%&gt;%</span> </span>
<span id="cb254-33"><a href="validate-tree-detection-and-crown-delineation.html#cb254-33" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(xmin,ymin,xmax,ymax,label,plot_name)</span>
<span id="cb254-34"><a href="validate-tree-detection-and-crown-delineation.html#cb254-34" tabindex="-1"></a>        , <span class="at">show =</span> F</span>
<span id="cb254-35"><a href="validate-tree-detection-and-crown-delineation.html#cb254-35" tabindex="-1"></a>        , <span class="at">summarize =</span> T</span>
<span id="cb254-36"><a href="validate-tree-detection-and-crown-delineation.html#cb254-36" tabindex="-1"></a>      )</span>
<span id="cb254-37"><a href="validate-tree-detection-and-crown-delineation.html#cb254-37" tabindex="-1"></a>      <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(ans<span class="sc">$</span>error)){</span>
<span id="cb254-38"><a href="validate-tree-detection-and-crown-delineation.html#cb254-38" tabindex="-1"></a>        <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb254-39"><a href="validate-tree-detection-and-crown-delineation.html#cb254-39" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb254-40"><a href="validate-tree-detection-and-crown-delineation.html#cb254-40" tabindex="-1"></a>        <span class="fu">return</span>(</span>
<span id="cb254-41"><a href="validate-tree-detection-and-crown-delineation.html#cb254-41" tabindex="-1"></a>          ans<span class="sc">$</span>result <span class="sc">%&gt;%</span> </span>
<span id="cb254-42"><a href="validate-tree-detection-and-crown-delineation.html#cb254-42" tabindex="-1"></a>            purrr<span class="sc">::</span><span class="fu">pluck</span>(<span class="st">&quot;plot_level&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb254-43"><a href="validate-tree-detection-and-crown-delineation.html#cb254-43" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb254-44"><a href="validate-tree-detection-and-crown-delineation.html#cb254-44" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">ws_fn_nm =</span> x)</span>
<span id="cb254-45"><a href="validate-tree-detection-and-crown-delineation.html#cb254-45" tabindex="-1"></a>        ) </span>
<span id="cb254-46"><a href="validate-tree-detection-and-crown-delineation.html#cb254-46" tabindex="-1"></a>      }</span>
<span id="cb254-47"><a href="validate-tree-detection-and-crown-delineation.html#cb254-47" tabindex="-1"></a>    }) <span class="sc">%&gt;%</span> </span>
<span id="cb254-48"><a href="validate-tree-detection-and-crown-delineation.html#cb254-48" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span>
<span id="cb254-49"><a href="validate-tree-detection-and-crown-delineation.html#cb254-49" tabindex="-1"></a>  <span class="co"># save</span></span>
<span id="cb254-50"><a href="validate-tree-detection-and-crown-delineation.html#cb254-50" tabindex="-1"></a>  readr<span class="sc">::</span><span class="fu">write_csv</span>(training_img_annttd_crwns, <span class="at">file =</span> training_eval_temp)</span>
<span id="cb254-51"><a href="validate-tree-detection-and-crown-delineation.html#cb254-51" tabindex="-1"></a>  <span class="do">#################################</span></span>
<span id="cb254-52"><a href="validate-tree-detection-and-crown-delineation.html#cb254-52" tabindex="-1"></a>  <span class="co"># now for the big ones so we don&#39;t crash memory</span></span>
<span id="cb254-53"><a href="validate-tree-detection-and-crown-delineation.html#cb254-53" tabindex="-1"></a>  <span class="do">## hate that this is manual but i&#39;m.....tired</span></span>
<span id="cb254-54"><a href="validate-tree-detection-and-crown-delineation.html#cb254-54" tabindex="-1"></a>  <span class="do">#################################</span></span>
<span id="cb254-55"><a href="validate-tree-detection-and-crown-delineation.html#cb254-55" tabindex="-1"></a>  <span class="co"># filter for only those with this type of validation data</span></span>
<span id="cb254-56"><a href="validate-tree-detection-and-crown-delineation.html#cb254-56" tabindex="-1"></a>  submission_temp <span class="ot">&lt;-</span> training_submission <span class="sc">%&gt;%</span> </span>
<span id="cb254-57"><a href="validate-tree-detection-and-crown-delineation.html#cb254-57" tabindex="-1"></a>    <span class="do">## !!!!!!!!!!!! do these separate</span></span>
<span id="cb254-58"><a href="validate-tree-detection-and-crown-delineation.html#cb254-58" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(plot_name <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;2018_NIWO_2_450000_4426000_image_crop&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb254-59"><a href="validate-tree-detection-and-crown-delineation.html#cb254-59" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb254-60"><a href="validate-tree-detection-and-crown-delineation.html#cb254-60" tabindex="-1"></a>      lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb254-61"><a href="validate-tree-detection-and-crown-delineation.html#cb254-61" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb254-62"><a href="validate-tree-detection-and-crown-delineation.html#cb254-62" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(has_image_annotation<span class="sc">==</span>T) <span class="sc">%&gt;%</span> </span>
<span id="cb254-63"><a href="validate-tree-detection-and-crown-delineation.html#cb254-63" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">distinct</span>(plot_name)</span>
<span id="cb254-64"><a href="validate-tree-detection-and-crown-delineation.html#cb254-64" tabindex="-1"></a>      , <span class="at">by =</span> <span class="st">&quot;plot_name&quot;</span></span>
<span id="cb254-65"><a href="validate-tree-detection-and-crown-delineation.html#cb254-65" tabindex="-1"></a>    )</span>
<span id="cb254-66"><a href="validate-tree-detection-and-crown-delineation.html#cb254-66" tabindex="-1"></a>  <span class="co"># validate</span></span>
<span id="cb254-67"><a href="validate-tree-detection-and-crown-delineation.html#cb254-67" tabindex="-1"></a>  training_img_annttd_crwns_temp <span class="ot">&lt;-</span></span>
<span id="cb254-68"><a href="validate-tree-detection-and-crown-delineation.html#cb254-68" tabindex="-1"></a>    submission_temp<span class="sc">$</span>ws_fn_nm <span class="sc">%&gt;%</span> </span>
<span id="cb254-69"><a href="validate-tree-detection-and-crown-delineation.html#cb254-69" tabindex="-1"></a>    <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb254-70"><a href="validate-tree-detection-and-crown-delineation.html#cb254-70" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">map</span>(<span class="cf">function</span>(x){</span>
<span id="cb254-71"><a href="validate-tree-detection-and-crown-delineation.html#cb254-71" tabindex="-1"></a>      ans <span class="ot">&lt;-</span> <span class="fu">safe_evaluate_image_crowns</span>(</span>
<span id="cb254-72"><a href="validate-tree-detection-and-crown-delineation.html#cb254-72" tabindex="-1"></a>        <span class="at">predictions =</span> submission_temp <span class="sc">%&gt;%</span> </span>
<span id="cb254-73"><a href="validate-tree-detection-and-crown-delineation.html#cb254-73" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb254-74"><a href="validate-tree-detection-and-crown-delineation.html#cb254-74" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(ws_fn_nm <span class="sc">==</span> x) <span class="sc">%&gt;%</span> </span>
<span id="cb254-75"><a href="validate-tree-detection-and-crown-delineation.html#cb254-75" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(xmin,ymin,xmax,ymax,label,plot_name)</span>
<span id="cb254-76"><a href="validate-tree-detection-and-crown-delineation.html#cb254-76" tabindex="-1"></a>        , <span class="at">show =</span> F</span>
<span id="cb254-77"><a href="validate-tree-detection-and-crown-delineation.html#cb254-77" tabindex="-1"></a>        , <span class="at">summarize =</span> T</span>
<span id="cb254-78"><a href="validate-tree-detection-and-crown-delineation.html#cb254-78" tabindex="-1"></a>      )</span>
<span id="cb254-79"><a href="validate-tree-detection-and-crown-delineation.html#cb254-79" tabindex="-1"></a>      <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(ans<span class="sc">$</span>error)){</span>
<span id="cb254-80"><a href="validate-tree-detection-and-crown-delineation.html#cb254-80" tabindex="-1"></a>        <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb254-81"><a href="validate-tree-detection-and-crown-delineation.html#cb254-81" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb254-82"><a href="validate-tree-detection-and-crown-delineation.html#cb254-82" tabindex="-1"></a>        <span class="fu">return</span>(</span>
<span id="cb254-83"><a href="validate-tree-detection-and-crown-delineation.html#cb254-83" tabindex="-1"></a>          ans<span class="sc">$</span>result <span class="sc">%&gt;%</span> </span>
<span id="cb254-84"><a href="validate-tree-detection-and-crown-delineation.html#cb254-84" tabindex="-1"></a>            purrr<span class="sc">::</span><span class="fu">pluck</span>(<span class="st">&quot;plot_level&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb254-85"><a href="validate-tree-detection-and-crown-delineation.html#cb254-85" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb254-86"><a href="validate-tree-detection-and-crown-delineation.html#cb254-86" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">ws_fn_nm =</span> x)</span>
<span id="cb254-87"><a href="validate-tree-detection-and-crown-delineation.html#cb254-87" tabindex="-1"></a>        ) </span>
<span id="cb254-88"><a href="validate-tree-detection-and-crown-delineation.html#cb254-88" tabindex="-1"></a>      }</span>
<span id="cb254-89"><a href="validate-tree-detection-and-crown-delineation.html#cb254-89" tabindex="-1"></a>    }) <span class="sc">%&gt;%</span> </span>
<span id="cb254-90"><a href="validate-tree-detection-and-crown-delineation.html#cb254-90" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span>
<span id="cb254-91"><a href="validate-tree-detection-and-crown-delineation.html#cb254-91" tabindex="-1"></a>  <span class="co"># add it</span></span>
<span id="cb254-92"><a href="validate-tree-detection-and-crown-delineation.html#cb254-92" tabindex="-1"></a>  training_img_annttd_crwns <span class="ot">&lt;-</span> training_img_annttd_crwns <span class="sc">%&gt;%</span> </span>
<span id="cb254-93"><a href="validate-tree-detection-and-crown-delineation.html#cb254-93" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(training_img_annttd_crwns_temp)</span>
<span id="cb254-94"><a href="validate-tree-detection-and-crown-delineation.html#cb254-94" tabindex="-1"></a>  <span class="co"># save</span></span>
<span id="cb254-95"><a href="validate-tree-detection-and-crown-delineation.html#cb254-95" tabindex="-1"></a>  readr<span class="sc">::</span><span class="fu">write_csv</span>(training_img_annttd_crwns, <span class="at">file =</span> training_eval_temp)</span>
<span id="cb254-96"><a href="validate-tree-detection-and-crown-delineation.html#cb254-96" tabindex="-1"></a>  <span class="do">#################################</span></span>
<span id="cb254-97"><a href="validate-tree-detection-and-crown-delineation.html#cb254-97" tabindex="-1"></a>  <span class="co"># now for the big ones so we don&#39;t crash memory</span></span>
<span id="cb254-98"><a href="validate-tree-detection-and-crown-delineation.html#cb254-98" tabindex="-1"></a>  <span class="do">## hate that this is manual but i&#39;m.....tired</span></span>
<span id="cb254-99"><a href="validate-tree-detection-and-crown-delineation.html#cb254-99" tabindex="-1"></a>  <span class="do">#################################</span></span>
<span id="cb254-100"><a href="validate-tree-detection-and-crown-delineation.html#cb254-100" tabindex="-1"></a>  <span class="co"># filter for only those with this type of validation data</span></span>
<span id="cb254-101"><a href="validate-tree-detection-and-crown-delineation.html#cb254-101" tabindex="-1"></a>  submission_temp <span class="ot">&lt;-</span> training_submission <span class="sc">%&gt;%</span> </span>
<span id="cb254-102"><a href="validate-tree-detection-and-crown-delineation.html#cb254-102" tabindex="-1"></a>    <span class="do">## !!!!!!!!!!!! do these separate</span></span>
<span id="cb254-103"><a href="validate-tree-detection-and-crown-delineation.html#cb254-103" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(plot_name <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;2018_TEAK_3_315000_4094000_image_crop&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb254-104"><a href="validate-tree-detection-and-crown-delineation.html#cb254-104" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb254-105"><a href="validate-tree-detection-and-crown-delineation.html#cb254-105" tabindex="-1"></a>      lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb254-106"><a href="validate-tree-detection-and-crown-delineation.html#cb254-106" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb254-107"><a href="validate-tree-detection-and-crown-delineation.html#cb254-107" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(has_image_annotation<span class="sc">==</span>T) <span class="sc">%&gt;%</span> </span>
<span id="cb254-108"><a href="validate-tree-detection-and-crown-delineation.html#cb254-108" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">distinct</span>(plot_name)</span>
<span id="cb254-109"><a href="validate-tree-detection-and-crown-delineation.html#cb254-109" tabindex="-1"></a>      , <span class="at">by =</span> <span class="st">&quot;plot_name&quot;</span></span>
<span id="cb254-110"><a href="validate-tree-detection-and-crown-delineation.html#cb254-110" tabindex="-1"></a>    )</span>
<span id="cb254-111"><a href="validate-tree-detection-and-crown-delineation.html#cb254-111" tabindex="-1"></a>  <span class="co"># validate</span></span>
<span id="cb254-112"><a href="validate-tree-detection-and-crown-delineation.html#cb254-112" tabindex="-1"></a>  training_img_annttd_crwns_temp <span class="ot">&lt;-</span></span>
<span id="cb254-113"><a href="validate-tree-detection-and-crown-delineation.html#cb254-113" tabindex="-1"></a>    submission_temp<span class="sc">$</span>ws_fn_nm <span class="sc">%&gt;%</span> </span>
<span id="cb254-114"><a href="validate-tree-detection-and-crown-delineation.html#cb254-114" tabindex="-1"></a>    <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb254-115"><a href="validate-tree-detection-and-crown-delineation.html#cb254-115" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">map</span>(<span class="cf">function</span>(x){</span>
<span id="cb254-116"><a href="validate-tree-detection-and-crown-delineation.html#cb254-116" tabindex="-1"></a>      ans <span class="ot">&lt;-</span> <span class="fu">safe_evaluate_image_crowns</span>(</span>
<span id="cb254-117"><a href="validate-tree-detection-and-crown-delineation.html#cb254-117" tabindex="-1"></a>        <span class="at">predictions =</span> submission_temp <span class="sc">%&gt;%</span> </span>
<span id="cb254-118"><a href="validate-tree-detection-and-crown-delineation.html#cb254-118" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb254-119"><a href="validate-tree-detection-and-crown-delineation.html#cb254-119" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(ws_fn_nm <span class="sc">==</span> x) <span class="sc">%&gt;%</span> </span>
<span id="cb254-120"><a href="validate-tree-detection-and-crown-delineation.html#cb254-120" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(xmin,ymin,xmax,ymax,label,plot_name)</span>
<span id="cb254-121"><a href="validate-tree-detection-and-crown-delineation.html#cb254-121" tabindex="-1"></a>        , <span class="at">show =</span> F</span>
<span id="cb254-122"><a href="validate-tree-detection-and-crown-delineation.html#cb254-122" tabindex="-1"></a>        , <span class="at">summarize =</span> T</span>
<span id="cb254-123"><a href="validate-tree-detection-and-crown-delineation.html#cb254-123" tabindex="-1"></a>      )</span>
<span id="cb254-124"><a href="validate-tree-detection-and-crown-delineation.html#cb254-124" tabindex="-1"></a>      <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(ans<span class="sc">$</span>error)){</span>
<span id="cb254-125"><a href="validate-tree-detection-and-crown-delineation.html#cb254-125" tabindex="-1"></a>        <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb254-126"><a href="validate-tree-detection-and-crown-delineation.html#cb254-126" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb254-127"><a href="validate-tree-detection-and-crown-delineation.html#cb254-127" tabindex="-1"></a>        <span class="fu">return</span>(</span>
<span id="cb254-128"><a href="validate-tree-detection-and-crown-delineation.html#cb254-128" tabindex="-1"></a>          ans<span class="sc">$</span>result <span class="sc">%&gt;%</span> </span>
<span id="cb254-129"><a href="validate-tree-detection-and-crown-delineation.html#cb254-129" tabindex="-1"></a>            purrr<span class="sc">::</span><span class="fu">pluck</span>(<span class="st">&quot;plot_level&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb254-130"><a href="validate-tree-detection-and-crown-delineation.html#cb254-130" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb254-131"><a href="validate-tree-detection-and-crown-delineation.html#cb254-131" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">ws_fn_nm =</span> x)</span>
<span id="cb254-132"><a href="validate-tree-detection-and-crown-delineation.html#cb254-132" tabindex="-1"></a>        ) </span>
<span id="cb254-133"><a href="validate-tree-detection-and-crown-delineation.html#cb254-133" tabindex="-1"></a>      }</span>
<span id="cb254-134"><a href="validate-tree-detection-and-crown-delineation.html#cb254-134" tabindex="-1"></a>    }) <span class="sc">%&gt;%</span> </span>
<span id="cb254-135"><a href="validate-tree-detection-and-crown-delineation.html#cb254-135" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span>
<span id="cb254-136"><a href="validate-tree-detection-and-crown-delineation.html#cb254-136" tabindex="-1"></a>  <span class="co"># add it</span></span>
<span id="cb254-137"><a href="validate-tree-detection-and-crown-delineation.html#cb254-137" tabindex="-1"></a>  training_img_annttd_crwns <span class="ot">&lt;-</span> training_img_annttd_crwns <span class="sc">%&gt;%</span> </span>
<span id="cb254-138"><a href="validate-tree-detection-and-crown-delineation.html#cb254-138" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(training_img_annttd_crwns_temp)</span>
<span id="cb254-139"><a href="validate-tree-detection-and-crown-delineation.html#cb254-139" tabindex="-1"></a>  <span class="co"># save</span></span>
<span id="cb254-140"><a href="validate-tree-detection-and-crown-delineation.html#cb254-140" tabindex="-1"></a>  readr<span class="sc">::</span><span class="fu">write_csv</span>(training_img_annttd_crwns, <span class="at">file =</span> training_eval_temp)</span>
<span id="cb254-141"><a href="validate-tree-detection-and-crown-delineation.html#cb254-141" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb254-142"><a href="validate-tree-detection-and-crown-delineation.html#cb254-142" tabindex="-1"></a>  training_img_annttd_crwns <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(training_eval_temp, <span class="at">progress =</span> F, <span class="at">show_col_types =</span> F)</span>
<span id="cb254-143"><a href="validate-tree-detection-and-crown-delineation.html#cb254-143" tabindex="-1"></a>}</span>
<span id="cb254-144"><a href="validate-tree-detection-and-crown-delineation.html#cb254-144" tabindex="-1"></a><span class="co"># training_img_annttd_crwns %&gt;% dplyr::glimpse()</span></span></code></pre></div>
<p>our return data should include precision and recall values for each plot and variable window function that resulted in trees extracted (some window functions might not have extracted any trees) with image annotated crown evaluation data…unless the <code>NeonTreeEvaluation::evaluate_image_crowns()</code> resulted in an error</p>
<p>count of the variable window functions which resulted in trees extracted and were successfully evaluated using image annotated crown ground truth data by plot</p>
<div class="sourceCode" id="cb255"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb255-1"><a href="validate-tree-detection-and-crown-delineation.html#cb255-1" tabindex="-1"></a>training_submission <span class="sc">%&gt;%</span> </span>
<span id="cb255-2"><a href="validate-tree-detection-and-crown-delineation.html#cb255-2" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb255-3"><a href="validate-tree-detection-and-crown-delineation.html#cb255-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb255-4"><a href="validate-tree-detection-and-crown-delineation.html#cb255-4" tabindex="-1"></a>    lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb255-5"><a href="validate-tree-detection-and-crown-delineation.html#cb255-5" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb255-6"><a href="validate-tree-detection-and-crown-delineation.html#cb255-6" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb255-7"><a href="validate-tree-detection-and-crown-delineation.html#cb255-7" tabindex="-1"></a>        has_image_annotation<span class="sc">==</span>T <span class="sc">&amp;</span> </span>
<span id="cb255-8"><a href="validate-tree-detection-and-crown-delineation.html#cb255-8" tabindex="-1"></a>        (data_type<span class="sc">==</span><span class="st">&quot;training&quot;</span> <span class="sc">|</span> is_new_image_annotation_training)</span>
<span id="cb255-9"><a href="validate-tree-detection-and-crown-delineation.html#cb255-9" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb255-10"><a href="validate-tree-detection-and-crown-delineation.html#cb255-10" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">distinct</span>(plot_name)</span>
<span id="cb255-11"><a href="validate-tree-detection-and-crown-delineation.html#cb255-11" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;plot_name&quot;</span></span>
<span id="cb255-12"><a href="validate-tree-detection-and-crown-delineation.html#cb255-12" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb255-13"><a href="validate-tree-detection-and-crown-delineation.html#cb255-13" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(plot_name,ws_fn_nm) <span class="sc">%&gt;%</span> </span>
<span id="cb255-14"><a href="validate-tree-detection-and-crown-delineation.html#cb255-14" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb255-15"><a href="validate-tree-detection-and-crown-delineation.html#cb255-15" tabindex="-1"></a>    training_img_annttd_crwns</span>
<span id="cb255-16"><a href="validate-tree-detection-and-crown-delineation.html#cb255-16" tabindex="-1"></a>    , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(plot_name,ws_fn_nm)</span>
<span id="cb255-17"><a href="validate-tree-detection-and-crown-delineation.html#cb255-17" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb255-18"><a href="validate-tree-detection-and-crown-delineation.html#cb255-18" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(plot_name) <span class="sc">%&gt;%</span> </span>
<span id="cb255-19"><a href="validate-tree-detection-and-crown-delineation.html#cb255-19" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">ws_trees =</span> dplyr<span class="sc">::</span><span class="fu">n</span>(), <span class="at">ws_eval =</span> <span class="fu">sum</span>(<span class="fu">ifelse</span>(<span class="fu">is.na</span>(precision),<span class="dv">0</span>,<span class="dv">1</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb255-20"><a href="validate-tree-detection-and-crown-delineation.html#cb255-20" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(plot_name) <span class="sc">%&gt;%</span> </span>
<span id="cb255-21"><a href="validate-tree-detection-and-crown-delineation.html#cb255-21" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(</span>
<span id="cb255-22"><a href="validate-tree-detection-and-crown-delineation.html#cb255-22" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">&quot;Count of variable window functions tested and successfully evaluated using image annotated crowns&quot;</span></span>
<span id="cb255-23"><a href="validate-tree-detection-and-crown-delineation.html#cb255-23" tabindex="-1"></a>    , <span class="at">digits =</span> <span class="dv">0</span></span>
<span id="cb255-24"><a href="validate-tree-detection-and-crown-delineation.html#cb255-24" tabindex="-1"></a>    , <span class="at">col.names =</span> <span class="fu">c</span>(</span>
<span id="cb255-25"><a href="validate-tree-detection-and-crown-delineation.html#cb255-25" tabindex="-1"></a>      <span class="st">&quot;plot&quot;</span>,<span class="st">&quot;window functions&lt;br&gt;with trees&quot;</span>,<span class="st">&quot;window functions&lt;br&gt;successfully evaluated&quot;</span></span>
<span id="cb255-26"><a href="validate-tree-detection-and-crown-delineation.html#cb255-26" tabindex="-1"></a>    )</span>
<span id="cb255-27"><a href="validate-tree-detection-and-crown-delineation.html#cb255-27" tabindex="-1"></a>    , <span class="at">escape =</span> F</span>
<span id="cb255-28"><a href="validate-tree-detection-and-crown-delineation.html#cb255-28" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb255-29"><a href="validate-tree-detection-and-crown-delineation.html#cb255-29" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>()</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-228">Table 4.6: </span>Count of variable window functions tested and successfully evaluated using image annotated crowns
</caption>
<thead>
<tr>
<th style="text-align:left;">
plot
</th>
<th style="text-align:right;">
window functions<br>with trees
</th>
<th style="text-align:right;">
window functions<br>successfully evaluated
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
2018_JERC_4_742000_3451000_image_crop
</td>
<td style="text-align:right;">
15
</td>
<td style="text-align:right;">
15
</td>
</tr>
<tr>
<td style="text-align:left;">
2018_NIWO_2_450000_4426000_image_crop
</td>
<td style="text-align:right;">
15
</td>
<td style="text-align:right;">
13
</td>
</tr>
<tr>
<td style="text-align:left;">
2018_OSBS_4_405000_3286000_image
</td>
<td style="text-align:right;">
14
</td>
<td style="text-align:right;">
14
</td>
</tr>
<tr>
<td style="text-align:left;">
2018_TEAK_3_315000_4094000_image_crop
</td>
<td style="text-align:right;">
15
</td>
<td style="text-align:right;">
11
</td>
</tr>
<tr>
<td style="text-align:left;">
2019_OSBS_5_405000_3287000_image_crop
</td>
<td style="text-align:right;">
14
</td>
<td style="text-align:right;">
14
</td>
</tr>
<tr>
<td style="text-align:left;">
2019_OSBS_5_405000_3287000_image_crop2
</td>
<td style="text-align:right;">
15
</td>
<td style="text-align:right;">
15
</td>
</tr>
<tr>
<td style="text-align:left;">
DSNY_005_2018
</td>
<td style="text-align:right;">
13
</td>
<td style="text-align:right;">
13
</td>
</tr>
<tr>
<td style="text-align:left;">
DSNY_025_2018
</td>
<td style="text-align:right;">
13
</td>
<td style="text-align:right;">
13
</td>
</tr>
</tbody>
</table>
<p>plot precision and recall by plot</p>
<div class="sourceCode" id="cb256"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb256-1"><a href="validate-tree-detection-and-crown-delineation.html#cb256-1" tabindex="-1"></a>training_img_annttd_crwns <span class="sc">%&gt;%</span> </span>
<span id="cb256-2"><a href="validate-tree-detection-and-crown-delineation.html#cb256-2" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(precision,recall)) <span class="sc">%&gt;%</span> </span>
<span id="cb256-3"><a href="validate-tree-detection-and-crown-delineation.html#cb256-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">y =</span> plot_name, <span class="at">color =</span> ws_fn_nm)) <span class="sc">+</span></span>
<span id="cb256-4"><a href="validate-tree-detection-and-crown-delineation.html#cb256-4" tabindex="-1"></a>    <span class="co"># ggplot2::geom_point(size = 4) +</span></span>
<span id="cb256-5"><a href="validate-tree-detection-and-crown-delineation.html#cb256-5" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_jitter</span>(<span class="at">height =</span> <span class="fl">0.12</span>, <span class="at">width =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb256-6"><a href="validate-tree-detection-and-crown-delineation.html#cb256-6" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_grid</span>(<span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(name)) <span class="sc">+</span></span>
<span id="cb256-7"><a href="validate-tree-detection-and-crown-delineation.html#cb256-7" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> pal_ws) <span class="sc">+</span></span>
<span id="cb256-8"><a href="validate-tree-detection-and-crown-delineation.html#cb256-8" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb256-9"><a href="validate-tree-detection-and-crown-delineation.html#cb256-9" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb256-10"><a href="validate-tree-detection-and-crown-delineation.html#cb256-10" tabindex="-1"></a>      , <span class="at">color =</span> <span class="st">&quot;variable</span><span class="sc">\n</span><span class="st">window</span><span class="sc">\n</span><span class="st">function&quot;</span></span>
<span id="cb256-11"><a href="validate-tree-detection-and-crown-delineation.html#cb256-11" tabindex="-1"></a>      , <span class="at">subtitle =</span> <span class="st">&quot;Training data: validation against image annotated crowns ground truth&quot;</span></span>
<span id="cb256-12"><a href="validate-tree-detection-and-crown-delineation.html#cb256-12" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb256-13"><a href="validate-tree-detection-and-crown-delineation.html#cb256-13" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb256-14"><a href="validate-tree-detection-and-crown-delineation.html#cb256-14" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb256-15"><a href="validate-tree-detection-and-crown-delineation.html#cb256-15" tabindex="-1"></a>      <span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">8</span>)</span>
<span id="cb256-16"><a href="validate-tree-detection-and-crown-delineation.html#cb256-16" tabindex="-1"></a>      , <span class="at">panel.grid.major.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_line</span>(<span class="at">color=</span><span class="st">&quot;gray22&quot;</span>)</span>
<span id="cb256-17"><a href="validate-tree-detection-and-crown-delineation.html#cb256-17" tabindex="-1"></a>      , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb256-18"><a href="validate-tree-detection-and-crown-delineation.html#cb256-18" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb256-19"><a href="validate-tree-detection-and-crown-delineation.html#cb256-19" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">guides</span>(</span>
<span id="cb256-20"><a href="validate-tree-detection-and-crown-delineation.html#cb256-20" tabindex="-1"></a>      <span class="at">color =</span> ggplot2<span class="sc">::</span><span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">shape =</span> <span class="dv">15</span>, <span class="at">size =</span> <span class="dv">6</span>))</span>
<span id="cb256-21"><a href="validate-tree-detection-and-crown-delineation.html#cb256-21" tabindex="-1"></a>    )</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-229-1.png" width="1008" /></p>
<p>we’ll quickly compare the variable window functions by averaging across sites and making a “quadrant” plot whereby we overlay the median value to differentiate the “best” window size by the two dimensions (precision, recall)…the upper-right quadrant is the “best” of the variable window functions tested based on these training plots evaluated against image annotated crowns</p>
<div class="sourceCode" id="cb257"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb257-1"><a href="validate-tree-detection-and-crown-delineation.html#cb257-1" tabindex="-1"></a>agg_pr_temp <span class="ot">&lt;-</span> training_img_annttd_crwns <span class="sc">%&gt;%</span> </span>
<span id="cb257-2"><a href="validate-tree-detection-and-crown-delineation.html#cb257-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(ws_fn_nm) <span class="sc">%&gt;%</span> </span>
<span id="cb257-3"><a href="validate-tree-detection-and-crown-delineation.html#cb257-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(dplyr<span class="sc">::</span><span class="fu">across</span>(dplyr<span class="sc">::</span><span class="fu">where</span>(is.numeric),mean))</span>
<span id="cb257-4"><a href="validate-tree-detection-and-crown-delineation.html#cb257-4" tabindex="-1"></a>agg_pr_temp <span class="sc">%&gt;%</span> </span>
<span id="cb257-5"><a href="validate-tree-detection-and-crown-delineation.html#cb257-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x=</span>precision,<span class="at">y=</span>recall,<span class="at">color=</span>ws_fn_nm)) <span class="sc">+</span></span>
<span id="cb257-6"><a href="validate-tree-detection-and-crown-delineation.html#cb257-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">median</span>(agg_pr_temp<span class="sc">$</span>recall),<span class="at">linetype=</span><span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span></span>
<span id="cb257-7"><a href="validate-tree-detection-and-crown-delineation.html#cb257-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">median</span>(agg_pr_temp<span class="sc">$</span>precision),<span class="at">linetype=</span><span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span></span>
<span id="cb257-8"><a href="validate-tree-detection-and-crown-delineation.html#cb257-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">6</span>) <span class="sc">+</span></span>
<span id="cb257-9"><a href="validate-tree-detection-and-crown-delineation.html#cb257-9" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> pal_ws) <span class="sc">+</span></span>
<span id="cb257-10"><a href="validate-tree-detection-and-crown-delineation.html#cb257-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb257-11"><a href="validate-tree-detection-and-crown-delineation.html#cb257-11" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb257-12"><a href="validate-tree-detection-and-crown-delineation.html#cb257-12" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb257-13"><a href="validate-tree-detection-and-crown-delineation.html#cb257-13" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">&quot;variable</span><span class="sc">\n</span><span class="st">window</span><span class="sc">\n</span><span class="st">function&quot;</span></span>
<span id="cb257-14"><a href="validate-tree-detection-and-crown-delineation.html#cb257-14" tabindex="-1"></a>    , <span class="at">subtitle =</span> <span class="st">&quot;Training data: validation against image annotated crowns ground truth&quot;</span></span>
<span id="cb257-15"><a href="validate-tree-detection-and-crown-delineation.html#cb257-15" tabindex="-1"></a>    , <span class="at">caption =</span> <span class="st">&quot;*values are averaged across sites and plots&quot;</span></span>
<span id="cb257-16"><a href="validate-tree-detection-and-crown-delineation.html#cb257-16" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb257-17"><a href="validate-tree-detection-and-crown-delineation.html#cb257-17" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb257-18"><a href="validate-tree-detection-and-crown-delineation.html#cb257-18" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">guides</span>(</span>
<span id="cb257-19"><a href="validate-tree-detection-and-crown-delineation.html#cb257-19" tabindex="-1"></a>    <span class="at">color =</span> ggplot2<span class="sc">::</span><span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">shape =</span> <span class="dv">15</span>, <span class="at">size =</span> <span class="dv">6</span>))</span>
<span id="cb257-20"><a href="validate-tree-detection-and-crown-delineation.html#cb257-20" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-230-1.png" width="1008" /></p>
</div>
<div id="scores-for-field-collected-stems-1" class="section level5 hasAnchor" number="4.2.4.4.2">
<h5><span class="header-section-number">4.2.4.4.2</span> Scores for field-collected stems<a href="validate-tree-detection-and-crown-delineation.html#scores-for-field-collected-stems-1" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div class="sourceCode" id="cb258"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb258-1"><a href="validate-tree-detection-and-crown-delineation.html#cb258-1" tabindex="-1"></a><span class="co"># where should we save the file?</span></span>
<span id="cb258-2"><a href="validate-tree-detection-and-crown-delineation.html#cb258-2" tabindex="-1"></a>training_eval_temp <span class="ot">&lt;-</span> <span class="st">&quot;../data/NeonTreeEvaluation_training_evaluate_field_stems.csv&quot;</span></span>
<span id="cb258-3"><a href="validate-tree-detection-and-crown-delineation.html#cb258-3" tabindex="-1"></a><span class="co"># if we don&#39;t already have the data, run it</span></span>
<span id="cb258-4"><a href="validate-tree-detection-and-crown-delineation.html#cb258-4" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(training_eval_temp)){</span>
<span id="cb258-5"><a href="validate-tree-detection-and-crown-delineation.html#cb258-5" tabindex="-1"></a><span class="co"># if(T){</span></span>
<span id="cb258-6"><a href="validate-tree-detection-and-crown-delineation.html#cb258-6" tabindex="-1"></a>  <span class="co"># filter for only those with this type of validation data</span></span>
<span id="cb258-7"><a href="validate-tree-detection-and-crown-delineation.html#cb258-7" tabindex="-1"></a>  submission_temp <span class="ot">&lt;-</span> training_submission <span class="sc">%&gt;%</span> </span>
<span id="cb258-8"><a href="validate-tree-detection-and-crown-delineation.html#cb258-8" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb258-9"><a href="validate-tree-detection-and-crown-delineation.html#cb258-9" tabindex="-1"></a>      lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb258-10"><a href="validate-tree-detection-and-crown-delineation.html#cb258-10" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb258-11"><a href="validate-tree-detection-and-crown-delineation.html#cb258-11" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(has_field_stems<span class="sc">==</span>T <span class="sc">&amp;</span> (data_type <span class="sc">==</span> <span class="st">&quot;training&quot;</span> <span class="sc">|</span> is_new_field_stems_training)) <span class="sc">%&gt;%</span> </span>
<span id="cb258-12"><a href="validate-tree-detection-and-crown-delineation.html#cb258-12" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">distinct</span>(plot_name)</span>
<span id="cb258-13"><a href="validate-tree-detection-and-crown-delineation.html#cb258-13" tabindex="-1"></a>      , <span class="at">by =</span> <span class="st">&quot;plot_name&quot;</span></span>
<span id="cb258-14"><a href="validate-tree-detection-and-crown-delineation.html#cb258-14" tabindex="-1"></a>    )</span>
<span id="cb258-15"><a href="validate-tree-detection-and-crown-delineation.html#cb258-15" tabindex="-1"></a>  <span class="co"># safe it bc: error in `clue::solve_LSAP()`: long vectors (argument 1) are not supported</span></span>
<span id="cb258-16"><a href="validate-tree-detection-and-crown-delineation.html#cb258-16" tabindex="-1"></a>  <span class="co"># would need to dig through NeonTreeEvaluation, fix, and pull request...</span></span>
<span id="cb258-17"><a href="validate-tree-detection-and-crown-delineation.html#cb258-17" tabindex="-1"></a>  safe_evaluate_field_stems <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">safely</span>(NeonTreeEvaluation<span class="sc">::</span>evaluate_field_stems)</span>
<span id="cb258-18"><a href="validate-tree-detection-and-crown-delineation.html#cb258-18" tabindex="-1"></a>  <span class="co"># validate</span></span>
<span id="cb258-19"><a href="validate-tree-detection-and-crown-delineation.html#cb258-19" tabindex="-1"></a>  training_fld_cllctd_stems <span class="ot">&lt;-</span></span>
<span id="cb258-20"><a href="validate-tree-detection-and-crown-delineation.html#cb258-20" tabindex="-1"></a>    submission_temp<span class="sc">$</span>ws_fn_nm <span class="sc">%&gt;%</span> </span>
<span id="cb258-21"><a href="validate-tree-detection-and-crown-delineation.html#cb258-21" tabindex="-1"></a>    <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb258-22"><a href="validate-tree-detection-and-crown-delineation.html#cb258-22" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">map</span>(<span class="cf">function</span>(x){</span>
<span id="cb258-23"><a href="validate-tree-detection-and-crown-delineation.html#cb258-23" tabindex="-1"></a>      ans <span class="ot">&lt;-</span> <span class="fu">safe_evaluate_field_stems</span>(</span>
<span id="cb258-24"><a href="validate-tree-detection-and-crown-delineation.html#cb258-24" tabindex="-1"></a>        <span class="at">predictions =</span> submission_temp <span class="sc">%&gt;%</span> </span>
<span id="cb258-25"><a href="validate-tree-detection-and-crown-delineation.html#cb258-25" tabindex="-1"></a>          <span class="co"># sf::st_drop_geometry() %&gt;% </span><span class="al">###</span><span class="co"> polygons work here !</span></span>
<span id="cb258-26"><a href="validate-tree-detection-and-crown-delineation.html#cb258-26" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(ws_fn_nm <span class="sc">==</span> x) <span class="sc">%&gt;%</span> </span>
<span id="cb258-27"><a href="validate-tree-detection-and-crown-delineation.html#cb258-27" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(xmin,ymin,xmax,ymax,label,plot_name)</span>
<span id="cb258-28"><a href="validate-tree-detection-and-crown-delineation.html#cb258-28" tabindex="-1"></a>        , <span class="at">show =</span> F</span>
<span id="cb258-29"><a href="validate-tree-detection-and-crown-delineation.html#cb258-29" tabindex="-1"></a>        , <span class="at">summarize =</span> T</span>
<span id="cb258-30"><a href="validate-tree-detection-and-crown-delineation.html#cb258-30" tabindex="-1"></a>      )</span>
<span id="cb258-31"><a href="validate-tree-detection-and-crown-delineation.html#cb258-31" tabindex="-1"></a>      <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(ans<span class="sc">$</span>error)){</span>
<span id="cb258-32"><a href="validate-tree-detection-and-crown-delineation.html#cb258-32" tabindex="-1"></a>        <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb258-33"><a href="validate-tree-detection-and-crown-delineation.html#cb258-33" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb258-34"><a href="validate-tree-detection-and-crown-delineation.html#cb258-34" tabindex="-1"></a>        <span class="fu">return</span>(</span>
<span id="cb258-35"><a href="validate-tree-detection-and-crown-delineation.html#cb258-35" tabindex="-1"></a>          ans<span class="sc">$</span>result <span class="sc">%&gt;%</span> </span>
<span id="cb258-36"><a href="validate-tree-detection-and-crown-delineation.html#cb258-36" tabindex="-1"></a>            purrr<span class="sc">::</span><span class="fu">pluck</span>(<span class="st">&quot;plot_level&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb258-37"><a href="validate-tree-detection-and-crown-delineation.html#cb258-37" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb258-38"><a href="validate-tree-detection-and-crown-delineation.html#cb258-38" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">ws_fn_nm =</span> x)</span>
<span id="cb258-39"><a href="validate-tree-detection-and-crown-delineation.html#cb258-39" tabindex="-1"></a>        ) </span>
<span id="cb258-40"><a href="validate-tree-detection-and-crown-delineation.html#cb258-40" tabindex="-1"></a>      }</span>
<span id="cb258-41"><a href="validate-tree-detection-and-crown-delineation.html#cb258-41" tabindex="-1"></a>    }) <span class="sc">%&gt;%</span> </span>
<span id="cb258-42"><a href="validate-tree-detection-and-crown-delineation.html#cb258-42" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span>
<span id="cb258-43"><a href="validate-tree-detection-and-crown-delineation.html#cb258-43" tabindex="-1"></a>  <span class="co"># save</span></span>
<span id="cb258-44"><a href="validate-tree-detection-and-crown-delineation.html#cb258-44" tabindex="-1"></a>  readr<span class="sc">::</span><span class="fu">write_csv</span>(training_fld_cllctd_stems, <span class="at">file =</span> training_eval_temp)</span>
<span id="cb258-45"><a href="validate-tree-detection-and-crown-delineation.html#cb258-45" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb258-46"><a href="validate-tree-detection-and-crown-delineation.html#cb258-46" tabindex="-1"></a>  training_fld_cllctd_stems <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(training_eval_temp, <span class="at">progress =</span> F, <span class="at">show_col_types =</span> F)</span>
<span id="cb258-47"><a href="validate-tree-detection-and-crown-delineation.html#cb258-47" tabindex="-1"></a>}</span>
<span id="cb258-48"><a href="validate-tree-detection-and-crown-delineation.html#cb258-48" tabindex="-1"></a><span class="co"># training_fld_cllctd_stems %&gt;% dplyr::glimpse()</span></span></code></pre></div>
<p>our return data should include recall values for each plot and variable window function that resulted in trees extracted (some window functions might not have extracted any trees) with image annotated crown evaluation data…unless the <code>NeonTreeEvaluation::evaluate_field_stems()</code> resulted in an error</p>
<p>count of the variable window functions which resulted in trees extracted and were successfully evaluated using image annotated crown ground truth data by plot</p>
<div class="sourceCode" id="cb259"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb259-1"><a href="validate-tree-detection-and-crown-delineation.html#cb259-1" tabindex="-1"></a>training_submission <span class="sc">%&gt;%</span> </span>
<span id="cb259-2"><a href="validate-tree-detection-and-crown-delineation.html#cb259-2" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb259-3"><a href="validate-tree-detection-and-crown-delineation.html#cb259-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb259-4"><a href="validate-tree-detection-and-crown-delineation.html#cb259-4" tabindex="-1"></a>    lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb259-5"><a href="validate-tree-detection-and-crown-delineation.html#cb259-5" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb259-6"><a href="validate-tree-detection-and-crown-delineation.html#cb259-6" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb259-7"><a href="validate-tree-detection-and-crown-delineation.html#cb259-7" tabindex="-1"></a>        has_field_stems<span class="sc">==</span>T <span class="sc">&amp;</span> </span>
<span id="cb259-8"><a href="validate-tree-detection-and-crown-delineation.html#cb259-8" tabindex="-1"></a>        (data_type<span class="sc">==</span><span class="st">&quot;training&quot;</span> <span class="sc">|</span> is_new_field_stems_training)</span>
<span id="cb259-9"><a href="validate-tree-detection-and-crown-delineation.html#cb259-9" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb259-10"><a href="validate-tree-detection-and-crown-delineation.html#cb259-10" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">distinct</span>(plot_name,plot_name_sans_yr)</span>
<span id="cb259-11"><a href="validate-tree-detection-and-crown-delineation.html#cb259-11" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;plot_name&quot;</span></span>
<span id="cb259-12"><a href="validate-tree-detection-and-crown-delineation.html#cb259-12" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb259-13"><a href="validate-tree-detection-and-crown-delineation.html#cb259-13" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(plot_name,plot_name_sans_yr,ws_fn_nm) <span class="sc">%&gt;%</span> </span>
<span id="cb259-14"><a href="validate-tree-detection-and-crown-delineation.html#cb259-14" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb259-15"><a href="validate-tree-detection-and-crown-delineation.html#cb259-15" tabindex="-1"></a>    training_fld_cllctd_stems <span class="sc">%&gt;%</span> </span>
<span id="cb259-16"><a href="validate-tree-detection-and-crown-delineation.html#cb259-16" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(plot_name,ws_fn_nm,recall)</span>
<span id="cb259-17"><a href="validate-tree-detection-and-crown-delineation.html#cb259-17" tabindex="-1"></a>    , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(plot_name_sans_yr<span class="sc">==</span>plot_name,ws_fn_nm)</span>
<span id="cb259-18"><a href="validate-tree-detection-and-crown-delineation.html#cb259-18" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb259-19"><a href="validate-tree-detection-and-crown-delineation.html#cb259-19" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(plot_name) <span class="sc">%&gt;%</span> </span>
<span id="cb259-20"><a href="validate-tree-detection-and-crown-delineation.html#cb259-20" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">ws_trees =</span> dplyr<span class="sc">::</span><span class="fu">n</span>(), <span class="at">ws_eval =</span> <span class="fu">sum</span>(<span class="fu">ifelse</span>(<span class="fu">is.na</span>(recall),<span class="dv">0</span>,<span class="dv">1</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb259-21"><a href="validate-tree-detection-and-crown-delineation.html#cb259-21" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(plot_name) <span class="sc">%&gt;%</span> </span>
<span id="cb259-22"><a href="validate-tree-detection-and-crown-delineation.html#cb259-22" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(</span>
<span id="cb259-23"><a href="validate-tree-detection-and-crown-delineation.html#cb259-23" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">&quot;Count of variable window functions tested and successfully evaluated using field collected stems&quot;</span></span>
<span id="cb259-24"><a href="validate-tree-detection-and-crown-delineation.html#cb259-24" tabindex="-1"></a>    , <span class="at">digits =</span> <span class="dv">0</span></span>
<span id="cb259-25"><a href="validate-tree-detection-and-crown-delineation.html#cb259-25" tabindex="-1"></a>    , <span class="at">col.names =</span> <span class="fu">c</span>(</span>
<span id="cb259-26"><a href="validate-tree-detection-and-crown-delineation.html#cb259-26" tabindex="-1"></a>      <span class="st">&quot;plot&quot;</span>,<span class="st">&quot;window functions&lt;br&gt;with trees&quot;</span>,<span class="st">&quot;window functions&lt;br&gt;successfully evaluated&quot;</span></span>
<span id="cb259-27"><a href="validate-tree-detection-and-crown-delineation.html#cb259-27" tabindex="-1"></a>    )</span>
<span id="cb259-28"><a href="validate-tree-detection-and-crown-delineation.html#cb259-28" tabindex="-1"></a>    , <span class="at">escape =</span> F</span>
<span id="cb259-29"><a href="validate-tree-detection-and-crown-delineation.html#cb259-29" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb259-30"><a href="validate-tree-detection-and-crown-delineation.html#cb259-30" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>()</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-234">Table 4.7: </span>Count of variable window functions tested and successfully evaluated using field collected stems
</caption>
<thead>
<tr>
<th style="text-align:left;">
plot
</th>
<th style="text-align:right;">
window functions<br>with trees
</th>
<th style="text-align:right;">
window functions<br>successfully evaluated
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
ABBY_065_2018
</td>
<td style="text-align:right;">
15
</td>
<td style="text-align:right;">
15
</td>
</tr>
<tr>
<td style="text-align:left;">
ABBY_075_2018
</td>
<td style="text-align:right;">
15
</td>
<td style="text-align:right;">
15
</td>
</tr>
<tr>
<td style="text-align:left;">
DEJU_014_2018
</td>
<td style="text-align:right;">
14
</td>
<td style="text-align:right;">
14
</td>
</tr>
<tr>
<td style="text-align:left;">
DEJU_016_2019
</td>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
12
</td>
</tr>
<tr>
<td style="text-align:left;">
JERC_049_2018
</td>
<td style="text-align:right;">
14
</td>
<td style="text-align:right;">
14
</td>
</tr>
<tr>
<td style="text-align:left;">
JERC_063_2018
</td>
<td style="text-align:right;">
14
</td>
<td style="text-align:right;">
14
</td>
</tr>
<tr>
<td style="text-align:left;">
NIWO_009_2020
</td>
<td style="text-align:right;">
14
</td>
<td style="text-align:right;">
14
</td>
</tr>
<tr>
<td style="text-align:left;">
NIWO_040_2020
</td>
<td style="text-align:right;">
14
</td>
<td style="text-align:right;">
14
</td>
</tr>
<tr>
<td style="text-align:left;">
OSBS_004_2019
</td>
<td style="text-align:right;">
14
</td>
<td style="text-align:right;">
14
</td>
</tr>
<tr>
<td style="text-align:left;">
OSBS_035_2019
</td>
<td style="text-align:right;">
14
</td>
<td style="text-align:right;">
14
</td>
</tr>
<tr>
<td style="text-align:left;">
TALL_053_2018
</td>
<td style="text-align:right;">
15
</td>
<td style="text-align:right;">
15
</td>
</tr>
<tr>
<td style="text-align:left;">
TALL_061_2019
</td>
<td style="text-align:right;">
15
</td>
<td style="text-align:right;">
15
</td>
</tr>
</tbody>
</table>
<p>plot recall by plot</p>
<div class="sourceCode" id="cb260"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb260-1"><a href="validate-tree-detection-and-crown-delineation.html#cb260-1" tabindex="-1"></a>training_fld_cllctd_stems <span class="sc">%&gt;%</span> </span>
<span id="cb260-2"><a href="validate-tree-detection-and-crown-delineation.html#cb260-2" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(n,recall)) <span class="sc">%&gt;%</span> </span>
<span id="cb260-3"><a href="validate-tree-detection-and-crown-delineation.html#cb260-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(name<span class="sc">==</span><span class="st">&quot;recall&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb260-4"><a href="validate-tree-detection-and-crown-delineation.html#cb260-4" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">y =</span> plot_name, <span class="at">color =</span> ws_fn_nm)) <span class="sc">+</span></span>
<span id="cb260-5"><a href="validate-tree-detection-and-crown-delineation.html#cb260-5" tabindex="-1"></a>    <span class="co"># ggplot2::geom_point(size = 4) +</span></span>
<span id="cb260-6"><a href="validate-tree-detection-and-crown-delineation.html#cb260-6" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_jitter</span>(<span class="at">height =</span> <span class="fl">0.12</span>, <span class="at">width =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb260-7"><a href="validate-tree-detection-and-crown-delineation.html#cb260-7" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_grid</span>(<span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(name)) <span class="sc">+</span></span>
<span id="cb260-8"><a href="validate-tree-detection-and-crown-delineation.html#cb260-8" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> pal_ws) <span class="sc">+</span></span>
<span id="cb260-9"><a href="validate-tree-detection-and-crown-delineation.html#cb260-9" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb260-10"><a href="validate-tree-detection-and-crown-delineation.html#cb260-10" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb260-11"><a href="validate-tree-detection-and-crown-delineation.html#cb260-11" tabindex="-1"></a>      , <span class="at">color =</span> <span class="st">&quot;variable</span><span class="sc">\n</span><span class="st">window</span><span class="sc">\n</span><span class="st">function&quot;</span></span>
<span id="cb260-12"><a href="validate-tree-detection-and-crown-delineation.html#cb260-12" tabindex="-1"></a>      , <span class="at">subtitle =</span> <span class="st">&quot;Training data: validation against field collected stems ground truth&quot;</span></span>
<span id="cb260-13"><a href="validate-tree-detection-and-crown-delineation.html#cb260-13" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb260-14"><a href="validate-tree-detection-and-crown-delineation.html#cb260-14" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb260-15"><a href="validate-tree-detection-and-crown-delineation.html#cb260-15" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb260-16"><a href="validate-tree-detection-and-crown-delineation.html#cb260-16" tabindex="-1"></a>      <span class="at">panel.grid.major.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_line</span>(<span class="at">color=</span><span class="st">&quot;gray22&quot;</span>)</span>
<span id="cb260-17"><a href="validate-tree-detection-and-crown-delineation.html#cb260-17" tabindex="-1"></a>      , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb260-18"><a href="validate-tree-detection-and-crown-delineation.html#cb260-18" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb260-19"><a href="validate-tree-detection-and-crown-delineation.html#cb260-19" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">guides</span>(</span>
<span id="cb260-20"><a href="validate-tree-detection-and-crown-delineation.html#cb260-20" tabindex="-1"></a>      <span class="at">color =</span> ggplot2<span class="sc">::</span><span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">shape =</span> <span class="dv">15</span>, <span class="at">size =</span> <span class="dv">6</span>))</span>
<span id="cb260-21"><a href="validate-tree-detection-and-crown-delineation.html#cb260-21" tabindex="-1"></a>    )</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-235-1.png" width="1008" /></p>
</div>
</div>
<div id="best-variable-window-function" class="section level4 hasAnchor" number="4.2.4.5">
<h4><span class="header-section-number">4.2.4.5</span> Best variable window function<a href="validate-tree-detection-and-crown-delineation.html#best-variable-window-function" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>We are going to use the training data to determine the “best” ITD window function to use for a given NEON site since the <code>cloud2trees</code> package <a href="https://github.com/georgewoolsey/cloud2trees?tab=readme-ov-file#individual-tree-detection-itd-tuning">strongly recommends</a> that “a different window size function is defined for each region of your study area with significantly different forest structure”. We’ll get the precision and recall for each plot and variable window function combination and then select the window function that results in the best tree detection by NEON site. We’ll also average across sites to select the best variable window function overall which we’ll use for NEON sites that did not have training data.</p>
<p>We will determine the “best” variable window function by calculating the F-score which incorporates true positive, commission, and omission rates to determine how well the aerial point cloud-detected trees match the ground truth trees. As a measure of predictive performance, the highest possible value of an F-score is 1.0, indicating perfect precision and recall, and the lowest possible value is 0, if either precision or recall are zero.</p>
<p><span class="math display">\[
\textrm{F-score} = 2 \times \frac{\bigl(precision \times recall \bigr)}{\bigl(precision + recall \bigr)}
\]</span></p>
<p>let’s combine our evaluation results, collapse across plot to calculate an average precision and recall for each NEON site and variable window function combination, calculate F-score, choose the highest F-score acheived by a variable window function for each NEON site and overall by averaging over each site.</p>
<div class="sourceCode" id="cb261"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb261-1"><a href="validate-tree-detection-and-crown-delineation.html#cb261-1" tabindex="-1"></a><span class="co"># combine eval results</span></span>
<span id="cb261-2"><a href="validate-tree-detection-and-crown-delineation.html#cb261-2" tabindex="-1"></a>training_eval_combined_temp <span class="ot">&lt;-</span> training_img_annttd_crwns <span class="sc">%&gt;%</span> </span>
<span id="cb261-3"><a href="validate-tree-detection-and-crown-delineation.html#cb261-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb261-4"><a href="validate-tree-detection-and-crown-delineation.html#cb261-4" tabindex="-1"></a>    lidar_df <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">distinct</span>(plot_name,siteID)</span>
<span id="cb261-5"><a href="validate-tree-detection-and-crown-delineation.html#cb261-5" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;plot_name&quot;</span></span>
<span id="cb261-6"><a href="validate-tree-detection-and-crown-delineation.html#cb261-6" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb261-7"><a href="validate-tree-detection-and-crown-delineation.html#cb261-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(siteID,plot_name,ws_fn_nm,recall,precision) <span class="sc">%&gt;%</span> </span>
<span id="cb261-8"><a href="validate-tree-detection-and-crown-delineation.html#cb261-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">eval_type =</span> <span class="st">&quot;img_annttd_crwns&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb261-9"><a href="validate-tree-detection-and-crown-delineation.html#cb261-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb261-10"><a href="validate-tree-detection-and-crown-delineation.html#cb261-10" tabindex="-1"></a>    training_fld_cllctd_stems <span class="sc">%&gt;%</span> </span>
<span id="cb261-11"><a href="validate-tree-detection-and-crown-delineation.html#cb261-11" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(siteID,plot_name,ws_fn_nm,recall) <span class="sc">%&gt;%</span> </span>
<span id="cb261-12"><a href="validate-tree-detection-and-crown-delineation.html#cb261-12" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">eval_type =</span> <span class="st">&quot;fld_cllctd_stems&quot;</span>)</span>
<span id="cb261-13"><a href="validate-tree-detection-and-crown-delineation.html#cb261-13" tabindex="-1"></a>  )</span>
<span id="cb261-14"><a href="validate-tree-detection-and-crown-delineation.html#cb261-14" tabindex="-1"></a><span class="co"># overall eval results</span></span>
<span id="cb261-15"><a href="validate-tree-detection-and-crown-delineation.html#cb261-15" tabindex="-1"></a>training_eval_overall <span class="ot">&lt;-</span></span>
<span id="cb261-16"><a href="validate-tree-detection-and-crown-delineation.html#cb261-16" tabindex="-1"></a>  training_eval_combined_temp <span class="sc">%&gt;%</span> </span>
<span id="cb261-17"><a href="validate-tree-detection-and-crown-delineation.html#cb261-17" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(ws_fn_nm) <span class="sc">%&gt;%</span> </span>
<span id="cb261-18"><a href="validate-tree-detection-and-crown-delineation.html#cb261-18" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb261-19"><a href="validate-tree-detection-and-crown-delineation.html#cb261-19" tabindex="-1"></a>    <span class="at">precision =</span> <span class="fu">mean</span>(precision, <span class="at">na.rm =</span> T)</span>
<span id="cb261-20"><a href="validate-tree-detection-and-crown-delineation.html#cb261-20" tabindex="-1"></a>    , <span class="at">recall =</span> <span class="fu">mean</span>(recall, <span class="at">na.rm =</span> T)</span>
<span id="cb261-21"><a href="validate-tree-detection-and-crown-delineation.html#cb261-21" tabindex="-1"></a>    , <span class="at">n_fld_cllctd_stems =</span> <span class="fu">sum</span>(<span class="fu">ifelse</span>(eval_type <span class="sc">==</span> <span class="st">&quot;fld_cllctd_stems&quot;</span>,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb261-22"><a href="validate-tree-detection-and-crown-delineation.html#cb261-22" tabindex="-1"></a>    , <span class="at">n_img_annttd_crwns =</span> <span class="fu">sum</span>(<span class="fu">ifelse</span>(eval_type <span class="sc">==</span> <span class="st">&quot;img_annttd_crwns&quot;</span>,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb261-23"><a href="validate-tree-detection-and-crown-delineation.html#cb261-23" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb261-24"><a href="validate-tree-detection-and-crown-delineation.html#cb261-24" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb261-25"><a href="validate-tree-detection-and-crown-delineation.html#cb261-25" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb261-26"><a href="validate-tree-detection-and-crown-delineation.html#cb261-26" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">across</span>(<span class="at">.cols =</span> <span class="fu">c</span>(precision,recall), <span class="sc">~</span><span class="fu">ifelse</span>(<span class="fu">is.nan</span>(.x),<span class="fu">as.numeric</span>(<span class="cn">NA</span>),.x))</span>
<span id="cb261-27"><a href="validate-tree-detection-and-crown-delineation.html#cb261-27" tabindex="-1"></a>    , <span class="at">f_score =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb261-28"><a href="validate-tree-detection-and-crown-delineation.html#cb261-28" tabindex="-1"></a>      <span class="fu">is.na</span>(precision) <span class="sc">|</span> <span class="fu">is.na</span>(recall) <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb261-29"><a href="validate-tree-detection-and-crown-delineation.html#cb261-29" tabindex="-1"></a>      , (precision<span class="sc">+</span>recall) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="dv">0</span></span>
<span id="cb261-30"><a href="validate-tree-detection-and-crown-delineation.html#cb261-30" tabindex="-1"></a>      , T <span class="sc">~</span> <span class="dv">2</span> <span class="sc">*</span> ( (precision<span class="sc">*</span>recall)<span class="sc">/</span>(precision<span class="sc">+</span>recall) )</span>
<span id="cb261-31"><a href="validate-tree-detection-and-crown-delineation.html#cb261-31" tabindex="-1"></a>    )</span>
<span id="cb261-32"><a href="validate-tree-detection-and-crown-delineation.html#cb261-32" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb261-33"><a href="validate-tree-detection-and-crown-delineation.html#cb261-33" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(f_score),<span class="fu">desc</span>(precision),<span class="fu">desc</span>(recall),<span class="fu">desc</span>(n_fld_cllctd_stems),<span class="fu">desc</span>(n_img_annttd_crwns)) <span class="sc">%&gt;%</span> </span>
<span id="cb261-34"><a href="validate-tree-detection-and-crown-delineation.html#cb261-34" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">is_best_fn =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>()<span class="sc">==</span><span class="dv">1</span>)</span>
<span id="cb261-35"><a href="validate-tree-detection-and-crown-delineation.html#cb261-35" tabindex="-1"></a><span class="co"># save it</span></span>
<span id="cb261-36"><a href="validate-tree-detection-and-crown-delineation.html#cb261-36" tabindex="-1"></a>readr<span class="sc">::</span><span class="fu">write_csv</span>(training_eval_overall, <span class="st">&quot;../data/NeonTreeEvaluation_training_eval_overall.csv&quot;</span>, <span class="at">append =</span> F, <span class="at">progress =</span> F)</span>
<span id="cb261-37"><a href="validate-tree-detection-and-crown-delineation.html#cb261-37" tabindex="-1"></a><span class="co"># site eval results</span></span>
<span id="cb261-38"><a href="validate-tree-detection-and-crown-delineation.html#cb261-38" tabindex="-1"></a>training_eval_by_site <span class="ot">&lt;-</span></span>
<span id="cb261-39"><a href="validate-tree-detection-and-crown-delineation.html#cb261-39" tabindex="-1"></a>  training_eval_combined_temp <span class="sc">%&gt;%</span> </span>
<span id="cb261-40"><a href="validate-tree-detection-and-crown-delineation.html#cb261-40" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(siteID,ws_fn_nm) <span class="sc">%&gt;%</span> </span>
<span id="cb261-41"><a href="validate-tree-detection-and-crown-delineation.html#cb261-41" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb261-42"><a href="validate-tree-detection-and-crown-delineation.html#cb261-42" tabindex="-1"></a>    <span class="at">precision =</span> <span class="fu">mean</span>(precision, <span class="at">na.rm =</span> T)</span>
<span id="cb261-43"><a href="validate-tree-detection-and-crown-delineation.html#cb261-43" tabindex="-1"></a>    , <span class="at">recall =</span> <span class="fu">mean</span>(recall, <span class="at">na.rm =</span> T)</span>
<span id="cb261-44"><a href="validate-tree-detection-and-crown-delineation.html#cb261-44" tabindex="-1"></a>    , <span class="at">n_fld_cllctd_stems =</span> <span class="fu">sum</span>(<span class="fu">ifelse</span>(eval_type <span class="sc">==</span> <span class="st">&quot;fld_cllctd_stems&quot;</span>,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb261-45"><a href="validate-tree-detection-and-crown-delineation.html#cb261-45" tabindex="-1"></a>    , <span class="at">n_img_annttd_crwns =</span> <span class="fu">sum</span>(<span class="fu">ifelse</span>(eval_type <span class="sc">==</span> <span class="st">&quot;img_annttd_crwns&quot;</span>,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb261-46"><a href="validate-tree-detection-and-crown-delineation.html#cb261-46" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb261-47"><a href="validate-tree-detection-and-crown-delineation.html#cb261-47" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb261-48"><a href="validate-tree-detection-and-crown-delineation.html#cb261-48" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb261-49"><a href="validate-tree-detection-and-crown-delineation.html#cb261-49" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">across</span>(<span class="at">.cols =</span> <span class="fu">c</span>(precision,recall), <span class="sc">~</span><span class="fu">ifelse</span>(<span class="fu">is.nan</span>(.x),<span class="fu">as.numeric</span>(<span class="cn">NA</span>),.x))</span>
<span id="cb261-50"><a href="validate-tree-detection-and-crown-delineation.html#cb261-50" tabindex="-1"></a>    , <span class="at">f_score =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb261-51"><a href="validate-tree-detection-and-crown-delineation.html#cb261-51" tabindex="-1"></a>      <span class="fu">is.na</span>(precision) <span class="sc">|</span> <span class="fu">is.na</span>(recall) <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb261-52"><a href="validate-tree-detection-and-crown-delineation.html#cb261-52" tabindex="-1"></a>      , (precision<span class="sc">+</span>recall) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="dv">0</span></span>
<span id="cb261-53"><a href="validate-tree-detection-and-crown-delineation.html#cb261-53" tabindex="-1"></a>      , T <span class="sc">~</span> <span class="dv">2</span> <span class="sc">*</span> ( (precision<span class="sc">*</span>recall)<span class="sc">/</span>(precision<span class="sc">+</span>recall) )</span>
<span id="cb261-54"><a href="validate-tree-detection-and-crown-delineation.html#cb261-54" tabindex="-1"></a>    )</span>
<span id="cb261-55"><a href="validate-tree-detection-and-crown-delineation.html#cb261-55" tabindex="-1"></a>  )</span>
<span id="cb261-56"><a href="validate-tree-detection-and-crown-delineation.html#cb261-56" tabindex="-1"></a><span class="co"># save it after cleaning</span></span></code></pre></div>
<div id="best-variable-window-function-by-neon-site" class="section level5 hasAnchor" number="4.2.4.5.1">
<h5><span class="header-section-number">4.2.4.5.1</span> Best variable window function by NEON site<a href="validate-tree-detection-and-crown-delineation.html#best-variable-window-function-by-neon-site" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>we collapsed across plot to calculate an average precision and recall for each NEON site and variable window function combination</p>
<div class="sourceCode" id="cb262"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb262-1"><a href="validate-tree-detection-and-crown-delineation.html#cb262-1" tabindex="-1"></a>training_eval_by_site <span class="sc">%&gt;%</span> </span>
<span id="cb262-2"><a href="validate-tree-detection-and-crown-delineation.html#cb262-2" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(precision,recall,f_score)) <span class="sc">%&gt;%</span> </span>
<span id="cb262-3"><a href="validate-tree-detection-and-crown-delineation.html#cb262-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb262-4"><a href="validate-tree-detection-and-crown-delineation.html#cb262-4" tabindex="-1"></a>    <span class="at">name =</span> <span class="fu">ifelse</span>(name<span class="sc">==</span><span class="st">&quot;f_score&quot;</span>,<span class="st">&quot;F-score&quot;</span>,name) <span class="sc">%&gt;%</span> forcats<span class="sc">::</span><span class="fu">fct_rev</span>()</span>
<span id="cb262-5"><a href="validate-tree-detection-and-crown-delineation.html#cb262-5" tabindex="-1"></a>    , <span class="at">siteID =</span> forcats<span class="sc">::</span><span class="fu">fct_rev</span>(siteID)</span>
<span id="cb262-6"><a href="validate-tree-detection-and-crown-delineation.html#cb262-6" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb262-7"><a href="validate-tree-detection-and-crown-delineation.html#cb262-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">y =</span> siteID, <span class="at">color =</span> ws_fn_nm)) <span class="sc">+</span></span>
<span id="cb262-8"><a href="validate-tree-detection-and-crown-delineation.html#cb262-8" tabindex="-1"></a>    <span class="co"># ggplot2::geom_point(size = 4) +</span></span>
<span id="cb262-9"><a href="validate-tree-detection-and-crown-delineation.html#cb262-9" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_jitter</span>(<span class="at">height =</span> <span class="fl">0.12</span>, <span class="at">width =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb262-10"><a href="validate-tree-detection-and-crown-delineation.html#cb262-10" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_grid</span>(<span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(name)) <span class="sc">+</span></span>
<span id="cb262-11"><a href="validate-tree-detection-and-crown-delineation.html#cb262-11" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> pal_ws) <span class="sc">+</span></span>
<span id="cb262-12"><a href="validate-tree-detection-and-crown-delineation.html#cb262-12" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb262-13"><a href="validate-tree-detection-and-crown-delineation.html#cb262-13" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb262-14"><a href="validate-tree-detection-and-crown-delineation.html#cb262-14" tabindex="-1"></a>      , <span class="at">color =</span> <span class="st">&quot;variable</span><span class="sc">\n</span><span class="st">window</span><span class="sc">\n</span><span class="st">function&quot;</span></span>
<span id="cb262-15"><a href="validate-tree-detection-and-crown-delineation.html#cb262-15" tabindex="-1"></a>      , <span class="at">subtitle =</span> <span class="st">&quot;Training data: overall validation against ground truth by NEON site&quot;</span></span>
<span id="cb262-16"><a href="validate-tree-detection-and-crown-delineation.html#cb262-16" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb262-17"><a href="validate-tree-detection-and-crown-delineation.html#cb262-17" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb262-18"><a href="validate-tree-detection-and-crown-delineation.html#cb262-18" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb262-19"><a href="validate-tree-detection-and-crown-delineation.html#cb262-19" tabindex="-1"></a>      <span class="at">axis.text.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">7</span>)</span>
<span id="cb262-20"><a href="validate-tree-detection-and-crown-delineation.html#cb262-20" tabindex="-1"></a>      , <span class="at">panel.grid.major.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_line</span>(<span class="at">color=</span><span class="st">&quot;gray22&quot;</span>)</span>
<span id="cb262-21"><a href="validate-tree-detection-and-crown-delineation.html#cb262-21" tabindex="-1"></a>      , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb262-22"><a href="validate-tree-detection-and-crown-delineation.html#cb262-22" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb262-23"><a href="validate-tree-detection-and-crown-delineation.html#cb262-23" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">guides</span>(</span>
<span id="cb262-24"><a href="validate-tree-detection-and-crown-delineation.html#cb262-24" tabindex="-1"></a>      <span class="at">color =</span> ggplot2<span class="sc">::</span><span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">shape =</span> <span class="dv">15</span>, <span class="at">size =</span> <span class="dv">6</span>))</span>
<span id="cb262-25"><a href="validate-tree-detection-and-crown-delineation.html#cb262-25" tabindex="-1"></a>    )</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-238-1.png" width="1008" /></p>
<p>Note that not every NEON site has a precision value filled (and no F-score). These NEON sites <a href="validate-tree-detection-and-crown-delineation.html#trn_dta">did not have enough data</a> to use for training data to be evaluated against the image annotated crown ground truth data. For these sites, we’ll select the variable window function that resulted in the best recall as determined by comparing the training data to the field collected stems ground truth data.</p>
<p>Ties across window functions will be broken by selecting the window function that resulted in the fewest trees extracted from the point cloud since, for the sites with recall only, the window function able to best detect trees by using fewer trees will be more precise</p>
<div class="sourceCode" id="cb263"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb263-1"><a href="validate-tree-detection-and-crown-delineation.html#cb263-1" tabindex="-1"></a>trees_site_fn_temp <span class="ot">&lt;-</span></span>
<span id="cb263-2"><a href="validate-tree-detection-and-crown-delineation.html#cb263-2" tabindex="-1"></a>  training_submission <span class="sc">%&gt;%</span> </span>
<span id="cb263-3"><a href="validate-tree-detection-and-crown-delineation.html#cb263-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">area =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.)) <span class="sc">%&gt;%</span> </span>
<span id="cb263-4"><a href="validate-tree-detection-and-crown-delineation.html#cb263-4" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb263-5"><a href="validate-tree-detection-and-crown-delineation.html#cb263-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(plot_name,ws_fn_nm) <span class="sc">%&gt;%</span> </span>
<span id="cb263-6"><a href="validate-tree-detection-and-crown-delineation.html#cb263-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">trees =</span> dplyr<span class="sc">::</span><span class="fu">n</span>(), <span class="at">area =</span> <span class="fu">sum</span>(area, <span class="at">na.rm =</span> T)) <span class="sc">%&gt;%</span></span>
<span id="cb263-7"><a href="validate-tree-detection-and-crown-delineation.html#cb263-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb263-8"><a href="validate-tree-detection-and-crown-delineation.html#cb263-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb263-9"><a href="validate-tree-detection-and-crown-delineation.html#cb263-9" tabindex="-1"></a>    lidar_df <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">distinct</span>(plot_name,siteID)</span>
<span id="cb263-10"><a href="validate-tree-detection-and-crown-delineation.html#cb263-10" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;plot_name&quot;</span></span>
<span id="cb263-11"><a href="validate-tree-detection-and-crown-delineation.html#cb263-11" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb263-12"><a href="validate-tree-detection-and-crown-delineation.html#cb263-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(siteID,ws_fn_nm) <span class="sc">%&gt;%</span> </span>
<span id="cb263-13"><a href="validate-tree-detection-and-crown-delineation.html#cb263-13" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb263-14"><a href="validate-tree-detection-and-crown-delineation.html#cb263-14" tabindex="-1"></a>    <span class="at">plots =</span> dplyr<span class="sc">::</span><span class="fu">n</span>()</span>
<span id="cb263-15"><a href="validate-tree-detection-and-crown-delineation.html#cb263-15" tabindex="-1"></a>    , <span class="at">trees =</span> <span class="fu">mean</span>(trees,<span class="at">na.rm =</span> T)</span>
<span id="cb263-16"><a href="validate-tree-detection-and-crown-delineation.html#cb263-16" tabindex="-1"></a>    , <span class="at">area =</span> <span class="fu">mean</span>(area,<span class="at">na.rm =</span> T)) <span class="sc">%&gt;%</span></span>
<span id="cb263-17"><a href="validate-tree-detection-and-crown-delineation.html#cb263-17" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>()</span>
<span id="cb263-18"><a href="validate-tree-detection-and-crown-delineation.html#cb263-18" tabindex="-1"></a><span class="co"># trees_site_fn_temp %&gt;% dplyr::glimpse()</span></span></code></pre></div>
<p>let’s look at the trees detected by NEON site and variable window function</p>
<div class="sourceCode" id="cb264"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb264-1"><a href="validate-tree-detection-and-crown-delineation.html#cb264-1" tabindex="-1"></a>trees_site_fn_temp <span class="sc">%&gt;%</span> </span>
<span id="cb264-2"><a href="validate-tree-detection-and-crown-delineation.html#cb264-2" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(trees,area)) <span class="sc">%&gt;%</span> </span>
<span id="cb264-3"><a href="validate-tree-detection-and-crown-delineation.html#cb264-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb264-4"><a href="validate-tree-detection-and-crown-delineation.html#cb264-4" tabindex="-1"></a>    <span class="at">siteID =</span> forcats<span class="sc">::</span><span class="fu">fct_rev</span>(siteID)</span>
<span id="cb264-5"><a href="validate-tree-detection-and-crown-delineation.html#cb264-5" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb264-6"><a href="validate-tree-detection-and-crown-delineation.html#cb264-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">y =</span> siteID, <span class="at">color =</span> ws_fn_nm)) <span class="sc">+</span></span>
<span id="cb264-7"><a href="validate-tree-detection-and-crown-delineation.html#cb264-7" tabindex="-1"></a>    <span class="co"># ggplot2::geom_point(size = 4) +</span></span>
<span id="cb264-8"><a href="validate-tree-detection-and-crown-delineation.html#cb264-8" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_jitter</span>(<span class="at">height =</span> <span class="fl">0.12</span>, <span class="at">width =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb264-9"><a href="validate-tree-detection-and-crown-delineation.html#cb264-9" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_grid</span>(<span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(name), <span class="at">scales =</span> <span class="st">&quot;free_x&quot;</span>) <span class="sc">+</span></span>
<span id="cb264-10"><a href="validate-tree-detection-and-crown-delineation.html#cb264-10" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_x_log10</span>() <span class="sc">+</span></span>
<span id="cb264-11"><a href="validate-tree-detection-and-crown-delineation.html#cb264-11" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> pal_ws) <span class="sc">+</span></span>
<span id="cb264-12"><a href="validate-tree-detection-and-crown-delineation.html#cb264-12" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb264-13"><a href="validate-tree-detection-and-crown-delineation.html#cb264-13" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb264-14"><a href="validate-tree-detection-and-crown-delineation.html#cb264-14" tabindex="-1"></a>      , <span class="at">color =</span> <span class="st">&quot;variable</span><span class="sc">\n</span><span class="st">window</span><span class="sc">\n</span><span class="st">function&quot;</span></span>
<span id="cb264-15"><a href="validate-tree-detection-and-crown-delineation.html#cb264-15" tabindex="-1"></a>      , <span class="at">subtitle =</span> <span class="st">&quot;Training data: trees detected and area covered by tree crowns&quot;</span></span>
<span id="cb264-16"><a href="validate-tree-detection-and-crown-delineation.html#cb264-16" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb264-17"><a href="validate-tree-detection-and-crown-delineation.html#cb264-17" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb264-18"><a href="validate-tree-detection-and-crown-delineation.html#cb264-18" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb264-19"><a href="validate-tree-detection-and-crown-delineation.html#cb264-19" tabindex="-1"></a>      <span class="at">panel.grid.major.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_line</span>(<span class="at">color=</span><span class="st">&quot;gray22&quot;</span>)</span>
<span id="cb264-20"><a href="validate-tree-detection-and-crown-delineation.html#cb264-20" tabindex="-1"></a>      , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb264-21"><a href="validate-tree-detection-and-crown-delineation.html#cb264-21" tabindex="-1"></a>      , <span class="at">axis.text.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb264-22"><a href="validate-tree-detection-and-crown-delineation.html#cb264-22" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb264-23"><a href="validate-tree-detection-and-crown-delineation.html#cb264-23" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">guides</span>(</span>
<span id="cb264-24"><a href="validate-tree-detection-and-crown-delineation.html#cb264-24" tabindex="-1"></a>      <span class="at">color =</span> ggplot2<span class="sc">::</span><span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">shape =</span> <span class="dv">15</span>, <span class="at">size =</span> <span class="dv">6</span>))</span>
<span id="cb264-25"><a href="validate-tree-detection-and-crown-delineation.html#cb264-25" tabindex="-1"></a>    )</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-240-1.png" width="1008" /></p>
<p>There are some variable window functions that resulted in many more trees extracted than others. If we only have recall to judge by, these functions will perform better than others which may actually be more suitable simply because there are more trees (more of the plot area is covered so it is more likely that trees will be “detected” with no penalty for including more trees). To put some checks in-place to detect these instances, we’ll exclude functions from consideration to be selected if recall is the only evaluation metric and the number of trees detected is more than two standard deviations from the mean number of trees detected in a plot at a site. We’ll apply the same constraints for the area covered by tree crowns as well to catch cases when there may be few trees detected but the individual crown area is very large so it covers more area even with fewer trees.</p>
<div class="sourceCode" id="cb265"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb265-1"><a href="validate-tree-detection-and-crown-delineation.html#cb265-1" tabindex="-1"></a>trees_site_fn_temp <span class="ot">&lt;-</span> trees_site_fn_temp <span class="sc">%&gt;%</span> </span>
<span id="cb265-2"><a href="validate-tree-detection-and-crown-delineation.html#cb265-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(siteID) <span class="sc">%&gt;%</span> </span>
<span id="cb265-3"><a href="validate-tree-detection-and-crown-delineation.html#cb265-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb265-4"><a href="validate-tree-detection-and-crown-delineation.html#cb265-4" tabindex="-1"></a>    <span class="at">mean_trees =</span> <span class="fu">mean</span>(trees,<span class="at">na.rm =</span> T), <span class="at">sd_trees =</span> <span class="fu">sd</span>(trees,<span class="at">na.rm =</span> T)</span>
<span id="cb265-5"><a href="validate-tree-detection-and-crown-delineation.html#cb265-5" tabindex="-1"></a>    , <span class="at">mean_area =</span> <span class="fu">mean</span>(area,<span class="at">na.rm =</span> T), <span class="at">sd_area =</span> <span class="fu">sd</span>(area,<span class="at">na.rm =</span> T)</span>
<span id="cb265-6"><a href="validate-tree-detection-and-crown-delineation.html#cb265-6" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb265-7"><a href="validate-tree-detection-and-crown-delineation.html#cb265-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb265-8"><a href="validate-tree-detection-and-crown-delineation.html#cb265-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb265-9"><a href="validate-tree-detection-and-crown-delineation.html#cb265-9" tabindex="-1"></a>    <span class="at">exclude_these_fns =</span> </span>
<span id="cb265-10"><a href="validate-tree-detection-and-crown-delineation.html#cb265-10" tabindex="-1"></a>      ( <span class="fu">abs</span>(trees<span class="sc">-</span>mean_trees)<span class="sc">&gt;</span>(<span class="dv">2</span><span class="sc">*</span>sd_trees) ) <span class="sc">|</span> </span>
<span id="cb265-11"><a href="validate-tree-detection-and-crown-delineation.html#cb265-11" tabindex="-1"></a>      ( <span class="fu">abs</span>(area<span class="sc">-</span>mean_area)<span class="sc">&gt;</span>(<span class="dv">2</span><span class="sc">*</span>sd_area) )</span>
<span id="cb265-12"><a href="validate-tree-detection-and-crown-delineation.html#cb265-12" tabindex="-1"></a>  )</span></code></pre></div>
<p>pick the best window function</p>
<div class="sourceCode" id="cb266"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb266-1"><a href="validate-tree-detection-and-crown-delineation.html#cb266-1" tabindex="-1"></a>training_eval_by_site <span class="ot">&lt;-</span> training_eval_by_site <span class="sc">%&gt;%</span> </span>
<span id="cb266-2"><a href="validate-tree-detection-and-crown-delineation.html#cb266-2" tabindex="-1"></a>  <span class="co"># attach trees</span></span>
<span id="cb266-3"><a href="validate-tree-detection-and-crown-delineation.html#cb266-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb266-4"><a href="validate-tree-detection-and-crown-delineation.html#cb266-4" tabindex="-1"></a>    trees_site_fn_temp <span class="sc">%&gt;%</span> </span>
<span id="cb266-5"><a href="validate-tree-detection-and-crown-delineation.html#cb266-5" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>plots)</span>
<span id="cb266-6"><a href="validate-tree-detection-and-crown-delineation.html#cb266-6" tabindex="-1"></a>    , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(siteID,ws_fn_nm)</span>
<span id="cb266-7"><a href="validate-tree-detection-and-crown-delineation.html#cb266-7" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb266-8"><a href="validate-tree-detection-and-crown-delineation.html#cb266-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(siteID,<span class="fu">desc</span>(f_score),<span class="fu">desc</span>(precision),exclude_these_fns,<span class="fu">desc</span>(recall),area,trees) <span class="sc">%&gt;%</span> </span>
<span id="cb266-9"><a href="validate-tree-detection-and-crown-delineation.html#cb266-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(siteID) <span class="sc">%&gt;%</span> </span>
<span id="cb266-10"><a href="validate-tree-detection-and-crown-delineation.html#cb266-10" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">is_best_fn =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>()<span class="sc">==</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb266-11"><a href="validate-tree-detection-and-crown-delineation.html#cb266-11" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>()</span>
<span id="cb266-12"><a href="validate-tree-detection-and-crown-delineation.html#cb266-12" tabindex="-1"></a><span class="co"># save it</span></span>
<span id="cb266-13"><a href="validate-tree-detection-and-crown-delineation.html#cb266-13" tabindex="-1"></a>readr<span class="sc">::</span><span class="fu">write_csv</span>(training_eval_by_site, <span class="st">&quot;../data/NeonTreeEvaluation_training_eval_by_site.csv&quot;</span>, <span class="at">append =</span> F, <span class="at">progress =</span> F)</span></code></pre></div>
<p>show the best window function by site</p>
<div class="sourceCode" id="cb267"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb267-1"><a href="validate-tree-detection-and-crown-delineation.html#cb267-1" tabindex="-1"></a>training_eval_by_site <span class="sc">%&gt;%</span> </span>
<span id="cb267-2"><a href="validate-tree-detection-and-crown-delineation.html#cb267-2" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(precision,recall,f_score)) <span class="sc">%&gt;%</span> </span>
<span id="cb267-3"><a href="validate-tree-detection-and-crown-delineation.html#cb267-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb267-4"><a href="validate-tree-detection-and-crown-delineation.html#cb267-4" tabindex="-1"></a>    <span class="at">name =</span> <span class="fu">ifelse</span>(name<span class="sc">==</span><span class="st">&quot;f_score&quot;</span>,<span class="st">&quot;F-score&quot;</span>,name) <span class="sc">%&gt;%</span> forcats<span class="sc">::</span><span class="fu">fct_rev</span>()</span>
<span id="cb267-5"><a href="validate-tree-detection-and-crown-delineation.html#cb267-5" tabindex="-1"></a>    , <span class="at">siteID =</span> forcats<span class="sc">::</span><span class="fu">fct_rev</span>(siteID)</span>
<span id="cb267-6"><a href="validate-tree-detection-and-crown-delineation.html#cb267-6" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb267-7"><a href="validate-tree-detection-and-crown-delineation.html#cb267-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(is_best_fn) <span class="sc">%&gt;%</span> </span>
<span id="cb267-8"><a href="validate-tree-detection-and-crown-delineation.html#cb267-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">y =</span> siteID, <span class="at">color =</span> ws_fn_nm)) <span class="sc">+</span></span>
<span id="cb267-9"><a href="validate-tree-detection-and-crown-delineation.html#cb267-9" tabindex="-1"></a>    <span class="co"># ggplot2::geom_point(size = 4) +</span></span>
<span id="cb267-10"><a href="validate-tree-detection-and-crown-delineation.html#cb267-10" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_jitter</span>(</span>
<span id="cb267-11"><a href="validate-tree-detection-and-crown-delineation.html#cb267-11" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">shape =</span> is_best_fn)</span>
<span id="cb267-12"><a href="validate-tree-detection-and-crown-delineation.html#cb267-12" tabindex="-1"></a>      ,<span class="at">height =</span> <span class="fl">0.12</span></span>
<span id="cb267-13"><a href="validate-tree-detection-and-crown-delineation.html#cb267-13" tabindex="-1"></a>      , <span class="at">width =</span> <span class="dv">0</span></span>
<span id="cb267-14"><a href="validate-tree-detection-and-crown-delineation.html#cb267-14" tabindex="-1"></a>      , <span class="at">size =</span> <span class="dv">5</span></span>
<span id="cb267-15"><a href="validate-tree-detection-and-crown-delineation.html#cb267-15" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb267-16"><a href="validate-tree-detection-and-crown-delineation.html#cb267-16" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_grid</span>(<span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(name)) <span class="sc">+</span></span>
<span id="cb267-17"><a href="validate-tree-detection-and-crown-delineation.html#cb267-17" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> pal_ws) <span class="sc">+</span></span>
<span id="cb267-18"><a href="validate-tree-detection-and-crown-delineation.html#cb267-18" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">20</span>,<span class="dv">15</span>)) <span class="sc">+</span></span>
<span id="cb267-19"><a href="validate-tree-detection-and-crown-delineation.html#cb267-19" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb267-20"><a href="validate-tree-detection-and-crown-delineation.html#cb267-20" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb267-21"><a href="validate-tree-detection-and-crown-delineation.html#cb267-21" tabindex="-1"></a>      , <span class="at">color =</span> <span class="st">&quot;variable</span><span class="sc">\n</span><span class="st">window</span><span class="sc">\n</span><span class="st">function&quot;</span></span>
<span id="cb267-22"><a href="validate-tree-detection-and-crown-delineation.html#cb267-22" tabindex="-1"></a>      , <span class="at">subtitle =</span> <span class="st">&quot;Best variable window function by NEON site based on training data evaluation&quot;</span></span>
<span id="cb267-23"><a href="validate-tree-detection-and-crown-delineation.html#cb267-23" tabindex="-1"></a>      , <span class="at">caption =</span> <span class="st">&quot;*a square indicates the best function&quot;</span></span>
<span id="cb267-24"><a href="validate-tree-detection-and-crown-delineation.html#cb267-24" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb267-25"><a href="validate-tree-detection-and-crown-delineation.html#cb267-25" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb267-26"><a href="validate-tree-detection-and-crown-delineation.html#cb267-26" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb267-27"><a href="validate-tree-detection-and-crown-delineation.html#cb267-27" tabindex="-1"></a>      <span class="at">axis.text.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">7</span>)</span>
<span id="cb267-28"><a href="validate-tree-detection-and-crown-delineation.html#cb267-28" tabindex="-1"></a>      , <span class="at">panel.grid.major.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_line</span>(<span class="at">color=</span><span class="st">&quot;gray22&quot;</span>)</span>
<span id="cb267-29"><a href="validate-tree-detection-and-crown-delineation.html#cb267-29" tabindex="-1"></a>      , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb267-30"><a href="validate-tree-detection-and-crown-delineation.html#cb267-30" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb267-31"><a href="validate-tree-detection-and-crown-delineation.html#cb267-31" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">guides</span>(</span>
<span id="cb267-32"><a href="validate-tree-detection-and-crown-delineation.html#cb267-32" tabindex="-1"></a>      <span class="at">color =</span> ggplot2<span class="sc">::</span><span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">shape =</span> <span class="dv">15</span>, <span class="at">size =</span> <span class="dv">6</span>))</span>
<span id="cb267-33"><a href="validate-tree-detection-and-crown-delineation.html#cb267-33" tabindex="-1"></a>      , <span class="at">shape =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb267-34"><a href="validate-tree-detection-and-crown-delineation.html#cb267-34" tabindex="-1"></a>    )</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-243-1.png" width="1008" /></p>
<p>table of the best function by site</p>
<div class="sourceCode" id="cb268"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb268-1"><a href="validate-tree-detection-and-crown-delineation.html#cb268-1" tabindex="-1"></a>training_eval_by_site <span class="sc">%&gt;%</span> </span>
<span id="cb268-2"><a href="validate-tree-detection-and-crown-delineation.html#cb268-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(is_best_fn) <span class="sc">%&gt;%</span> </span>
<span id="cb268-3"><a href="validate-tree-detection-and-crown-delineation.html#cb268-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(siteID,ws_fn_nm,precision,recall,f_score) <span class="sc">%&gt;%</span> </span>
<span id="cb268-4"><a href="validate-tree-detection-and-crown-delineation.html#cb268-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(siteID) <span class="sc">%&gt;%</span> </span>
<span id="cb268-5"><a href="validate-tree-detection-and-crown-delineation.html#cb268-5" tabindex="-1"></a>kableExtra<span class="sc">::</span><span class="fu">kbl</span>(</span>
<span id="cb268-6"><a href="validate-tree-detection-and-crown-delineation.html#cb268-6" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">&quot;Best variable window function by NEON site based on training data evaluation&quot;</span></span>
<span id="cb268-7"><a href="validate-tree-detection-and-crown-delineation.html#cb268-7" tabindex="-1"></a>    , <span class="at">digits =</span> <span class="dv">2</span></span>
<span id="cb268-8"><a href="validate-tree-detection-and-crown-delineation.html#cb268-8" tabindex="-1"></a>    , <span class="at">col.names =</span> <span class="fu">c</span>(</span>
<span id="cb268-9"><a href="validate-tree-detection-and-crown-delineation.html#cb268-9" tabindex="-1"></a>      <span class="st">&quot;site&quot;</span>,<span class="st">&quot;variable&lt;br&gt;window&lt;br&gt;function&quot;</span></span>
<span id="cb268-10"><a href="validate-tree-detection-and-crown-delineation.html#cb268-10" tabindex="-1"></a>      ,<span class="st">&quot;precision&quot;</span>,<span class="st">&quot;recall&quot;</span>,<span class="st">&quot;F-score&quot;</span></span>
<span id="cb268-11"><a href="validate-tree-detection-and-crown-delineation.html#cb268-11" tabindex="-1"></a>    )</span>
<span id="cb268-12"><a href="validate-tree-detection-and-crown-delineation.html#cb268-12" tabindex="-1"></a>    , <span class="at">escape =</span> F</span>
<span id="cb268-13"><a href="validate-tree-detection-and-crown-delineation.html#cb268-13" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb268-14"><a href="validate-tree-detection-and-crown-delineation.html#cb268-14" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>()</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-244">Table 4.8: </span>Best variable window function by NEON site based on training data evaluation
</caption>
<thead>
<tr>
<th style="text-align:left;">
site
</th>
<th style="text-align:left;">
variable<br>window<br>function
</th>
<th style="text-align:right;">
precision
</th>
<th style="text-align:right;">
recall
</th>
<th style="text-align:right;">
F-score
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
ABBY
</td>
<td style="text-align:left;">
log_less_ccv_fn
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:left;">
DEJU
</td>
<td style="text-align:left;">
log_less_ccv_fn
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
0.86
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:left;">
DSNY
</td>
<td style="text-align:left;">
lin_hi_slp_fn
</td>
<td style="text-align:right;">
0.46
</td>
<td style="text-align:right;">
0.76
</td>
<td style="text-align:right;">
0.58
</td>
</tr>
<tr>
<td style="text-align:left;">
JERC
</td>
<td style="text-align:left;">
log_mor_ccv_fn
</td>
<td style="text-align:right;">
0.20
</td>
<td style="text-align:right;">
0.51
</td>
<td style="text-align:right;">
0.29
</td>
</tr>
<tr>
<td style="text-align:left;">
NIWO
</td>
<td style="text-align:left;">
exp_fn
</td>
<td style="text-align:right;">
0.22
</td>
<td style="text-align:right;">
0.49
</td>
<td style="text-align:right;">
0.30
</td>
</tr>
<tr>
<td style="text-align:left;">
OSBS
</td>
<td style="text-align:left;">
log_fn
</td>
<td style="text-align:right;">
0.14
</td>
<td style="text-align:right;">
0.38
</td>
<td style="text-align:right;">
0.20
</td>
</tr>
<tr>
<td style="text-align:left;">
TALL
</td>
<td style="text-align:left;">
lin_lo_slp_fn
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
0.94
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:left;">
TEAK
</td>
<td style="text-align:left;">
log_fn
</td>
<td style="text-align:right;">
0.37
</td>
<td style="text-align:right;">
0.38
</td>
<td style="text-align:right;">
0.37
</td>
</tr>
</tbody>
</table>
</div>
<div id="best-variable-window-function-overall" class="section level5 hasAnchor" number="4.2.4.5.2">
<h5><span class="header-section-number">4.2.4.5.2</span> Best variable window function overall<a href="validate-tree-detection-and-crown-delineation.html#best-variable-window-function-overall" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>to select the best overall variable window function to apply to NEON sites that lacked training data, we collapsed across all training sites and plots to calculate an average precision and recall at the variable window function level</p>
<p>we can look at the full results table</p>
<div class="sourceCode" id="cb269"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb269-1"><a href="validate-tree-detection-and-crown-delineation.html#cb269-1" tabindex="-1"></a>training_eval_overall <span class="sc">%&gt;%</span> </span>
<span id="cb269-2"><a href="validate-tree-detection-and-crown-delineation.html#cb269-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(is_best_fn)) <span class="sc">%&gt;%</span> </span>
<span id="cb269-3"><a href="validate-tree-detection-and-crown-delineation.html#cb269-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;n_&quot;</span>), <span class="at">.after =</span> dplyr<span class="sc">::</span><span class="fu">last_col</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb269-4"><a href="validate-tree-detection-and-crown-delineation.html#cb269-4" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(</span>
<span id="cb269-5"><a href="validate-tree-detection-and-crown-delineation.html#cb269-5" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">&quot;Best variable window function overall based on training data evaluation&quot;</span></span>
<span id="cb269-6"><a href="validate-tree-detection-and-crown-delineation.html#cb269-6" tabindex="-1"></a>    , <span class="at">digits =</span> <span class="dv">2</span></span>
<span id="cb269-7"><a href="validate-tree-detection-and-crown-delineation.html#cb269-7" tabindex="-1"></a>    , <span class="at">col.names =</span> <span class="fu">c</span>(</span>
<span id="cb269-8"><a href="validate-tree-detection-and-crown-delineation.html#cb269-8" tabindex="-1"></a>      <span class="st">&quot;variable&lt;br&gt;window&lt;br&gt;function&quot;</span></span>
<span id="cb269-9"><a href="validate-tree-detection-and-crown-delineation.html#cb269-9" tabindex="-1"></a>      ,<span class="st">&quot;precision&quot;</span>,<span class="st">&quot;recall&quot;</span>,<span class="st">&quot;F-score&quot;</span></span>
<span id="cb269-10"><a href="validate-tree-detection-and-crown-delineation.html#cb269-10" tabindex="-1"></a>      ,<span class="st">&quot;plots&lt;br&gt;with ground truth&lt;br&gt;field collected stems&quot;</span></span>
<span id="cb269-11"><a href="validate-tree-detection-and-crown-delineation.html#cb269-11" tabindex="-1"></a>      ,<span class="st">&quot;plots&lt;br&gt;with ground truth&lt;br&gt;image ann. crowns&quot;</span></span>
<span id="cb269-12"><a href="validate-tree-detection-and-crown-delineation.html#cb269-12" tabindex="-1"></a>    )</span>
<span id="cb269-13"><a href="validate-tree-detection-and-crown-delineation.html#cb269-13" tabindex="-1"></a>    , <span class="at">escape =</span> F</span>
<span id="cb269-14"><a href="validate-tree-detection-and-crown-delineation.html#cb269-14" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb269-15"><a href="validate-tree-detection-and-crown-delineation.html#cb269-15" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>()</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-245">Table 4.9: </span>Best variable window function overall based on training data evaluation
</caption>
<thead>
<tr>
<th style="text-align:left;">
variable<br>window<br>function
</th>
<th style="text-align:right;">
precision
</th>
<th style="text-align:right;">
recall
</th>
<th style="text-align:right;">
F-score
</th>
<th style="text-align:right;">
plots<br>with ground truth<br>field collected stems
</th>
<th style="text-align:right;">
plots<br>with ground truth<br>image ann. crowns
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
log_mor_ccv_fn
</td>
<td style="text-align:right;">
0.26
</td>
<td style="text-align:right;">
0.57
</td>
<td style="text-align:right;">
0.36
</td>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
8
</td>
</tr>
<tr>
<td style="text-align:left;">
lin_hi_slp_fn
</td>
<td style="text-align:right;">
0.25
</td>
<td style="text-align:right;">
0.51
</td>
<td style="text-align:right;">
0.34
</td>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
8
</td>
</tr>
<tr>
<td style="text-align:left;">
log_morr_ccv_fn
</td>
<td style="text-align:right;">
0.24
</td>
<td style="text-align:right;">
0.50
</td>
<td style="text-align:right;">
0.33
</td>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
8
</td>
</tr>
<tr>
<td style="text-align:left;">
log_fn
</td>
<td style="text-align:right;">
0.22
</td>
<td style="text-align:right;">
0.56
</td>
<td style="text-align:right;">
0.32
</td>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
8
</td>
</tr>
<tr>
<td style="text-align:left;">
lin_hi_int_fn
</td>
<td style="text-align:right;">
0.20
</td>
<td style="text-align:right;">
0.61
</td>
<td style="text-align:right;">
0.30
</td>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
8
</td>
</tr>
<tr>
<td style="text-align:left;">
log_les_ccv_fn
</td>
<td style="text-align:right;">
0.18
</td>
<td style="text-align:right;">
0.64
</td>
<td style="text-align:right;">
0.28
</td>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
8
</td>
</tr>
<tr>
<td style="text-align:left;">
lin_fn
</td>
<td style="text-align:right;">
0.17
</td>
<td style="text-align:right;">
0.63
</td>
<td style="text-align:right;">
0.27
</td>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
8
</td>
</tr>
<tr>
<td style="text-align:left;">
exp_fn
</td>
<td style="text-align:right;">
0.15
</td>
<td style="text-align:right;">
0.61
</td>
<td style="text-align:right;">
0.24
</td>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
8
</td>
</tr>
<tr>
<td style="text-align:left;">
exp_mor_ccv_fn
</td>
<td style="text-align:right;">
0.06
</td>
<td style="text-align:right;">
0.48
</td>
<td style="text-align:right;">
0.10
</td>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
8
</td>
</tr>
<tr>
<td style="text-align:left;">
lin_lo_slp_fn
</td>
<td style="text-align:right;">
0.04
</td>
<td style="text-align:right;">
0.64
</td>
<td style="text-align:right;">
0.08
</td>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
8
</td>
</tr>
<tr>
<td style="text-align:left;">
log_less_ccv_fn
</td>
<td style="text-align:right;">
0.04
</td>
<td style="text-align:right;">
0.64
</td>
<td style="text-align:right;">
0.08
</td>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
8
</td>
</tr>
<tr>
<td style="text-align:left;">
exp_les_ccv_fn
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
0.45
</td>
<td style="text-align:right;">
0.01
</td>
<td style="text-align:right;">
11
</td>
<td style="text-align:right;">
6
</td>
</tr>
<tr>
<td style="text-align:left;">
exp_less_ccv_fn
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
0.39
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
11
</td>
<td style="text-align:right;">
5
</td>
</tr>
<tr>
<td style="text-align:left;">
lin_lo_int_fn
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
0.60
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
6
</td>
</tr>
<tr>
<td style="text-align:left;">
exp_lesss_ccv_fn
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
0.18
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
3
</td>
</tr>
</tbody>
</table>
<p>keep in mind that these are average values across plots and sites so the actual metric values matter little…it’s the relative value that we care about</p>
<p>we can view this “quadrant” plot whereby we overlay the median value to differentiate the “best” window size by the two dimensions (precision, recall)…the upper-right quadrant is the “best” of the variable window functions tested based on these training plots evaluated against image annotated crowns and field collected stems ground truth data</p>
<div class="sourceCode" id="cb270"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb270-1"><a href="validate-tree-detection-and-crown-delineation.html#cb270-1" tabindex="-1"></a>training_eval_overall <span class="sc">%&gt;%</span> </span>
<span id="cb270-2"><a href="validate-tree-detection-and-crown-delineation.html#cb270-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x=</span>precision,<span class="at">y=</span>recall,<span class="at">color=</span>ws_fn_nm)) <span class="sc">+</span></span>
<span id="cb270-3"><a href="validate-tree-detection-and-crown-delineation.html#cb270-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">median</span>(training_eval_overall<span class="sc">$</span>recall),<span class="at">linetype=</span><span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span></span>
<span id="cb270-4"><a href="validate-tree-detection-and-crown-delineation.html#cb270-4" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">median</span>(training_eval_overall<span class="sc">$</span>precision),<span class="at">linetype=</span><span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span></span>
<span id="cb270-5"><a href="validate-tree-detection-and-crown-delineation.html#cb270-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">shape=</span>is_best_fn),<span class="at">size =</span> <span class="dv">6</span>) <span class="sc">+</span></span>
<span id="cb270-6"><a href="validate-tree-detection-and-crown-delineation.html#cb270-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> pal_ws) <span class="sc">+</span></span>
<span id="cb270-7"><a href="validate-tree-detection-and-crown-delineation.html#cb270-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">20</span>,<span class="dv">15</span>)) <span class="sc">+</span></span>
<span id="cb270-8"><a href="validate-tree-detection-and-crown-delineation.html#cb270-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.4</span>)) <span class="sc">+</span></span>
<span id="cb270-9"><a href="validate-tree-detection-and-crown-delineation.html#cb270-9" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.7</span>)) <span class="sc">+</span></span>
<span id="cb270-10"><a href="validate-tree-detection-and-crown-delineation.html#cb270-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb270-11"><a href="validate-tree-detection-and-crown-delineation.html#cb270-11" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">&quot;variable</span><span class="sc">\n</span><span class="st">window</span><span class="sc">\n</span><span class="st">function&quot;</span></span>
<span id="cb270-12"><a href="validate-tree-detection-and-crown-delineation.html#cb270-12" tabindex="-1"></a>    , <span class="at">subtitle =</span> <span class="st">&quot;Best variable window function overall based on training data evaluation&quot;</span></span>
<span id="cb270-13"><a href="validate-tree-detection-and-crown-delineation.html#cb270-13" tabindex="-1"></a>    , <span class="at">caption =</span> <span class="st">&quot;*a square indicates the best function&quot;</span></span>
<span id="cb270-14"><a href="validate-tree-detection-and-crown-delineation.html#cb270-14" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb270-15"><a href="validate-tree-detection-and-crown-delineation.html#cb270-15" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb270-16"><a href="validate-tree-detection-and-crown-delineation.html#cb270-16" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">guides</span>(</span>
<span id="cb270-17"><a href="validate-tree-detection-and-crown-delineation.html#cb270-17" tabindex="-1"></a>    <span class="at">color =</span> ggplot2<span class="sc">::</span><span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">shape =</span> <span class="dv">15</span>, <span class="at">size =</span> <span class="dv">6</span>))</span>
<span id="cb270-18"><a href="validate-tree-detection-and-crown-delineation.html#cb270-18" tabindex="-1"></a>    , <span class="at">shape =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb270-19"><a href="validate-tree-detection-and-crown-delineation.html#cb270-19" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-246-1.png" width="1008" /></p>
<p>now we’ll attach the best variable window function to our processing data</p>
<div class="sourceCode" id="cb271"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb271-1"><a href="validate-tree-detection-and-crown-delineation.html#cb271-1" tabindex="-1"></a>lidar_df <span class="ot">&lt;-</span> lidar_df <span class="sc">%&gt;%</span></span>
<span id="cb271-2"><a href="validate-tree-detection-and-crown-delineation.html#cb271-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb271-3"><a href="validate-tree-detection-and-crown-delineation.html#cb271-3" tabindex="-1"></a>    training_eval_by_site <span class="sc">%&gt;%</span></span>
<span id="cb271-4"><a href="validate-tree-detection-and-crown-delineation.html#cb271-4" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(is_best_fn) <span class="sc">%&gt;%</span> </span>
<span id="cb271-5"><a href="validate-tree-detection-and-crown-delineation.html#cb271-5" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(siteID,ws_fn_nm)</span>
<span id="cb271-6"><a href="validate-tree-detection-and-crown-delineation.html#cb271-6" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;siteID&quot;</span></span>
<span id="cb271-7"><a href="validate-tree-detection-and-crown-delineation.html#cb271-7" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb271-8"><a href="validate-tree-detection-and-crown-delineation.html#cb271-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb271-9"><a href="validate-tree-detection-and-crown-delineation.html#cb271-9" tabindex="-1"></a>    <span class="at">ws_fn_nm =</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(</span>
<span id="cb271-10"><a href="validate-tree-detection-and-crown-delineation.html#cb271-10" tabindex="-1"></a>      ws_fn_nm</span>
<span id="cb271-11"><a href="validate-tree-detection-and-crown-delineation.html#cb271-11" tabindex="-1"></a>      , training_eval_overall <span class="sc">%&gt;%</span></span>
<span id="cb271-12"><a href="validate-tree-detection-and-crown-delineation.html#cb271-12" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(is_best_fn) <span class="sc">%&gt;%</span> </span>
<span id="cb271-13"><a href="validate-tree-detection-and-crown-delineation.html#cb271-13" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">pull</span>(ws_fn_nm)</span>
<span id="cb271-14"><a href="validate-tree-detection-and-crown-delineation.html#cb271-14" tabindex="-1"></a>    )</span>
<span id="cb271-15"><a href="validate-tree-detection-and-crown-delineation.html#cb271-15" tabindex="-1"></a>  )</span>
<span id="cb271-16"><a href="validate-tree-detection-and-crown-delineation.html#cb271-16" tabindex="-1"></a><span class="co"># save</span></span>
<span id="cb271-17"><a href="validate-tree-detection-and-crown-delineation.html#cb271-17" tabindex="-1"></a>readr<span class="sc">::</span><span class="fu">write_csv</span>(lidar_df, <span class="st">&quot;../data/NeonTreeEvaluation_lidar_df.csv&quot;</span>, <span class="at">append =</span> F, <span class="at">progress =</span> F)</span></code></pre></div>
</div>
</div>
</div>
<div id="evaluation-validation-process" class="section level3 hasAnchor" number="4.2.5">
<h3><span class="header-section-number">4.2.5</span> Evaluation validation process<a href="validate-tree-detection-and-crown-delineation.html#evaluation-validation-process" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We can finally process the evaluation data using all that we have gleaned in our analysis with the training data</p>
<div id="extract-trees-for-evaluation-data" class="section level4 hasAnchor" number="4.2.5.1">
<h4><span class="header-section-number">4.2.5.1</span> Extract trees for evaluation data<a href="validate-tree-detection-and-crown-delineation.html#extract-trees-for-evaluation-data" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>as a reminder, here’s how many evaluation plots we have by NEON site</p>
<div class="sourceCode" id="cb272"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb272-1"><a href="validate-tree-detection-and-crown-delineation.html#cb272-1" tabindex="-1"></a>lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb272-2"><a href="validate-tree-detection-and-crown-delineation.html#cb272-2" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb272-3"><a href="validate-tree-detection-and-crown-delineation.html#cb272-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb272-4"><a href="validate-tree-detection-and-crown-delineation.html#cb272-4" tabindex="-1"></a>    data_type <span class="sc">==</span> <span class="st">&quot;evaluation&quot;</span> <span class="sc">&amp;</span></span>
<span id="cb272-5"><a href="validate-tree-detection-and-crown-delineation.html#cb272-5" tabindex="-1"></a>      <span class="sc">!</span>is_new_image_annotation_training <span class="sc">&amp;</span></span>
<span id="cb272-6"><a href="validate-tree-detection-and-crown-delineation.html#cb272-6" tabindex="-1"></a>      <span class="sc">!</span>is_new_field_stems_training</span>
<span id="cb272-7"><a href="validate-tree-detection-and-crown-delineation.html#cb272-7" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb272-8"><a href="validate-tree-detection-and-crown-delineation.html#cb272-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(siteID) <span class="sc">%&gt;%</span> </span>
<span id="cb272-9"><a href="validate-tree-detection-and-crown-delineation.html#cb272-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb272-10"><a href="validate-tree-detection-and-crown-delineation.html#cb272-10" tabindex="-1"></a>    <span class="at">n =</span> dplyr<span class="sc">::</span><span class="fu">n</span>()</span>
<span id="cb272-11"><a href="validate-tree-detection-and-crown-delineation.html#cb272-11" tabindex="-1"></a>    , <span class="at">evaluation_ann_plots =</span> <span class="fu">sum</span>(<span class="fu">ifelse</span>(has_image_annotation,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb272-12"><a href="validate-tree-detection-and-crown-delineation.html#cb272-12" tabindex="-1"></a>    , <span class="at">evaluation_fld_plots =</span> <span class="fu">sum</span>(<span class="fu">ifelse</span>(has_field_stems,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb272-13"><a href="validate-tree-detection-and-crown-delineation.html#cb272-13" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb272-14"><a href="validate-tree-detection-and-crown-delineation.html#cb272-14" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(</span>
<span id="cb272-15"><a href="validate-tree-detection-and-crown-delineation.html#cb272-15" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">&quot;NEON sites with conifers and lidar plots for evaluation&quot;</span></span>
<span id="cb272-16"><a href="validate-tree-detection-and-crown-delineation.html#cb272-16" tabindex="-1"></a>    , <span class="at">col.names =</span> <span class="fu">c</span>(</span>
<span id="cb272-17"><a href="validate-tree-detection-and-crown-delineation.html#cb272-17" tabindex="-1"></a>      <span class="st">&quot;site&quot;</span>,<span class="st">&quot;unique&lt;br&gt;evaluation plots&quot;</span></span>
<span id="cb272-18"><a href="validate-tree-detection-and-crown-delineation.html#cb272-18" tabindex="-1"></a>      ,<span class="st">&quot;evaluation plots&lt;br&gt;with ground truth&lt;br&gt;image ann. crowns&quot;</span></span>
<span id="cb272-19"><a href="validate-tree-detection-and-crown-delineation.html#cb272-19" tabindex="-1"></a>      ,<span class="st">&quot;evaluation plots&lt;br&gt;with ground truth&lt;br&gt;field collected stems&quot;</span></span>
<span id="cb272-20"><a href="validate-tree-detection-and-crown-delineation.html#cb272-20" tabindex="-1"></a>    )</span>
<span id="cb272-21"><a href="validate-tree-detection-and-crown-delineation.html#cb272-21" tabindex="-1"></a>    , <span class="at">escape =</span> F</span>
<span id="cb272-22"><a href="validate-tree-detection-and-crown-delineation.html#cb272-22" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb272-23"><a href="validate-tree-detection-and-crown-delineation.html#cb272-23" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>()</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-249">Table 4.10: </span>NEON sites with conifers and lidar plots for evaluation
</caption>
<thead>
<tr>
<th style="text-align:left;">
site
</th>
<th style="text-align:right;">
unique<br>evaluation plots
</th>
<th style="text-align:right;">
evaluation plots<br>with ground truth<br>image ann. crowns
</th>
<th style="text-align:right;">
evaluation plots<br>with ground truth<br>field collected stems
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
ABBY
</td>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
11
</td>
</tr>
<tr>
<td style="text-align:left;">
DEJU
</td>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
12
</td>
</tr>
<tr>
<td style="text-align:left;">
DSNY
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
JERC
</td>
<td style="text-align:right;">
20
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
19
</td>
</tr>
<tr>
<td style="text-align:left;">
MOAB
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:left;">
NIWO
</td>
<td style="text-align:right;">
40
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
39
</td>
</tr>
<tr>
<td style="text-align:left;">
ONAQ
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
OSBS
</td>
<td style="text-align:right;">
47
</td>
<td style="text-align:right;">
14
</td>
<td style="text-align:right;">
44
</td>
</tr>
<tr>
<td style="text-align:left;">
SOAP
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
TALL
</td>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
20
</td>
</tr>
<tr>
<td style="text-align:left;">
TEAK
</td>
<td style="text-align:right;">
51
</td>
<td style="text-align:right;">
51
</td>
<td style="text-align:right;">
0
</td>
</tr>
</tbody>
</table>
<p>Now we’ll extract trees from the evaluation lidar data using the best window function for a site based on the training data</p>
<div class="sourceCode" id="cb273"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb273-1"><a href="validate-tree-detection-and-crown-delineation.html#cb273-1" tabindex="-1"></a><span class="co"># where should we save the file?</span></span>
<span id="cb273-2"><a href="validate-tree-detection-and-crown-delineation.html#cb273-2" tabindex="-1"></a>submission_fn_temp <span class="ot">&lt;-</span> <span class="st">&quot;../data/NeonTreeEvaluation_evaluation_submission.gpkg&quot;</span></span>
<span id="cb273-3"><a href="validate-tree-detection-and-crown-delineation.html#cb273-3" tabindex="-1"></a><span class="co"># if we don&#39;t already have the data, run it</span></span>
<span id="cb273-4"><a href="validate-tree-detection-and-crown-delineation.html#cb273-4" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(submission_fn_temp)){</span>
<span id="cb273-5"><a href="validate-tree-detection-and-crown-delineation.html#cb273-5" tabindex="-1"></a><span class="co"># if(T){ </span><span class="al">###</span><span class="co"> !!!!!!! take out when it gets real</span></span>
<span id="cb273-6"><a href="validate-tree-detection-and-crown-delineation.html#cb273-6" tabindex="-1"></a>  <span class="co"># just get evaluation</span></span>
<span id="cb273-7"><a href="validate-tree-detection-and-crown-delineation.html#cb273-7" tabindex="-1"></a>  evaluation_df_temp <span class="ot">&lt;-</span> lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb273-8"><a href="validate-tree-detection-and-crown-delineation.html#cb273-8" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb273-9"><a href="validate-tree-detection-and-crown-delineation.html#cb273-9" tabindex="-1"></a>      data_type <span class="sc">==</span> <span class="st">&quot;evaluation&quot;</span> <span class="sc">&amp;</span></span>
<span id="cb273-10"><a href="validate-tree-detection-and-crown-delineation.html#cb273-10" tabindex="-1"></a>        <span class="sc">!</span>is_new_image_annotation_training <span class="sc">&amp;</span></span>
<span id="cb273-11"><a href="validate-tree-detection-and-crown-delineation.html#cb273-11" tabindex="-1"></a>        <span class="sc">!</span>is_new_field_stems_training</span>
<span id="cb273-12"><a href="validate-tree-detection-and-crown-delineation.html#cb273-12" tabindex="-1"></a>    )</span>
<span id="cb273-13"><a href="validate-tree-detection-and-crown-delineation.html#cb273-13" tabindex="-1"></a>  </span>
<span id="cb273-14"><a href="validate-tree-detection-and-crown-delineation.html#cb273-14" tabindex="-1"></a>  <span class="co"># get trees for each evaluation plot and ws fn combination</span></span>
<span id="cb273-15"><a href="validate-tree-detection-and-crown-delineation.html#cb273-15" tabindex="-1"></a>  evaluation_submission <span class="ot">&lt;-</span> </span>
<span id="cb273-16"><a href="validate-tree-detection-and-crown-delineation.html#cb273-16" tabindex="-1"></a>    <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(evaluation_df_temp) <span class="sc">%&gt;%</span></span>
<span id="cb273-17"><a href="validate-tree-detection-and-crown-delineation.html#cb273-17" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">map</span>(<span class="cf">function</span>(x){ </span>
<span id="cb273-18"><a href="validate-tree-detection-and-crown-delineation.html#cb273-18" tabindex="-1"></a>      <span class="co"># get ws fn</span></span>
<span id="cb273-19"><a href="validate-tree-detection-and-crown-delineation.html#cb273-19" tabindex="-1"></a>      my_fn_nm <span class="ot">&lt;-</span> evaluation_df_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">slice</span>(x) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">pull</span>(ws_fn_nm)</span>
<span id="cb273-20"><a href="validate-tree-detection-and-crown-delineation.html#cb273-20" tabindex="-1"></a>      <span class="co"># run it</span></span>
<span id="cb273-21"><a href="validate-tree-detection-and-crown-delineation.html#cb273-21" tabindex="-1"></a>      ans <span class="ot">&lt;-</span> <span class="fu">cloud2trees_for_eval</span>(</span>
<span id="cb273-22"><a href="validate-tree-detection-and-crown-delineation.html#cb273-22" tabindex="-1"></a>        <span class="at">lidar_df_row =</span> x</span>
<span id="cb273-23"><a href="validate-tree-detection-and-crown-delineation.html#cb273-23" tabindex="-1"></a>        , <span class="at">lidar_df =</span> evaluation_df_temp</span>
<span id="cb273-24"><a href="validate-tree-detection-and-crown-delineation.html#cb273-24" tabindex="-1"></a>        , <span class="at">ws =</span> my_ws_functions[[my_fn_nm]]</span>
<span id="cb273-25"><a href="validate-tree-detection-and-crown-delineation.html#cb273-25" tabindex="-1"></a>      )</span>
<span id="cb273-26"><a href="validate-tree-detection-and-crown-delineation.html#cb273-26" tabindex="-1"></a>      <span class="do">### some of these ws functions may not extract any trees</span></span>
<span id="cb273-27"><a href="validate-tree-detection-and-crown-delineation.html#cb273-27" tabindex="-1"></a>      <span class="do">### account for this</span></span>
<span id="cb273-28"><a href="validate-tree-detection-and-crown-delineation.html#cb273-28" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">is.null</span>(ans) <span class="sc">||</span> <span class="sc">!</span><span class="fu">inherits</span>(ans,<span class="st">&quot;data.frame&quot;</span>)){</span>
<span id="cb273-29"><a href="validate-tree-detection-and-crown-delineation.html#cb273-29" tabindex="-1"></a>        <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb273-30"><a href="validate-tree-detection-and-crown-delineation.html#cb273-30" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb273-31"><a href="validate-tree-detection-and-crown-delineation.html#cb273-31" tabindex="-1"></a>        <span class="fu">return</span>(</span>
<span id="cb273-32"><a href="validate-tree-detection-and-crown-delineation.html#cb273-32" tabindex="-1"></a>          ans <span class="co"># %&gt;% dplyr::mutate(ws_fn_nm = my_fn_nm) # uncomment for testing</span></span>
<span id="cb273-33"><a href="validate-tree-detection-and-crown-delineation.html#cb273-33" tabindex="-1"></a>        )</span>
<span id="cb273-34"><a href="validate-tree-detection-and-crown-delineation.html#cb273-34" tabindex="-1"></a>      }</span>
<span id="cb273-35"><a href="validate-tree-detection-and-crown-delineation.html#cb273-35" tabindex="-1"></a>    }) <span class="sc">%&gt;%</span> </span>
<span id="cb273-36"><a href="validate-tree-detection-and-crown-delineation.html#cb273-36" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span>
<span id="cb273-37"><a href="validate-tree-detection-and-crown-delineation.html#cb273-37" tabindex="-1"></a>  <span class="co"># save it </span></span>
<span id="cb273-38"><a href="validate-tree-detection-and-crown-delineation.html#cb273-38" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_write</span>(evaluation_submission, submission_fn_temp, <span class="at">append =</span> F)</span>
<span id="cb273-39"><a href="validate-tree-detection-and-crown-delineation.html#cb273-39" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb273-40"><a href="validate-tree-detection-and-crown-delineation.html#cb273-40" tabindex="-1"></a>  evaluation_submission <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(submission_fn_temp, <span class="at">quiet =</span> T)</span>
<span id="cb273-41"><a href="validate-tree-detection-and-crown-delineation.html#cb273-41" tabindex="-1"></a>}</span></code></pre></div>
<p>now we need to filter our tree list based on the <a href="validate-tree-detection-and-crown-delineation.html#ht_filter">height threshold for “canopy” trees</a></p>
<div class="sourceCode" id="cb274"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb274-1"><a href="validate-tree-detection-and-crown-delineation.html#cb274-1" tabindex="-1"></a>evaluation_submission <span class="ot">&lt;-</span></span>
<span id="cb274-2"><a href="validate-tree-detection-and-crown-delineation.html#cb274-2" tabindex="-1"></a>  evaluation_submission <span class="sc">%&gt;%</span> </span>
<span id="cb274-3"><a href="validate-tree-detection-and-crown-delineation.html#cb274-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb274-4"><a href="validate-tree-detection-and-crown-delineation.html#cb274-4" tabindex="-1"></a>    lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb274-5"><a href="validate-tree-detection-and-crown-delineation.html#cb274-5" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb274-6"><a href="validate-tree-detection-and-crown-delineation.html#cb274-6" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(plot_name,site_prcntl_ht)</span>
<span id="cb274-7"><a href="validate-tree-detection-and-crown-delineation.html#cb274-7" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;plot_name&quot;</span></span>
<span id="cb274-8"><a href="validate-tree-detection-and-crown-delineation.html#cb274-8" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb274-9"><a href="validate-tree-detection-and-crown-delineation.html#cb274-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(tree_height_m<span class="sc">&gt;=</span>site_prcntl_ht) <span class="sc">%&gt;%</span> </span>
<span id="cb274-10"><a href="validate-tree-detection-and-crown-delineation.html#cb274-10" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(tree_height_m,site_prcntl_ht))</span></code></pre></div>
<p>what did we get?</p>
<div class="sourceCode" id="cb275"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb275-1"><a href="validate-tree-detection-and-crown-delineation.html#cb275-1" tabindex="-1"></a>evaluation_submission <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 26,831
## Columns: 7
## $ xmin      &lt;dbl&gt; 552088.8, 552089.5, 552099.2, 552100.5, 552101.5, 552103.2, …
## $ xmax      &lt;dbl&gt; 552089.5, 552090.2, 552099.8, 552101.5, 552101.8, 552104.2, …
## $ ymin      &lt;dbl&gt; 5068041, 5068041, 5068041, 5068041, 5068041, 5068041, 506804…
## $ ymax      &lt;dbl&gt; 5068042, 5068042, 5068042, 5068042, 5068042, 5068042, 506804…
## $ label     &lt;chr&gt; &quot;Tree&quot;, &quot;Tree&quot;, &quot;Tree&quot;, &quot;Tree&quot;, &quot;Tree&quot;, &quot;Tree&quot;, &quot;Tree&quot;, &quot;Tre…
## $ plot_name &lt;chr&gt; &quot;ABBY_076_2019&quot;, &quot;ABBY_076_2019&quot;, &quot;ABBY_076_2019&quot;, &quot;ABBY_076…
## $ geom      &lt;POLYGON&gt; POLYGON ((552089 5068042, 5..., POLYGON ((552089.5 50680…</code></pre>
</div>
<div id="evaluation-validation-against-ground-truth" class="section level4 hasAnchor" number="4.2.5.2">
<h4><span class="header-section-number">4.2.5.2</span> Evaluation: validation against ground truth<a href="validate-tree-detection-and-crown-delineation.html#evaluation-validation-against-ground-truth" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>We’ll compare our aerial point cloud-based tree detection and crown delineation results to two types of evaluation data (i.e. “ground truth” data) presented by Weinstein et al. (<a href="https://scholar.google.com/scholar?cluster=4986448711981898434&amp;hl=en&amp;as_sdt=0,6">2021</a>): field-collected stems and image-annotated crowns. Field-collected stems offer precise tree locations but might not align with the position of the tree crown as viewed from above (e.g. due to tree lean), image-annotated crowns outline crown boundaries but are subjective.</p>
<div id="scores-for-image-annotated-crowns-2" class="section level5 hasAnchor" number="4.2.5.2.1">
<h5><span class="header-section-number">4.2.5.2.1</span> Scores for image-annotated crowns<a href="validate-tree-detection-and-crown-delineation.html#scores-for-image-annotated-crowns-2" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div class="sourceCode" id="cb277"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb277-1"><a href="validate-tree-detection-and-crown-delineation.html#cb277-1" tabindex="-1"></a><span class="co"># where should we save the file?</span></span>
<span id="cb277-2"><a href="validate-tree-detection-and-crown-delineation.html#cb277-2" tabindex="-1"></a>evaluation_eval_temp <span class="ot">&lt;-</span> <span class="st">&quot;../data/NeonTreeEvaluation_evaluation_evaluate_image_crowns.csv&quot;</span></span>
<span id="cb277-3"><a href="validate-tree-detection-and-crown-delineation.html#cb277-3" tabindex="-1"></a><span class="co"># if we don&#39;t already have the data, run it</span></span>
<span id="cb277-4"><a href="validate-tree-detection-and-crown-delineation.html#cb277-4" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(evaluation_eval_temp)){</span>
<span id="cb277-5"><a href="validate-tree-detection-and-crown-delineation.html#cb277-5" tabindex="-1"></a><span class="co"># if(T){</span></span>
<span id="cb277-6"><a href="validate-tree-detection-and-crown-delineation.html#cb277-6" tabindex="-1"></a>  <span class="co"># filter for only those with this type of validation data</span></span>
<span id="cb277-7"><a href="validate-tree-detection-and-crown-delineation.html#cb277-7" tabindex="-1"></a>  submission_temp <span class="ot">&lt;-</span> evaluation_submission <span class="sc">%&gt;%</span> </span>
<span id="cb277-8"><a href="validate-tree-detection-and-crown-delineation.html#cb277-8" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb277-9"><a href="validate-tree-detection-and-crown-delineation.html#cb277-9" tabindex="-1"></a>      lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb277-10"><a href="validate-tree-detection-and-crown-delineation.html#cb277-10" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb277-11"><a href="validate-tree-detection-and-crown-delineation.html#cb277-11" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(has_image_annotation) <span class="sc">%&gt;%</span> </span>
<span id="cb277-12"><a href="validate-tree-detection-and-crown-delineation.html#cb277-12" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">distinct</span>(plot_name)</span>
<span id="cb277-13"><a href="validate-tree-detection-and-crown-delineation.html#cb277-13" tabindex="-1"></a>      , <span class="at">by =</span> <span class="st">&quot;plot_name&quot;</span></span>
<span id="cb277-14"><a href="validate-tree-detection-and-crown-delineation.html#cb277-14" tabindex="-1"></a>    )</span>
<span id="cb277-15"><a href="validate-tree-detection-and-crown-delineation.html#cb277-15" tabindex="-1"></a>  </span>
<span id="cb277-16"><a href="validate-tree-detection-and-crown-delineation.html#cb277-16" tabindex="-1"></a>  <span class="co"># safe it bc: error in `clue::solve_LSAP()`: long vectors (argument 1) are not supported</span></span>
<span id="cb277-17"><a href="validate-tree-detection-and-crown-delineation.html#cb277-17" tabindex="-1"></a>  <span class="co"># would need to dig through NeonTreeEvaluation, fix, and pull request...</span></span>
<span id="cb277-18"><a href="validate-tree-detection-and-crown-delineation.html#cb277-18" tabindex="-1"></a>  safe_evaluate_image_crowns <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">safely</span>(NeonTreeEvaluation<span class="sc">::</span>evaluate_image_crowns)</span>
<span id="cb277-19"><a href="validate-tree-detection-and-crown-delineation.html#cb277-19" tabindex="-1"></a>  <span class="co"># validate</span></span>
<span id="cb277-20"><a href="validate-tree-detection-and-crown-delineation.html#cb277-20" tabindex="-1"></a>  evaluation_img_annttd_crwns <span class="ot">&lt;-</span> <span class="fu">safe_evaluate_image_crowns</span>(</span>
<span id="cb277-21"><a href="validate-tree-detection-and-crown-delineation.html#cb277-21" tabindex="-1"></a>    <span class="at">predictions =</span> submission_temp <span class="sc">%&gt;%</span> </span>
<span id="cb277-22"><a href="validate-tree-detection-and-crown-delineation.html#cb277-22" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb277-23"><a href="validate-tree-detection-and-crown-delineation.html#cb277-23" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(xmin,ymin,xmax,ymax,label,plot_name)</span>
<span id="cb277-24"><a href="validate-tree-detection-and-crown-delineation.html#cb277-24" tabindex="-1"></a>    , <span class="at">show =</span> F</span>
<span id="cb277-25"><a href="validate-tree-detection-and-crown-delineation.html#cb277-25" tabindex="-1"></a>    , <span class="at">summarize =</span> T</span>
<span id="cb277-26"><a href="validate-tree-detection-and-crown-delineation.html#cb277-26" tabindex="-1"></a>  )</span>
<span id="cb277-27"><a href="validate-tree-detection-and-crown-delineation.html#cb277-27" tabindex="-1"></a>  </span>
<span id="cb277-28"><a href="validate-tree-detection-and-crown-delineation.html#cb277-28" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(evaluation_img_annttd_crwns<span class="sc">$</span>error)){</span>
<span id="cb277-29"><a href="validate-tree-detection-and-crown-delineation.html#cb277-29" tabindex="-1"></a>    <span class="fu">stop</span>(evaluation_img_annttd_crwns<span class="sc">$</span>error)</span>
<span id="cb277-30"><a href="validate-tree-detection-and-crown-delineation.html#cb277-30" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb277-31"><a href="validate-tree-detection-and-crown-delineation.html#cb277-31" tabindex="-1"></a>    evaluation_img_annttd_crwns <span class="ot">&lt;-</span> </span>
<span id="cb277-32"><a href="validate-tree-detection-and-crown-delineation.html#cb277-32" tabindex="-1"></a>      evaluation_img_annttd_crwns<span class="sc">$</span>result <span class="sc">%&gt;%</span> </span>
<span id="cb277-33"><a href="validate-tree-detection-and-crown-delineation.html#cb277-33" tabindex="-1"></a>        purrr<span class="sc">::</span><span class="fu">pluck</span>(<span class="st">&quot;plot_level&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb277-34"><a href="validate-tree-detection-and-crown-delineation.html#cb277-34" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">ungroup</span>()</span>
<span id="cb277-35"><a href="validate-tree-detection-and-crown-delineation.html#cb277-35" tabindex="-1"></a>  }</span>
<span id="cb277-36"><a href="validate-tree-detection-and-crown-delineation.html#cb277-36" tabindex="-1"></a>  <span class="co"># calculate f-score</span></span>
<span id="cb277-37"><a href="validate-tree-detection-and-crown-delineation.html#cb277-37" tabindex="-1"></a>  evaluation_img_annttd_crwns <span class="ot">&lt;-</span> evaluation_img_annttd_crwns <span class="sc">%&gt;%</span> </span>
<span id="cb277-38"><a href="validate-tree-detection-and-crown-delineation.html#cb277-38" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb277-39"><a href="validate-tree-detection-and-crown-delineation.html#cb277-39" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">across</span>(<span class="at">.cols =</span> <span class="fu">c</span>(precision,recall), <span class="sc">~</span><span class="fu">ifelse</span>(<span class="fu">is.nan</span>(.x),<span class="fu">as.numeric</span>(<span class="cn">NA</span>),.x))</span>
<span id="cb277-40"><a href="validate-tree-detection-and-crown-delineation.html#cb277-40" tabindex="-1"></a>      , <span class="at">f_score =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb277-41"><a href="validate-tree-detection-and-crown-delineation.html#cb277-41" tabindex="-1"></a>        <span class="fu">is.na</span>(precision) <span class="sc">|</span> <span class="fu">is.na</span>(recall) <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb277-42"><a href="validate-tree-detection-and-crown-delineation.html#cb277-42" tabindex="-1"></a>        , (precision<span class="sc">+</span>recall) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="dv">0</span></span>
<span id="cb277-43"><a href="validate-tree-detection-and-crown-delineation.html#cb277-43" tabindex="-1"></a>        , T <span class="sc">~</span> <span class="dv">2</span> <span class="sc">*</span> ( (precision<span class="sc">*</span>recall)<span class="sc">/</span>(precision<span class="sc">+</span>recall) )</span>
<span id="cb277-44"><a href="validate-tree-detection-and-crown-delineation.html#cb277-44" tabindex="-1"></a>      )</span>
<span id="cb277-45"><a href="validate-tree-detection-and-crown-delineation.html#cb277-45" tabindex="-1"></a>    )</span>
<span id="cb277-46"><a href="validate-tree-detection-and-crown-delineation.html#cb277-46" tabindex="-1"></a>  <span class="co"># save</span></span>
<span id="cb277-47"><a href="validate-tree-detection-and-crown-delineation.html#cb277-47" tabindex="-1"></a>  readr<span class="sc">::</span><span class="fu">write_csv</span>(evaluation_img_annttd_crwns, <span class="at">file =</span> evaluation_eval_temp)</span>
<span id="cb277-48"><a href="validate-tree-detection-and-crown-delineation.html#cb277-48" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb277-49"><a href="validate-tree-detection-and-crown-delineation.html#cb277-49" tabindex="-1"></a>  evaluation_img_annttd_crwns <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(evaluation_eval_temp, <span class="at">progress =</span> F, <span class="at">show_col_types =</span> F)</span>
<span id="cb277-50"><a href="validate-tree-detection-and-crown-delineation.html#cb277-50" tabindex="-1"></a>}</span>
<span id="cb277-51"><a href="validate-tree-detection-and-crown-delineation.html#cb277-51" tabindex="-1"></a><span class="co"># evaluation_img_annttd_crwns %&gt;% dplyr::glimpse()</span></span></code></pre></div>
<p>our return data should include precision and recall values for each plot that had trees extracted (some evaluation plots might not have extracted any trees) with image annotated crown evaluation data…unless the <code>NeonTreeEvaluation::evaluate_image_crowns()</code> resulted in an error</p>
<p>count of the plots which resulted in trees extracted and were successfully evaluated using image annotated crown ground truth data</p>
<div class="sourceCode" id="cb278"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb278-1"><a href="validate-tree-detection-and-crown-delineation.html#cb278-1" tabindex="-1"></a>evaluation_submission <span class="sc">%&gt;%</span> </span>
<span id="cb278-2"><a href="validate-tree-detection-and-crown-delineation.html#cb278-2" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb278-3"><a href="validate-tree-detection-and-crown-delineation.html#cb278-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb278-4"><a href="validate-tree-detection-and-crown-delineation.html#cb278-4" tabindex="-1"></a>    lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb278-5"><a href="validate-tree-detection-and-crown-delineation.html#cb278-5" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb278-6"><a href="validate-tree-detection-and-crown-delineation.html#cb278-6" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(has_image_annotation) <span class="sc">%&gt;%</span> </span>
<span id="cb278-7"><a href="validate-tree-detection-and-crown-delineation.html#cb278-7" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">distinct</span>(plot_name,siteID)</span>
<span id="cb278-8"><a href="validate-tree-detection-and-crown-delineation.html#cb278-8" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;plot_name&quot;</span></span>
<span id="cb278-9"><a href="validate-tree-detection-and-crown-delineation.html#cb278-9" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb278-10"><a href="validate-tree-detection-and-crown-delineation.html#cb278-10" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(siteID,plot_name) <span class="sc">%&gt;%</span> </span>
<span id="cb278-11"><a href="validate-tree-detection-and-crown-delineation.html#cb278-11" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb278-12"><a href="validate-tree-detection-and-crown-delineation.html#cb278-12" tabindex="-1"></a>    evaluation_img_annttd_crwns</span>
<span id="cb278-13"><a href="validate-tree-detection-and-crown-delineation.html#cb278-13" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;plot_name&quot;</span></span>
<span id="cb278-14"><a href="validate-tree-detection-and-crown-delineation.html#cb278-14" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb278-15"><a href="validate-tree-detection-and-crown-delineation.html#cb278-15" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(siteID) <span class="sc">%&gt;%</span> </span>
<span id="cb278-16"><a href="validate-tree-detection-and-crown-delineation.html#cb278-16" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">plots =</span> dplyr<span class="sc">::</span><span class="fu">n</span>(), <span class="at">plots_eval =</span> <span class="fu">sum</span>(<span class="fu">ifelse</span>(<span class="fu">is.na</span>(f_score),<span class="dv">0</span>,<span class="dv">1</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb278-17"><a href="validate-tree-detection-and-crown-delineation.html#cb278-17" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb278-18"><a href="validate-tree-detection-and-crown-delineation.html#cb278-18" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pct =</span> scales<span class="sc">::</span><span class="fu">percent</span>(plots_eval<span class="sc">/</span>plots,<span class="at">accuracy =</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb278-19"><a href="validate-tree-detection-and-crown-delineation.html#cb278-19" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(siteID) <span class="sc">%&gt;%</span> </span>
<span id="cb278-20"><a href="validate-tree-detection-and-crown-delineation.html#cb278-20" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(</span>
<span id="cb278-21"><a href="validate-tree-detection-and-crown-delineation.html#cb278-21" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">&quot;Count of plots with trees detected that were successfully evaluated using image annotated crowns&quot;</span></span>
<span id="cb278-22"><a href="validate-tree-detection-and-crown-delineation.html#cb278-22" tabindex="-1"></a>    , <span class="at">digits =</span> <span class="dv">0</span></span>
<span id="cb278-23"><a href="validate-tree-detection-and-crown-delineation.html#cb278-23" tabindex="-1"></a>    , <span class="at">col.names =</span> <span class="fu">c</span>(</span>
<span id="cb278-24"><a href="validate-tree-detection-and-crown-delineation.html#cb278-24" tabindex="-1"></a>      <span class="st">&quot;site&quot;</span>,<span class="st">&quot;# plots&lt;br&gt;with trees&quot;</span>,<span class="st">&quot;# plots&lt;br&gt;successfully evaluated&quot;</span></span>
<span id="cb278-25"><a href="validate-tree-detection-and-crown-delineation.html#cb278-25" tabindex="-1"></a>      ,<span class="st">&quot;% plots&lt;br&gt;successfully evaluated&quot;</span></span>
<span id="cb278-26"><a href="validate-tree-detection-and-crown-delineation.html#cb278-26" tabindex="-1"></a>    )</span>
<span id="cb278-27"><a href="validate-tree-detection-and-crown-delineation.html#cb278-27" tabindex="-1"></a>    , <span class="at">escape =</span> F</span>
<span id="cb278-28"><a href="validate-tree-detection-and-crown-delineation.html#cb278-28" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb278-29"><a href="validate-tree-detection-and-crown-delineation.html#cb278-29" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>()</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-255">Table 4.11: </span>Count of plots with trees detected that were successfully evaluated using image annotated crowns
</caption>
<thead>
<tr>
<th style="text-align:left;">
site
</th>
<th style="text-align:right;">
# plots<br>with trees
</th>
<th style="text-align:right;">
# plots<br>successfully evaluated
</th>
<th style="text-align:left;">
% plots<br>successfully evaluated
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
ABBY
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:left;">
100%
</td>
</tr>
<tr>
<td style="text-align:left;">
DSNY
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:left;">
100%
</td>
</tr>
<tr>
<td style="text-align:left;">
JERC
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:left;">
100%
</td>
</tr>
<tr>
<td style="text-align:left;">
NIWO
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:left;">
100%
</td>
</tr>
<tr>
<td style="text-align:left;">
ONAQ
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
100%
</td>
</tr>
<tr>
<td style="text-align:left;">
OSBS
</td>
<td style="text-align:right;">
14
</td>
<td style="text-align:right;">
14
</td>
<td style="text-align:left;">
100%
</td>
</tr>
<tr>
<td style="text-align:left;">
SOAP
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:left;">
100%
</td>
</tr>
<tr>
<td style="text-align:left;">
TALL
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:left;">
100%
</td>
</tr>
<tr>
<td style="text-align:left;">
TEAK
</td>
<td style="text-align:right;">
51
</td>
<td style="text-align:right;">
51
</td>
<td style="text-align:left;">
100%
</td>
</tr>
</tbody>
</table>
<p>we’ll dig into these metrics in the <a href="validate-tree-detection-and-crown-delineation.html#valid_sum">next section</a>; for now, let’s review some figures comparing the image-annotated crowns versus the bounding box of our delineated crown polygons</p>
<p><em>in the RGB plots: “red” boxes are crowns from our point cloud-based method extracted and “black” are the image annotated crowns</em></p>
<div class="sourceCode" id="cb279"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb279-1"><a href="validate-tree-detection-and-crown-delineation.html#cb279-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">888</span>)</span>
<span id="cb279-2"><a href="validate-tree-detection-and-crown-delineation.html#cb279-2" tabindex="-1"></a>evaluation_img_annttd_crwns <span class="sc">%&gt;%</span> </span>
<span id="cb279-3"><a href="validate-tree-detection-and-crown-delineation.html#cb279-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb279-4"><a href="validate-tree-detection-and-crown-delineation.html#cb279-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice_sample</span>(<span class="at">n=</span><span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb279-5"><a href="validate-tree-detection-and-crown-delineation.html#cb279-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(plot_name) <span class="sc">%&gt;%</span> </span>
<span id="cb279-6"><a href="validate-tree-detection-and-crown-delineation.html#cb279-6" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(\(x) NeonTreeEvaluation<span class="sc">::</span><span class="fu">image_crowns</span>(</span>
<span id="cb279-7"><a href="validate-tree-detection-and-crown-delineation.html#cb279-7" tabindex="-1"></a>    <span class="at">predictions =</span> evaluation_submission <span class="sc">%&gt;%</span> </span>
<span id="cb279-8"><a href="validate-tree-detection-and-crown-delineation.html#cb279-8" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb279-9"><a href="validate-tree-detection-and-crown-delineation.html#cb279-9" tabindex="-1"></a>        lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb279-10"><a href="validate-tree-detection-and-crown-delineation.html#cb279-10" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb279-11"><a href="validate-tree-detection-and-crown-delineation.html#cb279-11" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(has_image_annotation) <span class="sc">%&gt;%</span> </span>
<span id="cb279-12"><a href="validate-tree-detection-and-crown-delineation.html#cb279-12" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">distinct</span>(plot_name)</span>
<span id="cb279-13"><a href="validate-tree-detection-and-crown-delineation.html#cb279-13" tabindex="-1"></a>        , <span class="at">by =</span> <span class="st">&quot;plot_name&quot;</span></span>
<span id="cb279-14"><a href="validate-tree-detection-and-crown-delineation.html#cb279-14" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb279-15"><a href="validate-tree-detection-and-crown-delineation.html#cb279-15" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb279-16"><a href="validate-tree-detection-and-crown-delineation.html#cb279-16" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(plot_name<span class="sc">==</span>x)</span>
<span id="cb279-17"><a href="validate-tree-detection-and-crown-delineation.html#cb279-17" tabindex="-1"></a>    , <span class="at">show =</span> T</span>
<span id="cb279-18"><a href="validate-tree-detection-and-crown-delineation.html#cb279-18" tabindex="-1"></a>    , <span class="at">project_boxes =</span> F</span>
<span id="cb279-19"><a href="validate-tree-detection-and-crown-delineation.html#cb279-19" tabindex="-1"></a>  ))</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-256-1.png" width="1008" /><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-256-2.png" width="1008" /><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-256-3.png" width="1008" /></p>
<p><em>in the RGB plots: “red” boxes are crowns from our point cloud-based method extracted and “black” are the image annotated crowns</em></p>
</div>
<div id="prep-for-field-collected-stems-evaluation" class="section level5 hasAnchor" number="4.2.5.2.2">
<h5><span class="header-section-number">4.2.5.2.2</span> Prep for field-collected stems evaluation<a href="validate-tree-detection-and-crown-delineation.html#prep-for-field-collected-stems-evaluation" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>In testing, it was discovered that some plots have lidar data collections from different years (e.g. “NIWO_040_2019” and “NIWO_040_2020”). Unfortunately, when lidar-detected trees from these different data are passed to the <code>NeonTreeEvaluation::evaluate_field_stems()</code> function from the same plot, only a single recall score is returned at the plot level with the year removed (e.g. “NIWO_040”).</p>
<p>If the lidar data is truly different, then we would prefer to obtain evaluated recall for each unique, yearly data set even if it is compared against the same ground truth data. Different lidar data just presents more opportunities for us to test our methodologies. Let’s ensure that these are different lidar data sets by loading in a few.</p>
<div class="sourceCode" id="cb280"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb280-1"><a href="validate-tree-detection-and-crown-delineation.html#cb280-1" tabindex="-1"></a>lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb280-2"><a href="validate-tree-detection-and-crown-delineation.html#cb280-2" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb280-3"><a href="validate-tree-detection-and-crown-delineation.html#cb280-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(plot_has_multiple_years <span class="sc">&amp;</span> has_field_stems) <span class="sc">%&gt;%</span> </span>
<span id="cb280-4"><a href="validate-tree-detection-and-crown-delineation.html#cb280-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(plot_name, plot_name_sans_yr, plot_name_sans_yr_grp) <span class="sc">%&gt;%</span> </span>
<span id="cb280-5"><a href="validate-tree-detection-and-crown-delineation.html#cb280-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice_head</span>(<span class="at">n=</span><span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb280-6"><a href="validate-tree-detection-and-crown-delineation.html#cb280-6" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(<span class="at">caption=</span><span class="st">&quot;examples of plots with lidar data collections from different years&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb280-7"><a href="validate-tree-detection-and-crown-delineation.html#cb280-7" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>()</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-258">Table 4.12: </span>examples of plots with lidar data collections from different years
</caption>
<thead>
<tr>
<th style="text-align:left;">
plot_name
</th>
<th style="text-align:left;">
plot_name_sans_yr
</th>
<th style="text-align:right;">
plot_name_sans_yr_grp
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
ABBY_063_2018
</td>
<td style="text-align:left;">
ABBY_063
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
ABBY_063_2019
</td>
<td style="text-align:left;">
ABBY_063
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:left;">
ABBY_065_2018
</td>
<td style="text-align:left;">
ABBY_065
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
ABBY_065_2019
</td>
<td style="text-align:left;">
ABBY_065
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:left;">
ABBY_070_2018
</td>
<td style="text-align:left;">
ABBY_070
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
ABBY_070_2019
</td>
<td style="text-align:left;">
ABBY_070
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:left;">
ABBY_073_2018
</td>
<td style="text-align:left;">
ABBY_073
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
ABBY_073_2019
</td>
<td style="text-align:left;">
ABBY_073
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:left;">
ABBY_074_2018
</td>
<td style="text-align:left;">
ABBY_074
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
ABBY_074_2019
</td>
<td style="text-align:left;">
ABBY_074
</td>
<td style="text-align:right;">
2
</td>
</tr>
</tbody>
</table>
<p>let’s load in the lidar data for one of these plots with lidar data collections from different years and look at the lidar data summary</p>
<div class="sourceCode" id="cb281"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb281-1"><a href="validate-tree-detection-and-crown-delineation.html#cb281-1" tabindex="-1"></a><span class="co"># sample a plot</span></span>
<span id="cb281-2"><a href="validate-tree-detection-and-crown-delineation.html#cb281-2" tabindex="-1"></a>ex_plot_temp <span class="ot">&lt;-</span> lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb281-3"><a href="validate-tree-detection-and-crown-delineation.html#cb281-3" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb281-4"><a href="validate-tree-detection-and-crown-delineation.html#cb281-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(plot_has_multiple_years) <span class="sc">%&gt;%</span> </span>
<span id="cb281-5"><a href="validate-tree-detection-and-crown-delineation.html#cb281-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice_sample</span>(<span class="at">n=</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb281-6"><a href="validate-tree-detection-and-crown-delineation.html#cb281-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(plot_name_sans_yr)</span>
<span id="cb281-7"><a href="validate-tree-detection-and-crown-delineation.html#cb281-7" tabindex="-1"></a><span class="co"># load in the lidar for all years from this plot</span></span>
<span id="cb281-8"><a href="validate-tree-detection-and-crown-delineation.html#cb281-8" tabindex="-1"></a>las_list_temp <span class="ot">&lt;-</span></span>
<span id="cb281-9"><a href="validate-tree-detection-and-crown-delineation.html#cb281-9" tabindex="-1"></a>  <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>( lidar_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(plot_name_sans_yr<span class="sc">==</span>ex_plot_temp) ) <span class="sc">%&gt;%</span> </span>
<span id="cb281-10"><a href="validate-tree-detection-and-crown-delineation.html#cb281-10" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(<span class="cf">function</span>(x){</span>
<span id="cb281-11"><a href="validate-tree-detection-and-crown-delineation.html#cb281-11" tabindex="-1"></a>    lidR<span class="sc">::</span><span class="fu">readLAS</span>(</span>
<span id="cb281-12"><a href="validate-tree-detection-and-crown-delineation.html#cb281-12" tabindex="-1"></a>      <span class="at">files =</span></span>
<span id="cb281-13"><a href="validate-tree-detection-and-crown-delineation.html#cb281-13" tabindex="-1"></a>        lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb281-14"><a href="validate-tree-detection-and-crown-delineation.html#cb281-14" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(plot_name_sans_yr<span class="sc">==</span>ex_plot_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb281-15"><a href="validate-tree-detection-and-crown-delineation.html#cb281-15" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">slice</span>(x) <span class="sc">%&gt;%</span> </span>
<span id="cb281-16"><a href="validate-tree-detection-and-crown-delineation.html#cb281-16" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">pull</span>(f_path)</span>
<span id="cb281-17"><a href="validate-tree-detection-and-crown-delineation.html#cb281-17" tabindex="-1"></a>    )</span>
<span id="cb281-18"><a href="validate-tree-detection-and-crown-delineation.html#cb281-18" tabindex="-1"></a>  })</span>
<span id="cb281-19"><a href="validate-tree-detection-and-crown-delineation.html#cb281-19" tabindex="-1"></a><span class="co"># check it</span></span>
<span id="cb281-20"><a href="validate-tree-detection-and-crown-delineation.html#cb281-20" tabindex="-1"></a>las_list_temp</span></code></pre></div>
<pre><code>## [[1]]
## class        : LAS (v1.3 format 1)
## memory       : 1.2 Mb 
## extent       : 552589.8, 552629.8, 5067821, 5067861 (xmin, xmax, ymin, ymax)
## coord. ref.  : WGS 84 / UTM zone 10N 
## area         : 1642 m²
## points       : 21.1 thousand points
## density      : 12.88 points/m²
## density      : 7.96 pulses/m²
## 
## [[2]]
## class        : LAS (v1.3 format 3)
## memory       : 1.9 Mb 
## extent       : 552589.8, 552629.8, 5067821, 5067861 (xmin, xmax, ymin, ymax)
## coord. ref.  : WGS 84 / UTM zone 10N 
## area         : 1643 m²
## points       : 27.6 thousand points
## density      : 16.8 points/m²
## density      : 9.11 pulses/m²</code></pre>
<p>notice that even though these point clouds are from the same plot (see the “extent”), the underlying data is different (see the “points” and “memory”)</p>
<p>Since the lidar data is different we will obtain evaluated recall for each unique, yearly data set even if it is compared against the same ground truth data</p>
</div>
<div id="scores-for-field-collected-stems-2" class="section level5 hasAnchor" number="4.2.5.2.3">
<h5><span class="header-section-number">4.2.5.2.3</span> Scores for field-collected stems<a href="validate-tree-detection-and-crown-delineation.html#scores-for-field-collected-stems-2" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div class="sourceCode" id="cb283"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb283-1"><a href="validate-tree-detection-and-crown-delineation.html#cb283-1" tabindex="-1"></a><span class="co"># where should we save the file?</span></span>
<span id="cb283-2"><a href="validate-tree-detection-and-crown-delineation.html#cb283-2" tabindex="-1"></a>evaluation_eval_temp <span class="ot">&lt;-</span> <span class="st">&quot;../data/NeonTreeEvaluation_evaluation_evaluate_field_stems.csv&quot;</span></span>
<span id="cb283-3"><a href="validate-tree-detection-and-crown-delineation.html#cb283-3" tabindex="-1"></a><span class="co"># if we don&#39;t already have the data, run it</span></span>
<span id="cb283-4"><a href="validate-tree-detection-and-crown-delineation.html#cb283-4" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(evaluation_eval_temp)){</span>
<span id="cb283-5"><a href="validate-tree-detection-and-crown-delineation.html#cb283-5" tabindex="-1"></a><span class="co"># if(T){</span></span>
<span id="cb283-6"><a href="validate-tree-detection-and-crown-delineation.html#cb283-6" tabindex="-1"></a>  <span class="co"># filter for only those with this type of validation data</span></span>
<span id="cb283-7"><a href="validate-tree-detection-and-crown-delineation.html#cb283-7" tabindex="-1"></a>  submission_temp <span class="ot">&lt;-</span> evaluation_submission <span class="sc">%&gt;%</span> </span>
<span id="cb283-8"><a href="validate-tree-detection-and-crown-delineation.html#cb283-8" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb283-9"><a href="validate-tree-detection-and-crown-delineation.html#cb283-9" tabindex="-1"></a>      lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb283-10"><a href="validate-tree-detection-and-crown-delineation.html#cb283-10" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb283-11"><a href="validate-tree-detection-and-crown-delineation.html#cb283-11" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(has_field_stems) <span class="sc">%&gt;%</span> </span>
<span id="cb283-12"><a href="validate-tree-detection-and-crown-delineation.html#cb283-12" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">distinct</span>(plot_name,plot_name_sans_yr,plot_name_sans_yr_grp)</span>
<span id="cb283-13"><a href="validate-tree-detection-and-crown-delineation.html#cb283-13" tabindex="-1"></a>      , <span class="at">by =</span> <span class="st">&quot;plot_name&quot;</span></span>
<span id="cb283-14"><a href="validate-tree-detection-and-crown-delineation.html#cb283-14" tabindex="-1"></a>    )</span>
<span id="cb283-15"><a href="validate-tree-detection-and-crown-delineation.html#cb283-15" tabindex="-1"></a>  </span>
<span id="cb283-16"><a href="validate-tree-detection-and-crown-delineation.html#cb283-16" tabindex="-1"></a>  <span class="co"># safe it bc: error in `clue::solve_LSAP()`: long vectors (argument 1) are not supported</span></span>
<span id="cb283-17"><a href="validate-tree-detection-and-crown-delineation.html#cb283-17" tabindex="-1"></a>  <span class="co"># would need to dig through NeonTreeEvaluation, fix, and pull request...</span></span>
<span id="cb283-18"><a href="validate-tree-detection-and-crown-delineation.html#cb283-18" tabindex="-1"></a>  safe_evaluate_field_stems <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">safely</span>(NeonTreeEvaluation<span class="sc">::</span>evaluate_field_stems)</span>
<span id="cb283-19"><a href="validate-tree-detection-and-crown-delineation.html#cb283-19" tabindex="-1"></a>  <span class="co"># validate</span></span>
<span id="cb283-20"><a href="validate-tree-detection-and-crown-delineation.html#cb283-20" tabindex="-1"></a>  evaluation_fld_cllctd_stems <span class="ot">&lt;-</span></span>
<span id="cb283-21"><a href="validate-tree-detection-and-crown-delineation.html#cb283-21" tabindex="-1"></a>    submission_temp<span class="sc">$</span>plot_name_sans_yr_grp <span class="sc">%&gt;%</span> </span>
<span id="cb283-22"><a href="validate-tree-detection-and-crown-delineation.html#cb283-22" tabindex="-1"></a>    <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb283-23"><a href="validate-tree-detection-and-crown-delineation.html#cb283-23" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">map</span>(<span class="cf">function</span>(x){</span>
<span id="cb283-24"><a href="validate-tree-detection-and-crown-delineation.html#cb283-24" tabindex="-1"></a>      ans <span class="ot">&lt;-</span> <span class="fu">safe_evaluate_field_stems</span>(</span>
<span id="cb283-25"><a href="validate-tree-detection-and-crown-delineation.html#cb283-25" tabindex="-1"></a>        <span class="at">predictions =</span> submission_temp <span class="sc">%&gt;%</span> </span>
<span id="cb283-26"><a href="validate-tree-detection-and-crown-delineation.html#cb283-26" tabindex="-1"></a>          <span class="co"># sf::st_drop_geometry() %&gt;% </span><span class="al">###</span><span class="co"> polygons work here !</span></span>
<span id="cb283-27"><a href="validate-tree-detection-and-crown-delineation.html#cb283-27" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(plot_name_sans_yr_grp <span class="sc">==</span> x) <span class="sc">%&gt;%</span> </span>
<span id="cb283-28"><a href="validate-tree-detection-and-crown-delineation.html#cb283-28" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(xmin,ymin,xmax,ymax,label,plot_name)</span>
<span id="cb283-29"><a href="validate-tree-detection-and-crown-delineation.html#cb283-29" tabindex="-1"></a>        , <span class="at">show =</span> F</span>
<span id="cb283-30"><a href="validate-tree-detection-and-crown-delineation.html#cb283-30" tabindex="-1"></a>        , <span class="at">summarize =</span> T</span>
<span id="cb283-31"><a href="validate-tree-detection-and-crown-delineation.html#cb283-31" tabindex="-1"></a>      )</span>
<span id="cb283-32"><a href="validate-tree-detection-and-crown-delineation.html#cb283-32" tabindex="-1"></a>      <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(ans<span class="sc">$</span>error)){</span>
<span id="cb283-33"><a href="validate-tree-detection-and-crown-delineation.html#cb283-33" tabindex="-1"></a>        <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb283-34"><a href="validate-tree-detection-and-crown-delineation.html#cb283-34" tabindex="-1"></a>      }<span class="cf">else</span>{</span>
<span id="cb283-35"><a href="validate-tree-detection-and-crown-delineation.html#cb283-35" tabindex="-1"></a>        <span class="fu">return</span>(</span>
<span id="cb283-36"><a href="validate-tree-detection-and-crown-delineation.html#cb283-36" tabindex="-1"></a>          ans<span class="sc">$</span>result <span class="sc">%&gt;%</span> </span>
<span id="cb283-37"><a href="validate-tree-detection-and-crown-delineation.html#cb283-37" tabindex="-1"></a>            purrr<span class="sc">::</span><span class="fu">pluck</span>(<span class="st">&quot;plot_level&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb283-38"><a href="validate-tree-detection-and-crown-delineation.html#cb283-38" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb283-39"><a href="validate-tree-detection-and-crown-delineation.html#cb283-39" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">plot_name_sans_yr_grp =</span> x)</span>
<span id="cb283-40"><a href="validate-tree-detection-and-crown-delineation.html#cb283-40" tabindex="-1"></a>        ) </span>
<span id="cb283-41"><a href="validate-tree-detection-and-crown-delineation.html#cb283-41" tabindex="-1"></a>      }</span>
<span id="cb283-42"><a href="validate-tree-detection-and-crown-delineation.html#cb283-42" tabindex="-1"></a>    }) <span class="sc">%&gt;%</span> </span>
<span id="cb283-43"><a href="validate-tree-detection-and-crown-delineation.html#cb283-43" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>() <span class="sc">%&gt;%</span></span>
<span id="cb283-44"><a href="validate-tree-detection-and-crown-delineation.html#cb283-44" tabindex="-1"></a>    <span class="co"># attach the full plot name</span></span>
<span id="cb283-45"><a href="validate-tree-detection-and-crown-delineation.html#cb283-45" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb283-46"><a href="validate-tree-detection-and-crown-delineation.html#cb283-46" tabindex="-1"></a>      submission_temp <span class="sc">%&gt;%</span> </span>
<span id="cb283-47"><a href="validate-tree-detection-and-crown-delineation.html#cb283-47" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb283-48"><a href="validate-tree-detection-and-crown-delineation.html#cb283-48" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">distinct</span>(plot_name,plot_name_sans_yr,plot_name_sans_yr_grp) <span class="sc">%&gt;%</span> </span>
<span id="cb283-49"><a href="validate-tree-detection-and-crown-delineation.html#cb283-49" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">plot_name_orig=</span>plot_name)</span>
<span id="cb283-50"><a href="validate-tree-detection-and-crown-delineation.html#cb283-50" tabindex="-1"></a>      , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(plot_name<span class="sc">==</span>plot_name_sans_yr,plot_name_sans_yr_grp)</span>
<span id="cb283-51"><a href="validate-tree-detection-and-crown-delineation.html#cb283-51" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb283-52"><a href="validate-tree-detection-and-crown-delineation.html#cb283-52" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">plot_name =</span> plot_name_orig) <span class="sc">%&gt;%</span> </span>
<span id="cb283-53"><a href="validate-tree-detection-and-crown-delineation.html#cb283-53" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(plot_name_orig,plot_name_sans_yr_grp))</span>
<span id="cb283-54"><a href="validate-tree-detection-and-crown-delineation.html#cb283-54" tabindex="-1"></a>  </span>
<span id="cb283-55"><a href="validate-tree-detection-and-crown-delineation.html#cb283-55" tabindex="-1"></a>  <span class="co"># evaluation_fld_cllctd_stems %&gt;% dplyr::glimpse()</span></span>
<span id="cb283-56"><a href="validate-tree-detection-and-crown-delineation.html#cb283-56" tabindex="-1"></a>  <span class="co"># identical( </span></span>
<span id="cb283-57"><a href="validate-tree-detection-and-crown-delineation.html#cb283-57" tabindex="-1"></a>  <span class="co">#   evaluation_fld_cllctd_stems %&gt;% nrow() </span></span>
<span id="cb283-58"><a href="validate-tree-detection-and-crown-delineation.html#cb283-58" tabindex="-1"></a>  <span class="co">#   , evaluation_fld_cllctd_stems %&gt;% dplyr::distinct(plot_name) %&gt;% nrow() </span></span>
<span id="cb283-59"><a href="validate-tree-detection-and-crown-delineation.html#cb283-59" tabindex="-1"></a>  <span class="co"># )</span></span>
<span id="cb283-60"><a href="validate-tree-detection-and-crown-delineation.html#cb283-60" tabindex="-1"></a>  <span class="co"># save</span></span>
<span id="cb283-61"><a href="validate-tree-detection-and-crown-delineation.html#cb283-61" tabindex="-1"></a>  readr<span class="sc">::</span><span class="fu">write_csv</span>(evaluation_fld_cllctd_stems, <span class="at">file =</span> evaluation_eval_temp)</span>
<span id="cb283-62"><a href="validate-tree-detection-and-crown-delineation.html#cb283-62" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb283-63"><a href="validate-tree-detection-and-crown-delineation.html#cb283-63" tabindex="-1"></a>  evaluation_fld_cllctd_stems <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(evaluation_eval_temp, <span class="at">progress =</span> F, <span class="at">show_col_types =</span> F)</span>
<span id="cb283-64"><a href="validate-tree-detection-and-crown-delineation.html#cb283-64" tabindex="-1"></a>}</span></code></pre></div>
<p>our return data should include recall values for each plot and variable window function that resulted in trees extracted (some window functions might not have extracted any trees) with image annotated crown evaluation data…unless the <code>NeonTreeEvaluation::evaluate_field_stems()</code> resulted in an error</p>
<p>count of the plots which resulted in trees extracted and were successfully evaluated using field collected stems ground truth data</p>
<div class="sourceCode" id="cb284"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb284-1"><a href="validate-tree-detection-and-crown-delineation.html#cb284-1" tabindex="-1"></a>evaluation_submission <span class="sc">%&gt;%</span> </span>
<span id="cb284-2"><a href="validate-tree-detection-and-crown-delineation.html#cb284-2" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb284-3"><a href="validate-tree-detection-and-crown-delineation.html#cb284-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb284-4"><a href="validate-tree-detection-and-crown-delineation.html#cb284-4" tabindex="-1"></a>    lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb284-5"><a href="validate-tree-detection-and-crown-delineation.html#cb284-5" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb284-6"><a href="validate-tree-detection-and-crown-delineation.html#cb284-6" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(has_field_stems) <span class="sc">%&gt;%</span> </span>
<span id="cb284-7"><a href="validate-tree-detection-and-crown-delineation.html#cb284-7" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">distinct</span>(siteID,plot_name)</span>
<span id="cb284-8"><a href="validate-tree-detection-and-crown-delineation.html#cb284-8" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;plot_name&quot;</span></span>
<span id="cb284-9"><a href="validate-tree-detection-and-crown-delineation.html#cb284-9" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb284-10"><a href="validate-tree-detection-and-crown-delineation.html#cb284-10" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(siteID,plot_name) <span class="sc">%&gt;%</span> </span>
<span id="cb284-11"><a href="validate-tree-detection-and-crown-delineation.html#cb284-11" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb284-12"><a href="validate-tree-detection-and-crown-delineation.html#cb284-12" tabindex="-1"></a>    evaluation_fld_cllctd_stems <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>siteID)</span>
<span id="cb284-13"><a href="validate-tree-detection-and-crown-delineation.html#cb284-13" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;plot_name&quot;</span></span>
<span id="cb284-14"><a href="validate-tree-detection-and-crown-delineation.html#cb284-14" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb284-15"><a href="validate-tree-detection-and-crown-delineation.html#cb284-15" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(siteID) <span class="sc">%&gt;%</span> </span>
<span id="cb284-16"><a href="validate-tree-detection-and-crown-delineation.html#cb284-16" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">plots =</span> dplyr<span class="sc">::</span><span class="fu">n</span>(), <span class="at">plots_eval =</span> <span class="fu">sum</span>(<span class="fu">ifelse</span>(<span class="fu">is.na</span>(recall),<span class="dv">0</span>,<span class="dv">1</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb284-17"><a href="validate-tree-detection-and-crown-delineation.html#cb284-17" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb284-18"><a href="validate-tree-detection-and-crown-delineation.html#cb284-18" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pct =</span> scales<span class="sc">::</span><span class="fu">percent</span>(plots_eval<span class="sc">/</span>plots,<span class="at">accuracy =</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb284-19"><a href="validate-tree-detection-and-crown-delineation.html#cb284-19" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(siteID) <span class="sc">%&gt;%</span> </span>
<span id="cb284-20"><a href="validate-tree-detection-and-crown-delineation.html#cb284-20" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(</span>
<span id="cb284-21"><a href="validate-tree-detection-and-crown-delineation.html#cb284-21" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">&quot;Count of plots with trees detected that were successfully evaluated using field collected stems&quot;</span></span>
<span id="cb284-22"><a href="validate-tree-detection-and-crown-delineation.html#cb284-22" tabindex="-1"></a>    , <span class="at">digits =</span> <span class="dv">0</span></span>
<span id="cb284-23"><a href="validate-tree-detection-and-crown-delineation.html#cb284-23" tabindex="-1"></a>    , <span class="at">col.names =</span> <span class="fu">c</span>(</span>
<span id="cb284-24"><a href="validate-tree-detection-and-crown-delineation.html#cb284-24" tabindex="-1"></a>      <span class="st">&quot;site&quot;</span>,<span class="st">&quot;# plots&lt;br&gt;with trees&quot;</span>,<span class="st">&quot;# plots&lt;br&gt;successfully evaluated&quot;</span></span>
<span id="cb284-25"><a href="validate-tree-detection-and-crown-delineation.html#cb284-25" tabindex="-1"></a>      ,<span class="st">&quot;% plots&lt;br&gt;successfully evaluated&quot;</span></span>
<span id="cb284-26"><a href="validate-tree-detection-and-crown-delineation.html#cb284-26" tabindex="-1"></a>    )</span>
<span id="cb284-27"><a href="validate-tree-detection-and-crown-delineation.html#cb284-27" tabindex="-1"></a>    , <span class="at">escape =</span> F</span>
<span id="cb284-28"><a href="validate-tree-detection-and-crown-delineation.html#cb284-28" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb284-29"><a href="validate-tree-detection-and-crown-delineation.html#cb284-29" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>()</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-263">Table 4.13: </span>Count of plots with trees detected that were successfully evaluated using field collected stems
</caption>
<thead>
<tr>
<th style="text-align:left;">
site
</th>
<th style="text-align:right;">
# plots<br>with trees
</th>
<th style="text-align:right;">
# plots<br>successfully evaluated
</th>
<th style="text-align:left;">
% plots<br>successfully evaluated
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
ABBY
</td>
<td style="text-align:right;">
11
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:left;">
91%
</td>
</tr>
<tr>
<td style="text-align:left;">
DEJU
</td>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
11
</td>
<td style="text-align:left;">
92%
</td>
</tr>
<tr>
<td style="text-align:left;">
JERC
</td>
<td style="text-align:right;">
19
</td>
<td style="text-align:right;">
19
</td>
<td style="text-align:left;">
100%
</td>
</tr>
<tr>
<td style="text-align:left;">
MOAB
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:left;">
100%
</td>
</tr>
<tr>
<td style="text-align:left;">
NIWO
</td>
<td style="text-align:right;">
38
</td>
<td style="text-align:right;">
38
</td>
<td style="text-align:left;">
100%
</td>
</tr>
<tr>
<td style="text-align:left;">
OSBS
</td>
<td style="text-align:right;">
44
</td>
<td style="text-align:right;">
44
</td>
<td style="text-align:left;">
100%
</td>
</tr>
<tr>
<td style="text-align:left;">
TALL
</td>
<td style="text-align:right;">
20
</td>
<td style="text-align:right;">
18
</td>
<td style="text-align:left;">
90%
</td>
</tr>
</tbody>
</table>
<p>we’ll dig into these metrics in the <a href="validate-tree-detection-and-crown-delineation.html#valid_sum">next section</a>; for now, let’s review some figures comparing the field collected stem point locations versus our delineated crown polygons</p>
<p><em>in the RGB plots: “red” outlines are crowns from our point cloud-based method extracted while “blue” points are the field collected stems not detected and “yellow” points are the field collected stems properly identified</em></p>
<div class="sourceCode" id="cb285"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb285-1"><a href="validate-tree-detection-and-crown-delineation.html#cb285-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">88</span>)</span>
<span id="cb285-2"><a href="validate-tree-detection-and-crown-delineation.html#cb285-2" tabindex="-1"></a>evaluation_fld_cllctd_stems <span class="sc">%&gt;%</span> </span>
<span id="cb285-3"><a href="validate-tree-detection-and-crown-delineation.html#cb285-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb285-4"><a href="validate-tree-detection-and-crown-delineation.html#cb285-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice_sample</span>(<span class="at">n=</span><span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb285-5"><a href="validate-tree-detection-and-crown-delineation.html#cb285-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(plot_name) <span class="sc">%&gt;%</span> </span>
<span id="cb285-6"><a href="validate-tree-detection-and-crown-delineation.html#cb285-6" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(\(x) NeonTreeEvaluation<span class="sc">::</span><span class="fu">evaluate_field_stems</span>(</span>
<span id="cb285-7"><a href="validate-tree-detection-and-crown-delineation.html#cb285-7" tabindex="-1"></a>    <span class="at">predictions =</span> evaluation_submission <span class="sc">%&gt;%</span> </span>
<span id="cb285-8"><a href="validate-tree-detection-and-crown-delineation.html#cb285-8" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb285-9"><a href="validate-tree-detection-and-crown-delineation.html#cb285-9" tabindex="-1"></a>        lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb285-10"><a href="validate-tree-detection-and-crown-delineation.html#cb285-10" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb285-11"><a href="validate-tree-detection-and-crown-delineation.html#cb285-11" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">filter</span>(has_field_stems) <span class="sc">%&gt;%</span> </span>
<span id="cb285-12"><a href="validate-tree-detection-and-crown-delineation.html#cb285-12" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">distinct</span>(plot_name)</span>
<span id="cb285-13"><a href="validate-tree-detection-and-crown-delineation.html#cb285-13" tabindex="-1"></a>        , <span class="at">by =</span> <span class="st">&quot;plot_name&quot;</span></span>
<span id="cb285-14"><a href="validate-tree-detection-and-crown-delineation.html#cb285-14" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb285-15"><a href="validate-tree-detection-and-crown-delineation.html#cb285-15" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(plot_name<span class="sc">==</span>x)</span>
<span id="cb285-16"><a href="validate-tree-detection-and-crown-delineation.html#cb285-16" tabindex="-1"></a>    , <span class="at">show =</span> T</span>
<span id="cb285-17"><a href="validate-tree-detection-and-crown-delineation.html#cb285-17" tabindex="-1"></a>  ))</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-265-1.png" width="1008" /><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-265-2.png" width="1008" /><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-265-3.png" width="1008" /></p>
<p><em>in the RGB plots: “red” outlines are crowns from our point cloud-based method extracted while “blue” points are the field collected stems not detected and “yellow” points are the field collected stems properly identified</em></p>
</div>
</div>
</div>
<div id="valid_sum" class="section level3 hasAnchor" number="4.2.6">
<h3><span class="header-section-number">4.2.6</span> Summary of validation against ground truth<a href="validate-tree-detection-and-crown-delineation.html#valid_sum" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Let’s take a deep dive into the evaluation of our aerial point cloud-based tree detection methodology based on comparison to the Weinstein et al. (<a href="https://scholar.google.com/scholar?cluster=4986448711981898434&amp;hl=en&amp;as_sdt=0,6">2021</a>) benchmark data</p>
<div id="overall" class="section level4 hasAnchor" number="4.2.6.1">
<h4><span class="header-section-number">4.2.6.1</span> Overall<a href="validate-tree-detection-and-crown-delineation.html#overall" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>let’s look at the distribution of scores by pooling all plots across NEON sites</p>
<div id="image-annotated-crowns" class="section level5 hasAnchor" number="4.2.6.1.1">
<h5><span class="header-section-number">4.2.6.1.1</span> Image-annotated crowns<a href="validate-tree-detection-and-crown-delineation.html#image-annotated-crowns" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>distribution of plot-level scores</p>
<div class="sourceCode" id="cb286"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb286-1"><a href="validate-tree-detection-and-crown-delineation.html#cb286-1" tabindex="-1"></a>evaluation_img_annttd_crwns <span class="sc">%&gt;%</span> </span>
<span id="cb286-2"><a href="validate-tree-detection-and-crown-delineation.html#cb286-2" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(precision,recall,f_score)) <span class="sc">%&gt;%</span> </span>
<span id="cb286-3"><a href="validate-tree-detection-and-crown-delineation.html#cb286-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb286-4"><a href="validate-tree-detection-and-crown-delineation.html#cb286-4" tabindex="-1"></a>    <span class="at">name =</span> <span class="fu">ifelse</span>(name<span class="sc">==</span><span class="st">&quot;f_score&quot;</span>,<span class="st">&quot;F-score&quot;</span>,name) <span class="sc">%&gt;%</span> forcats<span class="sc">::</span><span class="fu">fct_rev</span>()</span>
<span id="cb286-5"><a href="validate-tree-detection-and-crown-delineation.html#cb286-5" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb286-6"><a href="validate-tree-detection-and-crown-delineation.html#cb286-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span> </span>
<span id="cb286-7"><a href="validate-tree-detection-and-crown-delineation.html#cb286-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">med_val =</span> <span class="fu">median</span>(value,<span class="at">na.rm=</span>T)) <span class="sc">%&gt;%</span> </span>
<span id="cb286-8"><a href="validate-tree-detection-and-crown-delineation.html#cb286-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb286-9"><a href="validate-tree-detection-and-crown-delineation.html#cb286-9" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">color =</span> name, <span class="at">fill =</span> name)) <span class="sc">+</span></span>
<span id="cb286-10"><a href="validate-tree-detection-and-crown-delineation.html#cb286-10" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">lwd =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb286-11"><a href="validate-tree-detection-and-crown-delineation.html#cb286-11" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> med_val), <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span></span>
<span id="cb286-12"><a href="validate-tree-detection-and-crown-delineation.html#cb286-12" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_rug</span>() <span class="sc">+</span></span>
<span id="cb286-13"><a href="validate-tree-detection-and-crown-delineation.html#cb286-13" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="at">facets =</span> <span class="fu">vars</span>(name), <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>) <span class="sc">+</span></span>
<span id="cb286-14"><a href="validate-tree-detection-and-crown-delineation.html#cb286-14" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="dv">6</span>)) <span class="sc">+</span></span>
<span id="cb286-15"><a href="validate-tree-detection-and-crown-delineation.html#cb286-15" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_viridis_d</span>(<span class="at">begin=</span><span class="fl">0.3</span>,<span class="at">end=</span><span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb286-16"><a href="validate-tree-detection-and-crown-delineation.html#cb286-16" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_fill_viridis_d</span>(<span class="at">begin=</span><span class="fl">0.3</span>,<span class="at">end=</span><span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb286-17"><a href="validate-tree-detection-and-crown-delineation.html#cb286-17" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb286-18"><a href="validate-tree-detection-and-crown-delineation.html#cb286-18" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb286-19"><a href="validate-tree-detection-and-crown-delineation.html#cb286-19" tabindex="-1"></a>      , <span class="at">subtitle =</span> <span class="st">&quot;Overall validation against image annotated crowns ground truth&quot;</span></span>
<span id="cb286-20"><a href="validate-tree-detection-and-crown-delineation.html#cb286-20" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb286-21"><a href="validate-tree-detection-and-crown-delineation.html#cb286-21" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb286-22"><a href="validate-tree-detection-and-crown-delineation.html#cb286-22" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb286-23"><a href="validate-tree-detection-and-crown-delineation.html#cb286-23" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb286-24"><a href="validate-tree-detection-and-crown-delineation.html#cb286-24" tabindex="-1"></a>      , <span class="at">axis.text.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">7</span>)</span>
<span id="cb286-25"><a href="validate-tree-detection-and-crown-delineation.html#cb286-25" tabindex="-1"></a>      , <span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb286-26"><a href="validate-tree-detection-and-crown-delineation.html#cb286-26" tabindex="-1"></a>      , <span class="at">axis.ticks.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb286-27"><a href="validate-tree-detection-and-crown-delineation.html#cb286-27" tabindex="-1"></a>      , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb286-28"><a href="validate-tree-detection-and-crown-delineation.html#cb286-28" tabindex="-1"></a>    )</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-267-1.png" width="1008" /></p>
<p>summary statistics</p>
<div class="sourceCode" id="cb287"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb287-1"><a href="validate-tree-detection-and-crown-delineation.html#cb287-1" tabindex="-1"></a>evaluation_img_annttd_crwns <span class="sc">%&gt;%</span> </span>
<span id="cb287-2"><a href="validate-tree-detection-and-crown-delineation.html#cb287-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb287-3"><a href="validate-tree-detection-and-crown-delineation.html#cb287-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">fscore=</span>f_score) <span class="sc">%&gt;%</span> </span>
<span id="cb287-4"><a href="validate-tree-detection-and-crown-delineation.html#cb287-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb287-5"><a href="validate-tree-detection-and-crown-delineation.html#cb287-5" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">across</span>(</span>
<span id="cb287-6"><a href="validate-tree-detection-and-crown-delineation.html#cb287-6" tabindex="-1"></a>      <span class="fu">c</span>(precision,recall,fscore)</span>
<span id="cb287-7"><a href="validate-tree-detection-and-crown-delineation.html#cb287-7" tabindex="-1"></a>      , <span class="at">.fns =</span> <span class="fu">list</span>(<span class="at">mean =</span> mean, <span class="at">median =</span> median, <span class="at">sd =</span> sd, <span class="at">min =</span> min, <span class="at">max =</span> max)</span>
<span id="cb287-8"><a href="validate-tree-detection-and-crown-delineation.html#cb287-8" tabindex="-1"></a>    )</span>
<span id="cb287-9"><a href="validate-tree-detection-and-crown-delineation.html#cb287-9" tabindex="-1"></a>    , <span class="at">n =</span> dplyr<span class="sc">::</span><span class="fu">n</span>()</span>
<span id="cb287-10"><a href="validate-tree-detection-and-crown-delineation.html#cb287-10" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb287-11"><a href="validate-tree-detection-and-crown-delineation.html#cb287-11" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span><span class="fu">c</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb287-12"><a href="validate-tree-detection-and-crown-delineation.html#cb287-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb287-13"><a href="validate-tree-detection-and-crown-delineation.html#cb287-13" tabindex="-1"></a>    <span class="at">agg =</span> stringr<span class="sc">::</span><span class="fu">word</span>(name,<span class="sc">-</span><span class="dv">1</span>,<span class="at">sep =</span> <span class="st">&quot;_&quot;</span>)</span>
<span id="cb287-14"><a href="validate-tree-detection-and-crown-delineation.html#cb287-14" tabindex="-1"></a>    , <span class="at">metric =</span> stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(name, <span class="fu">paste0</span>(<span class="st">&quot;_&quot;</span>,agg))</span>
<span id="cb287-15"><a href="validate-tree-detection-and-crown-delineation.html#cb287-15" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb287-16"><a href="validate-tree-detection-and-crown-delineation.html#cb287-16" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>name) <span class="sc">%&gt;%</span> </span>
<span id="cb287-17"><a href="validate-tree-detection-and-crown-delineation.html#cb287-17" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb287-18"><a href="validate-tree-detection-and-crown-delineation.html#cb287-18" tabindex="-1"></a>    <span class="at">value =</span> scales<span class="sc">::</span><span class="fu">comma</span>(value,<span class="at">accuracy=</span><span class="fl">0.01</span>)</span>
<span id="cb287-19"><a href="validate-tree-detection-and-crown-delineation.html#cb287-19" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb287-20"><a href="validate-tree-detection-and-crown-delineation.html#cb287-20" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(<span class="at">names_from =</span> agg, <span class="at">values_from =</span> value) <span class="sc">%&gt;%</span> </span>
<span id="cb287-21"><a href="validate-tree-detection-and-crown-delineation.html#cb287-21" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb287-22"><a href="validate-tree-detection-and-crown-delineation.html#cb287-22" tabindex="-1"></a>    <span class="at">unit_lab =</span> <span class="fu">paste0</span>(</span>
<span id="cb287-23"><a href="validate-tree-detection-and-crown-delineation.html#cb287-23" tabindex="-1"></a>      <span class="st">&quot;Overall&lt;br&gt;(&quot;</span></span>
<span id="cb287-24"><a href="validate-tree-detection-and-crown-delineation.html#cb287-24" tabindex="-1"></a>      , scales<span class="sc">::</span><span class="fu">comma</span>(n,<span class="at">accuracy=</span><span class="dv">1</span>)</span>
<span id="cb287-25"><a href="validate-tree-detection-and-crown-delineation.html#cb287-25" tabindex="-1"></a>      ,<span class="st">&quot; plots)&quot;</span></span>
<span id="cb287-26"><a href="validate-tree-detection-and-crown-delineation.html#cb287-26" tabindex="-1"></a>    )</span>
<span id="cb287-27"><a href="validate-tree-detection-and-crown-delineation.html#cb287-27" tabindex="-1"></a>    , <span class="at">range =</span> <span class="fu">paste0</span>(min, <span class="st">&quot;—&quot;</span>, max)</span>
<span id="cb287-28"><a href="validate-tree-detection-and-crown-delineation.html#cb287-28" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb287-29"><a href="validate-tree-detection-and-crown-delineation.html#cb287-29" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(unit_lab) <span class="sc">%&gt;%</span> </span>
<span id="cb287-30"><a href="validate-tree-detection-and-crown-delineation.html#cb287-30" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb287-31"><a href="validate-tree-detection-and-crown-delineation.html#cb287-31" tabindex="-1"></a>    <span class="at">metric =</span> <span class="fu">factor</span>(</span>
<span id="cb287-32"><a href="validate-tree-detection-and-crown-delineation.html#cb287-32" tabindex="-1"></a>      metric</span>
<span id="cb287-33"><a href="validate-tree-detection-and-crown-delineation.html#cb287-33" tabindex="-1"></a>      , <span class="at">ordered =</span> T</span>
<span id="cb287-34"><a href="validate-tree-detection-and-crown-delineation.html#cb287-34" tabindex="-1"></a>      , <span class="at">levels =</span> <span class="fu">c</span>(</span>
<span id="cb287-35"><a href="validate-tree-detection-and-crown-delineation.html#cb287-35" tabindex="-1"></a>          <span class="st">&quot;recall&quot;</span></span>
<span id="cb287-36"><a href="validate-tree-detection-and-crown-delineation.html#cb287-36" tabindex="-1"></a>          , <span class="st">&quot;precision&quot;</span></span>
<span id="cb287-37"><a href="validate-tree-detection-and-crown-delineation.html#cb287-37" tabindex="-1"></a>          , <span class="st">&quot;fscore&quot;</span></span>
<span id="cb287-38"><a href="validate-tree-detection-and-crown-delineation.html#cb287-38" tabindex="-1"></a>        )</span>
<span id="cb287-39"><a href="validate-tree-detection-and-crown-delineation.html#cb287-39" tabindex="-1"></a>      , <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb287-40"><a href="validate-tree-detection-and-crown-delineation.html#cb287-40" tabindex="-1"></a>          <span class="st">&quot;recall&quot;</span></span>
<span id="cb287-41"><a href="validate-tree-detection-and-crown-delineation.html#cb287-41" tabindex="-1"></a>          , <span class="st">&quot;precision&quot;</span></span>
<span id="cb287-42"><a href="validate-tree-detection-and-crown-delineation.html#cb287-42" tabindex="-1"></a>          , <span class="st">&quot;F-score&quot;</span></span>
<span id="cb287-43"><a href="validate-tree-detection-and-crown-delineation.html#cb287-43" tabindex="-1"></a>        )</span>
<span id="cb287-44"><a href="validate-tree-detection-and-crown-delineation.html#cb287-44" tabindex="-1"></a>    )</span>
<span id="cb287-45"><a href="validate-tree-detection-and-crown-delineation.html#cb287-45" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb287-46"><a href="validate-tree-detection-and-crown-delineation.html#cb287-46" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(n,min,max)) <span class="sc">%&gt;%</span> </span>
<span id="cb287-47"><a href="validate-tree-detection-and-crown-delineation.html#cb287-47" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(unit_lab,metric) <span class="sc">%&gt;%</span> </span>
<span id="cb287-48"><a href="validate-tree-detection-and-crown-delineation.html#cb287-48" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(</span>
<span id="cb287-49"><a href="validate-tree-detection-and-crown-delineation.html#cb287-49" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">&quot;Overall validation against image annotated crowns ground truth&quot;</span></span>
<span id="cb287-50"><a href="validate-tree-detection-and-crown-delineation.html#cb287-50" tabindex="-1"></a>    , <span class="at">col.names =</span> <span class="fu">c</span>(</span>
<span id="cb287-51"><a href="validate-tree-detection-and-crown-delineation.html#cb287-51" tabindex="-1"></a>      <span class="st">&quot;Score level&quot;</span>, <span class="st">&quot;Metric&quot;</span></span>
<span id="cb287-52"><a href="validate-tree-detection-and-crown-delineation.html#cb287-52" tabindex="-1"></a>      , <span class="st">&quot;Mean&quot;</span>, <span class="st">&quot;Median&quot;</span></span>
<span id="cb287-53"><a href="validate-tree-detection-and-crown-delineation.html#cb287-53" tabindex="-1"></a>      , <span class="st">&quot;Std Dev&quot;</span>, <span class="st">&quot;Range&quot;</span></span>
<span id="cb287-54"><a href="validate-tree-detection-and-crown-delineation.html#cb287-54" tabindex="-1"></a>    )</span>
<span id="cb287-55"><a href="validate-tree-detection-and-crown-delineation.html#cb287-55" tabindex="-1"></a>    , <span class="at">escape =</span> F</span>
<span id="cb287-56"><a href="validate-tree-detection-and-crown-delineation.html#cb287-56" tabindex="-1"></a>    <span class="co"># , digits = 2</span></span>
<span id="cb287-57"><a href="validate-tree-detection-and-crown-delineation.html#cb287-57" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb287-58"><a href="validate-tree-detection-and-crown-delineation.html#cb287-58" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>(<span class="at">font_size =</span> <span class="dv">13</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb287-59"><a href="validate-tree-detection-and-crown-delineation.html#cb287-59" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">collapse_rows</span>(<span class="at">columns =</span> <span class="dv">1</span>, <span class="at">valign =</span> <span class="st">&quot;top&quot;</span>)</span></code></pre></div>
<table class="table" style="font-size: 13px; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">
<span id="tab:unnamed-chunk-268">Table 4.14: </span>Overall validation against image annotated crowns ground truth
</caption>
<thead>
<tr>
<th style="text-align:left;">
Score level
</th>
<th style="text-align:left;">
Metric
</th>
<th style="text-align:left;">
Mean
</th>
<th style="text-align:left;">
Median
</th>
<th style="text-align:left;">
Std Dev
</th>
<th style="text-align:left;">
Range
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="3">
Overall<br>(92 plots)
</td>
<td style="text-align:left;">
recall
</td>
<td style="text-align:left;">
0.43
</td>
<td style="text-align:left;">
0.34
</td>
<td style="text-align:left;">
0.26
</td>
<td style="text-align:left;">
0.00—1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
precision
</td>
<td style="text-align:left;">
0.30
</td>
<td style="text-align:left;">
0.28
</td>
<td style="text-align:left;">
0.16
</td>
<td style="text-align:left;">
0.00—1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
F-score
</td>
<td style="text-align:left;">
0.33
</td>
<td style="text-align:left;">
0.31
</td>
<td style="text-align:left;">
0.18
</td>
<td style="text-align:left;">
0.00—1.00
</td>
</tr>
</tbody>
</table>
<div id="comparison-with-other-methods" class="section level6 hasAnchor" number="4.2.6.1.1.1">
<h6><span class="header-section-number">4.2.6.1.1.1</span> Comparison with other methods<a href="validate-tree-detection-and-crown-delineation.html#comparison-with-other-methods" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<p>There are overall scores from other methods in the benchmark</p>
<table>
<colgroup>
<col width="27%" />
<col width="13%" />
<col width="9%" />
<col width="50%" />
</colgroup>
<thead>
<tr class="header">
<th>Author</th>
<th>Precision</th>
<th>Recall</th>
<th>Cite/Code</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Weinstein et al. 2020</td>
<td>0.66</td>
<td>0.79</td>
<td><a href="https://deepforest.readthedocs.io/" class="uri">https://deepforest.readthedocs.io/</a></td>
</tr>
<tr class="even">
<td>Silva et al. 2016</td>
<td>0.34</td>
<td>0.47</td>
<td><a href="https://rdrr.io/cran/lidR/man/its_silva2016.html"><code>lidR::silva2016()</code></a></td>
</tr>
<tr class="odd">
<td><code>cloud2trees</code> (present study)</td>
<td>0.30</td>
<td>0.43</td>
<td><a href="https://github.com/georgewoolsey/cloud2trees">cloud2trees package</a></td>
</tr>
</tbody>
</table>
<p>Our scores are in-line with the scores obtained by <a href="https://rdrr.io/cran/lidR/man/its_silva2016.html"><code>lidR::silva2016()</code></a> but it is unclear which plots and NEON sites were evaluated with this methodology</p>
<p>Weinstein et al. (<a href="https://scholar.google.com/scholar?cluster=4986448711981898434&amp;hl=en&amp;as_sdt=0,6">2021</a>) describe the DeepForest model:</p>
<blockquote>
<p>DeepForest is a RGB deep learning model that predicts canopy crown bounding boxes. The prebuilt model in DeepForest was trained with the training data described above, but did not use or overlap spatially with any evaluation data in this benchmark. Following the best practices for computational biology benchmarking described in, we emphasize that the DeepForest algorithm was designed in conjunction with these evaluation data and it is therefore not surprising that it performs well, with image-annotated boxes and field-annotated crown polygons both at approximately 70% accuracy. (p. 14)</p>
</blockquote>
</div>
</div>
<div id="field-collected-stems" class="section level5 hasAnchor" number="4.2.6.1.2">
<h5><span class="header-section-number">4.2.6.1.2</span> Field-collected stems<a href="validate-tree-detection-and-crown-delineation.html#field-collected-stems" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>distribution of plot-level scores</p>
<div class="sourceCode" id="cb288"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb288-1"><a href="validate-tree-detection-and-crown-delineation.html#cb288-1" tabindex="-1"></a>evaluation_fld_cllctd_stems <span class="sc">%&gt;%</span> </span>
<span id="cb288-2"><a href="validate-tree-detection-and-crown-delineation.html#cb288-2" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(recall,n)) <span class="sc">%&gt;%</span> </span>
<span id="cb288-3"><a href="validate-tree-detection-and-crown-delineation.html#cb288-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(name<span class="sc">!=</span><span class="st">&quot;n&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb288-4"><a href="validate-tree-detection-and-crown-delineation.html#cb288-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb288-5"><a href="validate-tree-detection-and-crown-delineation.html#cb288-5" tabindex="-1"></a>    <span class="at">name =</span> <span class="fu">ifelse</span>(name<span class="sc">==</span><span class="st">&quot;n&quot;</span>,<span class="st">&quot;# actual trees&quot;</span>,name) <span class="sc">%&gt;%</span> forcats<span class="sc">::</span><span class="fu">fct_rev</span>()</span>
<span id="cb288-6"><a href="validate-tree-detection-and-crown-delineation.html#cb288-6" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb288-7"><a href="validate-tree-detection-and-crown-delineation.html#cb288-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span> </span>
<span id="cb288-8"><a href="validate-tree-detection-and-crown-delineation.html#cb288-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">med_val =</span> <span class="fu">median</span>(value,<span class="at">na.rm=</span>T)) <span class="sc">%&gt;%</span> </span>
<span id="cb288-9"><a href="validate-tree-detection-and-crown-delineation.html#cb288-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb288-10"><a href="validate-tree-detection-and-crown-delineation.html#cb288-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">color =</span> name, <span class="at">fill =</span> name)) <span class="sc">+</span></span>
<span id="cb288-11"><a href="validate-tree-detection-and-crown-delineation.html#cb288-11" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">lwd =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb288-12"><a href="validate-tree-detection-and-crown-delineation.html#cb288-12" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> med_val), <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span></span>
<span id="cb288-13"><a href="validate-tree-detection-and-crown-delineation.html#cb288-13" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_rug</span>() <span class="sc">+</span></span>
<span id="cb288-14"><a href="validate-tree-detection-and-crown-delineation.html#cb288-14" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_wrap</span>(<span class="at">facets =</span> <span class="fu">vars</span>(name), <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>) <span class="sc">+</span></span>
<span id="cb288-15"><a href="validate-tree-detection-and-crown-delineation.html#cb288-15" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="dv">6</span>)) <span class="sc">+</span></span>
<span id="cb288-16"><a href="validate-tree-detection-and-crown-delineation.html#cb288-16" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(viridis<span class="sc">::</span><span class="fu">viridis</span>(<span class="at">n=</span><span class="dv">3</span>,<span class="at">begin=</span><span class="fl">0.3</span>,<span class="at">end=</span><span class="fl">0.7</span>)[<span class="dv">1</span>],<span class="st">&quot;gray&quot;</span>)) <span class="sc">+</span></span>
<span id="cb288-17"><a href="validate-tree-detection-and-crown-delineation.html#cb288-17" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values=</span><span class="fu">c</span>(viridis<span class="sc">::</span><span class="fu">viridis</span>(<span class="at">n=</span><span class="dv">3</span>,<span class="at">begin=</span><span class="fl">0.3</span>,<span class="at">end=</span><span class="fl">0.7</span>)[<span class="dv">1</span>],<span class="st">&quot;gray&quot;</span>)) <span class="sc">+</span></span>
<span id="cb288-18"><a href="validate-tree-detection-and-crown-delineation.html#cb288-18" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb288-19"><a href="validate-tree-detection-and-crown-delineation.html#cb288-19" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb288-20"><a href="validate-tree-detection-and-crown-delineation.html#cb288-20" tabindex="-1"></a>      , <span class="at">subtitle =</span> <span class="st">&quot;Overall validation against field-collected stems ground truth&quot;</span></span>
<span id="cb288-21"><a href="validate-tree-detection-and-crown-delineation.html#cb288-21" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb288-22"><a href="validate-tree-detection-and-crown-delineation.html#cb288-22" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb288-23"><a href="validate-tree-detection-and-crown-delineation.html#cb288-23" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb288-24"><a href="validate-tree-detection-and-crown-delineation.html#cb288-24" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb288-25"><a href="validate-tree-detection-and-crown-delineation.html#cb288-25" tabindex="-1"></a>      , <span class="at">axis.text.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">7</span>)</span>
<span id="cb288-26"><a href="validate-tree-detection-and-crown-delineation.html#cb288-26" tabindex="-1"></a>      , <span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb288-27"><a href="validate-tree-detection-and-crown-delineation.html#cb288-27" tabindex="-1"></a>      , <span class="at">axis.ticks.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>()</span>
<span id="cb288-28"><a href="validate-tree-detection-and-crown-delineation.html#cb288-28" tabindex="-1"></a>      , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb288-29"><a href="validate-tree-detection-and-crown-delineation.html#cb288-29" tabindex="-1"></a>    )</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-269-1.png" width="1008" /></p>
<p>summary statistics</p>
<div class="sourceCode" id="cb289"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb289-1"><a href="validate-tree-detection-and-crown-delineation.html#cb289-1" tabindex="-1"></a>evaluation_fld_cllctd_stems <span class="sc">%&gt;%</span> </span>
<span id="cb289-2"><a href="validate-tree-detection-and-crown-delineation.html#cb289-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb289-3"><a href="validate-tree-detection-and-crown-delineation.html#cb289-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb289-4"><a href="validate-tree-detection-and-crown-delineation.html#cb289-4" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">across</span>(</span>
<span id="cb289-5"><a href="validate-tree-detection-and-crown-delineation.html#cb289-5" tabindex="-1"></a>      <span class="fu">c</span>(recall)</span>
<span id="cb289-6"><a href="validate-tree-detection-and-crown-delineation.html#cb289-6" tabindex="-1"></a>      , <span class="at">.fns =</span> <span class="fu">list</span>(<span class="at">mean =</span> mean, <span class="at">median =</span> median, <span class="at">sd =</span> sd, <span class="at">min =</span> min, <span class="at">max =</span> max)</span>
<span id="cb289-7"><a href="validate-tree-detection-and-crown-delineation.html#cb289-7" tabindex="-1"></a>    )</span>
<span id="cb289-8"><a href="validate-tree-detection-and-crown-delineation.html#cb289-8" tabindex="-1"></a>    , <span class="at">n =</span> dplyr<span class="sc">::</span><span class="fu">n</span>()</span>
<span id="cb289-9"><a href="validate-tree-detection-and-crown-delineation.html#cb289-9" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb289-10"><a href="validate-tree-detection-and-crown-delineation.html#cb289-10" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span><span class="fu">c</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb289-11"><a href="validate-tree-detection-and-crown-delineation.html#cb289-11" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb289-12"><a href="validate-tree-detection-and-crown-delineation.html#cb289-12" tabindex="-1"></a>    <span class="at">agg =</span> stringr<span class="sc">::</span><span class="fu">word</span>(name,<span class="sc">-</span><span class="dv">1</span>,<span class="at">sep =</span> <span class="st">&quot;_&quot;</span>)</span>
<span id="cb289-13"><a href="validate-tree-detection-and-crown-delineation.html#cb289-13" tabindex="-1"></a>    , <span class="at">metric =</span> stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(name, <span class="fu">paste0</span>(<span class="st">&quot;_&quot;</span>,agg))</span>
<span id="cb289-14"><a href="validate-tree-detection-and-crown-delineation.html#cb289-14" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb289-15"><a href="validate-tree-detection-and-crown-delineation.html#cb289-15" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>name) <span class="sc">%&gt;%</span> </span>
<span id="cb289-16"><a href="validate-tree-detection-and-crown-delineation.html#cb289-16" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb289-17"><a href="validate-tree-detection-and-crown-delineation.html#cb289-17" tabindex="-1"></a>    <span class="at">value =</span> scales<span class="sc">::</span><span class="fu">comma</span>(value,<span class="at">accuracy=</span><span class="fl">0.01</span>)</span>
<span id="cb289-18"><a href="validate-tree-detection-and-crown-delineation.html#cb289-18" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb289-19"><a href="validate-tree-detection-and-crown-delineation.html#cb289-19" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(<span class="at">names_from =</span> agg, <span class="at">values_from =</span> value) <span class="sc">%&gt;%</span> </span>
<span id="cb289-20"><a href="validate-tree-detection-and-crown-delineation.html#cb289-20" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb289-21"><a href="validate-tree-detection-and-crown-delineation.html#cb289-21" tabindex="-1"></a>    <span class="at">unit_lab =</span> <span class="fu">paste0</span>(</span>
<span id="cb289-22"><a href="validate-tree-detection-and-crown-delineation.html#cb289-22" tabindex="-1"></a>      <span class="st">&quot;Overall&lt;br&gt;(&quot;</span></span>
<span id="cb289-23"><a href="validate-tree-detection-and-crown-delineation.html#cb289-23" tabindex="-1"></a>      , scales<span class="sc">::</span><span class="fu">comma</span>(n,<span class="at">accuracy=</span><span class="dv">1</span>)</span>
<span id="cb289-24"><a href="validate-tree-detection-and-crown-delineation.html#cb289-24" tabindex="-1"></a>      ,<span class="st">&quot; plots)&quot;</span></span>
<span id="cb289-25"><a href="validate-tree-detection-and-crown-delineation.html#cb289-25" tabindex="-1"></a>    )</span>
<span id="cb289-26"><a href="validate-tree-detection-and-crown-delineation.html#cb289-26" tabindex="-1"></a>    , <span class="at">range =</span> <span class="fu">paste0</span>(min, <span class="st">&quot;—&quot;</span>, max)</span>
<span id="cb289-27"><a href="validate-tree-detection-and-crown-delineation.html#cb289-27" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb289-28"><a href="validate-tree-detection-and-crown-delineation.html#cb289-28" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(unit_lab) <span class="sc">%&gt;%</span> </span>
<span id="cb289-29"><a href="validate-tree-detection-and-crown-delineation.html#cb289-29" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(n,min,max)) <span class="sc">%&gt;%</span> </span>
<span id="cb289-30"><a href="validate-tree-detection-and-crown-delineation.html#cb289-30" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(unit_lab,metric) <span class="sc">%&gt;%</span> </span>
<span id="cb289-31"><a href="validate-tree-detection-and-crown-delineation.html#cb289-31" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(</span>
<span id="cb289-32"><a href="validate-tree-detection-and-crown-delineation.html#cb289-32" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">&quot;Overall validation against field-collected stems ground truth&quot;</span></span>
<span id="cb289-33"><a href="validate-tree-detection-and-crown-delineation.html#cb289-33" tabindex="-1"></a>    , <span class="at">col.names =</span> <span class="fu">c</span>(</span>
<span id="cb289-34"><a href="validate-tree-detection-and-crown-delineation.html#cb289-34" tabindex="-1"></a>      <span class="st">&quot;Score level&quot;</span>, <span class="st">&quot;Metric&quot;</span></span>
<span id="cb289-35"><a href="validate-tree-detection-and-crown-delineation.html#cb289-35" tabindex="-1"></a>      , <span class="st">&quot;Mean&quot;</span>, <span class="st">&quot;Median&quot;</span></span>
<span id="cb289-36"><a href="validate-tree-detection-and-crown-delineation.html#cb289-36" tabindex="-1"></a>      , <span class="st">&quot;Std Dev&quot;</span>, <span class="st">&quot;Range&quot;</span></span>
<span id="cb289-37"><a href="validate-tree-detection-and-crown-delineation.html#cb289-37" tabindex="-1"></a>    )</span>
<span id="cb289-38"><a href="validate-tree-detection-and-crown-delineation.html#cb289-38" tabindex="-1"></a>    , <span class="at">escape =</span> F</span>
<span id="cb289-39"><a href="validate-tree-detection-and-crown-delineation.html#cb289-39" tabindex="-1"></a>    <span class="co"># , digits = 2</span></span>
<span id="cb289-40"><a href="validate-tree-detection-and-crown-delineation.html#cb289-40" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb289-41"><a href="validate-tree-detection-and-crown-delineation.html#cb289-41" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>(<span class="at">font_size =</span> <span class="dv">13</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb289-42"><a href="validate-tree-detection-and-crown-delineation.html#cb289-42" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">collapse_rows</span>(<span class="at">columns =</span> <span class="dv">1</span>, <span class="at">valign =</span> <span class="st">&quot;top&quot;</span>)</span></code></pre></div>
<table class="table" style="font-size: 13px; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">
<span id="tab:unnamed-chunk-270">Table 4.15: </span>Overall validation against field-collected stems ground truth
</caption>
<thead>
<tr>
<th style="text-align:left;">
Score level
</th>
<th style="text-align:left;">
Metric
</th>
<th style="text-align:left;">
Mean
</th>
<th style="text-align:left;">
Median
</th>
<th style="text-align:left;">
Std Dev
</th>
<th style="text-align:left;">
Range
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Overall<br>(142 plots)
</td>
<td style="text-align:left;">
recall
</td>
<td style="text-align:left;">
0.71
</td>
<td style="text-align:left;">
0.71
</td>
<td style="text-align:left;">
0.23
</td>
<td style="text-align:left;">
0.00—1.00
</td>
</tr>
</tbody>
</table>
<div id="comparison-to-other-methods" class="section level6 hasAnchor" number="4.2.6.1.2.1">
<h6><span class="header-section-number">4.2.6.1.2.1</span> Comparison to other methods<a href="validate-tree-detection-and-crown-delineation.html#comparison-to-other-methods" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<p>There are overall scores from other methods in the benchmark</p>
<table>
<colgroup>
<col width="31%" />
<col width="10%" />
<col width="57%" />
</colgroup>
<thead>
<tr class="header">
<th>Author</th>
<th>Recall</th>
<th>Cite/Code</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Weinstein et al. 2020</td>
<td>0.74</td>
<td><a href="https://deepforest.readthedocs.io/" class="uri">https://deepforest.readthedocs.io/</a></td>
</tr>
<tr class="even">
<td><code>cloud2trees</code> (present study)</td>
<td>0.71</td>
<td><a href="https://github.com/georgewoolsey/cloud2trees">cloud2trees package</a></td>
</tr>
</tbody>
</table>
<p>Our scores are in-line with the scores obtained by the DeepForest model which is promising given that “the DeepForest algorithm was designed in conjunction with these evaluation data” presented by Weinstein et al. (<a href="https://scholar.google.com/scholar?cluster=4986448711981898434&amp;hl=en&amp;as_sdt=0,6">2021</a>, p. 14)</p>
</div>
</div>
</div>
<div id="neon-site" class="section level4 hasAnchor" number="4.2.6.2">
<h4><span class="header-section-number">4.2.6.2</span> NEON site<a href="validate-tree-detection-and-crown-delineation.html#neon-site" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>let’s look at the distribution of scores at the NEON site level</p>
<div id="image-annotated-crowns-1" class="section level5 hasAnchor" number="4.2.6.2.1">
<h5><span class="header-section-number">4.2.6.2.1</span> Image-annotated crowns<a href="validate-tree-detection-and-crown-delineation.html#image-annotated-crowns-1" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>distribution of plot-level scores</p>
<div class="sourceCode" id="cb290"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb290-1"><a href="validate-tree-detection-and-crown-delineation.html#cb290-1" tabindex="-1"></a>evaluation_img_annttd_crwns <span class="sc">%&gt;%</span> </span>
<span id="cb290-2"><a href="validate-tree-detection-and-crown-delineation.html#cb290-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(lidar_df <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">distinct</span>(plot_name,siteID),<span class="at">by=</span><span class="st">&quot;plot_name&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb290-3"><a href="validate-tree-detection-and-crown-delineation.html#cb290-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(siteID) <span class="sc">%&gt;%</span> </span>
<span id="cb290-4"><a href="validate-tree-detection-and-crown-delineation.html#cb290-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">siteID =</span> <span class="fu">paste0</span>(siteID, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">(plots=&quot;</span>, scales<span class="sc">::</span><span class="fu">comma</span>(dplyr<span class="sc">::</span><span class="fu">n</span>(),<span class="at">accuracy=</span><span class="dv">1</span>),<span class="st">&quot;)&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb290-5"><a href="validate-tree-detection-and-crown-delineation.html#cb290-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb290-6"><a href="validate-tree-detection-and-crown-delineation.html#cb290-6" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(precision,recall,f_score)) <span class="sc">%&gt;%</span> </span>
<span id="cb290-7"><a href="validate-tree-detection-and-crown-delineation.html#cb290-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb290-8"><a href="validate-tree-detection-and-crown-delineation.html#cb290-8" tabindex="-1"></a>    <span class="at">name =</span> <span class="fu">ifelse</span>(name<span class="sc">==</span><span class="st">&quot;f_score&quot;</span>,<span class="st">&quot;F-score&quot;</span>,name) <span class="sc">%&gt;%</span> forcats<span class="sc">::</span><span class="fu">fct_rev</span>()</span>
<span id="cb290-9"><a href="validate-tree-detection-and-crown-delineation.html#cb290-9" tabindex="-1"></a>    , <span class="at">siteID =</span> forcats<span class="sc">::</span><span class="fu">fct_rev</span>(siteID)</span>
<span id="cb290-10"><a href="validate-tree-detection-and-crown-delineation.html#cb290-10" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb290-11"><a href="validate-tree-detection-and-crown-delineation.html#cb290-11" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">y =</span> siteID, <span class="at">color =</span> name)) <span class="sc">+</span></span>
<span id="cb290-12"><a href="validate-tree-detection-and-crown-delineation.html#cb290-12" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_jitter</span>(<span class="at">height =</span> <span class="fl">0.12</span>, <span class="at">width =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb290-13"><a href="validate-tree-detection-and-crown-delineation.html#cb290-13" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_boxplot</span>(</span>
<span id="cb290-14"><a href="validate-tree-detection-and-crown-delineation.html#cb290-14" tabindex="-1"></a>      <span class="at">width=</span><span class="fl">0.3</span>,<span class="at">staplewidth=</span><span class="fl">0.4</span>,<span class="at">lwd=</span><span class="fl">0.7</span></span>
<span id="cb290-15"><a href="validate-tree-detection-and-crown-delineation.html#cb290-15" tabindex="-1"></a>      ,<span class="at">fill=</span><span class="cn">NA</span>,<span class="at">color =</span> <span class="st">&quot;gray9&quot;</span></span>
<span id="cb290-16"><a href="validate-tree-detection-and-crown-delineation.html#cb290-16" tabindex="-1"></a>      , <span class="at">outliers =</span> F</span>
<span id="cb290-17"><a href="validate-tree-detection-and-crown-delineation.html#cb290-17" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb290-18"><a href="validate-tree-detection-and-crown-delineation.html#cb290-18" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_grid</span>(<span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(name)) <span class="sc">+</span></span>
<span id="cb290-19"><a href="validate-tree-detection-and-crown-delineation.html#cb290-19" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_viridis_d</span>(<span class="at">begin=</span><span class="fl">0.3</span>,<span class="at">end=</span><span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb290-20"><a href="validate-tree-detection-and-crown-delineation.html#cb290-20" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="dv">6</span>)) <span class="sc">+</span></span>
<span id="cb290-21"><a href="validate-tree-detection-and-crown-delineation.html#cb290-21" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb290-22"><a href="validate-tree-detection-and-crown-delineation.html#cb290-22" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span>, <span class="at">color =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb290-23"><a href="validate-tree-detection-and-crown-delineation.html#cb290-23" tabindex="-1"></a>      , <span class="at">subtitle =</span> <span class="st">&quot;NEON site-level validation against image annotated crowns ground truth&quot;</span></span>
<span id="cb290-24"><a href="validate-tree-detection-and-crown-delineation.html#cb290-24" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb290-25"><a href="validate-tree-detection-and-crown-delineation.html#cb290-25" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb290-26"><a href="validate-tree-detection-and-crown-delineation.html#cb290-26" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb290-27"><a href="validate-tree-detection-and-crown-delineation.html#cb290-27" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb290-28"><a href="validate-tree-detection-and-crown-delineation.html#cb290-28" tabindex="-1"></a>      , <span class="at">axis.text.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">7</span>)</span>
<span id="cb290-29"><a href="validate-tree-detection-and-crown-delineation.html#cb290-29" tabindex="-1"></a>      , <span class="at">panel.grid.major.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_line</span>(<span class="at">color=</span><span class="st">&quot;gray22&quot;</span>)</span>
<span id="cb290-30"><a href="validate-tree-detection-and-crown-delineation.html#cb290-30" tabindex="-1"></a>      , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb290-31"><a href="validate-tree-detection-and-crown-delineation.html#cb290-31" tabindex="-1"></a>    )</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-271-1.png" width="1008" /></p>
<p>summary statistics</p>
<div class="sourceCode" id="cb291"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb291-1"><a href="validate-tree-detection-and-crown-delineation.html#cb291-1" tabindex="-1"></a>evaluation_img_annttd_crwns <span class="sc">%&gt;%</span> </span>
<span id="cb291-2"><a href="validate-tree-detection-and-crown-delineation.html#cb291-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(lidar_df <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">distinct</span>(plot_name,siteID),<span class="at">by=</span><span class="st">&quot;plot_name&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb291-3"><a href="validate-tree-detection-and-crown-delineation.html#cb291-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(siteID) <span class="sc">%&gt;%</span> </span>
<span id="cb291-4"><a href="validate-tree-detection-and-crown-delineation.html#cb291-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">fscore=</span>f_score) <span class="sc">%&gt;%</span> </span>
<span id="cb291-5"><a href="validate-tree-detection-and-crown-delineation.html#cb291-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb291-6"><a href="validate-tree-detection-and-crown-delineation.html#cb291-6" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">across</span>(</span>
<span id="cb291-7"><a href="validate-tree-detection-and-crown-delineation.html#cb291-7" tabindex="-1"></a>      <span class="fu">c</span>(precision,recall,fscore)</span>
<span id="cb291-8"><a href="validate-tree-detection-and-crown-delineation.html#cb291-8" tabindex="-1"></a>      , <span class="at">.fns =</span> <span class="fu">list</span>(<span class="at">mean =</span> mean, <span class="at">median =</span> median, <span class="at">sd =</span> sd, <span class="at">min =</span> min, <span class="at">max =</span> max)</span>
<span id="cb291-9"><a href="validate-tree-detection-and-crown-delineation.html#cb291-9" tabindex="-1"></a>    )</span>
<span id="cb291-10"><a href="validate-tree-detection-and-crown-delineation.html#cb291-10" tabindex="-1"></a>    , <span class="at">n =</span> dplyr<span class="sc">::</span><span class="fu">n</span>()</span>
<span id="cb291-11"><a href="validate-tree-detection-and-crown-delineation.html#cb291-11" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb291-12"><a href="validate-tree-detection-and-crown-delineation.html#cb291-12" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span><span class="fu">c</span>(siteID,n)) <span class="sc">%&gt;%</span> </span>
<span id="cb291-13"><a href="validate-tree-detection-and-crown-delineation.html#cb291-13" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb291-14"><a href="validate-tree-detection-and-crown-delineation.html#cb291-14" tabindex="-1"></a>    <span class="at">agg =</span> stringr<span class="sc">::</span><span class="fu">word</span>(name,<span class="sc">-</span><span class="dv">1</span>,<span class="at">sep =</span> <span class="st">&quot;_&quot;</span>)</span>
<span id="cb291-15"><a href="validate-tree-detection-and-crown-delineation.html#cb291-15" tabindex="-1"></a>    , <span class="at">metric =</span> stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(name, <span class="fu">paste0</span>(<span class="st">&quot;_&quot;</span>,agg))</span>
<span id="cb291-16"><a href="validate-tree-detection-and-crown-delineation.html#cb291-16" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb291-17"><a href="validate-tree-detection-and-crown-delineation.html#cb291-17" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>name) <span class="sc">%&gt;%</span> </span>
<span id="cb291-18"><a href="validate-tree-detection-and-crown-delineation.html#cb291-18" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb291-19"><a href="validate-tree-detection-and-crown-delineation.html#cb291-19" tabindex="-1"></a>    <span class="at">value =</span> scales<span class="sc">::</span><span class="fu">comma</span>(value,<span class="at">accuracy=</span><span class="fl">0.01</span>)</span>
<span id="cb291-20"><a href="validate-tree-detection-and-crown-delineation.html#cb291-20" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb291-21"><a href="validate-tree-detection-and-crown-delineation.html#cb291-21" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(<span class="at">names_from =</span> agg, <span class="at">values_from =</span> value) <span class="sc">%&gt;%</span> </span>
<span id="cb291-22"><a href="validate-tree-detection-and-crown-delineation.html#cb291-22" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb291-23"><a href="validate-tree-detection-and-crown-delineation.html#cb291-23" tabindex="-1"></a>    <span class="at">unit_lab =</span> <span class="fu">paste0</span>(</span>
<span id="cb291-24"><a href="validate-tree-detection-and-crown-delineation.html#cb291-24" tabindex="-1"></a>      siteID</span>
<span id="cb291-25"><a href="validate-tree-detection-and-crown-delineation.html#cb291-25" tabindex="-1"></a>      , <span class="st">&quot;&lt;br&gt;(&quot;</span></span>
<span id="cb291-26"><a href="validate-tree-detection-and-crown-delineation.html#cb291-26" tabindex="-1"></a>      , scales<span class="sc">::</span><span class="fu">comma</span>(n,<span class="at">accuracy=</span><span class="dv">1</span>)</span>
<span id="cb291-27"><a href="validate-tree-detection-and-crown-delineation.html#cb291-27" tabindex="-1"></a>      ,<span class="st">&quot; plots)&quot;</span></span>
<span id="cb291-28"><a href="validate-tree-detection-and-crown-delineation.html#cb291-28" tabindex="-1"></a>    )</span>
<span id="cb291-29"><a href="validate-tree-detection-and-crown-delineation.html#cb291-29" tabindex="-1"></a>    , <span class="at">range =</span> <span class="fu">paste0</span>(min, <span class="st">&quot;—&quot;</span>, max)</span>
<span id="cb291-30"><a href="validate-tree-detection-and-crown-delineation.html#cb291-30" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb291-31"><a href="validate-tree-detection-and-crown-delineation.html#cb291-31" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(unit_lab) <span class="sc">%&gt;%</span> </span>
<span id="cb291-32"><a href="validate-tree-detection-and-crown-delineation.html#cb291-32" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(siteID)) <span class="sc">%&gt;%</span> </span>
<span id="cb291-33"><a href="validate-tree-detection-and-crown-delineation.html#cb291-33" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb291-34"><a href="validate-tree-detection-and-crown-delineation.html#cb291-34" tabindex="-1"></a>    <span class="at">metric =</span> <span class="fu">factor</span>(</span>
<span id="cb291-35"><a href="validate-tree-detection-and-crown-delineation.html#cb291-35" tabindex="-1"></a>      metric</span>
<span id="cb291-36"><a href="validate-tree-detection-and-crown-delineation.html#cb291-36" tabindex="-1"></a>      , <span class="at">ordered =</span> T</span>
<span id="cb291-37"><a href="validate-tree-detection-and-crown-delineation.html#cb291-37" tabindex="-1"></a>      , <span class="at">levels =</span> <span class="fu">c</span>(</span>
<span id="cb291-38"><a href="validate-tree-detection-and-crown-delineation.html#cb291-38" tabindex="-1"></a>          <span class="st">&quot;recall&quot;</span></span>
<span id="cb291-39"><a href="validate-tree-detection-and-crown-delineation.html#cb291-39" tabindex="-1"></a>          , <span class="st">&quot;precision&quot;</span></span>
<span id="cb291-40"><a href="validate-tree-detection-and-crown-delineation.html#cb291-40" tabindex="-1"></a>          , <span class="st">&quot;fscore&quot;</span></span>
<span id="cb291-41"><a href="validate-tree-detection-and-crown-delineation.html#cb291-41" tabindex="-1"></a>        )</span>
<span id="cb291-42"><a href="validate-tree-detection-and-crown-delineation.html#cb291-42" tabindex="-1"></a>      , <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb291-43"><a href="validate-tree-detection-and-crown-delineation.html#cb291-43" tabindex="-1"></a>          <span class="st">&quot;recall&quot;</span></span>
<span id="cb291-44"><a href="validate-tree-detection-and-crown-delineation.html#cb291-44" tabindex="-1"></a>          , <span class="st">&quot;precision&quot;</span></span>
<span id="cb291-45"><a href="validate-tree-detection-and-crown-delineation.html#cb291-45" tabindex="-1"></a>          , <span class="st">&quot;F-score&quot;</span></span>
<span id="cb291-46"><a href="validate-tree-detection-and-crown-delineation.html#cb291-46" tabindex="-1"></a>        )</span>
<span id="cb291-47"><a href="validate-tree-detection-and-crown-delineation.html#cb291-47" tabindex="-1"></a>    )</span>
<span id="cb291-48"><a href="validate-tree-detection-and-crown-delineation.html#cb291-48" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb291-49"><a href="validate-tree-detection-and-crown-delineation.html#cb291-49" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(n,min,max)) <span class="sc">%&gt;%</span> </span>
<span id="cb291-50"><a href="validate-tree-detection-and-crown-delineation.html#cb291-50" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(unit_lab,metric) <span class="sc">%&gt;%</span> </span>
<span id="cb291-51"><a href="validate-tree-detection-and-crown-delineation.html#cb291-51" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(</span>
<span id="cb291-52"><a href="validate-tree-detection-and-crown-delineation.html#cb291-52" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">&quot;NEON site-level validation against image annotated crowns ground truth&quot;</span></span>
<span id="cb291-53"><a href="validate-tree-detection-and-crown-delineation.html#cb291-53" tabindex="-1"></a>    , <span class="at">col.names =</span> <span class="fu">c</span>(</span>
<span id="cb291-54"><a href="validate-tree-detection-and-crown-delineation.html#cb291-54" tabindex="-1"></a>      <span class="st">&quot;site&quot;</span>, <span class="st">&quot;Metric&quot;</span></span>
<span id="cb291-55"><a href="validate-tree-detection-and-crown-delineation.html#cb291-55" tabindex="-1"></a>      , <span class="st">&quot;Mean&quot;</span>, <span class="st">&quot;Median&quot;</span></span>
<span id="cb291-56"><a href="validate-tree-detection-and-crown-delineation.html#cb291-56" tabindex="-1"></a>      , <span class="st">&quot;Std Dev&quot;</span>, <span class="st">&quot;Range&quot;</span></span>
<span id="cb291-57"><a href="validate-tree-detection-and-crown-delineation.html#cb291-57" tabindex="-1"></a>    )</span>
<span id="cb291-58"><a href="validate-tree-detection-and-crown-delineation.html#cb291-58" tabindex="-1"></a>    , <span class="at">escape =</span> F</span>
<span id="cb291-59"><a href="validate-tree-detection-and-crown-delineation.html#cb291-59" tabindex="-1"></a>    <span class="co"># , digits = 2</span></span>
<span id="cb291-60"><a href="validate-tree-detection-and-crown-delineation.html#cb291-60" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb291-61"><a href="validate-tree-detection-and-crown-delineation.html#cb291-61" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>(<span class="at">font_size =</span> <span class="dv">13</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb291-62"><a href="validate-tree-detection-and-crown-delineation.html#cb291-62" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">collapse_rows</span>(<span class="at">columns =</span> <span class="dv">1</span>, <span class="at">valign =</span> <span class="st">&quot;top&quot;</span>)</span></code></pre></div>
<table class="table" style="font-size: 13px; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">
<span id="tab:unnamed-chunk-272">Table 4.16: </span>NEON site-level validation against image annotated crowns ground truth
</caption>
<thead>
<tr>
<th style="text-align:left;">
site
</th>
<th style="text-align:left;">
Metric
</th>
<th style="text-align:left;">
Mean
</th>
<th style="text-align:left;">
Median
</th>
<th style="text-align:left;">
Std Dev
</th>
<th style="text-align:left;">
Range
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="3">
ABBY<br>(2 plots)
</td>
<td style="text-align:left;">
recall
</td>
<td style="text-align:left;">
0.15
</td>
<td style="text-align:left;">
0.15
</td>
<td style="text-align:left;">
0.02
</td>
<td style="text-align:left;">
0.14—0.16
</td>
</tr>
<tr>
<td style="text-align:left;">
precision
</td>
<td style="text-align:left;">
0.02
</td>
<td style="text-align:left;">
0.02
</td>
<td style="text-align:left;">
0.01
</td>
<td style="text-align:left;">
0.02—0.03
</td>
</tr>
<tr>
<td style="text-align:left;">
F-score
</td>
<td style="text-align:left;">
0.04
</td>
<td style="text-align:left;">
0.04
</td>
<td style="text-align:left;">
0.01
</td>
<td style="text-align:left;">
0.03—0.04
</td>
</tr>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="3">
DSNY<br>(4 plots)
</td>
<td style="text-align:left;">
recall
</td>
<td style="text-align:left;">
0.71
</td>
<td style="text-align:left;">
0.68
</td>
<td style="text-align:left;">
0.26
</td>
<td style="text-align:left;">
0.48—1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
precision
</td>
<td style="text-align:left;">
0.49
</td>
<td style="text-align:left;">
0.56
</td>
<td style="text-align:left;">
0.28
</td>
<td style="text-align:left;">
0.09—0.75
</td>
</tr>
<tr>
<td style="text-align:left;">
F-score
</td>
<td style="text-align:left;">
0.54
</td>
<td style="text-align:left;">
0.60
</td>
<td style="text-align:left;">
0.28
</td>
<td style="text-align:left;">
0.15—0.80
</td>
</tr>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="3">
JERC<br>(6 plots)
</td>
<td style="text-align:left;">
recall
</td>
<td style="text-align:left;">
0.66
</td>
<td style="text-align:left;">
0.70
</td>
<td style="text-align:left;">
0.23
</td>
<td style="text-align:left;">
0.27—0.86
</td>
</tr>
<tr>
<td style="text-align:left;">
precision
</td>
<td style="text-align:left;">
0.39
</td>
<td style="text-align:left;">
0.37
</td>
<td style="text-align:left;">
0.13
</td>
<td style="text-align:left;">
0.27—0.59
</td>
</tr>
<tr>
<td style="text-align:left;">
F-score
</td>
<td style="text-align:left;">
0.47
</td>
<td style="text-align:left;">
0.42
</td>
<td style="text-align:left;">
0.14
</td>
<td style="text-align:left;">
0.33—0.68
</td>
</tr>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="3">
NIWO<br>(10 plots)
</td>
<td style="text-align:left;">
recall
</td>
<td style="text-align:left;">
0.27
</td>
<td style="text-align:left;">
0.27
</td>
<td style="text-align:left;">
0.05
</td>
<td style="text-align:left;">
0.19—0.35
</td>
</tr>
<tr>
<td style="text-align:left;">
precision
</td>
<td style="text-align:left;">
0.27
</td>
<td style="text-align:left;">
0.28
</td>
<td style="text-align:left;">
0.07
</td>
<td style="text-align:left;">
0.14—0.35
</td>
</tr>
<tr>
<td style="text-align:left;">
F-score
</td>
<td style="text-align:left;">
0.27
</td>
<td style="text-align:left;">
0.28
</td>
<td style="text-align:left;">
0.06
</td>
<td style="text-align:left;">
0.17—0.35
</td>
</tr>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="3">
ONAQ<br>(1 plots)
</td>
<td style="text-align:left;">
recall
</td>
<td style="text-align:left;">
0.56
</td>
<td style="text-align:left;">
0.56
</td>
<td style="text-align:left;">
NA
</td>
<td style="text-align:left;">
0.56—0.56
</td>
</tr>
<tr>
<td style="text-align:left;">
precision
</td>
<td style="text-align:left;">
0.25
</td>
<td style="text-align:left;">
0.25
</td>
<td style="text-align:left;">
NA
</td>
<td style="text-align:left;">
0.25—0.25
</td>
</tr>
<tr>
<td style="text-align:left;">
F-score
</td>
<td style="text-align:left;">
0.34
</td>
<td style="text-align:left;">
0.34
</td>
<td style="text-align:left;">
NA
</td>
<td style="text-align:left;">
0.34—0.34
</td>
</tr>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="3">
OSBS<br>(14 plots)
</td>
<td style="text-align:left;">
recall
</td>
<td style="text-align:left;">
0.44
</td>
<td style="text-align:left;">
0.40
</td>
<td style="text-align:left;">
0.21
</td>
<td style="text-align:left;">
0.00—0.88
</td>
</tr>
<tr>
<td style="text-align:left;">
precision
</td>
<td style="text-align:left;">
0.32
</td>
<td style="text-align:left;">
0.34
</td>
<td style="text-align:left;">
0.14
</td>
<td style="text-align:left;">
0.00—0.47
</td>
</tr>
<tr>
<td style="text-align:left;">
F-score
</td>
<td style="text-align:left;">
0.36
</td>
<td style="text-align:left;">
0.35
</td>
<td style="text-align:left;">
0.15
</td>
<td style="text-align:left;">
0.00—0.61
</td>
</tr>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="3">
SOAP<br>(2 plots)
</td>
<td style="text-align:left;">
recall
</td>
<td style="text-align:left;">
0.19
</td>
<td style="text-align:left;">
0.19
</td>
<td style="text-align:left;">
0.05
</td>
<td style="text-align:left;">
0.15—0.22
</td>
</tr>
<tr>
<td style="text-align:left;">
precision
</td>
<td style="text-align:left;">
0.23
</td>
<td style="text-align:left;">
0.23
</td>
<td style="text-align:left;">
0.03
</td>
<td style="text-align:left;">
0.21—0.26
</td>
</tr>
<tr>
<td style="text-align:left;">
F-score
</td>
<td style="text-align:left;">
0.21
</td>
<td style="text-align:left;">
0.21
</td>
<td style="text-align:left;">
0.04
</td>
<td style="text-align:left;">
0.18—0.24
</td>
</tr>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="3">
TALL<br>(2 plots)
</td>
<td style="text-align:left;">
recall
</td>
<td style="text-align:left;">
0.41
</td>
<td style="text-align:left;">
0.41
</td>
<td style="text-align:left;">
0.10
</td>
<td style="text-align:left;">
0.34—0.48
</td>
</tr>
<tr>
<td style="text-align:left;">
precision
</td>
<td style="text-align:left;">
0.05
</td>
<td style="text-align:left;">
0.05
</td>
<td style="text-align:left;">
0.01
</td>
<td style="text-align:left;">
0.05—0.06
</td>
</tr>
<tr>
<td style="text-align:left;">
F-score
</td>
<td style="text-align:left;">
0.09
</td>
<td style="text-align:left;">
0.09
</td>
<td style="text-align:left;">
0.02
</td>
<td style="text-align:left;">
0.08—0.11
</td>
</tr>
<tr>
<td style="text-align:left;vertical-align: top !important;" rowspan="3">
TEAK<br>(51 plots)
</td>
<td style="text-align:left;">
recall
</td>
<td style="text-align:left;">
0.43
</td>
<td style="text-align:left;">
0.33
</td>
<td style="text-align:left;">
0.27
</td>
<td style="text-align:left;">
0.00—1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
precision
</td>
<td style="text-align:left;">
0.29
</td>
<td style="text-align:left;">
0.28
</td>
<td style="text-align:left;">
0.16
</td>
<td style="text-align:left;">
0.00—1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
F-score
</td>
<td style="text-align:left;">
0.33
</td>
<td style="text-align:left;">
0.30
</td>
<td style="text-align:left;">
0.18
</td>
<td style="text-align:left;">
0.00—1.00
</td>
</tr>
</tbody>
</table>
<p>where are these NEON sites that we were able to evaluate using the image annotated crowns ground truth data</p>
<div class="sourceCode" id="cb292"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb292-1"><a href="validate-tree-detection-and-crown-delineation.html#cb292-1" tabindex="-1"></a>lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb292-2"><a href="validate-tree-detection-and-crown-delineation.html#cb292-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb292-3"><a href="validate-tree-detection-and-crown-delineation.html#cb292-3" tabindex="-1"></a>    evaluation_img_annttd_crwns <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">distinct</span>(plot_name)</span>
<span id="cb292-4"><a href="validate-tree-detection-and-crown-delineation.html#cb292-4" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb292-5"><a href="validate-tree-detection-and-crown-delineation.html#cb292-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(siteID) <span class="sc">%&gt;%</span></span>
<span id="cb292-6"><a href="validate-tree-detection-and-crown-delineation.html#cb292-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">plots_evaluated=</span>n) <span class="sc">%&gt;%</span> </span>
<span id="cb292-7"><a href="validate-tree-detection-and-crown-delineation.html#cb292-7" tabindex="-1"></a>  mapview<span class="sc">::</span><span class="fu">mapview</span>(</span>
<span id="cb292-8"><a href="validate-tree-detection-and-crown-delineation.html#cb292-8" tabindex="-1"></a>    <span class="at">cex =</span> <span class="st">&quot;plots_evaluated&quot;</span></span>
<span id="cb292-9"><a href="validate-tree-detection-and-crown-delineation.html#cb292-9" tabindex="-1"></a>    , <span class="at">label =</span> <span class="st">&quot;siteID&quot;</span></span>
<span id="cb292-10"><a href="validate-tree-detection-and-crown-delineation.html#cb292-10" tabindex="-1"></a>    , <span class="at">legend =</span> F</span>
<span id="cb292-11"><a href="validate-tree-detection-and-crown-delineation.html#cb292-11" tabindex="-1"></a>    <span class="co"># , layer.name = &quot;# plots evaluated&quot;</span></span>
<span id="cb292-12"><a href="validate-tree-detection-and-crown-delineation.html#cb292-12" tabindex="-1"></a>    , <span class="at">col.regions =</span> <span class="st">&quot;firebrick&quot;</span></span>
<span id="cb292-13"><a href="validate-tree-detection-and-crown-delineation.html#cb292-13" tabindex="-1"></a>  )</span></code></pre></div>
<div class="leaflet html-widget html-fill-item" id="htmlwidget-8abfe57a4f731df9e55a" style="width:1008px;height:672px;"></div>
<script type="application/json" data-for="htmlwidget-8abfe57a4f731df9e55a">{"x":{"options":{"minZoom":1,"maxZoom":52,"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}},"preferCanvas":false,"bounceAtZoomLimits":false,"maxBounds":[[[-90,-370]],[[90,370]]]},"calls":[{"method":"addProviderTiles","args":["OpenStreetMap","OpenStreetMap","OpenStreetMap",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["Esri.WorldImagery","Esri.WorldImagery","Esri.WorldImagery",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"createMapPane","args":["point",440]},{"method":"addCircleMarkers","args":[[45.76170271641791,28.08222958823529,31.19748024733096,40.04172801108648,40.17957887499999,29.69109949456522,37.03389210536779,32.94875689412314,37.00258338164251],[-122.3339110559701,-81.40931664705882,-84.46601650711743,-105.5650561036585,-112.5173911477273,-81.98834036801242,-119.2642730019881,-87.39915964505597,-119.0076350660226],[3.24,3.72,4.2,5.16,3,6.12,3.24,3.24,15],null,".",{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}},"pane":"point","stroke":true,"color":"#333333","weight":1,"opacity":0.9,"fill":true,"fillColor":"#B22222","fillOpacity":0.6},null,null,["<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>1&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>ABBY&emsp;<\/td><\/tr><tr><td>2<\/td><th>plots_evaluated&emsp;<\/th><td> 2&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>2&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>DSNY&emsp;<\/td><\/tr><tr><td>2<\/td><th>plots_evaluated&emsp;<\/th><td> 4&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>3&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>JERC&emsp;<\/td><\/tr><tr><td>2<\/td><th>plots_evaluated&emsp;<\/th><td> 6&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>4&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>NIWO&emsp;<\/td><\/tr><tr><td>2<\/td><th>plots_evaluated&emsp;<\/th><td>10&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>5&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>ONAQ&emsp;<\/td><\/tr><tr><td>2<\/td><th>plots_evaluated&emsp;<\/th><td> 1&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>6&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>OSBS&emsp;<\/td><\/tr><tr><td>2<\/td><th>plots_evaluated&emsp;<\/th><td>14&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>7&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>SOAP&emsp;<\/td><\/tr><tr><td>2<\/td><th>plots_evaluated&emsp;<\/th><td> 2&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>8&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>TALL&emsp;<\/td><\/tr><tr><td>2<\/td><th>plots_evaluated&emsp;<\/th><td> 2&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>9&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>TEAK&emsp;<\/td><\/tr><tr><td>2<\/td><th>plots_evaluated&emsp;<\/th><td>51&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><\/table><\/div>"],{"maxWidth":800,"minWidth":50,"autoPan":true,"keepInView":false,"closeButton":true,"closeOnClick":true,"className":""},["ABBY","DSNY","JERC","NIWO","ONAQ","OSBS","SOAP","TALL","TEAK"],{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addScaleBar","args":[{"maxWidth":100,"metric":true,"imperial":true,"updateWhenIdle":true,"position":"bottomleft"}]},{"method":"addLayersControl","args":[["OpenStreetMap","Esri.WorldImagery"],".",{"collapsed":true,"autoZIndex":true,"position":"topleft"}]}],"limits":{"lat":[28.08222958823529,45.76170271641791],"lng":[-122.3339110559701,-81.40931664705882]},"fitBounds":[28.08222958823529,-122.3339110559701,45.76170271641791,-81.40931664705882,[]]},"evals":[],"jsHooks":{"render":[{"code":"function(el, x, data) {\n  return (\n      function(el, x, data) {\n      // get the leaflet map\n      var map = this; //HTMLWidgets.find('#' + el.id);\n      // we need a new div element because we have to handle\n      // the mouseover output separately\n      // debugger;\n      function addElement () {\n      // generate new div Element\n      var newDiv = $(document.createElement('div'));\n      // append at end of leaflet htmlwidget container\n      $(el).append(newDiv);\n      //provide ID and style\n      newDiv.addClass('lnlt');\n      newDiv.css({\n      'position': 'relative',\n      'bottomleft':  '0px',\n      'background-color': 'rgba(255, 255, 255, 0.7)',\n      'box-shadow': '0 0 2px #bbb',\n      'background-clip': 'padding-box',\n      'margin': '0',\n      'padding-left': '5px',\n      'color': '#333',\n      'font': '9px/1.5 \"Helvetica Neue\", Arial, Helvetica, sans-serif',\n      'z-index': '700',\n      });\n      return newDiv;\n      }\n\n\n      // check for already existing lnlt class to not duplicate\n      var lnlt = $(el).find('.lnlt');\n\n      if(!lnlt.length) {\n      lnlt = addElement();\n\n      // grab the special div we generated in the beginning\n      // and put the mousmove output there\n\n      map.on('mousemove', function (e) {\n      if (e.originalEvent.ctrlKey) {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                           ' lon: ' + (e.latlng.lng).toFixed(5) +\n                           ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                           ' | zoom: ' + map.getZoom() +\n                           ' | x: ' + L.CRS.EPSG3857.project(e.latlng).x.toFixed(0) +\n                           ' | y: ' + L.CRS.EPSG3857.project(e.latlng).y.toFixed(0) +\n                           ' | epsg: 3857 ' +\n                           ' | proj4: +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs ');\n      } else {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                      ' | zoom: ' + map.getZoom() + ' ');\n      }\n      });\n\n      // remove the lnlt div when mouse leaves map\n      map.on('mouseout', function (e) {\n      var strip = document.querySelector('.lnlt');\n      if( strip !==null) strip.remove();\n      });\n\n      };\n\n      //$(el).keypress(67, function(e) {\n      map.on('preclick', function(e) {\n      if (e.originalEvent.ctrlKey) {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                      ' | zoom: ' + map.getZoom() + ' ');\n      var txt = document.querySelector('.lnlt').textContent;\n      console.log(txt);\n      //txt.innerText.focus();\n      //txt.select();\n      setClipboardText('\"' + txt + '\"');\n      }\n      });\n\n      }\n      ).call(this.getMap(), el, x, data);\n}","data":null},{"code":"function(el, x, data) {\n  return (function(el,x,data){\n           var map = this;\n\n           map.on('keypress', function(e) {\n               console.log(e.originalEvent.code);\n               var key = e.originalEvent.code;\n               if (key === 'KeyE') {\n                   var bb = this.getBounds();\n                   var txt = JSON.stringify(bb);\n                   console.log(txt);\n\n                   setClipboardText('\\'' + txt + '\\'');\n               }\n           })\n        }).call(this.getMap(), el, x, data);\n}","data":null}]}}</script>
</div>
<div id="field-collected-stems-1" class="section level5 hasAnchor" number="4.2.6.2.2">
<h5><span class="header-section-number">4.2.6.2.2</span> Field-collected stems<a href="validate-tree-detection-and-crown-delineation.html#field-collected-stems-1" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>distribution of plot-level scores</p>
<div class="sourceCode" id="cb293"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb293-1"><a href="validate-tree-detection-and-crown-delineation.html#cb293-1" tabindex="-1"></a>evaluation_fld_cllctd_stems <span class="sc">%&gt;%</span> </span>
<span id="cb293-2"><a href="validate-tree-detection-and-crown-delineation.html#cb293-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>siteID) <span class="sc">%&gt;%</span> </span>
<span id="cb293-3"><a href="validate-tree-detection-and-crown-delineation.html#cb293-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb293-4"><a href="validate-tree-detection-and-crown-delineation.html#cb293-4" tabindex="-1"></a>    lidar_df <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">distinct</span>(plot_name,siteID),<span class="at">by=</span><span class="st">&quot;plot_name&quot;</span></span>
<span id="cb293-5"><a href="validate-tree-detection-and-crown-delineation.html#cb293-5" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb293-6"><a href="validate-tree-detection-and-crown-delineation.html#cb293-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(siteID) <span class="sc">%&gt;%</span> </span>
<span id="cb293-7"><a href="validate-tree-detection-and-crown-delineation.html#cb293-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">siteID =</span> <span class="fu">paste0</span>(siteID, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">(plots=&quot;</span>, scales<span class="sc">::</span><span class="fu">comma</span>(dplyr<span class="sc">::</span><span class="fu">n</span>(),<span class="at">accuracy=</span><span class="dv">1</span>),<span class="st">&quot;)&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb293-8"><a href="validate-tree-detection-and-crown-delineation.html#cb293-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb293-9"><a href="validate-tree-detection-and-crown-delineation.html#cb293-9" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(recall,n)) <span class="sc">%&gt;%</span> </span>
<span id="cb293-10"><a href="validate-tree-detection-and-crown-delineation.html#cb293-10" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(name<span class="sc">!=</span><span class="st">&quot;n&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb293-11"><a href="validate-tree-detection-and-crown-delineation.html#cb293-11" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb293-12"><a href="validate-tree-detection-and-crown-delineation.html#cb293-12" tabindex="-1"></a>    <span class="at">name =</span> <span class="fu">ifelse</span>(name<span class="sc">==</span><span class="st">&quot;n&quot;</span>,<span class="st">&quot;# actual trees&quot;</span>,name) <span class="sc">%&gt;%</span> forcats<span class="sc">::</span><span class="fu">fct_rev</span>()</span>
<span id="cb293-13"><a href="validate-tree-detection-and-crown-delineation.html#cb293-13" tabindex="-1"></a>    , <span class="at">siteID =</span> forcats<span class="sc">::</span><span class="fu">fct_rev</span>(siteID)</span>
<span id="cb293-14"><a href="validate-tree-detection-and-crown-delineation.html#cb293-14" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb293-15"><a href="validate-tree-detection-and-crown-delineation.html#cb293-15" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">y =</span> siteID, <span class="at">color =</span> name)) <span class="sc">+</span></span>
<span id="cb293-16"><a href="validate-tree-detection-and-crown-delineation.html#cb293-16" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_jitter</span>(<span class="at">height =</span> <span class="fl">0.12</span>, <span class="at">width =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb293-17"><a href="validate-tree-detection-and-crown-delineation.html#cb293-17" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_boxplot</span>(</span>
<span id="cb293-18"><a href="validate-tree-detection-and-crown-delineation.html#cb293-18" tabindex="-1"></a>      <span class="at">width=</span><span class="fl">0.3</span>,<span class="at">staplewidth=</span><span class="fl">0.4</span>,<span class="at">lwd=</span><span class="fl">0.7</span></span>
<span id="cb293-19"><a href="validate-tree-detection-and-crown-delineation.html#cb293-19" tabindex="-1"></a>      ,<span class="at">fill=</span><span class="cn">NA</span>,<span class="at">color =</span> <span class="st">&quot;gray9&quot;</span></span>
<span id="cb293-20"><a href="validate-tree-detection-and-crown-delineation.html#cb293-20" tabindex="-1"></a>      , <span class="at">outliers =</span> F</span>
<span id="cb293-21"><a href="validate-tree-detection-and-crown-delineation.html#cb293-21" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb293-22"><a href="validate-tree-detection-and-crown-delineation.html#cb293-22" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_grid</span>(<span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(name)) <span class="sc">+</span></span>
<span id="cb293-23"><a href="validate-tree-detection-and-crown-delineation.html#cb293-23" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(viridis<span class="sc">::</span><span class="fu">viridis</span>(<span class="at">n=</span><span class="dv">3</span>,<span class="at">begin=</span><span class="fl">0.3</span>,<span class="at">end=</span><span class="fl">0.7</span>)[<span class="dv">1</span>],<span class="st">&quot;gray&quot;</span>)) <span class="sc">+</span></span>
<span id="cb293-24"><a href="validate-tree-detection-and-crown-delineation.html#cb293-24" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="dv">6</span>)) <span class="sc">+</span></span>
<span id="cb293-25"><a href="validate-tree-detection-and-crown-delineation.html#cb293-25" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb293-26"><a href="validate-tree-detection-and-crown-delineation.html#cb293-26" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span>, <span class="at">color =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb293-27"><a href="validate-tree-detection-and-crown-delineation.html#cb293-27" tabindex="-1"></a>      , <span class="at">subtitle =</span> <span class="st">&quot;NEON site-level validation against field-collected stems ground truth&quot;</span></span>
<span id="cb293-28"><a href="validate-tree-detection-and-crown-delineation.html#cb293-28" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb293-29"><a href="validate-tree-detection-and-crown-delineation.html#cb293-29" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb293-30"><a href="validate-tree-detection-and-crown-delineation.html#cb293-30" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb293-31"><a href="validate-tree-detection-and-crown-delineation.html#cb293-31" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb293-32"><a href="validate-tree-detection-and-crown-delineation.html#cb293-32" tabindex="-1"></a>      , <span class="at">axis.text.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">7</span>)</span>
<span id="cb293-33"><a href="validate-tree-detection-and-crown-delineation.html#cb293-33" tabindex="-1"></a>      , <span class="at">panel.grid.major.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_line</span>(<span class="at">color=</span><span class="st">&quot;gray22&quot;</span>)</span>
<span id="cb293-34"><a href="validate-tree-detection-and-crown-delineation.html#cb293-34" tabindex="-1"></a>      , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb293-35"><a href="validate-tree-detection-and-crown-delineation.html#cb293-35" tabindex="-1"></a>    )</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-274-1.png" width="1008" /></p>
<p>summary statistics</p>
<div class="sourceCode" id="cb294"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb294-1"><a href="validate-tree-detection-and-crown-delineation.html#cb294-1" tabindex="-1"></a>evaluation_fld_cllctd_stems <span class="sc">%&gt;%</span> </span>
<span id="cb294-2"><a href="validate-tree-detection-and-crown-delineation.html#cb294-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>siteID) <span class="sc">%&gt;%</span> </span>
<span id="cb294-3"><a href="validate-tree-detection-and-crown-delineation.html#cb294-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb294-4"><a href="validate-tree-detection-and-crown-delineation.html#cb294-4" tabindex="-1"></a>    lidar_df <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">distinct</span>(plot_name,siteID),<span class="at">by=</span><span class="st">&quot;plot_name&quot;</span></span>
<span id="cb294-5"><a href="validate-tree-detection-and-crown-delineation.html#cb294-5" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb294-6"><a href="validate-tree-detection-and-crown-delineation.html#cb294-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(siteID) <span class="sc">%&gt;%</span> </span>
<span id="cb294-7"><a href="validate-tree-detection-and-crown-delineation.html#cb294-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb294-8"><a href="validate-tree-detection-and-crown-delineation.html#cb294-8" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">across</span>(</span>
<span id="cb294-9"><a href="validate-tree-detection-and-crown-delineation.html#cb294-9" tabindex="-1"></a>      <span class="fu">c</span>(recall)</span>
<span id="cb294-10"><a href="validate-tree-detection-and-crown-delineation.html#cb294-10" tabindex="-1"></a>      , <span class="at">.fns =</span> <span class="fu">list</span>(<span class="at">mean =</span> mean, <span class="at">median =</span> median, <span class="at">sd =</span> sd, <span class="at">min =</span> min, <span class="at">max =</span> max)</span>
<span id="cb294-11"><a href="validate-tree-detection-and-crown-delineation.html#cb294-11" tabindex="-1"></a>    )</span>
<span id="cb294-12"><a href="validate-tree-detection-and-crown-delineation.html#cb294-12" tabindex="-1"></a>    , <span class="at">n =</span> dplyr<span class="sc">::</span><span class="fu">n</span>()</span>
<span id="cb294-13"><a href="validate-tree-detection-and-crown-delineation.html#cb294-13" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb294-14"><a href="validate-tree-detection-and-crown-delineation.html#cb294-14" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span><span class="fu">c</span>(siteID,n)) <span class="sc">%&gt;%</span> </span>
<span id="cb294-15"><a href="validate-tree-detection-and-crown-delineation.html#cb294-15" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb294-16"><a href="validate-tree-detection-and-crown-delineation.html#cb294-16" tabindex="-1"></a>    <span class="at">agg =</span> stringr<span class="sc">::</span><span class="fu">word</span>(name,<span class="sc">-</span><span class="dv">1</span>,<span class="at">sep =</span> <span class="st">&quot;_&quot;</span>)</span>
<span id="cb294-17"><a href="validate-tree-detection-and-crown-delineation.html#cb294-17" tabindex="-1"></a>    , <span class="at">metric =</span> stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(name, <span class="fu">paste0</span>(<span class="st">&quot;_&quot;</span>,agg))</span>
<span id="cb294-18"><a href="validate-tree-detection-and-crown-delineation.html#cb294-18" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb294-19"><a href="validate-tree-detection-and-crown-delineation.html#cb294-19" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>name) <span class="sc">%&gt;%</span> </span>
<span id="cb294-20"><a href="validate-tree-detection-and-crown-delineation.html#cb294-20" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb294-21"><a href="validate-tree-detection-and-crown-delineation.html#cb294-21" tabindex="-1"></a>    <span class="at">value =</span> scales<span class="sc">::</span><span class="fu">comma</span>(value,<span class="at">accuracy=</span><span class="fl">0.01</span>)</span>
<span id="cb294-22"><a href="validate-tree-detection-and-crown-delineation.html#cb294-22" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb294-23"><a href="validate-tree-detection-and-crown-delineation.html#cb294-23" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(<span class="at">names_from =</span> agg, <span class="at">values_from =</span> value) <span class="sc">%&gt;%</span> </span>
<span id="cb294-24"><a href="validate-tree-detection-and-crown-delineation.html#cb294-24" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb294-25"><a href="validate-tree-detection-and-crown-delineation.html#cb294-25" tabindex="-1"></a>    <span class="at">unit_lab =</span> <span class="fu">paste0</span>(</span>
<span id="cb294-26"><a href="validate-tree-detection-and-crown-delineation.html#cb294-26" tabindex="-1"></a>      siteID</span>
<span id="cb294-27"><a href="validate-tree-detection-and-crown-delineation.html#cb294-27" tabindex="-1"></a>      , <span class="st">&quot;&lt;br&gt;(&quot;</span></span>
<span id="cb294-28"><a href="validate-tree-detection-and-crown-delineation.html#cb294-28" tabindex="-1"></a>      , scales<span class="sc">::</span><span class="fu">comma</span>(n,<span class="at">accuracy=</span><span class="dv">1</span>)</span>
<span id="cb294-29"><a href="validate-tree-detection-and-crown-delineation.html#cb294-29" tabindex="-1"></a>      ,<span class="st">&quot; plots)&quot;</span></span>
<span id="cb294-30"><a href="validate-tree-detection-and-crown-delineation.html#cb294-30" tabindex="-1"></a>    )</span>
<span id="cb294-31"><a href="validate-tree-detection-and-crown-delineation.html#cb294-31" tabindex="-1"></a>    , <span class="at">range =</span> <span class="fu">paste0</span>(min, <span class="st">&quot;—&quot;</span>, max)</span>
<span id="cb294-32"><a href="validate-tree-detection-and-crown-delineation.html#cb294-32" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb294-33"><a href="validate-tree-detection-and-crown-delineation.html#cb294-33" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(unit_lab) <span class="sc">%&gt;%</span> </span>
<span id="cb294-34"><a href="validate-tree-detection-and-crown-delineation.html#cb294-34" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(siteID,n,min,max)) <span class="sc">%&gt;%</span> </span>
<span id="cb294-35"><a href="validate-tree-detection-and-crown-delineation.html#cb294-35" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(unit_lab,metric) <span class="sc">%&gt;%</span> </span>
<span id="cb294-36"><a href="validate-tree-detection-and-crown-delineation.html#cb294-36" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kbl</span>(</span>
<span id="cb294-37"><a href="validate-tree-detection-and-crown-delineation.html#cb294-37" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">&quot;NEON site-level validation against field collected-stems ground truth&quot;</span></span>
<span id="cb294-38"><a href="validate-tree-detection-and-crown-delineation.html#cb294-38" tabindex="-1"></a>    , <span class="at">col.names =</span> <span class="fu">c</span>(</span>
<span id="cb294-39"><a href="validate-tree-detection-and-crown-delineation.html#cb294-39" tabindex="-1"></a>      <span class="st">&quot;site&quot;</span>, <span class="st">&quot;Metric&quot;</span></span>
<span id="cb294-40"><a href="validate-tree-detection-and-crown-delineation.html#cb294-40" tabindex="-1"></a>      , <span class="st">&quot;Mean&quot;</span>, <span class="st">&quot;Median&quot;</span></span>
<span id="cb294-41"><a href="validate-tree-detection-and-crown-delineation.html#cb294-41" tabindex="-1"></a>      , <span class="st">&quot;Std Dev&quot;</span>, <span class="st">&quot;Range&quot;</span></span>
<span id="cb294-42"><a href="validate-tree-detection-and-crown-delineation.html#cb294-42" tabindex="-1"></a>    )</span>
<span id="cb294-43"><a href="validate-tree-detection-and-crown-delineation.html#cb294-43" tabindex="-1"></a>    , <span class="at">escape =</span> F</span>
<span id="cb294-44"><a href="validate-tree-detection-and-crown-delineation.html#cb294-44" tabindex="-1"></a>    <span class="co"># , digits = 2</span></span>
<span id="cb294-45"><a href="validate-tree-detection-and-crown-delineation.html#cb294-45" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb294-46"><a href="validate-tree-detection-and-crown-delineation.html#cb294-46" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>(<span class="at">font_size =</span> <span class="dv">13</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb294-47"><a href="validate-tree-detection-and-crown-delineation.html#cb294-47" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">collapse_rows</span>(<span class="at">columns =</span> <span class="dv">1</span>, <span class="at">valign =</span> <span class="st">&quot;top&quot;</span>)</span></code></pre></div>
<table class="table" style="font-size: 13px; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">
<span id="tab:unnamed-chunk-275">Table 4.17: </span>NEON site-level validation against field collected-stems ground truth
</caption>
<thead>
<tr>
<th style="text-align:left;">
site
</th>
<th style="text-align:left;">
Metric
</th>
<th style="text-align:left;">
Mean
</th>
<th style="text-align:left;">
Median
</th>
<th style="text-align:left;">
Std Dev
</th>
<th style="text-align:left;">
Range
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
ABBY<br>(10 plots)
</td>
<td style="text-align:left;">
recall
</td>
<td style="text-align:left;">
0.70
</td>
<td style="text-align:left;">
0.93
</td>
<td style="text-align:left;">
0.41
</td>
<td style="text-align:left;">
0.00—1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
DEJU<br>(11 plots)
</td>
<td style="text-align:left;">
recall
</td>
<td style="text-align:left;">
0.67
</td>
<td style="text-align:left;">
0.67
</td>
<td style="text-align:left;">
0.27
</td>
<td style="text-align:left;">
0.00—1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
JERC<br>(19 plots)
</td>
<td style="text-align:left;">
recall
</td>
<td style="text-align:left;">
0.82
</td>
<td style="text-align:left;">
0.86
</td>
<td style="text-align:left;">
0.20
</td>
<td style="text-align:left;">
0.35—1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
MOAB<br>(2 plots)
</td>
<td style="text-align:left;">
recall
</td>
<td style="text-align:left;">
0.86
</td>
<td style="text-align:left;">
0.86
</td>
<td style="text-align:left;">
0.06
</td>
<td style="text-align:left;">
0.82—0.91
</td>
</tr>
<tr>
<td style="text-align:left;">
NIWO<br>(38 plots)
</td>
<td style="text-align:left;">
recall
</td>
<td style="text-align:left;">
0.54
</td>
<td style="text-align:left;">
0.57
</td>
<td style="text-align:left;">
0.17
</td>
<td style="text-align:left;">
0.00—0.83
</td>
</tr>
<tr>
<td style="text-align:left;">
OSBS<br>(44 plots)
</td>
<td style="text-align:left;">
recall
</td>
<td style="text-align:left;">
0.73
</td>
<td style="text-align:left;">
0.70
</td>
<td style="text-align:left;">
0.16
</td>
<td style="text-align:left;">
0.38—1.00
</td>
</tr>
<tr>
<td style="text-align:left;">
TALL<br>(18 plots)
</td>
<td style="text-align:left;">
recall
</td>
<td style="text-align:left;">
0.89
</td>
<td style="text-align:left;">
0.91
</td>
<td style="text-align:left;">
0.09
</td>
<td style="text-align:left;">
0.75—1.00
</td>
</tr>
</tbody>
</table>
<p>the recall values for our lidar-based tree list are much better using the field collected stems for validation than using the image annotated crowns…this might this suggest that our “canopy” filter is aligned for field stems (which we based the filter on) but not for crowns visible from aerial photography</p>
<p>where are these NEON sites that we were able to evaluate using the field-collected stems ground truth data</p>
<div class="sourceCode" id="cb295"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb295-1"><a href="validate-tree-detection-and-crown-delineation.html#cb295-1" tabindex="-1"></a>lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb295-2"><a href="validate-tree-detection-and-crown-delineation.html#cb295-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb295-3"><a href="validate-tree-detection-and-crown-delineation.html#cb295-3" tabindex="-1"></a>    evaluation_fld_cllctd_stems <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">distinct</span>(plot_name)</span>
<span id="cb295-4"><a href="validate-tree-detection-and-crown-delineation.html#cb295-4" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb295-5"><a href="validate-tree-detection-and-crown-delineation.html#cb295-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(siteID) <span class="sc">%&gt;%</span></span>
<span id="cb295-6"><a href="validate-tree-detection-and-crown-delineation.html#cb295-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">plots_evaluated=</span>n) <span class="sc">%&gt;%</span> </span>
<span id="cb295-7"><a href="validate-tree-detection-and-crown-delineation.html#cb295-7" tabindex="-1"></a>  mapview<span class="sc">::</span><span class="fu">mapview</span>(</span>
<span id="cb295-8"><a href="validate-tree-detection-and-crown-delineation.html#cb295-8" tabindex="-1"></a>    <span class="at">cex =</span> <span class="st">&quot;plots_evaluated&quot;</span></span>
<span id="cb295-9"><a href="validate-tree-detection-and-crown-delineation.html#cb295-9" tabindex="-1"></a>    , <span class="at">label =</span> <span class="st">&quot;siteID&quot;</span></span>
<span id="cb295-10"><a href="validate-tree-detection-and-crown-delineation.html#cb295-10" tabindex="-1"></a>    , <span class="at">legend =</span> F</span>
<span id="cb295-11"><a href="validate-tree-detection-and-crown-delineation.html#cb295-11" tabindex="-1"></a>    <span class="co"># , layer.name = &quot;# plots evaluated&quot;</span></span>
<span id="cb295-12"><a href="validate-tree-detection-and-crown-delineation.html#cb295-12" tabindex="-1"></a>    , <span class="at">col.regions =</span> <span class="st">&quot;steelblue2&quot;</span></span>
<span id="cb295-13"><a href="validate-tree-detection-and-crown-delineation.html#cb295-13" tabindex="-1"></a>  )</span></code></pre></div>
<div class="leaflet html-widget html-fill-item" id="htmlwidget-f9a9d7280457e4a5efb7" style="width:1008px;height:672px;"></div>
<script type="application/json" data-for="htmlwidget-f9a9d7280457e4a5efb7">{"x":{"options":{"minZoom":1,"maxZoom":52,"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}},"preferCanvas":false,"bounceAtZoomLimits":false,"maxBounds":[[[-90,-370]],[[90,370]]]},"calls":[{"method":"addProviderTiles","args":["OpenStreetMap","OpenStreetMap","OpenStreetMap",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["Esri.WorldImagery","Esri.WorldImagery","Esri.WorldImagery",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"createMapPane","args":["point",440]},{"method":"addCircleMarkers","args":[[45.76170271641791,63.87034470520231,31.19748024733096,38.26231868965518,40.04172801108648,29.69109949456522,32.94875689412314],[-122.3339110559701,-145.7525825260116,-84.46601650711743,-109.3457485172414,-105.5650561036585,-81.98834036801242,-87.39915964505597],[5.285714285714286,5.571428571428571,7.857142857142858,3,13.28571428571428,15,7.571428571428571],null,".",{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}},"pane":"point","stroke":true,"color":"#333333","weight":1,"opacity":0.9,"fill":true,"fillColor":"#5CACEE","fillOpacity":0.6},null,null,["<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>1&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>ABBY&emsp;<\/td><\/tr><tr><td>2<\/td><th>plots_evaluated&emsp;<\/th><td>10&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>2&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>DEJU&emsp;<\/td><\/tr><tr><td>2<\/td><th>plots_evaluated&emsp;<\/th><td>11&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>3&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>JERC&emsp;<\/td><\/tr><tr><td>2<\/td><th>plots_evaluated&emsp;<\/th><td>19&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>4&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>MOAB&emsp;<\/td><\/tr><tr><td>2<\/td><th>plots_evaluated&emsp;<\/th><td> 2&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>5&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>NIWO&emsp;<\/td><\/tr><tr><td>2<\/td><th>plots_evaluated&emsp;<\/th><td>38&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>6&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>OSBS&emsp;<\/td><\/tr><tr><td>2<\/td><th>plots_evaluated&emsp;<\/th><td>44&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>7&emsp;<\/td><\/tr><tr><td>1<\/td><th>siteID&emsp;<\/th><td>TALL&emsp;<\/td><\/tr><tr><td>2<\/td><th>plots_evaluated&emsp;<\/th><td>18&emsp;<\/td><\/tr><tr><td>3<\/td><th>geometry&emsp;<\/th><td>sfc_POINT&emsp;<\/td><\/tr><\/table><\/div>"],{"maxWidth":800,"minWidth":50,"autoPan":true,"keepInView":false,"closeButton":true,"closeOnClick":true,"className":""},["ABBY","DEJU","JERC","MOAB","NIWO","OSBS","TALL"],{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addScaleBar","args":[{"maxWidth":100,"metric":true,"imperial":true,"updateWhenIdle":true,"position":"bottomleft"}]},{"method":"addLayersControl","args":[["OpenStreetMap","Esri.WorldImagery"],".",{"collapsed":true,"autoZIndex":true,"position":"topleft"}]}],"limits":{"lat":[29.69109949456522,63.87034470520231],"lng":[-145.7525825260116,-81.98834036801242]},"fitBounds":[29.69109949456522,-145.7525825260116,63.87034470520231,-81.98834036801242,[]]},"evals":[],"jsHooks":{"render":[{"code":"function(el, x, data) {\n  return (\n      function(el, x, data) {\n      // get the leaflet map\n      var map = this; //HTMLWidgets.find('#' + el.id);\n      // we need a new div element because we have to handle\n      // the mouseover output separately\n      // debugger;\n      function addElement () {\n      // generate new div Element\n      var newDiv = $(document.createElement('div'));\n      // append at end of leaflet htmlwidget container\n      $(el).append(newDiv);\n      //provide ID and style\n      newDiv.addClass('lnlt');\n      newDiv.css({\n      'position': 'relative',\n      'bottomleft':  '0px',\n      'background-color': 'rgba(255, 255, 255, 0.7)',\n      'box-shadow': '0 0 2px #bbb',\n      'background-clip': 'padding-box',\n      'margin': '0',\n      'padding-left': '5px',\n      'color': '#333',\n      'font': '9px/1.5 \"Helvetica Neue\", Arial, Helvetica, sans-serif',\n      'z-index': '700',\n      });\n      return newDiv;\n      }\n\n\n      // check for already existing lnlt class to not duplicate\n      var lnlt = $(el).find('.lnlt');\n\n      if(!lnlt.length) {\n      lnlt = addElement();\n\n      // grab the special div we generated in the beginning\n      // and put the mousmove output there\n\n      map.on('mousemove', function (e) {\n      if (e.originalEvent.ctrlKey) {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                           ' lon: ' + (e.latlng.lng).toFixed(5) +\n                           ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                           ' | zoom: ' + map.getZoom() +\n                           ' | x: ' + L.CRS.EPSG3857.project(e.latlng).x.toFixed(0) +\n                           ' | y: ' + L.CRS.EPSG3857.project(e.latlng).y.toFixed(0) +\n                           ' | epsg: 3857 ' +\n                           ' | proj4: +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs ');\n      } else {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                      ' | zoom: ' + map.getZoom() + ' ');\n      }\n      });\n\n      // remove the lnlt div when mouse leaves map\n      map.on('mouseout', function (e) {\n      var strip = document.querySelector('.lnlt');\n      if( strip !==null) strip.remove();\n      });\n\n      };\n\n      //$(el).keypress(67, function(e) {\n      map.on('preclick', function(e) {\n      if (e.originalEvent.ctrlKey) {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                      ' | zoom: ' + map.getZoom() + ' ');\n      var txt = document.querySelector('.lnlt').textContent;\n      console.log(txt);\n      //txt.innerText.focus();\n      //txt.select();\n      setClipboardText('\"' + txt + '\"');\n      }\n      });\n\n      }\n      ).call(this.getMap(), el, x, data);\n}","data":null},{"code":"function(el, x, data) {\n  return (function(el,x,data){\n           var map = this;\n\n           map.on('keypress', function(e) {\n               console.log(e.originalEvent.code);\n               var key = e.originalEvent.code;\n               if (key === 'KeyE') {\n                   var bb = this.getBounds();\n                   var txt = JSON.stringify(bb);\n                   console.log(txt);\n\n                   setClipboardText('\\'' + txt + '\\'');\n               }\n           })\n        }).call(this.getMap(), el, x, data);\n}","data":null}]}}</script>
</div>
</div>
</div>
</div>
<div id="for-instance-benchmark" class="section level2 hasAnchor" number="4.3">
<h2><span class="header-section-number">4.3</span> FOR-instance benchmark<a href="validate-tree-detection-and-crown-delineation.html#for-instance-benchmark" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Puliti et al. <a href="https://doi.org/10.48550/arXiv.2309.01279">(2023)</a> also provide the benchmarking dataset “FOR-instance” for dense airborne laser scanning data. The dataset comprises five curated UAV-based laser scanning data collections from diverse global locations, representing various forest types. The data was collected over five sites in Norway, Czech Republic, Austria, Australia, and New Zealand and covers mature forests for the following forest types: boreal (42% of the number of trees) and temperate coniferous (5%), temperate mixed deciduous (29%), coniferous plantation (13%), and dry sclerophyll forests (11%). We will also consider this data for validation of our methods.</p>
<p>This benchmark data is described (p. 10):</p>
<blockquote>
<p>The annotated collections were then split into development (i.e. dev) and test sub-sets in order to create two separate sets of data for the following scopes:</p>
</blockquote>
<blockquote>
<p><strong>Dev data</strong>: these data can be used for developing new methods. The dev data can be further split into training and validation by the user to create a validation dataset for hyperparameter tuning, overfitting detection, and model selection.</p>
</blockquote>
<blockquote>
<p><strong>Test data</strong>: these data aim to be used for the final evaluation of a method (i.e., either preexisting or developed using the training data). These datasets should strictly not be used in any step of model training, and to avoid any information leak, the user should limit the number of
times the test data is used.</p>
</blockquote>
<p>70% of the annotated area was selected for development (i.e. “training”) and 30% for testing (i.e. “evaluation”). We downloaded this data from the online archive at <a href="https://zenodo.org/records/8287792">https://zenodo.org/records/8287792</a></p>
<div id="lidar-data-in-for-instance" class="section level3 hasAnchor" number="4.3.1">
<h3><span class="header-section-number">4.3.1</span> lidar data in <strong>FOR-instance</strong><a href="validate-tree-detection-and-crown-delineation.html#lidar-data-in-for-instance" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>FOR-instance includes the following five forest types described by Puliti et al. <a href="https://doi.org/10.48550/arXiv.2309.01279">(2023, p. 5)</a>:</p>
<ol style="list-style-type: decimal">
<li>Coniferous dominated boreal forest (42% of the annotated trees): these are found in Norway in the <strong>NIBIO</strong> collection and are composed of mature forests dominated by Norway spruce (<em>Picea abies</em>) and with few Scots pine (<em>Pinus Sylvestris</em>) and deciduous species (mainly <em>Betula</em> sp.). In specific, the <strong>NIBIO</strong> collection is mainly dominated by Norway spruce. Further details on the <strong>NIBIO</strong> forest structures can be found in the study by Puliti et al. (2022).</li>
<li>Coniferous dominated temperate forest (5% of the trees): these forests correspond to three plots in the <strong>CULS</strong> collection and consist of a productive even-aged Scots pine forest stand found in sandy areas of the Czech north of Prague, that are generally more productive than the mire forest in boreal conditions. Further details regarding forest characteristics can be found in Kuzelka et al. (2020).</li>
<li>Deciduous alluvial forests (29% of the annotated trees): this forest type is found in the <strong>TU_WIEN</strong> collection and consists of a Natura 2000 site characterized by complex vegetation structures (woody debris, lying and standing deadwood, dense understory) a large diversity of tree species and considerable variation in canopy layering and tree size (DBH up to 1.3 m). Further details on the specific forest characteristics can be found in Wieser et al. (2017).</li>
<li>Native dry sclerophyll eucalypt forest (11% of the annotated trees): This forest type is found in the <strong>RMIT</strong> collection with a dominant canopy species of White Peppermint (<em>Eucalyptus pulchella</em>). Trees of this species are found within the plot at a range of ages and heights (from 5 m to 17 m). The study site was subject to planned burning 3 years before the drone laser scanning acquisition. The understory at time of capture consisted of low shrubs (up to 2 m in height) and native grasses.</li>
<li>Coniferous non-native temperate (13% of the annotated trees): This type is found in the <strong>SCION</strong> collection and consists of pure radiata pine (<em>Pinus radiata</em>) of 18-20 years of age and is representative of a typical productive plantation forest (approx. 930 trees per hectare) in New Zealand. The forest was planted on a 2 m × 5 m grid and remained unthinned, and no silvicultural interventions except for regular mowing of the blackberry understory between the rows. The vertical forest structure is single-layered, and due to the branchiness of radiata pine, the canopy is composed of a dense layer of intertwined and overlapping crowns.</li>
</ol>
<p>we will want to limit our evaluation to only sites with conifer trees – <strong>NIBIO</strong>, <strong>CULS</strong>, and <strong>SCION</strong> – since <code>cloud2trees</code> implements methods developed specifically to quantify conifer forest structure that may not be appropriate for other forest types</p>
<p>let’s load the FOR-instance point cloud data tracking file. If you have been with us from the beginning, this is the <code>lidar_df</code> file that we <a href="validate-tree-detection-and-crown-delineation.html#neon_lidar">generated above</a> for the Weinstein et al. (<a href="https://scholar.google.com/scholar?cluster=4986448711981898434&amp;hl=en&amp;as_sdt=0,6">2021</a>) benchmark</p>
<div class="sourceCode" id="cb296"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb296-1"><a href="validate-tree-detection-and-crown-delineation.html#cb296-1" tabindex="-1"></a>fi_lidar_df <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="st">&quot;../data/FORinstance_dataset/data_split_metadata.csv&quot;</span>, <span class="at">show_col_types =</span> F, <span class="at">progress =</span> F)</span>
<span id="cb296-2"><a href="validate-tree-detection-and-crown-delineation.html#cb296-2" tabindex="-1"></a><span class="co"># nice! we&#39;ll structure this in the same way as the `lidar_df` we have been working with above</span></span>
<span id="cb296-3"><a href="validate-tree-detection-and-crown-delineation.html#cb296-3" tabindex="-1"></a>fi_lidar_df <span class="ot">&lt;-</span></span>
<span id="cb296-4"><a href="validate-tree-detection-and-crown-delineation.html#cb296-4" tabindex="-1"></a>  fi_lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb296-5"><a href="validate-tree-detection-and-crown-delineation.html#cb296-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb296-6"><a href="validate-tree-detection-and-crown-delineation.html#cb296-6" tabindex="-1"></a>    <span class="at">f_path =</span> <span class="fu">file.path</span>( <span class="fu">normalizePath</span>(<span class="st">&quot;../data/FORinstance_dataset&quot;</span>), path )</span>
<span id="cb296-7"><a href="validate-tree-detection-and-crown-delineation.html#cb296-7" tabindex="-1"></a>    , <span class="at">siteID =</span> folder</span>
<span id="cb296-8"><a href="validate-tree-detection-and-crown-delineation.html#cb296-8" tabindex="-1"></a>    , <span class="at">plotID =</span> </span>
<span id="cb296-9"><a href="validate-tree-detection-and-crown-delineation.html#cb296-9" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_extract</span>(path, <span class="at">pattern =</span> <span class="st">&quot;plot_</span><span class="sc">\\</span><span class="st">d+&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb296-10"><a href="validate-tree-detection-and-crown-delineation.html#cb296-10" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_remove</span>(<span class="st">&quot;plot_&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb296-11"><a href="validate-tree-detection-and-crown-delineation.html#cb296-11" tabindex="-1"></a>      readr<span class="sc">::</span><span class="fu">parse_number</span>()</span>
<span id="cb296-12"><a href="validate-tree-detection-and-crown-delineation.html#cb296-12" tabindex="-1"></a>    , <span class="at">plot_name =</span> <span class="fu">paste0</span>(</span>
<span id="cb296-13"><a href="validate-tree-detection-and-crown-delineation.html#cb296-13" tabindex="-1"></a>      siteID</span>
<span id="cb296-14"><a href="validate-tree-detection-and-crown-delineation.html#cb296-14" tabindex="-1"></a>      , <span class="st">&quot;_&quot;</span></span>
<span id="cb296-15"><a href="validate-tree-detection-and-crown-delineation.html#cb296-15" tabindex="-1"></a>      , f_path <span class="sc">%&gt;%</span> <span class="fu">basename</span>() <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(<span class="st">&quot;</span><span class="sc">\\</span><span class="st">.(laz|las)$&quot;</span>)</span>
<span id="cb296-16"><a href="validate-tree-detection-and-crown-delineation.html#cb296-16" tabindex="-1"></a>    )</span>
<span id="cb296-17"><a href="validate-tree-detection-and-crown-delineation.html#cb296-17" tabindex="-1"></a>    , <span class="at">data_type =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb296-18"><a href="validate-tree-detection-and-crown-delineation.html#cb296-18" tabindex="-1"></a>      split <span class="sc">==</span> <span class="st">&quot;dev&quot;</span> <span class="sc">~</span> <span class="st">&quot;training&quot;</span></span>
<span id="cb296-19"><a href="validate-tree-detection-and-crown-delineation.html#cb296-19" tabindex="-1"></a>      , split <span class="sc">==</span> <span class="st">&quot;test&quot;</span> <span class="sc">~</span> <span class="st">&quot;evaluation&quot;</span></span>
<span id="cb296-20"><a href="validate-tree-detection-and-crown-delineation.html#cb296-20" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> <span class="fu">as.factor</span>()</span>
<span id="cb296-21"><a href="validate-tree-detection-and-crown-delineation.html#cb296-21" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb296-22"><a href="validate-tree-detection-and-crown-delineation.html#cb296-22" tabindex="-1"></a>  <span class="co"># we need to figure out where the tree level data resides</span></span>
<span id="cb296-23"><a href="validate-tree-detection-and-crown-delineation.html#cb296-23" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb296-24"><a href="validate-tree-detection-and-crown-delineation.html#cb296-24" tabindex="-1"></a>    <span class="fu">list.files</span>(</span>
<span id="cb296-25"><a href="validate-tree-detection-and-crown-delineation.html#cb296-25" tabindex="-1"></a>        <span class="st">&quot;../data/FORinstance_dataset&quot;</span></span>
<span id="cb296-26"><a href="validate-tree-detection-and-crown-delineation.html#cb296-26" tabindex="-1"></a>        , <span class="at">pattern =</span> <span class="st">&quot;tree_data_.*</span><span class="sc">\\</span><span class="st">.csv$&quot;</span></span>
<span id="cb296-27"><a href="validate-tree-detection-and-crown-delineation.html#cb296-27" tabindex="-1"></a>        , <span class="at">full.names =</span> T, <span class="at">recursive =</span> T</span>
<span id="cb296-28"><a href="validate-tree-detection-and-crown-delineation.html#cb296-28" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb296-29"><a href="validate-tree-detection-and-crown-delineation.html#cb296-29" tabindex="-1"></a>      <span class="fu">normalizePath</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb296-30"><a href="validate-tree-detection-and-crown-delineation.html#cb296-30" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb296-31"><a href="validate-tree-detection-and-crown-delineation.html#cb296-31" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">tree_data =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb296-32"><a href="validate-tree-detection-and-crown-delineation.html#cb296-32" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">siteID =</span> <span class="fu">dirname</span>(tree_data) <span class="sc">%&gt;%</span> <span class="fu">word</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="at">sep =</span> <span class="st">&quot;/&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb296-33"><a href="validate-tree-detection-and-crown-delineation.html#cb296-33" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">group_by</span>(siteID) <span class="sc">%&gt;%</span> </span>
<span id="cb296-34"><a href="validate-tree-detection-and-crown-delineation.html#cb296-34" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(dplyr<span class="sc">::</span><span class="fu">row_number</span>()<span class="sc">==</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb296-35"><a href="validate-tree-detection-and-crown-delineation.html#cb296-35" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">ungroup</span>()</span>
<span id="cb296-36"><a href="validate-tree-detection-and-crown-delineation.html#cb296-36" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;siteID&quot;</span></span>
<span id="cb296-37"><a href="validate-tree-detection-and-crown-delineation.html#cb296-37" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb296-38"><a href="validate-tree-detection-and-crown-delineation.html#cb296-38" tabindex="-1"></a>  <span class="co"># filter for the conifer sites</span></span>
<span id="cb296-39"><a href="validate-tree-detection-and-crown-delineation.html#cb296-39" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(siteID <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;NIBIO&quot;</span>,<span class="st">&quot;CULS&quot;</span>,<span class="st">&quot;SCION&quot;</span>) )</span>
<span id="cb296-40"><a href="validate-tree-detection-and-crown-delineation.html#cb296-40" tabindex="-1"></a><span class="co"># what is this?</span></span>
<span id="cb296-41"><a href="validate-tree-detection-and-crown-delineation.html#cb296-41" tabindex="-1"></a>fi_lidar_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 28
## Columns: 9
## $ path      &lt;chr&gt; &quot;CULS/plot_1_annotated.las&quot;, &quot;CULS/plot_2_annotated.las&quot;, &quot;C…
## $ folder    &lt;chr&gt; &quot;CULS&quot;, &quot;CULS&quot;, &quot;CULS&quot;, &quot;NIBIO&quot;, &quot;NIBIO&quot;, &quot;NIBIO&quot;, &quot;NIBIO&quot;, …
## $ split     &lt;chr&gt; &quot;dev&quot;, &quot;test&quot;, &quot;dev&quot;, &quot;test&quot;, &quot;dev&quot;, &quot;dev&quot;, &quot;dev&quot;, &quot;dev&quot;, &quot;d…
## $ f_path    &lt;chr&gt; &quot;C:\\Data\\usfs\\lidar_phys_fire_mods\\data\\FORinstance_dat…
## $ siteID    &lt;chr&gt; &quot;CULS&quot;, &quot;CULS&quot;, &quot;CULS&quot;, &quot;NIBIO&quot;, &quot;NIBIO&quot;, &quot;NIBIO&quot;, &quot;NIBIO&quot;, …
## $ plotID    &lt;dbl&gt; 1, 2, 3, 1, 10, 11, 12, 13, 16, 17, 18, 19, 2, 21, 22, 23, 3…
## $ plot_name &lt;chr&gt; &quot;CULS_plot_1_annotated&quot;, &quot;CULS_plot_2_annotated&quot;, &quot;CULS_plot…
## $ data_type &lt;fct&gt; training, evaluation, training, evaluation, training, traini…
## $ tree_data &lt;chr&gt; &quot;C:\\Data\\usfs\\lidar_phys_fire_mods\\data\\FORinstance_dat…</code></pre>
<p>looks good. let’s load in an example file and look at what it has</p>
<div class="sourceCode" id="cb298"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb298-1"><a href="validate-tree-detection-and-crown-delineation.html#cb298-1" tabindex="-1"></a>las_temp <span class="ot">&lt;-</span></span>
<span id="cb298-2"><a href="validate-tree-detection-and-crown-delineation.html#cb298-2" tabindex="-1"></a>  fi_lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb298-3"><a href="validate-tree-detection-and-crown-delineation.html#cb298-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(data_type<span class="sc">==</span><span class="st">&quot;training&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb298-4"><a href="validate-tree-detection-and-crown-delineation.html#cb298-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice</span>(<span class="dv">17</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb298-5"><a href="validate-tree-detection-and-crown-delineation.html#cb298-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(f_path) <span class="sc">%&gt;%</span> </span>
<span id="cb298-6"><a href="validate-tree-detection-and-crown-delineation.html#cb298-6" tabindex="-1"></a>  lidR<span class="sc">::</span><span class="fu">readLAS</span>()</span>
<span id="cb298-7"><a href="validate-tree-detection-and-crown-delineation.html#cb298-7" tabindex="-1"></a><span class="co"># what?</span></span>
<span id="cb298-8"><a href="validate-tree-detection-and-crown-delineation.html#cb298-8" tabindex="-1"></a>las_temp</span></code></pre></div>
<pre><code>## class        : LAS (v1.2 format 2)
## memory       : 194.4 Mb 
## extent       : 1886455, 1886488, 5771811, 5771843 (xmin, xmax, ymin, ymax)
## coord. ref.  : NZGD2000 / New Zealand Transverse Mercator 2000 
## area         : 719 m²
## points       : 3.18 million points
## density      : 4428.73 points/m²
## density      : 3055.68 pulses/m²</code></pre>
<p>that is a dense point cloud compared to the ALS data we used in the Weinstein et al. (<a href="https://scholar.google.com/scholar?cluster=4986448711981898434&amp;hl=en&amp;as_sdt=0,6">2021</a>) benchmark</p>
<p>Let’s see if the point cloud data has attributes attached. Puliti et al. <a href="https://doi.org/10.48550/arXiv.2309.01279">(2023)</a> note that:</p>
<blockquote>
<p>The tree unique identifier was stored as an additional treeID column in the .las files. The annotation was performed for all trees where the stem was visible in the point cloud. Hence, small trees in the understory were assigned to a low vegetation class (see step 2 semantic annotation). Trees outside the plot boundaries were not annotated but retained and assigned to the out-points class (see step 2 semantic annotation). In addition to any other point that did not represent a tree (e.g. ground), these points were assigned a treeID = 0. (p. 8)</p>
</blockquote>
<div class="sourceCode" id="cb300"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb300-1"><a href="validate-tree-detection-and-crown-delineation.html#cb300-1" tabindex="-1"></a>las_temp <span class="sc">%&gt;%</span> </span>
<span id="cb300-2"><a href="validate-tree-detection-and-crown-delineation.html#cb300-2" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">pluck</span>(<span class="st">&quot;data&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb300-3"><a href="validate-tree-detection-and-crown-delineation.html#cb300-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 3,184,258
## Columns: 20
## $ X                 &lt;dbl&gt; 1886475, 1886475, 1886475, 1886475, 1886475, 1886475…
## $ Y                 &lt;dbl&gt; 5771819, 5771819, 5771819, 5771819, 5771819, 5771819…
## $ Z                 &lt;dbl&gt; 30.041, 30.171, 30.364, 30.504, 30.041, 30.207, 30.3…
## $ Intensity         &lt;int&gt; 187, 182, 188, 186, 175, 190, 182, 197, 186, 183, 15…
## $ ReturnNumber      &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
## $ NumberOfReturns   &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 1, 2, 2, 1, 1, 1…
## $ ScanDirectionFlag &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ EdgeOfFlightline  &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ Classification    &lt;int&gt; 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4…
## $ Synthetic_flag    &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FAL…
## $ Keypoint_flag     &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FAL…
## $ Withheld_flag     &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FAL…
## $ ScanAngleRank     &lt;int&gt; -42, -42, -43, -43, -42, -42, -43, -43, -40, -40, -4…
## $ UserData          &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ PointSourceID     &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ R                 &lt;int&gt; 65280, 65280, 65280, 65280, 65280, 65280, 65280, 652…
## $ G                 &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ B                 &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ treeID            &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
## $ treeSP            &lt;int&gt; 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4…</code></pre>
<p>look at that <code>treeID</code> attribute, super slick. this particular plot has a small area, let’s plot point cloud and color the points by <code>treeID</code></p>
<div class="sourceCode" id="cb302"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb302-1"><a href="validate-tree-detection-and-crown-delineation.html#cb302-1" tabindex="-1"></a>las_temp <span class="sc">%&gt;%</span> </span>
<span id="cb302-2"><a href="validate-tree-detection-and-crown-delineation.html#cb302-2" tabindex="-1"></a>  lidR<span class="sc">::</span><span class="fu">filter_poi</span>(<span class="sc">!</span><span class="fu">is.na</span>(treeID) <span class="sc">&amp;</span> treeID <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb302-3"><a href="validate-tree-detection-and-crown-delineation.html#cb302-3" tabindex="-1"></a>  lidR<span class="sc">::</span><span class="fu">plot</span>(<span class="at">color =</span> <span class="st">&quot;treeID&quot;</span>, <span class="at">bg =</span> <span class="st">&quot;white&quot;</span>, <span class="at">legend =</span> F)</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-282-1.png" width="1008" /></p>
<p>those sure look like trees \ (^_^) /</p>
<p>one challenge we will face is how to deal with trees that are in the data but not marked as trees because they are out of the plot</p>
<div class="sourceCode" id="cb303"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb303-1"><a href="validate-tree-detection-and-crown-delineation.html#cb303-1" tabindex="-1"></a>las_temp <span class="sc">%&gt;%</span> </span>
<span id="cb303-2"><a href="validate-tree-detection-and-crown-delineation.html#cb303-2" tabindex="-1"></a>  lidR<span class="sc">::</span><span class="fu">add_attribute</span>(</span>
<span id="cb303-3"><a href="validate-tree-detection-and-crown-delineation.html#cb303-3" tabindex="-1"></a>    <span class="fu">ifelse</span>(las_temp<span class="sc">$</span>treeID<span class="sc">==</span><span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb303-4"><a href="validate-tree-detection-and-crown-delineation.html#cb303-4" tabindex="-1"></a>    , <span class="st">&quot;is_tree&quot;</span></span>
<span id="cb303-5"><a href="validate-tree-detection-and-crown-delineation.html#cb303-5" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb303-6"><a href="validate-tree-detection-and-crown-delineation.html#cb303-6" tabindex="-1"></a>  lidR<span class="sc">::</span><span class="fu">filter_poi</span>(<span class="sc">!</span><span class="fu">is.na</span>(treeID)) <span class="sc">%&gt;%</span> </span>
<span id="cb303-7"><a href="validate-tree-detection-and-crown-delineation.html#cb303-7" tabindex="-1"></a>  lidR<span class="sc">::</span><span class="fu">plot</span>(<span class="at">color =</span> <span class="st">&quot;is_tree&quot;</span>, <span class="at">bg =</span> <span class="st">&quot;white&quot;</span>, <span class="at">legend =</span> F)</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-283-1.png" width="1008" /></p>
<p>these non-plot trees shown in blue will be classified with the Classification code of “3” for “out-points”</p>
<div class="sourceCode" id="cb304"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb304-1"><a href="validate-tree-detection-and-crown-delineation.html#cb304-1" tabindex="-1"></a>las_temp <span class="sc">%&gt;%</span> </span>
<span id="cb304-2"><a href="validate-tree-detection-and-crown-delineation.html#cb304-2" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">pluck</span>(<span class="st">&quot;data&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb304-3"><a href="validate-tree-detection-and-crown-delineation.html#cb304-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(Classification)</span></code></pre></div>
<pre><code>##    Classification       n
##             &lt;int&gt;   &lt;int&gt;
## 1:              1   87396
## 2:              2  161183
## 3:              3  774180
## 4:              4   50163
## 5:              5 1879490
## 6:              6  231846</code></pre>
<table>
<thead>
<tr class="header">
<th>Classification</th>
<th>Class Name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>Unclassified</td>
</tr>
<tr class="even">
<td>1</td>
<td>Low-vegetation</td>
</tr>
<tr class="odd">
<td>2</td>
<td>Terrain</td>
</tr>
<tr class="even">
<td>3</td>
<td>Out-points</td>
</tr>
<tr class="odd">
<td>4</td>
<td>Stem</td>
</tr>
<tr class="even">
<td>5</td>
<td>Live branches</td>
</tr>
<tr class="odd">
<td>6</td>
<td>Woody branches</td>
</tr>
</tbody>
</table>
<p>we will use the Classification code of “3” for “out-points” to mask our <code>cloud2trees</code> results in post-processing so that they don’t count against us for precision.</p>
<p>Since the individual tree segmentation from Puliti et al. <a href="https://doi.org/10.48550/arXiv.2309.01279">(2023)</a> resides in the point cloud data only, we will need to transform the 3D point cloud into 2D representations of the tree crown. Let’s make a quick function to do this so that we can compare tree crown polygons from the benchmark to our <code>cloud2trees</code> tree crown polygons. This will allow us to perform “instance segmentation evaluation” whereby we assess the ability of our method to correctly identify and delineate individual trees.</p>
<p>we’ll want to use the FOR-instance point cloud as input and return: 1) tree crown polygons; 2) polygons of areas outside of the plot to mask</p>
<div class="sourceCode" id="cb306"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb306-1"><a href="validate-tree-detection-and-crown-delineation.html#cb306-1" tabindex="-1"></a><span class="co"># .stdtreemetrics from lidR does not return min(z)</span></span>
<span id="cb306-2"><a href="validate-tree-detection-and-crown-delineation.html#cb306-2" tabindex="-1"></a>stdtreemetrics_new <span class="ot">=</span> <span class="cf">function</span>(x, y, z){</span>
<span id="cb306-3"><a href="validate-tree-detection-and-crown-delineation.html#cb306-3" tabindex="-1"></a>  metrics <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb306-4"><a href="validate-tree-detection-and-crown-delineation.html#cb306-4" tabindex="-1"></a>    <span class="at">max_z =</span> <span class="fu">max</span>(z),</span>
<span id="cb306-5"><a href="validate-tree-detection-and-crown-delineation.html#cb306-5" tabindex="-1"></a>    <span class="at">min_z =</span> <span class="fu">min</span>(z),</span>
<span id="cb306-6"><a href="validate-tree-detection-and-crown-delineation.html#cb306-6" tabindex="-1"></a>    <span class="at">npoints =</span> <span class="fu">length</span>(x)</span>
<span id="cb306-7"><a href="validate-tree-detection-and-crown-delineation.html#cb306-7" tabindex="-1"></a>  )</span>
<span id="cb306-8"><a href="validate-tree-detection-and-crown-delineation.html#cb306-8" tabindex="-1"></a>  <span class="fu">return</span>(metrics)</span>
<span id="cb306-9"><a href="validate-tree-detection-and-crown-delineation.html#cb306-9" tabindex="-1"></a>}</span>
<span id="cb306-10"><a href="validate-tree-detection-and-crown-delineation.html#cb306-10" tabindex="-1"></a><span class="co"># pass a las, return some polygons with metrics</span></span>
<span id="cb306-11"><a href="validate-tree-detection-and-crown-delineation.html#cb306-11" tabindex="-1"></a>fi_las_to_poly <span class="ot">&lt;-</span> <span class="cf">function</span>(las,<span class="at">res=</span><span class="fl">0.25</span>,<span class="at">smooth=</span>T) {</span>
<span id="cb306-12"><a href="validate-tree-detection-and-crown-delineation.html#cb306-12" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(las,<span class="st">&quot;LAS&quot;</span>)){<span class="fu">stop</span>(<span class="st">&quot;must be LAS class&quot;</span>)}</span>
<span id="cb306-13"><a href="validate-tree-detection-and-crown-delineation.html#cb306-13" tabindex="-1"></a>  <span class="co"># get the mask using out of plot points these areas will be removed from both</span></span>
<span id="cb306-14"><a href="validate-tree-detection-and-crown-delineation.html#cb306-14" tabindex="-1"></a>  <span class="co"># the ground truth crowns and our estimated crowns</span></span>
<span id="cb306-15"><a href="validate-tree-detection-and-crown-delineation.html#cb306-15" tabindex="-1"></a>  mask <span class="ot">&lt;-</span> las <span class="sc">%&gt;%</span> </span>
<span id="cb306-16"><a href="validate-tree-detection-and-crown-delineation.html#cb306-16" tabindex="-1"></a>    lidR<span class="sc">::</span><span class="fu">filter_poi</span>(Classification <span class="sc">==</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb306-17"><a href="validate-tree-detection-and-crown-delineation.html#cb306-17" tabindex="-1"></a>    lidR<span class="sc">::</span><span class="fu">pixel_metrics</span>(<span class="at">fun =</span> <span class="fu">max</span>(<span class="sc">!</span>treeID), <span class="at">res =</span> res)</span>
<span id="cb306-18"><a href="validate-tree-detection-and-crown-delineation.html#cb306-18" tabindex="-1"></a>  <span class="cf">if</span>(smooth){</span>
<span id="cb306-19"><a href="validate-tree-detection-and-crown-delineation.html#cb306-19" tabindex="-1"></a>    mask <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">focal</span>(</span>
<span id="cb306-20"><a href="validate-tree-detection-and-crown-delineation.html#cb306-20" tabindex="-1"></a>      mask</span>
<span id="cb306-21"><a href="validate-tree-detection-and-crown-delineation.html#cb306-21" tabindex="-1"></a>      , <span class="at">w =</span> <span class="dv">3</span></span>
<span id="cb306-22"><a href="validate-tree-detection-and-crown-delineation.html#cb306-22" tabindex="-1"></a>      , <span class="at">fun =</span> <span class="st">&quot;max&quot;</span></span>
<span id="cb306-23"><a href="validate-tree-detection-and-crown-delineation.html#cb306-23" tabindex="-1"></a>      , <span class="at">na.rm =</span> T</span>
<span id="cb306-24"><a href="validate-tree-detection-and-crown-delineation.html#cb306-24" tabindex="-1"></a>      <span class="co"># na.policy Must be one of:</span></span>
<span id="cb306-25"><a href="validate-tree-detection-and-crown-delineation.html#cb306-25" tabindex="-1"></a>        <span class="co"># &quot;all&quot; (compute for all cells)</span></span>
<span id="cb306-26"><a href="validate-tree-detection-and-crown-delineation.html#cb306-26" tabindex="-1"></a>        <span class="co"># , &quot;only&quot; (only for cells that are NA)</span></span>
<span id="cb306-27"><a href="validate-tree-detection-and-crown-delineation.html#cb306-27" tabindex="-1"></a>        <span class="co"># , or &quot;omit&quot; (skip cells that are NA).</span></span>
<span id="cb306-28"><a href="validate-tree-detection-and-crown-delineation.html#cb306-28" tabindex="-1"></a>      , <span class="at">na.policy =</span> <span class="st">&quot;only&quot;</span></span>
<span id="cb306-29"><a href="validate-tree-detection-and-crown-delineation.html#cb306-29" tabindex="-1"></a>    )</span>
<span id="cb306-30"><a href="validate-tree-detection-and-crown-delineation.html#cb306-30" tabindex="-1"></a>  }</span>
<span id="cb306-31"><a href="validate-tree-detection-and-crown-delineation.html#cb306-31" tabindex="-1"></a>  <span class="co"># raster mask to polygons</span></span>
<span id="cb306-32"><a href="validate-tree-detection-and-crown-delineation.html#cb306-32" tabindex="-1"></a>   mask <span class="ot">&lt;-</span> mask <span class="sc">%&gt;%</span> </span>
<span id="cb306-33"><a href="validate-tree-detection-and-crown-delineation.html#cb306-33" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">as.polygons</span>(<span class="at">aggregate =</span> T, <span class="at">na.rm =</span> T, <span class="at">crs =</span> lidR<span class="sc">::</span><span class="fu">crs</span>(las)) <span class="sc">%&gt;%</span> </span>
<span id="cb306-34"><a href="validate-tree-detection-and-crown-delineation.html#cb306-34" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_as_sf</span>()</span>
<span id="cb306-35"><a href="validate-tree-detection-and-crown-delineation.html#cb306-35" tabindex="-1"></a>  <span class="co"># tree crown polygons</span></span>
<span id="cb306-36"><a href="validate-tree-detection-and-crown-delineation.html#cb306-36" tabindex="-1"></a>  crowns <span class="ot">&lt;-</span> </span>
<span id="cb306-37"><a href="validate-tree-detection-and-crown-delineation.html#cb306-37" tabindex="-1"></a>    las <span class="sc">%&gt;%</span> </span>
<span id="cb306-38"><a href="validate-tree-detection-and-crown-delineation.html#cb306-38" tabindex="-1"></a>    lidR<span class="sc">::</span><span class="fu">filter_poi</span>(<span class="sc">!</span><span class="fu">is.na</span>(treeID) <span class="sc">&amp;</span> treeID <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb306-39"><a href="validate-tree-detection-and-crown-delineation.html#cb306-39" tabindex="-1"></a>    <span class="co"># lidR::crown_metrics(func = .stdtreemetrics, attribute = &quot;treeID&quot;, geom = &quot;concave&quot;) %&gt;% </span></span>
<span id="cb306-40"><a href="validate-tree-detection-and-crown-delineation.html#cb306-40" tabindex="-1"></a>    lidR<span class="sc">::</span><span class="fu">crown_metrics</span>(<span class="at">func =</span> <span class="sc">~</span><span class="fu">stdtreemetrics_new</span>(X, Y, Z), <span class="at">attribute =</span> <span class="st">&quot;treeID&quot;</span>, <span class="at">geom =</span> <span class="st">&quot;concave&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb306-41"><a href="validate-tree-detection-and-crown-delineation.html#cb306-41" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb306-42"><a href="validate-tree-detection-and-crown-delineation.html#cb306-42" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">gt_tree_height =</span> max_z <span class="sc">-</span> min_z) <span class="sc">%&gt;%</span> </span>
<span id="cb306-43"><a href="validate-tree-detection-and-crown-delineation.html#cb306-43" tabindex="-1"></a>    <span class="co"># sf::st_difference(mask) %&gt;% # to be consistent we</span></span>
<span id="cb306-44"><a href="validate-tree-detection-and-crown-delineation.html#cb306-44" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(treeID,gt_tree_height)</span>
<span id="cb306-45"><a href="validate-tree-detection-and-crown-delineation.html#cb306-45" tabindex="-1"></a>  <span class="co"># return</span></span>
<span id="cb306-46"><a href="validate-tree-detection-and-crown-delineation.html#cb306-46" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb306-47"><a href="validate-tree-detection-and-crown-delineation.html#cb306-47" tabindex="-1"></a>    <span class="at">crowns =</span> crowns</span>
<span id="cb306-48"><a href="validate-tree-detection-and-crown-delineation.html#cb306-48" tabindex="-1"></a>    , <span class="at">mask =</span> mask</span>
<span id="cb306-49"><a href="validate-tree-detection-and-crown-delineation.html#cb306-49" tabindex="-1"></a>  ))</span>
<span id="cb306-50"><a href="validate-tree-detection-and-crown-delineation.html#cb306-50" tabindex="-1"></a>}</span></code></pre></div>
<p>let’s see if this function gets us 1) tree crown polygons; 2) polygons of areas outside of the plot to mask</p>
<div class="sourceCode" id="cb307"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb307-1"><a href="validate-tree-detection-and-crown-delineation.html#cb307-1" tabindex="-1"></a>polys_temp <span class="ot">&lt;-</span> <span class="fu">fi_las_to_poly</span>(<span class="at">las =</span> las_temp,<span class="at">res=</span><span class="fl">0.1</span>,<span class="at">smooth =</span> F)</span>
<span id="cb307-2"><a href="validate-tree-detection-and-crown-delineation.html#cb307-2" tabindex="-1"></a><span class="co"># plot it</span></span>
<span id="cb307-3"><a href="validate-tree-detection-and-crown-delineation.html#cb307-3" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb307-4"><a href="validate-tree-detection-and-crown-delineation.html#cb307-4" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> polys_temp<span class="sc">$</span>mask, <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> <span class="st">&quot;mask&quot;</span>), <span class="at">color =</span> <span class="cn">NA</span>,<span class="at">alpha=</span><span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb307-5"><a href="validate-tree-detection-and-crown-delineation.html#cb307-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> polys_temp<span class="sc">$</span>crowns, <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> <span class="st">&quot;crowns&quot;</span>), <span class="at">color =</span> <span class="cn">NA</span>,<span class="at">alpha=</span><span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb307-6"><a href="validate-tree-detection-and-crown-delineation.html#cb307-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;forestgreen&quot;</span>,<span class="st">&quot;gray11&quot;</span>), <span class="at">name =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb307-7"><a href="validate-tree-detection-and-crown-delineation.html#cb307-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-287-1.png" width="1008" /></p>
<p>Neat. In a real-world forest canopy tree crowns overlap, for example, where shorter trees are partially or entirely under the crown of taller trees. We want to ensure that we are allowing for this overlap because it represents reality. This will penalize the 2D crown-delineation process implemented in <code>cloud2trees</code> during evaluation since it does not capture this overlap. There are overlapping crowns in this plot and our 2D crown polygon representation that we’ll use for instance segmentation evaluation appropriately reflects reality (darker green areas show individual tree crowns overlapping)</p>
</div>
<div id="ex_valid2" class="section level3 hasAnchor" number="4.3.2">
<h3><span class="header-section-number">4.3.2</span> Example validation process<a href="validate-tree-detection-and-crown-delineation.html#ex_valid2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Puliti et al. <a href="https://doi.org/10.48550/arXiv.2309.01279">(2023, p. 14)</a> provide guidance on performing “instance segmentation evaluation” whereby we assess the ability of our method to correctly identify and delineate individual trees</p>
<blockquote>
<p>The first step in performing any instance segmentation evaluation is to match the point cloud reference and predicted instance IDs. To do this, it is necessary to define whether a prediction is correct. Here we adopt a method Wielgosz et al. (2023) proposed for matching tree instance IDs from two point clouds with reference and predicted instance IDs, respectively. Given a reference and a predicted point cloud with two separate sets of instances, the tree instances are iteratively matched in descending order from the tallest to the shortest trees by using the following algorithm:</p>
</blockquote>
<ol style="list-style-type: lower-alpha">
<li>Find the tallest tree in the reference data;</li>
<li>Find the tree in the predicted instances that have the largest intersection over union (IoU) with the tree selected in the previous step;</li>
<li>if the IoU is &lt;0.5: the predicted tree is considered an error, and thus no reference instance ID is available;</li>
<li>if the IoU is ≥0.5: the tree is considered a correct match, and assign reference instance ID label to the predicted tree;</li>
<li>Add to collection (dictionary) of predicted tree instances with IDs matching the reference instance IDs.</li>
</ol>
<p>Following the initial matching of reference and predicted instance IDs, the evaluation can be done on the tree level to evaluate detection, omission, and commission rates (which can be used to calculate precision, recall, and the F-score metric)</p>
<div id="cloud2treescloud2trees-1" class="section level4 hasAnchor" number="4.3.2.1">
<h4><span class="header-section-number">4.3.2.1</span> <code>cloud2trees::cloud2trees()</code><a href="validate-tree-detection-and-crown-delineation.html#cloud2treescloud2trees-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>for our example, we’ll use all default settings in <code>cloud2trees::cloud2trees()</code> to get a point cloud-detected tree list</p>
<div class="sourceCode" id="cb308"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb308-1"><a href="validate-tree-detection-and-crown-delineation.html#cb308-1" tabindex="-1"></a>lidar_df_row_temp <span class="ot">&lt;-</span></span>
<span id="cb308-2"><a href="validate-tree-detection-and-crown-delineation.html#cb308-2" tabindex="-1"></a>  fi_lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb308-3"><a href="validate-tree-detection-and-crown-delineation.html#cb308-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb308-4"><a href="validate-tree-detection-and-crown-delineation.html#cb308-4" tabindex="-1"></a>    <span class="at">rn =</span> <span class="fu">ifelse</span>(</span>
<span id="cb308-5"><a href="validate-tree-detection-and-crown-delineation.html#cb308-5" tabindex="-1"></a>      data_type<span class="sc">==</span><span class="st">&quot;training&quot;</span></span>
<span id="cb308-6"><a href="validate-tree-detection-and-crown-delineation.html#cb308-6" tabindex="-1"></a>      ,dplyr<span class="sc">::</span><span class="fu">row_number</span>()</span>
<span id="cb308-7"><a href="validate-tree-detection-and-crown-delineation.html#cb308-7" tabindex="-1"></a>      ,<span class="cn">NA</span></span>
<span id="cb308-8"><a href="validate-tree-detection-and-crown-delineation.html#cb308-8" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span> </span>
<span id="cb308-9"><a href="validate-tree-detection-and-crown-delineation.html#cb308-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(rn)) <span class="sc">%&gt;%</span> </span>
<span id="cb308-10"><a href="validate-tree-detection-and-crown-delineation.html#cb308-10" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice</span>(<span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb308-11"><a href="validate-tree-detection-and-crown-delineation.html#cb308-11" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(rn)</span></code></pre></div>
<p>look at the point cloud</p>
<div class="sourceCode" id="cb309"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb309-1"><a href="validate-tree-detection-and-crown-delineation.html#cb309-1" tabindex="-1"></a>fi_lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb309-2"><a href="validate-tree-detection-and-crown-delineation.html#cb309-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice</span>(lidar_df_row_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb309-3"><a href="validate-tree-detection-and-crown-delineation.html#cb309-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(f_path) <span class="sc">%&gt;%</span> </span>
<span id="cb309-4"><a href="validate-tree-detection-and-crown-delineation.html#cb309-4" tabindex="-1"></a>  lidR<span class="sc">::</span><span class="fu">readLAS</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb309-5"><a href="validate-tree-detection-and-crown-delineation.html#cb309-5" tabindex="-1"></a>  lidR<span class="sc">::</span><span class="fu">filter_poi</span>(<span class="sc">!</span><span class="fu">is.na</span>(treeID) <span class="sc">&amp;</span> treeID <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb309-6"><a href="validate-tree-detection-and-crown-delineation.html#cb309-6" tabindex="-1"></a>  lidR<span class="sc">::</span><span class="fu">plot</span>(<span class="at">color =</span> <span class="st">&quot;treeID&quot;</span>, <span class="at">bg =</span> <span class="st">&quot;white&quot;</span>, <span class="at">legend =</span> F)</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-290-1.png" width="1008" /></p>
<p>extract trees using our <code>cloud2trees::cloud2trees()</code> process</p>
<div class="sourceCode" id="cb310"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb310-1"><a href="validate-tree-detection-and-crown-delineation.html#cb310-1" tabindex="-1"></a><span class="co"># c2t</span></span>
<span id="cb310-2"><a href="validate-tree-detection-and-crown-delineation.html#cb310-2" tabindex="-1"></a>ans <span class="ot">&lt;-</span> cloud2trees<span class="sc">::</span><span class="fu">cloud2trees</span>(</span>
<span id="cb310-3"><a href="validate-tree-detection-and-crown-delineation.html#cb310-3" tabindex="-1"></a>  <span class="at">input_las_dir =</span> fi_lidar_df<span class="sc">$</span>f_path[lidar_df_row_temp]</span>
<span id="cb310-4"><a href="validate-tree-detection-and-crown-delineation.html#cb310-4" tabindex="-1"></a>  , <span class="at">output_dir =</span> <span class="fu">tempdir</span>()</span>
<span id="cb310-5"><a href="validate-tree-detection-and-crown-delineation.html#cb310-5" tabindex="-1"></a>)</span>
<span id="cb310-6"><a href="validate-tree-detection-and-crown-delineation.html#cb310-6" tabindex="-1"></a><span class="co"># simplify multipolygon crowns</span></span>
<span id="cb310-7"><a href="validate-tree-detection-and-crown-delineation.html#cb310-7" tabindex="-1"></a>ans_crowns <span class="ot">&lt;-</span> cloud2trees<span class="sc">::</span><span class="fu">simplify_multipolygon_crowns</span>(ans<span class="sc">$</span>crowns_sf)</span></code></pre></div>
<p>check out our extracted trees on the CHM</p>
<div class="sourceCode" id="cb311"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb311-1"><a href="validate-tree-detection-and-crown-delineation.html#cb311-1" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb311-2"><a href="validate-tree-detection-and-crown-delineation.html#cb311-2" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_tile</span>(</span>
<span id="cb311-3"><a href="validate-tree-detection-and-crown-delineation.html#cb311-3" tabindex="-1"></a>    <span class="at">data =</span> ans<span class="sc">$</span>chm_rast <span class="sc">%&gt;%</span></span>
<span id="cb311-4"><a href="validate-tree-detection-and-crown-delineation.html#cb311-4" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">as.data.frame</span>(<span class="at">xy=</span>T) <span class="sc">%&gt;%</span></span>
<span id="cb311-5"><a href="validate-tree-detection-and-crown-delineation.html#cb311-5" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">f=</span><span class="dv">3</span>)</span>
<span id="cb311-6"><a href="validate-tree-detection-and-crown-delineation.html#cb311-6" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">fill =</span> f)</span>
<span id="cb311-7"><a href="validate-tree-detection-and-crown-delineation.html#cb311-7" tabindex="-1"></a>    , <span class="at">na.rm =</span> T</span>
<span id="cb311-8"><a href="validate-tree-detection-and-crown-delineation.html#cb311-8" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb311-9"><a href="validate-tree-detection-and-crown-delineation.html#cb311-9" tabindex="-1"></a>  harrypotter<span class="sc">::</span><span class="fu">scale_fill_hp</span>(</span>
<span id="cb311-10"><a href="validate-tree-detection-and-crown-delineation.html#cb311-10" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">&quot;gryffindor&quot;</span></span>
<span id="cb311-11"><a href="validate-tree-detection-and-crown-delineation.html#cb311-11" tabindex="-1"></a>    , <span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_extended</span>(<span class="at">n=</span><span class="dv">10</span>)</span>
<span id="cb311-12"><a href="validate-tree-detection-and-crown-delineation.html#cb311-12" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb311-13"><a href="validate-tree-detection-and-crown-delineation.html#cb311-13" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb311-14"><a href="validate-tree-detection-and-crown-delineation.html#cb311-14" tabindex="-1"></a>    <span class="at">data =</span> ans_crowns</span>
<span id="cb311-15"><a href="validate-tree-detection-and-crown-delineation.html#cb311-15" tabindex="-1"></a>    , <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">&quot;gray44&quot;</span>, <span class="at">lwd =</span> <span class="fl">1.2</span></span>
<span id="cb311-16"><a href="validate-tree-detection-and-crown-delineation.html#cb311-16" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb311-17"><a href="validate-tree-detection-and-crown-delineation.html#cb311-17" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span>, <span class="at">fill =</span> <span class="st">&quot;CHM (m)&quot;</span>) <span class="sc">+</span></span>
<span id="cb311-18"><a href="validate-tree-detection-and-crown-delineation.html#cb311-18" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb311-19"><a href="validate-tree-detection-and-crown-delineation.html#cb311-19" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">axis.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-292-1.png" width="1008" /></p>
</div>
<div id="comparison-with-ground-truth" class="section level4 hasAnchor" number="4.3.2.2">
<h4><span class="header-section-number">4.3.2.2</span> Comparison with ground truth<a href="validate-tree-detection-and-crown-delineation.html#comparison-with-ground-truth" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>check out the crown polygons from the ground truth data and we’ll match the resolution to the <code>cloud2trees::cloud2trees()</code> setting</p>
<div class="sourceCode" id="cb312"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb312-1"><a href="validate-tree-detection-and-crown-delineation.html#cb312-1" tabindex="-1"></a>ground_truth_temp <span class="ot">&lt;-</span> fi_lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb312-2"><a href="validate-tree-detection-and-crown-delineation.html#cb312-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice</span>(lidar_df_row_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb312-3"><a href="validate-tree-detection-and-crown-delineation.html#cb312-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(f_path) <span class="sc">%&gt;%</span> </span>
<span id="cb312-4"><a href="validate-tree-detection-and-crown-delineation.html#cb312-4" tabindex="-1"></a>  lidR<span class="sc">::</span><span class="fu">readLAS</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb312-5"><a href="validate-tree-detection-and-crown-delineation.html#cb312-5" tabindex="-1"></a>  <span class="fu">fi_las_to_poly</span>(<span class="at">res =</span> <span class="fl">0.25</span>,<span class="at">smooth =</span> T)</span>
<span id="cb312-6"><a href="validate-tree-detection-and-crown-delineation.html#cb312-6" tabindex="-1"></a><span class="co"># plot it</span></span>
<span id="cb312-7"><a href="validate-tree-detection-and-crown-delineation.html#cb312-7" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb312-8"><a href="validate-tree-detection-and-crown-delineation.html#cb312-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> ground_truth_temp<span class="sc">$</span>mask, <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> <span class="st">&quot;mask&quot;</span>), <span class="at">color =</span> <span class="cn">NA</span>,<span class="at">alpha=</span><span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb312-9"><a href="validate-tree-detection-and-crown-delineation.html#cb312-9" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> ground_truth_temp<span class="sc">$</span>crowns, <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> <span class="st">&quot;crowns&quot;</span>), <span class="at">color =</span> <span class="cn">NA</span>,<span class="at">alpha=</span><span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb312-10"><a href="validate-tree-detection-and-crown-delineation.html#cb312-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;forestgreen&quot;</span>,<span class="st">&quot;gray11&quot;</span>), <span class="at">name =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb312-11"><a href="validate-tree-detection-and-crown-delineation.html#cb312-11" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-293-1.png" width="1008" /></p>
<p>we’ll implement a rule to remove the entire crown from our predicted data if &gt;= 70% of it’s area is masked</p>
<div class="sourceCode" id="cb313"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb313-1"><a href="validate-tree-detection-and-crown-delineation.html#cb313-1" tabindex="-1"></a><span class="co"># remove trees with &gt;70% overlap with mask</span></span>
<span id="cb313-2"><a href="validate-tree-detection-and-crown-delineation.html#cb313-2" tabindex="-1"></a>ans_crowns_no_mask <span class="ot">&lt;-</span></span>
<span id="cb313-3"><a href="validate-tree-detection-and-crown-delineation.html#cb313-3" tabindex="-1"></a>  ans_crowns <span class="sc">%&gt;%</span> </span>
<span id="cb313-4"><a href="validate-tree-detection-and-crown-delineation.html#cb313-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb313-5"><a href="validate-tree-detection-and-crown-delineation.html#cb313-5" tabindex="-1"></a>    <span class="co"># calculate area within mask</span></span>
<span id="cb313-6"><a href="validate-tree-detection-and-crown-delineation.html#cb313-6" tabindex="-1"></a>    ans_crowns <span class="sc">%&gt;%</span> </span>
<span id="cb313-7"><a href="validate-tree-detection-and-crown-delineation.html#cb313-7" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(treeID) <span class="sc">%&gt;%</span> </span>
<span id="cb313-8"><a href="validate-tree-detection-and-crown-delineation.html#cb313-8" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_intersection</span>(ground_truth_temp<span class="sc">$</span>mask) <span class="sc">%&gt;%</span> </span>
<span id="cb313-9"><a href="validate-tree-detection-and-crown-delineation.html#cb313-9" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">mask_area =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb313-10"><a href="validate-tree-detection-and-crown-delineation.html#cb313-10" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb313-11"><a href="validate-tree-detection-and-crown-delineation.html#cb313-11" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(treeID,mask_area)</span>
<span id="cb313-12"><a href="validate-tree-detection-and-crown-delineation.html#cb313-12" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span></span>
<span id="cb313-13"><a href="validate-tree-detection-and-crown-delineation.html#cb313-13" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb313-14"><a href="validate-tree-detection-and-crown-delineation.html#cb313-14" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb313-15"><a href="validate-tree-detection-and-crown-delineation.html#cb313-15" tabindex="-1"></a>    ( dplyr<span class="sc">::</span><span class="fu">coalesce</span>(mask_area,<span class="dv">0</span>)<span class="sc">/</span><span class="fu">as.numeric</span>(sf<span class="sc">::</span><span class="fu">st_area</span>(.)) ) <span class="sc">&lt;</span> <span class="fl">0.7</span></span>
<span id="cb313-16"><a href="validate-tree-detection-and-crown-delineation.html#cb313-16" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb313-17"><a href="validate-tree-detection-and-crown-delineation.html#cb313-17" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>mask_area)</span></code></pre></div>
<p>here are the predicted trees we are left to evaluate compared to the ground truth and the mask</p>
<div class="sourceCode" id="cb314"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb314-1"><a href="validate-tree-detection-and-crown-delineation.html#cb314-1" tabindex="-1"></a><span class="co"># plot it</span></span>
<span id="cb314-2"><a href="validate-tree-detection-and-crown-delineation.html#cb314-2" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb314-3"><a href="validate-tree-detection-and-crown-delineation.html#cb314-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> ground_truth_temp<span class="sc">$</span>mask, <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> <span class="st">&quot;mask&quot;</span>), <span class="at">color =</span> <span class="cn">NA</span>,<span class="at">alpha=</span><span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb314-4"><a href="validate-tree-detection-and-crown-delineation.html#cb314-4" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(<span class="at">data =</span> ground_truth_temp<span class="sc">$</span>crowns, <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> <span class="st">&quot;crowns&quot;</span>), <span class="at">color =</span> <span class="cn">NA</span>,<span class="at">alpha=</span><span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb314-5"><a href="validate-tree-detection-and-crown-delineation.html#cb314-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb314-6"><a href="validate-tree-detection-and-crown-delineation.html#cb314-6" tabindex="-1"></a>    <span class="at">data =</span> ans_crowns <span class="sc">%&gt;%</span> </span>
<span id="cb314-7"><a href="validate-tree-detection-and-crown-delineation.html#cb314-7" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">anti_join</span>(</span>
<span id="cb314-8"><a href="validate-tree-detection-and-crown-delineation.html#cb314-8" tabindex="-1"></a>        ans_crowns_no_mask <span class="sc">%&gt;%</span> </span>
<span id="cb314-9"><a href="validate-tree-detection-and-crown-delineation.html#cb314-9" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb314-10"><a href="validate-tree-detection-and-crown-delineation.html#cb314-10" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(treeID)</span>
<span id="cb314-11"><a href="validate-tree-detection-and-crown-delineation.html#cb314-11" tabindex="-1"></a>        , <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span></span>
<span id="cb314-12"><a href="validate-tree-detection-and-crown-delineation.html#cb314-12" tabindex="-1"></a>      )</span>
<span id="cb314-13"><a href="validate-tree-detection-and-crown-delineation.html#cb314-13" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> <span class="st">&quot;prediction</span><span class="sc">\n</span><span class="st">removed&quot;</span>)</span>
<span id="cb314-14"><a href="validate-tree-detection-and-crown-delineation.html#cb314-14" tabindex="-1"></a>    , <span class="at">alpha =</span> <span class="dv">0</span></span>
<span id="cb314-15"><a href="validate-tree-detection-and-crown-delineation.html#cb314-15" tabindex="-1"></a>    , <span class="at">color =</span> <span class="st">&quot;plum&quot;</span>, <span class="at">lwd =</span> <span class="dv">1</span></span>
<span id="cb314-16"><a href="validate-tree-detection-and-crown-delineation.html#cb314-16" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb314-17"><a href="validate-tree-detection-and-crown-delineation.html#cb314-17" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb314-18"><a href="validate-tree-detection-and-crown-delineation.html#cb314-18" tabindex="-1"></a>    <span class="at">data =</span> ans_crowns_no_mask</span>
<span id="cb314-19"><a href="validate-tree-detection-and-crown-delineation.html#cb314-19" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> <span class="st">&quot;prediction&quot;</span>)</span>
<span id="cb314-20"><a href="validate-tree-detection-and-crown-delineation.html#cb314-20" tabindex="-1"></a>    , <span class="at">alpha =</span> <span class="dv">0</span></span>
<span id="cb314-21"><a href="validate-tree-detection-and-crown-delineation.html#cb314-21" tabindex="-1"></a>    , <span class="at">color =</span> <span class="st">&quot;purple&quot;</span>, <span class="at">lwd =</span> <span class="dv">1</span></span>
<span id="cb314-22"><a href="validate-tree-detection-and-crown-delineation.html#cb314-22" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb314-23"><a href="validate-tree-detection-and-crown-delineation.html#cb314-23" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;forestgreen&quot;</span>,<span class="st">&quot;gray11&quot;</span>,<span class="st">&quot;purple&quot;</span>,<span class="st">&quot;plum&quot;</span>), <span class="at">name =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb314-24"><a href="validate-tree-detection-and-crown-delineation.html#cb314-24" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-295-1.png" width="1008" /></p>
</div>
<div id="prediction-vs-ground-truth-matching" class="section level4 hasAnchor" number="4.3.2.3">
<h4><span class="header-section-number">4.3.2.3</span> Prediction vs ground truth matching<a href="validate-tree-detection-and-crown-delineation.html#prediction-vs-ground-truth-matching" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Given a reference and a predicted point cloud with two separate sets of instances, the tree instances are iteratively matched in descending order from the tallest to the shortest trees by using the following algorithm:</p>
<ol style="list-style-type: lower-alpha">
<li>Find the tallest tree in the reference data;</li>
<li>Find the tree in the predicted instances that have the largest intersection over union (IoU) with the tree selected in the previous step;</li>
<li>if the IoU is &lt;0.5: the predicted tree is considered an error, and thus no reference instance ID is available;</li>
<li>if the IoU is ≥0.5: the tree is considered a correct match, and assign reference instance ID label to the predicted tree;</li>
<li>Add to collection (dictionary) of predicted tree instances with IDs matching the reference instance IDs.</li>
</ol>
<p>to find the tallest tree in the data we need to bring in the tree attributes data</p>
<div class="sourceCode" id="cb315"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb315-1"><a href="validate-tree-detection-and-crown-delineation.html#cb315-1" tabindex="-1"></a>ground_truth_temp<span class="sc">$</span>crowns <span class="ot">&lt;-</span> ground_truth_temp<span class="sc">$</span>crowns <span class="sc">%&gt;%</span> </span>
<span id="cb315-2"><a href="validate-tree-detection-and-crown-delineation.html#cb315-2" tabindex="-1"></a>  <span class="co"># add in tree attribute data</span></span>
<span id="cb315-3"><a href="validate-tree-detection-and-crown-delineation.html#cb315-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb315-4"><a href="validate-tree-detection-and-crown-delineation.html#cb315-4" tabindex="-1"></a>    <span class="co"># read tree data</span></span>
<span id="cb315-5"><a href="validate-tree-detection-and-crown-delineation.html#cb315-5" tabindex="-1"></a>    fi_lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb315-6"><a href="validate-tree-detection-and-crown-delineation.html#cb315-6" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">slice</span>(lidar_df_row_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb315-7"><a href="validate-tree-detection-and-crown-delineation.html#cb315-7" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">pull</span>(tree_data) <span class="sc">%&gt;%</span> </span>
<span id="cb315-8"><a href="validate-tree-detection-and-crown-delineation.html#cb315-8" tabindex="-1"></a>      readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="at">show_col_types =</span> F, <span class="at">progress =</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb315-9"><a href="validate-tree-detection-and-crown-delineation.html#cb315-9" tabindex="-1"></a>      <span class="co"># filter for just the current plot</span></span>
<span id="cb315-10"><a href="validate-tree-detection-and-crown-delineation.html#cb315-10" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb315-11"><a href="validate-tree-detection-and-crown-delineation.html#cb315-11" tabindex="-1"></a>        plotID <span class="sc">==</span> fi_lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb315-12"><a href="validate-tree-detection-and-crown-delineation.html#cb315-12" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">slice</span>(lidar_df_row_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb315-13"><a href="validate-tree-detection-and-crown-delineation.html#cb315-13" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">pull</span>(plotID)</span>
<span id="cb315-14"><a href="validate-tree-detection-and-crown-delineation.html#cb315-14" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb315-15"><a href="validate-tree-detection-and-crown-delineation.html#cb315-15" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">rename_with</span>(<span class="at">.fn =</span> tolower, <span class="at">.cols =</span> <span class="sc">-</span><span class="fu">c</span>(plotID,treeID))</span>
<span id="cb315-16"><a href="validate-tree-detection-and-crown-delineation.html#cb315-16" tabindex="-1"></a>    , <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span></span>
<span id="cb315-17"><a href="validate-tree-detection-and-crown-delineation.html#cb315-17" tabindex="-1"></a>  )</span>
<span id="cb315-18"><a href="validate-tree-detection-and-crown-delineation.html#cb315-18" tabindex="-1"></a><span class="co"># what tree attributes are there?</span></span>
<span id="cb315-19"><a href="validate-tree-detection-and-crown-delineation.html#cb315-19" tabindex="-1"></a>ground_truth_temp<span class="sc">$</span>crowns <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 21
## Columns: 5
## $ treeID         &lt;dbl&gt; 3101, 3102, 3103, 3104, 3105, 3106, 3107, 3108, 3109, 3…
## $ gt_tree_height &lt;dbl&gt; 24.742, 23.317, 23.710, 23.236, 23.932, 23.542, 24.105,…
## $ plotID         &lt;dbl&gt; 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3…
## $ dbh            &lt;dbl&gt; 29.4, 24.8, 29.3, 29.3, 26.6, 26.1, 25.5, 29.8, 22.9, 2…
## $ geometry       &lt;POLYGON [m]&gt; POLYGON ((480614.3 5601259,..., POLYGON ((48061…</code></pre>
<p>looks like there is only DBH so we’ll use the <code>gt_tree_height</code> data calculated from the point cloud using our <code>fi_las_to_poly()</code> for the matching algorithm above. We calculated ground truth tree height in the For-Instance benchmark (<code>gt_tree_height</code>) as the difference between the highest and lowest point for each tree instance following Wielgosz et al. (<a href="https://doi.org/10.1016/j.rse.2024.114367">2024</a>).</p>
<p>first, we’ll define a function to attempt a match with a single ground truth tree</p>
<div class="sourceCode" id="cb317"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb317-1"><a href="validate-tree-detection-and-crown-delineation.html#cb317-1" tabindex="-1"></a>ground_truth_single_tree_match <span class="ot">&lt;-</span> <span class="cf">function</span>(gt_tree, predictions, <span class="at">min_iou_pct =</span> <span class="fl">0.5</span>) {</span>
<span id="cb317-2"><a href="validate-tree-detection-and-crown-delineation.html#cb317-2" tabindex="-1"></a>  <span class="cf">if</span>( <span class="sc">!</span><span class="fu">inherits</span>(gt_tree,<span class="st">&quot;sf&quot;</span>) <span class="sc">||</span> <span class="fu">nrow</span>(gt_tree)<span class="sc">!=</span><span class="dv">1</span> ){<span class="fu">stop</span>(<span class="st">&quot;ground truth tree must be spatial `sf` data with a single record&quot;</span>)}</span>
<span id="cb317-3"><a href="validate-tree-detection-and-crown-delineation.html#cb317-3" tabindex="-1"></a>  <span class="cf">if</span>( <span class="sc">!</span><span class="fu">inherits</span>(predictions,<span class="st">&quot;sf&quot;</span>) ){<span class="fu">stop</span>(<span class="st">&quot;predictions must be spatial `sf` data&quot;</span>)}</span>
<span id="cb317-4"><a href="validate-tree-detection-and-crown-delineation.html#cb317-4" tabindex="-1"></a>  <span class="cf">if</span>( <span class="sc">!</span>(<span class="fu">names</span>(gt_tree) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_equal</span>(<span class="st">&quot;treeID&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">any</span>()) ){<span class="fu">stop</span>(<span class="st">&quot;ground truth tree data must contain `treeID` column&quot;</span>)}</span>
<span id="cb317-5"><a href="validate-tree-detection-and-crown-delineation.html#cb317-5" tabindex="-1"></a>  <span class="cf">if</span>( <span class="fu">names</span>(predictions) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_equal</span>(<span class="st">&quot;treeID&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">any</span>() ){</span>
<span id="cb317-6"><a href="validate-tree-detection-and-crown-delineation.html#cb317-6" tabindex="-1"></a>    predictions <span class="ot">&lt;-</span> predictions <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">treeID_pred =</span> treeID)</span>
<span id="cb317-7"><a href="validate-tree-detection-and-crown-delineation.html#cb317-7" tabindex="-1"></a>  }</span>
<span id="cb317-8"><a href="validate-tree-detection-and-crown-delineation.html#cb317-8" tabindex="-1"></a>  <span class="cf">if</span>( <span class="sc">!</span>(<span class="fu">names</span>(predictions) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_equal</span>(<span class="st">&quot;treeID_pred&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">any</span>()) ){</span>
<span id="cb317-9"><a href="validate-tree-detection-and-crown-delineation.html#cb317-9" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;predictions tree data must contain `treeID` or `treeID_pred` column&quot;</span>)</span>
<span id="cb317-10"><a href="validate-tree-detection-and-crown-delineation.html#cb317-10" tabindex="-1"></a>  }</span>
<span id="cb317-11"><a href="validate-tree-detection-and-crown-delineation.html#cb317-11" tabindex="-1"></a>  </span>
<span id="cb317-12"><a href="validate-tree-detection-and-crown-delineation.html#cb317-12" tabindex="-1"></a>  <span class="co"># intersection</span></span>
<span id="cb317-13"><a href="validate-tree-detection-and-crown-delineation.html#cb317-13" tabindex="-1"></a>    i_temp <span class="ot">&lt;-</span></span>
<span id="cb317-14"><a href="validate-tree-detection-and-crown-delineation.html#cb317-14" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_intersection</span>(predictions,gt_tree) <span class="sc">%&gt;%</span> </span>
<span id="cb317-15"><a href="validate-tree-detection-and-crown-delineation.html#cb317-15" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">i_area =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>())</span>
<span id="cb317-16"><a href="validate-tree-detection-and-crown-delineation.html#cb317-16" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">nrow</span>(i_temp)<span class="sc">==</span><span class="dv">0</span>){<span class="fu">return</span>(<span class="cn">NULL</span>)}</span>
<span id="cb317-17"><a href="validate-tree-detection-and-crown-delineation.html#cb317-17" tabindex="-1"></a>  <span class="co"># union</span></span>
<span id="cb317-18"><a href="validate-tree-detection-and-crown-delineation.html#cb317-18" tabindex="-1"></a>    u_temp <span class="ot">&lt;-</span></span>
<span id="cb317-19"><a href="validate-tree-detection-and-crown-delineation.html#cb317-19" tabindex="-1"></a>      i_temp <span class="sc">%&gt;%</span> </span>
<span id="cb317-20"><a href="validate-tree-detection-and-crown-delineation.html#cb317-20" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb317-21"><a href="validate-tree-detection-and-crown-delineation.html#cb317-21" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(predictions <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_set_geometry</span>(<span class="st">&quot;geom1&quot;</span>), <span class="at">by =</span> <span class="st">&quot;treeID_pred&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb317-22"><a href="validate-tree-detection-and-crown-delineation.html#cb317-22" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">inner_join</span>(gt_tree <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_set_geometry</span>(<span class="st">&quot;geom2&quot;</span>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(treeID), <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb317-23"><a href="validate-tree-detection-and-crown-delineation.html#cb317-23" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb317-24"><a href="validate-tree-detection-and-crown-delineation.html#cb317-24" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb317-25"><a href="validate-tree-detection-and-crown-delineation.html#cb317-25" tabindex="-1"></a>        <span class="at">u_area =</span> sf<span class="sc">::</span><span class="fu">st_union</span>(geom1, geom2) <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_area</span>() <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb317-26"><a href="validate-tree-detection-and-crown-delineation.html#cb317-26" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb317-27"><a href="validate-tree-detection-and-crown-delineation.html#cb317-27" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb317-28"><a href="validate-tree-detection-and-crown-delineation.html#cb317-28" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(geom1,geom2)) <span class="sc">%&gt;%</span> </span>
<span id="cb317-29"><a href="validate-tree-detection-and-crown-delineation.html#cb317-29" tabindex="-1"></a>      sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb317-30"><a href="validate-tree-detection-and-crown-delineation.html#cb317-30" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb317-31"><a href="validate-tree-detection-and-crown-delineation.html#cb317-31" tabindex="-1"></a>        <span class="at">iou =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb317-32"><a href="validate-tree-detection-and-crown-delineation.html#cb317-32" tabindex="-1"></a>          <span class="fu">is.na</span>(u_area) <span class="sc">|</span> <span class="fu">is.nan</span>(u_area) <span class="sc">~</span> <span class="cn">NA</span></span>
<span id="cb317-33"><a href="validate-tree-detection-and-crown-delineation.html#cb317-33" tabindex="-1"></a>          , T <span class="sc">~</span> dplyr<span class="sc">::</span><span class="fu">coalesce</span>(i_area,<span class="dv">0</span>)<span class="sc">/</span>u_area</span>
<span id="cb317-34"><a href="validate-tree-detection-and-crown-delineation.html#cb317-34" tabindex="-1"></a>        )</span>
<span id="cb317-35"><a href="validate-tree-detection-and-crown-delineation.html#cb317-35" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb317-36"><a href="validate-tree-detection-and-crown-delineation.html#cb317-36" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(iou) <span class="sc">&amp;</span> iou<span class="sc">&gt;=</span>min_iou_pct)</span>
<span id="cb317-37"><a href="validate-tree-detection-and-crown-delineation.html#cb317-37" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">nrow</span>(u_temp)<span class="sc">==</span><span class="dv">0</span>){<span class="fu">return</span>(<span class="cn">NULL</span>)}</span>
<span id="cb317-38"><a href="validate-tree-detection-and-crown-delineation.html#cb317-38" tabindex="-1"></a>  <span class="co"># return</span></span>
<span id="cb317-39"><a href="validate-tree-detection-and-crown-delineation.html#cb317-39" tabindex="-1"></a>  <span class="fu">return</span>(</span>
<span id="cb317-40"><a href="validate-tree-detection-and-crown-delineation.html#cb317-40" tabindex="-1"></a>    u_temp <span class="sc">%&gt;%</span> </span>
<span id="cb317-41"><a href="validate-tree-detection-and-crown-delineation.html#cb317-41" tabindex="-1"></a>      <span class="co"># pick the highest iou</span></span>
<span id="cb317-42"><a href="validate-tree-detection-and-crown-delineation.html#cb317-42" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(iou)) <span class="sc">%&gt;%</span> </span>
<span id="cb317-43"><a href="validate-tree-detection-and-crown-delineation.html#cb317-43" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb317-44"><a href="validate-tree-detection-and-crown-delineation.html#cb317-44" tabindex="-1"></a>      <span class="co"># column clean</span></span>
<span id="cb317-45"><a href="validate-tree-detection-and-crown-delineation.html#cb317-45" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb317-46"><a href="validate-tree-detection-and-crown-delineation.html#cb317-46" tabindex="-1"></a>        treeID, i_area, u_area, iou</span>
<span id="cb317-47"><a href="validate-tree-detection-and-crown-delineation.html#cb317-47" tabindex="-1"></a>        , base<span class="sc">::</span><span class="fu">setdiff</span>( </span>
<span id="cb317-48"><a href="validate-tree-detection-and-crown-delineation.html#cb317-48" tabindex="-1"></a>          <span class="fu">names</span>(predictions)</span>
<span id="cb317-49"><a href="validate-tree-detection-and-crown-delineation.html#cb317-49" tabindex="-1"></a>          , <span class="fu">c</span>(<span class="st">&quot;geometry&quot;</span>, <span class="st">&quot;geom&quot;</span>, <span class="st">&quot;treeID&quot;</span>, <span class="st">&quot;i_area&quot;</span>, <span class="st">&quot;u_area&quot;</span>, <span class="st">&quot;iou&quot;</span>) </span>
<span id="cb317-50"><a href="validate-tree-detection-and-crown-delineation.html#cb317-50" tabindex="-1"></a>        )</span>
<span id="cb317-51"><a href="validate-tree-detection-and-crown-delineation.html#cb317-51" tabindex="-1"></a>      )</span>
<span id="cb317-52"><a href="validate-tree-detection-and-crown-delineation.html#cb317-52" tabindex="-1"></a>  )</span>
<span id="cb317-53"><a href="validate-tree-detection-and-crown-delineation.html#cb317-53" tabindex="-1"></a>}</span></code></pre></div>
<p>test for a single ground truth tree</p>
<div class="sourceCode" id="cb318"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb318-1"><a href="validate-tree-detection-and-crown-delineation.html#cb318-1" tabindex="-1"></a><span class="fu">ground_truth_single_tree_match</span>(</span>
<span id="cb318-2"><a href="validate-tree-detection-and-crown-delineation.html#cb318-2" tabindex="-1"></a>  <span class="at">gt_tree =</span> ground_truth_temp<span class="sc">$</span>crowns <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(gt_tree_height)) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">slice</span>(<span class="dv">2</span>)</span>
<span id="cb318-3"><a href="validate-tree-detection-and-crown-delineation.html#cb318-3" tabindex="-1"></a>  , <span class="at">predictions =</span> ans_crowns_no_mask <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(treeID)</span>
<span id="cb318-4"><a href="validate-tree-detection-and-crown-delineation.html#cb318-4" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## # A tibble: 1 × 5
##   treeID i_area u_area   iou treeID_pred          
##    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;                
## 1   3117   28.5   36.8 0.773 12_480600.6_5601257.6</code></pre>
<p>now we need to make a function that takes reference and predicted tree crown polygons, matches the trees iteratively allowing for only a single match from the predictions (i.e. one prediction can only go to one ground truth tree), and returns all trees labeled as true positive (correctly matched with a prediction), commission (predictions which do not match a ground truth tree; false positive), or omission (ground truth trees for which no predictions match; false negative)</p>
<div class="sourceCode" id="cb320"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb320-1"><a href="validate-tree-detection-and-crown-delineation.html#cb320-1" tabindex="-1"></a>ground_truth_crown_match <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb320-2"><a href="validate-tree-detection-and-crown-delineation.html#cb320-2" tabindex="-1"></a>  <span class="co"># ground_truth should be sorted already</span></span>
<span id="cb320-3"><a href="validate-tree-detection-and-crown-delineation.html#cb320-3" tabindex="-1"></a>  ground_truth</span>
<span id="cb320-4"><a href="validate-tree-detection-and-crown-delineation.html#cb320-4" tabindex="-1"></a>  <span class="co"># predictions just needs treeID</span></span>
<span id="cb320-5"><a href="validate-tree-detection-and-crown-delineation.html#cb320-5" tabindex="-1"></a>  , predictions</span>
<span id="cb320-6"><a href="validate-tree-detection-and-crown-delineation.html#cb320-6" tabindex="-1"></a>  , <span class="at">min_iou_pct =</span> <span class="fl">0.5</span></span>
<span id="cb320-7"><a href="validate-tree-detection-and-crown-delineation.html#cb320-7" tabindex="-1"></a>  , <span class="at">calculate_height_diff =</span> F</span>
<span id="cb320-8"><a href="validate-tree-detection-and-crown-delineation.html#cb320-8" tabindex="-1"></a>) {</span>
<span id="cb320-9"><a href="validate-tree-detection-and-crown-delineation.html#cb320-9" tabindex="-1"></a>  <span class="co"># checks</span></span>
<span id="cb320-10"><a href="validate-tree-detection-and-crown-delineation.html#cb320-10" tabindex="-1"></a>  <span class="cf">if</span>( <span class="sc">!</span><span class="fu">inherits</span>(ground_truth,<span class="st">&quot;sf&quot;</span>) <span class="sc">||</span> <span class="fu">nrow</span>(ground_truth)<span class="sc">==</span><span class="dv">0</span> ){<span class="fu">stop</span>(<span class="st">&quot;ground truth must be spatial `sf` data&quot;</span>)}</span>
<span id="cb320-11"><a href="validate-tree-detection-and-crown-delineation.html#cb320-11" tabindex="-1"></a>  <span class="cf">if</span>( <span class="sc">!</span><span class="fu">inherits</span>(predictions,<span class="st">&quot;sf&quot;</span>) ){<span class="fu">stop</span>(<span class="st">&quot;predictions must be spatial `sf` data&quot;</span>)}</span>
<span id="cb320-12"><a href="validate-tree-detection-and-crown-delineation.html#cb320-12" tabindex="-1"></a>  <span class="cf">if</span>( <span class="sc">!</span>(<span class="fu">names</span>(ground_truth) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_equal</span>(<span class="st">&quot;treeID&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">any</span>()) ){</span>
<span id="cb320-13"><a href="validate-tree-detection-and-crown-delineation.html#cb320-13" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;ground truth tree data must contain `treeID` column&quot;</span>)</span>
<span id="cb320-14"><a href="validate-tree-detection-and-crown-delineation.html#cb320-14" tabindex="-1"></a>  }</span>
<span id="cb320-15"><a href="validate-tree-detection-and-crown-delineation.html#cb320-15" tabindex="-1"></a>  <span class="cf">if</span>(calculate_height_diff <span class="sc">&amp;&amp;</span> <span class="sc">!</span>(<span class="fu">names</span>(ground_truth) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_equal</span>(<span class="st">&quot;gt_tree_height&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">any</span>()) ){</span>
<span id="cb320-16"><a href="validate-tree-detection-and-crown-delineation.html#cb320-16" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;ground truth tree data must contain `gt_tree_height` column if `calculate_height_diff=T`&quot;</span>)</span>
<span id="cb320-17"><a href="validate-tree-detection-and-crown-delineation.html#cb320-17" tabindex="-1"></a>  }</span>
<span id="cb320-18"><a href="validate-tree-detection-and-crown-delineation.html#cb320-18" tabindex="-1"></a>  <span class="cf">if</span>(calculate_height_diff <span class="sc">&amp;&amp;</span> <span class="sc">!</span>(<span class="fu">names</span>(predictions) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_equal</span>(<span class="st">&quot;tree_height_m&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">any</span>()) ){</span>
<span id="cb320-19"><a href="validate-tree-detection-and-crown-delineation.html#cb320-19" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;ground truth tree data must contain `tree_height_m` column if `calculate_height_diff=T`&quot;</span>)</span>
<span id="cb320-20"><a href="validate-tree-detection-and-crown-delineation.html#cb320-20" tabindex="-1"></a>  }</span>
<span id="cb320-21"><a href="validate-tree-detection-and-crown-delineation.html#cb320-21" tabindex="-1"></a>  <span class="cf">if</span>( <span class="sc">!</span>(<span class="fu">names</span>(predictions) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_equal</span>(<span class="st">&quot;treeID&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">any</span>()) ){</span>
<span id="cb320-22"><a href="validate-tree-detection-and-crown-delineation.html#cb320-22" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;predictions tree data must contain `treeID` column&quot;</span>)</span>
<span id="cb320-23"><a href="validate-tree-detection-and-crown-delineation.html#cb320-23" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb320-24"><a href="validate-tree-detection-and-crown-delineation.html#cb320-24" tabindex="-1"></a>    predictions <span class="ot">&lt;-</span> predictions <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">treeID_pred =</span> treeID)</span>
<span id="cb320-25"><a href="validate-tree-detection-and-crown-delineation.html#cb320-25" tabindex="-1"></a>  }</span>
<span id="cb320-26"><a href="validate-tree-detection-and-crown-delineation.html#cb320-26" tabindex="-1"></a>  </span>
<span id="cb320-27"><a href="validate-tree-detection-and-crown-delineation.html#cb320-27" tabindex="-1"></a>  <span class="co"># set up a blank data frame</span></span>
<span id="cb320-28"><a href="validate-tree-detection-and-crown-delineation.html#cb320-28" tabindex="-1"></a>  return_df <span class="ot">&lt;-</span></span>
<span id="cb320-29"><a href="validate-tree-detection-and-crown-delineation.html#cb320-29" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb320-30"><a href="validate-tree-detection-and-crown-delineation.html#cb320-30" tabindex="-1"></a>      <span class="at">i_area =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb320-31"><a href="validate-tree-detection-and-crown-delineation.html#cb320-31" tabindex="-1"></a>      , <span class="at">u_area =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb320-32"><a href="validate-tree-detection-and-crown-delineation.html#cb320-32" tabindex="-1"></a>      , <span class="at">iou =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb320-33"><a href="validate-tree-detection-and-crown-delineation.html#cb320-33" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb320-34"><a href="validate-tree-detection-and-crown-delineation.html#cb320-34" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(</span>
<span id="cb320-35"><a href="validate-tree-detection-and-crown-delineation.html#cb320-35" tabindex="-1"></a>      ground_truth <span class="sc">%&gt;%</span> </span>
<span id="cb320-36"><a href="validate-tree-detection-and-crown-delineation.html#cb320-36" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb320-37"><a href="validate-tree-detection-and-crown-delineation.html#cb320-37" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(treeID) <span class="sc">%&gt;%</span> </span>
<span id="cb320-38"><a href="validate-tree-detection-and-crown-delineation.html#cb320-38" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">slice</span>(<span class="dv">0</span>)</span>
<span id="cb320-39"><a href="validate-tree-detection-and-crown-delineation.html#cb320-39" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb320-40"><a href="validate-tree-detection-and-crown-delineation.html#cb320-40" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(</span>
<span id="cb320-41"><a href="validate-tree-detection-and-crown-delineation.html#cb320-41" tabindex="-1"></a>      predictions <span class="sc">%&gt;%</span> </span>
<span id="cb320-42"><a href="validate-tree-detection-and-crown-delineation.html#cb320-42" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb320-43"><a href="validate-tree-detection-and-crown-delineation.html#cb320-43" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(treeID_pred) <span class="sc">%&gt;%</span> </span>
<span id="cb320-44"><a href="validate-tree-detection-and-crown-delineation.html#cb320-44" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">slice</span>(<span class="dv">0</span>)</span>
<span id="cb320-45"><a href="validate-tree-detection-and-crown-delineation.html#cb320-45" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb320-46"><a href="validate-tree-detection-and-crown-delineation.html#cb320-46" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">relocate</span>(tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;treeID&quot;</span>))</span>
<span id="cb320-47"><a href="validate-tree-detection-and-crown-delineation.html#cb320-47" tabindex="-1"></a>  </span>
<span id="cb320-48"><a href="validate-tree-detection-and-crown-delineation.html#cb320-48" tabindex="-1"></a>  <span class="co"># save names to select</span></span>
<span id="cb320-49"><a href="validate-tree-detection-and-crown-delineation.html#cb320-49" tabindex="-1"></a>  nms_temp <span class="ot">&lt;-</span> <span class="fu">names</span>(return_df)</span>
<span id="cb320-50"><a href="validate-tree-detection-and-crown-delineation.html#cb320-50" tabindex="-1"></a>  </span>
<span id="cb320-51"><a href="validate-tree-detection-and-crown-delineation.html#cb320-51" tabindex="-1"></a>  <span class="co"># start with tallest tree and match to get true positives</span></span>
<span id="cb320-52"><a href="validate-tree-detection-and-crown-delineation.html#cb320-52" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(ground_truth)) {</span>
<span id="cb320-53"><a href="validate-tree-detection-and-crown-delineation.html#cb320-53" tabindex="-1"></a>      match_temp <span class="ot">&lt;-</span> <span class="fu">ground_truth_single_tree_match</span>(</span>
<span id="cb320-54"><a href="validate-tree-detection-and-crown-delineation.html#cb320-54" tabindex="-1"></a>        <span class="at">gt_tree =</span> ground_truth <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">slice</span>(i)</span>
<span id="cb320-55"><a href="validate-tree-detection-and-crown-delineation.html#cb320-55" tabindex="-1"></a>        , <span class="at">predictions =</span> predictions <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(treeID_pred) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">anti_join</span>(return_df,<span class="at">by=</span><span class="st">&quot;treeID_pred&quot;</span>)</span>
<span id="cb320-56"><a href="validate-tree-detection-and-crown-delineation.html#cb320-56" tabindex="-1"></a>        , <span class="at">min_iou_pct =</span> min_iou_pct</span>
<span id="cb320-57"><a href="validate-tree-detection-and-crown-delineation.html#cb320-57" tabindex="-1"></a>      )</span>
<span id="cb320-58"><a href="validate-tree-detection-and-crown-delineation.html#cb320-58" tabindex="-1"></a>      <span class="co"># add to return</span></span>
<span id="cb320-59"><a href="validate-tree-detection-and-crown-delineation.html#cb320-59" tabindex="-1"></a>      <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(match_temp)){</span>
<span id="cb320-60"><a href="validate-tree-detection-and-crown-delineation.html#cb320-60" tabindex="-1"></a>        return_df <span class="ot">&lt;-</span> return_df <span class="sc">%&gt;%</span> </span>
<span id="cb320-61"><a href="validate-tree-detection-and-crown-delineation.html#cb320-61" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(match_temp <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(nms_temp))</span>
<span id="cb320-62"><a href="validate-tree-detection-and-crown-delineation.html#cb320-62" tabindex="-1"></a>      }</span>
<span id="cb320-63"><a href="validate-tree-detection-and-crown-delineation.html#cb320-63" tabindex="-1"></a>      match_temp <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb320-64"><a href="validate-tree-detection-and-crown-delineation.html#cb320-64" tabindex="-1"></a>    }</span>
<span id="cb320-65"><a href="validate-tree-detection-and-crown-delineation.html#cb320-65" tabindex="-1"></a>  <span class="co"># label tps</span></span>
<span id="cb320-66"><a href="validate-tree-detection-and-crown-delineation.html#cb320-66" tabindex="-1"></a>  return_df <span class="ot">&lt;-</span> return_df <span class="sc">%&gt;%</span> </span>
<span id="cb320-67"><a href="validate-tree-detection-and-crown-delineation.html#cb320-67" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">match_grp =</span> <span class="st">&quot;true positive&quot;</span>)</span>
<span id="cb320-68"><a href="validate-tree-detection-and-crown-delineation.html#cb320-68" tabindex="-1"></a>  <span class="co"># add omissions</span></span>
<span id="cb320-69"><a href="validate-tree-detection-and-crown-delineation.html#cb320-69" tabindex="-1"></a>  return_df <span class="ot">&lt;-</span></span>
<span id="cb320-70"><a href="validate-tree-detection-and-crown-delineation.html#cb320-70" tabindex="-1"></a>    return_df <span class="sc">%&gt;%</span> </span>
<span id="cb320-71"><a href="validate-tree-detection-and-crown-delineation.html#cb320-71" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb320-72"><a href="validate-tree-detection-and-crown-delineation.html#cb320-72" tabindex="-1"></a>      ground_truth <span class="sc">%&gt;%</span> </span>
<span id="cb320-73"><a href="validate-tree-detection-and-crown-delineation.html#cb320-73" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb320-74"><a href="validate-tree-detection-and-crown-delineation.html#cb320-74" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">anti_join</span>(return_df,<span class="at">by=</span><span class="st">&quot;treeID&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb320-75"><a href="validate-tree-detection-and-crown-delineation.html#cb320-75" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(treeID) <span class="sc">%&gt;%</span> </span>
<span id="cb320-76"><a href="validate-tree-detection-and-crown-delineation.html#cb320-76" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">match_grp =</span> <span class="st">&quot;omission&quot;</span>)</span>
<span id="cb320-77"><a href="validate-tree-detection-and-crown-delineation.html#cb320-77" tabindex="-1"></a>    )</span>
<span id="cb320-78"><a href="validate-tree-detection-and-crown-delineation.html#cb320-78" tabindex="-1"></a>  <span class="co"># add commissions</span></span>
<span id="cb320-79"><a href="validate-tree-detection-and-crown-delineation.html#cb320-79" tabindex="-1"></a>  return_df <span class="ot">&lt;-</span></span>
<span id="cb320-80"><a href="validate-tree-detection-and-crown-delineation.html#cb320-80" tabindex="-1"></a>    return_df <span class="sc">%&gt;%</span> </span>
<span id="cb320-81"><a href="validate-tree-detection-and-crown-delineation.html#cb320-81" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb320-82"><a href="validate-tree-detection-and-crown-delineation.html#cb320-82" tabindex="-1"></a>      predictions <span class="sc">%&gt;%</span> </span>
<span id="cb320-83"><a href="validate-tree-detection-and-crown-delineation.html#cb320-83" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb320-84"><a href="validate-tree-detection-and-crown-delineation.html#cb320-84" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">anti_join</span>(return_df,<span class="at">by=</span><span class="st">&quot;treeID_pred&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb320-85"><a href="validate-tree-detection-and-crown-delineation.html#cb320-85" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(treeID_pred) <span class="sc">%&gt;%</span> </span>
<span id="cb320-86"><a href="validate-tree-detection-and-crown-delineation.html#cb320-86" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">match_grp =</span> <span class="st">&quot;commission&quot;</span>)</span>
<span id="cb320-87"><a href="validate-tree-detection-and-crown-delineation.html#cb320-87" tabindex="-1"></a>    )</span>
<span id="cb320-88"><a href="validate-tree-detection-and-crown-delineation.html#cb320-88" tabindex="-1"></a>  <span class="co"># make match_grp factor</span></span>
<span id="cb320-89"><a href="validate-tree-detection-and-crown-delineation.html#cb320-89" tabindex="-1"></a>  return_df <span class="ot">&lt;-</span> return_df <span class="sc">%&gt;%</span> </span>
<span id="cb320-90"><a href="validate-tree-detection-and-crown-delineation.html#cb320-90" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb320-91"><a href="validate-tree-detection-and-crown-delineation.html#cb320-91" tabindex="-1"></a>      <span class="at">match_grp =</span> <span class="fu">factor</span>(</span>
<span id="cb320-92"><a href="validate-tree-detection-and-crown-delineation.html#cb320-92" tabindex="-1"></a>        match_grp</span>
<span id="cb320-93"><a href="validate-tree-detection-and-crown-delineation.html#cb320-93" tabindex="-1"></a>        , <span class="at">ordered =</span> T</span>
<span id="cb320-94"><a href="validate-tree-detection-and-crown-delineation.html#cb320-94" tabindex="-1"></a>        , <span class="at">levels =</span> <span class="fu">c</span>(</span>
<span id="cb320-95"><a href="validate-tree-detection-and-crown-delineation.html#cb320-95" tabindex="-1"></a>          <span class="st">&quot;true positive&quot;</span></span>
<span id="cb320-96"><a href="validate-tree-detection-and-crown-delineation.html#cb320-96" tabindex="-1"></a>          , <span class="st">&quot;commission&quot;</span></span>
<span id="cb320-97"><a href="validate-tree-detection-and-crown-delineation.html#cb320-97" tabindex="-1"></a>          , <span class="st">&quot;omission&quot;</span></span>
<span id="cb320-98"><a href="validate-tree-detection-and-crown-delineation.html#cb320-98" tabindex="-1"></a>        )</span>
<span id="cb320-99"><a href="validate-tree-detection-and-crown-delineation.html#cb320-99" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> forcats<span class="sc">::</span><span class="fu">fct_rev</span>()</span>
<span id="cb320-100"><a href="validate-tree-detection-and-crown-delineation.html#cb320-100" tabindex="-1"></a>    )</span>
<span id="cb320-101"><a href="validate-tree-detection-and-crown-delineation.html#cb320-101" tabindex="-1"></a>  </span>
<span id="cb320-102"><a href="validate-tree-detection-and-crown-delineation.html#cb320-102" tabindex="-1"></a>  <span class="co"># calculate height difference for matched trees</span></span>
<span id="cb320-103"><a href="validate-tree-detection-and-crown-delineation.html#cb320-103" tabindex="-1"></a>  <span class="cf">if</span>(calculate_height_diff){</span>
<span id="cb320-104"><a href="validate-tree-detection-and-crown-delineation.html#cb320-104" tabindex="-1"></a>    return_df <span class="ot">&lt;-</span> return_df <span class="sc">%&gt;%</span> </span>
<span id="cb320-105"><a href="validate-tree-detection-and-crown-delineation.html#cb320-105" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb320-106"><a href="validate-tree-detection-and-crown-delineation.html#cb320-106" tabindex="-1"></a>        ground_truth <span class="sc">%&gt;%</span> </span>
<span id="cb320-107"><a href="validate-tree-detection-and-crown-delineation.html#cb320-107" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb320-108"><a href="validate-tree-detection-and-crown-delineation.html#cb320-108" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(treeID,gt_tree_height)</span>
<span id="cb320-109"><a href="validate-tree-detection-and-crown-delineation.html#cb320-109" tabindex="-1"></a>        , <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span></span>
<span id="cb320-110"><a href="validate-tree-detection-and-crown-delineation.html#cb320-110" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb320-111"><a href="validate-tree-detection-and-crown-delineation.html#cb320-111" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb320-112"><a href="validate-tree-detection-and-crown-delineation.html#cb320-112" tabindex="-1"></a>        predictions <span class="sc">%&gt;%</span> </span>
<span id="cb320-113"><a href="validate-tree-detection-and-crown-delineation.html#cb320-113" tabindex="-1"></a>          sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb320-114"><a href="validate-tree-detection-and-crown-delineation.html#cb320-114" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(treeID_pred,tree_height_m)</span>
<span id="cb320-115"><a href="validate-tree-detection-and-crown-delineation.html#cb320-115" tabindex="-1"></a>        , <span class="at">by=</span><span class="st">&quot;treeID_pred&quot;</span></span>
<span id="cb320-116"><a href="validate-tree-detection-and-crown-delineation.html#cb320-116" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb320-117"><a href="validate-tree-detection-and-crown-delineation.html#cb320-117" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">height_diff =</span> gt_tree_height<span class="sc">-</span>tree_height_m)</span>
<span id="cb320-118"><a href="validate-tree-detection-and-crown-delineation.html#cb320-118" tabindex="-1"></a>  }</span>
<span id="cb320-119"><a href="validate-tree-detection-and-crown-delineation.html#cb320-119" tabindex="-1"></a>  <span class="co"># return</span></span>
<span id="cb320-120"><a href="validate-tree-detection-and-crown-delineation.html#cb320-120" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(return_df)<span class="sc">==</span><span class="dv">0</span>){</span>
<span id="cb320-121"><a href="validate-tree-detection-and-crown-delineation.html#cb320-121" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">&quot;no records found for ground truth to predition matching&quot;</span>)</span>
<span id="cb320-122"><a href="validate-tree-detection-and-crown-delineation.html#cb320-122" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb320-123"><a href="validate-tree-detection-and-crown-delineation.html#cb320-123" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb320-124"><a href="validate-tree-detection-and-crown-delineation.html#cb320-124" tabindex="-1"></a>    <span class="fu">return</span>(return_df)</span>
<span id="cb320-125"><a href="validate-tree-detection-and-crown-delineation.html#cb320-125" tabindex="-1"></a>  }</span>
<span id="cb320-126"><a href="validate-tree-detection-and-crown-delineation.html#cb320-126" tabindex="-1"></a>  </span>
<span id="cb320-127"><a href="validate-tree-detection-and-crown-delineation.html#cb320-127" tabindex="-1"></a>}</span></code></pre></div>
<p>test the tree matching process on the full data</p>
<div class="sourceCode" id="cb321"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb321-1"><a href="validate-tree-detection-and-crown-delineation.html#cb321-1" tabindex="-1"></a>ground_truth_crown_match_ans <span class="ot">&lt;-</span></span>
<span id="cb321-2"><a href="validate-tree-detection-and-crown-delineation.html#cb321-2" tabindex="-1"></a>  <span class="fu">ground_truth_crown_match</span>(</span>
<span id="cb321-3"><a href="validate-tree-detection-and-crown-delineation.html#cb321-3" tabindex="-1"></a>    <span class="co"># ground_truth should be sorted already</span></span>
<span id="cb321-4"><a href="validate-tree-detection-and-crown-delineation.html#cb321-4" tabindex="-1"></a>    <span class="at">ground_truth =</span> ground_truth_temp<span class="sc">$</span>crowns <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(gt_tree_height))</span>
<span id="cb321-5"><a href="validate-tree-detection-and-crown-delineation.html#cb321-5" tabindex="-1"></a>    <span class="co"># predictions just needs treeID</span></span>
<span id="cb321-6"><a href="validate-tree-detection-and-crown-delineation.html#cb321-6" tabindex="-1"></a>    , <span class="at">predictions =</span> ans_crowns_no_mask <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(treeID,tree_height_m)</span>
<span id="cb321-7"><a href="validate-tree-detection-and-crown-delineation.html#cb321-7" tabindex="-1"></a>    , <span class="at">min_iou_pct =</span> <span class="fl">0.5</span></span>
<span id="cb321-8"><a href="validate-tree-detection-and-crown-delineation.html#cb321-8" tabindex="-1"></a>    , <span class="at">calculate_height_diff =</span> T</span>
<span id="cb321-9"><a href="validate-tree-detection-and-crown-delineation.html#cb321-9" tabindex="-1"></a>  )</span></code></pre></div>
<p>how did our predictions do for this particular example?</p>
<div class="sourceCode" id="cb322"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb322-1"><a href="validate-tree-detection-and-crown-delineation.html#cb322-1" tabindex="-1"></a><span class="co"># what did we get?</span></span>
<span id="cb322-2"><a href="validate-tree-detection-and-crown-delineation.html#cb322-2" tabindex="-1"></a>ground_truth_crown_match_ans <span class="sc">%&gt;%</span> </span>
<span id="cb322-3"><a href="validate-tree-detection-and-crown-delineation.html#cb322-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(match_grp) <span class="sc">%&gt;%</span> </span>
<span id="cb322-4"><a href="validate-tree-detection-and-crown-delineation.html#cb322-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pct =</span> (n<span class="sc">/</span><span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span> scales<span class="sc">::</span><span class="fu">percent</span>(<span class="at">accuracy=</span><span class="fl">0.1</span>))</span></code></pre></div>
<pre><code>## # A tibble: 3 × 3
##   match_grp         n pct  
##   &lt;ord&gt;         &lt;int&gt; &lt;chr&gt;
## 1 omission         11 44.0%
## 2 commission        4 16.0%
## 3 true positive    10 40.0%</code></pre>
<p>let’s look at that spatially</p>
<div class="sourceCode" id="cb324"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb324-1"><a href="validate-tree-detection-and-crown-delineation.html#cb324-1" tabindex="-1"></a>pal_match_grp <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb324-2"><a href="validate-tree-detection-and-crown-delineation.html#cb324-2" tabindex="-1"></a>  <span class="st">&quot;omission&quot;</span><span class="ot">=</span>viridis<span class="sc">::</span><span class="fu">cividis</span>(<span class="dv">3</span>)[<span class="dv">1</span>]</span>
<span id="cb324-3"><a href="validate-tree-detection-and-crown-delineation.html#cb324-3" tabindex="-1"></a>  , <span class="st">&quot;commission&quot;</span><span class="ot">=</span>viridis<span class="sc">::</span><span class="fu">cividis</span>(<span class="dv">3</span>)[<span class="dv">2</span>]</span>
<span id="cb324-4"><a href="validate-tree-detection-and-crown-delineation.html#cb324-4" tabindex="-1"></a>  , <span class="st">&quot;true positive&quot;</span><span class="ot">=</span>viridis<span class="sc">::</span><span class="fu">cividis</span>(<span class="dv">3</span>)[<span class="dv">3</span>]</span>
<span id="cb324-5"><a href="validate-tree-detection-and-crown-delineation.html#cb324-5" tabindex="-1"></a>)</span>
<span id="cb324-6"><a href="validate-tree-detection-and-crown-delineation.html#cb324-6" tabindex="-1"></a><span class="co"># plot it</span></span>
<span id="cb324-7"><a href="validate-tree-detection-and-crown-delineation.html#cb324-7" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb324-8"><a href="validate-tree-detection-and-crown-delineation.html#cb324-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb324-9"><a href="validate-tree-detection-and-crown-delineation.html#cb324-9" tabindex="-1"></a>    <span class="at">data =</span> </span>
<span id="cb324-10"><a href="validate-tree-detection-and-crown-delineation.html#cb324-10" tabindex="-1"></a>      ground_truth_temp<span class="sc">$</span>crowns <span class="sc">%&gt;%</span> </span>
<span id="cb324-11"><a href="validate-tree-detection-and-crown-delineation.html#cb324-11" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb324-12"><a href="validate-tree-detection-and-crown-delineation.html#cb324-12" tabindex="-1"></a>          ground_truth_crown_match_ans <span class="sc">%&gt;%</span> </span>
<span id="cb324-13"><a href="validate-tree-detection-and-crown-delineation.html#cb324-13" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(treeID,match_grp)</span>
<span id="cb324-14"><a href="validate-tree-detection-and-crown-delineation.html#cb324-14" tabindex="-1"></a>          , <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span></span>
<span id="cb324-15"><a href="validate-tree-detection-and-crown-delineation.html#cb324-15" tabindex="-1"></a>        )</span>
<span id="cb324-16"><a href="validate-tree-detection-and-crown-delineation.html#cb324-16" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> match_grp)</span>
<span id="cb324-17"><a href="validate-tree-detection-and-crown-delineation.html#cb324-17" tabindex="-1"></a>    , <span class="at">color =</span> <span class="cn">NA</span> ,<span class="at">alpha=</span><span class="fl">0.7</span></span>
<span id="cb324-18"><a href="validate-tree-detection-and-crown-delineation.html#cb324-18" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb324-19"><a href="validate-tree-detection-and-crown-delineation.html#cb324-19" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb324-20"><a href="validate-tree-detection-and-crown-delineation.html#cb324-20" tabindex="-1"></a>    <span class="at">data =</span></span>
<span id="cb324-21"><a href="validate-tree-detection-and-crown-delineation.html#cb324-21" tabindex="-1"></a>      ans_crowns_no_mask <span class="sc">%&gt;%</span></span>
<span id="cb324-22"><a href="validate-tree-detection-and-crown-delineation.html#cb324-22" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb324-23"><a href="validate-tree-detection-and-crown-delineation.html#cb324-23" tabindex="-1"></a>          ground_truth_crown_match_ans <span class="sc">%&gt;%</span></span>
<span id="cb324-24"><a href="validate-tree-detection-and-crown-delineation.html#cb324-24" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(treeID_pred,match_grp)</span>
<span id="cb324-25"><a href="validate-tree-detection-and-crown-delineation.html#cb324-25" tabindex="-1"></a>          , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(treeID<span class="sc">==</span>treeID_pred)</span>
<span id="cb324-26"><a href="validate-tree-detection-and-crown-delineation.html#cb324-26" tabindex="-1"></a>        )</span>
<span id="cb324-27"><a href="validate-tree-detection-and-crown-delineation.html#cb324-27" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> match_grp, <span class="at">color =</span> match_grp)</span>
<span id="cb324-28"><a href="validate-tree-detection-and-crown-delineation.html#cb324-28" tabindex="-1"></a>    , <span class="at">alpha =</span> <span class="dv">0</span></span>
<span id="cb324-29"><a href="validate-tree-detection-and-crown-delineation.html#cb324-29" tabindex="-1"></a>    , <span class="at">lwd =</span> <span class="fl">1.2</span></span>
<span id="cb324-30"><a href="validate-tree-detection-and-crown-delineation.html#cb324-30" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb324-31"><a href="validate-tree-detection-and-crown-delineation.html#cb324-31" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values =</span> pal_match_grp, <span class="at">name =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb324-32"><a href="validate-tree-detection-and-crown-delineation.html#cb324-32" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> pal_match_grp, <span class="at">name =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb324-33"><a href="validate-tree-detection-and-crown-delineation.html#cb324-33" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb324-34"><a href="validate-tree-detection-and-crown-delineation.html#cb324-34" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">guides</span>(</span>
<span id="cb324-35"><a href="validate-tree-detection-and-crown-delineation.html#cb324-35" tabindex="-1"></a>    <span class="at">fill =</span> ggplot2<span class="sc">::</span><span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">color =</span> <span class="fu">c</span>(<span class="cn">NA</span>,<span class="cn">NA</span>,viridis<span class="sc">::</span><span class="fu">cividis</span>(<span class="dv">3</span>)[<span class="dv">2</span>])))</span>
<span id="cb324-36"><a href="validate-tree-detection-and-crown-delineation.html#cb324-36" tabindex="-1"></a>    , <span class="at">color =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb324-37"><a href="validate-tree-detection-and-crown-delineation.html#cb324-37" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-302-1.png" width="1008" /></p>
<p>Note the predicted crowns classified as commission errors that encompass multiple ground truth tree crowns which are counted as omission errors. Even though the predicted crowns cover at least on ground truth crowns, these instances are classified as such due to the criteria that “if the IoU is &lt;0.5: the predicted tree is considered an error” and thus no ground truth instance is matched</p>
<p>let’s quickly look at the IoU values on the true positive trees</p>
<div class="sourceCode" id="cb325"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb325-1"><a href="validate-tree-detection-and-crown-delineation.html#cb325-1" tabindex="-1"></a>ground_truth_crown_match_ans <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(iou) <span class="sc">%&gt;%</span> <span class="fu">summary</span>()</span></code></pre></div>
<pre><code>##       iou        
##  Min.   :0.6391  
##  1st Qu.:0.7235  
##  Median :0.7477  
##  Mean   :0.7473  
##  3rd Qu.:0.7696  
##  Max.   :0.8493  
##  NA&#39;s   :15</code></pre>
<p>Lastly, we’ll make a function to aggregate our plot-level scores to evaluate omission rate (false negative rate or miss rate), commission rate (false positive rate), precision, recall (detection rate), and the F-score metric. As a reminder, true positive (<span class="math inline">\(TP\)</span>) trees correctly match ground truth trees with a prediction, commission tree predictions do not match a ground truth tree (false positive; <span class="math inline">\(FP\)</span>), and omissions are ground truth trees for which no predictions match (false negative; <span class="math inline">\(FN\)</span>)</p>
<p><span class="math display">\[\textrm{omission rate} = \frac{FN}{TP+FN}\]</span></p>
<p><span class="math display">\[\textrm{commission rate} = \frac{FP}{TP+FP}\]</span></p>
<p><span class="math display">\[\textrm{precision} = \frac{TP}{TP+FP}\]</span></p>
<p><span class="math display">\[\textrm{recall} = \frac{TP}{TP+FN}\]</span></p>
<p><span class="math display">\[
\textrm{F-score} = 2 \times \frac{\bigl(precision \times recall \bigr)}{\bigl(precision + recall \bigr)}
\]</span></p>
<p>we’ll also automatically calculate root mean square error (RMSE) for the tree height in meters above ground if the we detect the <code>height_diff</code> column. Inclusion of tree height RMSE represents a complementary measure to the tree detection rates that captures the ability of the model to properly extract the tree tops.</p>
<p>tree height RMSE is calculated as</p>
<p><span class="math display">\[
\textrm{RMSE} = \sqrt{ \frac{  \sum_{i=1}^{N} (y_{i} - \hat{y_{i}})^{2}}{N}}
\]</span></p>
<p>Where <span class="math inline">\(N\)</span> is equal to the total number of trees either in a FOR-instance collection or in the whole dataset, <span class="math inline">\(y_i\)</span> is the reference height value and <span class="math inline">\(\hat{y_i}\)</span> is the predicted tree height value of tree <span class="math inline">\(i\)</span> in meters above ground (m).</p>
<div class="sourceCode" id="cb327"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb327-1"><a href="validate-tree-detection-and-crown-delineation.html#cb327-1" tabindex="-1"></a>agg_ground_truth_crown_match <span class="ot">&lt;-</span> <span class="cf">function</span>(ground_truth_crown_match_ans) {</span>
<span id="cb327-2"><a href="validate-tree-detection-and-crown-delineation.html#cb327-2" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(ground_truth_crown_match_ans)<span class="sc">==</span><span class="dv">0</span>){<span class="fu">return</span>(<span class="cn">NULL</span>)}</span>
<span id="cb327-3"><a href="validate-tree-detection-and-crown-delineation.html#cb327-3" tabindex="-1"></a>  <span class="cf">if</span>( <span class="sc">!</span>(<span class="fu">names</span>(ground_truth_crown_match_ans) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_equal</span>(<span class="st">&quot;match_grp&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">any</span>()) ){<span class="fu">stop</span>(<span class="st">&quot;ground_truth_crown_match_ans must contain `match_grp` column&quot;</span>)}</span>
<span id="cb327-4"><a href="validate-tree-detection-and-crown-delineation.html#cb327-4" tabindex="-1"></a>  <span class="co"># count by match group</span></span>
<span id="cb327-5"><a href="validate-tree-detection-and-crown-delineation.html#cb327-5" tabindex="-1"></a>  agg <span class="ot">&lt;-</span> ground_truth_crown_match_ans <span class="sc">%&gt;%</span> </span>
<span id="cb327-6"><a href="validate-tree-detection-and-crown-delineation.html#cb327-6" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">count</span>(match_grp) <span class="sc">%&gt;%</span> </span>
<span id="cb327-7"><a href="validate-tree-detection-and-crown-delineation.html#cb327-7" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb327-8"><a href="validate-tree-detection-and-crown-delineation.html#cb327-8" tabindex="-1"></a>      <span class="at">match_grp =</span> dplyr<span class="sc">::</span><span class="fu">case_match</span>(</span>
<span id="cb327-9"><a href="validate-tree-detection-and-crown-delineation.html#cb327-9" tabindex="-1"></a>        match_grp</span>
<span id="cb327-10"><a href="validate-tree-detection-and-crown-delineation.html#cb327-10" tabindex="-1"></a>        , <span class="st">&quot;true positive&quot;</span><span class="sc">~</span><span class="st">&quot;tp&quot;</span></span>
<span id="cb327-11"><a href="validate-tree-detection-and-crown-delineation.html#cb327-11" tabindex="-1"></a>        , <span class="st">&quot;commission&quot;</span><span class="sc">~</span><span class="st">&quot;fp&quot;</span></span>
<span id="cb327-12"><a href="validate-tree-detection-and-crown-delineation.html#cb327-12" tabindex="-1"></a>        , <span class="st">&quot;omission&quot;</span><span class="sc">~</span><span class="st">&quot;fn&quot;</span></span>
<span id="cb327-13"><a href="validate-tree-detection-and-crown-delineation.html#cb327-13" tabindex="-1"></a>      )</span>
<span id="cb327-14"><a href="validate-tree-detection-and-crown-delineation.html#cb327-14" tabindex="-1"></a>    )</span>
<span id="cb327-15"><a href="validate-tree-detection-and-crown-delineation.html#cb327-15" tabindex="-1"></a>  <span class="co"># true positive, false positive, false negative rates</span></span>
<span id="cb327-16"><a href="validate-tree-detection-and-crown-delineation.html#cb327-16" tabindex="-1"></a>  return_df <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">tibble</span>(<span class="at">match_grp =</span> <span class="fu">c</span>(<span class="st">&quot;tp&quot;</span>,<span class="st">&quot;fp&quot;</span>,<span class="st">&quot;fn&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb327-17"><a href="validate-tree-detection-and-crown-delineation.html#cb327-17" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(agg, <span class="at">by =</span> <span class="st">&quot;match_grp&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb327-18"><a href="validate-tree-detection-and-crown-delineation.html#cb327-18" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(dplyr<span class="sc">::</span><span class="fu">across</span>(<span class="at">.cols =</span> <span class="fu">c</span>(n), <span class="at">.fn =</span> <span class="sc">~</span>dplyr<span class="sc">::</span><span class="fu">coalesce</span>(.x,<span class="dv">0</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb327-19"><a href="validate-tree-detection-and-crown-delineation.html#cb327-19" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(</span>
<span id="cb327-20"><a href="validate-tree-detection-and-crown-delineation.html#cb327-20" tabindex="-1"></a>      <span class="at">names_from =</span> match_grp</span>
<span id="cb327-21"><a href="validate-tree-detection-and-crown-delineation.html#cb327-21" tabindex="-1"></a>      , <span class="at">values_from =</span> <span class="fu">c</span>(n)</span>
<span id="cb327-22"><a href="validate-tree-detection-and-crown-delineation.html#cb327-22" tabindex="-1"></a>      , <span class="at">names_glue =</span> <span class="st">&quot;{match_grp}_{.value}&quot;</span></span>
<span id="cb327-23"><a href="validate-tree-detection-and-crown-delineation.html#cb327-23" tabindex="-1"></a>    )</span>
<span id="cb327-24"><a href="validate-tree-detection-and-crown-delineation.html#cb327-24" tabindex="-1"></a>  <span class="co"># rates, precision, recall, f-score</span></span>
<span id="cb327-25"><a href="validate-tree-detection-and-crown-delineation.html#cb327-25" tabindex="-1"></a>  return_df <span class="ot">&lt;-</span> return_df <span class="sc">%&gt;%</span> </span>
<span id="cb327-26"><a href="validate-tree-detection-and-crown-delineation.html#cb327-26" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb327-27"><a href="validate-tree-detection-and-crown-delineation.html#cb327-27" tabindex="-1"></a>      <span class="at">omission_rate =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb327-28"><a href="validate-tree-detection-and-crown-delineation.html#cb327-28" tabindex="-1"></a>        (tp_n<span class="sc">+</span>fn_n) <span class="sc">==</span> <span class="dv">0</span>  <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb327-29"><a href="validate-tree-detection-and-crown-delineation.html#cb327-29" tabindex="-1"></a>        , T <span class="sc">~</span> fn_n<span class="sc">/</span>(tp_n<span class="sc">+</span>fn_n)</span>
<span id="cb327-30"><a href="validate-tree-detection-and-crown-delineation.html#cb327-30" tabindex="-1"></a>      ) <span class="co"># False Negative Rate or Miss Rate</span></span>
<span id="cb327-31"><a href="validate-tree-detection-and-crown-delineation.html#cb327-31" tabindex="-1"></a>      , <span class="at">commission_rate =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb327-32"><a href="validate-tree-detection-and-crown-delineation.html#cb327-32" tabindex="-1"></a>        (tp_n<span class="sc">+</span>fp_n) <span class="sc">==</span> <span class="dv">0</span>  <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb327-33"><a href="validate-tree-detection-and-crown-delineation.html#cb327-33" tabindex="-1"></a>        , T <span class="sc">~</span> fp_n<span class="sc">/</span>(tp_n<span class="sc">+</span>fp_n)</span>
<span id="cb327-34"><a href="validate-tree-detection-and-crown-delineation.html#cb327-34" tabindex="-1"></a>      ) <span class="co"># False Positive Rate</span></span>
<span id="cb327-35"><a href="validate-tree-detection-and-crown-delineation.html#cb327-35" tabindex="-1"></a>      , <span class="at">precision =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb327-36"><a href="validate-tree-detection-and-crown-delineation.html#cb327-36" tabindex="-1"></a>        (tp_n<span class="sc">+</span>fp_n) <span class="sc">==</span> <span class="dv">0</span>  <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb327-37"><a href="validate-tree-detection-and-crown-delineation.html#cb327-37" tabindex="-1"></a>        , T <span class="sc">~</span> tp_n<span class="sc">/</span>(tp_n<span class="sc">+</span>fp_n)</span>
<span id="cb327-38"><a href="validate-tree-detection-and-crown-delineation.html#cb327-38" tabindex="-1"></a>      )</span>
<span id="cb327-39"><a href="validate-tree-detection-and-crown-delineation.html#cb327-39" tabindex="-1"></a>      , <span class="at">recall =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb327-40"><a href="validate-tree-detection-and-crown-delineation.html#cb327-40" tabindex="-1"></a>        (tp_n<span class="sc">+</span>fn_n) <span class="sc">==</span> <span class="dv">0</span>  <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb327-41"><a href="validate-tree-detection-and-crown-delineation.html#cb327-41" tabindex="-1"></a>        , T <span class="sc">~</span> tp_n<span class="sc">/</span>(tp_n<span class="sc">+</span>fn_n)</span>
<span id="cb327-42"><a href="validate-tree-detection-and-crown-delineation.html#cb327-42" tabindex="-1"></a>      )</span>
<span id="cb327-43"><a href="validate-tree-detection-and-crown-delineation.html#cb327-43" tabindex="-1"></a>      , <span class="at">f_score =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb327-44"><a href="validate-tree-detection-and-crown-delineation.html#cb327-44" tabindex="-1"></a>        <span class="fu">is.na</span>(precision) <span class="sc">|</span> <span class="fu">is.na</span>(recall) <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb327-45"><a href="validate-tree-detection-and-crown-delineation.html#cb327-45" tabindex="-1"></a>        , (precision<span class="sc">+</span>recall) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="dv">0</span></span>
<span id="cb327-46"><a href="validate-tree-detection-and-crown-delineation.html#cb327-46" tabindex="-1"></a>        , T <span class="sc">~</span> <span class="dv">2</span> <span class="sc">*</span> ( (precision<span class="sc">*</span>recall)<span class="sc">/</span>(precision<span class="sc">+</span>recall) )</span>
<span id="cb327-47"><a href="validate-tree-detection-and-crown-delineation.html#cb327-47" tabindex="-1"></a>      )    </span>
<span id="cb327-48"><a href="validate-tree-detection-and-crown-delineation.html#cb327-48" tabindex="-1"></a>    )</span>
<span id="cb327-49"><a href="validate-tree-detection-and-crown-delineation.html#cb327-49" tabindex="-1"></a>  <span class="co"># height rmse</span></span>
<span id="cb327-50"><a href="validate-tree-detection-and-crown-delineation.html#cb327-50" tabindex="-1"></a>  <span class="cf">if</span>( <span class="fu">names</span>(ground_truth_crown_match_ans) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_equal</span>(<span class="st">&quot;height_diff&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">any</span>() ){</span>
<span id="cb327-51"><a href="validate-tree-detection-and-crown-delineation.html#cb327-51" tabindex="-1"></a>    return_df <span class="ot">&lt;-</span> return_df <span class="sc">%&gt;%</span> </span>
<span id="cb327-52"><a href="validate-tree-detection-and-crown-delineation.html#cb327-52" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">bind_cols</span>(</span>
<span id="cb327-53"><a href="validate-tree-detection-and-crown-delineation.html#cb327-53" tabindex="-1"></a>        ground_truth_crown_match_ans <span class="sc">%&gt;%</span> </span>
<span id="cb327-54"><a href="validate-tree-detection-and-crown-delineation.html#cb327-54" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb327-55"><a href="validate-tree-detection-and-crown-delineation.html#cb327-55" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb327-56"><a href="validate-tree-detection-and-crown-delineation.html#cb327-56" tabindex="-1"></a>          <span class="at">height_diff_sq =</span> <span class="fu">sum</span>(height_diff<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> T)</span>
<span id="cb327-57"><a href="validate-tree-detection-and-crown-delineation.html#cb327-57" tabindex="-1"></a>          , <span class="at">n =</span> <span class="fu">sum</span>(<span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(height_diff),<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb327-58"><a href="validate-tree-detection-and-crown-delineation.html#cb327-58" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb327-59"><a href="validate-tree-detection-and-crown-delineation.html#cb327-59" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb327-60"><a href="validate-tree-detection-and-crown-delineation.html#cb327-60" tabindex="-1"></a>          <span class="at">rmse_height_m =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb327-61"><a href="validate-tree-detection-and-crown-delineation.html#cb327-61" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">coalesce</span>(n,<span class="dv">0</span>)<span class="sc">==</span><span class="dv">0</span> <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb327-62"><a href="validate-tree-detection-and-crown-delineation.html#cb327-62" tabindex="-1"></a>            , T <span class="sc">~</span> <span class="fu">sqrt</span>(height_diff_sq<span class="sc">/</span>n)</span>
<span id="cb327-63"><a href="validate-tree-detection-and-crown-delineation.html#cb327-63" tabindex="-1"></a>          )</span>
<span id="cb327-64"><a href="validate-tree-detection-and-crown-delineation.html#cb327-64" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb327-65"><a href="validate-tree-detection-and-crown-delineation.html#cb327-65" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(rmse_height_m)</span>
<span id="cb327-66"><a href="validate-tree-detection-and-crown-delineation.html#cb327-66" tabindex="-1"></a>      )</span>
<span id="cb327-67"><a href="validate-tree-detection-and-crown-delineation.html#cb327-67" tabindex="-1"></a>  }</span>
<span id="cb327-68"><a href="validate-tree-detection-and-crown-delineation.html#cb327-68" tabindex="-1"></a>  <span class="co"># return</span></span>
<span id="cb327-69"><a href="validate-tree-detection-and-crown-delineation.html#cb327-69" tabindex="-1"></a>  <span class="fu">return</span>(return_df)</span>
<span id="cb327-70"><a href="validate-tree-detection-and-crown-delineation.html#cb327-70" tabindex="-1"></a>}</span></code></pre></div>
<p>let’s look at our score summary for this plot</p>
<div class="sourceCode" id="cb328"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb328-1"><a href="validate-tree-detection-and-crown-delineation.html#cb328-1" tabindex="-1"></a><span class="fu">agg_ground_truth_crown_match</span>(ground_truth_crown_match_ans)</span></code></pre></div>
<pre><code>## # A tibble: 1 × 9
##    tp_n  fp_n  fn_n omission_rate commission_rate precision recall f_score
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;         &lt;dbl&gt;           &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
## 1    10     4    11         0.524           0.286     0.714  0.476   0.571
## # ℹ 1 more variable: rmse_height_m &lt;dbl&gt;</code></pre>
<p>Finally, let’s compile this process into a function</p>
<div class="sourceCode" id="cb330"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb330-1"><a href="validate-tree-detection-and-crown-delineation.html#cb330-1" tabindex="-1"></a>fi_evaluate <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb330-2"><a href="validate-tree-detection-and-crown-delineation.html#cb330-2" tabindex="-1"></a>  predictions</span>
<span id="cb330-3"><a href="validate-tree-detection-and-crown-delineation.html#cb330-3" tabindex="-1"></a>  , las_f_path</span>
<span id="cb330-4"><a href="validate-tree-detection-and-crown-delineation.html#cb330-4" tabindex="-1"></a>  , <span class="at">remove_mask_overlap_pct =</span> <span class="fl">0.7</span></span>
<span id="cb330-5"><a href="validate-tree-detection-and-crown-delineation.html#cb330-5" tabindex="-1"></a>  , <span class="at">min_iou_pct =</span> <span class="fl">0.5</span></span>
<span id="cb330-6"><a href="validate-tree-detection-and-crown-delineation.html#cb330-6" tabindex="-1"></a>  , <span class="at">calculate_height_diff =</span> F</span>
<span id="cb330-7"><a href="validate-tree-detection-and-crown-delineation.html#cb330-7" tabindex="-1"></a>  , <span class="at">force_same_crs =</span> F</span>
<span id="cb330-8"><a href="validate-tree-detection-and-crown-delineation.html#cb330-8" tabindex="-1"></a>) {</span>
<span id="cb330-9"><a href="validate-tree-detection-and-crown-delineation.html#cb330-9" tabindex="-1"></a>  <span class="co"># checks, no balances</span></span>
<span id="cb330-10"><a href="validate-tree-detection-and-crown-delineation.html#cb330-10" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(las_f_path)){<span class="fu">stop</span>(<span class="fu">paste0</span>(<span class="st">&quot;could not locate point cloud file at</span><span class="sc">\n</span><span class="st">      &quot;</span>,las_f_path))}</span>
<span id="cb330-11"><a href="validate-tree-detection-and-crown-delineation.html#cb330-11" tabindex="-1"></a>  <span class="cf">if</span>( <span class="sc">!</span>(<span class="fu">names</span>(predictions) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_equal</span>(<span class="st">&quot;treeID&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">any</span>()) ){</span>
<span id="cb330-12"><a href="validate-tree-detection-and-crown-delineation.html#cb330-12" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;predictions tree data must contain `treeID` or `treeID` column&quot;</span>)</span>
<span id="cb330-13"><a href="validate-tree-detection-and-crown-delineation.html#cb330-13" tabindex="-1"></a>  }</span>
<span id="cb330-14"><a href="validate-tree-detection-and-crown-delineation.html#cb330-14" tabindex="-1"></a>  <span class="co"># get ground truth polygons</span></span>
<span id="cb330-15"><a href="validate-tree-detection-and-crown-delineation.html#cb330-15" tabindex="-1"></a>  ground_truth_temp <span class="ot">&lt;-</span> lidR<span class="sc">::</span><span class="fu">readLAS</span>(las_f_path) <span class="sc">%&gt;%</span> </span>
<span id="cb330-16"><a href="validate-tree-detection-and-crown-delineation.html#cb330-16" tabindex="-1"></a>    <span class="fu">fi_las_to_poly</span>(<span class="at">res =</span> <span class="fl">0.25</span>,<span class="at">smooth =</span> T) <span class="co"># hard-coded</span></span>
<span id="cb330-17"><a href="validate-tree-detection-and-crown-delineation.html#cb330-17" tabindex="-1"></a>  </span>
<span id="cb330-18"><a href="validate-tree-detection-and-crown-delineation.html#cb330-18" tabindex="-1"></a>  <span class="co"># force same crs</span></span>
<span id="cb330-19"><a href="validate-tree-detection-and-crown-delineation.html#cb330-19" tabindex="-1"></a>  <span class="cf">if</span>(force_same_crs){</span>
<span id="cb330-20"><a href="validate-tree-detection-and-crown-delineation.html#cb330-20" tabindex="-1"></a>    predictions <span class="ot">&lt;-</span> predictions <span class="sc">%&gt;%</span> sf<span class="sc">::</span><span class="fu">st_set_crs</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(ground_truth_temp<span class="sc">$</span>mask))</span>
<span id="cb330-21"><a href="validate-tree-detection-and-crown-delineation.html#cb330-21" tabindex="-1"></a>  }</span>
<span id="cb330-22"><a href="validate-tree-detection-and-crown-delineation.html#cb330-22" tabindex="-1"></a>  </span>
<span id="cb330-23"><a href="validate-tree-detection-and-crown-delineation.html#cb330-23" tabindex="-1"></a>  <span class="co"># remove predictions trees with &gt;70% overlap with mask</span></span>
<span id="cb330-24"><a href="validate-tree-detection-and-crown-delineation.html#cb330-24" tabindex="-1"></a>  ans_crowns_no_mask <span class="ot">&lt;-</span></span>
<span id="cb330-25"><a href="validate-tree-detection-and-crown-delineation.html#cb330-25" tabindex="-1"></a>    predictions <span class="sc">%&gt;%</span> </span>
<span id="cb330-26"><a href="validate-tree-detection-and-crown-delineation.html#cb330-26" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb330-27"><a href="validate-tree-detection-and-crown-delineation.html#cb330-27" tabindex="-1"></a>      <span class="co"># calculate area within mask</span></span>
<span id="cb330-28"><a href="validate-tree-detection-and-crown-delineation.html#cb330-28" tabindex="-1"></a>      predictions <span class="sc">%&gt;%</span> </span>
<span id="cb330-29"><a href="validate-tree-detection-and-crown-delineation.html#cb330-29" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(treeID) <span class="sc">%&gt;%</span> </span>
<span id="cb330-30"><a href="validate-tree-detection-and-crown-delineation.html#cb330-30" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_intersection</span>(ground_truth_temp<span class="sc">$</span>mask) <span class="sc">%&gt;%</span> </span>
<span id="cb330-31"><a href="validate-tree-detection-and-crown-delineation.html#cb330-31" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">mask_area =</span> sf<span class="sc">::</span><span class="fu">st_area</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb330-32"><a href="validate-tree-detection-and-crown-delineation.html#cb330-32" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb330-33"><a href="validate-tree-detection-and-crown-delineation.html#cb330-33" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(treeID,mask_area)</span>
<span id="cb330-34"><a href="validate-tree-detection-and-crown-delineation.html#cb330-34" tabindex="-1"></a>      , <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span></span>
<span id="cb330-35"><a href="validate-tree-detection-and-crown-delineation.html#cb330-35" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb330-36"><a href="validate-tree-detection-and-crown-delineation.html#cb330-36" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb330-37"><a href="validate-tree-detection-and-crown-delineation.html#cb330-37" tabindex="-1"></a>      ( dplyr<span class="sc">::</span><span class="fu">coalesce</span>(mask_area,<span class="dv">0</span>)<span class="sc">/</span><span class="fu">as.numeric</span>(sf<span class="sc">::</span><span class="fu">st_area</span>(.)) ) <span class="sc">&lt;</span> remove_mask_overlap_pct</span>
<span id="cb330-38"><a href="validate-tree-detection-and-crown-delineation.html#cb330-38" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb330-39"><a href="validate-tree-detection-and-crown-delineation.html#cb330-39" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>mask_area)</span>
<span id="cb330-40"><a href="validate-tree-detection-and-crown-delineation.html#cb330-40" tabindex="-1"></a>  </span>
<span id="cb330-41"><a href="validate-tree-detection-and-crown-delineation.html#cb330-41" tabindex="-1"></a>  <span class="co"># tree matching process on the full data</span></span>
<span id="cb330-42"><a href="validate-tree-detection-and-crown-delineation.html#cb330-42" tabindex="-1"></a>  ground_truth_crown_match_ans <span class="ot">&lt;-</span> <span class="fu">ground_truth_crown_match</span>(</span>
<span id="cb330-43"><a href="validate-tree-detection-and-crown-delineation.html#cb330-43" tabindex="-1"></a>    <span class="co"># ground_truth should be sorted already</span></span>
<span id="cb330-44"><a href="validate-tree-detection-and-crown-delineation.html#cb330-44" tabindex="-1"></a>    <span class="at">ground_truth =</span> ground_truth_temp<span class="sc">$</span>crowns <span class="sc">%&gt;%</span> </span>
<span id="cb330-45"><a href="validate-tree-detection-and-crown-delineation.html#cb330-45" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(gt_tree_height)) <span class="co"># column calculated in fi_las_to_poly()</span></span>
<span id="cb330-46"><a href="validate-tree-detection-and-crown-delineation.html#cb330-46" tabindex="-1"></a>    , <span class="at">predictions =</span> ans_crowns_no_mask</span>
<span id="cb330-47"><a href="validate-tree-detection-and-crown-delineation.html#cb330-47" tabindex="-1"></a>    , <span class="at">min_iou_pct =</span> min_iou_pct</span>
<span id="cb330-48"><a href="validate-tree-detection-and-crown-delineation.html#cb330-48" tabindex="-1"></a>    , <span class="at">calculate_height_diff =</span> calculate_height_diff</span>
<span id="cb330-49"><a href="validate-tree-detection-and-crown-delineation.html#cb330-49" tabindex="-1"></a>  )</span>
<span id="cb330-50"><a href="validate-tree-detection-and-crown-delineation.html#cb330-50" tabindex="-1"></a>  </span>
<span id="cb330-51"><a href="validate-tree-detection-and-crown-delineation.html#cb330-51" tabindex="-1"></a>  <span class="co"># plot-level score</span></span>
<span id="cb330-52"><a href="validate-tree-detection-and-crown-delineation.html#cb330-52" tabindex="-1"></a>  plot_score <span class="ot">&lt;-</span> <span class="fu">agg_ground_truth_crown_match</span>(ground_truth_crown_match_ans)</span>
<span id="cb330-53"><a href="validate-tree-detection-and-crown-delineation.html#cb330-53" tabindex="-1"></a>  </span>
<span id="cb330-54"><a href="validate-tree-detection-and-crown-delineation.html#cb330-54" tabindex="-1"></a>  <span class="co"># return</span></span>
<span id="cb330-55"><a href="validate-tree-detection-and-crown-delineation.html#cb330-55" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb330-56"><a href="validate-tree-detection-and-crown-delineation.html#cb330-56" tabindex="-1"></a>    <span class="at">plot_score =</span> plot_score</span>
<span id="cb330-57"><a href="validate-tree-detection-and-crown-delineation.html#cb330-57" tabindex="-1"></a>    , <span class="at">ground_truth_crown_match =</span> ground_truth_crown_match_ans</span>
<span id="cb330-58"><a href="validate-tree-detection-and-crown-delineation.html#cb330-58" tabindex="-1"></a>    , <span class="at">ground_truth_crowns =</span> ground_truth_temp<span class="sc">$</span>crowns</span>
<span id="cb330-59"><a href="validate-tree-detection-and-crown-delineation.html#cb330-59" tabindex="-1"></a>  ))</span>
<span id="cb330-60"><a href="validate-tree-detection-and-crown-delineation.html#cb330-60" tabindex="-1"></a>}</span></code></pre></div>
<p>test it</p>
<div class="sourceCode" id="cb331"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb331-1"><a href="validate-tree-detection-and-crown-delineation.html#cb331-1" tabindex="-1"></a>fi_evaluate_ans_temp <span class="ot">&lt;-</span> <span class="fu">fi_evaluate</span>(</span>
<span id="cb331-2"><a href="validate-tree-detection-and-crown-delineation.html#cb331-2" tabindex="-1"></a>  <span class="at">predictions =</span> ans_crowns</span>
<span id="cb331-3"><a href="validate-tree-detection-and-crown-delineation.html#cb331-3" tabindex="-1"></a>  , <span class="at">las_f_path =</span> fi_lidar_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">slice</span>(lidar_df_row_temp) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">pull</span>(f_path)</span>
<span id="cb331-4"><a href="validate-tree-detection-and-crown-delineation.html#cb331-4" tabindex="-1"></a>  , <span class="at">calculate_height_diff =</span> T</span>
<span id="cb331-5"><a href="validate-tree-detection-and-crown-delineation.html#cb331-5" tabindex="-1"></a>  , <span class="at">force_same_crs =</span> T</span>
<span id="cb331-6"><a href="validate-tree-detection-and-crown-delineation.html#cb331-6" tabindex="-1"></a>)</span>
<span id="cb331-7"><a href="validate-tree-detection-and-crown-delineation.html#cb331-7" tabindex="-1"></a><span class="co"># fi_evaluate_ans_temp</span></span>
<span id="cb331-8"><a href="validate-tree-detection-and-crown-delineation.html#cb331-8" tabindex="-1"></a>fi_evaluate_ans_temp<span class="sc">$</span>plot_score</span></code></pre></div>
<pre><code>## # A tibble: 1 × 9
##    tp_n  fp_n  fn_n omission_rate commission_rate precision recall f_score
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;         &lt;dbl&gt;           &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
## 1    10     4    11         0.524           0.286     0.714  0.476   0.571
## # ℹ 1 more variable: rmse_height_m &lt;dbl&gt;</code></pre>
<p>plot the test</p>
<div class="sourceCode" id="cb333"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb333-1"><a href="validate-tree-detection-and-crown-delineation.html#cb333-1" tabindex="-1"></a><span class="co"># plot it</span></span>
<span id="cb333-2"><a href="validate-tree-detection-and-crown-delineation.html#cb333-2" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb333-3"><a href="validate-tree-detection-and-crown-delineation.html#cb333-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb333-4"><a href="validate-tree-detection-and-crown-delineation.html#cb333-4" tabindex="-1"></a>    <span class="at">data =</span> </span>
<span id="cb333-5"><a href="validate-tree-detection-and-crown-delineation.html#cb333-5" tabindex="-1"></a>      fi_evaluate_ans_temp<span class="sc">$</span>ground_truth_crowns <span class="sc">%&gt;%</span> </span>
<span id="cb333-6"><a href="validate-tree-detection-and-crown-delineation.html#cb333-6" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb333-7"><a href="validate-tree-detection-and-crown-delineation.html#cb333-7" tabindex="-1"></a>          fi_evaluate_ans_temp<span class="sc">$</span>ground_truth_crown_match <span class="sc">%&gt;%</span> </span>
<span id="cb333-8"><a href="validate-tree-detection-and-crown-delineation.html#cb333-8" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(treeID,match_grp)</span>
<span id="cb333-9"><a href="validate-tree-detection-and-crown-delineation.html#cb333-9" tabindex="-1"></a>          , <span class="at">by =</span> <span class="st">&quot;treeID&quot;</span></span>
<span id="cb333-10"><a href="validate-tree-detection-and-crown-delineation.html#cb333-10" tabindex="-1"></a>        )</span>
<span id="cb333-11"><a href="validate-tree-detection-and-crown-delineation.html#cb333-11" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> match_grp)</span>
<span id="cb333-12"><a href="validate-tree-detection-and-crown-delineation.html#cb333-12" tabindex="-1"></a>    , <span class="at">color =</span> <span class="cn">NA</span> ,<span class="at">alpha=</span><span class="fl">0.7</span></span>
<span id="cb333-13"><a href="validate-tree-detection-and-crown-delineation.html#cb333-13" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb333-14"><a href="validate-tree-detection-and-crown-delineation.html#cb333-14" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_sf</span>(</span>
<span id="cb333-15"><a href="validate-tree-detection-and-crown-delineation.html#cb333-15" tabindex="-1"></a>    <span class="at">data =</span></span>
<span id="cb333-16"><a href="validate-tree-detection-and-crown-delineation.html#cb333-16" tabindex="-1"></a>      ans_crowns <span class="sc">%&gt;%</span> </span>
<span id="cb333-17"><a href="validate-tree-detection-and-crown-delineation.html#cb333-17" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb333-18"><a href="validate-tree-detection-and-crown-delineation.html#cb333-18" tabindex="-1"></a>          fi_evaluate_ans_temp<span class="sc">$</span>ground_truth_crown_match <span class="sc">%&gt;%</span> </span>
<span id="cb333-19"><a href="validate-tree-detection-and-crown-delineation.html#cb333-19" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(treeID_pred,match_grp)</span>
<span id="cb333-20"><a href="validate-tree-detection-and-crown-delineation.html#cb333-20" tabindex="-1"></a>          , <span class="at">by =</span> dplyr<span class="sc">::</span><span class="fu">join_by</span>(treeID<span class="sc">==</span>treeID_pred)</span>
<span id="cb333-21"><a href="validate-tree-detection-and-crown-delineation.html#cb333-21" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb333-22"><a href="validate-tree-detection-and-crown-delineation.html#cb333-22" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_set_crs</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(fi_evaluate_ans_temp<span class="sc">$</span>ground_truth_crowns))</span>
<span id="cb333-23"><a href="validate-tree-detection-and-crown-delineation.html#cb333-23" tabindex="-1"></a>    , <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">fill =</span> match_grp, <span class="at">color =</span> match_grp)</span>
<span id="cb333-24"><a href="validate-tree-detection-and-crown-delineation.html#cb333-24" tabindex="-1"></a>    , <span class="at">alpha =</span> <span class="dv">0</span></span>
<span id="cb333-25"><a href="validate-tree-detection-and-crown-delineation.html#cb333-25" tabindex="-1"></a>    , <span class="at">lwd =</span> <span class="fl">1.2</span></span>
<span id="cb333-26"><a href="validate-tree-detection-and-crown-delineation.html#cb333-26" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb333-27"><a href="validate-tree-detection-and-crown-delineation.html#cb333-27" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values =</span> pal_match_grp, <span class="at">name =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb333-28"><a href="validate-tree-detection-and-crown-delineation.html#cb333-28" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> pal_match_grp, <span class="at">name =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb333-29"><a href="validate-tree-detection-and-crown-delineation.html#cb333-29" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb333-30"><a href="validate-tree-detection-and-crown-delineation.html#cb333-30" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">guides</span>(</span>
<span id="cb333-31"><a href="validate-tree-detection-and-crown-delineation.html#cb333-31" tabindex="-1"></a>    <span class="at">fill =</span> ggplot2<span class="sc">::</span><span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">color =</span> <span class="fu">c</span>(<span class="cn">NA</span>,<span class="cn">NA</span>,viridis<span class="sc">::</span><span class="fu">cividis</span>(<span class="dv">3</span>)[<span class="dv">2</span>])))</span>
<span id="cb333-32"><a href="validate-tree-detection-and-crown-delineation.html#cb333-32" tabindex="-1"></a>    , <span class="at">color =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb333-33"><a href="validate-tree-detection-and-crown-delineation.html#cb333-33" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-308-1.png" width="1008" /></p>
<p>works</p>
</div>
</div>
<div id="training-validation-process-1" class="section level3 hasAnchor" number="4.3.3">
<h3><span class="header-section-number">4.3.3</span> Training validation process<a href="validate-tree-detection-and-crown-delineation.html#training-validation-process-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Now that we have been through the validation process for a <a href="validate-tree-detection-and-crown-delineation.html#ex_valid2">single sample plot</a> and <a href="validate-tree-detection-and-crown-delineation.html#itd_more">defined different variable window functions</a> for use in ITD, we’ll detect trees and delineate tree crowns using our <code>cloud2trees::cloud2trees()</code> <a href="validate-tree-detection-and-crown-delineation.html#xtract">method</a> to apply over each training lidar data set.</p>
<p>We’ll extract trees on each training data set using all 15 <a href="validate-tree-detection-and-crown-delineation.html#itd_more">variable window functions</a>, compare our point cloud-detected trees to the ground truth trees, and store the best variable window function by study site for use in validation on the evaluation lidar data.</p>
<div id="extract-trees-for-training-data-1" class="section level4 hasAnchor" number="4.3.3.1">
<h4><span class="header-section-number">4.3.3.1</span> Extract trees for training data<a href="validate-tree-detection-and-crown-delineation.html#extract-trees-for-training-data-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>extract trees from the training lidar data using each variable window function</p>
<div class="sourceCode" id="cb334"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb334-1"><a href="validate-tree-detection-and-crown-delineation.html#cb334-1" tabindex="-1"></a><span class="co"># where should we save the file?</span></span>
<span id="cb334-2"><a href="validate-tree-detection-and-crown-delineation.html#cb334-2" tabindex="-1"></a>submission_fn_temp <span class="ot">&lt;-</span> <span class="st">&quot;../data/ForInstance_training_submission.gpkg&quot;</span></span>
<span id="cb334-3"><a href="validate-tree-detection-and-crown-delineation.html#cb334-3" tabindex="-1"></a><span class="co"># if we don&#39;t already have the data, run it</span></span>
<span id="cb334-4"><a href="validate-tree-detection-and-crown-delineation.html#cb334-4" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(submission_fn_temp)){</span>
<span id="cb334-5"><a href="validate-tree-detection-and-crown-delineation.html#cb334-5" tabindex="-1"></a><span class="co"># if(T){ </span><span class="al">###</span><span class="co"> !!!!!!! take out when it gets real</span></span>
<span id="cb334-6"><a href="validate-tree-detection-and-crown-delineation.html#cb334-6" tabindex="-1"></a>  <span class="co"># just get training</span></span>
<span id="cb334-7"><a href="validate-tree-detection-and-crown-delineation.html#cb334-7" tabindex="-1"></a>  training_df_temp <span class="ot">&lt;-</span> fi_lidar_df <span class="sc">%&gt;%</span> </span>
<span id="cb334-8"><a href="validate-tree-detection-and-crown-delineation.html#cb334-8" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(data_type <span class="sc">==</span> <span class="st">&quot;training&quot;</span>)</span>
<span id="cb334-9"><a href="validate-tree-detection-and-crown-delineation.html#cb334-9" tabindex="-1"></a>  <span class="co"># get trees for each training plot and ws fn combination</span></span>
<span id="cb334-10"><a href="validate-tree-detection-and-crown-delineation.html#cb334-10" tabindex="-1"></a>  fi_training_submission <span class="ot">&lt;-</span> </span>
<span id="cb334-11"><a href="validate-tree-detection-and-crown-delineation.html#cb334-11" tabindex="-1"></a>    <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(training_df_temp) <span class="sc">%&gt;%</span> </span>
<span id="cb334-12"><a href="validate-tree-detection-and-crown-delineation.html#cb334-12" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">map</span>(\(x) </span>
<span id="cb334-13"><a href="validate-tree-detection-and-crown-delineation.html#cb334-13" tabindex="-1"></a>      <span class="fu">ws_fn_eval</span>(</span>
<span id="cb334-14"><a href="validate-tree-detection-and-crown-delineation.html#cb334-14" tabindex="-1"></a>        <span class="at">lidar_df =</span> training_df_temp </span>
<span id="cb334-15"><a href="validate-tree-detection-and-crown-delineation.html#cb334-15" tabindex="-1"></a>        , <span class="at">lidar_df_row =</span> x</span>
<span id="cb334-16"><a href="validate-tree-detection-and-crown-delineation.html#cb334-16" tabindex="-1"></a>        , <span class="at">ws_fn_list =</span> my_ws_functions</span>
<span id="cb334-17"><a href="validate-tree-detection-and-crown-delineation.html#cb334-17" tabindex="-1"></a>      )</span>
<span id="cb334-18"><a href="validate-tree-detection-and-crown-delineation.html#cb334-18" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb334-19"><a href="validate-tree-detection-and-crown-delineation.html#cb334-19" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span>
<span id="cb334-20"><a href="validate-tree-detection-and-crown-delineation.html#cb334-20" tabindex="-1"></a>  <span class="co"># generate treeID</span></span>
<span id="cb334-21"><a href="validate-tree-detection-and-crown-delineation.html#cb334-21" tabindex="-1"></a>  fi_training_submission <span class="ot">&lt;-</span> fi_training_submission <span class="sc">%&gt;%</span> </span>
<span id="cb334-22"><a href="validate-tree-detection-and-crown-delineation.html#cb334-22" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">group_by</span>(plot_name,ws_fn_nm) <span class="sc">%&gt;%</span> </span>
<span id="cb334-23"><a href="validate-tree-detection-and-crown-delineation.html#cb334-23" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">treeID =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb334-24"><a href="validate-tree-detection-and-crown-delineation.html#cb334-24" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">ungroup</span>()</span>
<span id="cb334-25"><a href="validate-tree-detection-and-crown-delineation.html#cb334-25" tabindex="-1"></a>  <span class="co"># save it </span></span>
<span id="cb334-26"><a href="validate-tree-detection-and-crown-delineation.html#cb334-26" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_write</span>(fi_training_submission, submission_fn_temp, <span class="at">append =</span> F)</span>
<span id="cb334-27"><a href="validate-tree-detection-and-crown-delineation.html#cb334-27" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb334-28"><a href="validate-tree-detection-and-crown-delineation.html#cb334-28" tabindex="-1"></a>  fi_training_submission <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(submission_fn_temp, <span class="at">quiet =</span> T)</span>
<span id="cb334-29"><a href="validate-tree-detection-and-crown-delineation.html#cb334-29" tabindex="-1"></a>}</span></code></pre></div>
<p>what did we get?</p>
<div class="sourceCode" id="cb335"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb335-1"><a href="validate-tree-detection-and-crown-delineation.html#cb335-1" tabindex="-1"></a>fi_training_submission <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 24,298
## Columns: 10
## $ xmin          &lt;dbl&gt; 480589.2, 480597.8, 480580.0, 480591.8, 480606.5, 480599…
## $ xmax          &lt;dbl&gt; 480594.8, 480601.8, 480584.8, 480597.2, 480607.8, 480605…
## $ ymin          &lt;dbl&gt; 5601168, 5601170, 5601164, 5601164, 5601166, 5601162, 56…
## $ ymax          &lt;dbl&gt; 5601171, 5601171, 5601171, 5601171, 5601168, 5601170, 56…
## $ label         &lt;chr&gt; &quot;Tree&quot;, &quot;Tree&quot;, &quot;Tree&quot;, &quot;Tree&quot;, &quot;Tree&quot;, &quot;Tree&quot;, &quot;Tree&quot;, …
## $ plot_name     &lt;chr&gt; &quot;CULS_plot_1_annotated&quot;, &quot;CULS_plot_1_annotated&quot;, &quot;CULS_…
## $ tree_height_m &lt;dbl&gt; 25.418, 24.812, 27.617, 24.112, 18.258, 27.227, 25.872, …
## $ ws_fn_nm      &lt;chr&gt; &quot;lin_fn&quot;, &quot;lin_fn&quot;, &quot;lin_fn&quot;, &quot;lin_fn&quot;, &quot;lin_fn&quot;, &quot;lin_f…
## $ treeID        &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 1…
## $ geom          &lt;POLYGON&gt; POLYGON ((480590.2 5601171,..., POLYGON ((480598 560…</code></pre>
<p>tabulate detected trees by plot and variable window function and plot it</p>
<div class="sourceCode" id="cb337"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb337-1"><a href="validate-tree-detection-and-crown-delineation.html#cb337-1" tabindex="-1"></a>fi_training_submission <span class="sc">%&gt;%</span> </span>
<span id="cb337-2"><a href="validate-tree-detection-and-crown-delineation.html#cb337-2" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb337-3"><a href="validate-tree-detection-and-crown-delineation.html#cb337-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(plot_name,ws_fn_nm) <span class="sc">%&gt;%</span> </span>
<span id="cb337-4"><a href="validate-tree-detection-and-crown-delineation.html#cb337-4" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> n, <span class="at">y =</span> plot_name, <span class="at">color =</span> ws_fn_nm)) <span class="sc">+</span></span>
<span id="cb337-5"><a href="validate-tree-detection-and-crown-delineation.html#cb337-5" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb337-6"><a href="validate-tree-detection-and-crown-delineation.html#cb337-6" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> pal_ws) <span class="sc">+</span></span>
<span id="cb337-7"><a href="validate-tree-detection-and-crown-delineation.html#cb337-7" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_x_log10</span>(<span class="at">labels=</span>scales<span class="sc">::</span>comma) <span class="sc">+</span></span>
<span id="cb337-8"><a href="validate-tree-detection-and-crown-delineation.html#cb337-8" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb337-9"><a href="validate-tree-detection-and-crown-delineation.html#cb337-9" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">&quot;# trees&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb337-10"><a href="validate-tree-detection-and-crown-delineation.html#cb337-10" tabindex="-1"></a>      , <span class="at">color =</span> <span class="st">&quot;variable</span><span class="sc">\n</span><span class="st">window</span><span class="sc">\n</span><span class="st">function&quot;</span></span>
<span id="cb337-11"><a href="validate-tree-detection-and-crown-delineation.html#cb337-11" tabindex="-1"></a>      , <span class="at">subtitle =</span> <span class="st">&quot;Training data: number of detected canopy trees&quot;</span></span>
<span id="cb337-12"><a href="validate-tree-detection-and-crown-delineation.html#cb337-12" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb337-13"><a href="validate-tree-detection-and-crown-delineation.html#cb337-13" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb337-14"><a href="validate-tree-detection-and-crown-delineation.html#cb337-14" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb337-15"><a href="validate-tree-detection-and-crown-delineation.html#cb337-15" tabindex="-1"></a>      <span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">8</span>)</span>
<span id="cb337-16"><a href="validate-tree-detection-and-crown-delineation.html#cb337-16" tabindex="-1"></a>      , <span class="at">panel.grid.major.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_line</span>(<span class="at">color=</span><span class="st">&quot;gray22&quot;</span>)</span>
<span id="cb337-17"><a href="validate-tree-detection-and-crown-delineation.html#cb337-17" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb337-18"><a href="validate-tree-detection-and-crown-delineation.html#cb337-18" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">guides</span>(</span>
<span id="cb337-19"><a href="validate-tree-detection-and-crown-delineation.html#cb337-19" tabindex="-1"></a>      <span class="at">color =</span> ggplot2<span class="sc">::</span><span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">shape =</span> <span class="dv">15</span>, <span class="at">size =</span> <span class="dv">6</span>))</span>
<span id="cb337-20"><a href="validate-tree-detection-and-crown-delineation.html#cb337-20" tabindex="-1"></a>    )</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-312-1.png" width="1008" /></p>
</div>
<div id="training-validation-against-ground-truth-1" class="section level4 hasAnchor" number="4.3.3.2">
<h4><span class="header-section-number">4.3.3.2</span> Training: validation against ground truth<a href="validate-tree-detection-and-crown-delineation.html#training-validation-against-ground-truth-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>We’ll compare our aerial point cloud-based tree detection and crown delineation results to the ground truth using the steps we outlined in the <a href="validate-tree-detection-and-crown-delineation.html#ex_valid2">example above</a>.</p>
<div class="sourceCode" id="cb338"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb338-1"><a href="validate-tree-detection-and-crown-delineation.html#cb338-1" tabindex="-1"></a><span class="co"># where should we save the file?</span></span>
<span id="cb338-2"><a href="validate-tree-detection-and-crown-delineation.html#cb338-2" tabindex="-1"></a>training_eval_temp <span class="ot">&lt;-</span> <span class="st">&quot;../data/ForInstance_training_evaluate.csv&quot;</span></span>
<span id="cb338-3"><a href="validate-tree-detection-and-crown-delineation.html#cb338-3" tabindex="-1"></a>training_eval_m_temp <span class="ot">&lt;-</span> <span class="st">&quot;../data/ForInstance_training_evaluate_crown_match.csv&quot;</span></span>
<span id="cb338-4"><a href="validate-tree-detection-and-crown-delineation.html#cb338-4" tabindex="-1"></a>training_eval_c_temp <span class="ot">&lt;-</span> <span class="st">&quot;../data/ForInstance_training_evaluate_gt_crowns.gpkg&quot;</span></span>
<span id="cb338-5"><a href="validate-tree-detection-and-crown-delineation.html#cb338-5" tabindex="-1"></a><span class="co"># if we don&#39;t already have the data, run it</span></span>
<span id="cb338-6"><a href="validate-tree-detection-and-crown-delineation.html#cb338-6" tabindex="-1"></a><span class="cf">if</span>(</span>
<span id="cb338-7"><a href="validate-tree-detection-and-crown-delineation.html#cb338-7" tabindex="-1"></a>  <span class="sc">!</span><span class="fu">file.exists</span>(training_eval_temp) <span class="sc">||</span></span>
<span id="cb338-8"><a href="validate-tree-detection-and-crown-delineation.html#cb338-8" tabindex="-1"></a>  <span class="sc">!</span><span class="fu">file.exists</span>(training_eval_m_temp) <span class="sc">||</span></span>
<span id="cb338-9"><a href="validate-tree-detection-and-crown-delineation.html#cb338-9" tabindex="-1"></a>  <span class="sc">!</span><span class="fu">file.exists</span>(training_eval_c_temp)</span>
<span id="cb338-10"><a href="validate-tree-detection-and-crown-delineation.html#cb338-10" tabindex="-1"></a>){</span>
<span id="cb338-11"><a href="validate-tree-detection-and-crown-delineation.html#cb338-11" tabindex="-1"></a><span class="co"># if(T){</span></span>
<span id="cb338-12"><a href="validate-tree-detection-and-crown-delineation.html#cb338-12" tabindex="-1"></a>  <span class="co"># get unique plot_name,ws_fn_nm</span></span>
<span id="cb338-13"><a href="validate-tree-detection-and-crown-delineation.html#cb338-13" tabindex="-1"></a>  combs_temp <span class="ot">&lt;-</span></span>
<span id="cb338-14"><a href="validate-tree-detection-and-crown-delineation.html#cb338-14" tabindex="-1"></a>    fi_training_submission <span class="sc">%&gt;%</span> </span>
<span id="cb338-15"><a href="validate-tree-detection-and-crown-delineation.html#cb338-15" tabindex="-1"></a>    sf<span class="sc">::</span><span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb338-16"><a href="validate-tree-detection-and-crown-delineation.html#cb338-16" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">distinct</span>(plot_name,ws_fn_nm)</span>
<span id="cb338-17"><a href="validate-tree-detection-and-crown-delineation.html#cb338-17" tabindex="-1"></a>  </span>
<span id="cb338-18"><a href="validate-tree-detection-and-crown-delineation.html#cb338-18" tabindex="-1"></a>  <span class="co"># safe it</span></span>
<span id="cb338-19"><a href="validate-tree-detection-and-crown-delineation.html#cb338-19" tabindex="-1"></a>  safe_fi_evaluate <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">safely</span>(fi_evaluate)</span>
<span id="cb338-20"><a href="validate-tree-detection-and-crown-delineation.html#cb338-20" tabindex="-1"></a>  </span>
<span id="cb338-21"><a href="validate-tree-detection-and-crown-delineation.html#cb338-21" tabindex="-1"></a>  <span class="co"># set up empty sets</span></span>
<span id="cb338-22"><a href="validate-tree-detection-and-crown-delineation.html#cb338-22" tabindex="-1"></a>  training_plot_score_df <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb338-23"><a href="validate-tree-detection-and-crown-delineation.html#cb338-23" tabindex="-1"></a>  training_ground_truth_crown_match_df <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb338-24"><a href="validate-tree-detection-and-crown-delineation.html#cb338-24" tabindex="-1"></a>  training_ground_truth_crowns_df <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb338-25"><a href="validate-tree-detection-and-crown-delineation.html#cb338-25" tabindex="-1"></a>  </span>
<span id="cb338-26"><a href="validate-tree-detection-and-crown-delineation.html#cb338-26" tabindex="-1"></a>  <span class="co"># we&#39;ll just loop this validation</span></span>
<span id="cb338-27"><a href="validate-tree-detection-and-crown-delineation.html#cb338-27" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(combs_temp)) {</span>
<span id="cb338-28"><a href="validate-tree-detection-and-crown-delineation.html#cb338-28" tabindex="-1"></a>    <span class="co"># validate</span></span>
<span id="cb338-29"><a href="validate-tree-detection-and-crown-delineation.html#cb338-29" tabindex="-1"></a>    fi_evaluate_ans_temp <span class="ot">&lt;-</span> <span class="fu">safe_fi_evaluate</span>(</span>
<span id="cb338-30"><a href="validate-tree-detection-and-crown-delineation.html#cb338-30" tabindex="-1"></a>      <span class="at">predictions =</span> </span>
<span id="cb338-31"><a href="validate-tree-detection-and-crown-delineation.html#cb338-31" tabindex="-1"></a>        fi_training_submission <span class="sc">%&gt;%</span> </span>
<span id="cb338-32"><a href="validate-tree-detection-and-crown-delineation.html#cb338-32" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb338-33"><a href="validate-tree-detection-and-crown-delineation.html#cb338-33" tabindex="-1"></a>          plot_name <span class="sc">==</span> combs_temp<span class="sc">$</span>plot_name[i]</span>
<span id="cb338-34"><a href="validate-tree-detection-and-crown-delineation.html#cb338-34" tabindex="-1"></a>          <span class="sc">&amp;</span> ws_fn_nm <span class="sc">==</span> combs_temp<span class="sc">$</span>ws_fn_nm[i]</span>
<span id="cb338-35"><a href="validate-tree-detection-and-crown-delineation.html#cb338-35" tabindex="-1"></a>        )</span>
<span id="cb338-36"><a href="validate-tree-detection-and-crown-delineation.html#cb338-36" tabindex="-1"></a>      , <span class="at">las_f_path =</span> fi_lidar_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(plot_name<span class="sc">==</span>combs_temp<span class="sc">$</span>plot_name[i]) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">pull</span>(f_path)</span>
<span id="cb338-37"><a href="validate-tree-detection-and-crown-delineation.html#cb338-37" tabindex="-1"></a>      , <span class="at">remove_mask_overlap_pct =</span> <span class="fl">0.7</span></span>
<span id="cb338-38"><a href="validate-tree-detection-and-crown-delineation.html#cb338-38" tabindex="-1"></a>      , <span class="at">min_iou_pct =</span> <span class="fl">0.5</span></span>
<span id="cb338-39"><a href="validate-tree-detection-and-crown-delineation.html#cb338-39" tabindex="-1"></a>      , <span class="at">calculate_height_diff =</span> T</span>
<span id="cb338-40"><a href="validate-tree-detection-and-crown-delineation.html#cb338-40" tabindex="-1"></a>      , <span class="at">force_same_crs =</span> T</span>
<span id="cb338-41"><a href="validate-tree-detection-and-crown-delineation.html#cb338-41" tabindex="-1"></a>    )</span>
<span id="cb338-42"><a href="validate-tree-detection-and-crown-delineation.html#cb338-42" tabindex="-1"></a>    <span class="co"># populate results if available</span></span>
<span id="cb338-43"><a href="validate-tree-detection-and-crown-delineation.html#cb338-43" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.null</span>(fi_evaluate_ans_temp<span class="sc">$</span>error)){</span>
<span id="cb338-44"><a href="validate-tree-detection-and-crown-delineation.html#cb338-44" tabindex="-1"></a>      <span class="co"># training_plot_score_df</span></span>
<span id="cb338-45"><a href="validate-tree-detection-and-crown-delineation.html#cb338-45" tabindex="-1"></a>      training_plot_score_df <span class="ot">&lt;-</span> training_plot_score_df <span class="sc">%&gt;%</span> </span>
<span id="cb338-46"><a href="validate-tree-detection-and-crown-delineation.html#cb338-46" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb338-47"><a href="validate-tree-detection-and-crown-delineation.html#cb338-47" tabindex="-1"></a>          fi_evaluate_ans_temp<span class="sc">$</span>result<span class="sc">$</span>plot_score <span class="sc">%&gt;%</span> </span>
<span id="cb338-48"><a href="validate-tree-detection-and-crown-delineation.html#cb338-48" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb338-49"><a href="validate-tree-detection-and-crown-delineation.html#cb338-49" tabindex="-1"></a>              <span class="at">plot_name =</span> combs_temp<span class="sc">$</span>plot_name[i]</span>
<span id="cb338-50"><a href="validate-tree-detection-and-crown-delineation.html#cb338-50" tabindex="-1"></a>              , <span class="at">ws_fn_nm =</span> combs_temp<span class="sc">$</span>ws_fn_nm[i]</span>
<span id="cb338-51"><a href="validate-tree-detection-and-crown-delineation.html#cb338-51" tabindex="-1"></a>            )</span>
<span id="cb338-52"><a href="validate-tree-detection-and-crown-delineation.html#cb338-52" tabindex="-1"></a>        )</span>
<span id="cb338-53"><a href="validate-tree-detection-and-crown-delineation.html#cb338-53" tabindex="-1"></a>      <span class="co"># training_ground_truth_crown_match_df</span></span>
<span id="cb338-54"><a href="validate-tree-detection-and-crown-delineation.html#cb338-54" tabindex="-1"></a>      training_ground_truth_crown_match_df <span class="ot">&lt;-</span> training_ground_truth_crown_match_df <span class="sc">%&gt;%</span> </span>
<span id="cb338-55"><a href="validate-tree-detection-and-crown-delineation.html#cb338-55" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb338-56"><a href="validate-tree-detection-and-crown-delineation.html#cb338-56" tabindex="-1"></a>          fi_evaluate_ans_temp<span class="sc">$</span>result<span class="sc">$</span>ground_truth_crown_match <span class="sc">%&gt;%</span> </span>
<span id="cb338-57"><a href="validate-tree-detection-and-crown-delineation.html#cb338-57" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb338-58"><a href="validate-tree-detection-and-crown-delineation.html#cb338-58" tabindex="-1"></a>              <span class="at">plot_name =</span> combs_temp<span class="sc">$</span>plot_name[i]</span>
<span id="cb338-59"><a href="validate-tree-detection-and-crown-delineation.html#cb338-59" tabindex="-1"></a>              , <span class="at">ws_fn_nm =</span> combs_temp<span class="sc">$</span>ws_fn_nm[i]</span>
<span id="cb338-60"><a href="validate-tree-detection-and-crown-delineation.html#cb338-60" tabindex="-1"></a>            )</span>
<span id="cb338-61"><a href="validate-tree-detection-and-crown-delineation.html#cb338-61" tabindex="-1"></a>        )</span>
<span id="cb338-62"><a href="validate-tree-detection-and-crown-delineation.html#cb338-62" tabindex="-1"></a>      <span class="co"># training_ground_truth_crowns_df</span></span>
<span id="cb338-63"><a href="validate-tree-detection-and-crown-delineation.html#cb338-63" tabindex="-1"></a>      epsg_temp <span class="ot">&lt;-</span> fi_evaluate_ans_temp<span class="sc">$</span>result<span class="sc">$</span>ground_truth_crowns <span class="sc">%&gt;%</span> </span>
<span id="cb338-64"><a href="validate-tree-detection-and-crown-delineation.html#cb338-64" tabindex="-1"></a>        sf<span class="sc">::</span><span class="fu">st_crs</span>(<span class="at">parameters=</span>T) <span class="sc">%&gt;%</span> </span>
<span id="cb338-65"><a href="validate-tree-detection-and-crown-delineation.html#cb338-65" tabindex="-1"></a>        purrr<span class="sc">::</span><span class="fu">pluck</span>(<span class="st">&quot;epsg&quot;</span>)</span>
<span id="cb338-66"><a href="validate-tree-detection-and-crown-delineation.html#cb338-66" tabindex="-1"></a>      training_ground_truth_crowns_df <span class="ot">&lt;-</span> training_ground_truth_crowns_df <span class="sc">%&gt;%</span> </span>
<span id="cb338-67"><a href="validate-tree-detection-and-crown-delineation.html#cb338-67" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb338-68"><a href="validate-tree-detection-and-crown-delineation.html#cb338-68" tabindex="-1"></a>          fi_evaluate_ans_temp<span class="sc">$</span>result<span class="sc">$</span>ground_truth_crowns <span class="sc">%&gt;%</span> </span>
<span id="cb338-69"><a href="validate-tree-detection-and-crown-delineation.html#cb338-69" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb338-70"><a href="validate-tree-detection-and-crown-delineation.html#cb338-70" tabindex="-1"></a>              <span class="at">plot_name =</span> combs_temp<span class="sc">$</span>plot_name[i]</span>
<span id="cb338-71"><a href="validate-tree-detection-and-crown-delineation.html#cb338-71" tabindex="-1"></a>              , <span class="at">ws_fn_nm =</span> combs_temp<span class="sc">$</span>ws_fn_nm[i]</span>
<span id="cb338-72"><a href="validate-tree-detection-and-crown-delineation.html#cb338-72" tabindex="-1"></a>              , <span class="at">epsg =</span> <span class="fu">ifelse</span>(<span class="fu">identical</span>(epsg_temp,<span class="fu">character</span>(<span class="dv">0</span>)),<span class="fu">as.numeric</span>(<span class="cn">NA</span>),<span class="fu">as.numeric</span>(epsg_temp))</span>
<span id="cb338-73"><a href="validate-tree-detection-and-crown-delineation.html#cb338-73" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span> </span>
<span id="cb338-74"><a href="validate-tree-detection-and-crown-delineation.html#cb338-74" tabindex="-1"></a>            sf<span class="sc">::</span><span class="fu">st_set_crs</span>(<span class="cn">NA</span>)</span>
<span id="cb338-75"><a href="validate-tree-detection-and-crown-delineation.html#cb338-75" tabindex="-1"></a>        )</span>
<span id="cb338-76"><a href="validate-tree-detection-and-crown-delineation.html#cb338-76" tabindex="-1"></a>    }</span>
<span id="cb338-77"><a href="validate-tree-detection-and-crown-delineation.html#cb338-77" tabindex="-1"></a>    fi_evaluate_ans_temp <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb338-78"><a href="validate-tree-detection-and-crown-delineation.html#cb338-78" tabindex="-1"></a>  }</span>
<span id="cb338-79"><a href="validate-tree-detection-and-crown-delineation.html#cb338-79" tabindex="-1"></a>  </span>
<span id="cb338-80"><a href="validate-tree-detection-and-crown-delineation.html#cb338-80" tabindex="-1"></a>  <span class="co"># save</span></span>
<span id="cb338-81"><a href="validate-tree-detection-and-crown-delineation.html#cb338-81" tabindex="-1"></a>  readr<span class="sc">::</span><span class="fu">write_csv</span>(training_plot_score_df, <span class="at">file =</span> training_eval_temp)</span>
<span id="cb338-82"><a href="validate-tree-detection-and-crown-delineation.html#cb338-82" tabindex="-1"></a>  readr<span class="sc">::</span><span class="fu">write_csv</span>(training_ground_truth_crown_match_df, <span class="at">file =</span> training_eval_m_temp)</span>
<span id="cb338-83"><a href="validate-tree-detection-and-crown-delineation.html#cb338-83" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_write</span>(training_ground_truth_crowns_df, training_eval_c_temp, <span class="at">append =</span> F)</span>
<span id="cb338-84"><a href="validate-tree-detection-and-crown-delineation.html#cb338-84" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb338-85"><a href="validate-tree-detection-and-crown-delineation.html#cb338-85" tabindex="-1"></a>  training_plot_score_df <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(training_eval_temp, <span class="at">progress =</span> F, <span class="at">show_col_types =</span> F)</span>
<span id="cb338-86"><a href="validate-tree-detection-and-crown-delineation.html#cb338-86" tabindex="-1"></a>  training_ground_truth_crown_match_df <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(training_eval_m_temp, <span class="at">progress =</span> F, <span class="at">show_col_types =</span> F)</span>
<span id="cb338-87"><a href="validate-tree-detection-and-crown-delineation.html#cb338-87" tabindex="-1"></a>  training_ground_truth_crowns_df <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(training_eval_c_temp, <span class="at">quiet =</span> T)</span>
<span id="cb338-88"><a href="validate-tree-detection-and-crown-delineation.html#cb338-88" tabindex="-1"></a>}</span></code></pre></div>
<p>plot precision, recall, and F-score by plot</p>
<div class="sourceCode" id="cb339"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb339-1"><a href="validate-tree-detection-and-crown-delineation.html#cb339-1" tabindex="-1"></a>training_plot_score_df <span class="sc">%&gt;%</span> </span>
<span id="cb339-2"><a href="validate-tree-detection-and-crown-delineation.html#cb339-2" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(precision,recall,f_score)) <span class="sc">%&gt;%</span> </span>
<span id="cb339-3"><a href="validate-tree-detection-and-crown-delineation.html#cb339-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb339-4"><a href="validate-tree-detection-and-crown-delineation.html#cb339-4" tabindex="-1"></a>    <span class="at">name =</span> <span class="fu">ifelse</span>(name<span class="sc">==</span><span class="st">&quot;f_score&quot;</span>,<span class="st">&quot;F-score&quot;</span>,name) <span class="sc">%&gt;%</span> forcats<span class="sc">::</span><span class="fu">fct_rev</span>()</span>
<span id="cb339-5"><a href="validate-tree-detection-and-crown-delineation.html#cb339-5" tabindex="-1"></a>    , <span class="at">plot_name =</span> plot_name <span class="sc">%&gt;%</span> forcats<span class="sc">::</span><span class="fu">fct_rev</span>()</span>
<span id="cb339-6"><a href="validate-tree-detection-and-crown-delineation.html#cb339-6" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb339-7"><a href="validate-tree-detection-and-crown-delineation.html#cb339-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">y =</span> plot_name, <span class="at">color =</span> ws_fn_nm)) <span class="sc">+</span></span>
<span id="cb339-8"><a href="validate-tree-detection-and-crown-delineation.html#cb339-8" tabindex="-1"></a>    <span class="co"># ggplot2::geom_point(size = 4) +</span></span>
<span id="cb339-9"><a href="validate-tree-detection-and-crown-delineation.html#cb339-9" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_jitter</span>(<span class="at">height =</span> <span class="fl">0.12</span>, <span class="at">width =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb339-10"><a href="validate-tree-detection-and-crown-delineation.html#cb339-10" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_grid</span>(<span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(name)) <span class="sc">+</span></span>
<span id="cb339-11"><a href="validate-tree-detection-and-crown-delineation.html#cb339-11" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> pal_ws) <span class="sc">+</span></span>
<span id="cb339-12"><a href="validate-tree-detection-and-crown-delineation.html#cb339-12" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb339-13"><a href="validate-tree-detection-and-crown-delineation.html#cb339-13" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb339-14"><a href="validate-tree-detection-and-crown-delineation.html#cb339-14" tabindex="-1"></a>      , <span class="at">color =</span> <span class="st">&quot;variable</span><span class="sc">\n</span><span class="st">window</span><span class="sc">\n</span><span class="st">function&quot;</span></span>
<span id="cb339-15"><a href="validate-tree-detection-and-crown-delineation.html#cb339-15" tabindex="-1"></a>      , <span class="at">subtitle =</span> <span class="st">&quot;Training data: validation against image annotated crowns ground truth&quot;</span></span>
<span id="cb339-16"><a href="validate-tree-detection-and-crown-delineation.html#cb339-16" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb339-17"><a href="validate-tree-detection-and-crown-delineation.html#cb339-17" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb339-18"><a href="validate-tree-detection-and-crown-delineation.html#cb339-18" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb339-19"><a href="validate-tree-detection-and-crown-delineation.html#cb339-19" tabindex="-1"></a>      <span class="at">axis.text.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">8</span>)</span>
<span id="cb339-20"><a href="validate-tree-detection-and-crown-delineation.html#cb339-20" tabindex="-1"></a>      , <span class="at">panel.grid.major.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_line</span>(<span class="at">color=</span><span class="st">&quot;gray22&quot;</span>)</span>
<span id="cb339-21"><a href="validate-tree-detection-and-crown-delineation.html#cb339-21" tabindex="-1"></a>      , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb339-22"><a href="validate-tree-detection-and-crown-delineation.html#cb339-22" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb339-23"><a href="validate-tree-detection-and-crown-delineation.html#cb339-23" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">guides</span>(</span>
<span id="cb339-24"><a href="validate-tree-detection-and-crown-delineation.html#cb339-24" tabindex="-1"></a>      <span class="at">color =</span> ggplot2<span class="sc">::</span><span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">shape =</span> <span class="dv">15</span>, <span class="at">size =</span> <span class="dv">6</span>))</span>
<span id="cb339-25"><a href="validate-tree-detection-and-crown-delineation.html#cb339-25" tabindex="-1"></a>    )</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-316-1.png" width="1008" /></p>
<p>we’ll quickly compare the variable window functions by averaging across sites and making a “quadrant” plot whereby we overlay the median value to differentiate the “best” window size by the two dimensions (precision, recall)…the upper-right quadrant is the “best” of the variable window functions tested based on these training plots evaluated against image annotated crowns</p>
<div class="sourceCode" id="cb340"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb340-1"><a href="validate-tree-detection-and-crown-delineation.html#cb340-1" tabindex="-1"></a>agg_pr_temp <span class="ot">&lt;-</span> training_plot_score_df <span class="sc">%&gt;%</span> </span>
<span id="cb340-2"><a href="validate-tree-detection-and-crown-delineation.html#cb340-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(ws_fn_nm) <span class="sc">%&gt;%</span> </span>
<span id="cb340-3"><a href="validate-tree-detection-and-crown-delineation.html#cb340-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(dplyr<span class="sc">::</span><span class="fu">across</span>(dplyr<span class="sc">::</span><span class="fu">where</span>(is.numeric),mean))</span>
<span id="cb340-4"><a href="validate-tree-detection-and-crown-delineation.html#cb340-4" tabindex="-1"></a>agg_pr_temp <span class="sc">%&gt;%</span> </span>
<span id="cb340-5"><a href="validate-tree-detection-and-crown-delineation.html#cb340-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x=</span>precision,<span class="at">y=</span>recall,<span class="at">color=</span>ws_fn_nm)) <span class="sc">+</span></span>
<span id="cb340-6"><a href="validate-tree-detection-and-crown-delineation.html#cb340-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">median</span>(agg_pr_temp<span class="sc">$</span>recall,<span class="at">na.rm =</span> T),<span class="at">linetype=</span><span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span></span>
<span id="cb340-7"><a href="validate-tree-detection-and-crown-delineation.html#cb340-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">median</span>(agg_pr_temp<span class="sc">$</span>precision,<span class="at">na.rm =</span> T),<span class="at">linetype=</span><span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span></span>
<span id="cb340-8"><a href="validate-tree-detection-and-crown-delineation.html#cb340-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">6</span>) <span class="sc">+</span></span>
<span id="cb340-9"><a href="validate-tree-detection-and-crown-delineation.html#cb340-9" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> pal_ws) <span class="sc">+</span></span>
<span id="cb340-10"><a href="validate-tree-detection-and-crown-delineation.html#cb340-10" tabindex="-1"></a>  <span class="co"># ggplot2::scale_x_continuous(limits = c(0,0.5)) +</span></span>
<span id="cb340-11"><a href="validate-tree-detection-and-crown-delineation.html#cb340-11" tabindex="-1"></a>  <span class="co"># ggplot2::scale_y_continuous(limits = c(0,0.5)) +</span></span>
<span id="cb340-12"><a href="validate-tree-detection-and-crown-delineation.html#cb340-12" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb340-13"><a href="validate-tree-detection-and-crown-delineation.html#cb340-13" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">&quot;variable</span><span class="sc">\n</span><span class="st">window</span><span class="sc">\n</span><span class="st">function&quot;</span></span>
<span id="cb340-14"><a href="validate-tree-detection-and-crown-delineation.html#cb340-14" tabindex="-1"></a>    , <span class="at">subtitle =</span> <span class="st">&quot;Training data: validation against image annotated crowns ground truth&quot;</span></span>
<span id="cb340-15"><a href="validate-tree-detection-and-crown-delineation.html#cb340-15" tabindex="-1"></a>    , <span class="at">caption =</span> <span class="st">&quot;*values are averaged across sites and plots&quot;</span></span>
<span id="cb340-16"><a href="validate-tree-detection-and-crown-delineation.html#cb340-16" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb340-17"><a href="validate-tree-detection-and-crown-delineation.html#cb340-17" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb340-18"><a href="validate-tree-detection-and-crown-delineation.html#cb340-18" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">guides</span>(</span>
<span id="cb340-19"><a href="validate-tree-detection-and-crown-delineation.html#cb340-19" tabindex="-1"></a>    <span class="at">color =</span> ggplot2<span class="sc">::</span><span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">shape =</span> <span class="dv">15</span>, <span class="at">size =</span> <span class="dv">6</span>))</span>
<span id="cb340-20"><a href="validate-tree-detection-and-crown-delineation.html#cb340-20" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-317-1.png" width="1008" /></p>
<div id="best-variable-window-function-by-site" class="section level5 hasAnchor" number="4.3.3.2.1">
<h5><span class="header-section-number">4.3.3.2.1</span> Best variable window function by site<a href="validate-tree-detection-and-crown-delineation.html#best-variable-window-function-by-site" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>we collapsed across plot to calculate an average precision, recall, and F-score for each site and variable window function combination</p>
<p>As a reminder, we limited our evaluation to only sites with conifer trees: <strong>NIBIO</strong>, <strong>CULS</strong>, and <strong>SCION</strong></p>
<ul>
<li><strong>NIBIO</strong>: Coniferous dominated boreal forest study site in Norway composed of mature forests dominated by Norway spruce (<em>Picea abies</em>) and with few Scots pine (<em>Pinus Sylvestris</em>) and deciduous species (mainly <em>Betula</em> sp.).</li>
<li><strong>CULS</strong>: Coniferous dominated temperate forest study site in the Czech north of Prague with forested plots consisting of productive even-aged Scots pine forest</li>
<li><strong>SCION</strong>: Coniferous non-native temperate study site in New Zealand consisting of pure Monterey pine (<em>Pinus radiata</em>) of 18-20 years of age and is representative of a typical productive plantation forest</li>
</ul>
<p>first, we’ll collapse across plot to calculate the site-level metrics for each variable window function</p>
<div class="sourceCode" id="cb341"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb341-1"><a href="validate-tree-detection-and-crown-delineation.html#cb341-1" tabindex="-1"></a><span class="co"># site eval results</span></span>
<span id="cb341-2"><a href="validate-tree-detection-and-crown-delineation.html#cb341-2" tabindex="-1"></a>fi_training_eval_by_site <span class="ot">&lt;-</span></span>
<span id="cb341-3"><a href="validate-tree-detection-and-crown-delineation.html#cb341-3" tabindex="-1"></a>  training_plot_score_df <span class="sc">%&gt;%</span> </span>
<span id="cb341-4"><a href="validate-tree-detection-and-crown-delineation.html#cb341-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(</span>
<span id="cb341-5"><a href="validate-tree-detection-and-crown-delineation.html#cb341-5" tabindex="-1"></a>    fi_lidar_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">distinct</span>(plot_name,siteID)</span>
<span id="cb341-6"><a href="validate-tree-detection-and-crown-delineation.html#cb341-6" tabindex="-1"></a>    , <span class="at">by=</span><span class="st">&quot;plot_name&quot;</span></span>
<span id="cb341-7"><a href="validate-tree-detection-and-crown-delineation.html#cb341-7" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb341-8"><a href="validate-tree-detection-and-crown-delineation.html#cb341-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(siteID,ws_fn_nm) <span class="sc">%&gt;%</span> </span>
<span id="cb341-9"><a href="validate-tree-detection-and-crown-delineation.html#cb341-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb341-10"><a href="validate-tree-detection-and-crown-delineation.html#cb341-10" tabindex="-1"></a>    <span class="at">precision =</span> <span class="fu">mean</span>(precision, <span class="at">na.rm =</span> T)</span>
<span id="cb341-11"><a href="validate-tree-detection-and-crown-delineation.html#cb341-11" tabindex="-1"></a>    , <span class="at">recall =</span> <span class="fu">mean</span>(recall, <span class="at">na.rm =</span> T)</span>
<span id="cb341-12"><a href="validate-tree-detection-and-crown-delineation.html#cb341-12" tabindex="-1"></a>    , <span class="at">omission_rate =</span> <span class="fu">mean</span>(omission_rate, <span class="at">na.rm =</span> T)</span>
<span id="cb341-13"><a href="validate-tree-detection-and-crown-delineation.html#cb341-13" tabindex="-1"></a>    , <span class="at">commission_rate =</span> <span class="fu">mean</span>(commission_rate, <span class="at">na.rm =</span> T)</span>
<span id="cb341-14"><a href="validate-tree-detection-and-crown-delineation.html#cb341-14" tabindex="-1"></a>    , <span class="at">rmse_height_m =</span> <span class="fu">mean</span>(rmse_height_m, <span class="at">na.rm =</span> T)</span>
<span id="cb341-15"><a href="validate-tree-detection-and-crown-delineation.html#cb341-15" tabindex="-1"></a>    , <span class="at">rmse_height_m_weighted_mean =</span> <span class="fu">sum</span>(rmse_height_m<span class="sc">*</span>tp_n, <span class="at">na.rm =</span> T)<span class="sc">/</span><span class="fu">sum</span>(tp_n, <span class="at">na.rm =</span> T)</span>
<span id="cb341-16"><a href="validate-tree-detection-and-crown-delineation.html#cb341-16" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb341-17"><a href="validate-tree-detection-and-crown-delineation.html#cb341-17" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb341-18"><a href="validate-tree-detection-and-crown-delineation.html#cb341-18" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb341-19"><a href="validate-tree-detection-and-crown-delineation.html#cb341-19" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">across</span>(</span>
<span id="cb341-20"><a href="validate-tree-detection-and-crown-delineation.html#cb341-20" tabindex="-1"></a>      <span class="at">.cols =</span> <span class="fu">c</span>(precision,recall,tidyselect<span class="sc">::</span><span class="fu">ends_with</span>(<span class="st">&quot;_rate&quot;</span>),tidyselect<span class="sc">::</span><span class="fu">starts_with</span>(<span class="st">&quot;rmse_&quot;</span>))</span>
<span id="cb341-21"><a href="validate-tree-detection-and-crown-delineation.html#cb341-21" tabindex="-1"></a>      , <span class="sc">~</span><span class="fu">ifelse</span>(<span class="fu">is.nan</span>(.x),<span class="fu">as.numeric</span>(<span class="cn">NA</span>),.x)</span>
<span id="cb341-22"><a href="validate-tree-detection-and-crown-delineation.html#cb341-22" tabindex="-1"></a>    )</span>
<span id="cb341-23"><a href="validate-tree-detection-and-crown-delineation.html#cb341-23" tabindex="-1"></a>    , <span class="at">f_score =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb341-24"><a href="validate-tree-detection-and-crown-delineation.html#cb341-24" tabindex="-1"></a>      <span class="fu">is.na</span>(precision) <span class="sc">|</span> <span class="fu">is.na</span>(recall) <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)</span>
<span id="cb341-25"><a href="validate-tree-detection-and-crown-delineation.html#cb341-25" tabindex="-1"></a>      , (precision<span class="sc">+</span>recall) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="dv">0</span></span>
<span id="cb341-26"><a href="validate-tree-detection-and-crown-delineation.html#cb341-26" tabindex="-1"></a>      , T <span class="sc">~</span> <span class="dv">2</span> <span class="sc">*</span> ( (precision<span class="sc">*</span>recall)<span class="sc">/</span>(precision<span class="sc">+</span>recall) )</span>
<span id="cb341-27"><a href="validate-tree-detection-and-crown-delineation.html#cb341-27" tabindex="-1"></a>    )</span>
<span id="cb341-28"><a href="validate-tree-detection-and-crown-delineation.html#cb341-28" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb341-29"><a href="validate-tree-detection-and-crown-delineation.html#cb341-29" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(siteID,<span class="fu">desc</span>(f_score),<span class="fu">desc</span>(precision),<span class="fu">desc</span>(recall),omission_rate,commission_rate) <span class="sc">%&gt;%</span> </span>
<span id="cb341-30"><a href="validate-tree-detection-and-crown-delineation.html#cb341-30" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(siteID) <span class="sc">%&gt;%</span> </span>
<span id="cb341-31"><a href="validate-tree-detection-and-crown-delineation.html#cb341-31" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">is_best_fn =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>()<span class="sc">==</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb341-32"><a href="validate-tree-detection-and-crown-delineation.html#cb341-32" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>()</span>
<span id="cb341-33"><a href="validate-tree-detection-and-crown-delineation.html#cb341-33" tabindex="-1"></a><span class="co"># save it after cleaning</span></span>
<span id="cb341-34"><a href="validate-tree-detection-and-crown-delineation.html#cb341-34" tabindex="-1"></a>readr<span class="sc">::</span><span class="fu">write_csv</span>(fi_training_eval_by_site, <span class="st">&quot;../data/ForInstance_training_eval_by_site.csv&quot;</span>, <span class="at">append =</span> F, <span class="at">progress =</span> F)</span></code></pre></div>
<p>show the best window function by site</p>
<div class="sourceCode" id="cb342"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb342-1"><a href="validate-tree-detection-and-crown-delineation.html#cb342-1" tabindex="-1"></a>fi_training_eval_by_site <span class="sc">%&gt;%</span> </span>
<span id="cb342-2"><a href="validate-tree-detection-and-crown-delineation.html#cb342-2" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(precision,recall,f_score)) <span class="sc">%&gt;%</span> </span>
<span id="cb342-3"><a href="validate-tree-detection-and-crown-delineation.html#cb342-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb342-4"><a href="validate-tree-detection-and-crown-delineation.html#cb342-4" tabindex="-1"></a>    <span class="at">name =</span> <span class="fu">ifelse</span>(name<span class="sc">==</span><span class="st">&quot;f_score&quot;</span>,<span class="st">&quot;F-score&quot;</span>,name) <span class="sc">%&gt;%</span> forcats<span class="sc">::</span><span class="fu">fct_rev</span>()</span>
<span id="cb342-5"><a href="validate-tree-detection-and-crown-delineation.html#cb342-5" tabindex="-1"></a>    , <span class="at">siteID =</span> forcats<span class="sc">::</span><span class="fu">fct_rev</span>(siteID)</span>
<span id="cb342-6"><a href="validate-tree-detection-and-crown-delineation.html#cb342-6" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb342-7"><a href="validate-tree-detection-and-crown-delineation.html#cb342-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(is_best_fn) <span class="sc">%&gt;%</span> </span>
<span id="cb342-8"><a href="validate-tree-detection-and-crown-delineation.html#cb342-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">y =</span> siteID, <span class="at">color =</span> ws_fn_nm)) <span class="sc">+</span></span>
<span id="cb342-9"><a href="validate-tree-detection-and-crown-delineation.html#cb342-9" tabindex="-1"></a>    <span class="co"># ggplot2::geom_point(size = 4) +</span></span>
<span id="cb342-10"><a href="validate-tree-detection-and-crown-delineation.html#cb342-10" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_jitter</span>(</span>
<span id="cb342-11"><a href="validate-tree-detection-and-crown-delineation.html#cb342-11" tabindex="-1"></a>      ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">shape =</span> is_best_fn)</span>
<span id="cb342-12"><a href="validate-tree-detection-and-crown-delineation.html#cb342-12" tabindex="-1"></a>      ,<span class="at">height =</span> <span class="fl">0.12</span></span>
<span id="cb342-13"><a href="validate-tree-detection-and-crown-delineation.html#cb342-13" tabindex="-1"></a>      , <span class="at">width =</span> <span class="dv">0</span></span>
<span id="cb342-14"><a href="validate-tree-detection-and-crown-delineation.html#cb342-14" tabindex="-1"></a>      , <span class="at">size =</span> <span class="dv">5</span></span>
<span id="cb342-15"><a href="validate-tree-detection-and-crown-delineation.html#cb342-15" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb342-16"><a href="validate-tree-detection-and-crown-delineation.html#cb342-16" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">facet_grid</span>(<span class="at">cols =</span> dplyr<span class="sc">::</span><span class="fu">vars</span>(name)) <span class="sc">+</span></span>
<span id="cb342-17"><a href="validate-tree-detection-and-crown-delineation.html#cb342-17" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> pal_ws) <span class="sc">+</span></span>
<span id="cb342-18"><a href="validate-tree-detection-and-crown-delineation.html#cb342-18" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">20</span>,<span class="dv">15</span>)) <span class="sc">+</span></span>
<span id="cb342-19"><a href="validate-tree-detection-and-crown-delineation.html#cb342-19" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="cn">NA</span>,<span class="fl">1.01</span>)) <span class="sc">+</span></span>
<span id="cb342-20"><a href="validate-tree-detection-and-crown-delineation.html#cb342-20" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">labs</span>(</span>
<span id="cb342-21"><a href="validate-tree-detection-and-crown-delineation.html#cb342-21" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span></span>
<span id="cb342-22"><a href="validate-tree-detection-and-crown-delineation.html#cb342-22" tabindex="-1"></a>      , <span class="at">color =</span> <span class="st">&quot;variable</span><span class="sc">\n</span><span class="st">window</span><span class="sc">\n</span><span class="st">function&quot;</span></span>
<span id="cb342-23"><a href="validate-tree-detection-and-crown-delineation.html#cb342-23" tabindex="-1"></a>      , <span class="at">subtitle =</span> <span class="st">&quot;Best variable window function by study site based on training data evaluation&quot;</span></span>
<span id="cb342-24"><a href="validate-tree-detection-and-crown-delineation.html#cb342-24" tabindex="-1"></a>      , <span class="at">caption =</span> <span class="st">&quot;*a square indicates the best function&quot;</span></span>
<span id="cb342-25"><a href="validate-tree-detection-and-crown-delineation.html#cb342-25" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb342-26"><a href="validate-tree-detection-and-crown-delineation.html#cb342-26" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb342-27"><a href="validate-tree-detection-and-crown-delineation.html#cb342-27" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb342-28"><a href="validate-tree-detection-and-crown-delineation.html#cb342-28" tabindex="-1"></a>      <span class="at">axis.text.x =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">7</span>)</span>
<span id="cb342-29"><a href="validate-tree-detection-and-crown-delineation.html#cb342-29" tabindex="-1"></a>      , <span class="at">panel.grid.major.y =</span> ggplot2<span class="sc">::</span><span class="fu">element_line</span>(<span class="at">color=</span><span class="st">&quot;gray22&quot;</span>)</span>
<span id="cb342-30"><a href="validate-tree-detection-and-crown-delineation.html#cb342-30" tabindex="-1"></a>      , <span class="at">strip.text =</span> ggplot2<span class="sc">::</span><span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb342-31"><a href="validate-tree-detection-and-crown-delineation.html#cb342-31" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb342-32"><a href="validate-tree-detection-and-crown-delineation.html#cb342-32" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">guides</span>(</span>
<span id="cb342-33"><a href="validate-tree-detection-and-crown-delineation.html#cb342-33" tabindex="-1"></a>      <span class="at">color =</span> ggplot2<span class="sc">::</span><span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">shape =</span> <span class="dv">15</span>, <span class="at">size =</span> <span class="dv">6</span>))</span>
<span id="cb342-34"><a href="validate-tree-detection-and-crown-delineation.html#cb342-34" tabindex="-1"></a>      , <span class="at">shape =</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb342-35"><a href="validate-tree-detection-and-crown-delineation.html#cb342-35" tabindex="-1"></a>    )</span></code></pre></div>
<p><img src="lidar_phys_fire_mods_files/figure-html/unnamed-chunk-320-1.png" width="1008" /></p>
<p>table of the best function by site</p>
<div class="sourceCode" id="cb343"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb343-1"><a href="validate-tree-detection-and-crown-delineation.html#cb343-1" tabindex="-1"></a>fi_training_eval_by_site <span class="sc">%&gt;%</span> </span>
<span id="cb343-2"><a href="validate-tree-detection-and-crown-delineation.html#cb343-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(is_best_fn) <span class="sc">%&gt;%</span> </span>
<span id="cb343-3"><a href="validate-tree-detection-and-crown-delineation.html#cb343-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(siteID,ws_fn_nm, omission_rate,commission_rate,recall,precision,f_score) <span class="sc">%&gt;%</span> </span>
<span id="cb343-4"><a href="validate-tree-detection-and-crown-delineation.html#cb343-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(siteID) <span class="sc">%&gt;%</span> </span>
<span id="cb343-5"><a href="validate-tree-detection-and-crown-delineation.html#cb343-5" tabindex="-1"></a>kableExtra<span class="sc">::</span><span class="fu">kbl</span>(</span>
<span id="cb343-6"><a href="validate-tree-detection-and-crown-delineation.html#cb343-6" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">&quot;Best variable window function by study site based on training data evaluation&quot;</span></span>
<span id="cb343-7"><a href="validate-tree-detection-and-crown-delineation.html#cb343-7" tabindex="-1"></a>    , <span class="at">digits =</span> <span class="dv">2</span></span>
<span id="cb343-8"><a href="validate-tree-detection-and-crown-delineation.html#cb343-8" tabindex="-1"></a>    , <span class="at">col.names =</span> <span class="fu">c</span>(</span>
<span id="cb343-9"><a href="validate-tree-detection-and-crown-delineation.html#cb343-9" tabindex="-1"></a>      <span class="st">&quot;site&quot;</span>,<span class="st">&quot;variable&lt;br&gt;window&lt;br&gt;function&quot;</span></span>
<span id="cb343-10"><a href="validate-tree-detection-and-crown-delineation.html#cb343-10" tabindex="-1"></a>      , <span class="st">&quot;omission&lt;br&gt;rate&quot;</span></span>
<span id="cb343-11"><a href="validate-tree-detection-and-crown-delineation.html#cb343-11" tabindex="-1"></a>      , <span class="st">&quot;commission&lt;br&gt;rate&quot;</span></span>
<span id="cb343-12"><a href="validate-tree-detection-and-crown-delineation.html#cb343-12" tabindex="-1"></a>      ,<span class="st">&quot;recall&quot;</span>,<span class="st">&quot;precision&quot;</span>,<span class="st">&quot;F-score&quot;</span></span>
<span id="cb343-13"><a href="validate-tree-detection-and-crown-delineation.html#cb343-13" tabindex="-1"></a>    )</span>
<span id="cb343-14"><a href="validate-tree-detection-and-crown-delineation.html#cb343-14" tabindex="-1"></a>    , <span class="at">escape =</span> F</span>
<span id="cb343-15"><a href="validate-tree-detection-and-crown-delineation.html#cb343-15" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb343-16"><a href="validate-tree-detection-and-crown-delineation.html#cb343-16" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>()</span></code></pre></div>
<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-321">Table 4.18: </span>Best variable window function by study site based on training data evaluation
</caption>
<thead>
<tr>
<th style="text-align:left;">
site
</th>
<th style="text-align:left;">
variable<br>window<br>function
</th>
<th style="text-align:right;">
omission<br>rate
</th>
<th style="text-align:right;">
commission<br>rate
</th>
<th style="text-align:right;">
recall
</th>
<th style="text-align:right;">
precision
</th>
<th style="text-align:right;">
F-score
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
CULS
</td>
<td style="text-align:left;">
log_les_ccv_fn
</td>
<td style="text-align:right;">
0.17
</td>
<td style="text-align:right;">
0.11
</td>
<td style="text-align:right;">
0.83
</td>
<td style="text-align:right;">
0.89
</td>
<td style="text-align:right;">
0.86
</td>
</tr>
<tr>
<td style="text-align:left;">
NIBIO
</td>
<td style="text-align:left;">
lin_lo_slp_fn
</td>
<td style="text-align:right;">
0.58
</td>
<td style="text-align:right;">
0.33
</td>
<td style="text-align:right;">
0.42
</td>
<td style="text-align:right;">
0.67
</td>
<td style="text-align:right;">
0.52
</td>
</tr>
<tr>
<td style="text-align:left;">
SCION
</td>
<td style="text-align:left;">
log_les_ccv_fn
</td>
<td style="text-align:right;">
0.50
</td>
<td style="text-align:right;">
0.26
</td>
<td style="text-align:right;">
0.50
</td>
<td style="text-align:right;">
0.74
</td>
<td style="text-align:right;">
0.60
</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="forest-stand-summary.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="appendix.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": null,
    "text": null
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": null,
    "text": null
  },
  "download": null,
  "search": {
    "engine": "fuse",
    "options": null
  },
  "toc": {
    "collapse": "subsection"
  }
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
