# Point Cloud Processing

In this section we'll process the [raw point cloud data](#data_desc) using the [`cloud2trees` R package](https://github.com/georgewoolsey/cloud2trees) developed to provide accessible routines for processing point cloud data collected by airborne lidar or generated using UAS imagery and photogrammetry (e.g. structure from motion).

```{r, warning=FALSE, message=FALSE}
# bread-and-butter
library(tidyverse) # the tidyverse
library(viridis) # viridis colors
library(harrypotter) # hp colors
library(RColorBrewer) # brewer colors
library(scales) # work with number and plot scales
library(latex2exp)

# visualization
library(mapview) # interactive html maps
library(kableExtra) # tables
library(patchwork) # combine plots

# spatial analysis
library(terra) # raster
library(sf) # simple features
library(lidR) # lidar data
library(cloud2trees) # the cloud2trees
```

```{r pkg-ld, include=F, warning=F, message=F}
# knit options
knitr::opts_chunk$set(
  echo = TRUE
  , warning = FALSE
  , message = FALSE
  # , results = 'hide'
  , fig.width = 10.5
  , fig.height = 7
)
# option to put satellite imagery as base layer of mapview maps
  mapview::mapviewOptions(
    homebutton = FALSE
    # , basemaps = c("Esri.WorldImagery","OpenStreetMap")
    , basemaps = c("OpenStreetMap", "Esri.WorldImagery")
  )
# clean session
remove(list = ls())
gc()
```

get all trees to build sample list

```{r}
# get the data from already run
treetops_sf <-
  list.files(
    "../data/point_cloud_processing_delivery"
    , pattern = "final_detected_tree_tops.*\\.gpkg$"
    , full.names = T
  ) %>% 
  normalizePath() %>% 
  # .[1:3] %>%
  purrr::map(\(x)
    sf::st_read(
      dsn = x
      , quiet = T
    )
  ) %>% 
  dplyr::bind_rows()
```

how many?

```{r}
nrow(treetops_sf)
```

sample

```{r}
# proportion of trees to sample
trees_sample_prop <- 0.2
# sample
trees_sample <- treetops_sf %>% 
  dplyr::slice_sample(prop = trees_sample_prop) %>% 
  # we only need the id
  sf::st_drop_geometry() %>% 
  dplyr::select(treeID)
```

remove everything else

```{r}
# removes everything but our samples
remove(list = ls()[ !ls() %in% ls()[grep("trees_sample",ls())] ])
# conflicted about gc
gc()
```

```{r, warning=FALSE, message=FALSE, echo=FALSE, include=FALSE}
remove(list = ls()[grep("_temp",ls())])
gc()
```

do it

```{r}
do_that_cbh <- function(crownfile, trees_sample, norm_las = "../data/point_cloud_processing_delivery/norm_las/") {
  # read crown
  crowns <- sf::st_read(dsn = crownfile, quiet = T) %>% 
    # this keeps our sample only
    dplyr::inner_join(trees_sample, by = "treeID")
  # check
  if(nrow(crowns)==0){return(NULL)}
  # run it
  trees_cbh_ans <- cloud2trees::trees_cbh(
    trees_poly = crowns
    , norm_las = norm_las
    , tree_sample_prop = 1 # nice
    , which_cbh = "lowest"
    , estimate_missing_cbh = F # we'll do it
    , min_vhp_n = 3
    , voxel_grain_size_m = 1
    , dist_btwn_bins_m = 1
    , min_fuel_layer_ht_m = 1
    , lad_pct_gap = 25
    , lad_pct_base = 25
    , num_jump_steps = 1
    , min_lad_pct = 10
    , frst_layer_min_ht_m = 1
    , force_same_crs = T
  )
  # write it
  fnm <- paste0(
    "cbh_"
    , crownfile %>% 
      basename() %>% 
      stringr::str_remove_all("\\.gpkg$")
    , ".csv"
  )
  fpth <- file.path(
    dirname(crownfile)
    , fnm 
  )
  trees_cbh_ans %>% 
    sf::st_drop_geometry() %>% 
    write.csv(file = fpth, row.names = F, append = F)
  return(fpth)
}
  
```

do it

```{r}
crown_f_list <- 
  list.files(
    "../data/point_cloud_processing_delivery"
    , pattern = "final_detected_crowns.*\\.gpkg$"
    , full.names = T
  ) %>% 
  normalizePath()
crown_f_list
#
cbh_f_list <- 
  crown_f_list %>% 
  purrr::map(\(x) 
    do_that_cbh(
      crownfile=x
      , trees_sample = trees_sample
      , norm_las = "../data/point_cloud_processing_delivery/norm_las/"
    )
  )
```

huh?

```{r}
cbh_f_list
```

## HMD

```{r}
do_that_hmd <- function(crownfile, norm_las = "../data/point_cloud_processing_delivery/norm_las/") {
  # read crown
  crowns <- sf::st_read(dsn = crownfile, quiet = T)
  # check
  if(nrow(crowns)==0){return(NULL)}
  # run it
  trees_hmd_ans <- cloud2trees::trees_hmd(
    trees_poly = crowns
    , norm_las = norm_las
    , tree_sample_prop = 1
    , estimate_missing_hmd = F
    , force_same_crs = T
  )
  # write it
  fnm <- paste0(
    "hmd_"
    , crownfile %>% 
      basename() %>% 
      stringr::str_remove_all("\\.gpkg$")
    , ".csv"
  )
  fpth <- file.path(
    dirname(crownfile)
    , fnm 
  )
  trees_hmd_ans %>% 
    sf::st_drop_geometry() %>% 
    write.csv(file = fpth, row.names = F, append = F)
  return(fpth)
}
  
```

do it

```{r}
crown_f_list <- 
  list.files(
    "../data/point_cloud_processing_delivery"
    , pattern = "final_detected_crowns.*\\.gpkg$"
    , full.names = T
  ) %>% 
  normalizePath()
crown_f_list
#
hmd_f_list <- 
  crown_f_list %>% 
  purrr::map(\(x) 
    do_that_hmd(
      crownfile=x
      , norm_las = "../data/point_cloud_processing_delivery/norm_las/"
    )
  )
```

huh?

```{r}
hmd_f_list
```

